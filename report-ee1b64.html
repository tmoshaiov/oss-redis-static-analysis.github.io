<!doctype html>
<html>
<head>
<title>redis-cli.c</title>

<style type="text/css">
body { color:#000000; background-color:#ffffff }
body { font-family:Helvetica, sans-serif; font-size:10pt }
h1 { font-size:14pt }
.FileName { margin-top: 5px; margin-bottom: 5px; display: inline; }
.FileNav { margin-left: 5px; margin-right: 5px; display: inline; }
.FileNav a { text-decoration:none; font-size: larger; }
.divider { margin-top: 30px; margin-bottom: 30px; height: 15px; }
.divider { background-color: gray; }
.code { border-collapse:collapse; width:100%; }
.code { font-family: "Monospace", monospace; font-size:10pt }
.code { line-height: 1.2em }
.comment { color: green; font-style: oblique }
.keyword { color: blue }
.string_literal { color: red }
.directive { color: darkmagenta }

/* Macros and variables could have pop-up notes hidden by default.
  - Macro pop-up:    expansion of the macro
  - Variable pop-up: value (table) of the variable */
.macro_popup, .variable_popup { display: none; }

/* Pop-up appears on mouse-hover event. */
.macro:hover .macro_popup, .variable:hover .variable_popup {
  display: block;
  padding: 2px;
  -webkit-border-radius:5px;
  -webkit-box-shadow:1px 1px 7px #000;
  border-radius:5px;
  box-shadow:1px 1px 7px #000;
  position: absolute;
  top: -1em;
  left:10em;
  z-index: 1
}

.macro_popup {
  border: 2px solid red;
  background-color:#FFF0F0;
  font-weight: normal;
}

.variable_popup {
  border: 2px solid blue;
  background-color:#F0F0FF;
  font-weight: bold;
  font-family: Helvetica, sans-serif;
  font-size: 9pt;
}

/* Pop-up notes needs a relative position as a base where they pops up. */
.macro, .variable {
  background-color: PaleGoldenRod;
  position: relative;
}
.macro { color: DarkMagenta; }

#tooltiphint {
  position: fixed;
  width: 50em;
  margin-left: -25em;
  left: 50%;
  padding: 10px;
  border: 1px solid #b0b0b0;
  border-radius: 2px;
  box-shadow: 1px 1px 7px black;
  background-color: #c0c0c0;
  z-index: 2;
}

.num { width:2.5em; padding-right:2ex; background-color:#eeeeee }
.num { text-align:right; font-size:8pt }
.num { color:#444444 }
.line { padding-left: 1ex; border-left: 3px solid #ccc }
.line { white-space: pre }
.msg { -webkit-box-shadow:1px 1px 7px #000 }
.msg { box-shadow:1px 1px 7px #000 }
.msg { -webkit-border-radius:5px }
.msg { border-radius:5px }
.msg { font-family:Helvetica, sans-serif; font-size:8pt }
.msg { float:left }
.msg { padding:0.25em 1ex 0.25em 1ex }
.msg { margin-top:10px; margin-bottom:10px }
.msg { font-weight:bold }
.msg { max-width:60em; word-wrap: break-word; white-space: pre-wrap }
.msgT { padding:0x; spacing:0x }
.msgEvent { background-color:#fff8b4; color:#000000 }
.msgControl { background-color:#bbbbbb; color:#000000 }
.msgNote { background-color:#ddeeff; color:#000000 }
.mrange { background-color:#dfddf3 }
.mrange { border-bottom:1px solid #6F9DBE }
.PathIndex { font-weight: bold; padding:0px 5px; margin-right:5px; }
.PathIndex { -webkit-border-radius:8px }
.PathIndex { border-radius:8px }
.PathIndexEvent { background-color:#bfba87 }
.PathIndexControl { background-color:#8c8c8c }
.PathIndexPopUp { background-color: #879abc; }
.PathNav a { text-decoration:none; font-size: larger }
.CodeInsertionHint { font-weight: bold; background-color: #10dd10 }
.CodeRemovalHint { background-color:#de1010 }
.CodeRemovalHint { border-bottom:1px solid #6F9DBE }
.selected{ background-color:orange !important; }

table.simpletable {
  padding: 5px;
  font-size:12pt;
  margin:20px;
  border-collapse: collapse; border-spacing: 0px;
}
td.rowname {
  text-align: right;
  vertical-align: top;
  font-weight: bold;
  color:#444444;
  padding-right:2ex;
}

/* Hidden text. */
input.spoilerhider + label {
  cursor: pointer;
  text-decoration: underline;
  display: block;
}
input.spoilerhider {
 display: none;
}
input.spoilerhider ~ .spoiler {
  overflow: hidden;
  margin: 10px auto 0;
  height: 0;
  opacity: 0;
}
input.spoilerhider:checked + label + .spoiler{
  height: auto;
  opacity: 1;
}
</style>
</head>
<body>
<!-- BUGDESC Null pointer passed to 1st parameter expecting 'nonnull' -->

<!-- BUGTYPE Argument with 'nonnull' attribute passed null -->

<!-- BUGCATEGORY API -->

<!-- BUGFILE /home/moshaiov/workplace/redis/src/redis-cli.c -->

<!-- FILENAME redis-cli.c -->

<!-- FUNCTIONNAME cliAddArgument -->

<!-- ISSUEHASHCONTENTOFLINEINCONTEXT 85bd1506e1e55b626d306b552ea16ba0 -->

<!-- BUGLINE 599 -->

<!-- BUGCOLUMN 10 -->

<!-- BUGPATHLENGTH 8 -->

<!-- BUGMETAEND -->
<h3><a href="/">Summary</a> > Report ee1b64</h3>
<h3>Bug Summary</h3>
<table class="simpletable">
<tr><td class="rowname">File:</td><td>/home/moshaiov/workplace/redis/src/redis-cli.c</td></tr>
<tr><td class="rowname">Warning:</td><td><a href="#EndPath">line 599, column 10</a><br />Null pointer passed to 1st parameter expecting 'nonnull'</td></tr>

</table>
<td class="Button"><a href="report/ee1b64">Report Bug</a></td>
<h3>Annotated Source Code</h3>
<p>Press <a href="#" onclick="toggleHelp(); return false;">'?'</a>
   to see keyboard shortcuts</p>
<input type="checkbox" class="spoilerhider" id="showinvocation" />
<label for="showinvocation" >Show analyzer invocation</label>
<div class="spoiler">clang -cc1 -cc1 -triple x86_64-unknown-linux-gnu -analyze -disable-free -disable-llvm-verifier -discard-value-names -main-file-name redis-cli.c -analyzer-store=region -analyzer-opt-analyze-nested-blocks -analyzer-checker=core -analyzer-checker=apiModeling -analyzer-checker=unix -analyzer-checker=deadcode -analyzer-checker=security.insecureAPI.UncheckedReturn -analyzer-checker=security.insecureAPI.getpw -analyzer-checker=security.insecureAPI.gets -analyzer-checker=security.insecureAPI.mktemp -analyzer-checker=security.insecureAPI.mkstemp -analyzer-checker=security.insecureAPI.vfork -analyzer-checker=nullability.NullPassedToNonnull -analyzer-checker=nullability.NullReturnedFromNonnull -analyzer-output plist -w -setup-static-analyzer -mrelocation-model static -mframe-pointer=none -fmath-errno -fno-rounding-math -mconstructor-aliases -munwind-tables -target-cpu x86-64 -fno-split-dwarf-inlining -debugger-tuning=gdb -resource-dir /usr/lib64/clang/11.1.0 -D REDIS_STATIC= -I ../deps/hiredis -I ../deps/linenoise -I ../deps/lua/src -I ../deps/hdr_histogram -D USE_JEMALLOC -I ../deps/jemalloc/include -internal-isystem /usr/local/include -internal-isystem /usr/lib64/clang/11.1.0/include -internal-externc-isystem /include -internal-externc-isystem /usr/include -O2 -Wno-missing-field-initializers -std=c11 -fdebug-compilation-dir /home/moshaiov/workplace/redis/src -ferror-limit 19 -fgnuc-version=4.2.1 -vectorize-loops -vectorize-slp -analyzer-output=html -faddrsig -o /tmp/scan-build-2022-07-13-141753-7578-1 -x c redis-cli.c
</div>
<div id='tooltiphint' hidden="true">
  <p>Keyboard shortcuts: </p>
  <ul>
    <li>Use 'j/k' keys for keyboard navigation</li>
    <li>Use 'Shift+S' to show/hide relevant lines</li>
    <li>Use '?' to toggle this window</li>
  </ul>
  <a href="#" onclick="toggleHelp(); return false;">Close</a>
</div>
<script type='text/javascript'>
var relevant_lines = {"1": {"541": 1, "542": 1, "543": 1, "552": 1, "553": 1, "554": 1, "555": 1, "556": 1, "557": 1, "558": 1, "559": 1, "560": 1, "563": 1, "566": 1, "599": 1}};

var filterCounterexample = function (hide) {
  var tables = document.getElementsByClassName("code");
  for (var t=0; t<tables.length; t++) {
    var table = tables[t];
    var file_id = table.getAttribute("data-fileid");
    var lines_in_fid = relevant_lines[file_id];
    if (!lines_in_fid) {
      lines_in_fid = {};
    }
    var lines = table.getElementsByClassName("codeline");
    for (var i=0; i<lines.length; i++) {
        var el = lines[i];
        var lineNo = el.getAttribute("data-linenumber");
        if (!lines_in_fid[lineNo]) {
          if (hide) {
            el.setAttribute("hidden", "");
          } else {
            el.removeAttribute("hidden");
          }
        }
    }
  }
}

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "S") {
    var checked = document.getElementsByName("showCounterexample")[0].checked;
    filterCounterexample(!checked);
    document.getElementsByName("showCounterexample")[0].checked = !checked;
  } else {
    return;
  }
  event.preventDefault();
}, true);

document.addEventListener("DOMContentLoaded", function() {
    document.querySelector('input[name="showCounterexample"]').onchange=
        function (event) {
      filterCounterexample(this.checked);
    };
});
</script>

<form>
    <input type="checkbox" name="showCounterexample" id="showCounterexample" />
    <label for="showCounterexample">
       Show only relevant lines
    </label>
</form>

<script type='text/javascript'>
var digitMatcher = new RegExp("[0-9]+");

var querySelectorAllArray = function(selector) {
  return Array.prototype.slice.call(
    document.querySelectorAll(selector));
}

document.addEventListener("DOMContentLoaded", function() {
    querySelectorAllArray(".PathNav > a").forEach(
        function(currentValue, currentIndex) {
            var hrefValue = currentValue.getAttribute("href");
            currentValue.onclick = function() {
                scrollTo(document.querySelector(hrefValue));
                return false;
            };
        });
});

var findNum = function() {
    var s = document.querySelector(".selected");
    if (!s || s.id == "EndPath") {
        return 0;
    }
    var out = parseInt(digitMatcher.exec(s.id)[0]);
    return out;
};

var scrollTo = function(el) {
    querySelectorAllArray(".selected").forEach(function(s) {
        s.classList.remove("selected");
    });
    el.classList.add("selected");
    window.scrollBy(0, el.getBoundingClientRect().top -
        (window.innerHeight / 2));
}

var move = function(num, up, numItems) {
  if (num == 1 && up || num == numItems - 1 && !up) {
    return 0;
  } else if (num == 0 && up) {
    return numItems - 1;
  } else if (num == 0 && !up) {
    return 1 % numItems;
  }
  return up ? num - 1 : num + 1;
}

var numToId = function(num) {
  if (num == 0) {
    return document.getElementById("EndPath")
  }
  return document.getElementById("Path" + num);
};

var navigateTo = function(up) {
  var numItems = document.querySelectorAll(
      ".line > .msgEvent, .line > .msgControl").length;
  var currentSelected = findNum();
  var newSelected = move(currentSelected, up, numItems);
  var newEl = numToId(newSelected, numItems);

  // Scroll element into center.
  scrollTo(newEl);
};

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "j") {
    navigateTo(/*up=*/false);
  } else if (event.key == "k") {
    navigateTo(/*up=*/true);
  } else {
    return;
  }
  event.preventDefault();
}, true);
</script>
  
<script type='text/javascript'>

var toggleHelp = function() {
    var hint = document.querySelector("#tooltiphint");
    var attributeName = "hidden";
    if (hint.hasAttribute(attributeName)) {
      hint.removeAttribute(attributeName);
    } else {
      hint.setAttribute("hidden", "true");
    }
};
window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "?") {
    toggleHelp();
  } else {
    return;
  }
  event.preventDefault();
});
</script>
<table class="code" data-fileid="1">
<tr class="codeline" data-linenumber="1"><td class="num" id="LN1">1</td><td class="line"><span class='comment'>/* Redis CLI (command line interface)</span></td></tr>
<tr class="codeline" data-linenumber="2"><td class="num" id="LN2">2</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3"><td class="num" id="LN3">3</td><td class="line"> <span class='comment'>* Copyright (c) 2009-2012, Salvatore Sanfilippo &lt;antirez at gmail dot com&gt;</span></td></tr>
<tr class="codeline" data-linenumber="4"><td class="num" id="LN4">4</td><td class="line"> <span class='comment'>* All rights reserved.</span></td></tr>
<tr class="codeline" data-linenumber="5"><td class="num" id="LN5">5</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="6"><td class="num" id="LN6">6</td><td class="line"> <span class='comment'>* Redistribution and use in source and binary forms, with or without</span></td></tr>
<tr class="codeline" data-linenumber="7"><td class="num" id="LN7">7</td><td class="line"> <span class='comment'>* modification, are permitted provided that the following conditions are met:</span></td></tr>
<tr class="codeline" data-linenumber="8"><td class="num" id="LN8">8</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="9"><td class="num" id="LN9">9</td><td class="line"> <span class='comment'>*   * Redistributions of source code must retain the above copyright notice,</span></td></tr>
<tr class="codeline" data-linenumber="10"><td class="num" id="LN10">10</td><td class="line"> <span class='comment'>*     this list of conditions and the following disclaimer.</span></td></tr>
<tr class="codeline" data-linenumber="11"><td class="num" id="LN11">11</td><td class="line"> <span class='comment'>*   * Redistributions in binary form must reproduce the above copyright</span></td></tr>
<tr class="codeline" data-linenumber="12"><td class="num" id="LN12">12</td><td class="line"> <span class='comment'>*     notice, this list of conditions and the following disclaimer in the</span></td></tr>
<tr class="codeline" data-linenumber="13"><td class="num" id="LN13">13</td><td class="line"> <span class='comment'>*     documentation and/or other materials provided with the distribution.</span></td></tr>
<tr class="codeline" data-linenumber="14"><td class="num" id="LN14">14</td><td class="line"> <span class='comment'>*   * Neither the name of Redis nor the names of its contributors may be used</span></td></tr>
<tr class="codeline" data-linenumber="15"><td class="num" id="LN15">15</td><td class="line"> <span class='comment'>*     to endorse or promote products derived from this software without</span></td></tr>
<tr class="codeline" data-linenumber="16"><td class="num" id="LN16">16</td><td class="line"> <span class='comment'>*     specific prior written permission.</span></td></tr>
<tr class="codeline" data-linenumber="17"><td class="num" id="LN17">17</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="18"><td class="num" id="LN18">18</td><td class="line"> <span class='comment'>* THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"</span></td></tr>
<tr class="codeline" data-linenumber="19"><td class="num" id="LN19">19</td><td class="line"> <span class='comment'>* AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span></td></tr>
<tr class="codeline" data-linenumber="20"><td class="num" id="LN20">20</td><td class="line"> <span class='comment'>* IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span></td></tr>
<tr class="codeline" data-linenumber="21"><td class="num" id="LN21">21</td><td class="line"> <span class='comment'>* ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE</span></td></tr>
<tr class="codeline" data-linenumber="22"><td class="num" id="LN22">22</td><td class="line"> <span class='comment'>* LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span></td></tr>
<tr class="codeline" data-linenumber="23"><td class="num" id="LN23">23</td><td class="line"> <span class='comment'>* CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span></td></tr>
<tr class="codeline" data-linenumber="24"><td class="num" id="LN24">24</td><td class="line"> <span class='comment'>* SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span></td></tr>
<tr class="codeline" data-linenumber="25"><td class="num" id="LN25">25</td><td class="line"> <span class='comment'>* INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span></td></tr>
<tr class="codeline" data-linenumber="26"><td class="num" id="LN26">26</td><td class="line"> <span class='comment'>* CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span></td></tr>
<tr class="codeline" data-linenumber="27"><td class="num" id="LN27">27</td><td class="line"> <span class='comment'>* ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span></td></tr>
<tr class="codeline" data-linenumber="28"><td class="num" id="LN28">28</td><td class="line"> <span class='comment'>* POSSIBILITY OF SUCH DAMAGE.</span></td></tr>
<tr class="codeline" data-linenumber="29"><td class="num" id="LN29">29</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="30"><td class="num" id="LN30">30</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="31"><td class="num" id="LN31">31</td><td class="line"><span class='directive'>#include "fmacros.h"</span></td></tr>
<tr class="codeline" data-linenumber="32"><td class="num" id="LN32">32</td><td class="line"><span class='directive'>#include "version.h"</span></td></tr>
<tr class="codeline" data-linenumber="33"><td class="num" id="LN33">33</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="34"><td class="num" id="LN34">34</td><td class="line"><span class='directive'>#include &lt;stdio.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="35"><td class="num" id="LN35">35</td><td class="line"><span class='directive'>#include &lt;string.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="36"><td class="num" id="LN36">36</td><td class="line"><span class='directive'>#include &lt;stdlib.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="37"><td class="num" id="LN37">37</td><td class="line"><span class='directive'>#include &lt;signal.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="38"><td class="num" id="LN38">38</td><td class="line"><span class='directive'>#include &lt;unistd.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="39"><td class="num" id="LN39">39</td><td class="line"><span class='directive'>#include &lt;time.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="40"><td class="num" id="LN40">40</td><td class="line"><span class='directive'>#include &lt;ctype.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="41"><td class="num" id="LN41">41</td><td class="line"><span class='directive'>#include &lt;<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="42"><td class="num" id="LN42">42</td><td class="line"><span class='directive'>#include &lt;sys/stat.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="43"><td class="num" id="LN43">43</td><td class="line"><span class='directive'>#include &lt;sys/time.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="44"><td class="num" id="LN44">44</td><td class="line"><span class='directive'>#include &lt;assert.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="45"><td class="num" id="LN45">45</td><td class="line"><span class='directive'>#include &lt;fcntl.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="46"><td class="num" id="LN46">46</td><td class="line"><span class='directive'>#include &lt;limits.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="47"><td class="num" id="LN47">47</td><td class="line"><span class='directive'>#include &lt;math.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="48"><td class="num" id="LN48">48</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="49"><td class="num" id="LN49">49</td><td class="line"><span class='directive'>#include &lt;hiredis.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="50"><td class="num" id="LN50">50</td><td class="line"><span class='directive'>#ifdef USE_OPENSSL</span></td></tr>
<tr class="codeline" data-linenumber="51"><td class="num" id="LN51">51</td><td class="line"><span class='directive'>#include &lt;openssl/ssl.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="52"><td class="num" id="LN52">52</td><td class="line"><span class='directive'>#include &lt;openssl/err.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="53"><td class="num" id="LN53">53</td><td class="line"><span class='directive'>#include &lt;hiredis_ssl.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="54"><td class="num" id="LN54">54</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="55"><td class="num" id="LN55">55</td><td class="line"><span class='directive'>#include &lt;sdscompat.h&gt; /* Use hiredis' sds compat header that maps sds calls to their hi_ variants */</span></td></tr>
<tr class="codeline" data-linenumber="56"><td class="num" id="LN56">56</td><td class="line"><span class='directive'>#include &lt;<span class='macro'>sds<span class='macro_popup'>hisds</span></span>.h&gt; /* use sds.h from hiredis, so that only one set of sds functions will be present in the binary */</span></td></tr>
<tr class="codeline" data-linenumber="57"><td class="num" id="LN57">57</td><td class="line"><span class='directive'>#include "dict.h"</span></td></tr>
<tr class="codeline" data-linenumber="58"><td class="num" id="LN58">58</td><td class="line"><span class='directive'>#include "adlist.h"</span></td></tr>
<tr class="codeline" data-linenumber="59"><td class="num" id="LN59">59</td><td class="line"><span class='directive'>#include "zmalloc.h"</span></td></tr>
<tr class="codeline" data-linenumber="60"><td class="num" id="LN60">60</td><td class="line"><span class='directive'>#include "linenoise.h"</span></td></tr>
<tr class="codeline" data-linenumber="61"><td class="num" id="LN61">61</td><td class="line"><span class='directive'>#include "help.h" /* Used for backwards-compatibility with pre-7.0 servers that don't support COMMAND DOCS. */</span></td></tr>
<tr class="codeline" data-linenumber="62"><td class="num" id="LN62">62</td><td class="line"><span class='directive'>#include "anet.h"</span></td></tr>
<tr class="codeline" data-linenumber="63"><td class="num" id="LN63">63</td><td class="line"><span class='directive'>#include "ae.h"</span></td></tr>
<tr class="codeline" data-linenumber="64"><td class="num" id="LN64">64</td><td class="line"><span class='directive'>#include "cli_common.h"</span></td></tr>
<tr class="codeline" data-linenumber="65"><td class="num" id="LN65">65</td><td class="line"><span class='directive'>#include "mt19937-64.h"</span></td></tr>
<tr class="codeline" data-linenumber="66"><td class="num" id="LN66">66</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="67"><td class="num" id="LN67">67</td><td class="line"><span class='directive'>#define <span class='macro'>UNUSED(V)<span class='macro_popup'>((void) V)</span></span> ((void) V)</span></td></tr>
<tr class="codeline" data-linenumber="68"><td class="num" id="LN68">68</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="69"><td class="num" id="LN69">69</td><td class="line"><span class='directive'>#define <span class='macro'>OUTPUT_STANDARD<span class='macro_popup'>0</span></span> 0</span></td></tr>
<tr class="codeline" data-linenumber="70"><td class="num" id="LN70">70</td><td class="line"><span class='directive'>#define <span class='macro'>OUTPUT_RAW<span class='macro_popup'>1</span></span> 1</span></td></tr>
<tr class="codeline" data-linenumber="71"><td class="num" id="LN71">71</td><td class="line"><span class='directive'>#define <span class='macro'>OUTPUT_CSV<span class='macro_popup'>2</span></span> 2</span></td></tr>
<tr class="codeline" data-linenumber="72"><td class="num" id="LN72">72</td><td class="line"><span class='directive'>#define <span class='macro'>OUTPUT_JSON<span class='macro_popup'>3</span></span> 3</span></td></tr>
<tr class="codeline" data-linenumber="73"><td class="num" id="LN73">73</td><td class="line"><span class='directive'>#define <span class='macro'>OUTPUT_QUOTED_JSON<span class='macro_popup'>4</span></span> 4</span></td></tr>
<tr class="codeline" data-linenumber="74"><td class="num" id="LN74">74</td><td class="line"><span class='directive'>#define <span class='macro'>REDIS_CLI_KEEPALIVE_INTERVAL<span class='macro_popup'>15</span></span> 15 /* seconds */</span></td></tr>
<tr class="codeline" data-linenumber="75"><td class="num" id="LN75">75</td><td class="line"><span class='directive'>#define <span class='macro'>REDIS_CLI_DEFAULT_PIPE_TIMEOUT<span class='macro_popup'>30</span></span> 30 /* seconds */</span></td></tr>
<tr class="codeline" data-linenumber="76"><td class="num" id="LN76">76</td><td class="line"><span class='directive'>#define <span class='macro'>REDIS_CLI_HISTFILE_ENV<span class='macro_popup'>"REDISCLI_HISTFILE"</span></span> "REDISCLI_HISTFILE"</span></td></tr>
<tr class="codeline" data-linenumber="77"><td class="num" id="LN77">77</td><td class="line"><span class='directive'>#define <span class='macro'>REDIS_CLI_HISTFILE_DEFAULT<span class='macro_popup'>".rediscli_history"</span></span> ".rediscli_history"</span></td></tr>
<tr class="codeline" data-linenumber="78"><td class="num" id="LN78">78</td><td class="line"><span class='directive'>#define <span class='macro'>REDIS_CLI_RCFILE_ENV<span class='macro_popup'>"REDISCLI_RCFILE"</span></span> "REDISCLI_RCFILE"</span></td></tr>
<tr class="codeline" data-linenumber="79"><td class="num" id="LN79">79</td><td class="line"><span class='directive'>#define <span class='macro'>REDIS_CLI_RCFILE_DEFAULT<span class='macro_popup'>".redisclirc"</span></span> ".redisclirc"</span></td></tr>
<tr class="codeline" data-linenumber="80"><td class="num" id="LN80">80</td><td class="line"><span class='directive'>#define <span class='macro'>REDIS_CLI_AUTH_ENV<span class='macro_popup'>"REDISCLI_AUTH"</span></span> "REDISCLI_AUTH"</span></td></tr>
<tr class="codeline" data-linenumber="81"><td class="num" id="LN81">81</td><td class="line"><span class='directive'>#define <span class='macro'>REDIS_CLI_CLUSTER_YES_ENV<span class='macro_popup'>"REDISCLI_CLUSTER_YES"</span></span> "REDISCLI_CLUSTER_YES"</span></td></tr>
<tr class="codeline" data-linenumber="82"><td class="num" id="LN82">82</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="83"><td class="num" id="LN83">83</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_SLOTS<span class='macro_popup'>16384</span></span>               16384</span></td></tr>
<tr class="codeline" data-linenumber="84"><td class="num" id="LN84">84</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_PORT_INCR<span class='macro_popup'>10000</span></span>           10000 /* same as CLUSTER_PORT_INCR */</span></td></tr>
<tr class="codeline" data-linenumber="85"><td class="num" id="LN85">85</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_MIGRATE_TIMEOUT<span class='macro_popup'>60000</span></span>     60000</span></td></tr>
<tr class="codeline" data-linenumber="86"><td class="num" id="LN86">86</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_MIGRATE_PIPELINE<span class='macro_popup'>10</span></span>    10</span></td></tr>
<tr class="codeline" data-linenumber="87"><td class="num" id="LN87">87</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_REBALANCE_THRESHOLD<span class='macro_popup'>2</span></span> 2</span></td></tr>
<tr class="codeline" data-linenumber="88"><td class="num" id="LN88">88</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="89"><td class="num" id="LN89">89</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_INVALID_HOST_ARG<span class='macro_popup'>"[ERR] Invalid arguments: you need to pass either a valid " "address (ie. 120.0.0.1:7000) or space separated IP "<br> "and port (ie. 120.0.0.1 7000)\n"</span></span> \</span></td></tr>
<tr class="codeline" data-linenumber="90"><td class="num" id="LN90">90</td><td class="line">    <span class='directive'>"[ERR] Invalid arguments: you need to pass either a valid " \</span></td></tr>
<tr class="codeline" data-linenumber="91"><td class="num" id="LN91">91</td><td class="line">    <span class='directive'>"address (ie. 120.0.0.1:7000) or space separated IP " \</span></td></tr>
<tr class="codeline" data-linenumber="92"><td class="num" id="LN92">92</td><td class="line">    <span class='directive'>"and port (ie. 120.0.0.1 7000)\n"</span></td></tr>
<tr class="codeline" data-linenumber="93"><td class="num" id="LN93">93</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_MODE()<span class='macro_popup'>(config.cluster_manager_command.name != ((void*)0))</span></span> (config.cluster_manager_command.name != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="94"><td class="num" id="LN94">94</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_MASTERS_COUNT(nodes, replicas)<span class='macro_popup'>(nodes/(replicas + 1))</span></span> (nodes/(replicas + 1))</span></td></tr>
<tr class="codeline" data-linenumber="95"><td class="num" id="LN95">95</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_COMMAND(n,...)<span class='macro_popup'>(redisCommand(n-&gt;context, ...))</span></span> \</span></td></tr>
<tr class="codeline" data-linenumber="96"><td class="num" id="LN96">96</td><td class="line">        <span class='directive'>(redisCommand(n-&gt;context, __VA_ARGS__))</span></td></tr>
<tr class="codeline" data-linenumber="97"><td class="num" id="LN97">97</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="98"><td class="num" id="LN98">98</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_NODE_ARRAY_FREE(array)<span class='macro_popup'>zfree(array-&gt;alloc)</span></span> zfree(array-&gt;alloc)</span></td></tr>
<tr class="codeline" data-linenumber="99"><td class="num" id="LN99">99</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="100"><td class="num" id="LN100">100</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_PRINT_REPLY_ERROR(n, err)<span class='macro_popup'>clusterManagerLog(3,"Node %s:%d replied with error:\n%s\n", n<br>-&gt;ip, n-&gt;port, err);</span></span> \</span></td></tr>
<tr class="codeline" data-linenumber="101"><td class="num" id="LN101">101</td><td class="line">    <span class='directive'><span class='macro'>clusterManagerLogErr("Node %s:%d replied with error:\n%s\n", \<span class='macro_popup'>clusterManagerLog(3,"Node %s:%d replied with error:\n%s\n", n<br>-&gt;ip, n-&gt;port, err)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="102"><td class="num" id="LN102">102</td><td class="line">                         <span class='directive'><span class='macro'>n-&gt;ip, n-&gt;port, err)<span class='macro_popup'>clusterManagerLog(3,"Node %s:%d replied with error:\n%s\n", n<br>-&gt;ip, n-&gt;port, err)</span></span>;</span></td></tr>
<tr class="codeline" data-linenumber="103"><td class="num" id="LN103">103</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="104"><td class="num" id="LN104">104</td><td class="line"><span class='directive'>#define <span class='macro'>clusterManagerLogInfo(...)<span class='macro_popup'>clusterManagerLog(1,...)</span></span> \</span></td></tr>
<tr class="codeline" data-linenumber="105"><td class="num" id="LN105">105</td><td class="line">    <span class='directive'>clusterManagerLog(<span class='macro'>CLUSTER_MANAGER_LOG_LVL_INFO<span class='macro_popup'>1</span></span>,__VA_ARGS__)</span></td></tr>
<tr class="codeline" data-linenumber="106"><td class="num" id="LN106">106</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="107"><td class="num" id="LN107">107</td><td class="line"><span class='directive'>#define <span class='macro'>clusterManagerLogErr(...)<span class='macro_popup'>clusterManagerLog(3,...)</span></span> \</span></td></tr>
<tr class="codeline" data-linenumber="108"><td class="num" id="LN108">108</td><td class="line">    <span class='directive'>clusterManagerLog(<span class='macro'>CLUSTER_MANAGER_LOG_LVL_ERR<span class='macro_popup'>3</span></span>,__VA_ARGS__)</span></td></tr>
<tr class="codeline" data-linenumber="109"><td class="num" id="LN109">109</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="110"><td class="num" id="LN110">110</td><td class="line"><span class='directive'>#define <span class='macro'>clusterManagerLogWarn(...)<span class='macro_popup'>clusterManagerLog(2,...)</span></span> \</span></td></tr>
<tr class="codeline" data-linenumber="111"><td class="num" id="LN111">111</td><td class="line">    <span class='directive'>clusterManagerLog(<span class='macro'>CLUSTER_MANAGER_LOG_LVL_WARN<span class='macro_popup'>2</span></span>,__VA_ARGS__)</span></td></tr>
<tr class="codeline" data-linenumber="112"><td class="num" id="LN112">112</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="113"><td class="num" id="LN113">113</td><td class="line"><span class='directive'>#define <span class='macro'>clusterManagerLogOk(...)<span class='macro_popup'>clusterManagerLog(4,...)</span></span> \</span></td></tr>
<tr class="codeline" data-linenumber="114"><td class="num" id="LN114">114</td><td class="line">    <span class='directive'>clusterManagerLog(<span class='macro'>CLUSTER_MANAGER_LOG_LVL_SUCCESS<span class='macro_popup'>4</span></span>,__VA_ARGS__)</span></td></tr>
<tr class="codeline" data-linenumber="115"><td class="num" id="LN115">115</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="116"><td class="num" id="LN116">116</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_FLAG_MYSELF<span class='macro_popup'>1 &lt;&lt; 0</span></span>     1 &lt;&lt; 0</span></td></tr>
<tr class="codeline" data-linenumber="117"><td class="num" id="LN117">117</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_FLAG_SLAVE<span class='macro_popup'>1 &lt;&lt; 1</span></span>      1 &lt;&lt; 1</span></td></tr>
<tr class="codeline" data-linenumber="118"><td class="num" id="LN118">118</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_FLAG_FRIEND<span class='macro_popup'>1 &lt;&lt; 2</span></span>     1 &lt;&lt; 2</span></td></tr>
<tr class="codeline" data-linenumber="119"><td class="num" id="LN119">119</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_FLAG_NOADDR<span class='macro_popup'>1 &lt;&lt; 3</span></span>     1 &lt;&lt; 3</span></td></tr>
<tr class="codeline" data-linenumber="120"><td class="num" id="LN120">120</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_FLAG_DISCONNECT<span class='macro_popup'>1 &lt;&lt; 4</span></span> 1 &lt;&lt; 4</span></td></tr>
<tr class="codeline" data-linenumber="121"><td class="num" id="LN121">121</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_FLAG_FAIL<span class='macro_popup'>1 &lt;&lt; 5</span></span>       1 &lt;&lt; 5</span></td></tr>
<tr class="codeline" data-linenumber="122"><td class="num" id="LN122">122</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="123"><td class="num" id="LN123">123</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_FIX<span class='macro_popup'>1 &lt;&lt; 0</span></span>            1 &lt;&lt; 0</span></td></tr>
<tr class="codeline" data-linenumber="124"><td class="num" id="LN124">124</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_SLAVE<span class='macro_popup'>1 &lt;&lt; 1</span></span>          1 &lt;&lt; 1</span></td></tr>
<tr class="codeline" data-linenumber="125"><td class="num" id="LN125">125</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_YES<span class='macro_popup'>1 &lt;&lt; 2</span></span>            1 &lt;&lt; 2</span></td></tr>
<tr class="codeline" data-linenumber="126"><td class="num" id="LN126">126</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_AUTOWEIGHTS<span class='macro_popup'>1 &lt;&lt; 3</span></span>    1 &lt;&lt; 3</span></td></tr>
<tr class="codeline" data-linenumber="127"><td class="num" id="LN127">127</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_EMPTYMASTER<span class='macro_popup'>1 &lt;&lt; 4</span></span>    1 &lt;&lt; 4</span></td></tr>
<tr class="codeline" data-linenumber="128"><td class="num" id="LN128">128</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_SIMULATE<span class='macro_popup'>1 &lt;&lt; 5</span></span>       1 &lt;&lt; 5</span></td></tr>
<tr class="codeline" data-linenumber="129"><td class="num" id="LN129">129</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_REPLACE<span class='macro_popup'>1 &lt;&lt; 6</span></span>        1 &lt;&lt; 6</span></td></tr>
<tr class="codeline" data-linenumber="130"><td class="num" id="LN130">130</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_COPY<span class='macro_popup'>1 &lt;&lt; 7</span></span>           1 &lt;&lt; 7</span></td></tr>
<tr class="codeline" data-linenumber="131"><td class="num" id="LN131">131</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_COLOR<span class='macro_popup'>1 &lt;&lt; 8</span></span>          1 &lt;&lt; 8</span></td></tr>
<tr class="codeline" data-linenumber="132"><td class="num" id="LN132">132</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_CHECK_OWNERS<span class='macro_popup'>1 &lt;&lt; 9</span></span>   1 &lt;&lt; 9</span></td></tr>
<tr class="codeline" data-linenumber="133"><td class="num" id="LN133">133</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_FIX_WITH_UNREACHABLE_MASTERS<span class='macro_popup'>1 &lt;&lt; 10</span></span> 1 &lt;&lt; 10</span></td></tr>
<tr class="codeline" data-linenumber="134"><td class="num" id="LN134">134</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_MASTERS_ONLY<span class='macro_popup'>1 &lt;&lt; 11</span></span>   1 &lt;&lt; 11</span></td></tr>
<tr class="codeline" data-linenumber="135"><td class="num" id="LN135">135</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_SLAVES_ONLY<span class='macro_popup'>1 &lt;&lt; 12</span></span>    1 &lt;&lt; 12</span></td></tr>
<tr class="codeline" data-linenumber="136"><td class="num" id="LN136">136</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="137"><td class="num" id="LN137">137</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_OPT_GETFRIENDS<span class='macro_popup'>1 &lt;&lt; 0</span></span>  1 &lt;&lt; 0</span></td></tr>
<tr class="codeline" data-linenumber="138"><td class="num" id="LN138">138</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_OPT_COLD<span class='macro_popup'>1 &lt;&lt; 1</span></span>        1 &lt;&lt; 1</span></td></tr>
<tr class="codeline" data-linenumber="139"><td class="num" id="LN139">139</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_OPT_UPDATE<span class='macro_popup'>1 &lt;&lt; 2</span></span>      1 &lt;&lt; 2</span></td></tr>
<tr class="codeline" data-linenumber="140"><td class="num" id="LN140">140</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_OPT_QUIET<span class='macro_popup'>1 &lt;&lt; 6</span></span>       1 &lt;&lt; 6</span></td></tr>
<tr class="codeline" data-linenumber="141"><td class="num" id="LN141">141</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_OPT_VERBOSE<span class='macro_popup'>1 &lt;&lt; 7</span></span>     1 &lt;&lt; 7</span></td></tr>
<tr class="codeline" data-linenumber="142"><td class="num" id="LN142">142</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="143"><td class="num" id="LN143">143</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_LOG_LVL_INFO<span class='macro_popup'>1</span></span>    1</span></td></tr>
<tr class="codeline" data-linenumber="144"><td class="num" id="LN144">144</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_LOG_LVL_WARN<span class='macro_popup'>2</span></span>    2</span></td></tr>
<tr class="codeline" data-linenumber="145"><td class="num" id="LN145">145</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_LOG_LVL_ERR<span class='macro_popup'>3</span></span>     3</span></td></tr>
<tr class="codeline" data-linenumber="146"><td class="num" id="LN146">146</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_MANAGER_LOG_LVL_SUCCESS<span class='macro_popup'>4</span></span> 4</span></td></tr>
<tr class="codeline" data-linenumber="147"><td class="num" id="LN147">147</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="148"><td class="num" id="LN148">148</td><td class="line"><span class='directive'>#define <span class='macro'>CLUSTER_JOIN_CHECK_AFTER<span class='macro_popup'>20</span></span>        20</span></td></tr>
<tr class="codeline" data-linenumber="149"><td class="num" id="LN149">149</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="150"><td class="num" id="LN150">150</td><td class="line"><span class='directive'>#define <span class='macro'>LOG_COLOR_BOLD<span class='macro_popup'>"29;1m"</span></span>      "29;1m"</span></td></tr>
<tr class="codeline" data-linenumber="151"><td class="num" id="LN151">151</td><td class="line"><span class='directive'>#define <span class='macro'>LOG_COLOR_RED<span class='macro_popup'>"31;1m"</span></span>       "31;1m"</span></td></tr>
<tr class="codeline" data-linenumber="152"><td class="num" id="LN152">152</td><td class="line"><span class='directive'>#define <span class='macro'>LOG_COLOR_GREEN<span class='macro_popup'>"32;1m"</span></span>     "32;1m"</span></td></tr>
<tr class="codeline" data-linenumber="153"><td class="num" id="LN153">153</td><td class="line"><span class='directive'>#define <span class='macro'>LOG_COLOR_YELLOW<span class='macro_popup'>"33;1m"</span></span>    "33;1m"</span></td></tr>
<tr class="codeline" data-linenumber="154"><td class="num" id="LN154">154</td><td class="line"><span class='directive'>#define <span class='macro'>LOG_COLOR_RESET<span class='macro_popup'>"0m"</span></span>     "0m"</span></td></tr>
<tr class="codeline" data-linenumber="155"><td class="num" id="LN155">155</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="156"><td class="num" id="LN156">156</td><td class="line"><span class='comment'>/* cliConnect() flags. */</span></td></tr>
<tr class="codeline" data-linenumber="157"><td class="num" id="LN157">157</td><td class="line"><span class='directive'>#define <span class='macro'>CC_FORCE<span class='macro_popup'>(1&lt;&lt;0)</span></span> (1&lt;&lt;0)         /* Re-connect if already connected. */</span></td></tr>
<tr class="codeline" data-linenumber="158"><td class="num" id="LN158">158</td><td class="line"><span class='directive'>#define <span class='macro'>CC_QUIET<span class='macro_popup'>(1&lt;&lt;1)</span></span> (1&lt;&lt;1)         /* Don't log connecting errors. */</span></td></tr>
<tr class="codeline" data-linenumber="159"><td class="num" id="LN159">159</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="160"><td class="num" id="LN160">160</td><td class="line"><span class='comment'>/* DNS lookup */</span></td></tr>
<tr class="codeline" data-linenumber="161"><td class="num" id="LN161">161</td><td class="line"><span class='directive'>#define <span class='macro'>NET_IP_STR_LEN<span class='macro_popup'>46</span></span> 46       /* INET6_ADDRSTRLEN is 46 */</span></td></tr>
<tr class="codeline" data-linenumber="162"><td class="num" id="LN162">162</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="163"><td class="num" id="LN163">163</td><td class="line"><span class='comment'>/* --latency-dist palettes. */</span></td></tr>
<tr class="codeline" data-linenumber="164"><td class="num" id="LN164">164</td><td class="line"><span class='keyword'>int</span> spectrum_palette_color_size = 19;</td></tr>
<tr class="codeline" data-linenumber="165"><td class="num" id="LN165">165</td><td class="line"><span class='keyword'>int</span> spectrum_palette_color[] = {0,233,234,235,237,239,241,243,245,247,144,143,142,184,226,214,208,202,196};</td></tr>
<tr class="codeline" data-linenumber="166"><td class="num" id="LN166">166</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="167"><td class="num" id="LN167">167</td><td class="line"><span class='keyword'>int</span> spectrum_palette_mono_size = 13;</td></tr>
<tr class="codeline" data-linenumber="168"><td class="num" id="LN168">168</td><td class="line"><span class='keyword'>int</span> spectrum_palette_mono[] = {0,233,234,235,237,239,241,243,245,247,249,251,253};</td></tr>
<tr class="codeline" data-linenumber="169"><td class="num" id="LN169">169</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="170"><td class="num" id="LN170">170</td><td class="line"><span class='comment'>/* The actual palette in use. */</span></td></tr>
<tr class="codeline" data-linenumber="171"><td class="num" id="LN171">171</td><td class="line"><span class='keyword'>int</span> *spectrum_palette;</td></tr>
<tr class="codeline" data-linenumber="172"><td class="num" id="LN172">172</td><td class="line"><span class='keyword'>int</span> spectrum_palette_size;</td></tr>
<tr class="codeline" data-linenumber="173"><td class="num" id="LN173">173</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="174"><td class="num" id="LN174">174</td><td class="line"><span class='comment'>/* Dict Helpers */</span></td></tr>
<tr class="codeline" data-linenumber="175"><td class="num" id="LN175">175</td><td class="line"><span class='keyword'>static</span> uint64_t dictSdsHash(<span class='keyword'>const</span> <span class='keyword'>void</span> *key);</td></tr>
<tr class="codeline" data-linenumber="176"><td class="num" id="LN176">176</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> dictSdsKeyCompare(dict *d, <span class='keyword'>const</span> <span class='keyword'>void</span> *key1,</td></tr>
<tr class="codeline" data-linenumber="177"><td class="num" id="LN177">177</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>void</span> *key2);</td></tr>
<tr class="codeline" data-linenumber="178"><td class="num" id="LN178">178</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> dictSdsDestructor(dict *d, <span class='keyword'>void</span> *val);</td></tr>
<tr class="codeline" data-linenumber="179"><td class="num" id="LN179">179</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> dictListDestructor(dict *d, <span class='keyword'>void</span> *val);</td></tr>
<tr class="codeline" data-linenumber="180"><td class="num" id="LN180">180</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="181"><td class="num" id="LN181">181</td><td class="line"><span class='comment'>/* Command documentation info used for help output */</span></td></tr>
<tr class="codeline" data-linenumber="182"><td class="num" id="LN182">182</td><td class="line"><span class='keyword'>struct</span> commandDocs {</td></tr>
<tr class="codeline" data-linenumber="183"><td class="num" id="LN183">183</td><td class="line">    <span class='keyword'>char</span> *name;</td></tr>
<tr class="codeline" data-linenumber="184"><td class="num" id="LN184">184</td><td class="line">    <span class='keyword'>char</span> *params; <span class='comment'>/* A string describing the syntax of the command arguments. */</span></td></tr>
<tr class="codeline" data-linenumber="185"><td class="num" id="LN185">185</td><td class="line">    <span class='keyword'>char</span> *summary;</td></tr>
<tr class="codeline" data-linenumber="186"><td class="num" id="LN186">186</td><td class="line">    <span class='keyword'>char</span> *group;</td></tr>
<tr class="codeline" data-linenumber="187"><td class="num" id="LN187">187</td><td class="line">    <span class='keyword'>char</span> *since;</td></tr>
<tr class="codeline" data-linenumber="188"><td class="num" id="LN188">188</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="189"><td class="num" id="LN189">189</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="190"><td class="num" id="LN190">190</td><td class="line"><span class='comment'>/* Cluster Manager Command Info */</span></td></tr>
<tr class="codeline" data-linenumber="191"><td class="num" id="LN191">191</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> clusterManagerCommand {</td></tr>
<tr class="codeline" data-linenumber="192"><td class="num" id="LN192">192</td><td class="line">    <span class='keyword'>char</span> *name;</td></tr>
<tr class="codeline" data-linenumber="193"><td class="num" id="LN193">193</td><td class="line">    <span class='keyword'>int</span> argc;</td></tr>
<tr class="codeline" data-linenumber="194"><td class="num" id="LN194">194</td><td class="line">    <span class='keyword'>char</span> **argv;</td></tr>
<tr class="codeline" data-linenumber="195"><td class="num" id="LN195">195</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> stdin_arg; <span class='comment'>/* arg from stdin. (-X option) */</span></td></tr>
<tr class="codeline" data-linenumber="196"><td class="num" id="LN196">196</td><td class="line">    <span class='keyword'>int</span> flags;</td></tr>
<tr class="codeline" data-linenumber="197"><td class="num" id="LN197">197</td><td class="line">    <span class='keyword'>int</span> replicas;</td></tr>
<tr class="codeline" data-linenumber="198"><td class="num" id="LN198">198</td><td class="line">    <span class='keyword'>char</span> *from;</td></tr>
<tr class="codeline" data-linenumber="199"><td class="num" id="LN199">199</td><td class="line">    <span class='keyword'>char</span> *to;</td></tr>
<tr class="codeline" data-linenumber="200"><td class="num" id="LN200">200</td><td class="line">    <span class='keyword'>char</span> **weight;</td></tr>
<tr class="codeline" data-linenumber="201"><td class="num" id="LN201">201</td><td class="line">    <span class='keyword'>int</span> weight_argc;</td></tr>
<tr class="codeline" data-linenumber="202"><td class="num" id="LN202">202</td><td class="line">    <span class='keyword'>char</span> *master_id;</td></tr>
<tr class="codeline" data-linenumber="203"><td class="num" id="LN203">203</td><td class="line">    <span class='keyword'>int</span> slots;</td></tr>
<tr class="codeline" data-linenumber="204"><td class="num" id="LN204">204</td><td class="line">    <span class='keyword'>int</span> timeout;</td></tr>
<tr class="codeline" data-linenumber="205"><td class="num" id="LN205">205</td><td class="line">    <span class='keyword'>int</span> pipeline;</td></tr>
<tr class="codeline" data-linenumber="206"><td class="num" id="LN206">206</td><td class="line">    <span class='keyword'>float</span> threshold;</td></tr>
<tr class="codeline" data-linenumber="207"><td class="num" id="LN207">207</td><td class="line">    <span class='keyword'>char</span> *backup_dir;</td></tr>
<tr class="codeline" data-linenumber="208"><td class="num" id="LN208">208</td><td class="line">    <span class='keyword'>char</span> *from_user;</td></tr>
<tr class="codeline" data-linenumber="209"><td class="num" id="LN209">209</td><td class="line">    <span class='keyword'>char</span> *from_pass;</td></tr>
<tr class="codeline" data-linenumber="210"><td class="num" id="LN210">210</td><td class="line">    <span class='keyword'>int</span> from_askpass;</td></tr>
<tr class="codeline" data-linenumber="211"><td class="num" id="LN211">211</td><td class="line">} clusterManagerCommand;</td></tr>
<tr class="codeline" data-linenumber="212"><td class="num" id="LN212">212</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="213"><td class="num" id="LN213">213</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> createClusterManagerCommand(<span class='keyword'>char</span> *cmdname, <span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv);</td></tr>
<tr class="codeline" data-linenumber="214"><td class="num" id="LN214">214</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="215"><td class="num" id="LN215">215</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="216"><td class="num" id="LN216">216</td><td class="line"><span class='keyword'>static</span> redisContext *context;</td></tr>
<tr class="codeline" data-linenumber="217"><td class="num" id="LN217">217</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>struct</span> config {</td></tr>
<tr class="codeline" data-linenumber="218"><td class="num" id="LN218">218</td><td class="line">    cliConnInfo conn_info;</td></tr>
<tr class="codeline" data-linenumber="219"><td class="num" id="LN219">219</td><td class="line">    <span class='keyword'>char</span> *hostsocket;</td></tr>
<tr class="codeline" data-linenumber="220"><td class="num" id="LN220">220</td><td class="line">    <span class='keyword'>int</span> tls;</td></tr>
<tr class="codeline" data-linenumber="221"><td class="num" id="LN221">221</td><td class="line">    cliSSLconfig sslconfig;</td></tr>
<tr class="codeline" data-linenumber="222"><td class="num" id="LN222">222</td><td class="line">    <span class='keyword'>long</span> repeat;</td></tr>
<tr class="codeline" data-linenumber="223"><td class="num" id="LN223">223</td><td class="line">    <span class='keyword'>long</span> interval;</td></tr>
<tr class="codeline" data-linenumber="224"><td class="num" id="LN224">224</td><td class="line">    <span class='keyword'>int</span> dbnum; <span class='comment'>/* db num currently selected */</span></td></tr>
<tr class="codeline" data-linenumber="225"><td class="num" id="LN225">225</td><td class="line">    <span class='keyword'>int</span> interactive;</td></tr>
<tr class="codeline" data-linenumber="226"><td class="num" id="LN226">226</td><td class="line">    <span class='keyword'>int</span> shutdown;</td></tr>
<tr class="codeline" data-linenumber="227"><td class="num" id="LN227">227</td><td class="line">    <span class='keyword'>int</span> monitor_mode;</td></tr>
<tr class="codeline" data-linenumber="228"><td class="num" id="LN228">228</td><td class="line">    <span class='keyword'>int</span> pubsub_mode;</td></tr>
<tr class="codeline" data-linenumber="229"><td class="num" id="LN229">229</td><td class="line">    <span class='keyword'>int</span> blocking_state_aborted; <span class='comment'>/* used to abort monitor_mode and pubsub_mode. */</span></td></tr>
<tr class="codeline" data-linenumber="230"><td class="num" id="LN230">230</td><td class="line">    <span class='keyword'>int</span> latency_mode;</td></tr>
<tr class="codeline" data-linenumber="231"><td class="num" id="LN231">231</td><td class="line">    <span class='keyword'>int</span> latency_dist_mode;</td></tr>
<tr class="codeline" data-linenumber="232"><td class="num" id="LN232">232</td><td class="line">    <span class='keyword'>int</span> latency_history;</td></tr>
<tr class="codeline" data-linenumber="233"><td class="num" id="LN233">233</td><td class="line">    <span class='keyword'>int</span> lru_test_mode;</td></tr>
<tr class="codeline" data-linenumber="234"><td class="num" id="LN234">234</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> lru_test_sample_size;</td></tr>
<tr class="codeline" data-linenumber="235"><td class="num" id="LN235">235</td><td class="line">    <span class='keyword'>int</span> cluster_mode;</td></tr>
<tr class="codeline" data-linenumber="236"><td class="num" id="LN236">236</td><td class="line">    <span class='keyword'>int</span> cluster_reissue_command;</td></tr>
<tr class="codeline" data-linenumber="237"><td class="num" id="LN237">237</td><td class="line">    <span class='keyword'>int</span> cluster_send_asking;</td></tr>
<tr class="codeline" data-linenumber="238"><td class="num" id="LN238">238</td><td class="line">    <span class='keyword'>int</span> slave_mode;</td></tr>
<tr class="codeline" data-linenumber="239"><td class="num" id="LN239">239</td><td class="line">    <span class='keyword'>int</span> pipe_mode;</td></tr>
<tr class="codeline" data-linenumber="240"><td class="num" id="LN240">240</td><td class="line">    <span class='keyword'>int</span> pipe_timeout;</td></tr>
<tr class="codeline" data-linenumber="241"><td class="num" id="LN241">241</td><td class="line">    <span class='keyword'>int</span> getrdb_mode;</td></tr>
<tr class="codeline" data-linenumber="242"><td class="num" id="LN242">242</td><td class="line">    <span class='keyword'>int</span> get_functions_rdb_mode;</td></tr>
<tr class="codeline" data-linenumber="243"><td class="num" id="LN243">243</td><td class="line">    <span class='keyword'>int</span> stat_mode;</td></tr>
<tr class="codeline" data-linenumber="244"><td class="num" id="LN244">244</td><td class="line">    <span class='keyword'>int</span> scan_mode;</td></tr>
<tr class="codeline" data-linenumber="245"><td class="num" id="LN245">245</td><td class="line">    <span class='keyword'>int</span> intrinsic_latency_mode;</td></tr>
<tr class="codeline" data-linenumber="246"><td class="num" id="LN246">246</td><td class="line">    <span class='keyword'>int</span> intrinsic_latency_duration;</td></tr>
<tr class="codeline" data-linenumber="247"><td class="num" id="LN247">247</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> pattern;</td></tr>
<tr class="codeline" data-linenumber="248"><td class="num" id="LN248">248</td><td class="line">    <span class='keyword'>char</span> *rdb_filename;</td></tr>
<tr class="codeline" data-linenumber="249"><td class="num" id="LN249">249</td><td class="line">    <span class='keyword'>int</span> bigkeys;</td></tr>
<tr class="codeline" data-linenumber="250"><td class="num" id="LN250">250</td><td class="line">    <span class='keyword'>int</span> memkeys;</td></tr>
<tr class="codeline" data-linenumber="251"><td class="num" id="LN251">251</td><td class="line">    <span class='keyword'>unsigned</span> memkeys_samples;</td></tr>
<tr class="codeline" data-linenumber="252"><td class="num" id="LN252">252</td><td class="line">    <span class='keyword'>int</span> hotkeys;</td></tr>
<tr class="codeline" data-linenumber="253"><td class="num" id="LN253">253</td><td class="line">    <span class='keyword'>int</span> stdin_lastarg; <span class='comment'>/* get last arg from stdin. (-x option) */</span></td></tr>
<tr class="codeline" data-linenumber="254"><td class="num" id="LN254">254</td><td class="line">    <span class='keyword'>int</span> stdin_tag_arg; <span class='comment'>/* get &lt;tag&gt; arg from stdin. (-X option) */</span></td></tr>
<tr class="codeline" data-linenumber="255"><td class="num" id="LN255">255</td><td class="line">    <span class='keyword'>char</span> *stdin_tag_name; <span class='comment'>/* Placeholder(tag name) for user input. */</span></td></tr>
<tr class="codeline" data-linenumber="256"><td class="num" id="LN256">256</td><td class="line">    <span class='keyword'>int</span> askpass;</td></tr>
<tr class="codeline" data-linenumber="257"><td class="num" id="LN257">257</td><td class="line">    <span class='keyword'>int</span> quoted_input;   <span class='comment'>/* Force input args to be treated as quoted strings */</span></td></tr>
<tr class="codeline" data-linenumber="258"><td class="num" id="LN258">258</td><td class="line">    <span class='keyword'>int</span> output; <span class='comment'>/* output mode, see OUTPUT_* defines */</span></td></tr>
<tr class="codeline" data-linenumber="259"><td class="num" id="LN259">259</td><td class="line">    <span class='keyword'>int</span> push_output; <span class='comment'>/* Should we display spontaneous PUSH replies */</span></td></tr>
<tr class="codeline" data-linenumber="260"><td class="num" id="LN260">260</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> mb_delim;</td></tr>
<tr class="codeline" data-linenumber="261"><td class="num" id="LN261">261</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> cmd_delim;</td></tr>
<tr class="codeline" data-linenumber="262"><td class="num" id="LN262">262</td><td class="line">    <span class='keyword'>char</span> prompt[128];</td></tr>
<tr class="codeline" data-linenumber="263"><td class="num" id="LN263">263</td><td class="line">    <span class='keyword'>char</span> *eval;</td></tr>
<tr class="codeline" data-linenumber="264"><td class="num" id="LN264">264</td><td class="line">    <span class='keyword'>int</span> eval_ldb;</td></tr>
<tr class="codeline" data-linenumber="265"><td class="num" id="LN265">265</td><td class="line">    <span class='keyword'>int</span> eval_ldb_sync;  <span class='comment'>/* Ask for synchronous mode of the Lua debugger. */</span></td></tr>
<tr class="codeline" data-linenumber="266"><td class="num" id="LN266">266</td><td class="line">    <span class='keyword'>int</span> eval_ldb_end;   <span class='comment'>/* Lua debugging session ended. */</span></td></tr>
<tr class="codeline" data-linenumber="267"><td class="num" id="LN267">267</td><td class="line">    <span class='keyword'>int</span> enable_ldb_on_eval; <span class='comment'>/* Handle manual SCRIPT DEBUG + EVAL commands. */</span></td></tr>
<tr class="codeline" data-linenumber="268"><td class="num" id="LN268">268</td><td class="line">    <span class='keyword'>int</span> last_cmd_type;</td></tr>
<tr class="codeline" data-linenumber="269"><td class="num" id="LN269">269</td><td class="line">    <span class='keyword'>int</span> verbose;</td></tr>
<tr class="codeline" data-linenumber="270"><td class="num" id="LN270">270</td><td class="line">    <span class='keyword'>int</span> set_errcode;</td></tr>
<tr class="codeline" data-linenumber="271"><td class="num" id="LN271">271</td><td class="line">    clusterManagerCommand cluster_manager_command;</td></tr>
<tr class="codeline" data-linenumber="272"><td class="num" id="LN272">272</td><td class="line">    <span class='keyword'>int</span> no_auth_warning;</td></tr>
<tr class="codeline" data-linenumber="273"><td class="num" id="LN273">273</td><td class="line">    <span class='keyword'>int</span> resp2;</td></tr>
<tr class="codeline" data-linenumber="274"><td class="num" id="LN274">274</td><td class="line">    <span class='keyword'>int</span> resp3; <span class='comment'>/* value of 1: specified explicitly, value of 2: implicit like --json option */</span></td></tr>
<tr class="codeline" data-linenumber="275"><td class="num" id="LN275">275</td><td class="line">    <span class='keyword'>int</span> in_multi;</td></tr>
<tr class="codeline" data-linenumber="276"><td class="num" id="LN276">276</td><td class="line">    <span class='keyword'>int</span> pre_multi_dbnum;</td></tr>
<tr class="codeline" data-linenumber="277"><td class="num" id="LN277">277</td><td class="line">} config;</td></tr>
<tr class="codeline" data-linenumber="278"><td class="num" id="LN278">278</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="279"><td class="num" id="LN279">279</td><td class="line"><span class='comment'>/* User preferences. */</span></td></tr>
<tr class="codeline" data-linenumber="280"><td class="num" id="LN280">280</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>struct</span> pref {</td></tr>
<tr class="codeline" data-linenumber="281"><td class="num" id="LN281">281</td><td class="line">    <span class='keyword'>int</span> hints;</td></tr>
<tr class="codeline" data-linenumber="282"><td class="num" id="LN282">282</td><td class="line">} pref;</td></tr>
<tr class="codeline" data-linenumber="283"><td class="num" id="LN283">283</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="284"><td class="num" id="LN284">284</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>volatile</span> sig_atomic_t force_cancel_loop = 0;</td></tr>
<tr class="codeline" data-linenumber="285"><td class="num" id="LN285">285</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> usage(<span class='keyword'>int</span> err);</td></tr>
<tr class="codeline" data-linenumber="286"><td class="num" id="LN286">286</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> slaveMode(<span class='keyword'>void</span>);</td></tr>
<tr class="codeline" data-linenumber="287"><td class="num" id="LN287">287</td><td class="line"><span class='keyword'>char</span> *redisGitSHA1(<span class='keyword'>void</span>);</td></tr>
<tr class="codeline" data-linenumber="288"><td class="num" id="LN288">288</td><td class="line"><span class='keyword'>char</span> *redisGitDirty(<span class='keyword'>void</span>);</td></tr>
<tr class="codeline" data-linenumber="289"><td class="num" id="LN289">289</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> cliConnect(<span class='keyword'>int</span> flags);</td></tr>
<tr class="codeline" data-linenumber="290"><td class="num" id="LN290">290</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="291"><td class="num" id="LN291">291</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>char</span> *getInfoField(<span class='keyword'>char</span> *info, <span class='keyword'>char</span> *field);</td></tr>
<tr class="codeline" data-linenumber="292"><td class="num" id="LN292">292</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>long</span> getLongInfoField(<span class='keyword'>char</span> *info, <span class='keyword'>char</span> *field);</td></tr>
<tr class="codeline" data-linenumber="293"><td class="num" id="LN293">293</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="294"><td class="num" id="LN294">294</td><td class="line"><span class='comment'>/*------------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="295"><td class="num" id="LN295">295</td><td class="line"> <span class='comment'>* Utility functions</span></td></tr>
<tr class="codeline" data-linenumber="296"><td class="num" id="LN296">296</td><td class="line"> <span class='comment'>*--------------------------------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="297"><td class="num" id="LN297">297</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="298"><td class="num" id="LN298">298</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> cliPushHandler(<span class='keyword'>void</span> *, <span class='keyword'>void</span> *);</td></tr>
<tr class="codeline" data-linenumber="299"><td class="num" id="LN299">299</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="300"><td class="num" id="LN300">300</td><td class="line">uint16_t crc16(<span class='keyword'>const</span> <span class='keyword'>char</span> *buf, <span class='keyword'>int</span> len);</td></tr>
<tr class="codeline" data-linenumber="301"><td class="num" id="LN301">301</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="302"><td class="num" id="LN302">302</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>long</span> <span class='keyword'>long</span> ustime(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="303"><td class="num" id="LN303">303</td><td class="line">    <span class='keyword'>struct</span> timeval tv;</td></tr>
<tr class="codeline" data-linenumber="304"><td class="num" id="LN304">304</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> ust;</td></tr>
<tr class="codeline" data-linenumber="305"><td class="num" id="LN305">305</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="306"><td class="num" id="LN306">306</td><td class="line">    gettimeofday(&amp;tv, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="307"><td class="num" id="LN307">307</td><td class="line">    ust = ((<span class='keyword'>long</span> <span class='keyword'>long</span>)tv.tv_sec)*1000000;</td></tr>
<tr class="codeline" data-linenumber="308"><td class="num" id="LN308">308</td><td class="line">    ust += tv.tv_usec;</td></tr>
<tr class="codeline" data-linenumber="309"><td class="num" id="LN309">309</td><td class="line">    <span class='keyword'>return</span> ust;</td></tr>
<tr class="codeline" data-linenumber="310"><td class="num" id="LN310">310</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="311"><td class="num" id="LN311">311</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="312"><td class="num" id="LN312">312</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>long</span> <span class='keyword'>long</span> mstime(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="313"><td class="num" id="LN313">313</td><td class="line">    <span class='keyword'>return</span> ustime()/1000;</td></tr>
<tr class="codeline" data-linenumber="314"><td class="num" id="LN314">314</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="315"><td class="num" id="LN315">315</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="316"><td class="num" id="LN316">316</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> cliRefreshPrompt(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="317"><td class="num" id="LN317">317</td><td class="line">    <span class='keyword'>if</span> (config.eval_ldb) <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="318"><td class="num" id="LN318">318</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="319"><td class="num" id="LN319">319</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> prompt = <span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>();</td></tr>
<tr class="codeline" data-linenumber="320"><td class="num" id="LN320">320</td><td class="line">    <span class='keyword'>if</span> (config.hostsocket != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="321"><td class="num" id="LN321">321</td><td class="line">        prompt = <span class='macro'>sdscatfmt<span class='macro_popup'>hi_sdscatfmt</span></span>(prompt,<span class='string_literal'>"redis %s"</span>,config.hostsocket);</td></tr>
<tr class="codeline" data-linenumber="322"><td class="num" id="LN322">322</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="323"><td class="num" id="LN323">323</td><td class="line">        <span class='keyword'>char</span> addr[256];</td></tr>
<tr class="codeline" data-linenumber="324"><td class="num" id="LN324">324</td><td class="line">        anetFormatAddr(addr, <span class='keyword'>sizeof</span>(addr), config.conn_info.hostip, config.conn_info.hostport);</td></tr>
<tr class="codeline" data-linenumber="325"><td class="num" id="LN325">325</td><td class="line">        prompt = <span class='macro'>sdscatlen<span class='macro_popup'>hi_sdscatlen</span></span>(prompt,addr,strlen(addr));</td></tr>
<tr class="codeline" data-linenumber="326"><td class="num" id="LN326">326</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="327"><td class="num" id="LN327">327</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="328"><td class="num" id="LN328">328</td><td class="line">    <span class='comment'>/* Add [dbnum] if needed */</span></td></tr>
<tr class="codeline" data-linenumber="329"><td class="num" id="LN329">329</td><td class="line">    <span class='keyword'>if</span> (config.dbnum != 0)</td></tr>
<tr class="codeline" data-linenumber="330"><td class="num" id="LN330">330</td><td class="line">        prompt = <span class='macro'>sdscatfmt<span class='macro_popup'>hi_sdscatfmt</span></span>(prompt,<span class='string_literal'>"[%i]"</span>,config.dbnum);</td></tr>
<tr class="codeline" data-linenumber="331"><td class="num" id="LN331">331</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="332"><td class="num" id="LN332">332</td><td class="line">    <span class='comment'>/* Add TX if in transaction state*/</span></td></tr>
<tr class="codeline" data-linenumber="333"><td class="num" id="LN333">333</td><td class="line">    <span class='keyword'>if</span> (config.in_multi)  </td></tr>
<tr class="codeline" data-linenumber="334"><td class="num" id="LN334">334</td><td class="line">        prompt = <span class='macro'>sdscatlen<span class='macro_popup'>hi_sdscatlen</span></span>(prompt,<span class='string_literal'>"(TX)"</span>,4);</td></tr>
<tr class="codeline" data-linenumber="335"><td class="num" id="LN335">335</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="336"><td class="num" id="LN336">336</td><td class="line">    <span class='comment'>/* Copy the prompt in the static buffer. */</span></td></tr>
<tr class="codeline" data-linenumber="337"><td class="num" id="LN337">337</td><td class="line">    prompt = <span class='macro'>sdscatlen<span class='macro_popup'>hi_sdscatlen</span></span>(prompt,<span class='string_literal'>"&gt; "</span>,2);</td></tr>
<tr class="codeline" data-linenumber="338"><td class="num" id="LN338">338</td><td class="line">    snprintf(config.prompt,<span class='keyword'>sizeof</span>(config.prompt),<span class='string_literal'>"%s"</span>,prompt);</td></tr>
<tr class="codeline" data-linenumber="339"><td class="num" id="LN339">339</td><td class="line">    <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(prompt);</td></tr>
<tr class="codeline" data-linenumber="340"><td class="num" id="LN340">340</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="341"><td class="num" id="LN341">341</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="342"><td class="num" id="LN342">342</td><td class="line"><span class='comment'>/* Return the name of the dotfile for the specified 'dotfilename'.</span></td></tr>
<tr class="codeline" data-linenumber="343"><td class="num" id="LN343">343</td><td class="line"> <span class='comment'>* Normally it just concatenates user $HOME to the file specified</span></td></tr>
<tr class="codeline" data-linenumber="344"><td class="num" id="LN344">344</td><td class="line"> <span class='comment'>* in 'dotfilename'. However if the environment variable 'envoverride'</span></td></tr>
<tr class="codeline" data-linenumber="345"><td class="num" id="LN345">345</td><td class="line"> <span class='comment'>* is set, its value is taken as the path.</span></td></tr>
<tr class="codeline" data-linenumber="346"><td class="num" id="LN346">346</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="347"><td class="num" id="LN347">347</td><td class="line"> <span class='comment'>* The function returns NULL (if the file is /dev/null or cannot be</span></td></tr>
<tr class="codeline" data-linenumber="348"><td class="num" id="LN348">348</td><td class="line"> <span class='comment'>* obtained for some error), or an SDS string that must be freed by</span></td></tr>
<tr class="codeline" data-linenumber="349"><td class="num" id="LN349">349</td><td class="line"> <span class='comment'>* the user. */</span></td></tr>
<tr class="codeline" data-linenumber="350"><td class="num" id="LN350">350</td><td class="line"><span class='keyword'>static</span> <span class='macro'>sds<span class='macro_popup'>hisds</span></span> getDotfilePath(<span class='keyword'>char</span> *envoverride, <span class='keyword'>char</span> *dotfilename) {</td></tr>
<tr class="codeline" data-linenumber="351"><td class="num" id="LN351">351</td><td class="line">    <span class='keyword'>char</span> *path = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="352"><td class="num" id="LN352">352</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> dotPath = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="353"><td class="num" id="LN353">353</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="354"><td class="num" id="LN354">354</td><td class="line">    <span class='comment'>/* Check the env for a dotfile override. */</span></td></tr>
<tr class="codeline" data-linenumber="355"><td class="num" id="LN355">355</td><td class="line">    path = getenv(envoverride);</td></tr>
<tr class="codeline" data-linenumber="356"><td class="num" id="LN356">356</td><td class="line">    <span class='keyword'>if</span> (path != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> &amp;&amp; *path != '\0') {</td></tr>
<tr class="codeline" data-linenumber="357"><td class="num" id="LN357">357</td><td class="line">        <span class='keyword'>if</span> (!strcmp(<span class='string_literal'>"/dev/null"</span>, path)) {</td></tr>
<tr class="codeline" data-linenumber="358"><td class="num" id="LN358">358</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="359"><td class="num" id="LN359">359</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="360"><td class="num" id="LN360">360</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="361"><td class="num" id="LN361">361</td><td class="line">        <span class='comment'>/* If the env is set, return it. */</span></td></tr>
<tr class="codeline" data-linenumber="362"><td class="num" id="LN362">362</td><td class="line">        dotPath = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(path);</td></tr>
<tr class="codeline" data-linenumber="363"><td class="num" id="LN363">363</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="364"><td class="num" id="LN364">364</td><td class="line">        <span class='keyword'>char</span> *home = getenv(<span class='string_literal'>"HOME"</span>);</td></tr>
<tr class="codeline" data-linenumber="365"><td class="num" id="LN365">365</td><td class="line">        <span class='keyword'>if</span> (home != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> &amp;&amp; *home != '\0') {</td></tr>
<tr class="codeline" data-linenumber="366"><td class="num" id="LN366">366</td><td class="line">            <span class='comment'>/* If no override is set use $HOME/&lt;dotfilename&gt;. */</span></td></tr>
<tr class="codeline" data-linenumber="367"><td class="num" id="LN367">367</td><td class="line">            dotPath = <span class='macro'>sdscatprintf<span class='macro_popup'>hi_sdscatprintf</span></span>(<span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>(), <span class='string_literal'>"%s/%s"</span>, home, dotfilename);</td></tr>
<tr class="codeline" data-linenumber="368"><td class="num" id="LN368">368</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="369"><td class="num" id="LN369">369</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="370"><td class="num" id="LN370">370</td><td class="line">    <span class='keyword'>return</span> dotPath;</td></tr>
<tr class="codeline" data-linenumber="371"><td class="num" id="LN371">371</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="372"><td class="num" id="LN372">372</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="373"><td class="num" id="LN373">373</td><td class="line"><span class='keyword'>static</span> uint64_t dictSdsHash(<span class='keyword'>const</span> <span class='keyword'>void</span> *key) {</td></tr>
<tr class="codeline" data-linenumber="374"><td class="num" id="LN374">374</td><td class="line">    <span class='keyword'>return</span> dictGenHashFunction((<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)key, <span class='macro'>sdslen<span class='macro_popup'>hi_sdslen</span></span>((<span class='keyword'>char</span>*)key));</td></tr>
<tr class="codeline" data-linenumber="375"><td class="num" id="LN375">375</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="376"><td class="num" id="LN376">376</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="377"><td class="num" id="LN377">377</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> dictSdsKeyCompare(dict *d, <span class='keyword'>const</span> <span class='keyword'>void</span> *key1, <span class='keyword'>const</span> <span class='keyword'>void</span> *key2)</td></tr>
<tr class="codeline" data-linenumber="378"><td class="num" id="LN378">378</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="379"><td class="num" id="LN379">379</td><td class="line">    <span class='keyword'>int</span> l1,l2;</td></tr>
<tr class="codeline" data-linenumber="380"><td class="num" id="LN380">380</td><td class="line">    <span class='macro'>UNUSED(d)<span class='macro_popup'>((void) d)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="381"><td class="num" id="LN381">381</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="382"><td class="num" id="LN382">382</td><td class="line">    l1 = <span class='macro'>sdslen<span class='macro_popup'>hi_sdslen</span></span>((<span class='macro'>sds<span class='macro_popup'>hisds</span></span>)key1);</td></tr>
<tr class="codeline" data-linenumber="383"><td class="num" id="LN383">383</td><td class="line">    l2 = <span class='macro'>sdslen<span class='macro_popup'>hi_sdslen</span></span>((<span class='macro'>sds<span class='macro_popup'>hisds</span></span>)key2);</td></tr>
<tr class="codeline" data-linenumber="384"><td class="num" id="LN384">384</td><td class="line">    <span class='keyword'>if</span> (l1 != l2) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="385"><td class="num" id="LN385">385</td><td class="line">    <span class='keyword'>return</span> memcmp(key1, key2, l1) == 0;</td></tr>
<tr class="codeline" data-linenumber="386"><td class="num" id="LN386">386</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="387"><td class="num" id="LN387">387</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="388"><td class="num" id="LN388">388</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> dictSdsDestructor(dict *d, <span class='keyword'>void</span> *val)</td></tr>
<tr class="codeline" data-linenumber="389"><td class="num" id="LN389">389</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="390"><td class="num" id="LN390">390</td><td class="line">    <span class='macro'>UNUSED(d)<span class='macro_popup'>((void) d)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="391"><td class="num" id="LN391">391</td><td class="line">    <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(val);</td></tr>
<tr class="codeline" data-linenumber="392"><td class="num" id="LN392">392</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="393"><td class="num" id="LN393">393</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="394"><td class="num" id="LN394">394</td><td class="line"><span class='keyword'>void</span> dictListDestructor(dict *d, <span class='keyword'>void</span> *val)</td></tr>
<tr class="codeline" data-linenumber="395"><td class="num" id="LN395">395</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="396"><td class="num" id="LN396">396</td><td class="line">    <span class='macro'>UNUSED(d)<span class='macro_popup'>((void) d)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="397"><td class="num" id="LN397">397</td><td class="line">    listRelease((list*)val);</td></tr>
<tr class="codeline" data-linenumber="398"><td class="num" id="LN398">398</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="399"><td class="num" id="LN399">399</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="400"><td class="num" id="LN400">400</td><td class="line"><span class='comment'>/*------------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="401"><td class="num" id="LN401">401</td><td class="line"> <span class='comment'>* Help functions</span></td></tr>
<tr class="codeline" data-linenumber="402"><td class="num" id="LN402">402</td><td class="line"> <span class='comment'>*--------------------------------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="403"><td class="num" id="LN403">403</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="404"><td class="num" id="LN404">404</td><td class="line"><span class='directive'>#define <span class='macro'>CLI_HELP_COMMAND<span class='macro_popup'>1</span></span> 1</span></td></tr>
<tr class="codeline" data-linenumber="405"><td class="num" id="LN405">405</td><td class="line"><span class='directive'>#define <span class='macro'>CLI_HELP_GROUP<span class='macro_popup'>2</span></span> 2</span></td></tr>
<tr class="codeline" data-linenumber="406"><td class="num" id="LN406">406</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="407"><td class="num" id="LN407">407</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> {</td></tr>
<tr class="codeline" data-linenumber="408"><td class="num" id="LN408">408</td><td class="line">    <span class='keyword'>int</span> type;</td></tr>
<tr class="codeline" data-linenumber="409"><td class="num" id="LN409">409</td><td class="line">    <span class='keyword'>int</span> argc;</td></tr>
<tr class="codeline" data-linenumber="410"><td class="num" id="LN410">410</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> *argv;</td></tr>
<tr class="codeline" data-linenumber="411"><td class="num" id="LN411">411</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> full;</td></tr>
<tr class="codeline" data-linenumber="412"><td class="num" id="LN412">412</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="413"><td class="num" id="LN413">413</td><td class="line">    <span class='comment'>/* Only used for help on commands */</span></td></tr>
<tr class="codeline" data-linenumber="414"><td class="num" id="LN414">414</td><td class="line">    <span class='keyword'>struct</span> commandDocs org;</td></tr>
<tr class="codeline" data-linenumber="415"><td class="num" id="LN415">415</td><td class="line">} helpEntry;</td></tr>
<tr class="codeline" data-linenumber="416"><td class="num" id="LN416">416</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="417"><td class="num" id="LN417">417</td><td class="line"><span class='keyword'>static</span> helpEntry *helpEntries = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="418"><td class="num" id="LN418">418</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> helpEntriesLen = 0;</td></tr>
<tr class="codeline" data-linenumber="419"><td class="num" id="LN419">419</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="420"><td class="num" id="LN420">420</td><td class="line"><span class='keyword'>static</span> <span class='macro'>sds<span class='macro_popup'>hisds</span></span> cliVersion(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="421"><td class="num" id="LN421">421</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> version;</td></tr>
<tr class="codeline" data-linenumber="422"><td class="num" id="LN422">422</td><td class="line">    version = <span class='macro'>sdscatprintf<span class='macro_popup'>hi_sdscatprintf</span></span>(<span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>(), <span class='string_literal'>"%s"</span>, <span class='macro'>REDIS_VERSION<span class='macro_popup'>"255.255.255"</span></span>);</td></tr>
<tr class="codeline" data-linenumber="423"><td class="num" id="LN423">423</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="424"><td class="num" id="LN424">424</td><td class="line">    <span class='comment'>/* Add git commit and working tree status when available */</span></td></tr>
<tr class="codeline" data-linenumber="425"><td class="num" id="LN425">425</td><td class="line">    <span class='keyword'>if</span> (strtoll(redisGitSHA1(),<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,16)) {</td></tr>
<tr class="codeline" data-linenumber="426"><td class="num" id="LN426">426</td><td class="line">        version = <span class='macro'>sdscatprintf<span class='macro_popup'>hi_sdscatprintf</span></span>(version, <span class='string_literal'>" (git:%s"</span>, redisGitSHA1());</td></tr>
<tr class="codeline" data-linenumber="427"><td class="num" id="LN427">427</td><td class="line">        <span class='keyword'>if</span> (strtoll(redisGitDirty(),<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,10))</td></tr>
<tr class="codeline" data-linenumber="428"><td class="num" id="LN428">428</td><td class="line">            version = <span class='macro'>sdscatprintf<span class='macro_popup'>hi_sdscatprintf</span></span>(version, <span class='string_literal'>"-dirty"</span>);</td></tr>
<tr class="codeline" data-linenumber="429"><td class="num" id="LN429">429</td><td class="line">        version = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(version, <span class='string_literal'>")"</span>);</td></tr>
<tr class="codeline" data-linenumber="430"><td class="num" id="LN430">430</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="431"><td class="num" id="LN431">431</td><td class="line">    <span class='keyword'>return</span> version;</td></tr>
<tr class="codeline" data-linenumber="432"><td class="num" id="LN432">432</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="433"><td class="num" id="LN433">433</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="434"><td class="num" id="LN434">434</td><td class="line"><span class='comment'>/* For backwards compatibility with pre-7.0 servers. Initializes command help. */</span></td></tr>
<tr class="codeline" data-linenumber="435"><td class="num" id="LN435">435</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> cliOldInitHelp(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="436"><td class="num" id="LN436">436</td><td class="line">    <span class='keyword'>int</span> commandslen = <span class='keyword'>sizeof</span>(commandHelp)/<span class='keyword'>sizeof</span>(<span class='keyword'>struct</span> commandHelp);</td></tr>
<tr class="codeline" data-linenumber="437"><td class="num" id="LN437">437</td><td class="line">    <span class='keyword'>int</span> groupslen = <span class='keyword'>sizeof</span>(commandGroups)/<span class='keyword'>sizeof</span>(<span class='keyword'>char</span>*);</td></tr>
<tr class="codeline" data-linenumber="438"><td class="num" id="LN438">438</td><td class="line">    <span class='keyword'>int</span> i, len, pos = 0;</td></tr>
<tr class="codeline" data-linenumber="439"><td class="num" id="LN439">439</td><td class="line">    helpEntry tmp;</td></tr>
<tr class="codeline" data-linenumber="440"><td class="num" id="LN440">440</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="441"><td class="num" id="LN441">441</td><td class="line">    helpEntriesLen = len = commandslen+groupslen;</td></tr>
<tr class="codeline" data-linenumber="442"><td class="num" id="LN442">442</td><td class="line">    helpEntries = zmalloc(<span class='keyword'>sizeof</span>(helpEntry)*len);</td></tr>
<tr class="codeline" data-linenumber="443"><td class="num" id="LN443">443</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="444"><td class="num" id="LN444">444</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; groupslen; i++) {</td></tr>
<tr class="codeline" data-linenumber="445"><td class="num" id="LN445">445</td><td class="line">        tmp.argc = 1;</td></tr>
<tr class="codeline" data-linenumber="446"><td class="num" id="LN446">446</td><td class="line">        tmp.argv = zmalloc(<span class='keyword'>sizeof</span>(<span class='macro'>sds<span class='macro_popup'>hisds</span></span>));</td></tr>
<tr class="codeline" data-linenumber="447"><td class="num" id="LN447">447</td><td class="line">        tmp.argv[0] = <span class='macro'>sdscatprintf<span class='macro_popup'>hi_sdscatprintf</span></span>(<span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>(),<span class='string_literal'>"@%s"</span>,commandGroups[i]);</td></tr>
<tr class="codeline" data-linenumber="448"><td class="num" id="LN448">448</td><td class="line">        tmp.full = tmp.argv[0];</td></tr>
<tr class="codeline" data-linenumber="449"><td class="num" id="LN449">449</td><td class="line">        tmp.type = <span class='macro'>CLI_HELP_GROUP<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="450"><td class="num" id="LN450">450</td><td class="line">        tmp.org.name = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="451"><td class="num" id="LN451">451</td><td class="line">        tmp.org.params = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="452"><td class="num" id="LN452">452</td><td class="line">        tmp.org.summary = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="453"><td class="num" id="LN453">453</td><td class="line">        tmp.org.since = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="454"><td class="num" id="LN454">454</td><td class="line">        tmp.org.group = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="455"><td class="num" id="LN455">455</td><td class="line">        helpEntries[pos++] = tmp;</td></tr>
<tr class="codeline" data-linenumber="456"><td class="num" id="LN456">456</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="457"><td class="num" id="LN457">457</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="458"><td class="num" id="LN458">458</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; commandslen; i++) {</td></tr>
<tr class="codeline" data-linenumber="459"><td class="num" id="LN459">459</td><td class="line">        tmp.argv = <span class='macro'>sdssplitargs<span class='macro_popup'>hi_sdssplitargs</span></span>(commandHelp[i].name,&amp;tmp.argc);</td></tr>
<tr class="codeline" data-linenumber="460"><td class="num" id="LN460">460</td><td class="line">        tmp.full = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(commandHelp[i].name);</td></tr>
<tr class="codeline" data-linenumber="461"><td class="num" id="LN461">461</td><td class="line">        tmp.type = <span class='macro'>CLI_HELP_COMMAND<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="462"><td class="num" id="LN462">462</td><td class="line">        tmp.org.name = commandHelp[i].name;</td></tr>
<tr class="codeline" data-linenumber="463"><td class="num" id="LN463">463</td><td class="line">        tmp.org.params = commandHelp[i].params;</td></tr>
<tr class="codeline" data-linenumber="464"><td class="num" id="LN464">464</td><td class="line">        tmp.org.summary = commandHelp[i].summary;</td></tr>
<tr class="codeline" data-linenumber="465"><td class="num" id="LN465">465</td><td class="line">        tmp.org.since = commandHelp[i].since;</td></tr>
<tr class="codeline" data-linenumber="466"><td class="num" id="LN466">466</td><td class="line">        tmp.org.group = commandGroups[commandHelp[i].group];</td></tr>
<tr class="codeline" data-linenumber="467"><td class="num" id="LN467">467</td><td class="line">        helpEntries[pos++] = tmp;</td></tr>
<tr class="codeline" data-linenumber="468"><td class="num" id="LN468">468</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="469"><td class="num" id="LN469">469</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="470"><td class="num" id="LN470">470</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="471"><td class="num" id="LN471">471</td><td class="line"><span class='comment'>/* For backwards compatibility with pre-7.0 servers.</span></td></tr>
<tr class="codeline" data-linenumber="472"><td class="num" id="LN472">472</td><td class="line"> <span class='comment'>* cliOldInitHelp() setups the helpEntries array with the command and group</span></td></tr>
<tr class="codeline" data-linenumber="473"><td class="num" id="LN473">473</td><td class="line"> <span class='comment'>* names from the help.h file. However the Redis instance we are connecting</span></td></tr>
<tr class="codeline" data-linenumber="474"><td class="num" id="LN474">474</td><td class="line"> <span class='comment'>* to may support more commands, so this function integrates the previous</span></td></tr>
<tr class="codeline" data-linenumber="475"><td class="num" id="LN475">475</td><td class="line"> <span class='comment'>* entries with additional entries obtained using the COMMAND command</span></td></tr>
<tr class="codeline" data-linenumber="476"><td class="num" id="LN476">476</td><td class="line"> <span class='comment'>* available in recent versions of Redis. */</span></td></tr>
<tr class="codeline" data-linenumber="477"><td class="num" id="LN477">477</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> cliOldIntegrateHelp(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="478"><td class="num" id="LN478">478</td><td class="line">    <span class='keyword'>if</span> (cliConnect(<span class='macro'>CC_QUIET<span class='macro_popup'>(1&lt;&lt;1)</span></span>) == <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>) <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="479"><td class="num" id="LN479">479</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="480"><td class="num" id="LN480">480</td><td class="line">    redisReply *reply = redisCommand(context, <span class='string_literal'>"COMMAND"</span>);</td></tr>
<tr class="codeline" data-linenumber="481"><td class="num" id="LN481">481</td><td class="line">    <span class='keyword'>if</span>(reply == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> || reply-&gt;type != <span class='macro'>REDIS_REPLY_ARRAY<span class='macro_popup'>2</span></span>) <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="482"><td class="num" id="LN482">482</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="483"><td class="num" id="LN483">483</td><td class="line">    <span class='comment'>/* Scan the array reported by COMMAND and fill only the entries that</span></td></tr>
<tr class="codeline" data-linenumber="484"><td class="num" id="LN484">484</td><td class="line">     <span class='comment'>* don't already match what we have. */</span></td></tr>
<tr class="codeline" data-linenumber="485"><td class="num" id="LN485">485</td><td class="line">    <span class='keyword'>for</span> (size_t j = 0; j &lt; reply-&gt;elements; j++) {</td></tr>
<tr class="codeline" data-linenumber="486"><td class="num" id="LN486">486</td><td class="line">        redisReply *entry = reply-&gt;element[j];</td></tr>
<tr class="codeline" data-linenumber="487"><td class="num" id="LN487">487</td><td class="line">        <span class='keyword'>if</span> (entry-&gt;type != <span class='macro'>REDIS_REPLY_ARRAY<span class='macro_popup'>2</span></span> || entry-&gt;elements &lt; 4 ||</td></tr>
<tr class="codeline" data-linenumber="488"><td class="num" id="LN488">488</td><td class="line">            entry-&gt;element[0]-&gt;type != <span class='macro'>REDIS_REPLY_STRING<span class='macro_popup'>1</span></span> ||</td></tr>
<tr class="codeline" data-linenumber="489"><td class="num" id="LN489">489</td><td class="line">            entry-&gt;element[1]-&gt;type != <span class='macro'>REDIS_REPLY_INTEGER<span class='macro_popup'>3</span></span> ||</td></tr>
<tr class="codeline" data-linenumber="490"><td class="num" id="LN490">490</td><td class="line">            entry-&gt;element[3]-&gt;type != <span class='macro'>REDIS_REPLY_INTEGER<span class='macro_popup'>3</span></span>) <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="491"><td class="num" id="LN491">491</td><td class="line">        <span class='keyword'>char</span> *cmdname = entry-&gt;element[0]-&gt;str;</td></tr>
<tr class="codeline" data-linenumber="492"><td class="num" id="LN492">492</td><td class="line">        <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="493"><td class="num" id="LN493">493</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="494"><td class="num" id="LN494">494</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; helpEntriesLen; i++) {</td></tr>
<tr class="codeline" data-linenumber="495"><td class="num" id="LN495">495</td><td class="line">            helpEntry *he = helpEntries+i;</td></tr>
<tr class="codeline" data-linenumber="496"><td class="num" id="LN496">496</td><td class="line">            <span class='keyword'>if</span> (!strcasecmp(he-&gt;argv[0],cmdname))</td></tr>
<tr class="codeline" data-linenumber="497"><td class="num" id="LN497">497</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="498"><td class="num" id="LN498">498</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="499"><td class="num" id="LN499">499</td><td class="line">        <span class='keyword'>if</span> (i != helpEntriesLen) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="500"><td class="num" id="LN500">500</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="501"><td class="num" id="LN501">501</td><td class="line">        helpEntriesLen++;</td></tr>
<tr class="codeline" data-linenumber="502"><td class="num" id="LN502">502</td><td class="line">        helpEntries = zrealloc(helpEntries,<span class='keyword'>sizeof</span>(helpEntry)*helpEntriesLen);</td></tr>
<tr class="codeline" data-linenumber="503"><td class="num" id="LN503">503</td><td class="line">        helpEntry *new = helpEntries+(helpEntriesLen-1);</td></tr>
<tr class="codeline" data-linenumber="504"><td class="num" id="LN504">504</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="505"><td class="num" id="LN505">505</td><td class="line">        new-&gt;argc = 1;</td></tr>
<tr class="codeline" data-linenumber="506"><td class="num" id="LN506">506</td><td class="line">        new-&gt;argv = zmalloc(<span class='keyword'>sizeof</span>(<span class='macro'>sds<span class='macro_popup'>hisds</span></span>));</td></tr>
<tr class="codeline" data-linenumber="507"><td class="num" id="LN507">507</td><td class="line">        new-&gt;argv[0] = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(cmdname);</td></tr>
<tr class="codeline" data-linenumber="508"><td class="num" id="LN508">508</td><td class="line">        new-&gt;full = new-&gt;argv[0];</td></tr>
<tr class="codeline" data-linenumber="509"><td class="num" id="LN509">509</td><td class="line">        new-&gt;type = <span class='macro'>CLI_HELP_COMMAND<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="510"><td class="num" id="LN510">510</td><td class="line">        <span class='macro'>sdstoupper<span class='macro_popup'>hi_sdstoupper</span></span>(new-&gt;argv[0]);</td></tr>
<tr class="codeline" data-linenumber="511"><td class="num" id="LN511">511</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="512"><td class="num" id="LN512">512</td><td class="line">        new-&gt;org.name = new-&gt;argv[0];</td></tr>
<tr class="codeline" data-linenumber="513"><td class="num" id="LN513">513</td><td class="line">        new-&gt;org.params = <span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>();</td></tr>
<tr class="codeline" data-linenumber="514"><td class="num" id="LN514">514</td><td class="line">        <span class='keyword'>int</span> args = llabs(entry-&gt;element[1]-&gt;integer);</td></tr>
<tr class="codeline" data-linenumber="515"><td class="num" id="LN515">515</td><td class="line">        args--; <span class='comment'>/* Remove the command name itself. */</span></td></tr>
<tr class="codeline" data-linenumber="516"><td class="num" id="LN516">516</td><td class="line">        <span class='keyword'>if</span> (entry-&gt;element[3]-&gt;integer == 1) {</td></tr>
<tr class="codeline" data-linenumber="517"><td class="num" id="LN517">517</td><td class="line">            new-&gt;org.params = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(new-&gt;org.params,<span class='string_literal'>"key "</span>);</td></tr>
<tr class="codeline" data-linenumber="518"><td class="num" id="LN518">518</td><td class="line">            args--;</td></tr>
<tr class="codeline" data-linenumber="519"><td class="num" id="LN519">519</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="520"><td class="num" id="LN520">520</td><td class="line">        <span class='keyword'>while</span>(args-- &gt; 0) new-&gt;org.params = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(new-&gt;org.params,<span class='string_literal'>"arg "</span>);</td></tr>
<tr class="codeline" data-linenumber="521"><td class="num" id="LN521">521</td><td class="line">        <span class='keyword'>if</span> (entry-&gt;element[1]-&gt;integer &lt; 0)</td></tr>
<tr class="codeline" data-linenumber="522"><td class="num" id="LN522">522</td><td class="line">            new-&gt;org.params = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(new-&gt;org.params,<span class='string_literal'>"...options..."</span>);</td></tr>
<tr class="codeline" data-linenumber="523"><td class="num" id="LN523">523</td><td class="line">        new-&gt;org.summary = <span class='string_literal'>"Help not available"</span>;</td></tr>
<tr class="codeline" data-linenumber="524"><td class="num" id="LN524">524</td><td class="line">        new-&gt;org.since = <span class='string_literal'>"Not known"</span>;</td></tr>
<tr class="codeline" data-linenumber="525"><td class="num" id="LN525">525</td><td class="line">        new-&gt;org.group = commandGroups[0];</td></tr>
<tr class="codeline" data-linenumber="526"><td class="num" id="LN526">526</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="527"><td class="num" id="LN527">527</td><td class="line">    freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="528"><td class="num" id="LN528">528</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="529"><td class="num" id="LN529">529</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="530"><td class="num" id="LN530">530</td><td class="line"><span class='comment'>/* Concatenate a string to an sds string, but if it's empty substitute double quote marks. */</span></td></tr>
<tr class="codeline" data-linenumber="531"><td class="num" id="LN531">531</td><td class="line"><span class='keyword'>static</span> <span class='macro'>sds<span class='macro_popup'>hisds</span></span> sdscat_orempty(<span class='macro'>sds<span class='macro_popup'>hisds</span></span> params, <span class='keyword'>char</span> *value) {</td></tr>
<tr class="codeline" data-linenumber="532"><td class="num" id="LN532">532</td><td class="line">    <span class='keyword'>if</span> (value[0] == '\0') {</td></tr>
<tr class="codeline" data-linenumber="533"><td class="num" id="LN533">533</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(params, <span class='string_literal'>"\"\""</span>);</td></tr>
<tr class="codeline" data-linenumber="534"><td class="num" id="LN534">534</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="535"><td class="num" id="LN535">535</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(params, value);</td></tr>
<tr class="codeline" data-linenumber="536"><td class="num" id="LN536">536</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="537"><td class="num" id="LN537">537</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="538"><td class="num" id="LN538">538</td><td class="line"><span class='keyword'>static</span> <span class='macro'>sds<span class='macro_popup'>hisds</span></span> cliAddArgument(<span class='macro'>sds<span class='macro_popup'>hisds</span></span> params, redisReply *argMap);</td></tr>
<tr class="codeline" data-linenumber="539"><td class="num" id="LN539">539</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="540"><td class="num" id="LN540">540</td><td class="line"><span class='comment'>/* Concatenate a list of arguments to the parameter string, separated by a separator string. */</span></td></tr>
<tr class="codeline" data-linenumber="541"><td class="num" id="LN541">541</td><td class="line"><span class='keyword'>static</span> <span class='macro'>sds<span class='macro_popup'>hisds</span></span> cliConcatArguments(<span class='macro'>sds<span class='macro_popup'>hisds</span></span> params, redisReply *arguments, <span class='keyword'>char</span> *separator) {</td></tr>
<tr class="codeline" data-linenumber="542"><td class="num" id="LN542">542</td><td class="line">    <span class='keyword'>for</span> (size_t j = 0; <span class="mrange">j &lt; arguments-&gt;elements</span>; j++) {</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path1" class="msg msgEvent" style="margin-left:24ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">1</div></td><td>Assuming 'j' is &lt; field 'elements'</td><td><div class="PathNav"><a href="#Path2" title="Next event (2)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr><td class="num"></td><td class="line"><div id="Path2" class="msg msgControl" style="margin-left:5ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">2</div></td><td><div class="PathNav"><a href="#Path1" title="Previous event (1)">&#x2190;</a></div></td><td>Loop condition is true.  Entering loop body</td><td><div class="PathNav"><a href="#Path3" title="Next event (3)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="543"><td class="num" id="LN543">543</td><td class="line">        params = <span class="mrange">cliAddArgument(params, arguments-&gt;element[j])</span>;</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path3" class="msg msgEvent" style="margin-left:18ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">3</div></td><td><div class="PathNav"><a href="#Path2" title="Previous event (2)">&#x2190;</a></div></td><td>Calling 'cliAddArgument'</td><td><div class="PathNav"><a href="#Path4" title="Next event (4)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="544"><td class="num" id="LN544">544</td><td class="line">        <span class='keyword'>if</span> (j != arguments-&gt;elements - 1) {</td></tr>
<tr class="codeline" data-linenumber="545"><td class="num" id="LN545">545</td><td class="line">            params = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(params, separator);</td></tr>
<tr class="codeline" data-linenumber="546"><td class="num" id="LN546">546</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="547"><td class="num" id="LN547">547</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="548"><td class="num" id="LN548">548</td><td class="line">    <span class='keyword'>return</span> params;</td></tr>
<tr class="codeline" data-linenumber="549"><td class="num" id="LN549">549</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="550"><td class="num" id="LN550">550</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="551"><td class="num" id="LN551">551</td><td class="line"><span class='comment'>/* Add an argument to the parameter string. */</span></td></tr>
<tr class="codeline" data-linenumber="552"><td class="num" id="LN552">552</td><td class="line"><span class='keyword'>static</span> <span class='macro'>sds<span class='macro_popup'>hisds</span></span> cliAddArgument(<span class='macro'>sds<span class='macro_popup'>hisds</span></span> params, redisReply *argMap) {</td></tr>
<tr class="codeline" data-linenumber="553"><td class="num" id="LN553">553</td><td class="line">    <span class='keyword'>char</span> *name = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="554"><td class="num" id="LN554">554</td><td class="line">    <span class="mrange"><span class='keyword'>char</span> *type</span> = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path4" class="msg msgEvent" style="margin-left:5ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">4</div></td><td><div class="PathNav"><a href="#Path3" title="Previous event (3)">&#x2190;</a></div></td><td>'type' initialized to a null pointer value</td><td><div class="PathNav"><a href="#Path5" title="Next event (5)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="555"><td class="num" id="LN555">555</td><td class="line">    <span class='keyword'>int</span> optional = 0;</td></tr>
<tr class="codeline" data-linenumber="556"><td class="num" id="LN556">556</td><td class="line">    <span class='keyword'>int</span> multiple = 0;</td></tr>
<tr class="codeline" data-linenumber="557"><td class="num" id="LN557">557</td><td class="line">    <span class='keyword'>int</span> multipleToken = 0;</td></tr>
<tr class="codeline" data-linenumber="558"><td class="num" id="LN558">558</td><td class="line">    redisReply *arguments = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="559"><td class="num" id="LN559">559</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> tokenPart = <span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>();</td></tr>
<tr class="codeline" data-linenumber="560"><td class="num" id="LN560">560</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> repeatPart = <span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>();</td></tr>
<tr class="codeline" data-linenumber="561"><td class="num" id="LN561">561</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="562"><td class="num" id="LN562">562</td><td class="line">    <span class='comment'>/* First read the fields describing the argument. */</span></td></tr>
<tr class="codeline" data-linenumber="563"><td class="num" id="LN563">563</td><td class="line">    <span class='keyword'>if</span> (<span class="mrange">argMap-&gt;type != <span class='macro'>REDIS_REPLY_MAP<span class='macro_popup'>9</span></span></span> &amp;&amp; argMap-&gt;type != <span class='macro'>REDIS_REPLY_ARRAY<span class='macro_popup'>2</span></span>) {</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path5" class="msg msgEvent" style="margin-left:9ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">5</div></td><td><div class="PathNav"><a href="#Path4" title="Previous event (4)">&#x2190;</a></div></td><td>Assuming field 'type' is equal to REDIS_REPLY_MAP</td><td><div class="PathNav"><a href="#Path6" title="Next event (6)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="564"><td class="num" id="LN564">564</td><td class="line">        <span class='keyword'>return</span> params;</td></tr>
<tr class="codeline" data-linenumber="565"><td class="num" id="LN565">565</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="566"><td class="num" id="LN566">566</td><td class="line">    <span class='keyword'>for</span> (size_t i = 0; <span class="mrange">i &lt; argMap-&gt;elements</span>; i += 2) {</td></tr>
<tr><td class="num"></td><td class="line"><div id="Path6" class="msg msgEvent" style="margin-left:24ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">6</div></td><td><div class="PathNav"><a href="#Path5" title="Previous event (5)">&#x2190;</a></div></td><td>Assuming 'i' is &gt;= field 'elements'</td><td><div class="PathNav"><a href="#Path7" title="Next event (7)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr><td class="num"></td><td class="line"><div id="Path7" class="msg msgControl" style="margin-left:5ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexControl">7</div></td><td><div class="PathNav"><a href="#Path6" title="Previous event (6)">&#x2190;</a></div></td><td>Loop condition is false. Execution continues on line 599</td><td><div class="PathNav"><a href="#EndPath" title="Next event (8)">&#x2192;</a></div></td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="567"><td class="num" id="LN567">567</td><td class="line">        <span class='macro'>assert(argMap-&gt;element[i]-&gt;type == REDIS_REPLY_STRING)<span class='macro_popup'>((argMap-&gt;element[i]-&gt;type == 1) ? (void) (0) : __assert_fail<br> ("argMap-&gt;element[i]-&gt;type == REDIS_REPLY_STRING", "redis-cli.c"<br>, 567, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="568"><td class="num" id="LN568">568</td><td class="line">        <span class='keyword'>char</span> *key = argMap-&gt;element[i]-&gt;str;</td></tr>
<tr class="codeline" data-linenumber="569"><td class="num" id="LN569">569</td><td class="line">        <span class='keyword'>if</span> (!strcmp(key, <span class='string_literal'>"name"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="570"><td class="num" id="LN570">570</td><td class="line">            <span class='macro'>assert(argMap-&gt;element[i + 1]-&gt;type == REDIS_REPLY_STRING)<span class='macro_popup'>((argMap-&gt;element[i + 1]-&gt;type == 1) ? (void) (0) : __assert_fail<br> ("argMap-&gt;element[i + 1]-&gt;type == REDIS_REPLY_STRING",<br> "redis-cli.c", 570, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="571"><td class="num" id="LN571">571</td><td class="line">            name = argMap-&gt;element[i + 1]-&gt;str;</td></tr>
<tr class="codeline" data-linenumber="572"><td class="num" id="LN572">572</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(key, <span class='string_literal'>"token"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="573"><td class="num" id="LN573">573</td><td class="line">            <span class='macro'>assert(argMap-&gt;element[i + 1]-&gt;type == REDIS_REPLY_STRING)<span class='macro_popup'>((argMap-&gt;element[i + 1]-&gt;type == 1) ? (void) (0) : __assert_fail<br> ("argMap-&gt;element[i + 1]-&gt;type == REDIS_REPLY_STRING",<br> "redis-cli.c", 573, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="574"><td class="num" id="LN574">574</td><td class="line">            <span class='keyword'>char</span> *token = argMap-&gt;element[i + 1]-&gt;str;</td></tr>
<tr class="codeline" data-linenumber="575"><td class="num" id="LN575">575</td><td class="line">            tokenPart = sdscat_orempty(tokenPart, token);</td></tr>
<tr class="codeline" data-linenumber="576"><td class="num" id="LN576">576</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(key, <span class='string_literal'>"type"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="577"><td class="num" id="LN577">577</td><td class="line">            <span class='macro'>assert(argMap-&gt;element[i + 1]-&gt;type == REDIS_REPLY_STRING)<span class='macro_popup'>((argMap-&gt;element[i + 1]-&gt;type == 1) ? (void) (0) : __assert_fail<br> ("argMap-&gt;element[i + 1]-&gt;type == REDIS_REPLY_STRING",<br> "redis-cli.c", 577, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="578"><td class="num" id="LN578">578</td><td class="line">            type = argMap-&gt;element[i + 1]-&gt;str;</td></tr>
<tr class="codeline" data-linenumber="579"><td class="num" id="LN579">579</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(key, <span class='string_literal'>"arguments"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="580"><td class="num" id="LN580">580</td><td class="line">            arguments = argMap-&gt;element[i + 1];</td></tr>
<tr class="codeline" data-linenumber="581"><td class="num" id="LN581">581</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(key, <span class='string_literal'>"flags"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="582"><td class="num" id="LN582">582</td><td class="line">            redisReply *flags = argMap-&gt;element[i + 1];</td></tr>
<tr class="codeline" data-linenumber="583"><td class="num" id="LN583">583</td><td class="line">            <span class='macro'>assert(flags-&gt;type == REDIS_REPLY_SET || flags-&gt;type == REDIS_REPLY_ARRAY)<span class='macro_popup'>((flags-&gt;type == 10 || flags-&gt;type == 2) ? (void) (0) :<br> __assert_fail ("flags-&gt;type == REDIS_REPLY_SET || flags-&gt;type == REDIS_REPLY_ARRAY"<br>, "redis-cli.c", 583, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="584"><td class="num" id="LN584">584</td><td class="line">            <span class='keyword'>for</span> (size_t j = 0; j &lt; flags-&gt;elements; j++) {</td></tr>
<tr class="codeline" data-linenumber="585"><td class="num" id="LN585">585</td><td class="line">                <span class='macro'>assert(flags-&gt;element[j]-&gt;type == REDIS_REPLY_STATUS)<span class='macro_popup'>((flags-&gt;element[j]-&gt;type == 5) ? (void) (0) : __assert_fail<br> ("flags-&gt;element[j]-&gt;type == REDIS_REPLY_STATUS", "redis-cli.c"<br>, 585, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="586"><td class="num" id="LN586">586</td><td class="line">                <span class='keyword'>char</span> *flag = flags-&gt;element[j]-&gt;str;</td></tr>
<tr class="codeline" data-linenumber="587"><td class="num" id="LN587">587</td><td class="line">                <span class='keyword'>if</span> (!strcmp(flag, <span class='string_literal'>"optional"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="588"><td class="num" id="LN588">588</td><td class="line">                    optional = 1;</td></tr>
<tr class="codeline" data-linenumber="589"><td class="num" id="LN589">589</td><td class="line">                } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(flag, <span class='string_literal'>"multiple"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="590"><td class="num" id="LN590">590</td><td class="line">                    multiple = 1;</td></tr>
<tr class="codeline" data-linenumber="591"><td class="num" id="LN591">591</td><td class="line">                } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(flag, <span class='string_literal'>"multiple_token"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="592"><td class="num" id="LN592">592</td><td class="line">                    multipleToken = 1;</td></tr>
<tr class="codeline" data-linenumber="593"><td class="num" id="LN593">593</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="594"><td class="num" id="LN594">594</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="595"><td class="num" id="LN595">595</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="596"><td class="num" id="LN596">596</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="597"><td class="num" id="LN597">597</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="598"><td class="num" id="LN598">598</td><td class="line">    <span class='comment'>/* Then build the "repeating part" of the argument string. */</span></td></tr>
<tr class="codeline" data-linenumber="599"><td class="num" id="LN599">599</td><td class="line">    <span class='keyword'>if</span> (!strcmp(<span class="mrange">type</span>, <span class='string_literal'>"key"</span>) ||</td></tr>
<tr><td class="num"></td><td class="line"><div id="EndPath" class="msg msgEvent" style="margin-left:10ex"><table class="msgT"><tr><td valign="top"><div class="PathIndex PathIndexEvent">8</div></td><td><div class="PathNav"><a href="#Path7" title="Previous event (7)">&#x2190;</a></div></td><td>Null pointer passed to 1st parameter expecting 'nonnull'</td></tr></table></div></td></tr>
<tr class="codeline" data-linenumber="600"><td class="num" id="LN600">600</td><td class="line">        !strcmp(type, <span class='string_literal'>"string"</span>) ||</td></tr>
<tr class="codeline" data-linenumber="601"><td class="num" id="LN601">601</td><td class="line">        !strcmp(type, <span class='string_literal'>"integer"</span>) ||</td></tr>
<tr class="codeline" data-linenumber="602"><td class="num" id="LN602">602</td><td class="line">        !strcmp(type, <span class='string_literal'>"double"</span>) ||</td></tr>
<tr class="codeline" data-linenumber="603"><td class="num" id="LN603">603</td><td class="line">        !strcmp(type, <span class='string_literal'>"pattern"</span>) ||</td></tr>
<tr class="codeline" data-linenumber="604"><td class="num" id="LN604">604</td><td class="line">        !strcmp(type, <span class='string_literal'>"unix-time"</span>) ||</td></tr>
<tr class="codeline" data-linenumber="605"><td class="num" id="LN605">605</td><td class="line">        !strcmp(type, <span class='string_literal'>"token"</span>))</td></tr>
<tr class="codeline" data-linenumber="606"><td class="num" id="LN606">606</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="607"><td class="num" id="LN607">607</td><td class="line">        repeatPart = sdscat_orempty(repeatPart, name);</td></tr>
<tr class="codeline" data-linenumber="608"><td class="num" id="LN608">608</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(type, <span class='string_literal'>"oneof"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="609"><td class="num" id="LN609">609</td><td class="line">        repeatPart = cliConcatArguments(repeatPart, arguments, <span class='string_literal'>"|"</span>);</td></tr>
<tr class="codeline" data-linenumber="610"><td class="num" id="LN610">610</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(type, <span class='string_literal'>"block"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="611"><td class="num" id="LN611">611</td><td class="line">        repeatPart = cliConcatArguments(repeatPart, arguments, <span class='string_literal'>" "</span>);</td></tr>
<tr class="codeline" data-linenumber="612"><td class="num" id="LN612">612</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (strcmp(type, <span class='string_literal'>"pure-token"</span>) != 0) {</td></tr>
<tr class="codeline" data-linenumber="613"><td class="num" id="LN613">613</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Unknown type '%s' set for argument '%s'\n"</span>, type, name);</td></tr>
<tr class="codeline" data-linenumber="614"><td class="num" id="LN614">614</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="615"><td class="num" id="LN615">615</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="616"><td class="num" id="LN616">616</td><td class="line">    <span class='comment'>/* Finally, build the parameter string. */</span></td></tr>
<tr class="codeline" data-linenumber="617"><td class="num" id="LN617">617</td><td class="line">    <span class='keyword'>if</span> (tokenPart[0] != '\0' &amp;&amp; strcmp(type, <span class='string_literal'>"pure-token"</span>) != 0) {</td></tr>
<tr class="codeline" data-linenumber="618"><td class="num" id="LN618">618</td><td class="line">        tokenPart = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(tokenPart, <span class='string_literal'>" "</span>);</td></tr>
<tr class="codeline" data-linenumber="619"><td class="num" id="LN619">619</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="620"><td class="num" id="LN620">620</td><td class="line">    <span class='keyword'>if</span> (optional) {</td></tr>
<tr class="codeline" data-linenumber="621"><td class="num" id="LN621">621</td><td class="line">        params = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(params, <span class='string_literal'>"["</span>);</td></tr>
<tr class="codeline" data-linenumber="622"><td class="num" id="LN622">622</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="623"><td class="num" id="LN623">623</td><td class="line">    params = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(params, tokenPart);</td></tr>
<tr class="codeline" data-linenumber="624"><td class="num" id="LN624">624</td><td class="line">    params = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(params, repeatPart);</td></tr>
<tr class="codeline" data-linenumber="625"><td class="num" id="LN625">625</td><td class="line">    <span class='keyword'>if</span> (multiple) {</td></tr>
<tr class="codeline" data-linenumber="626"><td class="num" id="LN626">626</td><td class="line">        params = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(params, <span class='string_literal'>" ["</span>);</td></tr>
<tr class="codeline" data-linenumber="627"><td class="num" id="LN627">627</td><td class="line">        <span class='keyword'>if</span> (multipleToken) {</td></tr>
<tr class="codeline" data-linenumber="628"><td class="num" id="LN628">628</td><td class="line">            params = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(params, tokenPart);</td></tr>
<tr class="codeline" data-linenumber="629"><td class="num" id="LN629">629</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="630"><td class="num" id="LN630">630</td><td class="line">        params = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(params, repeatPart);</td></tr>
<tr class="codeline" data-linenumber="631"><td class="num" id="LN631">631</td><td class="line">        params = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(params, <span class='string_literal'>" ...]"</span>);</td></tr>
<tr class="codeline" data-linenumber="632"><td class="num" id="LN632">632</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="633"><td class="num" id="LN633">633</td><td class="line">    <span class='keyword'>if</span> (optional) {</td></tr>
<tr class="codeline" data-linenumber="634"><td class="num" id="LN634">634</td><td class="line">        params = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(params, <span class='string_literal'>"]"</span>);</td></tr>
<tr class="codeline" data-linenumber="635"><td class="num" id="LN635">635</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="636"><td class="num" id="LN636">636</td><td class="line">    <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(tokenPart);</td></tr>
<tr class="codeline" data-linenumber="637"><td class="num" id="LN637">637</td><td class="line">    <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(repeatPart);</td></tr>
<tr class="codeline" data-linenumber="638"><td class="num" id="LN638">638</td><td class="line">    <span class='keyword'>return</span> params;</td></tr>
<tr class="codeline" data-linenumber="639"><td class="num" id="LN639">639</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="640"><td class="num" id="LN640">640</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="641"><td class="num" id="LN641">641</td><td class="line"><span class='comment'>/* Fill in the fields of a help entry for the command/subcommand name. */</span></td></tr>
<tr class="codeline" data-linenumber="642"><td class="num" id="LN642">642</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> cliFillInCommandHelpEntry(helpEntry *help, <span class='keyword'>char</span> *cmdname, <span class='keyword'>char</span> *subcommandname) {</td></tr>
<tr class="codeline" data-linenumber="643"><td class="num" id="LN643">643</td><td class="line">    help-&gt;argc = subcommandname ? 2 : 1;</td></tr>
<tr class="codeline" data-linenumber="644"><td class="num" id="LN644">644</td><td class="line">    help-&gt;argv = zmalloc(<span class='keyword'>sizeof</span>(<span class='macro'>sds<span class='macro_popup'>hisds</span></span>) * help-&gt;argc);</td></tr>
<tr class="codeline" data-linenumber="645"><td class="num" id="LN645">645</td><td class="line">    help-&gt;argv[0] = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(cmdname);</td></tr>
<tr class="codeline" data-linenumber="646"><td class="num" id="LN646">646</td><td class="line">    <span class='macro'>sdstoupper<span class='macro_popup'>hi_sdstoupper</span></span>(help-&gt;argv[0]);</td></tr>
<tr class="codeline" data-linenumber="647"><td class="num" id="LN647">647</td><td class="line">    <span class='keyword'>if</span> (subcommandname) {</td></tr>
<tr class="codeline" data-linenumber="648"><td class="num" id="LN648">648</td><td class="line">        <span class='comment'>/* Subcommand name is two words separated by a pipe character. */</span></td></tr>
<tr class="codeline" data-linenumber="649"><td class="num" id="LN649">649</td><td class="line">        help-&gt;argv[1] = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(strchr(subcommandname, '|') + 1);</td></tr>
<tr class="codeline" data-linenumber="650"><td class="num" id="LN650">650</td><td class="line">        <span class='macro'>sdstoupper<span class='macro_popup'>hi_sdstoupper</span></span>(help-&gt;argv[1]);</td></tr>
<tr class="codeline" data-linenumber="651"><td class="num" id="LN651">651</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="652"><td class="num" id="LN652">652</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> fullname = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(help-&gt;argv[0]);</td></tr>
<tr class="codeline" data-linenumber="653"><td class="num" id="LN653">653</td><td class="line">    <span class='keyword'>if</span> (subcommandname) {</td></tr>
<tr class="codeline" data-linenumber="654"><td class="num" id="LN654">654</td><td class="line">        fullname = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(fullname, <span class='string_literal'>" "</span>);</td></tr>
<tr class="codeline" data-linenumber="655"><td class="num" id="LN655">655</td><td class="line">        fullname = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(fullname, help-&gt;argv[1]);</td></tr>
<tr class="codeline" data-linenumber="656"><td class="num" id="LN656">656</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="657"><td class="num" id="LN657">657</td><td class="line">    help-&gt;full = fullname;</td></tr>
<tr class="codeline" data-linenumber="658"><td class="num" id="LN658">658</td><td class="line">    help-&gt;type = <span class='macro'>CLI_HELP_COMMAND<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="659"><td class="num" id="LN659">659</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="660"><td class="num" id="LN660">660</td><td class="line">    help-&gt;org.name = help-&gt;full;</td></tr>
<tr class="codeline" data-linenumber="661"><td class="num" id="LN661">661</td><td class="line">    help-&gt;org.params = <span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>();</td></tr>
<tr class="codeline" data-linenumber="662"><td class="num" id="LN662">662</td><td class="line">    help-&gt;org.since = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="663"><td class="num" id="LN663">663</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="664"><td class="num" id="LN664">664</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="665"><td class="num" id="LN665">665</td><td class="line"><span class='comment'>/* Initialize a command help entry for the command/subcommand described in 'specs'.</span></td></tr>
<tr class="codeline" data-linenumber="666"><td class="num" id="LN666">666</td><td class="line"> <span class='comment'>* 'next' points to the next help entry to be filled in.</span></td></tr>
<tr class="codeline" data-linenumber="667"><td class="num" id="LN667">667</td><td class="line"> <span class='comment'>* 'groups' is a set of command group names to be filled in.</span></td></tr>
<tr class="codeline" data-linenumber="668"><td class="num" id="LN668">668</td><td class="line"> <span class='comment'>* Returns a pointer to the next available position in the help entries table.</span></td></tr>
<tr class="codeline" data-linenumber="669"><td class="num" id="LN669">669</td><td class="line"> <span class='comment'>* If the command has subcommands, this is called recursively for the subcommands.</span></td></tr>
<tr class="codeline" data-linenumber="670"><td class="num" id="LN670">670</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="671"><td class="num" id="LN671">671</td><td class="line"><span class='keyword'>static</span> helpEntry *cliInitCommandHelpEntry(<span class='keyword'>char</span> *cmdname, <span class='keyword'>char</span> *subcommandname,</td></tr>
<tr class="codeline" data-linenumber="672"><td class="num" id="LN672">672</td><td class="line">                                          helpEntry *next, redisReply *specs,</td></tr>
<tr class="codeline" data-linenumber="673"><td class="num" id="LN673">673</td><td class="line">                                          dict *groups) {</td></tr>
<tr class="codeline" data-linenumber="674"><td class="num" id="LN674">674</td><td class="line">    helpEntry *help = next++;</td></tr>
<tr class="codeline" data-linenumber="675"><td class="num" id="LN675">675</td><td class="line">    cliFillInCommandHelpEntry(help, cmdname, subcommandname);</td></tr>
<tr class="codeline" data-linenumber="676"><td class="num" id="LN676">676</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="677"><td class="num" id="LN677">677</td><td class="line">    <span class='macro'>assert(specs-&gt;type == REDIS_REPLY_MAP || specs-&gt;type == REDIS_REPLY_ARRAY)<span class='macro_popup'>((specs-&gt;type == 9 || specs-&gt;type == 2) ? (void) (0) : __assert_fail<br> ("specs-&gt;type == REDIS_REPLY_MAP || specs-&gt;type == REDIS_REPLY_ARRAY"<br>, "redis-cli.c", 677, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="678"><td class="num" id="LN678">678</td><td class="line">    <span class='keyword'>for</span> (size_t j = 0; j &lt; specs-&gt;elements; j += 2) {</td></tr>
<tr class="codeline" data-linenumber="679"><td class="num" id="LN679">679</td><td class="line">        <span class='macro'>assert(specs-&gt;element[j]-&gt;type == REDIS_REPLY_STRING)<span class='macro_popup'>((specs-&gt;element[j]-&gt;type == 1) ? (void) (0) : __assert_fail<br> ("specs-&gt;element[j]-&gt;type == REDIS_REPLY_STRING", "redis-cli.c"<br>, 679, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="680"><td class="num" id="LN680">680</td><td class="line">        <span class='keyword'>char</span> *key = specs-&gt;element[j]-&gt;str;</td></tr>
<tr class="codeline" data-linenumber="681"><td class="num" id="LN681">681</td><td class="line">        <span class='keyword'>if</span> (!strcmp(key, <span class='string_literal'>"summary"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="682"><td class="num" id="LN682">682</td><td class="line">            redisReply *reply = specs-&gt;element[j + 1];</td></tr>
<tr class="codeline" data-linenumber="683"><td class="num" id="LN683">683</td><td class="line">            <span class='macro'>assert(reply-&gt;type == REDIS_REPLY_STRING)<span class='macro_popup'>((reply-&gt;type == 1) ? (void) (0) : __assert_fail ("reply-&gt;type == REDIS_REPLY_STRING"<br>, "redis-cli.c", 683, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="684"><td class="num" id="LN684">684</td><td class="line">            help-&gt;org.summary = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(reply-&gt;str);</td></tr>
<tr class="codeline" data-linenumber="685"><td class="num" id="LN685">685</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(key, <span class='string_literal'>"since"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="686"><td class="num" id="LN686">686</td><td class="line">            redisReply *reply = specs-&gt;element[j + 1];</td></tr>
<tr class="codeline" data-linenumber="687"><td class="num" id="LN687">687</td><td class="line">            <span class='macro'>assert(reply-&gt;type == REDIS_REPLY_STRING)<span class='macro_popup'>((reply-&gt;type == 1) ? (void) (0) : __assert_fail ("reply-&gt;type == REDIS_REPLY_STRING"<br>, "redis-cli.c", 687, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="688"><td class="num" id="LN688">688</td><td class="line">            help-&gt;org.since = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(reply-&gt;str);</td></tr>
<tr class="codeline" data-linenumber="689"><td class="num" id="LN689">689</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(key, <span class='string_literal'>"group"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="690"><td class="num" id="LN690">690</td><td class="line">            redisReply *reply = specs-&gt;element[j + 1];</td></tr>
<tr class="codeline" data-linenumber="691"><td class="num" id="LN691">691</td><td class="line">            <span class='macro'>assert(reply-&gt;type == REDIS_REPLY_STRING)<span class='macro_popup'>((reply-&gt;type == 1) ? (void) (0) : __assert_fail ("reply-&gt;type == REDIS_REPLY_STRING"<br>, "redis-cli.c", 691, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="692"><td class="num" id="LN692">692</td><td class="line">            help-&gt;org.group = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(reply-&gt;str);</td></tr>
<tr class="codeline" data-linenumber="693"><td class="num" id="LN693">693</td><td class="line">            <span class='macro'>sds<span class='macro_popup'>hisds</span></span> group = <span class='macro'>sdsdup<span class='macro_popup'>hi_sdsdup</span></span>(help-&gt;org.group);</td></tr>
<tr class="codeline" data-linenumber="694"><td class="num" id="LN694">694</td><td class="line">            <span class='keyword'>if</span> (dictAdd(groups, group, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) != <span class='macro'>DICT_OK<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="695"><td class="num" id="LN695">695</td><td class="line">                <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(group);</td></tr>
<tr class="codeline" data-linenumber="696"><td class="num" id="LN696">696</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="697"><td class="num" id="LN697">697</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(key, <span class='string_literal'>"arguments"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="698"><td class="num" id="LN698">698</td><td class="line">            redisReply *args = specs-&gt;element[j + 1];</td></tr>
<tr class="codeline" data-linenumber="699"><td class="num" id="LN699">699</td><td class="line">            <span class='macro'>assert(args-&gt;type == REDIS_REPLY_ARRAY)<span class='macro_popup'>((args-&gt;type == 2) ? (void) (0) : __assert_fail ("args-&gt;type == REDIS_REPLY_ARRAY"<br>, "redis-cli.c", 699, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="700"><td class="num" id="LN700">700</td><td class="line">            help-&gt;org.params = cliConcatArguments(help-&gt;org.params, args, <span class='string_literal'>" "</span>);</td></tr>
<tr class="codeline" data-linenumber="701"><td class="num" id="LN701">701</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(key, <span class='string_literal'>"subcommands"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="702"><td class="num" id="LN702">702</td><td class="line">            redisReply *subcommands = specs-&gt;element[j + 1];</td></tr>
<tr class="codeline" data-linenumber="703"><td class="num" id="LN703">703</td><td class="line">            <span class='macro'>assert(subcommands-&gt;type == REDIS_REPLY_MAP || subcommands-&gt;type == REDIS_REPLY_ARRAY)<span class='macro_popup'>((subcommands-&gt;type == 9 || subcommands-&gt;type == 2) ? (<br>void) (0) : __assert_fail ("subcommands-&gt;type == REDIS_REPLY_MAP || subcommands-&gt;type == REDIS_REPLY_ARRAY"<br>, "redis-cli.c", 703, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="704"><td class="num" id="LN704">704</td><td class="line">            <span class='keyword'>for</span> (size_t i = 0; i &lt; subcommands-&gt;elements; i += 2) {</td></tr>
<tr class="codeline" data-linenumber="705"><td class="num" id="LN705">705</td><td class="line">                <span class='macro'>assert(subcommands-&gt;element[i]-&gt;type == REDIS_REPLY_STRING)<span class='macro_popup'>((subcommands-&gt;element[i]-&gt;type == 1) ? (void) (0) : __assert_fail<br> ("subcommands-&gt;element[i]-&gt;type == REDIS_REPLY_STRING"<br>, "redis-cli.c", 705, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="706"><td class="num" id="LN706">706</td><td class="line">                <span class='keyword'>char</span> *subcommandname = subcommands-&gt;element[i]-&gt;str;</td></tr>
<tr class="codeline" data-linenumber="707"><td class="num" id="LN707">707</td><td class="line">                redisReply *subcommand = subcommands-&gt;element[i + 1];</td></tr>
<tr class="codeline" data-linenumber="708"><td class="num" id="LN708">708</td><td class="line">                <span class='macro'>assert(subcommand-&gt;type == REDIS_REPLY_MAP || subcommand-&gt;type == REDIS_REPLY_ARRAY)<span class='macro_popup'>((subcommand-&gt;type == 9 || subcommand-&gt;type == 2) ? (void<br>) (0) : __assert_fail ("subcommand-&gt;type == REDIS_REPLY_MAP || subcommand-&gt;type == REDIS_REPLY_ARRAY"<br>, "redis-cli.c", 708, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="709"><td class="num" id="LN709">709</td><td class="line">                next = cliInitCommandHelpEntry(cmdname, subcommandname, next, subcommand, groups);</td></tr>
<tr class="codeline" data-linenumber="710"><td class="num" id="LN710">710</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="711"><td class="num" id="LN711">711</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="712"><td class="num" id="LN712">712</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="713"><td class="num" id="LN713">713</td><td class="line">    <span class='keyword'>return</span> next;</td></tr>
<tr class="codeline" data-linenumber="714"><td class="num" id="LN714">714</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="715"><td class="num" id="LN715">715</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="716"><td class="num" id="LN716">716</td><td class="line"><span class='comment'>/* Returns the total number of commands and subcommands in the command docs table. */</span></td></tr>
<tr class="codeline" data-linenumber="717"><td class="num" id="LN717">717</td><td class="line"><span class='keyword'>static</span> size_t cliCountCommands(redisReply* commandTable) {</td></tr>
<tr class="codeline" data-linenumber="718"><td class="num" id="LN718">718</td><td class="line">    size_t numCommands = commandTable-&gt;elements / 2;</td></tr>
<tr class="codeline" data-linenumber="719"><td class="num" id="LN719">719</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="720"><td class="num" id="LN720">720</td><td class="line">    <span class='comment'>/* The command docs table maps command names to a map of their specs. */</span>    </td></tr>
<tr class="codeline" data-linenumber="721"><td class="num" id="LN721">721</td><td class="line">    <span class='keyword'>for</span> (size_t i = 0; i &lt; commandTable-&gt;elements; i += 2) {</td></tr>
<tr class="codeline" data-linenumber="722"><td class="num" id="LN722">722</td><td class="line">        <span class='macro'>assert(commandTable-&gt;element[i]-&gt;type == REDIS_REPLY_STRING)<span class='macro_popup'>((commandTable-&gt;element[i]-&gt;type == 1) ? (void) (0) : __assert_fail<br> ("commandTable-&gt;element[i]-&gt;type == REDIS_REPLY_STRING"<br>, "redis-cli.c", 722, __extension__ __PRETTY_FUNCTION__))</span></span>;  <span class='comment'>/* Command name. */</span></td></tr>
<tr class="codeline" data-linenumber="723"><td class="num" id="LN723">723</td><td class="line">        <span class='macro'>assert(commandTable-&gt;element[i + 1]-&gt;type == REDIS_REPLY_MAP ||<span class='macro_popup'>((commandTable-&gt;element[i + 1]-&gt;type == 9 || commandTable<br>-&gt;element[i + 1]-&gt;type == 2) ? (void) (0) : __assert_fail<br> ("commandTable-&gt;element[i + 1]-&gt;type == REDIS_REPLY_MAP || commandTable-&gt;element[i + 1]-&gt;type == REDIS_REPLY_ARRAY"<br>, "redis-cli.c", 724, __extension__ __PRETTY_FUNCTION__))</span></span></td></tr>
<tr class="codeline" data-linenumber="724"><td class="num" id="LN724">724</td><td class="line">               <span class='macro'>commandTable-&gt;element[i + 1]-&gt;type == REDIS_REPLY_ARRAY)<span class='macro_popup'>((commandTable-&gt;element[i + 1]-&gt;type == 9 || commandTable<br>-&gt;element[i + 1]-&gt;type == 2) ? (void) (0) : __assert_fail<br> ("commandTable-&gt;element[i + 1]-&gt;type == REDIS_REPLY_MAP || commandTable-&gt;element[i + 1]-&gt;type == REDIS_REPLY_ARRAY"<br>, "redis-cli.c", 724, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="725"><td class="num" id="LN725">725</td><td class="line">        redisReply *map = commandTable-&gt;element[i + 1];</td></tr>
<tr class="codeline" data-linenumber="726"><td class="num" id="LN726">726</td><td class="line">        <span class='keyword'>for</span> (size_t j = 0; j &lt; map-&gt;elements; j += 2) {</td></tr>
<tr class="codeline" data-linenumber="727"><td class="num" id="LN727">727</td><td class="line">            <span class='macro'>assert(map-&gt;element[j]-&gt;type == REDIS_REPLY_STRING)<span class='macro_popup'>((map-&gt;element[j]-&gt;type == 1) ? (void) (0) : __assert_fail<br> ("map-&gt;element[j]-&gt;type == REDIS_REPLY_STRING", "redis-cli.c"<br>, 727, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="728"><td class="num" id="LN728">728</td><td class="line">            <span class='keyword'>char</span> *key = map-&gt;element[j]-&gt;str;</td></tr>
<tr class="codeline" data-linenumber="729"><td class="num" id="LN729">729</td><td class="line">            <span class='keyword'>if</span> (!strcmp(key, <span class='string_literal'>"subcommands"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="730"><td class="num" id="LN730">730</td><td class="line">                redisReply *subcommands = map-&gt;element[j + 1];</td></tr>
<tr class="codeline" data-linenumber="731"><td class="num" id="LN731">731</td><td class="line">                <span class='macro'>assert(subcommands-&gt;type == REDIS_REPLY_MAP || subcommands-&gt;type == REDIS_REPLY_ARRAY)<span class='macro_popup'>((subcommands-&gt;type == 9 || subcommands-&gt;type == 2) ? (<br>void) (0) : __assert_fail ("subcommands-&gt;type == REDIS_REPLY_MAP || subcommands-&gt;type == REDIS_REPLY_ARRAY"<br>, "redis-cli.c", 731, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="732"><td class="num" id="LN732">732</td><td class="line">                numCommands += subcommands-&gt;elements / 2;</td></tr>
<tr class="codeline" data-linenumber="733"><td class="num" id="LN733">733</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="734"><td class="num" id="LN734">734</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="735"><td class="num" id="LN735">735</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="736"><td class="num" id="LN736">736</td><td class="line">    <span class='keyword'>return</span> numCommands;</td></tr>
<tr class="codeline" data-linenumber="737"><td class="num" id="LN737">737</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="738"><td class="num" id="LN738">738</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="739"><td class="num" id="LN739">739</td><td class="line"><span class='comment'>/* Comparator for sorting help table entries. */</span></td></tr>
<tr class="codeline" data-linenumber="740"><td class="num" id="LN740">740</td><td class="line"><span class='keyword'>int</span> helpEntryCompare(<span class='keyword'>const</span> <span class='keyword'>void</span> *entry1, <span class='keyword'>const</span> <span class='keyword'>void</span> *entry2) {</td></tr>
<tr class="codeline" data-linenumber="741"><td class="num" id="LN741">741</td><td class="line">    helpEntry *i1 = (helpEntry *)entry1;</td></tr>
<tr class="codeline" data-linenumber="742"><td class="num" id="LN742">742</td><td class="line">    helpEntry *i2 = (helpEntry *)entry2;</td></tr>
<tr class="codeline" data-linenumber="743"><td class="num" id="LN743">743</td><td class="line">    <span class='keyword'>return</span> strcmp(i1-&gt;full, i2-&gt;full);</td></tr>
<tr class="codeline" data-linenumber="744"><td class="num" id="LN744">744</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="745"><td class="num" id="LN745">745</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="746"><td class="num" id="LN746">746</td><td class="line"><span class='comment'>/* Initializes command help entries for command groups.</span></td></tr>
<tr class="codeline" data-linenumber="747"><td class="num" id="LN747">747</td><td class="line"> <span class='comment'>* Called after the command help entries have already been filled in.</span></td></tr>
<tr class="codeline" data-linenumber="748"><td class="num" id="LN748">748</td><td class="line"> <span class='comment'>* Extends the help table with new entries for the command groups.</span></td></tr>
<tr class="codeline" data-linenumber="749"><td class="num" id="LN749">749</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="750"><td class="num" id="LN750">750</td><td class="line"><span class='keyword'>void</span> cliInitGroupHelpEntries(dict *groups) {</td></tr>
<tr class="codeline" data-linenumber="751"><td class="num" id="LN751">751</td><td class="line">    dictIterator *iter = dictGetIterator(groups);</td></tr>
<tr class="codeline" data-linenumber="752"><td class="num" id="LN752">752</td><td class="line">    dictEntry *entry;</td></tr>
<tr class="codeline" data-linenumber="753"><td class="num" id="LN753">753</td><td class="line">    helpEntry tmp;</td></tr>
<tr class="codeline" data-linenumber="754"><td class="num" id="LN754">754</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="755"><td class="num" id="LN755">755</td><td class="line">    <span class='keyword'>int</span> numGroups = <span class='macro'>dictSize(groups)<span class='macro_popup'>((groups)-&gt;ht_used[0]+(groups)-&gt;ht_used[1])</span></span>;</td></tr>
<tr class="codeline" data-linenumber="756"><td class="num" id="LN756">756</td><td class="line">    <span class='keyword'>int</span> pos = helpEntriesLen;</td></tr>
<tr class="codeline" data-linenumber="757"><td class="num" id="LN757">757</td><td class="line">    helpEntriesLen += numGroups;</td></tr>
<tr class="codeline" data-linenumber="758"><td class="num" id="LN758">758</td><td class="line">    helpEntries = zrealloc(helpEntries, <span class='keyword'>sizeof</span>(helpEntry)*helpEntriesLen);</td></tr>
<tr class="codeline" data-linenumber="759"><td class="num" id="LN759">759</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="760"><td class="num" id="LN760">760</td><td class="line">    <span class='keyword'>for</span> (entry = dictNext(iter); entry != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>; entry = dictNext(iter)) {</td></tr>
<tr class="codeline" data-linenumber="761"><td class="num" id="LN761">761</td><td class="line">        tmp.argc = 1;</td></tr>
<tr class="codeline" data-linenumber="762"><td class="num" id="LN762">762</td><td class="line">        tmp.argv = zmalloc(<span class='keyword'>sizeof</span>(<span class='macro'>sds<span class='macro_popup'>hisds</span></span>));</td></tr>
<tr class="codeline" data-linenumber="763"><td class="num" id="LN763">763</td><td class="line">        tmp.argv[0] = <span class='macro'>sdscatprintf<span class='macro_popup'>hi_sdscatprintf</span></span>(<span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>(),<span class='string_literal'>"@%s"</span>,(<span class='keyword'>char</span> *)entry-&gt;key);</td></tr>
<tr class="codeline" data-linenumber="764"><td class="num" id="LN764">764</td><td class="line">        tmp.full = tmp.argv[0];</td></tr>
<tr class="codeline" data-linenumber="765"><td class="num" id="LN765">765</td><td class="line">        tmp.type = <span class='macro'>CLI_HELP_GROUP<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="766"><td class="num" id="LN766">766</td><td class="line">        tmp.org.name = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="767"><td class="num" id="LN767">767</td><td class="line">        tmp.org.params = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="768"><td class="num" id="LN768">768</td><td class="line">        tmp.org.summary = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="769"><td class="num" id="LN769">769</td><td class="line">        tmp.org.since = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="770"><td class="num" id="LN770">770</td><td class="line">        tmp.org.group = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="771"><td class="num" id="LN771">771</td><td class="line">        helpEntries[pos++] = tmp;</td></tr>
<tr class="codeline" data-linenumber="772"><td class="num" id="LN772">772</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="773"><td class="num" id="LN773">773</td><td class="line">    dictReleaseIterator(iter);</td></tr>
<tr class="codeline" data-linenumber="774"><td class="num" id="LN774">774</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="775"><td class="num" id="LN775">775</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="776"><td class="num" id="LN776">776</td><td class="line"><span class='comment'>/* Initializes help entries for all commands in the COMMAND DOCS reply. */</span></td></tr>
<tr class="codeline" data-linenumber="777"><td class="num" id="LN777">777</td><td class="line"><span class='keyword'>void</span> cliInitCommandHelpEntries(redisReply *commandTable, dict *groups) {</td></tr>
<tr class="codeline" data-linenumber="778"><td class="num" id="LN778">778</td><td class="line">    helpEntry *next = helpEntries;</td></tr>
<tr class="codeline" data-linenumber="779"><td class="num" id="LN779">779</td><td class="line">    <span class='keyword'>for</span> (size_t i = 0; i &lt; commandTable-&gt;elements; i += 2) {</td></tr>
<tr class="codeline" data-linenumber="780"><td class="num" id="LN780">780</td><td class="line">        <span class='macro'>assert(commandTable-&gt;element[i]-&gt;type == REDIS_REPLY_STRING)<span class='macro_popup'>((commandTable-&gt;element[i]-&gt;type == 1) ? (void) (0) : __assert_fail<br> ("commandTable-&gt;element[i]-&gt;type == REDIS_REPLY_STRING"<br>, "redis-cli.c", 780, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="781"><td class="num" id="LN781">781</td><td class="line">        <span class='keyword'>char</span> *cmdname = commandTable-&gt;element[i]-&gt;str;</td></tr>
<tr class="codeline" data-linenumber="782"><td class="num" id="LN782">782</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="783"><td class="num" id="LN783">783</td><td class="line">        <span class='macro'>assert(commandTable-&gt;element[i + 1]-&gt;type == REDIS_REPLY_MAP ||<span class='macro_popup'>((commandTable-&gt;element[i + 1]-&gt;type == 9 || commandTable<br>-&gt;element[i + 1]-&gt;type == 2) ? (void) (0) : __assert_fail<br> ("commandTable-&gt;element[i + 1]-&gt;type == REDIS_REPLY_MAP || commandTable-&gt;element[i + 1]-&gt;type == REDIS_REPLY_ARRAY"<br>, "redis-cli.c", 784, __extension__ __PRETTY_FUNCTION__))</span></span></td></tr>
<tr class="codeline" data-linenumber="784"><td class="num" id="LN784">784</td><td class="line">               <span class='macro'>commandTable-&gt;element[i + 1]-&gt;type == REDIS_REPLY_ARRAY)<span class='macro_popup'>((commandTable-&gt;element[i + 1]-&gt;type == 9 || commandTable<br>-&gt;element[i + 1]-&gt;type == 2) ? (void) (0) : __assert_fail<br> ("commandTable-&gt;element[i + 1]-&gt;type == REDIS_REPLY_MAP || commandTable-&gt;element[i + 1]-&gt;type == REDIS_REPLY_ARRAY"<br>, "redis-cli.c", 784, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="785"><td class="num" id="LN785">785</td><td class="line">        redisReply *cmdspecs = commandTable-&gt;element[i + 1];</td></tr>
<tr class="codeline" data-linenumber="786"><td class="num" id="LN786">786</td><td class="line">        next = cliInitCommandHelpEntry(cmdname, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, next, cmdspecs, groups);</td></tr>
<tr class="codeline" data-linenumber="787"><td class="num" id="LN787">787</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="788"><td class="num" id="LN788">788</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="789"><td class="num" id="LN789">789</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="790"><td class="num" id="LN790">790</td><td class="line"><span class='comment'>/* cliInitHelp() sets up the helpEntries array with the command and group</span></td></tr>
<tr class="codeline" data-linenumber="791"><td class="num" id="LN791">791</td><td class="line"> <span class='comment'>* names and command descriptions obtained using the COMMAND DOCS command.</span></td></tr>
<tr class="codeline" data-linenumber="792"><td class="num" id="LN792">792</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="793"><td class="num" id="LN793">793</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> cliInitHelp(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="794"><td class="num" id="LN794">794</td><td class="line">    <span class='comment'>/* Dict type for a set of strings, used to collect names of command groups. */</span></td></tr>
<tr class="codeline" data-linenumber="795"><td class="num" id="LN795">795</td><td class="line">    dictType groupsdt = {</td></tr>
<tr class="codeline" data-linenumber="796"><td class="num" id="LN796">796</td><td class="line">        dictSdsHash,                <span class='comment'>/* hash function */</span></td></tr>
<tr class="codeline" data-linenumber="797"><td class="num" id="LN797">797</td><td class="line">        <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                       <span class='comment'>/* key dup */</span></td></tr>
<tr class="codeline" data-linenumber="798"><td class="num" id="LN798">798</td><td class="line">        <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                       <span class='comment'>/* val dup */</span></td></tr>
<tr class="codeline" data-linenumber="799"><td class="num" id="LN799">799</td><td class="line">        dictSdsKeyCompare,          <span class='comment'>/* key compare */</span></td></tr>
<tr class="codeline" data-linenumber="800"><td class="num" id="LN800">800</td><td class="line">        dictSdsDestructor,          <span class='comment'>/* key destructor */</span></td></tr>
<tr class="codeline" data-linenumber="801"><td class="num" id="LN801">801</td><td class="line">        <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                       <span class='comment'>/* val destructor */</span></td></tr>
<tr class="codeline" data-linenumber="802"><td class="num" id="LN802">802</td><td class="line">        <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>                        <span class='comment'>/* allow to expand */</span></td></tr>
<tr class="codeline" data-linenumber="803"><td class="num" id="LN803">803</td><td class="line">    };</td></tr>
<tr class="codeline" data-linenumber="804"><td class="num" id="LN804">804</td><td class="line">    redisReply *commandTable;</td></tr>
<tr class="codeline" data-linenumber="805"><td class="num" id="LN805">805</td><td class="line">    dict *groups;</td></tr>
<tr class="codeline" data-linenumber="806"><td class="num" id="LN806">806</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="807"><td class="num" id="LN807">807</td><td class="line">    <span class='keyword'>if</span> (cliConnect(<span class='macro'>CC_QUIET<span class='macro_popup'>(1&lt;&lt;1)</span></span>) == <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="808"><td class="num" id="LN808">808</td><td class="line">        <span class='comment'>/* Can not connect to the server, but we still want to provide</span></td></tr>
<tr class="codeline" data-linenumber="809"><td class="num" id="LN809">809</td><td class="line">         <span class='comment'>* help, generate it only from the old help.h data instead. */</span></td></tr>
<tr class="codeline" data-linenumber="810"><td class="num" id="LN810">810</td><td class="line">        cliOldInitHelp();</td></tr>
<tr class="codeline" data-linenumber="811"><td class="num" id="LN811">811</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="812"><td class="num" id="LN812">812</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="813"><td class="num" id="LN813">813</td><td class="line">    commandTable = redisCommand(context, <span class='string_literal'>"COMMAND DOCS"</span>);</td></tr>
<tr class="codeline" data-linenumber="814"><td class="num" id="LN814">814</td><td class="line">    <span class='keyword'>if</span> (commandTable == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> || commandTable-&gt;type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="815"><td class="num" id="LN815">815</td><td class="line">        <span class='comment'>/* New COMMAND DOCS subcommand not supported - generate help from old help.h data instead. */</span></td></tr>
<tr class="codeline" data-linenumber="816"><td class="num" id="LN816">816</td><td class="line">        freeReplyObject(commandTable);</td></tr>
<tr class="codeline" data-linenumber="817"><td class="num" id="LN817">817</td><td class="line">        cliOldInitHelp();</td></tr>
<tr class="codeline" data-linenumber="818"><td class="num" id="LN818">818</td><td class="line">        cliOldIntegrateHelp();</td></tr>
<tr class="codeline" data-linenumber="819"><td class="num" id="LN819">819</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="820"><td class="num" id="LN820">820</td><td class="line">    };</td></tr>
<tr class="codeline" data-linenumber="821"><td class="num" id="LN821">821</td><td class="line">    <span class='keyword'>if</span> (commandTable-&gt;type != <span class='macro'>REDIS_REPLY_MAP<span class='macro_popup'>9</span></span> &amp;&amp; commandTable-&gt;type != <span class='macro'>REDIS_REPLY_ARRAY<span class='macro_popup'>2</span></span>) <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="822"><td class="num" id="LN822">822</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="823"><td class="num" id="LN823">823</td><td class="line">    <span class='comment'>/* Scan the array reported by COMMAND DOCS and fill in the entries */</span></td></tr>
<tr class="codeline" data-linenumber="824"><td class="num" id="LN824">824</td><td class="line">    helpEntriesLen = cliCountCommands(commandTable);</td></tr>
<tr class="codeline" data-linenumber="825"><td class="num" id="LN825">825</td><td class="line">    helpEntries = zmalloc(<span class='keyword'>sizeof</span>(helpEntry)*helpEntriesLen);</td></tr>
<tr class="codeline" data-linenumber="826"><td class="num" id="LN826">826</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="827"><td class="num" id="LN827">827</td><td class="line">    groups = dictCreate(&amp;groupsdt);</td></tr>
<tr class="codeline" data-linenumber="828"><td class="num" id="LN828">828</td><td class="line">    cliInitCommandHelpEntries(commandTable, groups);</td></tr>
<tr class="codeline" data-linenumber="829"><td class="num" id="LN829">829</td><td class="line">    cliInitGroupHelpEntries(groups);</td></tr>
<tr class="codeline" data-linenumber="830"><td class="num" id="LN830">830</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="831"><td class="num" id="LN831">831</td><td class="line">    qsort(helpEntries, helpEntriesLen, <span class='keyword'>sizeof</span>(helpEntry), helpEntryCompare);</td></tr>
<tr class="codeline" data-linenumber="832"><td class="num" id="LN832">832</td><td class="line">    freeReplyObject(commandTable);</td></tr>
<tr class="codeline" data-linenumber="833"><td class="num" id="LN833">833</td><td class="line">    dictRelease(groups);</td></tr>
<tr class="codeline" data-linenumber="834"><td class="num" id="LN834">834</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="835"><td class="num" id="LN835">835</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="836"><td class="num" id="LN836">836</td><td class="line"><span class='comment'>/* Output command help to stdout. */</span></td></tr>
<tr class="codeline" data-linenumber="837"><td class="num" id="LN837">837</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> cliOutputCommandHelp(<span class='keyword'>struct</span> commandDocs *help, <span class='keyword'>int</span> group) {</td></tr>
<tr class="codeline" data-linenumber="838"><td class="num" id="LN838">838</td><td class="line">    printf(<span class='string_literal'>"\r\n  \x1b[1m%s\x1b[0m \x1b[90m%s\x1b[0m\r\n"</span>, help-&gt;name, help-&gt;params);</td></tr>
<tr class="codeline" data-linenumber="839"><td class="num" id="LN839">839</td><td class="line">    printf(<span class='string_literal'>"  \x1b[33msummary:\x1b[0m %s\r\n"</span>, help-&gt;summary);</td></tr>
<tr class="codeline" data-linenumber="840"><td class="num" id="LN840">840</td><td class="line">    <span class='keyword'>if</span> (help-&gt;since != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="841"><td class="num" id="LN841">841</td><td class="line">        printf(<span class='string_literal'>"  \x1b[33msince:\x1b[0m %s\r\n"</span>, help-&gt;since);</td></tr>
<tr class="codeline" data-linenumber="842"><td class="num" id="LN842">842</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="843"><td class="num" id="LN843">843</td><td class="line">    <span class='keyword'>if</span> (group) {</td></tr>
<tr class="codeline" data-linenumber="844"><td class="num" id="LN844">844</td><td class="line">        printf(<span class='string_literal'>"  \x1b[33mgroup:\x1b[0m %s\r\n"</span>, help-&gt;group);</td></tr>
<tr class="codeline" data-linenumber="845"><td class="num" id="LN845">845</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="846"><td class="num" id="LN846">846</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="847"><td class="num" id="LN847">847</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="848"><td class="num" id="LN848">848</td><td class="line"><span class='comment'>/* Print generic help. */</span></td></tr>
<tr class="codeline" data-linenumber="849"><td class="num" id="LN849">849</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> cliOutputGenericHelp(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="850"><td class="num" id="LN850">850</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> version = cliVersion();</td></tr>
<tr class="codeline" data-linenumber="851"><td class="num" id="LN851">851</td><td class="line">    printf(</td></tr>
<tr class="codeline" data-linenumber="852"><td class="num" id="LN852">852</td><td class="line">        <span class='string_literal'>"redis-cli %s\n"</span></td></tr>
<tr class="codeline" data-linenumber="853"><td class="num" id="LN853">853</td><td class="line">        <span class='string_literal'>"To get help about Redis commands type:\n"</span></td></tr>
<tr class="codeline" data-linenumber="854"><td class="num" id="LN854">854</td><td class="line">        <span class='string_literal'>"      \"help @&lt;group&gt;\" to get a list of commands in &lt;group&gt;\n"</span></td></tr>
<tr class="codeline" data-linenumber="855"><td class="num" id="LN855">855</td><td class="line">        <span class='string_literal'>"      \"help &lt;command&gt;\" for help on &lt;command&gt;\n"</span></td></tr>
<tr class="codeline" data-linenumber="856"><td class="num" id="LN856">856</td><td class="line">        <span class='string_literal'>"      \"help &lt;tab&gt;\" to get a list of possible help topics\n"</span></td></tr>
<tr class="codeline" data-linenumber="857"><td class="num" id="LN857">857</td><td class="line">        <span class='string_literal'>"      \"quit\" to exit\n"</span></td></tr>
<tr class="codeline" data-linenumber="858"><td class="num" id="LN858">858</td><td class="line">        <span class='string_literal'>"\n"</span></td></tr>
<tr class="codeline" data-linenumber="859"><td class="num" id="LN859">859</td><td class="line">        <span class='string_literal'>"To set redis-cli preferences:\n"</span></td></tr>
<tr class="codeline" data-linenumber="860"><td class="num" id="LN860">860</td><td class="line">        <span class='string_literal'>"      \":set hints\" enable online hints\n"</span></td></tr>
<tr class="codeline" data-linenumber="861"><td class="num" id="LN861">861</td><td class="line">        <span class='string_literal'>"      \":set nohints\" disable online hints\n"</span></td></tr>
<tr class="codeline" data-linenumber="862"><td class="num" id="LN862">862</td><td class="line">        <span class='string_literal'>"Set your preferences in ~/.redisclirc\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="863"><td class="num" id="LN863">863</td><td class="line">        version</td></tr>
<tr class="codeline" data-linenumber="864"><td class="num" id="LN864">864</td><td class="line">    );</td></tr>
<tr class="codeline" data-linenumber="865"><td class="num" id="LN865">865</td><td class="line">    <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(version);</td></tr>
<tr class="codeline" data-linenumber="866"><td class="num" id="LN866">866</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="867"><td class="num" id="LN867">867</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="868"><td class="num" id="LN868">868</td><td class="line"><span class='comment'>/* Output all command help, filtering by group or command name. */</span></td></tr>
<tr class="codeline" data-linenumber="869"><td class="num" id="LN869">869</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> cliOutputHelp(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv) {</td></tr>
<tr class="codeline" data-linenumber="870"><td class="num" id="LN870">870</td><td class="line">    <span class='keyword'>int</span> i, j;</td></tr>
<tr class="codeline" data-linenumber="871"><td class="num" id="LN871">871</td><td class="line">    <span class='keyword'>char</span> *group = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="872"><td class="num" id="LN872">872</td><td class="line">    helpEntry *entry;</td></tr>
<tr class="codeline" data-linenumber="873"><td class="num" id="LN873">873</td><td class="line">    <span class='keyword'>struct</span> commandDocs *help;</td></tr>
<tr class="codeline" data-linenumber="874"><td class="num" id="LN874">874</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="875"><td class="num" id="LN875">875</td><td class="line">    <span class='keyword'>if</span> (argc == 0) {</td></tr>
<tr class="codeline" data-linenumber="876"><td class="num" id="LN876">876</td><td class="line">        cliOutputGenericHelp();</td></tr>
<tr class="codeline" data-linenumber="877"><td class="num" id="LN877">877</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="878"><td class="num" id="LN878">878</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (argc &gt; 0 &amp;&amp; argv[0][0] == '@') {</td></tr>
<tr class="codeline" data-linenumber="879"><td class="num" id="LN879">879</td><td class="line">        group = argv[0]+1;</td></tr>
<tr class="codeline" data-linenumber="880"><td class="num" id="LN880">880</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="881"><td class="num" id="LN881">881</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="882"><td class="num" id="LN882">882</td><td class="line">    <span class='keyword'>if</span> (helpEntries == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="883"><td class="num" id="LN883">883</td><td class="line">        <span class='comment'>/* Initialize the help using the results of the COMMAND command.</span></td></tr>
<tr class="codeline" data-linenumber="884"><td class="num" id="LN884">884</td><td class="line">         <span class='comment'>* In case we are using redis-cli help XXX, we need to init it. */</span></td></tr>
<tr class="codeline" data-linenumber="885"><td class="num" id="LN885">885</td><td class="line">        cliInitHelp();</td></tr>
<tr class="codeline" data-linenumber="886"><td class="num" id="LN886">886</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="887"><td class="num" id="LN887">887</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="888"><td class="num" id="LN888">888</td><td class="line">    <span class='macro'>assert(argc &gt; 0)<span class='macro_popup'>((argc &gt; 0) ? (void) (0) : __assert_fail ("argc &gt; 0", "redis-cli.c"<br>, 888, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="889"><td class="num" id="LN889">889</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; helpEntriesLen; i++) {</td></tr>
<tr class="codeline" data-linenumber="890"><td class="num" id="LN890">890</td><td class="line">        entry = &amp;helpEntries[i];</td></tr>
<tr class="codeline" data-linenumber="891"><td class="num" id="LN891">891</td><td class="line">        <span class='keyword'>if</span> (entry-&gt;type != <span class='macro'>CLI_HELP_COMMAND<span class='macro_popup'>1</span></span>) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="892"><td class="num" id="LN892">892</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="893"><td class="num" id="LN893">893</td><td class="line">        help = &amp;entry-&gt;org;</td></tr>
<tr class="codeline" data-linenumber="894"><td class="num" id="LN894">894</td><td class="line">        <span class='keyword'>if</span> (group == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="895"><td class="num" id="LN895">895</td><td class="line">            <span class='comment'>/* Compare all arguments */</span></td></tr>
<tr class="codeline" data-linenumber="896"><td class="num" id="LN896">896</td><td class="line">            <span class='keyword'>if</span> (argc &lt;= entry-&gt;argc) {</td></tr>
<tr class="codeline" data-linenumber="897"><td class="num" id="LN897">897</td><td class="line">                <span class='keyword'>for</span> (j = 0; j &lt; argc; j++) {</td></tr>
<tr class="codeline" data-linenumber="898"><td class="num" id="LN898">898</td><td class="line">                    <span class='keyword'>if</span> (strcasecmp(argv[j],entry-&gt;argv[j]) != 0) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="899"><td class="num" id="LN899">899</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="900"><td class="num" id="LN900">900</td><td class="line">                <span class='keyword'>if</span> (j == argc) {</td></tr>
<tr class="codeline" data-linenumber="901"><td class="num" id="LN901">901</td><td class="line">                    cliOutputCommandHelp(help,1);</td></tr>
<tr class="codeline" data-linenumber="902"><td class="num" id="LN902">902</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="903"><td class="num" id="LN903">903</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="904"><td class="num" id="LN904">904</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (strcasecmp(group, help-&gt;group) == 0) {</td></tr>
<tr class="codeline" data-linenumber="905"><td class="num" id="LN905">905</td><td class="line">            cliOutputCommandHelp(help,0);</td></tr>
<tr class="codeline" data-linenumber="906"><td class="num" id="LN906">906</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="907"><td class="num" id="LN907">907</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="908"><td class="num" id="LN908">908</td><td class="line">    printf(<span class='string_literal'>"\r\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="909"><td class="num" id="LN909">909</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="910"><td class="num" id="LN910">910</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="911"><td class="num" id="LN911">911</td><td class="line"><span class='comment'>/* Linenoise completion callback. */</span></td></tr>
<tr class="codeline" data-linenumber="912"><td class="num" id="LN912">912</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> completionCallback(<span class='keyword'>const</span> <span class='keyword'>char</span> *buf, linenoiseCompletions *lc) {</td></tr>
<tr class="codeline" data-linenumber="913"><td class="num" id="LN913">913</td><td class="line">    size_t startpos = 0;</td></tr>
<tr class="codeline" data-linenumber="914"><td class="num" id="LN914">914</td><td class="line">    <span class='keyword'>int</span> mask;</td></tr>
<tr class="codeline" data-linenumber="915"><td class="num" id="LN915">915</td><td class="line">    <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="916"><td class="num" id="LN916">916</td><td class="line">    size_t matchlen;</td></tr>
<tr class="codeline" data-linenumber="917"><td class="num" id="LN917">917</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> tmp;</td></tr>
<tr class="codeline" data-linenumber="918"><td class="num" id="LN918">918</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="919"><td class="num" id="LN919">919</td><td class="line">    <span class='keyword'>if</span> (strncasecmp(buf,<span class='string_literal'>"help "</span>,5) == 0) {</td></tr>
<tr class="codeline" data-linenumber="920"><td class="num" id="LN920">920</td><td class="line">        startpos = 5;</td></tr>
<tr class="codeline" data-linenumber="921"><td class="num" id="LN921">921</td><td class="line">        <span class='keyword'>while</span> (<span class='macro'>isspace(buf[startpos])<span class='macro_popup'>((*__ctype_b_loc ())[(int) ((buf[startpos]))] &amp; (unsigned<br> short int) _ISspace)</span></span>) startpos++;</td></tr>
<tr class="codeline" data-linenumber="922"><td class="num" id="LN922">922</td><td class="line">        mask = <span class='macro'>CLI_HELP_COMMAND<span class='macro_popup'>1</span></span> | <span class='macro'>CLI_HELP_GROUP<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="923"><td class="num" id="LN923">923</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="924"><td class="num" id="LN924">924</td><td class="line">        mask = <span class='macro'>CLI_HELP_COMMAND<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="925"><td class="num" id="LN925">925</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="926"><td class="num" id="LN926">926</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="927"><td class="num" id="LN927">927</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; helpEntriesLen; i++) {</td></tr>
<tr class="codeline" data-linenumber="928"><td class="num" id="LN928">928</td><td class="line">        <span class='keyword'>if</span> (!(helpEntries[i].type &amp; mask)) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="929"><td class="num" id="LN929">929</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="930"><td class="num" id="LN930">930</td><td class="line">        matchlen = strlen(buf+startpos);</td></tr>
<tr class="codeline" data-linenumber="931"><td class="num" id="LN931">931</td><td class="line">        <span class='keyword'>if</span> (strncasecmp(buf+startpos,helpEntries[i].full,matchlen) == 0) {</td></tr>
<tr class="codeline" data-linenumber="932"><td class="num" id="LN932">932</td><td class="line">            tmp = <span class='macro'>sdsnewlen<span class='macro_popup'>hi_sdsnewlen</span></span>(buf,startpos);</td></tr>
<tr class="codeline" data-linenumber="933"><td class="num" id="LN933">933</td><td class="line">            tmp = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(tmp,helpEntries[i].full);</td></tr>
<tr class="codeline" data-linenumber="934"><td class="num" id="LN934">934</td><td class="line">            linenoiseAddCompletion(lc,tmp);</td></tr>
<tr class="codeline" data-linenumber="935"><td class="num" id="LN935">935</td><td class="line">            <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(tmp);</td></tr>
<tr class="codeline" data-linenumber="936"><td class="num" id="LN936">936</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="937"><td class="num" id="LN937">937</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="938"><td class="num" id="LN938">938</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="939"><td class="num" id="LN939">939</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="940"><td class="num" id="LN940">940</td><td class="line"><span class='comment'>/* Linenoise hints callback. */</span></td></tr>
<tr class="codeline" data-linenumber="941"><td class="num" id="LN941">941</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>char</span> *hintsCallback(<span class='keyword'>const</span> <span class='keyword'>char</span> *buf, <span class='keyword'>int</span> *color, <span class='keyword'>int</span> *bold) {</td></tr>
<tr class="codeline" data-linenumber="942"><td class="num" id="LN942">942</td><td class="line">    <span class='keyword'>if</span> (!pref.hints) <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="943"><td class="num" id="LN943">943</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="944"><td class="num" id="LN944">944</td><td class="line">    <span class='keyword'>int</span> i, rawargc, argc, buflen = strlen(buf), matchlen = 0;</td></tr>
<tr class="codeline" data-linenumber="945"><td class="num" id="LN945">945</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> *rawargv, *argv = <span class='macro'>sdssplitargs<span class='macro_popup'>hi_sdssplitargs</span></span>(buf,&amp;argc);</td></tr>
<tr class="codeline" data-linenumber="946"><td class="num" id="LN946">946</td><td class="line">    <span class='keyword'>int</span> endspace = buflen &amp;&amp; <span class='macro'>isspace(buf[buflen-1])<span class='macro_popup'>((*__ctype_b_loc ())[(int) ((buf[buflen-1]))] &amp; (unsigned<br> short int) _ISspace)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="947"><td class="num" id="LN947">947</td><td class="line">    helpEntry *entry = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="948"><td class="num" id="LN948">948</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="949"><td class="num" id="LN949">949</td><td class="line">    <span class='comment'>/* Check if the argument list is empty and return ASAP. */</span></td></tr>
<tr class="codeline" data-linenumber="950"><td class="num" id="LN950">950</td><td class="line">    <span class='keyword'>if</span> (argc == 0) {</td></tr>
<tr class="codeline" data-linenumber="951"><td class="num" id="LN951">951</td><td class="line">        <span class='macro'>sdsfreesplitres<span class='macro_popup'>hi_sdsfreesplitres</span></span>(argv,argc);</td></tr>
<tr class="codeline" data-linenumber="952"><td class="num" id="LN952">952</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="953"><td class="num" id="LN953">953</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="954"><td class="num" id="LN954">954</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="955"><td class="num" id="LN955">955</td><td class="line">    <span class='comment'>/* Search longest matching prefix command */</span></td></tr>
<tr class="codeline" data-linenumber="956"><td class="num" id="LN956">956</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; helpEntriesLen; i++) {</td></tr>
<tr class="codeline" data-linenumber="957"><td class="num" id="LN957">957</td><td class="line">        <span class='keyword'>if</span> (!(helpEntries[i].type &amp; <span class='macro'>CLI_HELP_COMMAND<span class='macro_popup'>1</span></span>)) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="958"><td class="num" id="LN958">958</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="959"><td class="num" id="LN959">959</td><td class="line">        rawargv = <span class='macro'>sdssplitargs<span class='macro_popup'>hi_sdssplitargs</span></span>(helpEntries[i].full,&amp;rawargc);</td></tr>
<tr class="codeline" data-linenumber="960"><td class="num" id="LN960">960</td><td class="line">        <span class='keyword'>if</span> (rawargc &lt;= argc) {</td></tr>
<tr class="codeline" data-linenumber="961"><td class="num" id="LN961">961</td><td class="line">            <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="962"><td class="num" id="LN962">962</td><td class="line">            <span class='keyword'>for</span> (j = 0; j &lt; rawargc; j++) {</td></tr>
<tr class="codeline" data-linenumber="963"><td class="num" id="LN963">963</td><td class="line">                <span class='keyword'>if</span> (strcasecmp(rawargv[j],argv[j])) {</td></tr>
<tr class="codeline" data-linenumber="964"><td class="num" id="LN964">964</td><td class="line">                    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="965"><td class="num" id="LN965">965</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="966"><td class="num" id="LN966">966</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="967"><td class="num" id="LN967">967</td><td class="line">            <span class='keyword'>if</span> (j == rawargc &amp;&amp; rawargc &gt; matchlen) {</td></tr>
<tr class="codeline" data-linenumber="968"><td class="num" id="LN968">968</td><td class="line">                matchlen = rawargc;</td></tr>
<tr class="codeline" data-linenumber="969"><td class="num" id="LN969">969</td><td class="line">                entry = &amp;helpEntries[i];</td></tr>
<tr class="codeline" data-linenumber="970"><td class="num" id="LN970">970</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="971"><td class="num" id="LN971">971</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="972"><td class="num" id="LN972">972</td><td class="line">        <span class='macro'>sdsfreesplitres<span class='macro_popup'>hi_sdsfreesplitres</span></span>(rawargv,rawargc);</td></tr>
<tr class="codeline" data-linenumber="973"><td class="num" id="LN973">973</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="974"><td class="num" id="LN974">974</td><td class="line">    <span class='macro'>sdsfreesplitres<span class='macro_popup'>hi_sdsfreesplitres</span></span>(argv,argc);</td></tr>
<tr class="codeline" data-linenumber="975"><td class="num" id="LN975">975</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="976"><td class="num" id="LN976">976</td><td class="line">    <span class='keyword'>if</span> (entry) {</td></tr>
<tr class="codeline" data-linenumber="977"><td class="num" id="LN977">977</td><td class="line">        *color = 90;</td></tr>
<tr class="codeline" data-linenumber="978"><td class="num" id="LN978">978</td><td class="line">        *bold = 0;</td></tr>
<tr class="codeline" data-linenumber="979"><td class="num" id="LN979">979</td><td class="line">        <span class='macro'>sds<span class='macro_popup'>hisds</span></span> hint = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(entry-&gt;org.params);</td></tr>
<tr class="codeline" data-linenumber="980"><td class="num" id="LN980">980</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="981"><td class="num" id="LN981">981</td><td class="line">        <span class='comment'>/* Remove arguments from the returned hint to show only the</span></td></tr>
<tr class="codeline" data-linenumber="982"><td class="num" id="LN982">982</td><td class="line">            <span class='comment'>* ones the user did not yet type. */</span></td></tr>
<tr class="codeline" data-linenumber="983"><td class="num" id="LN983">983</td><td class="line">        <span class='keyword'>int</span> toremove = argc-matchlen;</td></tr>
<tr class="codeline" data-linenumber="984"><td class="num" id="LN984">984</td><td class="line">        <span class='keyword'>while</span>(toremove &gt; 0 &amp;&amp; <span class='macro'>sdslen<span class='macro_popup'>hi_sdslen</span></span>(hint)) {</td></tr>
<tr class="codeline" data-linenumber="985"><td class="num" id="LN985">985</td><td class="line">            <span class='keyword'>if</span> (hint[0] == '[') <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="986"><td class="num" id="LN986">986</td><td class="line">            <span class='keyword'>if</span> (hint[0] == ' ') toremove--;</td></tr>
<tr class="codeline" data-linenumber="987"><td class="num" id="LN987">987</td><td class="line">            <span class='macro'>sdsrange<span class='macro_popup'>hi_sdsrange</span></span>(hint,1,-1);</td></tr>
<tr class="codeline" data-linenumber="988"><td class="num" id="LN988">988</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="989"><td class="num" id="LN989">989</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="990"><td class="num" id="LN990">990</td><td class="line">        <span class='comment'>/* Add an initial space if needed. */</span></td></tr>
<tr class="codeline" data-linenumber="991"><td class="num" id="LN991">991</td><td class="line">        <span class='keyword'>if</span> (!endspace) {</td></tr>
<tr class="codeline" data-linenumber="992"><td class="num" id="LN992">992</td><td class="line">            <span class='macro'>sds<span class='macro_popup'>hisds</span></span> newhint = <span class='macro'>sdsnewlen<span class='macro_popup'>hi_sdsnewlen</span></span>(<span class='string_literal'>" "</span>,1);</td></tr>
<tr class="codeline" data-linenumber="993"><td class="num" id="LN993">993</td><td class="line">            newhint = <span class='macro'>sdscatsds<span class='macro_popup'>hi_sdscatsds</span></span>(newhint,hint);</td></tr>
<tr class="codeline" data-linenumber="994"><td class="num" id="LN994">994</td><td class="line">            <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(hint);</td></tr>
<tr class="codeline" data-linenumber="995"><td class="num" id="LN995">995</td><td class="line">            hint = newhint;</td></tr>
<tr class="codeline" data-linenumber="996"><td class="num" id="LN996">996</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="997"><td class="num" id="LN997">997</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="998"><td class="num" id="LN998">998</td><td class="line">        <span class='keyword'>return</span> hint;</td></tr>
<tr class="codeline" data-linenumber="999"><td class="num" id="LN999">999</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1000"><td class="num" id="LN1000">1000</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1001"><td class="num" id="LN1001">1001</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1002"><td class="num" id="LN1002">1002</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1003"><td class="num" id="LN1003">1003</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> freeHintsCallback(<span class='keyword'>void</span> *ptr) {</td></tr>
<tr class="codeline" data-linenumber="1004"><td class="num" id="LN1004">1004</td><td class="line">    <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(ptr);</td></tr>
<tr class="codeline" data-linenumber="1005"><td class="num" id="LN1005">1005</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1006"><td class="num" id="LN1006">1006</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1007"><td class="num" id="LN1007">1007</td><td class="line"><span class='comment'>/*------------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="1008"><td class="num" id="LN1008">1008</td><td class="line"> <span class='comment'>* Networking / parsing</span></td></tr>
<tr class="codeline" data-linenumber="1009"><td class="num" id="LN1009">1009</td><td class="line"> <span class='comment'>*--------------------------------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="1010"><td class="num" id="LN1010">1010</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1011"><td class="num" id="LN1011">1011</td><td class="line"><span class='comment'>/* Send AUTH command to the server */</span></td></tr>
<tr class="codeline" data-linenumber="1012"><td class="num" id="LN1012">1012</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> cliAuth(redisContext *ctx, <span class='keyword'>char</span> *user, <span class='keyword'>char</span> *auth) {</td></tr>
<tr class="codeline" data-linenumber="1013"><td class="num" id="LN1013">1013</td><td class="line">    redisReply *reply;</td></tr>
<tr class="codeline" data-linenumber="1014"><td class="num" id="LN1014">1014</td><td class="line">    <span class='keyword'>if</span> (auth == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>return</span> <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1015"><td class="num" id="LN1015">1015</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1016"><td class="num" id="LN1016">1016</td><td class="line">    <span class='keyword'>if</span> (user == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1017"><td class="num" id="LN1017">1017</td><td class="line">        reply = redisCommand(ctx,<span class='string_literal'>"AUTH %s"</span>,auth);</td></tr>
<tr class="codeline" data-linenumber="1018"><td class="num" id="LN1018">1018</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1019"><td class="num" id="LN1019">1019</td><td class="line">        reply = redisCommand(ctx,<span class='string_literal'>"AUTH %s %s"</span>,user,auth);</td></tr>
<tr class="codeline" data-linenumber="1020"><td class="num" id="LN1020">1020</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1021"><td class="num" id="LN1021">1021</td><td class="line">    <span class='keyword'>if</span> (reply == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1022"><td class="num" id="LN1022">1022</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"\nI/O error\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1023"><td class="num" id="LN1023">1023</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1024"><td class="num" id="LN1024">1024</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1025"><td class="num" id="LN1025">1025</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1026"><td class="num" id="LN1026">1026</td><td class="line">    <span class='keyword'>int</span> result = <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1027"><td class="num" id="LN1027">1027</td><td class="line">    <span class='keyword'>if</span> (reply-&gt;type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1028"><td class="num" id="LN1028">1028</td><td class="line">        result = <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1029"><td class="num" id="LN1029">1029</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"AUTH failed: %s\n"</span>, reply-&gt;str);</td></tr>
<tr class="codeline" data-linenumber="1030"><td class="num" id="LN1030">1030</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1031"><td class="num" id="LN1031">1031</td><td class="line">    freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="1032"><td class="num" id="LN1032">1032</td><td class="line">    <span class='keyword'>return</span> result;</td></tr>
<tr class="codeline" data-linenumber="1033"><td class="num" id="LN1033">1033</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1034"><td class="num" id="LN1034">1034</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1035"><td class="num" id="LN1035">1035</td><td class="line"><span class='comment'>/* Send SELECT input_dbnum to the server */</span></td></tr>
<tr class="codeline" data-linenumber="1036"><td class="num" id="LN1036">1036</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> cliSelect(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="1037"><td class="num" id="LN1037">1037</td><td class="line">    redisReply *reply;</td></tr>
<tr class="codeline" data-linenumber="1038"><td class="num" id="LN1038">1038</td><td class="line">    <span class='keyword'>if</span> (config.conn_info.input_dbnum == config.dbnum) <span class='keyword'>return</span> <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1039"><td class="num" id="LN1039">1039</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1040"><td class="num" id="LN1040">1040</td><td class="line">    reply = redisCommand(context,<span class='string_literal'>"SELECT %d"</span>,config.conn_info.input_dbnum);</td></tr>
<tr class="codeline" data-linenumber="1041"><td class="num" id="LN1041">1041</td><td class="line">    <span class='keyword'>if</span> (reply == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1042"><td class="num" id="LN1042">1042</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"\nI/O error\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1043"><td class="num" id="LN1043">1043</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1044"><td class="num" id="LN1044">1044</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1045"><td class="num" id="LN1045">1045</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1046"><td class="num" id="LN1046">1046</td><td class="line">    <span class='keyword'>int</span> result = <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1047"><td class="num" id="LN1047">1047</td><td class="line">    <span class='keyword'>if</span> (reply-&gt;type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1048"><td class="num" id="LN1048">1048</td><td class="line">        result = <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1049"><td class="num" id="LN1049">1049</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"SELECT %d failed: %s\n"</span>,config.conn_info.input_dbnum,reply-&gt;str);</td></tr>
<tr class="codeline" data-linenumber="1050"><td class="num" id="LN1050">1050</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1051"><td class="num" id="LN1051">1051</td><td class="line">        config.dbnum = config.conn_info.input_dbnum;</td></tr>
<tr class="codeline" data-linenumber="1052"><td class="num" id="LN1052">1052</td><td class="line">        cliRefreshPrompt();</td></tr>
<tr class="codeline" data-linenumber="1053"><td class="num" id="LN1053">1053</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1054"><td class="num" id="LN1054">1054</td><td class="line">    freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="1055"><td class="num" id="LN1055">1055</td><td class="line">    <span class='keyword'>return</span> result;</td></tr>
<tr class="codeline" data-linenumber="1056"><td class="num" id="LN1056">1056</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1057"><td class="num" id="LN1057">1057</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1058"><td class="num" id="LN1058">1058</td><td class="line"><span class='comment'>/* Select RESP3 mode if redis-cli was started with the -3 option.  */</span></td></tr>
<tr class="codeline" data-linenumber="1059"><td class="num" id="LN1059">1059</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> cliSwitchProto(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="1060"><td class="num" id="LN1060">1060</td><td class="line">    redisReply *reply;</td></tr>
<tr class="codeline" data-linenumber="1061"><td class="num" id="LN1061">1061</td><td class="line">    <span class='keyword'>if</span> (!config.resp3 || config.resp2) <span class='keyword'>return</span> <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1062"><td class="num" id="LN1062">1062</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1063"><td class="num" id="LN1063">1063</td><td class="line">    reply = redisCommand(context,<span class='string_literal'>"HELLO 3"</span>);</td></tr>
<tr class="codeline" data-linenumber="1064"><td class="num" id="LN1064">1064</td><td class="line">    <span class='keyword'>if</span> (reply == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1065"><td class="num" id="LN1065">1065</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"\nI/O error\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1066"><td class="num" id="LN1066">1066</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1067"><td class="num" id="LN1067">1067</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1068"><td class="num" id="LN1068">1068</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1069"><td class="num" id="LN1069">1069</td><td class="line">    <span class='keyword'>int</span> result = <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1070"><td class="num" id="LN1070">1070</td><td class="line">    <span class='keyword'>if</span> (reply-&gt;type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1071"><td class="num" id="LN1071">1071</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"HELLO 3 failed: %s\n"</span>,reply-&gt;str);</td></tr>
<tr class="codeline" data-linenumber="1072"><td class="num" id="LN1072">1072</td><td class="line">        <span class='keyword'>if</span> (config.resp3 == 1) {</td></tr>
<tr class="codeline" data-linenumber="1073"><td class="num" id="LN1073">1073</td><td class="line">            result = <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1074"><td class="num" id="LN1074">1074</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (config.resp3 == 2) {</td></tr>
<tr class="codeline" data-linenumber="1075"><td class="num" id="LN1075">1075</td><td class="line">            result = <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1076"><td class="num" id="LN1076">1076</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1077"><td class="num" id="LN1077">1077</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1078"><td class="num" id="LN1078">1078</td><td class="line">    freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="1079"><td class="num" id="LN1079">1079</td><td class="line">    <span class='keyword'>return</span> result;</td></tr>
<tr class="codeline" data-linenumber="1080"><td class="num" id="LN1080">1080</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1081"><td class="num" id="LN1081">1081</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1082"><td class="num" id="LN1082">1082</td><td class="line"><span class='comment'>/* Connect to the server. It is possible to pass certain flags to the function:</span></td></tr>
<tr class="codeline" data-linenumber="1083"><td class="num" id="LN1083">1083</td><td class="line"> <span class='comment'>*      CC_FORCE: The connection is performed even if there is already</span></td></tr>
<tr class="codeline" data-linenumber="1084"><td class="num" id="LN1084">1084</td><td class="line"> <span class='comment'>*                a connected socket.</span></td></tr>
<tr class="codeline" data-linenumber="1085"><td class="num" id="LN1085">1085</td><td class="line"> <span class='comment'>*      CC_QUIET: Don't print errors if connection fails. */</span></td></tr>
<tr class="codeline" data-linenumber="1086"><td class="num" id="LN1086">1086</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> cliConnect(<span class='keyword'>int</span> flags) {</td></tr>
<tr class="codeline" data-linenumber="1087"><td class="num" id="LN1087">1087</td><td class="line">    <span class='keyword'>if</span> (context == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> || flags &amp; <span class='macro'>CC_FORCE<span class='macro_popup'>(1&lt;&lt;0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1088"><td class="num" id="LN1088">1088</td><td class="line">        <span class='keyword'>if</span> (context != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1089"><td class="num" id="LN1089">1089</td><td class="line">            redisFree(context);</td></tr>
<tr class="codeline" data-linenumber="1090"><td class="num" id="LN1090">1090</td><td class="line">            config.dbnum = 0;</td></tr>
<tr class="codeline" data-linenumber="1091"><td class="num" id="LN1091">1091</td><td class="line">            config.in_multi = 0;</td></tr>
<tr class="codeline" data-linenumber="1092"><td class="num" id="LN1092">1092</td><td class="line">            cliRefreshPrompt();</td></tr>
<tr class="codeline" data-linenumber="1093"><td class="num" id="LN1093">1093</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1094"><td class="num" id="LN1094">1094</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1095"><td class="num" id="LN1095">1095</td><td class="line">        <span class='comment'>/* Do not use hostsocket when we got redirected in cluster mode */</span></td></tr>
<tr class="codeline" data-linenumber="1096"><td class="num" id="LN1096">1096</td><td class="line">        <span class='keyword'>if</span> (config.hostsocket == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> ||</td></tr>
<tr class="codeline" data-linenumber="1097"><td class="num" id="LN1097">1097</td><td class="line">            (config.cluster_mode &amp;&amp; config.cluster_reissue_command)) {</td></tr>
<tr class="codeline" data-linenumber="1098"><td class="num" id="LN1098">1098</td><td class="line">            context = redisConnect(config.conn_info.hostip,config.conn_info.hostport);</td></tr>
<tr class="codeline" data-linenumber="1099"><td class="num" id="LN1099">1099</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1100"><td class="num" id="LN1100">1100</td><td class="line">            context = redisConnectUnix(config.hostsocket);</td></tr>
<tr class="codeline" data-linenumber="1101"><td class="num" id="LN1101">1101</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1102"><td class="num" id="LN1102">1102</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1103"><td class="num" id="LN1103">1103</td><td class="line">        <span class='keyword'>if</span> (!context-&gt;err &amp;&amp; config.tls) {</td></tr>
<tr class="codeline" data-linenumber="1104"><td class="num" id="LN1104">1104</td><td class="line">            <span class='keyword'>const</span> <span class='keyword'>char</span> *err = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1105"><td class="num" id="LN1105">1105</td><td class="line">            <span class='keyword'>if</span> (cliSecureConnection(context, config.sslconfig, &amp;err) == <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span> &amp;&amp; err) {</td></tr>
<tr class="codeline" data-linenumber="1106"><td class="num" id="LN1106">1106</td><td class="line">                fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Could not negotiate a TLS connection: %s\n"</span>, err);</td></tr>
<tr class="codeline" data-linenumber="1107"><td class="num" id="LN1107">1107</td><td class="line">                redisFree(context);</td></tr>
<tr class="codeline" data-linenumber="1108"><td class="num" id="LN1108">1108</td><td class="line">                context = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1109"><td class="num" id="LN1109">1109</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1110"><td class="num" id="LN1110">1110</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1111"><td class="num" id="LN1111">1111</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1112"><td class="num" id="LN1112">1112</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1113"><td class="num" id="LN1113">1113</td><td class="line">        <span class='keyword'>if</span> (context-&gt;err) {</td></tr>
<tr class="codeline" data-linenumber="1114"><td class="num" id="LN1114">1114</td><td class="line">            <span class='keyword'>if</span> (!(flags &amp; <span class='macro'>CC_QUIET<span class='macro_popup'>(1&lt;&lt;1)</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="1115"><td class="num" id="LN1115">1115</td><td class="line">                fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"Could not connect to Redis at "</span>);</td></tr>
<tr class="codeline" data-linenumber="1116"><td class="num" id="LN1116">1116</td><td class="line">                <span class='keyword'>if</span> (config.hostsocket == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> ||</td></tr>
<tr class="codeline" data-linenumber="1117"><td class="num" id="LN1117">1117</td><td class="line">                    (config.cluster_mode &amp;&amp; config.cluster_reissue_command))</td></tr>
<tr class="codeline" data-linenumber="1118"><td class="num" id="LN1118">1118</td><td class="line">                {</td></tr>
<tr class="codeline" data-linenumber="1119"><td class="num" id="LN1119">1119</td><td class="line">                    fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"%s:%d: %s\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="1120"><td class="num" id="LN1120">1120</td><td class="line">                        config.conn_info.hostip,config.conn_info.hostport,context-&gt;errstr);</td></tr>
<tr class="codeline" data-linenumber="1121"><td class="num" id="LN1121">1121</td><td class="line">                } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1122"><td class="num" id="LN1122">1122</td><td class="line">                    fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"%s: %s\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="1123"><td class="num" id="LN1123">1123</td><td class="line">                        config.hostsocket,context-&gt;errstr);</td></tr>
<tr class="codeline" data-linenumber="1124"><td class="num" id="LN1124">1124</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="1125"><td class="num" id="LN1125">1125</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1126"><td class="num" id="LN1126">1126</td><td class="line">            redisFree(context);</td></tr>
<tr class="codeline" data-linenumber="1127"><td class="num" id="LN1127">1127</td><td class="line">            context = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1128"><td class="num" id="LN1128">1128</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1129"><td class="num" id="LN1129">1129</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1130"><td class="num" id="LN1130">1130</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1131"><td class="num" id="LN1131">1131</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1132"><td class="num" id="LN1132">1132</td><td class="line">        <span class='comment'>/* Set aggressive KEEP_ALIVE socket option in the Redis context socket</span></td></tr>
<tr class="codeline" data-linenumber="1133"><td class="num" id="LN1133">1133</td><td class="line">         <span class='comment'>* in order to prevent timeouts caused by the execution of long</span></td></tr>
<tr class="codeline" data-linenumber="1134"><td class="num" id="LN1134">1134</td><td class="line">         <span class='comment'>* commands. At the same time this improves the detection of real</span></td></tr>
<tr class="codeline" data-linenumber="1135"><td class="num" id="LN1135">1135</td><td class="line">         <span class='comment'>* errors. */</span></td></tr>
<tr class="codeline" data-linenumber="1136"><td class="num" id="LN1136">1136</td><td class="line">        anetKeepAlive(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, context-&gt;fd, <span class='macro'>REDIS_CLI_KEEPALIVE_INTERVAL<span class='macro_popup'>15</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1137"><td class="num" id="LN1137">1137</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1138"><td class="num" id="LN1138">1138</td><td class="line">        <span class='comment'>/* Do AUTH, select the right DB, switch to RESP3 if needed. */</span></td></tr>
<tr class="codeline" data-linenumber="1139"><td class="num" id="LN1139">1139</td><td class="line">        <span class='keyword'>if</span> (cliAuth(context, config.conn_info.user, config.conn_info.auth) != <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1140"><td class="num" id="LN1140">1140</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1141"><td class="num" id="LN1141">1141</td><td class="line">        <span class='keyword'>if</span> (cliSelect() != <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1142"><td class="num" id="LN1142">1142</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1143"><td class="num" id="LN1143">1143</td><td class="line">        <span class='keyword'>if</span> (cliSwitchProto() != <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1144"><td class="num" id="LN1144">1144</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1145"><td class="num" id="LN1145">1145</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1146"><td class="num" id="LN1146">1146</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1147"><td class="num" id="LN1147">1147</td><td class="line">    <span class='comment'>/* Set a PUSH handler if configured to do so. */</span></td></tr>
<tr class="codeline" data-linenumber="1148"><td class="num" id="LN1148">1148</td><td class="line">    <span class='keyword'>if</span> (config.push_output) {</td></tr>
<tr class="codeline" data-linenumber="1149"><td class="num" id="LN1149">1149</td><td class="line">        redisSetPushCallback(context, cliPushHandler);</td></tr>
<tr class="codeline" data-linenumber="1150"><td class="num" id="LN1150">1150</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1151"><td class="num" id="LN1151">1151</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1152"><td class="num" id="LN1152">1152</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1153"><td class="num" id="LN1153">1153</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1154"><td class="num" id="LN1154">1154</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1155"><td class="num" id="LN1155">1155</td><td class="line"><span class='comment'>/* In cluster, if server replies ASK, we will redirect to a different node.</span></td></tr>
<tr class="codeline" data-linenumber="1156"><td class="num" id="LN1156">1156</td><td class="line"> <span class='comment'>* Before sending the real command, we need to send ASKING command first. */</span></td></tr>
<tr class="codeline" data-linenumber="1157"><td class="num" id="LN1157">1157</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> cliSendAsking() {</td></tr>
<tr class="codeline" data-linenumber="1158"><td class="num" id="LN1158">1158</td><td class="line">    redisReply *reply;</td></tr>
<tr class="codeline" data-linenumber="1159"><td class="num" id="LN1159">1159</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1160"><td class="num" id="LN1160">1160</td><td class="line">    config.cluster_send_asking = 0;</td></tr>
<tr class="codeline" data-linenumber="1161"><td class="num" id="LN1161">1161</td><td class="line">    <span class='keyword'>if</span> (context == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1162"><td class="num" id="LN1162">1162</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1163"><td class="num" id="LN1163">1163</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1164"><td class="num" id="LN1164">1164</td><td class="line">    reply = redisCommand(context,<span class='string_literal'>"ASKING"</span>);</td></tr>
<tr class="codeline" data-linenumber="1165"><td class="num" id="LN1165">1165</td><td class="line">    <span class='keyword'>if</span> (reply == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1166"><td class="num" id="LN1166">1166</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"\nI/O error\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1167"><td class="num" id="LN1167">1167</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1168"><td class="num" id="LN1168">1168</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1169"><td class="num" id="LN1169">1169</td><td class="line">    <span class='keyword'>int</span> result = <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1170"><td class="num" id="LN1170">1170</td><td class="line">    <span class='keyword'>if</span> (reply-&gt;type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1171"><td class="num" id="LN1171">1171</td><td class="line">        result = <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1172"><td class="num" id="LN1172">1172</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"ASKING failed: %s\n"</span>,reply-&gt;str);</td></tr>
<tr class="codeline" data-linenumber="1173"><td class="num" id="LN1173">1173</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1174"><td class="num" id="LN1174">1174</td><td class="line">    freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="1175"><td class="num" id="LN1175">1175</td><td class="line">    <span class='keyword'>return</span> result;</td></tr>
<tr class="codeline" data-linenumber="1176"><td class="num" id="LN1176">1176</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1177"><td class="num" id="LN1177">1177</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1178"><td class="num" id="LN1178">1178</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> cliPrintContextError(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="1179"><td class="num" id="LN1179">1179</td><td class="line">    <span class='keyword'>if</span> (context == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1180"><td class="num" id="LN1180">1180</td><td class="line">    fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"Error: %s\n"</span>,context-&gt;errstr);</td></tr>
<tr class="codeline" data-linenumber="1181"><td class="num" id="LN1181">1181</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1182"><td class="num" id="LN1182">1182</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1183"><td class="num" id="LN1183">1183</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> isInvalidateReply(redisReply *reply) {</td></tr>
<tr class="codeline" data-linenumber="1184"><td class="num" id="LN1184">1184</td><td class="line">    <span class='keyword'>return</span> reply-&gt;type == <span class='macro'>REDIS_REPLY_PUSH<span class='macro_popup'>12</span></span> &amp;&amp; reply-&gt;elements == 2 &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1185"><td class="num" id="LN1185">1185</td><td class="line">        reply-&gt;element[0]-&gt;type == <span class='macro'>REDIS_REPLY_STRING<span class='macro_popup'>1</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1186"><td class="num" id="LN1186">1186</td><td class="line">        !strncmp(reply-&gt;element[0]-&gt;str, <span class='string_literal'>"invalidate"</span>, 10) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1187"><td class="num" id="LN1187">1187</td><td class="line">        reply-&gt;element[1]-&gt;type == <span class='macro'>REDIS_REPLY_ARRAY<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1188"><td class="num" id="LN1188">1188</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1189"><td class="num" id="LN1189">1189</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1190"><td class="num" id="LN1190">1190</td><td class="line"><span class='comment'>/* Special display handler for RESP3 'invalidate' messages.</span></td></tr>
<tr class="codeline" data-linenumber="1191"><td class="num" id="LN1191">1191</td><td class="line"> <span class='comment'>* This function does not validate the reply, so it should</span></td></tr>
<tr class="codeline" data-linenumber="1192"><td class="num" id="LN1192">1192</td><td class="line"> <span class='comment'>* already be confirmed correct */</span></td></tr>
<tr class="codeline" data-linenumber="1193"><td class="num" id="LN1193">1193</td><td class="line"><span class='keyword'>static</span> <span class='macro'>sds<span class='macro_popup'>hisds</span></span> cliFormatInvalidateTTY(redisReply *r) {</td></tr>
<tr class="codeline" data-linenumber="1194"><td class="num" id="LN1194">1194</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> out = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(<span class='string_literal'>"-&gt; invalidate: "</span>);</td></tr>
<tr class="codeline" data-linenumber="1195"><td class="num" id="LN1195">1195</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1196"><td class="num" id="LN1196">1196</td><td class="line">    <span class='keyword'>for</span> (size_t i = 0; i &lt; r-&gt;element[1]-&gt;elements; i++) {</td></tr>
<tr class="codeline" data-linenumber="1197"><td class="num" id="LN1197">1197</td><td class="line">        redisReply *key = r-&gt;element[1]-&gt;element[i];</td></tr>
<tr class="codeline" data-linenumber="1198"><td class="num" id="LN1198">1198</td><td class="line">        <span class='macro'>assert(key-&gt;type == REDIS_REPLY_STRING)<span class='macro_popup'>((key-&gt;type == 1) ? (void) (0) : __assert_fail ("key-&gt;type == REDIS_REPLY_STRING"<br>, "redis-cli.c", 1198, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1199"><td class="num" id="LN1199">1199</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1200"><td class="num" id="LN1200">1200</td><td class="line">        out = <span class='macro'>sdscatfmt<span class='macro_popup'>hi_sdscatfmt</span></span>(out, <span class='string_literal'>"'%s'"</span>, key-&gt;str, key-&gt;len);</td></tr>
<tr class="codeline" data-linenumber="1201"><td class="num" id="LN1201">1201</td><td class="line">        <span class='keyword'>if</span> (i &lt; r-&gt;element[1]-&gt;elements - 1)</td></tr>
<tr class="codeline" data-linenumber="1202"><td class="num" id="LN1202">1202</td><td class="line">            out = <span class='macro'>sdscatlen<span class='macro_popup'>hi_sdscatlen</span></span>(out, <span class='string_literal'>", "</span>, 2);</td></tr>
<tr class="codeline" data-linenumber="1203"><td class="num" id="LN1203">1203</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1204"><td class="num" id="LN1204">1204</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1205"><td class="num" id="LN1205">1205</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>sdscatlen<span class='macro_popup'>hi_sdscatlen</span></span>(out, <span class='string_literal'>"\n"</span>, 1);</td></tr>
<tr class="codeline" data-linenumber="1206"><td class="num" id="LN1206">1206</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1207"><td class="num" id="LN1207">1207</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1208"><td class="num" id="LN1208">1208</td><td class="line"><span class='comment'>/* Returns non-zero if cliFormatReplyTTY renders the reply in multiple lines. */</span></td></tr>
<tr class="codeline" data-linenumber="1209"><td class="num" id="LN1209">1209</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> cliIsMultilineValueTTY(redisReply *r) {</td></tr>
<tr class="codeline" data-linenumber="1210"><td class="num" id="LN1210">1210</td><td class="line">    <span class='keyword'>switch</span> (r-&gt;type) {</td></tr>
<tr class="codeline" data-linenumber="1211"><td class="num" id="LN1211">1211</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_ARRAY<span class='macro_popup'>2</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1212"><td class="num" id="LN1212">1212</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_SET<span class='macro_popup'>10</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1213"><td class="num" id="LN1213">1213</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_PUSH<span class='macro_popup'>12</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1214"><td class="num" id="LN1214">1214</td><td class="line">        <span class='keyword'>if</span> (r-&gt;elements == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1215"><td class="num" id="LN1215">1215</td><td class="line">        <span class='keyword'>if</span> (r-&gt;elements &gt; 1) <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1216"><td class="num" id="LN1216">1216</td><td class="line">        <span class='keyword'>return</span> cliIsMultilineValueTTY(r-&gt;element[0]);</td></tr>
<tr class="codeline" data-linenumber="1217"><td class="num" id="LN1217">1217</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_MAP<span class='macro_popup'>9</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1218"><td class="num" id="LN1218">1218</td><td class="line">        <span class='keyword'>if</span> (r-&gt;elements == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1219"><td class="num" id="LN1219">1219</td><td class="line">        <span class='keyword'>if</span> (r-&gt;elements &gt; 2) <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1220"><td class="num" id="LN1220">1220</td><td class="line">        <span class='keyword'>return</span> cliIsMultilineValueTTY(r-&gt;element[1]);</td></tr>
<tr class="codeline" data-linenumber="1221"><td class="num" id="LN1221">1221</td><td class="line">    <span class='keyword'>default</span>:</td></tr>
<tr class="codeline" data-linenumber="1222"><td class="num" id="LN1222">1222</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1223"><td class="num" id="LN1223">1223</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1224"><td class="num" id="LN1224">1224</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1225"><td class="num" id="LN1225">1225</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1226"><td class="num" id="LN1226">1226</td><td class="line"><span class='keyword'>static</span> <span class='macro'>sds<span class='macro_popup'>hisds</span></span> cliFormatReplyTTY(redisReply *r, <span class='keyword'>char</span> *prefix) {</td></tr>
<tr class="codeline" data-linenumber="1227"><td class="num" id="LN1227">1227</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> out = <span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>();</td></tr>
<tr class="codeline" data-linenumber="1228"><td class="num" id="LN1228">1228</td><td class="line">    <span class='keyword'>switch</span> (r-&gt;type) {</td></tr>
<tr class="codeline" data-linenumber="1229"><td class="num" id="LN1229">1229</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1230"><td class="num" id="LN1230">1230</td><td class="line">        out = <span class='macro'>sdscatprintf<span class='macro_popup'>hi_sdscatprintf</span></span>(out,<span class='string_literal'>"(error) %s\n"</span>, r-&gt;str);</td></tr>
<tr class="codeline" data-linenumber="1231"><td class="num" id="LN1231">1231</td><td class="line">    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1232"><td class="num" id="LN1232">1232</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_STATUS<span class='macro_popup'>5</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1233"><td class="num" id="LN1233">1233</td><td class="line">        out = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(out,r-&gt;str);</td></tr>
<tr class="codeline" data-linenumber="1234"><td class="num" id="LN1234">1234</td><td class="line">        out = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(out,<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1235"><td class="num" id="LN1235">1235</td><td class="line">    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1236"><td class="num" id="LN1236">1236</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_INTEGER<span class='macro_popup'>3</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1237"><td class="num" id="LN1237">1237</td><td class="line">        out = <span class='macro'>sdscatprintf<span class='macro_popup'>hi_sdscatprintf</span></span>(out,<span class='string_literal'>"(integer) %lld\n"</span>,r-&gt;integer);</td></tr>
<tr class="codeline" data-linenumber="1238"><td class="num" id="LN1238">1238</td><td class="line">    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1239"><td class="num" id="LN1239">1239</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_DOUBLE<span class='macro_popup'>7</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1240"><td class="num" id="LN1240">1240</td><td class="line">        out = <span class='macro'>sdscatprintf<span class='macro_popup'>hi_sdscatprintf</span></span>(out,<span class='string_literal'>"(double) %s\n"</span>,r-&gt;str);</td></tr>
<tr class="codeline" data-linenumber="1241"><td class="num" id="LN1241">1241</td><td class="line">    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1242"><td class="num" id="LN1242">1242</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_STRING<span class='macro_popup'>1</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1243"><td class="num" id="LN1243">1243</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_VERB<span class='macro_popup'>14</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1244"><td class="num" id="LN1244">1244</td><td class="line">        <span class='comment'>/* If you are producing output for the standard output we want</span></td></tr>
<tr class="codeline" data-linenumber="1245"><td class="num" id="LN1245">1245</td><td class="line">        <span class='comment'>* a more interesting output with quoted characters and so forth,</span></td></tr>
<tr class="codeline" data-linenumber="1246"><td class="num" id="LN1246">1246</td><td class="line">        <span class='comment'>* unless it's a verbatim string type. */</span></td></tr>
<tr class="codeline" data-linenumber="1247"><td class="num" id="LN1247">1247</td><td class="line">        <span class='keyword'>if</span> (r-&gt;type == <span class='macro'>REDIS_REPLY_STRING<span class='macro_popup'>1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1248"><td class="num" id="LN1248">1248</td><td class="line">            out = <span class='macro'>sdscatrepr<span class='macro_popup'>hi_sdscatrepr</span></span>(out,r-&gt;str,r-&gt;len);</td></tr>
<tr class="codeline" data-linenumber="1249"><td class="num" id="LN1249">1249</td><td class="line">            out = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(out,<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1250"><td class="num" id="LN1250">1250</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1251"><td class="num" id="LN1251">1251</td><td class="line">            out = <span class='macro'>sdscatlen<span class='macro_popup'>hi_sdscatlen</span></span>(out,r-&gt;str,r-&gt;len);</td></tr>
<tr class="codeline" data-linenumber="1252"><td class="num" id="LN1252">1252</td><td class="line">            out = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(out,<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1253"><td class="num" id="LN1253">1253</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1254"><td class="num" id="LN1254">1254</td><td class="line">    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1255"><td class="num" id="LN1255">1255</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_NIL<span class='macro_popup'>4</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1256"><td class="num" id="LN1256">1256</td><td class="line">        out = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(out,<span class='string_literal'>"(nil)\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1257"><td class="num" id="LN1257">1257</td><td class="line">    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1258"><td class="num" id="LN1258">1258</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_BOOL<span class='macro_popup'>8</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1259"><td class="num" id="LN1259">1259</td><td class="line">        out = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(out,r-&gt;integer ? <span class='string_literal'>"(true)\n"</span> : <span class='string_literal'>"(false)\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1260"><td class="num" id="LN1260">1260</td><td class="line">    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1261"><td class="num" id="LN1261">1261</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_ARRAY<span class='macro_popup'>2</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1262"><td class="num" id="LN1262">1262</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_MAP<span class='macro_popup'>9</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1263"><td class="num" id="LN1263">1263</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_SET<span class='macro_popup'>10</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1264"><td class="num" id="LN1264">1264</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_PUSH<span class='macro_popup'>12</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1265"><td class="num" id="LN1265">1265</td><td class="line">        <span class='keyword'>if</span> (r-&gt;elements == 0) {</td></tr>
<tr class="codeline" data-linenumber="1266"><td class="num" id="LN1266">1266</td><td class="line">            <span class='keyword'>if</span> (r-&gt;type == <span class='macro'>REDIS_REPLY_ARRAY<span class='macro_popup'>2</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1267"><td class="num" id="LN1267">1267</td><td class="line">                out = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(out,<span class='string_literal'>"(empty array)\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1268"><td class="num" id="LN1268">1268</td><td class="line">            <span class='keyword'>else</span> <span class='keyword'>if</span> (r-&gt;type == <span class='macro'>REDIS_REPLY_MAP<span class='macro_popup'>9</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1269"><td class="num" id="LN1269">1269</td><td class="line">                out = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(out,<span class='string_literal'>"(empty hash)\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1270"><td class="num" id="LN1270">1270</td><td class="line">            <span class='keyword'>else</span> <span class='keyword'>if</span> (r-&gt;type == <span class='macro'>REDIS_REPLY_SET<span class='macro_popup'>10</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1271"><td class="num" id="LN1271">1271</td><td class="line">                out = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(out,<span class='string_literal'>"(empty set)\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1272"><td class="num" id="LN1272">1272</td><td class="line">            <span class='keyword'>else</span> <span class='keyword'>if</span> (r-&gt;type == <span class='macro'>REDIS_REPLY_PUSH<span class='macro_popup'>12</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1273"><td class="num" id="LN1273">1273</td><td class="line">                out = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(out,<span class='string_literal'>"(empty push)\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1274"><td class="num" id="LN1274">1274</td><td class="line">            <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1275"><td class="num" id="LN1275">1275</td><td class="line">                out = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(out,<span class='string_literal'>"(empty aggregate type)\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1276"><td class="num" id="LN1276">1276</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1277"><td class="num" id="LN1277">1277</td><td class="line">            <span class='keyword'>unsigned</span> <span class='keyword'>int</span> i, idxlen = 0;</td></tr>
<tr class="codeline" data-linenumber="1278"><td class="num" id="LN1278">1278</td><td class="line">            <span class='keyword'>char</span> _prefixlen[16];</td></tr>
<tr class="codeline" data-linenumber="1279"><td class="num" id="LN1279">1279</td><td class="line">            <span class='keyword'>char</span> _prefixfmt[16];</td></tr>
<tr class="codeline" data-linenumber="1280"><td class="num" id="LN1280">1280</td><td class="line">            <span class='macro'>sds<span class='macro_popup'>hisds</span></span> _prefix;</td></tr>
<tr class="codeline" data-linenumber="1281"><td class="num" id="LN1281">1281</td><td class="line">            <span class='macro'>sds<span class='macro_popup'>hisds</span></span> tmp;</td></tr>
<tr class="codeline" data-linenumber="1282"><td class="num" id="LN1282">1282</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1283"><td class="num" id="LN1283">1283</td><td class="line">            <span class='comment'>/* Calculate chars needed to represent the largest index */</span></td></tr>
<tr class="codeline" data-linenumber="1284"><td class="num" id="LN1284">1284</td><td class="line">            i = r-&gt;elements;</td></tr>
<tr class="codeline" data-linenumber="1285"><td class="num" id="LN1285">1285</td><td class="line">            <span class='keyword'>if</span> (r-&gt;type == <span class='macro'>REDIS_REPLY_MAP<span class='macro_popup'>9</span></span>) i /= 2;</td></tr>
<tr class="codeline" data-linenumber="1286"><td class="num" id="LN1286">1286</td><td class="line">            <span class='keyword'>do</span> {</td></tr>
<tr class="codeline" data-linenumber="1287"><td class="num" id="LN1287">1287</td><td class="line">                idxlen++;</td></tr>
<tr class="codeline" data-linenumber="1288"><td class="num" id="LN1288">1288</td><td class="line">                i /= 10;</td></tr>
<tr class="codeline" data-linenumber="1289"><td class="num" id="LN1289">1289</td><td class="line">            } <span class='keyword'>while</span>(i);</td></tr>
<tr class="codeline" data-linenumber="1290"><td class="num" id="LN1290">1290</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1291"><td class="num" id="LN1291">1291</td><td class="line">            <span class='comment'>/* Prefix for nested multi bulks should grow with idxlen+2 spaces */</span></td></tr>
<tr class="codeline" data-linenumber="1292"><td class="num" id="LN1292">1292</td><td class="line">            memset(_prefixlen,' ',idxlen+2);</td></tr>
<tr class="codeline" data-linenumber="1293"><td class="num" id="LN1293">1293</td><td class="line">            _prefixlen[idxlen+2] = '\0';</td></tr>
<tr class="codeline" data-linenumber="1294"><td class="num" id="LN1294">1294</td><td class="line">            _prefix = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(<span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(prefix),_prefixlen);</td></tr>
<tr class="codeline" data-linenumber="1295"><td class="num" id="LN1295">1295</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1296"><td class="num" id="LN1296">1296</td><td class="line">            <span class='comment'>/* Setup prefix format for every entry */</span></td></tr>
<tr class="codeline" data-linenumber="1297"><td class="num" id="LN1297">1297</td><td class="line">            <span class='keyword'>char</span> numsep;</td></tr>
<tr class="codeline" data-linenumber="1298"><td class="num" id="LN1298">1298</td><td class="line">            <span class='keyword'>if</span> (r-&gt;type == <span class='macro'>REDIS_REPLY_SET<span class='macro_popup'>10</span></span>) numsep = '~';</td></tr>
<tr class="codeline" data-linenumber="1299"><td class="num" id="LN1299">1299</td><td class="line">            <span class='keyword'>else</span> <span class='keyword'>if</span> (r-&gt;type == <span class='macro'>REDIS_REPLY_MAP<span class='macro_popup'>9</span></span>) numsep = '#';</td></tr>
<tr class="codeline" data-linenumber="1300"><td class="num" id="LN1300">1300</td><td class="line">            <span class='keyword'>else</span> numsep = ')';</td></tr>
<tr class="codeline" data-linenumber="1301"><td class="num" id="LN1301">1301</td><td class="line">            snprintf(_prefixfmt,<span class='keyword'>sizeof</span>(_prefixfmt),<span class='string_literal'>"%%s%%%ud%c "</span>,idxlen,numsep);</td></tr>
<tr class="codeline" data-linenumber="1302"><td class="num" id="LN1302">1302</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1303"><td class="num" id="LN1303">1303</td><td class="line">            <span class='keyword'>for</span> (i = 0; i &lt; r-&gt;elements; i++) {</td></tr>
<tr class="codeline" data-linenumber="1304"><td class="num" id="LN1304">1304</td><td class="line">                <span class='keyword'>unsigned</span> <span class='keyword'>int</span> human_idx = (r-&gt;type == <span class='macro'>REDIS_REPLY_MAP<span class='macro_popup'>9</span></span>) ?</td></tr>
<tr class="codeline" data-linenumber="1305"><td class="num" id="LN1305">1305</td><td class="line">                                         i/2 : i;</td></tr>
<tr class="codeline" data-linenumber="1306"><td class="num" id="LN1306">1306</td><td class="line">                human_idx++; <span class='comment'>/* Make it 1-based. */</span></td></tr>
<tr class="codeline" data-linenumber="1307"><td class="num" id="LN1307">1307</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1308"><td class="num" id="LN1308">1308</td><td class="line">                <span class='comment'>/* Don't use the prefix for the first element, as the parent</span></td></tr>
<tr class="codeline" data-linenumber="1309"><td class="num" id="LN1309">1309</td><td class="line">                 <span class='comment'>* caller already prepended the index number. */</span></td></tr>
<tr class="codeline" data-linenumber="1310"><td class="num" id="LN1310">1310</td><td class="line">                out = <span class='macro'>sdscatprintf<span class='macro_popup'>hi_sdscatprintf</span></span>(out,_prefixfmt,i == 0 ? <span class='string_literal'>""</span> : prefix,human_idx);</td></tr>
<tr class="codeline" data-linenumber="1311"><td class="num" id="LN1311">1311</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1312"><td class="num" id="LN1312">1312</td><td class="line">                <span class='comment'>/* Format the multi bulk entry */</span></td></tr>
<tr class="codeline" data-linenumber="1313"><td class="num" id="LN1313">1313</td><td class="line">                tmp = cliFormatReplyTTY(r-&gt;element[i],_prefix);</td></tr>
<tr class="codeline" data-linenumber="1314"><td class="num" id="LN1314">1314</td><td class="line">                out = <span class='macro'>sdscatlen<span class='macro_popup'>hi_sdscatlen</span></span>(out,tmp,<span class='macro'>sdslen<span class='macro_popup'>hi_sdslen</span></span>(tmp));</td></tr>
<tr class="codeline" data-linenumber="1315"><td class="num" id="LN1315">1315</td><td class="line">                <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(tmp);</td></tr>
<tr class="codeline" data-linenumber="1316"><td class="num" id="LN1316">1316</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1317"><td class="num" id="LN1317">1317</td><td class="line">                <span class='comment'>/* For maps, format the value as well. */</span></td></tr>
<tr class="codeline" data-linenumber="1318"><td class="num" id="LN1318">1318</td><td class="line">                <span class='keyword'>if</span> (r-&gt;type == <span class='macro'>REDIS_REPLY_MAP<span class='macro_popup'>9</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1319"><td class="num" id="LN1319">1319</td><td class="line">                    i++;</td></tr>
<tr class="codeline" data-linenumber="1320"><td class="num" id="LN1320">1320</td><td class="line">                    <span class='macro'>sdsrange<span class='macro_popup'>hi_sdsrange</span></span>(out,0,-2);</td></tr>
<tr class="codeline" data-linenumber="1321"><td class="num" id="LN1321">1321</td><td class="line">                    out = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(out,<span class='string_literal'>" =&gt; "</span>);</td></tr>
<tr class="codeline" data-linenumber="1322"><td class="num" id="LN1322">1322</td><td class="line">                    <span class='keyword'>if</span> (cliIsMultilineValueTTY(r-&gt;element[i])) {</td></tr>
<tr class="codeline" data-linenumber="1323"><td class="num" id="LN1323">1323</td><td class="line">                        <span class='comment'>/* linebreak before multiline value to fix alignment */</span></td></tr>
<tr class="codeline" data-linenumber="1324"><td class="num" id="LN1324">1324</td><td class="line">                        out = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(out, <span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1325"><td class="num" id="LN1325">1325</td><td class="line">                        out = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(out, _prefix);</td></tr>
<tr class="codeline" data-linenumber="1326"><td class="num" id="LN1326">1326</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="1327"><td class="num" id="LN1327">1327</td><td class="line">                    tmp = cliFormatReplyTTY(r-&gt;element[i],_prefix);</td></tr>
<tr class="codeline" data-linenumber="1328"><td class="num" id="LN1328">1328</td><td class="line">                    out = <span class='macro'>sdscatlen<span class='macro_popup'>hi_sdscatlen</span></span>(out,tmp,<span class='macro'>sdslen<span class='macro_popup'>hi_sdslen</span></span>(tmp));</td></tr>
<tr class="codeline" data-linenumber="1329"><td class="num" id="LN1329">1329</td><td class="line">                    <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(tmp);</td></tr>
<tr class="codeline" data-linenumber="1330"><td class="num" id="LN1330">1330</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="1331"><td class="num" id="LN1331">1331</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1332"><td class="num" id="LN1332">1332</td><td class="line">            <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(_prefix);</td></tr>
<tr class="codeline" data-linenumber="1333"><td class="num" id="LN1333">1333</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1334"><td class="num" id="LN1334">1334</td><td class="line">    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1335"><td class="num" id="LN1335">1335</td><td class="line">    <span class='keyword'>default</span>:</td></tr>
<tr class="codeline" data-linenumber="1336"><td class="num" id="LN1336">1336</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"Unknown reply type: %d\n"</span>, r-&gt;type);</td></tr>
<tr class="codeline" data-linenumber="1337"><td class="num" id="LN1337">1337</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="1338"><td class="num" id="LN1338">1338</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1339"><td class="num" id="LN1339">1339</td><td class="line">    <span class='keyword'>return</span> out;</td></tr>
<tr class="codeline" data-linenumber="1340"><td class="num" id="LN1340">1340</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1341"><td class="num" id="LN1341">1341</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1342"><td class="num" id="LN1342">1342</td><td class="line"><span class='keyword'>int</span> isColorTerm(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="1343"><td class="num" id="LN1343">1343</td><td class="line">    <span class='keyword'>char</span> *t = getenv(<span class='string_literal'>"TERM"</span>);</td></tr>
<tr class="codeline" data-linenumber="1344"><td class="num" id="LN1344">1344</td><td class="line">    <span class='keyword'>return</span> t != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> &amp;&amp; strstr(t,<span class='string_literal'>"xterm"</span>) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1345"><td class="num" id="LN1345">1345</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1346"><td class="num" id="LN1346">1346</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1347"><td class="num" id="LN1347">1347</td><td class="line"><span class='comment'>/* Helper function for sdsCatColorizedLdbReply() appending colorize strings</span></td></tr>
<tr class="codeline" data-linenumber="1348"><td class="num" id="LN1348">1348</td><td class="line"> <span class='comment'>* to an SDS string. */</span></td></tr>
<tr class="codeline" data-linenumber="1349"><td class="num" id="LN1349">1349</td><td class="line"><span class='macro'>sds<span class='macro_popup'>hisds</span></span> sdscatcolor(<span class='macro'>sds<span class='macro_popup'>hisds</span></span> o, <span class='keyword'>char</span> *s, size_t len, <span class='keyword'>char</span> *color) {</td></tr>
<tr class="codeline" data-linenumber="1350"><td class="num" id="LN1350">1350</td><td class="line">    <span class='keyword'>if</span> (!isColorTerm()) <span class='keyword'>return</span> <span class='macro'>sdscatlen<span class='macro_popup'>hi_sdscatlen</span></span>(o,s,len);</td></tr>
<tr class="codeline" data-linenumber="1351"><td class="num" id="LN1351">1351</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1352"><td class="num" id="LN1352">1352</td><td class="line">    <span class='keyword'>int</span> bold = strstr(color,<span class='string_literal'>"bold"</span>) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1353"><td class="num" id="LN1353">1353</td><td class="line">    <span class='keyword'>int</span> ccode = 37; <span class='comment'>/* Defaults to white. */</span></td></tr>
<tr class="codeline" data-linenumber="1354"><td class="num" id="LN1354">1354</td><td class="line">    <span class='keyword'>if</span> (strstr(color,<span class='string_literal'>"red"</span>)) ccode = 31;</td></tr>
<tr class="codeline" data-linenumber="1355"><td class="num" id="LN1355">1355</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (strstr(color,<span class='string_literal'>"green"</span>)) ccode = 32;</td></tr>
<tr class="codeline" data-linenumber="1356"><td class="num" id="LN1356">1356</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (strstr(color,<span class='string_literal'>"yellow"</span>)) ccode = 33;</td></tr>
<tr class="codeline" data-linenumber="1357"><td class="num" id="LN1357">1357</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (strstr(color,<span class='string_literal'>"blue"</span>)) ccode = 34;</td></tr>
<tr class="codeline" data-linenumber="1358"><td class="num" id="LN1358">1358</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (strstr(color,<span class='string_literal'>"magenta"</span>)) ccode = 35;</td></tr>
<tr class="codeline" data-linenumber="1359"><td class="num" id="LN1359">1359</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (strstr(color,<span class='string_literal'>"cyan"</span>)) ccode = 36;</td></tr>
<tr class="codeline" data-linenumber="1360"><td class="num" id="LN1360">1360</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (strstr(color,<span class='string_literal'>"white"</span>)) ccode = 37;</td></tr>
<tr class="codeline" data-linenumber="1361"><td class="num" id="LN1361">1361</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1362"><td class="num" id="LN1362">1362</td><td class="line">    o = <span class='macro'>sdscatfmt<span class='macro_popup'>hi_sdscatfmt</span></span>(o,<span class='string_literal'>"\033[%i;%i;49m"</span>,bold,ccode);</td></tr>
<tr class="codeline" data-linenumber="1363"><td class="num" id="LN1363">1363</td><td class="line">    o = <span class='macro'>sdscatlen<span class='macro_popup'>hi_sdscatlen</span></span>(o,s,len);</td></tr>
<tr class="codeline" data-linenumber="1364"><td class="num" id="LN1364">1364</td><td class="line">    o = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(o,<span class='string_literal'>"\033[0m"</span>);</td></tr>
<tr class="codeline" data-linenumber="1365"><td class="num" id="LN1365">1365</td><td class="line">    <span class='keyword'>return</span> o;</td></tr>
<tr class="codeline" data-linenumber="1366"><td class="num" id="LN1366">1366</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1367"><td class="num" id="LN1367">1367</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1368"><td class="num" id="LN1368">1368</td><td class="line"><span class='comment'>/* Colorize Lua debugger status replies according to the prefix they</span></td></tr>
<tr class="codeline" data-linenumber="1369"><td class="num" id="LN1369">1369</td><td class="line"> <span class='comment'>* have. */</span></td></tr>
<tr class="codeline" data-linenumber="1370"><td class="num" id="LN1370">1370</td><td class="line"><span class='macro'>sds<span class='macro_popup'>hisds</span></span> sdsCatColorizedLdbReply(<span class='macro'>sds<span class='macro_popup'>hisds</span></span> o, <span class='keyword'>char</span> *s, size_t len) {</td></tr>
<tr class="codeline" data-linenumber="1371"><td class="num" id="LN1371">1371</td><td class="line">    <span class='keyword'>char</span> *color = <span class='string_literal'>"white"</span>;</td></tr>
<tr class="codeline" data-linenumber="1372"><td class="num" id="LN1372">1372</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1373"><td class="num" id="LN1373">1373</td><td class="line">    <span class='keyword'>if</span> (strstr(s,<span class='string_literal'>"&lt;debug&gt;"</span>)) color = <span class='string_literal'>"bold"</span>;</td></tr>
<tr class="codeline" data-linenumber="1374"><td class="num" id="LN1374">1374</td><td class="line">    <span class='keyword'>if</span> (strstr(s,<span class='string_literal'>"&lt;redis&gt;"</span>)) color = <span class='string_literal'>"green"</span>;</td></tr>
<tr class="codeline" data-linenumber="1375"><td class="num" id="LN1375">1375</td><td class="line">    <span class='keyword'>if</span> (strstr(s,<span class='string_literal'>"&lt;reply&gt;"</span>)) color = <span class='string_literal'>"cyan"</span>;</td></tr>
<tr class="codeline" data-linenumber="1376"><td class="num" id="LN1376">1376</td><td class="line">    <span class='keyword'>if</span> (strstr(s,<span class='string_literal'>"&lt;error&gt;"</span>)) color = <span class='string_literal'>"red"</span>;</td></tr>
<tr class="codeline" data-linenumber="1377"><td class="num" id="LN1377">1377</td><td class="line">    <span class='keyword'>if</span> (strstr(s,<span class='string_literal'>"&lt;hint&gt;"</span>)) color = <span class='string_literal'>"bold"</span>;</td></tr>
<tr class="codeline" data-linenumber="1378"><td class="num" id="LN1378">1378</td><td class="line">    <span class='keyword'>if</span> (strstr(s,<span class='string_literal'>"&lt;value&gt;"</span>) || strstr(s,<span class='string_literal'>"&lt;retval&gt;"</span>)) color = <span class='string_literal'>"magenta"</span>;</td></tr>
<tr class="codeline" data-linenumber="1379"><td class="num" id="LN1379">1379</td><td class="line">    <span class='keyword'>if</span> (len &gt; 4 &amp;&amp; <span class='macro'>isdigit(s[3])<span class='macro_popup'>((*__ctype_b_loc ())[(int) ((s[3]))] &amp; (unsigned short int<br>) _ISdigit)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1380"><td class="num" id="LN1380">1380</td><td class="line">        <span class='keyword'>if</span> (s[1] == '&gt;') color = <span class='string_literal'>"yellow"</span>; <span class='comment'>/* Current line. */</span></td></tr>
<tr class="codeline" data-linenumber="1381"><td class="num" id="LN1381">1381</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (s[2] == '#') color = <span class='string_literal'>"bold"</span>; <span class='comment'>/* Break point. */</span></td></tr>
<tr class="codeline" data-linenumber="1382"><td class="num" id="LN1382">1382</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1383"><td class="num" id="LN1383">1383</td><td class="line">    <span class='keyword'>return</span> sdscatcolor(o,s,len,color);</td></tr>
<tr class="codeline" data-linenumber="1384"><td class="num" id="LN1384">1384</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1385"><td class="num" id="LN1385">1385</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1386"><td class="num" id="LN1386">1386</td><td class="line"><span class='keyword'>static</span> <span class='macro'>sds<span class='macro_popup'>hisds</span></span> cliFormatReplyRaw(redisReply *r) {</td></tr>
<tr class="codeline" data-linenumber="1387"><td class="num" id="LN1387">1387</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> out = <span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>(), tmp;</td></tr>
<tr class="codeline" data-linenumber="1388"><td class="num" id="LN1388">1388</td><td class="line">    size_t i;</td></tr>
<tr class="codeline" data-linenumber="1389"><td class="num" id="LN1389">1389</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1390"><td class="num" id="LN1390">1390</td><td class="line">    <span class='keyword'>switch</span> (r-&gt;type) {</td></tr>
<tr class="codeline" data-linenumber="1391"><td class="num" id="LN1391">1391</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_NIL<span class='macro_popup'>4</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1392"><td class="num" id="LN1392">1392</td><td class="line">        <span class='comment'>/* Nothing... */</span></td></tr>
<tr class="codeline" data-linenumber="1393"><td class="num" id="LN1393">1393</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1394"><td class="num" id="LN1394">1394</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1395"><td class="num" id="LN1395">1395</td><td class="line">        out = <span class='macro'>sdscatlen<span class='macro_popup'>hi_sdscatlen</span></span>(out,r-&gt;str,r-&gt;len);</td></tr>
<tr class="codeline" data-linenumber="1396"><td class="num" id="LN1396">1396</td><td class="line">        out = <span class='macro'>sdscatlen<span class='macro_popup'>hi_sdscatlen</span></span>(out,<span class='string_literal'>"\n"</span>,1);</td></tr>
<tr class="codeline" data-linenumber="1397"><td class="num" id="LN1397">1397</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1398"><td class="num" id="LN1398">1398</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_STATUS<span class='macro_popup'>5</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1399"><td class="num" id="LN1399">1399</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_STRING<span class='macro_popup'>1</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1400"><td class="num" id="LN1400">1400</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_VERB<span class='macro_popup'>14</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1401"><td class="num" id="LN1401">1401</td><td class="line">        <span class='keyword'>if</span> (r-&gt;type == <span class='macro'>REDIS_REPLY_STATUS<span class='macro_popup'>5</span></span> &amp;&amp; config.eval_ldb) {</td></tr>
<tr class="codeline" data-linenumber="1402"><td class="num" id="LN1402">1402</td><td class="line">            <span class='comment'>/* The Lua debugger replies with arrays of simple (status)</span></td></tr>
<tr class="codeline" data-linenumber="1403"><td class="num" id="LN1403">1403</td><td class="line">             <span class='comment'>* strings. We colorize the output for more fun if this</span></td></tr>
<tr class="codeline" data-linenumber="1404"><td class="num" id="LN1404">1404</td><td class="line">             <span class='comment'>* is a debugging session. */</span></td></tr>
<tr class="codeline" data-linenumber="1405"><td class="num" id="LN1405">1405</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1406"><td class="num" id="LN1406">1406</td><td class="line">            <span class='comment'>/* Detect the end of a debugging session. */</span></td></tr>
<tr class="codeline" data-linenumber="1407"><td class="num" id="LN1407">1407</td><td class="line">            <span class='keyword'>if</span> (strstr(r-&gt;str,<span class='string_literal'>"&lt;endsession&gt;"</span>) == r-&gt;str) {</td></tr>
<tr class="codeline" data-linenumber="1408"><td class="num" id="LN1408">1408</td><td class="line">                config.enable_ldb_on_eval = 0;</td></tr>
<tr class="codeline" data-linenumber="1409"><td class="num" id="LN1409">1409</td><td class="line">                config.eval_ldb = 0;</td></tr>
<tr class="codeline" data-linenumber="1410"><td class="num" id="LN1410">1410</td><td class="line">                config.eval_ldb_end = 1; <span class='comment'>/* Signal the caller session ended. */</span></td></tr>
<tr class="codeline" data-linenumber="1411"><td class="num" id="LN1411">1411</td><td class="line">                config.output = <span class='macro'>OUTPUT_STANDARD<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1412"><td class="num" id="LN1412">1412</td><td class="line">                cliRefreshPrompt();</td></tr>
<tr class="codeline" data-linenumber="1413"><td class="num" id="LN1413">1413</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1414"><td class="num" id="LN1414">1414</td><td class="line">                out = sdsCatColorizedLdbReply(out,r-&gt;str,r-&gt;len);</td></tr>
<tr class="codeline" data-linenumber="1415"><td class="num" id="LN1415">1415</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1416"><td class="num" id="LN1416">1416</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1417"><td class="num" id="LN1417">1417</td><td class="line">            out = <span class='macro'>sdscatlen<span class='macro_popup'>hi_sdscatlen</span></span>(out,r-&gt;str,r-&gt;len);</td></tr>
<tr class="codeline" data-linenumber="1418"><td class="num" id="LN1418">1418</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1419"><td class="num" id="LN1419">1419</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1420"><td class="num" id="LN1420">1420</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_BOOL<span class='macro_popup'>8</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1421"><td class="num" id="LN1421">1421</td><td class="line">        out = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(out,r-&gt;integer ? <span class='string_literal'>"(true)"</span> : <span class='string_literal'>"(false)"</span>);</td></tr>
<tr class="codeline" data-linenumber="1422"><td class="num" id="LN1422">1422</td><td class="line">    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1423"><td class="num" id="LN1423">1423</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_INTEGER<span class='macro_popup'>3</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1424"><td class="num" id="LN1424">1424</td><td class="line">        out = <span class='macro'>sdscatprintf<span class='macro_popup'>hi_sdscatprintf</span></span>(out,<span class='string_literal'>"%lld"</span>,r-&gt;integer);</td></tr>
<tr class="codeline" data-linenumber="1425"><td class="num" id="LN1425">1425</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1426"><td class="num" id="LN1426">1426</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_DOUBLE<span class='macro_popup'>7</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1427"><td class="num" id="LN1427">1427</td><td class="line">        out = <span class='macro'>sdscatprintf<span class='macro_popup'>hi_sdscatprintf</span></span>(out,<span class='string_literal'>"%s"</span>,r-&gt;str);</td></tr>
<tr class="codeline" data-linenumber="1428"><td class="num" id="LN1428">1428</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1429"><td class="num" id="LN1429">1429</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_SET<span class='macro_popup'>10</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1430"><td class="num" id="LN1430">1430</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_ARRAY<span class='macro_popup'>2</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1431"><td class="num" id="LN1431">1431</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_PUSH<span class='macro_popup'>12</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1432"><td class="num" id="LN1432">1432</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; r-&gt;elements; i++) {</td></tr>
<tr class="codeline" data-linenumber="1433"><td class="num" id="LN1433">1433</td><td class="line">            <span class='keyword'>if</span> (i &gt; 0) out = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(out,config.mb_delim);</td></tr>
<tr class="codeline" data-linenumber="1434"><td class="num" id="LN1434">1434</td><td class="line">            tmp = cliFormatReplyRaw(r-&gt;element[i]);</td></tr>
<tr class="codeline" data-linenumber="1435"><td class="num" id="LN1435">1435</td><td class="line">            out = <span class='macro'>sdscatlen<span class='macro_popup'>hi_sdscatlen</span></span>(out,tmp,<span class='macro'>sdslen<span class='macro_popup'>hi_sdslen</span></span>(tmp));</td></tr>
<tr class="codeline" data-linenumber="1436"><td class="num" id="LN1436">1436</td><td class="line">            <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(tmp);</td></tr>
<tr class="codeline" data-linenumber="1437"><td class="num" id="LN1437">1437</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1438"><td class="num" id="LN1438">1438</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1439"><td class="num" id="LN1439">1439</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_MAP<span class='macro_popup'>9</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1440"><td class="num" id="LN1440">1440</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; r-&gt;elements; i += 2) {</td></tr>
<tr class="codeline" data-linenumber="1441"><td class="num" id="LN1441">1441</td><td class="line">            <span class='keyword'>if</span> (i &gt; 0) out = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(out,config.mb_delim);</td></tr>
<tr class="codeline" data-linenumber="1442"><td class="num" id="LN1442">1442</td><td class="line">            tmp = cliFormatReplyRaw(r-&gt;element[i]);</td></tr>
<tr class="codeline" data-linenumber="1443"><td class="num" id="LN1443">1443</td><td class="line">            out = <span class='macro'>sdscatlen<span class='macro_popup'>hi_sdscatlen</span></span>(out,tmp,<span class='macro'>sdslen<span class='macro_popup'>hi_sdslen</span></span>(tmp));</td></tr>
<tr class="codeline" data-linenumber="1444"><td class="num" id="LN1444">1444</td><td class="line">            <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(tmp);</td></tr>
<tr class="codeline" data-linenumber="1445"><td class="num" id="LN1445">1445</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1446"><td class="num" id="LN1446">1446</td><td class="line">            out = <span class='macro'>sdscatlen<span class='macro_popup'>hi_sdscatlen</span></span>(out,<span class='string_literal'>" "</span>,1);</td></tr>
<tr class="codeline" data-linenumber="1447"><td class="num" id="LN1447">1447</td><td class="line">            tmp = cliFormatReplyRaw(r-&gt;element[i+1]);</td></tr>
<tr class="codeline" data-linenumber="1448"><td class="num" id="LN1448">1448</td><td class="line">            out = <span class='macro'>sdscatlen<span class='macro_popup'>hi_sdscatlen</span></span>(out,tmp,<span class='macro'>sdslen<span class='macro_popup'>hi_sdslen</span></span>(tmp));</td></tr>
<tr class="codeline" data-linenumber="1449"><td class="num" id="LN1449">1449</td><td class="line">            <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(tmp);</td></tr>
<tr class="codeline" data-linenumber="1450"><td class="num" id="LN1450">1450</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1451"><td class="num" id="LN1451">1451</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1452"><td class="num" id="LN1452">1452</td><td class="line">    <span class='keyword'>default</span>:</td></tr>
<tr class="codeline" data-linenumber="1453"><td class="num" id="LN1453">1453</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"Unknown reply type: %d\n"</span>, r-&gt;type);</td></tr>
<tr class="codeline" data-linenumber="1454"><td class="num" id="LN1454">1454</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="1455"><td class="num" id="LN1455">1455</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1456"><td class="num" id="LN1456">1456</td><td class="line">    <span class='keyword'>return</span> out;</td></tr>
<tr class="codeline" data-linenumber="1457"><td class="num" id="LN1457">1457</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1458"><td class="num" id="LN1458">1458</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1459"><td class="num" id="LN1459">1459</td><td class="line"><span class='keyword'>static</span> <span class='macro'>sds<span class='macro_popup'>hisds</span></span> cliFormatReplyCSV(redisReply *r) {</td></tr>
<tr class="codeline" data-linenumber="1460"><td class="num" id="LN1460">1460</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="1461"><td class="num" id="LN1461">1461</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1462"><td class="num" id="LN1462">1462</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> out = <span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>();</td></tr>
<tr class="codeline" data-linenumber="1463"><td class="num" id="LN1463">1463</td><td class="line">    <span class='keyword'>switch</span> (r-&gt;type) {</td></tr>
<tr class="codeline" data-linenumber="1464"><td class="num" id="LN1464">1464</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1465"><td class="num" id="LN1465">1465</td><td class="line">        out = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(out,<span class='string_literal'>"ERROR,"</span>);</td></tr>
<tr class="codeline" data-linenumber="1466"><td class="num" id="LN1466">1466</td><td class="line">        out = <span class='macro'>sdscatrepr<span class='macro_popup'>hi_sdscatrepr</span></span>(out,r-&gt;str,strlen(r-&gt;str));</td></tr>
<tr class="codeline" data-linenumber="1467"><td class="num" id="LN1467">1467</td><td class="line">    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1468"><td class="num" id="LN1468">1468</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_STATUS<span class='macro_popup'>5</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1469"><td class="num" id="LN1469">1469</td><td class="line">        out = <span class='macro'>sdscatrepr<span class='macro_popup'>hi_sdscatrepr</span></span>(out,r-&gt;str,r-&gt;len);</td></tr>
<tr class="codeline" data-linenumber="1470"><td class="num" id="LN1470">1470</td><td class="line">    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1471"><td class="num" id="LN1471">1471</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_INTEGER<span class='macro_popup'>3</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1472"><td class="num" id="LN1472">1472</td><td class="line">        out = <span class='macro'>sdscatprintf<span class='macro_popup'>hi_sdscatprintf</span></span>(out,<span class='string_literal'>"%lld"</span>,r-&gt;integer);</td></tr>
<tr class="codeline" data-linenumber="1473"><td class="num" id="LN1473">1473</td><td class="line">    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1474"><td class="num" id="LN1474">1474</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_DOUBLE<span class='macro_popup'>7</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1475"><td class="num" id="LN1475">1475</td><td class="line">        out = <span class='macro'>sdscatprintf<span class='macro_popup'>hi_sdscatprintf</span></span>(out,<span class='string_literal'>"%s"</span>,r-&gt;str);</td></tr>
<tr class="codeline" data-linenumber="1476"><td class="num" id="LN1476">1476</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1477"><td class="num" id="LN1477">1477</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_STRING<span class='macro_popup'>1</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1478"><td class="num" id="LN1478">1478</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_VERB<span class='macro_popup'>14</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1479"><td class="num" id="LN1479">1479</td><td class="line">        out = <span class='macro'>sdscatrepr<span class='macro_popup'>hi_sdscatrepr</span></span>(out,r-&gt;str,r-&gt;len);</td></tr>
<tr class="codeline" data-linenumber="1480"><td class="num" id="LN1480">1480</td><td class="line">    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1481"><td class="num" id="LN1481">1481</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_NIL<span class='macro_popup'>4</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1482"><td class="num" id="LN1482">1482</td><td class="line">        out = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(out,<span class='string_literal'>"NULL"</span>);</td></tr>
<tr class="codeline" data-linenumber="1483"><td class="num" id="LN1483">1483</td><td class="line">    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1484"><td class="num" id="LN1484">1484</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_BOOL<span class='macro_popup'>8</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1485"><td class="num" id="LN1485">1485</td><td class="line">        out = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(out,r-&gt;integer ? <span class='string_literal'>"true"</span> : <span class='string_literal'>"false"</span>);</td></tr>
<tr class="codeline" data-linenumber="1486"><td class="num" id="LN1486">1486</td><td class="line">    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1487"><td class="num" id="LN1487">1487</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_ARRAY<span class='macro_popup'>2</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1488"><td class="num" id="LN1488">1488</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_SET<span class='macro_popup'>10</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1489"><td class="num" id="LN1489">1489</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_PUSH<span class='macro_popup'>12</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1490"><td class="num" id="LN1490">1490</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_MAP<span class='macro_popup'>9</span></span>: <span class='comment'>/* CSV has no map type, just output flat list. */</span></td></tr>
<tr class="codeline" data-linenumber="1491"><td class="num" id="LN1491">1491</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; r-&gt;elements; i++) {</td></tr>
<tr class="codeline" data-linenumber="1492"><td class="num" id="LN1492">1492</td><td class="line">            <span class='macro'>sds<span class='macro_popup'>hisds</span></span> tmp = cliFormatReplyCSV(r-&gt;element[i]);</td></tr>
<tr class="codeline" data-linenumber="1493"><td class="num" id="LN1493">1493</td><td class="line">            out = <span class='macro'>sdscatlen<span class='macro_popup'>hi_sdscatlen</span></span>(out,tmp,<span class='macro'>sdslen<span class='macro_popup'>hi_sdslen</span></span>(tmp));</td></tr>
<tr class="codeline" data-linenumber="1494"><td class="num" id="LN1494">1494</td><td class="line">            <span class='keyword'>if</span> (i != r-&gt;elements-1) out = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(out,<span class='string_literal'>","</span>);</td></tr>
<tr class="codeline" data-linenumber="1495"><td class="num" id="LN1495">1495</td><td class="line">            <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(tmp);</td></tr>
<tr class="codeline" data-linenumber="1496"><td class="num" id="LN1496">1496</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1497"><td class="num" id="LN1497">1497</td><td class="line">    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1498"><td class="num" id="LN1498">1498</td><td class="line">    <span class='keyword'>default</span>:</td></tr>
<tr class="codeline" data-linenumber="1499"><td class="num" id="LN1499">1499</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"Unknown reply type: %d\n"</span>, r-&gt;type);</td></tr>
<tr class="codeline" data-linenumber="1500"><td class="num" id="LN1500">1500</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="1501"><td class="num" id="LN1501">1501</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1502"><td class="num" id="LN1502">1502</td><td class="line">    <span class='keyword'>return</span> out;</td></tr>
<tr class="codeline" data-linenumber="1503"><td class="num" id="LN1503">1503</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1504"><td class="num" id="LN1504">1504</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1505"><td class="num" id="LN1505">1505</td><td class="line"><span class='comment'>/* Append specified buffer to out and return it, using required JSON output</span></td></tr>
<tr class="codeline" data-linenumber="1506"><td class="num" id="LN1506">1506</td><td class="line"> <span class='comment'>* mode. */</span></td></tr>
<tr class="codeline" data-linenumber="1507"><td class="num" id="LN1507">1507</td><td class="line"><span class='keyword'>static</span> <span class='macro'>sds<span class='macro_popup'>hisds</span></span> jsonStringOutput(<span class='macro'>sds<span class='macro_popup'>hisds</span></span> out, <span class='keyword'>const</span> <span class='keyword'>char</span> *p, <span class='keyword'>int</span> len, <span class='keyword'>int</span> mode) {</td></tr>
<tr class="codeline" data-linenumber="1508"><td class="num" id="LN1508">1508</td><td class="line">    <span class='keyword'>if</span> (mode == <span class='macro'>OUTPUT_JSON<span class='macro_popup'>3</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1509"><td class="num" id="LN1509">1509</td><td class="line">        <span class='keyword'>return</span> escapeJsonString(out, p, len);</td></tr>
<tr class="codeline" data-linenumber="1510"><td class="num" id="LN1510">1510</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (mode == <span class='macro'>OUTPUT_QUOTED_JSON<span class='macro_popup'>4</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1511"><td class="num" id="LN1511">1511</td><td class="line">        <span class='comment'>/* Need to double-quote backslashes */</span></td></tr>
<tr class="codeline" data-linenumber="1512"><td class="num" id="LN1512">1512</td><td class="line">        <span class='macro'>sds<span class='macro_popup'>hisds</span></span> tmp = <span class='macro'>sdscatrepr<span class='macro_popup'>hi_sdscatrepr</span></span>(<span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>(), p, len);</td></tr>
<tr class="codeline" data-linenumber="1513"><td class="num" id="LN1513">1513</td><td class="line">        <span class='keyword'>int</span> tmplen = <span class='macro'>sdslen<span class='macro_popup'>hi_sdslen</span></span>(tmp);</td></tr>
<tr class="codeline" data-linenumber="1514"><td class="num" id="LN1514">1514</td><td class="line">        <span class='keyword'>char</span> *n = tmp;</td></tr>
<tr class="codeline" data-linenumber="1515"><td class="num" id="LN1515">1515</td><td class="line">        <span class='keyword'>while</span> (tmplen--) {</td></tr>
<tr class="codeline" data-linenumber="1516"><td class="num" id="LN1516">1516</td><td class="line">            <span class='keyword'>if</span> (*n == '\\') out = <span class='macro'>sdscatlen<span class='macro_popup'>hi_sdscatlen</span></span>(out, <span class='string_literal'>"\\\\"</span>, 2);</td></tr>
<tr class="codeline" data-linenumber="1517"><td class="num" id="LN1517">1517</td><td class="line">            <span class='keyword'>else</span> out = <span class='macro'>sdscatlen<span class='macro_popup'>hi_sdscatlen</span></span>(out, n, 1);</td></tr>
<tr class="codeline" data-linenumber="1518"><td class="num" id="LN1518">1518</td><td class="line">            n++;</td></tr>
<tr class="codeline" data-linenumber="1519"><td class="num" id="LN1519">1519</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1520"><td class="num" id="LN1520">1520</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1521"><td class="num" id="LN1521">1521</td><td class="line">        <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(tmp);</td></tr>
<tr class="codeline" data-linenumber="1522"><td class="num" id="LN1522">1522</td><td class="line">        <span class='keyword'>return</span> out;</td></tr>
<tr class="codeline" data-linenumber="1523"><td class="num" id="LN1523">1523</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1524"><td class="num" id="LN1524">1524</td><td class="line">        <span class='macro'>assert(0)<span class='macro_popup'>((0) ? (void) (0) : __assert_fail ("0", "redis-cli.c", 1524, __extension__<br> __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1525"><td class="num" id="LN1525">1525</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1526"><td class="num" id="LN1526">1526</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1527"><td class="num" id="LN1527">1527</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1528"><td class="num" id="LN1528">1528</td><td class="line"><span class='keyword'>static</span> <span class='macro'>sds<span class='macro_popup'>hisds</span></span> cliFormatReplyJson(<span class='macro'>sds<span class='macro_popup'>hisds</span></span> out, redisReply *r, <span class='keyword'>int</span> mode) {</td></tr>
<tr class="codeline" data-linenumber="1529"><td class="num" id="LN1529">1529</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="1530"><td class="num" id="LN1530">1530</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1531"><td class="num" id="LN1531">1531</td><td class="line">    <span class='keyword'>switch</span> (r-&gt;type) {</td></tr>
<tr class="codeline" data-linenumber="1532"><td class="num" id="LN1532">1532</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1533"><td class="num" id="LN1533">1533</td><td class="line">        out = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(out,<span class='string_literal'>"error:"</span>);</td></tr>
<tr class="codeline" data-linenumber="1534"><td class="num" id="LN1534">1534</td><td class="line">        out = jsonStringOutput(out,r-&gt;str,strlen(r-&gt;str),mode);</td></tr>
<tr class="codeline" data-linenumber="1535"><td class="num" id="LN1535">1535</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1536"><td class="num" id="LN1536">1536</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_STATUS<span class='macro_popup'>5</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1537"><td class="num" id="LN1537">1537</td><td class="line">        out = jsonStringOutput(out,r-&gt;str,r-&gt;len,mode);</td></tr>
<tr class="codeline" data-linenumber="1538"><td class="num" id="LN1538">1538</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1539"><td class="num" id="LN1539">1539</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_INTEGER<span class='macro_popup'>3</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1540"><td class="num" id="LN1540">1540</td><td class="line">        out = <span class='macro'>sdscatprintf<span class='macro_popup'>hi_sdscatprintf</span></span>(out,<span class='string_literal'>"%lld"</span>,r-&gt;integer);</td></tr>
<tr class="codeline" data-linenumber="1541"><td class="num" id="LN1541">1541</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1542"><td class="num" id="LN1542">1542</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_DOUBLE<span class='macro_popup'>7</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1543"><td class="num" id="LN1543">1543</td><td class="line">        out = <span class='macro'>sdscatprintf<span class='macro_popup'>hi_sdscatprintf</span></span>(out,<span class='string_literal'>"%s"</span>,r-&gt;str);</td></tr>
<tr class="codeline" data-linenumber="1544"><td class="num" id="LN1544">1544</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1545"><td class="num" id="LN1545">1545</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_STRING<span class='macro_popup'>1</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1546"><td class="num" id="LN1546">1546</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_VERB<span class='macro_popup'>14</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1547"><td class="num" id="LN1547">1547</td><td class="line">        out = jsonStringOutput(out,r-&gt;str,r-&gt;len,mode);</td></tr>
<tr class="codeline" data-linenumber="1548"><td class="num" id="LN1548">1548</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1549"><td class="num" id="LN1549">1549</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_NIL<span class='macro_popup'>4</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1550"><td class="num" id="LN1550">1550</td><td class="line">        out = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(out,<span class='string_literal'>"null"</span>);</td></tr>
<tr class="codeline" data-linenumber="1551"><td class="num" id="LN1551">1551</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1552"><td class="num" id="LN1552">1552</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_BOOL<span class='macro_popup'>8</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1553"><td class="num" id="LN1553">1553</td><td class="line">        out = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(out,r-&gt;integer ? <span class='string_literal'>"true"</span> : <span class='string_literal'>"false"</span>);</td></tr>
<tr class="codeline" data-linenumber="1554"><td class="num" id="LN1554">1554</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1555"><td class="num" id="LN1555">1555</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_ARRAY<span class='macro_popup'>2</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1556"><td class="num" id="LN1556">1556</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_SET<span class='macro_popup'>10</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1557"><td class="num" id="LN1557">1557</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_PUSH<span class='macro_popup'>12</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1558"><td class="num" id="LN1558">1558</td><td class="line">        out = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(out,<span class='string_literal'>"["</span>);</td></tr>
<tr class="codeline" data-linenumber="1559"><td class="num" id="LN1559">1559</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; r-&gt;elements; i++ ) {</td></tr>
<tr class="codeline" data-linenumber="1560"><td class="num" id="LN1560">1560</td><td class="line">            out = cliFormatReplyJson(out,r-&gt;element[i],mode);</td></tr>
<tr class="codeline" data-linenumber="1561"><td class="num" id="LN1561">1561</td><td class="line">            <span class='keyword'>if</span> (i != r-&gt;elements-1) out = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(out,<span class='string_literal'>","</span>);</td></tr>
<tr class="codeline" data-linenumber="1562"><td class="num" id="LN1562">1562</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1563"><td class="num" id="LN1563">1563</td><td class="line">        out = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(out,<span class='string_literal'>"]"</span>);</td></tr>
<tr class="codeline" data-linenumber="1564"><td class="num" id="LN1564">1564</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1565"><td class="num" id="LN1565">1565</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_MAP<span class='macro_popup'>9</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1566"><td class="num" id="LN1566">1566</td><td class="line">        out = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(out,<span class='string_literal'>"{"</span>);</td></tr>
<tr class="codeline" data-linenumber="1567"><td class="num" id="LN1567">1567</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; r-&gt;elements; i += 2) {</td></tr>
<tr class="codeline" data-linenumber="1568"><td class="num" id="LN1568">1568</td><td class="line">            redisReply *key = r-&gt;element[i];</td></tr>
<tr class="codeline" data-linenumber="1569"><td class="num" id="LN1569">1569</td><td class="line">            <span class='keyword'>if</span> (key-&gt;type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span> ||</td></tr>
<tr class="codeline" data-linenumber="1570"><td class="num" id="LN1570">1570</td><td class="line">                key-&gt;type == <span class='macro'>REDIS_REPLY_STATUS<span class='macro_popup'>5</span></span> ||</td></tr>
<tr class="codeline" data-linenumber="1571"><td class="num" id="LN1571">1571</td><td class="line">                key-&gt;type == <span class='macro'>REDIS_REPLY_STRING<span class='macro_popup'>1</span></span> ||</td></tr>
<tr class="codeline" data-linenumber="1572"><td class="num" id="LN1572">1572</td><td class="line">                key-&gt;type == <span class='macro'>REDIS_REPLY_VERB<span class='macro_popup'>14</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1573"><td class="num" id="LN1573">1573</td><td class="line">            {</td></tr>
<tr class="codeline" data-linenumber="1574"><td class="num" id="LN1574">1574</td><td class="line">                out = cliFormatReplyJson(out,key,mode);</td></tr>
<tr class="codeline" data-linenumber="1575"><td class="num" id="LN1575">1575</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1576"><td class="num" id="LN1576">1576</td><td class="line">                <span class='comment'>/* According to JSON spec, JSON map keys must be strings,</span></td></tr>
<tr class="codeline" data-linenumber="1577"><td class="num" id="LN1577">1577</td><td class="line">                 <span class='comment'>* and in RESP3, they can be other types.</span> </td></tr>
<tr class="codeline" data-linenumber="1578"><td class="num" id="LN1578">1578</td><td class="line">                 <span class='comment'>* The first one(cliFormatReplyJson) is to convert non string type to string</span></td></tr>
<tr class="codeline" data-linenumber="1579"><td class="num" id="LN1579">1579</td><td class="line">                 <span class='comment'>* The Second one(escapeJsonString) is to escape the converted string */</span></td></tr>
<tr class="codeline" data-linenumber="1580"><td class="num" id="LN1580">1580</td><td class="line">                <span class='macro'>sds<span class='macro_popup'>hisds</span></span> keystr = cliFormatReplyJson(<span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>(),key,mode);</td></tr>
<tr class="codeline" data-linenumber="1581"><td class="num" id="LN1581">1581</td><td class="line">                <span class='keyword'>if</span> (keystr[0] == '"') out = <span class='macro'>sdscatsds<span class='macro_popup'>hi_sdscatsds</span></span>(out,keystr);</td></tr>
<tr class="codeline" data-linenumber="1582"><td class="num" id="LN1582">1582</td><td class="line">                <span class='keyword'>else</span> out = <span class='macro'>sdscatfmt<span class='macro_popup'>hi_sdscatfmt</span></span>(out,<span class='string_literal'>"\"%S\""</span>,keystr);</td></tr>
<tr class="codeline" data-linenumber="1583"><td class="num" id="LN1583">1583</td><td class="line">                <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(keystr);</td></tr>
<tr class="codeline" data-linenumber="1584"><td class="num" id="LN1584">1584</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1585"><td class="num" id="LN1585">1585</td><td class="line">            out = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(out,<span class='string_literal'>":"</span>);</td></tr>
<tr class="codeline" data-linenumber="1586"><td class="num" id="LN1586">1586</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1587"><td class="num" id="LN1587">1587</td><td class="line">            out = cliFormatReplyJson(out,r-&gt;element[i+1],mode);</td></tr>
<tr class="codeline" data-linenumber="1588"><td class="num" id="LN1588">1588</td><td class="line">            <span class='keyword'>if</span> (i != r-&gt;elements-2) out = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(out,<span class='string_literal'>","</span>);</td></tr>
<tr class="codeline" data-linenumber="1589"><td class="num" id="LN1589">1589</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1590"><td class="num" id="LN1590">1590</td><td class="line">        out = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(out,<span class='string_literal'>"}"</span>);</td></tr>
<tr class="codeline" data-linenumber="1591"><td class="num" id="LN1591">1591</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1592"><td class="num" id="LN1592">1592</td><td class="line">    <span class='keyword'>default</span>:</td></tr>
<tr class="codeline" data-linenumber="1593"><td class="num" id="LN1593">1593</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"Unknown reply type: %d\n"</span>, r-&gt;type);</td></tr>
<tr class="codeline" data-linenumber="1594"><td class="num" id="LN1594">1594</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="1595"><td class="num" id="LN1595">1595</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1596"><td class="num" id="LN1596">1596</td><td class="line">    <span class='keyword'>return</span> out;</td></tr>
<tr class="codeline" data-linenumber="1597"><td class="num" id="LN1597">1597</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1598"><td class="num" id="LN1598">1598</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1599"><td class="num" id="LN1599">1599</td><td class="line"><span class='comment'>/* Generate reply strings in various output modes */</span></td></tr>
<tr class="codeline" data-linenumber="1600"><td class="num" id="LN1600">1600</td><td class="line"><span class='keyword'>static</span> <span class='macro'>sds<span class='macro_popup'>hisds</span></span> cliFormatReply(redisReply *reply, <span class='keyword'>int</span> mode, <span class='keyword'>int</span> verbatim) {</td></tr>
<tr class="codeline" data-linenumber="1601"><td class="num" id="LN1601">1601</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> out;</td></tr>
<tr class="codeline" data-linenumber="1602"><td class="num" id="LN1602">1602</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1603"><td class="num" id="LN1603">1603</td><td class="line">    <span class='keyword'>if</span> (verbatim) {</td></tr>
<tr class="codeline" data-linenumber="1604"><td class="num" id="LN1604">1604</td><td class="line">        out = cliFormatReplyRaw(reply);</td></tr>
<tr class="codeline" data-linenumber="1605"><td class="num" id="LN1605">1605</td><td class="line">    }  <span class='keyword'>else</span> <span class='keyword'>if</span> (mode == <span class='macro'>OUTPUT_STANDARD<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1606"><td class="num" id="LN1606">1606</td><td class="line">        out = cliFormatReplyTTY(reply, <span class='string_literal'>""</span>);</td></tr>
<tr class="codeline" data-linenumber="1607"><td class="num" id="LN1607">1607</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (mode == <span class='macro'>OUTPUT_RAW<span class='macro_popup'>1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1608"><td class="num" id="LN1608">1608</td><td class="line">        out = cliFormatReplyRaw(reply);</td></tr>
<tr class="codeline" data-linenumber="1609"><td class="num" id="LN1609">1609</td><td class="line">        out = <span class='macro'>sdscatsds<span class='macro_popup'>hi_sdscatsds</span></span>(out, config.cmd_delim);</td></tr>
<tr class="codeline" data-linenumber="1610"><td class="num" id="LN1610">1610</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (mode == <span class='macro'>OUTPUT_CSV<span class='macro_popup'>2</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1611"><td class="num" id="LN1611">1611</td><td class="line">        out = cliFormatReplyCSV(reply);</td></tr>
<tr class="codeline" data-linenumber="1612"><td class="num" id="LN1612">1612</td><td class="line">        out = <span class='macro'>sdscatlen<span class='macro_popup'>hi_sdscatlen</span></span>(out, <span class='string_literal'>"\n"</span>, 1);</td></tr>
<tr class="codeline" data-linenumber="1613"><td class="num" id="LN1613">1613</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (mode == <span class='macro'>OUTPUT_JSON<span class='macro_popup'>3</span></span> || mode == <span class='macro'>OUTPUT_QUOTED_JSON<span class='macro_popup'>4</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1614"><td class="num" id="LN1614">1614</td><td class="line">        out = cliFormatReplyJson(<span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>(), reply, mode);</td></tr>
<tr class="codeline" data-linenumber="1615"><td class="num" id="LN1615">1615</td><td class="line">        out = <span class='macro'>sdscatlen<span class='macro_popup'>hi_sdscatlen</span></span>(out, <span class='string_literal'>"\n"</span>, 1);</td></tr>
<tr class="codeline" data-linenumber="1616"><td class="num" id="LN1616">1616</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1617"><td class="num" id="LN1617">1617</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Error:  Unknown output encoding %d\n"</span>, mode);</td></tr>
<tr class="codeline" data-linenumber="1618"><td class="num" id="LN1618">1618</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="1619"><td class="num" id="LN1619">1619</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1620"><td class="num" id="LN1620">1620</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1621"><td class="num" id="LN1621">1621</td><td class="line">    <span class='keyword'>return</span> out;</td></tr>
<tr class="codeline" data-linenumber="1622"><td class="num" id="LN1622">1622</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1623"><td class="num" id="LN1623">1623</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1624"><td class="num" id="LN1624">1624</td><td class="line"><span class='comment'>/* Output any spontaneous PUSH reply we receive */</span></td></tr>
<tr class="codeline" data-linenumber="1625"><td class="num" id="LN1625">1625</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> cliPushHandler(<span class='keyword'>void</span> *privdata, <span class='keyword'>void</span> *reply) {</td></tr>
<tr class="codeline" data-linenumber="1626"><td class="num" id="LN1626">1626</td><td class="line">    <span class='macro'>UNUSED(privdata)<span class='macro_popup'>((void) privdata)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1627"><td class="num" id="LN1627">1627</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> out;</td></tr>
<tr class="codeline" data-linenumber="1628"><td class="num" id="LN1628">1628</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1629"><td class="num" id="LN1629">1629</td><td class="line">    <span class='keyword'>if</span> (config.output == <span class='macro'>OUTPUT_STANDARD<span class='macro_popup'>0</span></span> &amp;&amp; isInvalidateReply(reply)) {</td></tr>
<tr class="codeline" data-linenumber="1630"><td class="num" id="LN1630">1630</td><td class="line">        out = cliFormatInvalidateTTY(reply);</td></tr>
<tr class="codeline" data-linenumber="1631"><td class="num" id="LN1631">1631</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1632"><td class="num" id="LN1632">1632</td><td class="line">        out = cliFormatReply(reply, config.output, 0);</td></tr>
<tr class="codeline" data-linenumber="1633"><td class="num" id="LN1633">1633</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1634"><td class="num" id="LN1634">1634</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1635"><td class="num" id="LN1635">1635</td><td class="line">    fwrite(out, <span class='macro'>sdslen<span class='macro_popup'>hi_sdslen</span></span>(out), 1, <span class='macro'>stdout<span class='macro_popup'>stdout</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1636"><td class="num" id="LN1636">1636</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1637"><td class="num" id="LN1637">1637</td><td class="line">    freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="1638"><td class="num" id="LN1638">1638</td><td class="line">    <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(out);</td></tr>
<tr class="codeline" data-linenumber="1639"><td class="num" id="LN1639">1639</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1640"><td class="num" id="LN1640">1640</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1641"><td class="num" id="LN1641">1641</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> cliReadReply(<span class='keyword'>int</span> output_raw_strings) {</td></tr>
<tr class="codeline" data-linenumber="1642"><td class="num" id="LN1642">1642</td><td class="line">    <span class='keyword'>void</span> *_reply;</td></tr>
<tr class="codeline" data-linenumber="1643"><td class="num" id="LN1643">1643</td><td class="line">    redisReply *reply;</td></tr>
<tr class="codeline" data-linenumber="1644"><td class="num" id="LN1644">1644</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> out = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1645"><td class="num" id="LN1645">1645</td><td class="line">    <span class='keyword'>int</span> output = 1;</td></tr>
<tr class="codeline" data-linenumber="1646"><td class="num" id="LN1646">1646</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1647"><td class="num" id="LN1647">1647</td><td class="line">    <span class='keyword'>if</span> (redisGetReply(context,&amp;_reply) != <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1648"><td class="num" id="LN1648">1648</td><td class="line">        <span class='keyword'>if</span> (config.blocking_state_aborted) {</td></tr>
<tr class="codeline" data-linenumber="1649"><td class="num" id="LN1649">1649</td><td class="line">            config.blocking_state_aborted = 0;</td></tr>
<tr class="codeline" data-linenumber="1650"><td class="num" id="LN1650">1650</td><td class="line">            config.monitor_mode = 0;</td></tr>
<tr class="codeline" data-linenumber="1651"><td class="num" id="LN1651">1651</td><td class="line">            config.pubsub_mode = 0;</td></tr>
<tr class="codeline" data-linenumber="1652"><td class="num" id="LN1652">1652</td><td class="line">            <span class='keyword'>return</span> cliConnect(<span class='macro'>CC_FORCE<span class='macro_popup'>(1&lt;&lt;0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1653"><td class="num" id="LN1653">1653</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1654"><td class="num" id="LN1654">1654</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1655"><td class="num" id="LN1655">1655</td><td class="line">        <span class='keyword'>if</span> (config.shutdown) {</td></tr>
<tr class="codeline" data-linenumber="1656"><td class="num" id="LN1656">1656</td><td class="line">            redisFree(context);</td></tr>
<tr class="codeline" data-linenumber="1657"><td class="num" id="LN1657">1657</td><td class="line">            context = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1658"><td class="num" id="LN1658">1658</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1659"><td class="num" id="LN1659">1659</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1660"><td class="num" id="LN1660">1660</td><td class="line">        <span class='keyword'>if</span> (config.interactive) {</td></tr>
<tr class="codeline" data-linenumber="1661"><td class="num" id="LN1661">1661</td><td class="line">            <span class='comment'>/* Filter cases where we should reconnect */</span></td></tr>
<tr class="codeline" data-linenumber="1662"><td class="num" id="LN1662">1662</td><td class="line">            <span class='keyword'>if</span> (context-&gt;err == <span class='macro'>REDIS_ERR_IO<span class='macro_popup'>1</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1663"><td class="num" id="LN1663">1663</td><td class="line">                (<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span> == <span class='macro'>ECONNRESET<span class='macro_popup'>104</span></span> || <span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span> == <span class='macro'>EPIPE<span class='macro_popup'>32</span></span>))</td></tr>
<tr class="codeline" data-linenumber="1664"><td class="num" id="LN1664">1664</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1665"><td class="num" id="LN1665">1665</td><td class="line">            <span class='keyword'>if</span> (context-&gt;err == <span class='macro'>REDIS_ERR_EOF<span class='macro_popup'>3</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1666"><td class="num" id="LN1666">1666</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1667"><td class="num" id="LN1667">1667</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1668"><td class="num" id="LN1668">1668</td><td class="line">        cliPrintContextError();</td></tr>
<tr class="codeline" data-linenumber="1669"><td class="num" id="LN1669">1669</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="1670"><td class="num" id="LN1670">1670</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>; <span class='comment'>/* avoid compiler warning */</span></td></tr>
<tr class="codeline" data-linenumber="1671"><td class="num" id="LN1671">1671</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1672"><td class="num" id="LN1672">1672</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1673"><td class="num" id="LN1673">1673</td><td class="line">    reply = (redisReply*)_reply;</td></tr>
<tr class="codeline" data-linenumber="1674"><td class="num" id="LN1674">1674</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1675"><td class="num" id="LN1675">1675</td><td class="line">    config.last_cmd_type = reply-&gt;type;</td></tr>
<tr class="codeline" data-linenumber="1676"><td class="num" id="LN1676">1676</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1677"><td class="num" id="LN1677">1677</td><td class="line">    <span class='comment'>/* Check if we need to connect to a different node and reissue the</span></td></tr>
<tr class="codeline" data-linenumber="1678"><td class="num" id="LN1678">1678</td><td class="line">     <span class='comment'>* request. */</span></td></tr>
<tr class="codeline" data-linenumber="1679"><td class="num" id="LN1679">1679</td><td class="line">    <span class='keyword'>if</span> (config.cluster_mode &amp;&amp; reply-&gt;type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1680"><td class="num" id="LN1680">1680</td><td class="line">        (!strncmp(reply-&gt;str,<span class='string_literal'>"MOVED "</span>,6) || !strncmp(reply-&gt;str,<span class='string_literal'>"ASK "</span>,4)))</td></tr>
<tr class="codeline" data-linenumber="1681"><td class="num" id="LN1681">1681</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1682"><td class="num" id="LN1682">1682</td><td class="line">        <span class='keyword'>char</span> *p = reply-&gt;str, *s;</td></tr>
<tr class="codeline" data-linenumber="1683"><td class="num" id="LN1683">1683</td><td class="line">        <span class='keyword'>int</span> slot;</td></tr>
<tr class="codeline" data-linenumber="1684"><td class="num" id="LN1684">1684</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1685"><td class="num" id="LN1685">1685</td><td class="line">        output = 0;</td></tr>
<tr class="codeline" data-linenumber="1686"><td class="num" id="LN1686">1686</td><td class="line">        <span class='comment'>/* Comments show the position of the pointer as:</span></td></tr>
<tr class="codeline" data-linenumber="1687"><td class="num" id="LN1687">1687</td><td class="line">         <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1688"><td class="num" id="LN1688">1688</td><td class="line">         <span class='comment'>* [S] for pointer 's'</span></td></tr>
<tr class="codeline" data-linenumber="1689"><td class="num" id="LN1689">1689</td><td class="line">         <span class='comment'>* [P] for pointer 'p'</span></td></tr>
<tr class="codeline" data-linenumber="1690"><td class="num" id="LN1690">1690</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1691"><td class="num" id="LN1691">1691</td><td class="line">        s = strchr(p,' ');      <span class='comment'>/* MOVED[S]3999 127.0.0.1:6381 */</span></td></tr>
<tr class="codeline" data-linenumber="1692"><td class="num" id="LN1692">1692</td><td class="line">        p = strchr(s+1,' ');    <span class='comment'>/* MOVED[S]3999[P]127.0.0.1:6381 */</span></td></tr>
<tr class="codeline" data-linenumber="1693"><td class="num" id="LN1693">1693</td><td class="line">        *p = '\0';</td></tr>
<tr class="codeline" data-linenumber="1694"><td class="num" id="LN1694">1694</td><td class="line">        slot = atoi(s+1);</td></tr>
<tr class="codeline" data-linenumber="1695"><td class="num" id="LN1695">1695</td><td class="line">        s = strrchr(p+1,':');    <span class='comment'>/* MOVED 3999[P]127.0.0.1[S]6381 */</span></td></tr>
<tr class="codeline" data-linenumber="1696"><td class="num" id="LN1696">1696</td><td class="line">        *s = '\0';</td></tr>
<tr class="codeline" data-linenumber="1697"><td class="num" id="LN1697">1697</td><td class="line">        <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(config.conn_info.hostip);</td></tr>
<tr class="codeline" data-linenumber="1698"><td class="num" id="LN1698">1698</td><td class="line">        config.conn_info.hostip = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(p+1);</td></tr>
<tr class="codeline" data-linenumber="1699"><td class="num" id="LN1699">1699</td><td class="line">        config.conn_info.hostport = atoi(s+1);</td></tr>
<tr class="codeline" data-linenumber="1700"><td class="num" id="LN1700">1700</td><td class="line">        <span class='keyword'>if</span> (config.interactive)</td></tr>
<tr class="codeline" data-linenumber="1701"><td class="num" id="LN1701">1701</td><td class="line">            printf(<span class='string_literal'>"-&gt; Redirected to slot [%d] located at %s:%d\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="1702"><td class="num" id="LN1702">1702</td><td class="line">                slot, config.conn_info.hostip, config.conn_info.hostport);</td></tr>
<tr class="codeline" data-linenumber="1703"><td class="num" id="LN1703">1703</td><td class="line">        config.cluster_reissue_command = 1;</td></tr>
<tr class="codeline" data-linenumber="1704"><td class="num" id="LN1704">1704</td><td class="line">        <span class='keyword'>if</span> (!strncmp(reply-&gt;str,<span class='string_literal'>"ASK "</span>,4)) {</td></tr>
<tr class="codeline" data-linenumber="1705"><td class="num" id="LN1705">1705</td><td class="line">            config.cluster_send_asking = 1;</td></tr>
<tr class="codeline" data-linenumber="1706"><td class="num" id="LN1706">1706</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1707"><td class="num" id="LN1707">1707</td><td class="line">        cliRefreshPrompt();</td></tr>
<tr class="codeline" data-linenumber="1708"><td class="num" id="LN1708">1708</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (!config.interactive &amp;&amp; config.set_errcode &amp;&amp; </td></tr>
<tr class="codeline" data-linenumber="1709"><td class="num" id="LN1709">1709</td><td class="line">        reply-&gt;type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>) </td></tr>
<tr class="codeline" data-linenumber="1710"><td class="num" id="LN1710">1710</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1711"><td class="num" id="LN1711">1711</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"%s\n"</span>,reply-&gt;str);</td></tr>
<tr class="codeline" data-linenumber="1712"><td class="num" id="LN1712">1712</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="1713"><td class="num" id="LN1713">1713</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>; <span class='comment'>/* avoid compiler warning */</span></td></tr>
<tr class="codeline" data-linenumber="1714"><td class="num" id="LN1714">1714</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1715"><td class="num" id="LN1715">1715</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1716"><td class="num" id="LN1716">1716</td><td class="line">    <span class='keyword'>if</span> (output) {</td></tr>
<tr class="codeline" data-linenumber="1717"><td class="num" id="LN1717">1717</td><td class="line">        out = cliFormatReply(reply, config.output, output_raw_strings);</td></tr>
<tr class="codeline" data-linenumber="1718"><td class="num" id="LN1718">1718</td><td class="line">        fwrite(out,<span class='macro'>sdslen<span class='macro_popup'>hi_sdslen</span></span>(out),1,<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1719"><td class="num" id="LN1719">1719</td><td class="line">        fflush(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1720"><td class="num" id="LN1720">1720</td><td class="line">        <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(out);</td></tr>
<tr class="codeline" data-linenumber="1721"><td class="num" id="LN1721">1721</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1722"><td class="num" id="LN1722">1722</td><td class="line">    freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="1723"><td class="num" id="LN1723">1723</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1724"><td class="num" id="LN1724">1724</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1725"><td class="num" id="LN1725">1725</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1726"><td class="num" id="LN1726">1726</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> cliSendCommand(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv, <span class='keyword'>long</span> repeat) {</td></tr>
<tr class="codeline" data-linenumber="1727"><td class="num" id="LN1727">1727</td><td class="line">    <span class='keyword'>char</span> *command = argv[0];</td></tr>
<tr class="codeline" data-linenumber="1728"><td class="num" id="LN1728">1728</td><td class="line">    size_t *argvlen;</td></tr>
<tr class="codeline" data-linenumber="1729"><td class="num" id="LN1729">1729</td><td class="line">    <span class='keyword'>int</span> j, output_raw;</td></tr>
<tr class="codeline" data-linenumber="1730"><td class="num" id="LN1730">1730</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1731"><td class="num" id="LN1731">1731</td><td class="line">    <span class='keyword'>if</span> (context == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>return</span> <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1732"><td class="num" id="LN1732">1732</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1733"><td class="num" id="LN1733">1733</td><td class="line">    output_raw = 0;</td></tr>
<tr class="codeline" data-linenumber="1734"><td class="num" id="LN1734">1734</td><td class="line">    <span class='keyword'>if</span> (!strcasecmp(command,<span class='string_literal'>"info"</span>) ||</td></tr>
<tr class="codeline" data-linenumber="1735"><td class="num" id="LN1735">1735</td><td class="line">        !strcasecmp(command,<span class='string_literal'>"lolwut"</span>) ||</td></tr>
<tr class="codeline" data-linenumber="1736"><td class="num" id="LN1736">1736</td><td class="line">        (argc &gt;= 2 &amp;&amp; !strcasecmp(command,<span class='string_literal'>"debug"</span>) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1737"><td class="num" id="LN1737">1737</td><td class="line">                       !strcasecmp(argv[1],<span class='string_literal'>"htstats"</span>)) ||</td></tr>
<tr class="codeline" data-linenumber="1738"><td class="num" id="LN1738">1738</td><td class="line">        (argc &gt;= 2 &amp;&amp; !strcasecmp(command,<span class='string_literal'>"debug"</span>) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1739"><td class="num" id="LN1739">1739</td><td class="line">                       !strcasecmp(argv[1],<span class='string_literal'>"htstats-key"</span>)) ||</td></tr>
<tr class="codeline" data-linenumber="1740"><td class="num" id="LN1740">1740</td><td class="line">        (argc &gt;= 2 &amp;&amp; !strcasecmp(command,<span class='string_literal'>"debug"</span>) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1741"><td class="num" id="LN1741">1741</td><td class="line">                       !strcasecmp(argv[1],<span class='string_literal'>"client-eviction"</span>)) ||</td></tr>
<tr class="codeline" data-linenumber="1742"><td class="num" id="LN1742">1742</td><td class="line">        (argc &gt;= 2 &amp;&amp; !strcasecmp(command,<span class='string_literal'>"memory"</span>) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1743"><td class="num" id="LN1743">1743</td><td class="line">                      (!strcasecmp(argv[1],<span class='string_literal'>"malloc-stats"</span>) ||</td></tr>
<tr class="codeline" data-linenumber="1744"><td class="num" id="LN1744">1744</td><td class="line">                       !strcasecmp(argv[1],<span class='string_literal'>"doctor"</span>))) ||</td></tr>
<tr class="codeline" data-linenumber="1745"><td class="num" id="LN1745">1745</td><td class="line">        (argc == 2 &amp;&amp; !strcasecmp(command,<span class='string_literal'>"cluster"</span>) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1746"><td class="num" id="LN1746">1746</td><td class="line">                      (!strcasecmp(argv[1],<span class='string_literal'>"nodes"</span>) ||</td></tr>
<tr class="codeline" data-linenumber="1747"><td class="num" id="LN1747">1747</td><td class="line">                       !strcasecmp(argv[1],<span class='string_literal'>"info"</span>))) ||</td></tr>
<tr class="codeline" data-linenumber="1748"><td class="num" id="LN1748">1748</td><td class="line">        (argc &gt;= 2 &amp;&amp; !strcasecmp(command,<span class='string_literal'>"client"</span>) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1749"><td class="num" id="LN1749">1749</td><td class="line">                       (!strcasecmp(argv[1],<span class='string_literal'>"list"</span>) ||</td></tr>
<tr class="codeline" data-linenumber="1750"><td class="num" id="LN1750">1750</td><td class="line">                        !strcasecmp(argv[1],<span class='string_literal'>"info"</span>))) ||</td></tr>
<tr class="codeline" data-linenumber="1751"><td class="num" id="LN1751">1751</td><td class="line">        (argc == 3 &amp;&amp; !strcasecmp(command,<span class='string_literal'>"latency"</span>) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1752"><td class="num" id="LN1752">1752</td><td class="line">                       !strcasecmp(argv[1],<span class='string_literal'>"graph"</span>)) ||</td></tr>
<tr class="codeline" data-linenumber="1753"><td class="num" id="LN1753">1753</td><td class="line">        (argc == 2 &amp;&amp; !strcasecmp(command,<span class='string_literal'>"latency"</span>) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1754"><td class="num" id="LN1754">1754</td><td class="line">                       !strcasecmp(argv[1],<span class='string_literal'>"doctor"</span>)) ||</td></tr>
<tr class="codeline" data-linenumber="1755"><td class="num" id="LN1755">1755</td><td class="line">        <span class='comment'>/* Format PROXY INFO command for Redis Cluster Proxy:</span></td></tr>
<tr class="codeline" data-linenumber="1756"><td class="num" id="LN1756">1756</td><td class="line">         <span class='comment'>* https://github.com/artix75/redis-cluster-proxy */</span></td></tr>
<tr class="codeline" data-linenumber="1757"><td class="num" id="LN1757">1757</td><td class="line">        (argc &gt;= 2 &amp;&amp; !strcasecmp(command,<span class='string_literal'>"proxy"</span>) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1758"><td class="num" id="LN1758">1758</td><td class="line">                       !strcasecmp(argv[1],<span class='string_literal'>"info"</span>)))</td></tr>
<tr class="codeline" data-linenumber="1759"><td class="num" id="LN1759">1759</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1760"><td class="num" id="LN1760">1760</td><td class="line">        output_raw = 1;</td></tr>
<tr class="codeline" data-linenumber="1761"><td class="num" id="LN1761">1761</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1762"><td class="num" id="LN1762">1762</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1763"><td class="num" id="LN1763">1763</td><td class="line">    <span class='keyword'>if</span> (!strcasecmp(command,<span class='string_literal'>"shutdown"</span>)) config.shutdown = 1;</td></tr>
<tr class="codeline" data-linenumber="1764"><td class="num" id="LN1764">1764</td><td class="line">    <span class='keyword'>if</span> (!strcasecmp(command,<span class='string_literal'>"monitor"</span>)) config.monitor_mode = 1;</td></tr>
<tr class="codeline" data-linenumber="1765"><td class="num" id="LN1765">1765</td><td class="line">    <span class='keyword'>if</span> (!strcasecmp(command,<span class='string_literal'>"subscribe"</span>) ||</td></tr>
<tr class="codeline" data-linenumber="1766"><td class="num" id="LN1766">1766</td><td class="line">        !strcasecmp(command,<span class='string_literal'>"psubscribe"</span>) ||</td></tr>
<tr class="codeline" data-linenumber="1767"><td class="num" id="LN1767">1767</td><td class="line">        !strcasecmp(command,<span class='string_literal'>"ssubscribe"</span>)) config.pubsub_mode = 1;</td></tr>
<tr class="codeline" data-linenumber="1768"><td class="num" id="LN1768">1768</td><td class="line">    <span class='keyword'>if</span> (!strcasecmp(command,<span class='string_literal'>"sync"</span>) ||</td></tr>
<tr class="codeline" data-linenumber="1769"><td class="num" id="LN1769">1769</td><td class="line">        !strcasecmp(command,<span class='string_literal'>"psync"</span>)) config.slave_mode = 1;</td></tr>
<tr class="codeline" data-linenumber="1770"><td class="num" id="LN1770">1770</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1771"><td class="num" id="LN1771">1771</td><td class="line">    <span class='comment'>/* When the user manually calls SCRIPT DEBUG, setup the activation of</span></td></tr>
<tr class="codeline" data-linenumber="1772"><td class="num" id="LN1772">1772</td><td class="line">     <span class='comment'>* debugging mode on the next eval if needed. */</span></td></tr>
<tr class="codeline" data-linenumber="1773"><td class="num" id="LN1773">1773</td><td class="line">    <span class='keyword'>if</span> (argc == 3 &amp;&amp; !strcasecmp(argv[0],<span class='string_literal'>"script"</span>) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1774"><td class="num" id="LN1774">1774</td><td class="line">                     !strcasecmp(argv[1],<span class='string_literal'>"debug"</span>))</td></tr>
<tr class="codeline" data-linenumber="1775"><td class="num" id="LN1775">1775</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1776"><td class="num" id="LN1776">1776</td><td class="line">        <span class='keyword'>if</span> (!strcasecmp(argv[2],<span class='string_literal'>"yes"</span>) || !strcasecmp(argv[2],<span class='string_literal'>"sync"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="1777"><td class="num" id="LN1777">1777</td><td class="line">            config.enable_ldb_on_eval = 1;</td></tr>
<tr class="codeline" data-linenumber="1778"><td class="num" id="LN1778">1778</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1779"><td class="num" id="LN1779">1779</td><td class="line">            config.enable_ldb_on_eval = 0;</td></tr>
<tr class="codeline" data-linenumber="1780"><td class="num" id="LN1780">1780</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1781"><td class="num" id="LN1781">1781</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1782"><td class="num" id="LN1782">1782</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1783"><td class="num" id="LN1783">1783</td><td class="line">    <span class='comment'>/* Actually activate LDB on EVAL if needed. */</span></td></tr>
<tr class="codeline" data-linenumber="1784"><td class="num" id="LN1784">1784</td><td class="line">    <span class='keyword'>if</span> (!strcasecmp(command,<span class='string_literal'>"eval"</span>) &amp;&amp; config.enable_ldb_on_eval) {</td></tr>
<tr class="codeline" data-linenumber="1785"><td class="num" id="LN1785">1785</td><td class="line">        config.eval_ldb = 1;</td></tr>
<tr class="codeline" data-linenumber="1786"><td class="num" id="LN1786">1786</td><td class="line">        config.output = <span class='macro'>OUTPUT_RAW<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1787"><td class="num" id="LN1787">1787</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1788"><td class="num" id="LN1788">1788</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1789"><td class="num" id="LN1789">1789</td><td class="line">    <span class='comment'>/* Setup argument length */</span></td></tr>
<tr class="codeline" data-linenumber="1790"><td class="num" id="LN1790">1790</td><td class="line">    argvlen = zmalloc(argc*<span class='keyword'>sizeof</span>(size_t));</td></tr>
<tr class="codeline" data-linenumber="1791"><td class="num" id="LN1791">1791</td><td class="line">    <span class='keyword'>for</span> (j = 0; j &lt; argc; j++)</td></tr>
<tr class="codeline" data-linenumber="1792"><td class="num" id="LN1792">1792</td><td class="line">        argvlen[j] = <span class='macro'>sdslen<span class='macro_popup'>hi_sdslen</span></span>(argv[j]);</td></tr>
<tr class="codeline" data-linenumber="1793"><td class="num" id="LN1793">1793</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1794"><td class="num" id="LN1794">1794</td><td class="line">    <span class='comment'>/* Negative repeat is allowed and causes infinite loop,</span></td></tr>
<tr class="codeline" data-linenumber="1795"><td class="num" id="LN1795">1795</td><td class="line">       <span class='comment'>works well with the interval option. */</span></td></tr>
<tr class="codeline" data-linenumber="1796"><td class="num" id="LN1796">1796</td><td class="line">    <span class='keyword'>while</span>(repeat &lt; 0 || repeat-- &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="1797"><td class="num" id="LN1797">1797</td><td class="line">        redisAppendCommandArgv(context,argc,(<span class='keyword'>const</span> <span class='keyword'>char</span>**)argv,argvlen);</td></tr>
<tr class="codeline" data-linenumber="1798"><td class="num" id="LN1798">1798</td><td class="line">        <span class='keyword'>if</span> (config.monitor_mode) {</td></tr>
<tr class="codeline" data-linenumber="1799"><td class="num" id="LN1799">1799</td><td class="line">            <span class='keyword'>do</span> {</td></tr>
<tr class="codeline" data-linenumber="1800"><td class="num" id="LN1800">1800</td><td class="line">                <span class='keyword'>if</span> (cliReadReply(output_raw) != <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1801"><td class="num" id="LN1801">1801</td><td class="line">                    cliPrintContextError();</td></tr>
<tr class="codeline" data-linenumber="1802"><td class="num" id="LN1802">1802</td><td class="line">                    exit(1);</td></tr>
<tr class="codeline" data-linenumber="1803"><td class="num" id="LN1803">1803</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="1804"><td class="num" id="LN1804">1804</td><td class="line">                fflush(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1805"><td class="num" id="LN1805">1805</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1806"><td class="num" id="LN1806">1806</td><td class="line">                <span class='comment'>/* This happens when the MONITOR command returns an error. */</span></td></tr>
<tr class="codeline" data-linenumber="1807"><td class="num" id="LN1807">1807</td><td class="line">                <span class='keyword'>if</span> (config.last_cmd_type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1808"><td class="num" id="LN1808">1808</td><td class="line">                    config.monitor_mode = 0;</td></tr>
<tr class="codeline" data-linenumber="1809"><td class="num" id="LN1809">1809</td><td class="line">            } <span class='keyword'>while</span>(config.monitor_mode);</td></tr>
<tr class="codeline" data-linenumber="1810"><td class="num" id="LN1810">1810</td><td class="line">            zfree(argvlen);</td></tr>
<tr class="codeline" data-linenumber="1811"><td class="num" id="LN1811">1811</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1812"><td class="num" id="LN1812">1812</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1813"><td class="num" id="LN1813">1813</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1814"><td class="num" id="LN1814">1814</td><td class="line">        <span class='keyword'>if</span> (config.pubsub_mode) {</td></tr>
<tr class="codeline" data-linenumber="1815"><td class="num" id="LN1815">1815</td><td class="line">            <span class='keyword'>if</span> (config.output != <span class='macro'>OUTPUT_RAW<span class='macro_popup'>1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1816"><td class="num" id="LN1816">1816</td><td class="line">                printf(<span class='string_literal'>"Reading messages... (press Ctrl-C to quit)\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1817"><td class="num" id="LN1817">1817</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1818"><td class="num" id="LN1818">1818</td><td class="line">            <span class='comment'>/* Unset our default PUSH handler so this works in RESP2/RESP3 */</span></td></tr>
<tr class="codeline" data-linenumber="1819"><td class="num" id="LN1819">1819</td><td class="line">            redisSetPushCallback(context, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1820"><td class="num" id="LN1820">1820</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1821"><td class="num" id="LN1821">1821</td><td class="line">            <span class='keyword'>while</span> (config.pubsub_mode) {</td></tr>
<tr class="codeline" data-linenumber="1822"><td class="num" id="LN1822">1822</td><td class="line">                <span class='keyword'>if</span> (cliReadReply(output_raw) != <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1823"><td class="num" id="LN1823">1823</td><td class="line">                    cliPrintContextError();</td></tr>
<tr class="codeline" data-linenumber="1824"><td class="num" id="LN1824">1824</td><td class="line">                    exit(1);</td></tr>
<tr class="codeline" data-linenumber="1825"><td class="num" id="LN1825">1825</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="1826"><td class="num" id="LN1826">1826</td><td class="line">                fflush(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>); <span class='comment'>/* Make it grep friendly */</span></td></tr>
<tr class="codeline" data-linenumber="1827"><td class="num" id="LN1827">1827</td><td class="line">                <span class='keyword'>if</span> (!config.pubsub_mode || config.last_cmd_type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1828"><td class="num" id="LN1828">1828</td><td class="line">                    <span class='keyword'>if</span> (config.push_output) {</td></tr>
<tr class="codeline" data-linenumber="1829"><td class="num" id="LN1829">1829</td><td class="line">                        redisSetPushCallback(context, cliPushHandler);</td></tr>
<tr class="codeline" data-linenumber="1830"><td class="num" id="LN1830">1830</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="1831"><td class="num" id="LN1831">1831</td><td class="line">                    config.pubsub_mode = 0;</td></tr>
<tr class="codeline" data-linenumber="1832"><td class="num" id="LN1832">1832</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="1833"><td class="num" id="LN1833">1833</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1834"><td class="num" id="LN1834">1834</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1835"><td class="num" id="LN1835">1835</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1836"><td class="num" id="LN1836">1836</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1837"><td class="num" id="LN1837">1837</td><td class="line">        <span class='keyword'>if</span> (config.slave_mode) {</td></tr>
<tr class="codeline" data-linenumber="1838"><td class="num" id="LN1838">1838</td><td class="line">            printf(<span class='string_literal'>"Entering replica output mode...  (press Ctrl-C to quit)\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1839"><td class="num" id="LN1839">1839</td><td class="line">            slaveMode();</td></tr>
<tr class="codeline" data-linenumber="1840"><td class="num" id="LN1840">1840</td><td class="line">            config.slave_mode = 0;</td></tr>
<tr class="codeline" data-linenumber="1841"><td class="num" id="LN1841">1841</td><td class="line">            zfree(argvlen);</td></tr>
<tr class="codeline" data-linenumber="1842"><td class="num" id="LN1842">1842</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>;  <span class='comment'>/* Error = slaveMode lost connection to master */</span></td></tr>
<tr class="codeline" data-linenumber="1843"><td class="num" id="LN1843">1843</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1844"><td class="num" id="LN1844">1844</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1845"><td class="num" id="LN1845">1845</td><td class="line">        <span class='keyword'>if</span> (cliReadReply(output_raw) != <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1846"><td class="num" id="LN1846">1846</td><td class="line">            zfree(argvlen);</td></tr>
<tr class="codeline" data-linenumber="1847"><td class="num" id="LN1847">1847</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1848"><td class="num" id="LN1848">1848</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1849"><td class="num" id="LN1849">1849</td><td class="line">            <span class='comment'>/* Store database number when SELECT was successfully executed. */</span></td></tr>
<tr class="codeline" data-linenumber="1850"><td class="num" id="LN1850">1850</td><td class="line">            <span class='keyword'>if</span> (!strcasecmp(command,<span class='string_literal'>"select"</span>) &amp;&amp; argc == 2 &amp;&amp; </td></tr>
<tr class="codeline" data-linenumber="1851"><td class="num" id="LN1851">1851</td><td class="line">                config.last_cmd_type != <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>) </td></tr>
<tr class="codeline" data-linenumber="1852"><td class="num" id="LN1852">1852</td><td class="line">            {</td></tr>
<tr class="codeline" data-linenumber="1853"><td class="num" id="LN1853">1853</td><td class="line">                config.conn_info.input_dbnum = config.dbnum = atoi(argv[1]);</td></tr>
<tr class="codeline" data-linenumber="1854"><td class="num" id="LN1854">1854</td><td class="line">                cliRefreshPrompt();</td></tr>
<tr class="codeline" data-linenumber="1855"><td class="num" id="LN1855">1855</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(command,<span class='string_literal'>"auth"</span>) &amp;&amp; (argc == 2 || argc == 3)) {</td></tr>
<tr class="codeline" data-linenumber="1856"><td class="num" id="LN1856">1856</td><td class="line">                cliSelect();</td></tr>
<tr class="codeline" data-linenumber="1857"><td class="num" id="LN1857">1857</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(command,<span class='string_literal'>"multi"</span>) &amp;&amp; argc == 1 &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1858"><td class="num" id="LN1858">1858</td><td class="line">                config.last_cmd_type != <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>) </td></tr>
<tr class="codeline" data-linenumber="1859"><td class="num" id="LN1859">1859</td><td class="line">            {</td></tr>
<tr class="codeline" data-linenumber="1860"><td class="num" id="LN1860">1860</td><td class="line">                config.in_multi = 1;</td></tr>
<tr class="codeline" data-linenumber="1861"><td class="num" id="LN1861">1861</td><td class="line">                config.pre_multi_dbnum = config.dbnum;</td></tr>
<tr class="codeline" data-linenumber="1862"><td class="num" id="LN1862">1862</td><td class="line">                cliRefreshPrompt();</td></tr>
<tr class="codeline" data-linenumber="1863"><td class="num" id="LN1863">1863</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(command,<span class='string_literal'>"exec"</span>) &amp;&amp; argc == 1 &amp;&amp; config.in_multi) {</td></tr>
<tr class="codeline" data-linenumber="1864"><td class="num" id="LN1864">1864</td><td class="line">                config.in_multi = 0;</td></tr>
<tr class="codeline" data-linenumber="1865"><td class="num" id="LN1865">1865</td><td class="line">                <span class='keyword'>if</span> (config.last_cmd_type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span> ||</td></tr>
<tr class="codeline" data-linenumber="1866"><td class="num" id="LN1866">1866</td><td class="line">                    config.last_cmd_type == <span class='macro'>REDIS_REPLY_NIL<span class='macro_popup'>4</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1867"><td class="num" id="LN1867">1867</td><td class="line">                {</td></tr>
<tr class="codeline" data-linenumber="1868"><td class="num" id="LN1868">1868</td><td class="line">                    config.conn_info.input_dbnum = config.dbnum = config.pre_multi_dbnum;</td></tr>
<tr class="codeline" data-linenumber="1869"><td class="num" id="LN1869">1869</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="1870"><td class="num" id="LN1870">1870</td><td class="line">                cliRefreshPrompt();</td></tr>
<tr class="codeline" data-linenumber="1871"><td class="num" id="LN1871">1871</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(command,<span class='string_literal'>"discard"</span>) &amp;&amp; argc == 1 &amp;&amp; </td></tr>
<tr class="codeline" data-linenumber="1872"><td class="num" id="LN1872">1872</td><td class="line">                config.last_cmd_type != <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>) </td></tr>
<tr class="codeline" data-linenumber="1873"><td class="num" id="LN1873">1873</td><td class="line">            {</td></tr>
<tr class="codeline" data-linenumber="1874"><td class="num" id="LN1874">1874</td><td class="line">                config.in_multi = 0;</td></tr>
<tr class="codeline" data-linenumber="1875"><td class="num" id="LN1875">1875</td><td class="line">                config.conn_info.input_dbnum = config.dbnum = config.pre_multi_dbnum;</td></tr>
<tr class="codeline" data-linenumber="1876"><td class="num" id="LN1876">1876</td><td class="line">                cliRefreshPrompt();</td></tr>
<tr class="codeline" data-linenumber="1877"><td class="num" id="LN1877">1877</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(command,<span class='string_literal'>"reset"</span>) &amp;&amp; argc == 1 &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1878"><td class="num" id="LN1878">1878</td><td class="line">                                     config.last_cmd_type != <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1879"><td class="num" id="LN1879">1879</td><td class="line">                config.in_multi = 0;</td></tr>
<tr class="codeline" data-linenumber="1880"><td class="num" id="LN1880">1880</td><td class="line">                config.dbnum = 0;</td></tr>
<tr class="codeline" data-linenumber="1881"><td class="num" id="LN1881">1881</td><td class="line">                config.conn_info.input_dbnum = 0;</td></tr>
<tr class="codeline" data-linenumber="1882"><td class="num" id="LN1882">1882</td><td class="line">                config.resp3 = 0;</td></tr>
<tr class="codeline" data-linenumber="1883"><td class="num" id="LN1883">1883</td><td class="line">                cliRefreshPrompt();</td></tr>
<tr class="codeline" data-linenumber="1884"><td class="num" id="LN1884">1884</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1885"><td class="num" id="LN1885">1885</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1886"><td class="num" id="LN1886">1886</td><td class="line">        <span class='keyword'>if</span> (config.cluster_reissue_command){</td></tr>
<tr class="codeline" data-linenumber="1887"><td class="num" id="LN1887">1887</td><td class="line">            <span class='comment'>/* If we need to reissue the command, break to prevent a</span></td></tr>
<tr class="codeline" data-linenumber="1888"><td class="num" id="LN1888">1888</td><td class="line">               <span class='comment'>further 'repeat' number of dud interactions */</span></td></tr>
<tr class="codeline" data-linenumber="1889"><td class="num" id="LN1889">1889</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1890"><td class="num" id="LN1890">1890</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1891"><td class="num" id="LN1891">1891</td><td class="line">        <span class='keyword'>if</span> (config.interval) usleep(config.interval);</td></tr>
<tr class="codeline" data-linenumber="1892"><td class="num" id="LN1892">1892</td><td class="line">        fflush(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>); <span class='comment'>/* Make it grep friendly */</span></td></tr>
<tr class="codeline" data-linenumber="1893"><td class="num" id="LN1893">1893</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1894"><td class="num" id="LN1894">1894</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1895"><td class="num" id="LN1895">1895</td><td class="line">    zfree(argvlen);</td></tr>
<tr class="codeline" data-linenumber="1896"><td class="num" id="LN1896">1896</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1897"><td class="num" id="LN1897">1897</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1898"><td class="num" id="LN1898">1898</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1899"><td class="num" id="LN1899">1899</td><td class="line"><span class='comment'>/* Send a command reconnecting the link if needed. */</span></td></tr>
<tr class="codeline" data-linenumber="1900"><td class="num" id="LN1900">1900</td><td class="line"><span class='keyword'>static</span> redisReply *reconnectingRedisCommand(redisContext *c, <span class='keyword'>const</span> <span class='keyword'>char</span> *fmt, ...) {</td></tr>
<tr class="codeline" data-linenumber="1901"><td class="num" id="LN1901">1901</td><td class="line">    redisReply *reply = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1902"><td class="num" id="LN1902">1902</td><td class="line">    <span class='keyword'>int</span> tries = 0;</td></tr>
<tr class="codeline" data-linenumber="1903"><td class="num" id="LN1903">1903</td><td class="line">    va_list ap;</td></tr>
<tr class="codeline" data-linenumber="1904"><td class="num" id="LN1904">1904</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1905"><td class="num" id="LN1905">1905</td><td class="line">    <span class='macro'>assert(!c-&gt;err)<span class='macro_popup'>((!c-&gt;err) ? (void) (0) : __assert_fail ("!c-&gt;err", "redis-cli.c"<br>, 1905, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1906"><td class="num" id="LN1906">1906</td><td class="line">    <span class='keyword'>while</span>(reply == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1907"><td class="num" id="LN1907">1907</td><td class="line">        <span class='keyword'>while</span> (c-&gt;err &amp; (<span class='macro'>REDIS_ERR_IO<span class='macro_popup'>1</span></span> | <span class='macro'>REDIS_ERR_EOF<span class='macro_popup'>3</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="1908"><td class="num" id="LN1908">1908</td><td class="line">            printf(<span class='string_literal'>"\r\x1b[0K"</span>); <span class='comment'>/* Cursor to left edge + clear line. */</span></td></tr>
<tr class="codeline" data-linenumber="1909"><td class="num" id="LN1909">1909</td><td class="line">            printf(<span class='string_literal'>"Reconnecting... %d\r"</span>, ++tries);</td></tr>
<tr class="codeline" data-linenumber="1910"><td class="num" id="LN1910">1910</td><td class="line">            fflush(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1911"><td class="num" id="LN1911">1911</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1912"><td class="num" id="LN1912">1912</td><td class="line">            redisFree(c);</td></tr>
<tr class="codeline" data-linenumber="1913"><td class="num" id="LN1913">1913</td><td class="line">            c = redisConnect(config.conn_info.hostip,config.conn_info.hostport);</td></tr>
<tr class="codeline" data-linenumber="1914"><td class="num" id="LN1914">1914</td><td class="line">            <span class='keyword'>if</span> (!c-&gt;err &amp;&amp; config.tls) {</td></tr>
<tr class="codeline" data-linenumber="1915"><td class="num" id="LN1915">1915</td><td class="line">                <span class='keyword'>const</span> <span class='keyword'>char</span> *err = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1916"><td class="num" id="LN1916">1916</td><td class="line">                <span class='keyword'>if</span> (cliSecureConnection(c, config.sslconfig, &amp;err) == <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span> &amp;&amp; err) {</td></tr>
<tr class="codeline" data-linenumber="1917"><td class="num" id="LN1917">1917</td><td class="line">                    fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"TLS Error: %s\n"</span>, err);</td></tr>
<tr class="codeline" data-linenumber="1918"><td class="num" id="LN1918">1918</td><td class="line">                    exit(1);</td></tr>
<tr class="codeline" data-linenumber="1919"><td class="num" id="LN1919">1919</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="1920"><td class="num" id="LN1920">1920</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1921"><td class="num" id="LN1921">1921</td><td class="line">            usleep(1000000);</td></tr>
<tr class="codeline" data-linenumber="1922"><td class="num" id="LN1922">1922</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1923"><td class="num" id="LN1923">1923</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1924"><td class="num" id="LN1924">1924</td><td class="line">        <span class='macro'>va_start(ap,fmt)<span class='macro_popup'>__builtin_va_start(ap, fmt)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1925"><td class="num" id="LN1925">1925</td><td class="line">        reply = redisvCommand(c,fmt,ap);</td></tr>
<tr class="codeline" data-linenumber="1926"><td class="num" id="LN1926">1926</td><td class="line">        <span class='macro'>va_end(ap)<span class='macro_popup'>__builtin_va_end(ap)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1927"><td class="num" id="LN1927">1927</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1928"><td class="num" id="LN1928">1928</td><td class="line">        <span class='keyword'>if</span> (c-&gt;err &amp;&amp; !(c-&gt;err &amp; (<span class='macro'>REDIS_ERR_IO<span class='macro_popup'>1</span></span> | <span class='macro'>REDIS_ERR_EOF<span class='macro_popup'>3</span></span>))) {</td></tr>
<tr class="codeline" data-linenumber="1929"><td class="num" id="LN1929">1929</td><td class="line">            fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Error: %s\n"</span>, c-&gt;errstr);</td></tr>
<tr class="codeline" data-linenumber="1930"><td class="num" id="LN1930">1930</td><td class="line">            exit(1);</td></tr>
<tr class="codeline" data-linenumber="1931"><td class="num" id="LN1931">1931</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (tries &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="1932"><td class="num" id="LN1932">1932</td><td class="line">            printf(<span class='string_literal'>"\r\x1b[0K"</span>); <span class='comment'>/* Cursor to left edge + clear line. */</span></td></tr>
<tr class="codeline" data-linenumber="1933"><td class="num" id="LN1933">1933</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1934"><td class="num" id="LN1934">1934</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1935"><td class="num" id="LN1935">1935</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1936"><td class="num" id="LN1936">1936</td><td class="line">    context = c;</td></tr>
<tr class="codeline" data-linenumber="1937"><td class="num" id="LN1937">1937</td><td class="line">    <span class='keyword'>return</span> reply;</td></tr>
<tr class="codeline" data-linenumber="1938"><td class="num" id="LN1938">1938</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1939"><td class="num" id="LN1939">1939</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1940"><td class="num" id="LN1940">1940</td><td class="line"><span class='comment'>/*------------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="1941"><td class="num" id="LN1941">1941</td><td class="line"> <span class='comment'>* User interface</span></td></tr>
<tr class="codeline" data-linenumber="1942"><td class="num" id="LN1942">1942</td><td class="line"> <span class='comment'>*--------------------------------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="1943"><td class="num" id="LN1943">1943</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1944"><td class="num" id="LN1944">1944</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> parseOptions(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv) {</td></tr>
<tr class="codeline" data-linenumber="1945"><td class="num" id="LN1945">1945</td><td class="line">    <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="1946"><td class="num" id="LN1946">1946</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1947"><td class="num" id="LN1947">1947</td><td class="line">    <span class='keyword'>for</span> (i = 1; i &lt; argc; i++) {</td></tr>
<tr class="codeline" data-linenumber="1948"><td class="num" id="LN1948">1948</td><td class="line">        <span class='keyword'>int</span> lastarg = i==argc-1;</td></tr>
<tr class="codeline" data-linenumber="1949"><td class="num" id="LN1949">1949</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1950"><td class="num" id="LN1950">1950</td><td class="line">        <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"-h"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="1951"><td class="num" id="LN1951">1951</td><td class="line">            <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(config.conn_info.hostip);</td></tr>
<tr class="codeline" data-linenumber="1952"><td class="num" id="LN1952">1952</td><td class="line">            config.conn_info.hostip = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(argv[++i]);</td></tr>
<tr class="codeline" data-linenumber="1953"><td class="num" id="LN1953">1953</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"-h"</span>) &amp;&amp; lastarg) {</td></tr>
<tr class="codeline" data-linenumber="1954"><td class="num" id="LN1954">1954</td><td class="line">            usage(0);</td></tr>
<tr class="codeline" data-linenumber="1955"><td class="num" id="LN1955">1955</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--help"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="1956"><td class="num" id="LN1956">1956</td><td class="line">            usage(0);</td></tr>
<tr class="codeline" data-linenumber="1957"><td class="num" id="LN1957">1957</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"-x"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="1958"><td class="num" id="LN1958">1958</td><td class="line">            config.stdin_lastarg = 1;</td></tr>
<tr class="codeline" data-linenumber="1959"><td class="num" id="LN1959">1959</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i], <span class='string_literal'>"-X"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="1960"><td class="num" id="LN1960">1960</td><td class="line">            config.stdin_tag_arg = 1;</td></tr>
<tr class="codeline" data-linenumber="1961"><td class="num" id="LN1961">1961</td><td class="line">            config.stdin_tag_name = argv[++i];</td></tr>
<tr class="codeline" data-linenumber="1962"><td class="num" id="LN1962">1962</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"-p"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="1963"><td class="num" id="LN1963">1963</td><td class="line">            config.conn_info.hostport = atoi(argv[++i]);</td></tr>
<tr class="codeline" data-linenumber="1964"><td class="num" id="LN1964">1964</td><td class="line">            <span class='keyword'>if</span> (config.conn_info.hostport &lt; 0 || config.conn_info.hostport &gt; 65535) {</td></tr>
<tr class="codeline" data-linenumber="1965"><td class="num" id="LN1965">1965</td><td class="line">                fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Invalid server port.\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1966"><td class="num" id="LN1966">1966</td><td class="line">                exit(1);</td></tr>
<tr class="codeline" data-linenumber="1967"><td class="num" id="LN1967">1967</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1968"><td class="num" id="LN1968">1968</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"-s"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="1969"><td class="num" id="LN1969">1969</td><td class="line">            config.hostsocket = argv[++i];</td></tr>
<tr class="codeline" data-linenumber="1970"><td class="num" id="LN1970">1970</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"-r"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="1971"><td class="num" id="LN1971">1971</td><td class="line">            config.repeat = strtoll(argv[++i],<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,10);</td></tr>
<tr class="codeline" data-linenumber="1972"><td class="num" id="LN1972">1972</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"-i"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="1973"><td class="num" id="LN1973">1973</td><td class="line">            <span class='keyword'>double</span> seconds = atof(argv[++i]);</td></tr>
<tr class="codeline" data-linenumber="1974"><td class="num" id="LN1974">1974</td><td class="line">            config.interval = seconds*1000000;</td></tr>
<tr class="codeline" data-linenumber="1975"><td class="num" id="LN1975">1975</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"-n"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="1976"><td class="num" id="LN1976">1976</td><td class="line">            config.conn_info.input_dbnum = atoi(argv[++i]);</td></tr>
<tr class="codeline" data-linenumber="1977"><td class="num" id="LN1977">1977</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i], <span class='string_literal'>"--no-auth-warning"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="1978"><td class="num" id="LN1978">1978</td><td class="line">            config.no_auth_warning = 1;</td></tr>
<tr class="codeline" data-linenumber="1979"><td class="num" id="LN1979">1979</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i], <span class='string_literal'>"--askpass"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="1980"><td class="num" id="LN1980">1980</td><td class="line">            config.askpass = 1;</td></tr>
<tr class="codeline" data-linenumber="1981"><td class="num" id="LN1981">1981</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> ((!strcmp(argv[i],<span class='string_literal'>"-a"</span>) || !strcmp(argv[i],<span class='string_literal'>"--pass"</span>))</td></tr>
<tr class="codeline" data-linenumber="1982"><td class="num" id="LN1982">1982</td><td class="line">                   &amp;&amp; !lastarg)</td></tr>
<tr class="codeline" data-linenumber="1983"><td class="num" id="LN1983">1983</td><td class="line">        {</td></tr>
<tr class="codeline" data-linenumber="1984"><td class="num" id="LN1984">1984</td><td class="line">            config.conn_info.auth = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(argv[++i]);</td></tr>
<tr class="codeline" data-linenumber="1985"><td class="num" id="LN1985">1985</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--user"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="1986"><td class="num" id="LN1986">1986</td><td class="line">            config.conn_info.user = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(argv[++i]);</td></tr>
<tr class="codeline" data-linenumber="1987"><td class="num" id="LN1987">1987</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"-u"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="1988"><td class="num" id="LN1988">1988</td><td class="line">            parseRedisUri(argv[++i],<span class='string_literal'>"redis-cli"</span>,&amp;config.conn_info,&amp;config.tls);</td></tr>
<tr class="codeline" data-linenumber="1989"><td class="num" id="LN1989">1989</td><td class="line">            <span class='keyword'>if</span> (config.conn_info.hostport &lt; 0 || config.conn_info.hostport &gt; 65535) {</td></tr>
<tr class="codeline" data-linenumber="1990"><td class="num" id="LN1990">1990</td><td class="line">                fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Invalid server port.\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1991"><td class="num" id="LN1991">1991</td><td class="line">                exit(1);</td></tr>
<tr class="codeline" data-linenumber="1992"><td class="num" id="LN1992">1992</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1993"><td class="num" id="LN1993">1993</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--raw"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="1994"><td class="num" id="LN1994">1994</td><td class="line">            config.output = <span class='macro'>OUTPUT_RAW<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1995"><td class="num" id="LN1995">1995</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--no-raw"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="1996"><td class="num" id="LN1996">1996</td><td class="line">            config.output = <span class='macro'>OUTPUT_STANDARD<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1997"><td class="num" id="LN1997">1997</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--quoted-input"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="1998"><td class="num" id="LN1998">1998</td><td class="line">            config.quoted_input = 1;</td></tr>
<tr class="codeline" data-linenumber="1999"><td class="num" id="LN1999">1999</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--csv"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2000"><td class="num" id="LN2000">2000</td><td class="line">            config.output = <span class='macro'>OUTPUT_CSV<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2001"><td class="num" id="LN2001">2001</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--json"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2002"><td class="num" id="LN2002">2002</td><td class="line">            <span class='comment'>/* Not overwrite explicit value by -3 */</span></td></tr>
<tr class="codeline" data-linenumber="2003"><td class="num" id="LN2003">2003</td><td class="line">            <span class='keyword'>if</span> (config.resp3 == 0) {</td></tr>
<tr class="codeline" data-linenumber="2004"><td class="num" id="LN2004">2004</td><td class="line">                config.resp3 = 2;</td></tr>
<tr class="codeline" data-linenumber="2005"><td class="num" id="LN2005">2005</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2006"><td class="num" id="LN2006">2006</td><td class="line">            config.output = <span class='macro'>OUTPUT_JSON<span class='macro_popup'>3</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2007"><td class="num" id="LN2007">2007</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--quoted-json"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2008"><td class="num" id="LN2008">2008</td><td class="line">            <span class='comment'>/* Not overwrite explicit value by -3*/</span></td></tr>
<tr class="codeline" data-linenumber="2009"><td class="num" id="LN2009">2009</td><td class="line">            <span class='keyword'>if</span> (config.resp3 == 0) {</td></tr>
<tr class="codeline" data-linenumber="2010"><td class="num" id="LN2010">2010</td><td class="line">                config.resp3 = 2;</td></tr>
<tr class="codeline" data-linenumber="2011"><td class="num" id="LN2011">2011</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2012"><td class="num" id="LN2012">2012</td><td class="line">            config.output = <span class='macro'>OUTPUT_QUOTED_JSON<span class='macro_popup'>4</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2013"><td class="num" id="LN2013">2013</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--latency"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2014"><td class="num" id="LN2014">2014</td><td class="line">            config.latency_mode = 1;</td></tr>
<tr class="codeline" data-linenumber="2015"><td class="num" id="LN2015">2015</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--latency-dist"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2016"><td class="num" id="LN2016">2016</td><td class="line">            config.latency_dist_mode = 1;</td></tr>
<tr class="codeline" data-linenumber="2017"><td class="num" id="LN2017">2017</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--mono"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2018"><td class="num" id="LN2018">2018</td><td class="line">            spectrum_palette = spectrum_palette_mono;</td></tr>
<tr class="codeline" data-linenumber="2019"><td class="num" id="LN2019">2019</td><td class="line">            spectrum_palette_size = spectrum_palette_mono_size;</td></tr>
<tr class="codeline" data-linenumber="2020"><td class="num" id="LN2020">2020</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--latency-history"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2021"><td class="num" id="LN2021">2021</td><td class="line">            config.latency_mode = 1;</td></tr>
<tr class="codeline" data-linenumber="2022"><td class="num" id="LN2022">2022</td><td class="line">            config.latency_history = 1;</td></tr>
<tr class="codeline" data-linenumber="2023"><td class="num" id="LN2023">2023</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--lru-test"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="2024"><td class="num" id="LN2024">2024</td><td class="line">            config.lru_test_mode = 1;</td></tr>
<tr class="codeline" data-linenumber="2025"><td class="num" id="LN2025">2025</td><td class="line">            config.lru_test_sample_size = strtoll(argv[++i],<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,10);</td></tr>
<tr class="codeline" data-linenumber="2026"><td class="num" id="LN2026">2026</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--slave"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2027"><td class="num" id="LN2027">2027</td><td class="line">            config.slave_mode = 1;</td></tr>
<tr class="codeline" data-linenumber="2028"><td class="num" id="LN2028">2028</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--replica"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2029"><td class="num" id="LN2029">2029</td><td class="line">            config.slave_mode = 1;</td></tr>
<tr class="codeline" data-linenumber="2030"><td class="num" id="LN2030">2030</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--stat"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2031"><td class="num" id="LN2031">2031</td><td class="line">            config.stat_mode = 1;</td></tr>
<tr class="codeline" data-linenumber="2032"><td class="num" id="LN2032">2032</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--scan"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2033"><td class="num" id="LN2033">2033</td><td class="line">            config.scan_mode = 1;</td></tr>
<tr class="codeline" data-linenumber="2034"><td class="num" id="LN2034">2034</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--pattern"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="2035"><td class="num" id="LN2035">2035</td><td class="line">            <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(config.pattern);</td></tr>
<tr class="codeline" data-linenumber="2036"><td class="num" id="LN2036">2036</td><td class="line">            config.pattern = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(argv[++i]);</td></tr>
<tr class="codeline" data-linenumber="2037"><td class="num" id="LN2037">2037</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--quoted-pattern"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="2038"><td class="num" id="LN2038">2038</td><td class="line">            <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(config.pattern);</td></tr>
<tr class="codeline" data-linenumber="2039"><td class="num" id="LN2039">2039</td><td class="line">            config.pattern = unquoteCString(argv[++i]);</td></tr>
<tr class="codeline" data-linenumber="2040"><td class="num" id="LN2040">2040</td><td class="line">            <span class='keyword'>if</span> (!config.pattern) {</td></tr>
<tr class="codeline" data-linenumber="2041"><td class="num" id="LN2041">2041</td><td class="line">                fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"Invalid quoted string specified for --quoted-pattern.\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="2042"><td class="num" id="LN2042">2042</td><td class="line">                exit(1);</td></tr>
<tr class="codeline" data-linenumber="2043"><td class="num" id="LN2043">2043</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2044"><td class="num" id="LN2044">2044</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--intrinsic-latency"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="2045"><td class="num" id="LN2045">2045</td><td class="line">            config.intrinsic_latency_mode = 1;</td></tr>
<tr class="codeline" data-linenumber="2046"><td class="num" id="LN2046">2046</td><td class="line">            config.intrinsic_latency_duration = atoi(argv[++i]);</td></tr>
<tr class="codeline" data-linenumber="2047"><td class="num" id="LN2047">2047</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--rdb"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="2048"><td class="num" id="LN2048">2048</td><td class="line">            config.getrdb_mode = 1;</td></tr>
<tr class="codeline" data-linenumber="2049"><td class="num" id="LN2049">2049</td><td class="line">            config.rdb_filename = argv[++i];</td></tr>
<tr class="codeline" data-linenumber="2050"><td class="num" id="LN2050">2050</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--functions-rdb"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="2051"><td class="num" id="LN2051">2051</td><td class="line">            config.get_functions_rdb_mode = 1;</td></tr>
<tr class="codeline" data-linenumber="2052"><td class="num" id="LN2052">2052</td><td class="line">            config.rdb_filename = argv[++i];</td></tr>
<tr class="codeline" data-linenumber="2053"><td class="num" id="LN2053">2053</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--pipe"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2054"><td class="num" id="LN2054">2054</td><td class="line">            config.pipe_mode = 1;</td></tr>
<tr class="codeline" data-linenumber="2055"><td class="num" id="LN2055">2055</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--pipe-timeout"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="2056"><td class="num" id="LN2056">2056</td><td class="line">            config.pipe_timeout = atoi(argv[++i]);</td></tr>
<tr class="codeline" data-linenumber="2057"><td class="num" id="LN2057">2057</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--bigkeys"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2058"><td class="num" id="LN2058">2058</td><td class="line">            config.bigkeys = 1;</td></tr>
<tr class="codeline" data-linenumber="2059"><td class="num" id="LN2059">2059</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--memkeys"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2060"><td class="num" id="LN2060">2060</td><td class="line">            config.memkeys = 1;</td></tr>
<tr class="codeline" data-linenumber="2061"><td class="num" id="LN2061">2061</td><td class="line">            config.memkeys_samples = 0; <span class='comment'>/* use redis default */</span></td></tr>
<tr class="codeline" data-linenumber="2062"><td class="num" id="LN2062">2062</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--memkeys-samples"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2063"><td class="num" id="LN2063">2063</td><td class="line">            config.memkeys = 1;</td></tr>
<tr class="codeline" data-linenumber="2064"><td class="num" id="LN2064">2064</td><td class="line">            config.memkeys_samples = atoi(argv[++i]);</td></tr>
<tr class="codeline" data-linenumber="2065"><td class="num" id="LN2065">2065</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--hotkeys"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2066"><td class="num" id="LN2066">2066</td><td class="line">            config.hotkeys = 1;</td></tr>
<tr class="codeline" data-linenumber="2067"><td class="num" id="LN2067">2067</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--eval"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="2068"><td class="num" id="LN2068">2068</td><td class="line">            config.eval = argv[++i];</td></tr>
<tr class="codeline" data-linenumber="2069"><td class="num" id="LN2069">2069</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--ldb"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2070"><td class="num" id="LN2070">2070</td><td class="line">            config.eval_ldb = 1;</td></tr>
<tr class="codeline" data-linenumber="2071"><td class="num" id="LN2071">2071</td><td class="line">            config.output = <span class='macro'>OUTPUT_RAW<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2072"><td class="num" id="LN2072">2072</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--ldb-sync-mode"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2073"><td class="num" id="LN2073">2073</td><td class="line">            config.eval_ldb = 1;</td></tr>
<tr class="codeline" data-linenumber="2074"><td class="num" id="LN2074">2074</td><td class="line">            config.eval_ldb_sync = 1;</td></tr>
<tr class="codeline" data-linenumber="2075"><td class="num" id="LN2075">2075</td><td class="line">            config.output = <span class='macro'>OUTPUT_RAW<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2076"><td class="num" id="LN2076">2076</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"-c"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2077"><td class="num" id="LN2077">2077</td><td class="line">            config.cluster_mode = 1;</td></tr>
<tr class="codeline" data-linenumber="2078"><td class="num" id="LN2078">2078</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"-d"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="2079"><td class="num" id="LN2079">2079</td><td class="line">            <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(config.mb_delim);</td></tr>
<tr class="codeline" data-linenumber="2080"><td class="num" id="LN2080">2080</td><td class="line">            config.mb_delim = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(argv[++i]);</td></tr>
<tr class="codeline" data-linenumber="2081"><td class="num" id="LN2081">2081</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"-D"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="2082"><td class="num" id="LN2082">2082</td><td class="line">            <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(config.cmd_delim);</td></tr>
<tr class="codeline" data-linenumber="2083"><td class="num" id="LN2083">2083</td><td class="line">            config.cmd_delim = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(argv[++i]);</td></tr>
<tr class="codeline" data-linenumber="2084"><td class="num" id="LN2084">2084</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"-e"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2085"><td class="num" id="LN2085">2085</td><td class="line">            config.set_errcode = 1;</td></tr>
<tr class="codeline" data-linenumber="2086"><td class="num" id="LN2086">2086</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--verbose"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2087"><td class="num" id="LN2087">2087</td><td class="line">            config.verbose = 1;</td></tr>
<tr class="codeline" data-linenumber="2088"><td class="num" id="LN2088">2088</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--cluster"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="2089"><td class="num" id="LN2089">2089</td><td class="line">            <span class='keyword'>if</span> (<span class='macro'>CLUSTER_MANAGER_MODE()<span class='macro_popup'>(config.cluster_manager_command.name != ((void*)0))</span></span>) usage(1);</td></tr>
<tr class="codeline" data-linenumber="2090"><td class="num" id="LN2090">2090</td><td class="line">            <span class='keyword'>char</span> *cmd = argv[++i];</td></tr>
<tr class="codeline" data-linenumber="2091"><td class="num" id="LN2091">2091</td><td class="line">            <span class='keyword'>int</span> j = i;</td></tr>
<tr class="codeline" data-linenumber="2092"><td class="num" id="LN2092">2092</td><td class="line">            <span class='keyword'>while</span> (j &lt; argc &amp;&amp; argv[j][0] != '-') j++;</td></tr>
<tr class="codeline" data-linenumber="2093"><td class="num" id="LN2093">2093</td><td class="line">            <span class='keyword'>if</span> (j &gt; i) j--;</td></tr>
<tr class="codeline" data-linenumber="2094"><td class="num" id="LN2094">2094</td><td class="line">            <span class='keyword'>int</span> err = createClusterManagerCommand(cmd, j - i, argv + i + 1);</td></tr>
<tr class="codeline" data-linenumber="2095"><td class="num" id="LN2095">2095</td><td class="line">            <span class='keyword'>if</span> (err) exit(err);</td></tr>
<tr class="codeline" data-linenumber="2096"><td class="num" id="LN2096">2096</td><td class="line">            i = j;</td></tr>
<tr class="codeline" data-linenumber="2097"><td class="num" id="LN2097">2097</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--cluster"</span>) &amp;&amp; lastarg) {</td></tr>
<tr class="codeline" data-linenumber="2098"><td class="num" id="LN2098">2098</td><td class="line">            usage(1);</td></tr>
<tr class="codeline" data-linenumber="2099"><td class="num" id="LN2099">2099</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> ((!strcmp(argv[i],<span class='string_literal'>"--cluster-only-masters"</span>))) {</td></tr>
<tr class="codeline" data-linenumber="2100"><td class="num" id="LN2100">2100</td><td class="line">            config.cluster_manager_command.flags |=</td></tr>
<tr class="codeline" data-linenumber="2101"><td class="num" id="LN2101">2101</td><td class="line">                    <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_MASTERS_ONLY<span class='macro_popup'>1 &lt;&lt; 11</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2102"><td class="num" id="LN2102">2102</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> ((!strcmp(argv[i],<span class='string_literal'>"--cluster-only-replicas"</span>))) {</td></tr>
<tr class="codeline" data-linenumber="2103"><td class="num" id="LN2103">2103</td><td class="line">            config.cluster_manager_command.flags |=</td></tr>
<tr class="codeline" data-linenumber="2104"><td class="num" id="LN2104">2104</td><td class="line">                    <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_SLAVES_ONLY<span class='macro_popup'>1 &lt;&lt; 12</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2105"><td class="num" id="LN2105">2105</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--cluster-replicas"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="2106"><td class="num" id="LN2106">2106</td><td class="line">            config.cluster_manager_command.replicas = atoi(argv[++i]);</td></tr>
<tr class="codeline" data-linenumber="2107"><td class="num" id="LN2107">2107</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--cluster-master-id"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="2108"><td class="num" id="LN2108">2108</td><td class="line">            config.cluster_manager_command.master_id = argv[++i];</td></tr>
<tr class="codeline" data-linenumber="2109"><td class="num" id="LN2109">2109</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--cluster-from"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="2110"><td class="num" id="LN2110">2110</td><td class="line">            config.cluster_manager_command.from = argv[++i];</td></tr>
<tr class="codeline" data-linenumber="2111"><td class="num" id="LN2111">2111</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--cluster-to"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="2112"><td class="num" id="LN2112">2112</td><td class="line">            config.cluster_manager_command.to = argv[++i];</td></tr>
<tr class="codeline" data-linenumber="2113"><td class="num" id="LN2113">2113</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--cluster-from-user"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="2114"><td class="num" id="LN2114">2114</td><td class="line">            config.cluster_manager_command.from_user = argv[++i];</td></tr>
<tr class="codeline" data-linenumber="2115"><td class="num" id="LN2115">2115</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--cluster-from-pass"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="2116"><td class="num" id="LN2116">2116</td><td class="line">            config.cluster_manager_command.from_pass = argv[++i];</td></tr>
<tr class="codeline" data-linenumber="2117"><td class="num" id="LN2117">2117</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i], <span class='string_literal'>"--cluster-from-askpass"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2118"><td class="num" id="LN2118">2118</td><td class="line">            config.cluster_manager_command.from_askpass = 1;</td></tr>
<tr class="codeline" data-linenumber="2119"><td class="num" id="LN2119">2119</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--cluster-weight"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="2120"><td class="num" id="LN2120">2120</td><td class="line">            <span class='keyword'>if</span> (config.cluster_manager_command.weight != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2121"><td class="num" id="LN2121">2121</td><td class="line">                fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"WARNING: you cannot use --cluster-weight "</span></td></tr>
<tr class="codeline" data-linenumber="2122"><td class="num" id="LN2122">2122</td><td class="line">                                <span class='string_literal'>"more than once.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2123"><td class="num" id="LN2123">2123</td><td class="line">                                <span class='string_literal'>"You can set more weights by adding them "</span></td></tr>
<tr class="codeline" data-linenumber="2124"><td class="num" id="LN2124">2124</td><td class="line">                                <span class='string_literal'>"as a space-separated list, ie:\n"</span></td></tr>
<tr class="codeline" data-linenumber="2125"><td class="num" id="LN2125">2125</td><td class="line">                                <span class='string_literal'>"--cluster-weight n1=w n2=w\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="2126"><td class="num" id="LN2126">2126</td><td class="line">                exit(1);</td></tr>
<tr class="codeline" data-linenumber="2127"><td class="num" id="LN2127">2127</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2128"><td class="num" id="LN2128">2128</td><td class="line">            <span class='keyword'>int</span> widx = i + 1;</td></tr>
<tr class="codeline" data-linenumber="2129"><td class="num" id="LN2129">2129</td><td class="line">            <span class='keyword'>char</span> **weight = argv + widx;</td></tr>
<tr class="codeline" data-linenumber="2130"><td class="num" id="LN2130">2130</td><td class="line">            <span class='keyword'>int</span> wargc = 0;</td></tr>
<tr class="codeline" data-linenumber="2131"><td class="num" id="LN2131">2131</td><td class="line">            <span class='keyword'>for</span> (; widx &lt; argc; widx++) {</td></tr>
<tr class="codeline" data-linenumber="2132"><td class="num" id="LN2132">2132</td><td class="line">                <span class='keyword'>if</span> (strstr(argv[widx], <span class='string_literal'>"--"</span>) == argv[widx]) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2133"><td class="num" id="LN2133">2133</td><td class="line">                <span class='keyword'>if</span> (strchr(argv[widx], '=') == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2134"><td class="num" id="LN2134">2134</td><td class="line">                wargc++;</td></tr>
<tr class="codeline" data-linenumber="2135"><td class="num" id="LN2135">2135</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2136"><td class="num" id="LN2136">2136</td><td class="line">            <span class='keyword'>if</span> (wargc &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="2137"><td class="num" id="LN2137">2137</td><td class="line">                config.cluster_manager_command.weight = weight;</td></tr>
<tr class="codeline" data-linenumber="2138"><td class="num" id="LN2138">2138</td><td class="line">                config.cluster_manager_command.weight_argc = wargc;</td></tr>
<tr class="codeline" data-linenumber="2139"><td class="num" id="LN2139">2139</td><td class="line">                i += wargc;</td></tr>
<tr class="codeline" data-linenumber="2140"><td class="num" id="LN2140">2140</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2141"><td class="num" id="LN2141">2141</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--cluster-slots"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="2142"><td class="num" id="LN2142">2142</td><td class="line">            config.cluster_manager_command.slots = atoi(argv[++i]);</td></tr>
<tr class="codeline" data-linenumber="2143"><td class="num" id="LN2143">2143</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--cluster-timeout"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="2144"><td class="num" id="LN2144">2144</td><td class="line">            config.cluster_manager_command.timeout = atoi(argv[++i]);</td></tr>
<tr class="codeline" data-linenumber="2145"><td class="num" id="LN2145">2145</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--cluster-pipeline"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="2146"><td class="num" id="LN2146">2146</td><td class="line">            config.cluster_manager_command.pipeline = atoi(argv[++i]);</td></tr>
<tr class="codeline" data-linenumber="2147"><td class="num" id="LN2147">2147</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--cluster-threshold"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="2148"><td class="num" id="LN2148">2148</td><td class="line">            config.cluster_manager_command.threshold = atof(argv[++i]);</td></tr>
<tr class="codeline" data-linenumber="2149"><td class="num" id="LN2149">2149</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--cluster-yes"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2150"><td class="num" id="LN2150">2150</td><td class="line">            config.cluster_manager_command.flags |=</td></tr>
<tr class="codeline" data-linenumber="2151"><td class="num" id="LN2151">2151</td><td class="line">                <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_YES<span class='macro_popup'>1 &lt;&lt; 2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2152"><td class="num" id="LN2152">2152</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--cluster-simulate"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2153"><td class="num" id="LN2153">2153</td><td class="line">            config.cluster_manager_command.flags |=</td></tr>
<tr class="codeline" data-linenumber="2154"><td class="num" id="LN2154">2154</td><td class="line">                <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_SIMULATE<span class='macro_popup'>1 &lt;&lt; 5</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2155"><td class="num" id="LN2155">2155</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--cluster-replace"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2156"><td class="num" id="LN2156">2156</td><td class="line">            config.cluster_manager_command.flags |=</td></tr>
<tr class="codeline" data-linenumber="2157"><td class="num" id="LN2157">2157</td><td class="line">                <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_REPLACE<span class='macro_popup'>1 &lt;&lt; 6</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2158"><td class="num" id="LN2158">2158</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--cluster-copy"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2159"><td class="num" id="LN2159">2159</td><td class="line">            config.cluster_manager_command.flags |=</td></tr>
<tr class="codeline" data-linenumber="2160"><td class="num" id="LN2160">2160</td><td class="line">                <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_COPY<span class='macro_popup'>1 &lt;&lt; 7</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2161"><td class="num" id="LN2161">2161</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--cluster-slave"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2162"><td class="num" id="LN2162">2162</td><td class="line">            config.cluster_manager_command.flags |=</td></tr>
<tr class="codeline" data-linenumber="2163"><td class="num" id="LN2163">2163</td><td class="line">                <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_SLAVE<span class='macro_popup'>1 &lt;&lt; 1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2164"><td class="num" id="LN2164">2164</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--cluster-use-empty-masters"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2165"><td class="num" id="LN2165">2165</td><td class="line">            config.cluster_manager_command.flags |=</td></tr>
<tr class="codeline" data-linenumber="2166"><td class="num" id="LN2166">2166</td><td class="line">                <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_EMPTYMASTER<span class='macro_popup'>1 &lt;&lt; 4</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2167"><td class="num" id="LN2167">2167</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--cluster-search-multiple-owners"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2168"><td class="num" id="LN2168">2168</td><td class="line">            config.cluster_manager_command.flags |=</td></tr>
<tr class="codeline" data-linenumber="2169"><td class="num" id="LN2169">2169</td><td class="line">                <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_CHECK_OWNERS<span class='macro_popup'>1 &lt;&lt; 9</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2170"><td class="num" id="LN2170">2170</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--cluster-fix-with-unreachable-masters"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2171"><td class="num" id="LN2171">2171</td><td class="line">            config.cluster_manager_command.flags |=</td></tr>
<tr class="codeline" data-linenumber="2172"><td class="num" id="LN2172">2172</td><td class="line">                <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_FIX_WITH_UNREACHABLE_MASTERS<span class='macro_popup'>1 &lt;&lt; 10</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2173"><td class="num" id="LN2173">2173</td><td class="line"><span class='directive'>#ifdef USE_OPENSSL</span></td></tr>
<tr class="codeline" data-linenumber="2174"><td class="num" id="LN2174">2174</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--tls"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2175"><td class="num" id="LN2175">2175</td><td class="line">            config.tls = 1;</td></tr>
<tr class="codeline" data-linenumber="2176"><td class="num" id="LN2176">2176</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--sni"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="2177"><td class="num" id="LN2177">2177</td><td class="line">            config.sslconfig.sni = argv[++i];</td></tr>
<tr class="codeline" data-linenumber="2178"><td class="num" id="LN2178">2178</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--cacertdir"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="2179"><td class="num" id="LN2179">2179</td><td class="line">            config.sslconfig.cacertdir = argv[++i];</td></tr>
<tr class="codeline" data-linenumber="2180"><td class="num" id="LN2180">2180</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--cacert"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="2181"><td class="num" id="LN2181">2181</td><td class="line">            config.sslconfig.cacert = argv[++i];</td></tr>
<tr class="codeline" data-linenumber="2182"><td class="num" id="LN2182">2182</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--cert"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="2183"><td class="num" id="LN2183">2183</td><td class="line">            config.sslconfig.cert = argv[++i];</td></tr>
<tr class="codeline" data-linenumber="2184"><td class="num" id="LN2184">2184</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--key"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="2185"><td class="num" id="LN2185">2185</td><td class="line">            config.sslconfig.key = argv[++i];</td></tr>
<tr class="codeline" data-linenumber="2186"><td class="num" id="LN2186">2186</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--tls-ciphers"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="2187"><td class="num" id="LN2187">2187</td><td class="line">            config.sslconfig.ciphers = argv[++i];</td></tr>
<tr class="codeline" data-linenumber="2188"><td class="num" id="LN2188">2188</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--insecure"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2189"><td class="num" id="LN2189">2189</td><td class="line">            config.sslconfig.skip_cert_verify = 1;</td></tr>
<tr class="codeline" data-linenumber="2190"><td class="num" id="LN2190">2190</td><td class="line">        <span class='directive'>#ifdef TLS1_3_VERSION</span></td></tr>
<tr class="codeline" data-linenumber="2191"><td class="num" id="LN2191">2191</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--tls-ciphersuites"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="2192"><td class="num" id="LN2192">2192</td><td class="line">            config.sslconfig.ciphersuites = argv[++i];</td></tr>
<tr class="codeline" data-linenumber="2193"><td class="num" id="LN2193">2193</td><td class="line">        <span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2194"><td class="num" id="LN2194">2194</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2195"><td class="num" id="LN2195">2195</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"-v"</span>) || !strcmp(argv[i], <span class='string_literal'>"--version"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2196"><td class="num" id="LN2196">2196</td><td class="line">            <span class='macro'>sds<span class='macro_popup'>hisds</span></span> version = cliVersion();</td></tr>
<tr class="codeline" data-linenumber="2197"><td class="num" id="LN2197">2197</td><td class="line">            printf(<span class='string_literal'>"redis-cli %s\n"</span>, version);</td></tr>
<tr class="codeline" data-linenumber="2198"><td class="num" id="LN2198">2198</td><td class="line">            <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(version);</td></tr>
<tr class="codeline" data-linenumber="2199"><td class="num" id="LN2199">2199</td><td class="line">            exit(0);</td></tr>
<tr class="codeline" data-linenumber="2200"><td class="num" id="LN2200">2200</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"-2"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2201"><td class="num" id="LN2201">2201</td><td class="line">            config.resp2 = 1;</td></tr>
<tr class="codeline" data-linenumber="2202"><td class="num" id="LN2202">2202</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"-3"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2203"><td class="num" id="LN2203">2203</td><td class="line">            config.resp3 = 1;</td></tr>
<tr class="codeline" data-linenumber="2204"><td class="num" id="LN2204">2204</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(argv[i],<span class='string_literal'>"--show-pushes"</span>) &amp;&amp; !lastarg) {</td></tr>
<tr class="codeline" data-linenumber="2205"><td class="num" id="LN2205">2205</td><td class="line">            <span class='keyword'>char</span> *argval = argv[++i];</td></tr>
<tr class="codeline" data-linenumber="2206"><td class="num" id="LN2206">2206</td><td class="line">            <span class='keyword'>if</span> (!strncasecmp(argval, <span class='string_literal'>"n"</span>, 1)) {</td></tr>
<tr class="codeline" data-linenumber="2207"><td class="num" id="LN2207">2207</td><td class="line">                config.push_output = 0;</td></tr>
<tr class="codeline" data-linenumber="2208"><td class="num" id="LN2208">2208</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strncasecmp(argval, <span class='string_literal'>"y"</span>, 1)) {</td></tr>
<tr class="codeline" data-linenumber="2209"><td class="num" id="LN2209">2209</td><td class="line">                config.push_output = 1;</td></tr>
<tr class="codeline" data-linenumber="2210"><td class="num" id="LN2210">2210</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2211"><td class="num" id="LN2211">2211</td><td class="line">                fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Unknown --show-pushes value '%s' "</span></td></tr>
<tr class="codeline" data-linenumber="2212"><td class="num" id="LN2212">2212</td><td class="line">                        <span class='string_literal'>"(valid: '[y]es', '[n]o')\n"</span>, argval);</td></tr>
<tr class="codeline" data-linenumber="2213"><td class="num" id="LN2213">2213</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2214"><td class="num" id="LN2214">2214</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (<span class='macro'>CLUSTER_MANAGER_MODE()<span class='macro_popup'>(config.cluster_manager_command.name != ((void*)0))</span></span> &amp;&amp; argv[i][0] != '-') {</td></tr>
<tr class="codeline" data-linenumber="2215"><td class="num" id="LN2215">2215</td><td class="line">            <span class='keyword'>if</span> (config.cluster_manager_command.argc == 0) {</td></tr>
<tr class="codeline" data-linenumber="2216"><td class="num" id="LN2216">2216</td><td class="line">                <span class='keyword'>int</span> j = i + 1;</td></tr>
<tr class="codeline" data-linenumber="2217"><td class="num" id="LN2217">2217</td><td class="line">                <span class='keyword'>while</span> (j &lt; argc &amp;&amp; argv[j][0] != '-') j++;</td></tr>
<tr class="codeline" data-linenumber="2218"><td class="num" id="LN2218">2218</td><td class="line">                <span class='keyword'>int</span> cmd_argc = j - i;</td></tr>
<tr class="codeline" data-linenumber="2219"><td class="num" id="LN2219">2219</td><td class="line">                config.cluster_manager_command.argc = cmd_argc;</td></tr>
<tr class="codeline" data-linenumber="2220"><td class="num" id="LN2220">2220</td><td class="line">                config.cluster_manager_command.argv = argv + i;</td></tr>
<tr class="codeline" data-linenumber="2221"><td class="num" id="LN2221">2221</td><td class="line">                <span class='keyword'>if</span> (cmd_argc &gt; 1) i = j - 1;</td></tr>
<tr class="codeline" data-linenumber="2222"><td class="num" id="LN2222">2222</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2223"><td class="num" id="LN2223">2223</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2224"><td class="num" id="LN2224">2224</td><td class="line">            <span class='keyword'>if</span> (argv[i][0] == '-') {</td></tr>
<tr class="codeline" data-linenumber="2225"><td class="num" id="LN2225">2225</td><td class="line">                fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2226"><td class="num" id="LN2226">2226</td><td class="line">                    <span class='string_literal'>"Unrecognized option or bad number of args for: '%s'\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="2227"><td class="num" id="LN2227">2227</td><td class="line">                    argv[i]);</td></tr>
<tr class="codeline" data-linenumber="2228"><td class="num" id="LN2228">2228</td><td class="line">                exit(1);</td></tr>
<tr class="codeline" data-linenumber="2229"><td class="num" id="LN2229">2229</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2230"><td class="num" id="LN2230">2230</td><td class="line">                <span class='comment'>/* Likely the command name, stop here. */</span></td></tr>
<tr class="codeline" data-linenumber="2231"><td class="num" id="LN2231">2231</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2232"><td class="num" id="LN2232">2232</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2233"><td class="num" id="LN2233">2233</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2234"><td class="num" id="LN2234">2234</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2235"><td class="num" id="LN2235">2235</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2236"><td class="num" id="LN2236">2236</td><td class="line">    <span class='keyword'>if</span> (config.hostsocket &amp;&amp; config.cluster_mode) {</td></tr>
<tr class="codeline" data-linenumber="2237"><td class="num" id="LN2237">2237</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"Options -c and -s are mutually exclusive.\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="2238"><td class="num" id="LN2238">2238</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="2239"><td class="num" id="LN2239">2239</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2240"><td class="num" id="LN2240">2240</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2241"><td class="num" id="LN2241">2241</td><td class="line">    <span class='keyword'>if</span> (config.resp2 &amp;&amp; config.resp3 == 1) {</td></tr>
<tr class="codeline" data-linenumber="2242"><td class="num" id="LN2242">2242</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"Options -2 and -3 are mutually exclusive.\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="2243"><td class="num" id="LN2243">2243</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="2244"><td class="num" id="LN2244">2244</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2245"><td class="num" id="LN2245">2245</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2246"><td class="num" id="LN2246">2246</td><td class="line">    <span class='comment'>/* --ldb requires --eval. */</span></td></tr>
<tr class="codeline" data-linenumber="2247"><td class="num" id="LN2247">2247</td><td class="line">    <span class='keyword'>if</span> (config.eval_ldb &amp;&amp; config.eval == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2248"><td class="num" id="LN2248">2248</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"Options --ldb and --ldb-sync-mode require --eval.\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="2249"><td class="num" id="LN2249">2249</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"Try %s --help for more information.\n"</span>, argv[0]);</td></tr>
<tr class="codeline" data-linenumber="2250"><td class="num" id="LN2250">2250</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="2251"><td class="num" id="LN2251">2251</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2252"><td class="num" id="LN2252">2252</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2253"><td class="num" id="LN2253">2253</td><td class="line">    <span class='keyword'>if</span> (!config.no_auth_warning &amp;&amp; config.conn_info.auth != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2254"><td class="num" id="LN2254">2254</td><td class="line">        fputs(<span class='string_literal'>"Warning: Using a password with '-a' or '-u' option on the command"</span></td></tr>
<tr class="codeline" data-linenumber="2255"><td class="num" id="LN2255">2255</td><td class="line">              <span class='string_literal'>" line interface may not be safe.\n"</span>, <span class='macro'>stderr<span class='macro_popup'>stderr</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2256"><td class="num" id="LN2256">2256</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2257"><td class="num" id="LN2257">2257</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2258"><td class="num" id="LN2258">2258</td><td class="line">    <span class='keyword'>if</span> (config.get_functions_rdb_mode &amp;&amp; config.getrdb_mode) {</td></tr>
<tr class="codeline" data-linenumber="2259"><td class="num" id="LN2259">2259</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"Option --functions-rdb and --rdb are mutually exclusive.\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="2260"><td class="num" id="LN2260">2260</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="2261"><td class="num" id="LN2261">2261</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2262"><td class="num" id="LN2262">2262</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2263"><td class="num" id="LN2263">2263</td><td class="line">    <span class='keyword'>if</span> (config.stdin_lastarg &amp;&amp; config.stdin_tag_arg) {</td></tr>
<tr class="codeline" data-linenumber="2264"><td class="num" id="LN2264">2264</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Options -x and -X are mutually exclusive.\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="2265"><td class="num" id="LN2265">2265</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="2266"><td class="num" id="LN2266">2266</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2267"><td class="num" id="LN2267">2267</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2268"><td class="num" id="LN2268">2268</td><td class="line">    <span class='keyword'>return</span> i;</td></tr>
<tr class="codeline" data-linenumber="2269"><td class="num" id="LN2269">2269</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2270"><td class="num" id="LN2270">2270</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2271"><td class="num" id="LN2271">2271</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> parseEnv() {</td></tr>
<tr class="codeline" data-linenumber="2272"><td class="num" id="LN2272">2272</td><td class="line">    <span class='comment'>/* Set auth from env, but do not overwrite CLI arguments if passed */</span></td></tr>
<tr class="codeline" data-linenumber="2273"><td class="num" id="LN2273">2273</td><td class="line">    <span class='keyword'>char</span> *auth = getenv(<span class='macro'>REDIS_CLI_AUTH_ENV<span class='macro_popup'>"REDISCLI_AUTH"</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2274"><td class="num" id="LN2274">2274</td><td class="line">    <span class='keyword'>if</span> (auth != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> &amp;&amp; config.conn_info.auth == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2275"><td class="num" id="LN2275">2275</td><td class="line">        config.conn_info.auth = auth;</td></tr>
<tr class="codeline" data-linenumber="2276"><td class="num" id="LN2276">2276</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2277"><td class="num" id="LN2277">2277</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2278"><td class="num" id="LN2278">2278</td><td class="line">    <span class='keyword'>char</span> *cluster_yes = getenv(<span class='macro'>REDIS_CLI_CLUSTER_YES_ENV<span class='macro_popup'>"REDISCLI_CLUSTER_YES"</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2279"><td class="num" id="LN2279">2279</td><td class="line">    <span class='keyword'>if</span> (cluster_yes != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> &amp;&amp; !strcmp(cluster_yes, <span class='string_literal'>"1"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2280"><td class="num" id="LN2280">2280</td><td class="line">        config.cluster_manager_command.flags |= <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_YES<span class='macro_popup'>1 &lt;&lt; 2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2281"><td class="num" id="LN2281">2281</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2282"><td class="num" id="LN2282">2282</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2283"><td class="num" id="LN2283">2283</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2284"><td class="num" id="LN2284">2284</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> usage(<span class='keyword'>int</span> err) {</td></tr>
<tr class="codeline" data-linenumber="2285"><td class="num" id="LN2285">2285</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> version = cliVersion();</td></tr>
<tr class="codeline" data-linenumber="2286"><td class="num" id="LN2286">2286</td><td class="line">    FILE *target = err ? <span class='macro'>stderr<span class='macro_popup'>stderr</span></span>: <span class='macro'>stdout<span class='macro_popup'>stdout</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2287"><td class="num" id="LN2287">2287</td><td class="line">    fprintf(target,</td></tr>
<tr class="codeline" data-linenumber="2288"><td class="num" id="LN2288">2288</td><td class="line"><span class='string_literal'>"redis-cli %s\n"</span></td></tr>
<tr class="codeline" data-linenumber="2289"><td class="num" id="LN2289">2289</td><td class="line"><span class='string_literal'>"\n"</span></td></tr>
<tr class="codeline" data-linenumber="2290"><td class="num" id="LN2290">2290</td><td class="line"><span class='string_literal'>"Usage: redis-cli [OPTIONS] [cmd [arg [arg ...]]]\n"</span></td></tr>
<tr class="codeline" data-linenumber="2291"><td class="num" id="LN2291">2291</td><td class="line"><span class='string_literal'>"  -h &lt;hostname&gt;      Server hostname (default: 127.0.0.1).\n"</span></td></tr>
<tr class="codeline" data-linenumber="2292"><td class="num" id="LN2292">2292</td><td class="line"><span class='string_literal'>"  -p &lt;port&gt;          Server port (default: 6379).\n"</span></td></tr>
<tr class="codeline" data-linenumber="2293"><td class="num" id="LN2293">2293</td><td class="line"><span class='string_literal'>"  -s &lt;socket&gt;        Server socket (overrides hostname and port).\n"</span></td></tr>
<tr class="codeline" data-linenumber="2294"><td class="num" id="LN2294">2294</td><td class="line"><span class='string_literal'>"  -a &lt;password&gt;      Password to use when connecting to the server.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2295"><td class="num" id="LN2295">2295</td><td class="line"><span class='string_literal'>"                     You can also use the "</span> <span class='macro'>REDIS_CLI_AUTH_ENV<span class='macro_popup'>"REDISCLI_AUTH"</span></span> <span class='string_literal'>" environment\n"</span></td></tr>
<tr class="codeline" data-linenumber="2296"><td class="num" id="LN2296">2296</td><td class="line"><span class='string_literal'>"                     variable to pass this password more safely\n"</span></td></tr>
<tr class="codeline" data-linenumber="2297"><td class="num" id="LN2297">2297</td><td class="line"><span class='string_literal'>"                     (if both are used, this argument takes precedence).\n"</span></td></tr>
<tr class="codeline" data-linenumber="2298"><td class="num" id="LN2298">2298</td><td class="line"><span class='string_literal'>"  --user &lt;username&gt;  Used to send ACL style 'AUTH username pass'. Needs -a.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2299"><td class="num" id="LN2299">2299</td><td class="line"><span class='string_literal'>"  --pass &lt;password&gt;  Alias of -a for consistency with the new --user option.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2300"><td class="num" id="LN2300">2300</td><td class="line"><span class='string_literal'>"  --askpass          Force user to input password with mask from STDIN.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2301"><td class="num" id="LN2301">2301</td><td class="line"><span class='string_literal'>"                     If this argument is used, '-a' and "</span> <span class='macro'>REDIS_CLI_AUTH_ENV<span class='macro_popup'>"REDISCLI_AUTH"</span></span> <span class='string_literal'>"\n"</span></td></tr>
<tr class="codeline" data-linenumber="2302"><td class="num" id="LN2302">2302</td><td class="line"><span class='string_literal'>"                     environment variable will be ignored.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2303"><td class="num" id="LN2303">2303</td><td class="line"><span class='string_literal'>"  -u &lt;uri&gt;           Server URI.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2304"><td class="num" id="LN2304">2304</td><td class="line"><span class='string_literal'>"  -r &lt;repeat&gt;        Execute specified command N times.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2305"><td class="num" id="LN2305">2305</td><td class="line"><span class='string_literal'>"  -i &lt;interval&gt;      When -r is used, waits &lt;interval&gt; seconds per command.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2306"><td class="num" id="LN2306">2306</td><td class="line"><span class='string_literal'>"                     It is possible to specify sub-second times like -i 0.1.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2307"><td class="num" id="LN2307">2307</td><td class="line"><span class='string_literal'>"                     This interval is also used in --scan and --stat per cycle.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2308"><td class="num" id="LN2308">2308</td><td class="line"><span class='string_literal'>"                     and in --bigkeys, --memkeys, and --hotkeys per 100 cycles.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2309"><td class="num" id="LN2309">2309</td><td class="line"><span class='string_literal'>"  -n &lt;db&gt;            Database number.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2310"><td class="num" id="LN2310">2310</td><td class="line"><span class='string_literal'>"  -2                 Start session in RESP2 protocol mode.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2311"><td class="num" id="LN2311">2311</td><td class="line"><span class='string_literal'>"  -3                 Start session in RESP3 protocol mode.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2312"><td class="num" id="LN2312">2312</td><td class="line"><span class='string_literal'>"  -x                 Read last argument from STDIN (see example below).\n"</span></td></tr>
<tr class="codeline" data-linenumber="2313"><td class="num" id="LN2313">2313</td><td class="line"><span class='string_literal'>"  -X                 Read &lt;tag&gt; argument from STDIN (see example below).\n"</span></td></tr>
<tr class="codeline" data-linenumber="2314"><td class="num" id="LN2314">2314</td><td class="line"><span class='string_literal'>"  -d &lt;delimiter&gt;     Delimiter between response bulks for raw formatting (default: \\n).\n"</span></td></tr>
<tr class="codeline" data-linenumber="2315"><td class="num" id="LN2315">2315</td><td class="line"><span class='string_literal'>"  -D &lt;delimiter&gt;     Delimiter between responses for raw formatting (default: \\n).\n"</span></td></tr>
<tr class="codeline" data-linenumber="2316"><td class="num" id="LN2316">2316</td><td class="line"><span class='string_literal'>"  -c                 Enable cluster mode (follow -ASK and -MOVED redirections).\n"</span></td></tr>
<tr class="codeline" data-linenumber="2317"><td class="num" id="LN2317">2317</td><td class="line"><span class='string_literal'>"  -e                 Return exit error code when command execution fails.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2318"><td class="num" id="LN2318">2318</td><td class="line"><span class='directive'>#ifdef USE_OPENSSL</span></td></tr>
<tr class="codeline" data-linenumber="2319"><td class="num" id="LN2319">2319</td><td class="line"><span class='string_literal'>"  --tls              Establish a secure TLS connection.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2320"><td class="num" id="LN2320">2320</td><td class="line"><span class='string_literal'>"  --sni &lt;host&gt;       Server name indication for TLS.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2321"><td class="num" id="LN2321">2321</td><td class="line"><span class='string_literal'>"  --cacert &lt;file&gt;    CA Certificate file to verify with.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2322"><td class="num" id="LN2322">2322</td><td class="line"><span class='string_literal'>"  --cacertdir &lt;dir&gt;  Directory where trusted CA certificates are stored.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2323"><td class="num" id="LN2323">2323</td><td class="line"><span class='string_literal'>"                     If neither cacert nor cacertdir are specified, the default\n"</span></td></tr>
<tr class="codeline" data-linenumber="2324"><td class="num" id="LN2324">2324</td><td class="line"><span class='string_literal'>"                     system-wide trusted root certs configuration will apply.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2325"><td class="num" id="LN2325">2325</td><td class="line"><span class='string_literal'>"  --insecure         Allow insecure TLS connection by skipping cert validation.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2326"><td class="num" id="LN2326">2326</td><td class="line"><span class='string_literal'>"  --cert &lt;file&gt;      Client certificate to authenticate with.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2327"><td class="num" id="LN2327">2327</td><td class="line"><span class='string_literal'>"  --key &lt;file&gt;       Private key file to authenticate with.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2328"><td class="num" id="LN2328">2328</td><td class="line"><span class='string_literal'>"  --tls-ciphers &lt;list&gt; Sets the list of preferred ciphers (TLSv1.2 and below)\n"</span></td></tr>
<tr class="codeline" data-linenumber="2329"><td class="num" id="LN2329">2329</td><td class="line"><span class='string_literal'>"                     in order of preference from highest to lowest separated by colon (\":\").\n"</span></td></tr>
<tr class="codeline" data-linenumber="2330"><td class="num" id="LN2330">2330</td><td class="line"><span class='string_literal'>"                     See the ciphers(1ssl) manpage for more information about the syntax of this string.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2331"><td class="num" id="LN2331">2331</td><td class="line"><span class='directive'>#ifdef TLS1_3_VERSION</span></td></tr>
<tr class="codeline" data-linenumber="2332"><td class="num" id="LN2332">2332</td><td class="line"><span class='string_literal'>"  --tls-ciphersuites &lt;list&gt; Sets the list of preferred ciphersuites (TLSv1.3)\n"</span></td></tr>
<tr class="codeline" data-linenumber="2333"><td class="num" id="LN2333">2333</td><td class="line"><span class='string_literal'>"                     in order of preference from highest to lowest separated by colon (\":\").\n"</span></td></tr>
<tr class="codeline" data-linenumber="2334"><td class="num" id="LN2334">2334</td><td class="line"><span class='string_literal'>"                     See the ciphers(1ssl) manpage for more information about the syntax of this string,\n"</span></td></tr>
<tr class="codeline" data-linenumber="2335"><td class="num" id="LN2335">2335</td><td class="line"><span class='string_literal'>"                     and specifically for TLSv1.3 ciphersuites.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2336"><td class="num" id="LN2336">2336</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2337"><td class="num" id="LN2337">2337</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2338"><td class="num" id="LN2338">2338</td><td class="line"><span class='string_literal'>"  --raw              Use raw formatting for replies (default when STDOUT is\n"</span></td></tr>
<tr class="codeline" data-linenumber="2339"><td class="num" id="LN2339">2339</td><td class="line"><span class='string_literal'>"                     not a tty).\n"</span></td></tr>
<tr class="codeline" data-linenumber="2340"><td class="num" id="LN2340">2340</td><td class="line"><span class='string_literal'>"  --no-raw           Force formatted output even when STDOUT is not a tty.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2341"><td class="num" id="LN2341">2341</td><td class="line"><span class='string_literal'>"  --quoted-input     Force input to be handled as quoted strings.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2342"><td class="num" id="LN2342">2342</td><td class="line"><span class='string_literal'>"  --csv              Output in CSV format.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2343"><td class="num" id="LN2343">2343</td><td class="line"><span class='string_literal'>"  --json             Output in JSON format (default RESP3, use -2 if you want to use with RESP2).\n"</span></td></tr>
<tr class="codeline" data-linenumber="2344"><td class="num" id="LN2344">2344</td><td class="line"><span class='string_literal'>"  --quoted-json      Same as --json, but produce ASCII-safe quoted strings, not Unicode.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2345"><td class="num" id="LN2345">2345</td><td class="line"><span class='string_literal'>"  --show-pushes &lt;yn&gt; Whether to print RESP3 PUSH messages.  Enabled by default when\n"</span></td></tr>
<tr class="codeline" data-linenumber="2346"><td class="num" id="LN2346">2346</td><td class="line"><span class='string_literal'>"                     STDOUT is a tty but can be overridden with --show-pushes no.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2347"><td class="num" id="LN2347">2347</td><td class="line"><span class='string_literal'>"  --stat             Print rolling stats about server: mem, clients, ...\n"</span>,version);</td></tr>
<tr class="codeline" data-linenumber="2348"><td class="num" id="LN2348">2348</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2349"><td class="num" id="LN2349">2349</td><td class="line">    fprintf(target,</td></tr>
<tr class="codeline" data-linenumber="2350"><td class="num" id="LN2350">2350</td><td class="line"><span class='string_literal'>"  --latency          Enter a special mode continuously sampling latency.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2351"><td class="num" id="LN2351">2351</td><td class="line"><span class='string_literal'>"                     If you use this mode in an interactive session it runs\n"</span></td></tr>
<tr class="codeline" data-linenumber="2352"><td class="num" id="LN2352">2352</td><td class="line"><span class='string_literal'>"                     forever displaying real-time stats. Otherwise if --raw or\n"</span></td></tr>
<tr class="codeline" data-linenumber="2353"><td class="num" id="LN2353">2353</td><td class="line"><span class='string_literal'>"                     --csv is specified, or if you redirect the output to a non\n"</span></td></tr>
<tr class="codeline" data-linenumber="2354"><td class="num" id="LN2354">2354</td><td class="line"><span class='string_literal'>"                     TTY, it samples the latency for 1 second (you can use\n"</span></td></tr>
<tr class="codeline" data-linenumber="2355"><td class="num" id="LN2355">2355</td><td class="line"><span class='string_literal'>"                     -i to change the interval), then produces a single output\n"</span></td></tr>
<tr class="codeline" data-linenumber="2356"><td class="num" id="LN2356">2356</td><td class="line"><span class='string_literal'>"                     and exits.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2357"><td class="num" id="LN2357">2357</td><td class="line"><span class='string_literal'>"  --latency-history  Like --latency but tracking latency changes over time.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2358"><td class="num" id="LN2358">2358</td><td class="line"><span class='string_literal'>"                     Default time interval is 15 sec. Change it using -i.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2359"><td class="num" id="LN2359">2359</td><td class="line"><span class='string_literal'>"  --latency-dist     Shows latency as a spectrum, requires xterm 256 colors.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2360"><td class="num" id="LN2360">2360</td><td class="line"><span class='string_literal'>"                     Default time interval is 1 sec. Change it using -i.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2361"><td class="num" id="LN2361">2361</td><td class="line"><span class='string_literal'>"  --lru-test &lt;keys&gt;  Simulate a cache workload with an 80-20 distribution.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2362"><td class="num" id="LN2362">2362</td><td class="line"><span class='string_literal'>"  --replica          Simulate a replica showing commands received from the master.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2363"><td class="num" id="LN2363">2363</td><td class="line"><span class='string_literal'>"  --rdb &lt;filename&gt;   Transfer an RDB dump from remote server to local file.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2364"><td class="num" id="LN2364">2364</td><td class="line"><span class='string_literal'>"                     Use filename of \"-\" to write to stdout.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2365"><td class="num" id="LN2365">2365</td><td class="line"><span class='string_literal'>" --functions-rdb &lt;filename&gt; Like --rdb but only get the functions (not the keys)\n"</span></td></tr>
<tr class="codeline" data-linenumber="2366"><td class="num" id="LN2366">2366</td><td class="line"><span class='string_literal'>"                     when getting the RDB dump file.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2367"><td class="num" id="LN2367">2367</td><td class="line"><span class='string_literal'>"  --pipe             Transfer raw Redis protocol from stdin to server.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2368"><td class="num" id="LN2368">2368</td><td class="line"><span class='string_literal'>"  --pipe-timeout &lt;n&gt; In --pipe mode, abort with error if after sending all data.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2369"><td class="num" id="LN2369">2369</td><td class="line"><span class='string_literal'>"                     no reply is received within &lt;n&gt; seconds.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2370"><td class="num" id="LN2370">2370</td><td class="line"><span class='string_literal'>"                     Default timeout: %d. Use 0 to wait forever.\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="2371"><td class="num" id="LN2371">2371</td><td class="line">    <span class='macro'>REDIS_CLI_DEFAULT_PIPE_TIMEOUT<span class='macro_popup'>30</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2372"><td class="num" id="LN2372">2372</td><td class="line">    fprintf(target,</td></tr>
<tr class="codeline" data-linenumber="2373"><td class="num" id="LN2373">2373</td><td class="line"><span class='string_literal'>"  --bigkeys          Sample Redis keys looking for keys with many elements (complexity).\n"</span></td></tr>
<tr class="codeline" data-linenumber="2374"><td class="num" id="LN2374">2374</td><td class="line"><span class='string_literal'>"  --memkeys          Sample Redis keys looking for keys consuming a lot of memory.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2375"><td class="num" id="LN2375">2375</td><td class="line"><span class='string_literal'>"  --memkeys-samples &lt;n&gt; Sample Redis keys looking for keys consuming a lot of memory.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2376"><td class="num" id="LN2376">2376</td><td class="line"><span class='string_literal'>"                     And define number of key elements to sample\n"</span></td></tr>
<tr class="codeline" data-linenumber="2377"><td class="num" id="LN2377">2377</td><td class="line"><span class='string_literal'>"  --hotkeys          Sample Redis keys looking for hot keys.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2378"><td class="num" id="LN2378">2378</td><td class="line"><span class='string_literal'>"                     only works when maxmemory-policy is *lfu.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2379"><td class="num" id="LN2379">2379</td><td class="line"><span class='string_literal'>"  --scan             List all keys using the SCAN command.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2380"><td class="num" id="LN2380">2380</td><td class="line"><span class='string_literal'>"  --pattern &lt;pat&gt;    Keys pattern when using the --scan, --bigkeys or --hotkeys\n"</span></td></tr>
<tr class="codeline" data-linenumber="2381"><td class="num" id="LN2381">2381</td><td class="line"><span class='string_literal'>"                     options (default: *).\n"</span></td></tr>
<tr class="codeline" data-linenumber="2382"><td class="num" id="LN2382">2382</td><td class="line"><span class='string_literal'>"  --quoted-pattern &lt;pat&gt; Same as --pattern, but the specified string can be\n"</span></td></tr>
<tr class="codeline" data-linenumber="2383"><td class="num" id="LN2383">2383</td><td class="line"><span class='string_literal'>"                         quoted, in order to pass an otherwise non binary-safe string.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2384"><td class="num" id="LN2384">2384</td><td class="line"><span class='string_literal'>"  --intrinsic-latency &lt;sec&gt; Run a test to measure intrinsic system latency.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2385"><td class="num" id="LN2385">2385</td><td class="line"><span class='string_literal'>"                     The test will run for the specified amount of seconds.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2386"><td class="num" id="LN2386">2386</td><td class="line"><span class='string_literal'>"  --eval &lt;file&gt;      Send an EVAL command using the Lua script at &lt;file&gt;.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2387"><td class="num" id="LN2387">2387</td><td class="line"><span class='string_literal'>"  --ldb              Used with --eval enable the Redis Lua debugger.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2388"><td class="num" id="LN2388">2388</td><td class="line"><span class='string_literal'>"  --ldb-sync-mode    Like --ldb but uses the synchronous Lua debugger, in\n"</span></td></tr>
<tr class="codeline" data-linenumber="2389"><td class="num" id="LN2389">2389</td><td class="line"><span class='string_literal'>"                     this mode the server is blocked and script changes are\n"</span></td></tr>
<tr class="codeline" data-linenumber="2390"><td class="num" id="LN2390">2390</td><td class="line"><span class='string_literal'>"                     not rolled back from the server memory.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2391"><td class="num" id="LN2391">2391</td><td class="line"><span class='string_literal'>"  --cluster &lt;command&gt; [args...] [opts...]\n"</span></td></tr>
<tr class="codeline" data-linenumber="2392"><td class="num" id="LN2392">2392</td><td class="line"><span class='string_literal'>"                     Cluster Manager command and arguments (see below).\n"</span></td></tr>
<tr class="codeline" data-linenumber="2393"><td class="num" id="LN2393">2393</td><td class="line"><span class='string_literal'>"  --verbose          Verbose mode.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2394"><td class="num" id="LN2394">2394</td><td class="line"><span class='string_literal'>"  --no-auth-warning  Don't show warning message when using password on command\n"</span></td></tr>
<tr class="codeline" data-linenumber="2395"><td class="num" id="LN2395">2395</td><td class="line"><span class='string_literal'>"                     line interface.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2396"><td class="num" id="LN2396">2396</td><td class="line"><span class='string_literal'>"  --help             Output this help and exit.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2397"><td class="num" id="LN2397">2397</td><td class="line"><span class='string_literal'>"  --version          Output version and exit.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2398"><td class="num" id="LN2398">2398</td><td class="line"><span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="2399"><td class="num" id="LN2399">2399</td><td class="line">    <span class='comment'>/* Using another fprintf call to avoid -Woverlength-strings compile warning */</span></td></tr>
<tr class="codeline" data-linenumber="2400"><td class="num" id="LN2400">2400</td><td class="line">    fprintf(target,</td></tr>
<tr class="codeline" data-linenumber="2401"><td class="num" id="LN2401">2401</td><td class="line"><span class='string_literal'>"Cluster Manager Commands:\n"</span></td></tr>
<tr class="codeline" data-linenumber="2402"><td class="num" id="LN2402">2402</td><td class="line"><span class='string_literal'>"  Use --cluster help to list all available cluster manager commands.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2403"><td class="num" id="LN2403">2403</td><td class="line"><span class='string_literal'>"\n"</span></td></tr>
<tr class="codeline" data-linenumber="2404"><td class="num" id="LN2404">2404</td><td class="line"><span class='string_literal'>"Examples:\n"</span></td></tr>
<tr class="codeline" data-linenumber="2405"><td class="num" id="LN2405">2405</td><td class="line"><span class='string_literal'>"  cat /etc/passwd | redis-cli -x set mypasswd\n"</span></td></tr>
<tr class="codeline" data-linenumber="2406"><td class="num" id="LN2406">2406</td><td class="line"><span class='string_literal'>"  redis-cli -D \"\" --raw dump key &gt; key.dump &amp;&amp; redis-cli -X dump_tag restore key2 0 dump_tag replace &lt; key.dump\n"</span></td></tr>
<tr class="codeline" data-linenumber="2407"><td class="num" id="LN2407">2407</td><td class="line"><span class='string_literal'>"  redis-cli -r 100 lpush mylist x\n"</span></td></tr>
<tr class="codeline" data-linenumber="2408"><td class="num" id="LN2408">2408</td><td class="line"><span class='string_literal'>"  redis-cli -r 100 -i 1 info | grep used_memory_human:\n"</span></td></tr>
<tr class="codeline" data-linenumber="2409"><td class="num" id="LN2409">2409</td><td class="line"><span class='string_literal'>"  redis-cli --quoted-input set '\"null-\\x00-separated\"' value\n"</span></td></tr>
<tr class="codeline" data-linenumber="2410"><td class="num" id="LN2410">2410</td><td class="line"><span class='string_literal'>"  redis-cli --eval myscript.lua key1 key2 , arg1 arg2 arg3\n"</span></td></tr>
<tr class="codeline" data-linenumber="2411"><td class="num" id="LN2411">2411</td><td class="line"><span class='string_literal'>"  redis-cli --scan --pattern '*:12345*'\n"</span></td></tr>
<tr class="codeline" data-linenumber="2412"><td class="num" id="LN2412">2412</td><td class="line"><span class='string_literal'>"\n"</span></td></tr>
<tr class="codeline" data-linenumber="2413"><td class="num" id="LN2413">2413</td><td class="line"><span class='string_literal'>"  (Note: when using --eval the comma separates KEYS[] from ARGV[] items)\n"</span></td></tr>
<tr class="codeline" data-linenumber="2414"><td class="num" id="LN2414">2414</td><td class="line"><span class='string_literal'>"\n"</span></td></tr>
<tr class="codeline" data-linenumber="2415"><td class="num" id="LN2415">2415</td><td class="line"><span class='string_literal'>"When no command is given, redis-cli starts in interactive mode.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2416"><td class="num" id="LN2416">2416</td><td class="line"><span class='string_literal'>"Type \"help\" in interactive mode for information on available commands\n"</span></td></tr>
<tr class="codeline" data-linenumber="2417"><td class="num" id="LN2417">2417</td><td class="line"><span class='string_literal'>"and settings.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2418"><td class="num" id="LN2418">2418</td><td class="line"><span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="2419"><td class="num" id="LN2419">2419</td><td class="line">    <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(version);</td></tr>
<tr class="codeline" data-linenumber="2420"><td class="num" id="LN2420">2420</td><td class="line">    exit(err);</td></tr>
<tr class="codeline" data-linenumber="2421"><td class="num" id="LN2421">2421</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2422"><td class="num" id="LN2422">2422</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2423"><td class="num" id="LN2423">2423</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> confirmWithYes(<span class='keyword'>char</span> *msg, <span class='keyword'>int</span> ignore_force) {</td></tr>
<tr class="codeline" data-linenumber="2424"><td class="num" id="LN2424">2424</td><td class="line">    <span class='comment'>/* if --cluster-yes option is set and ignore_force is false,</span></td></tr>
<tr class="codeline" data-linenumber="2425"><td class="num" id="LN2425">2425</td><td class="line">     <span class='comment'>* do not prompt for an answer */</span></td></tr>
<tr class="codeline" data-linenumber="2426"><td class="num" id="LN2426">2426</td><td class="line">    <span class='keyword'>if</span> (!ignore_force &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2427"><td class="num" id="LN2427">2427</td><td class="line">        (config.cluster_manager_command.flags &amp; <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_YES<span class='macro_popup'>1 &lt;&lt; 2</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="2428"><td class="num" id="LN2428">2428</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2429"><td class="num" id="LN2429">2429</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2430"><td class="num" id="LN2430">2430</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2431"><td class="num" id="LN2431">2431</td><td class="line">    printf(<span class='string_literal'>"%s (type 'yes' to accept): "</span>, msg);</td></tr>
<tr class="codeline" data-linenumber="2432"><td class="num" id="LN2432">2432</td><td class="line">    fflush(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2433"><td class="num" id="LN2433">2433</td><td class="line">    <span class='keyword'>char</span> buf[4];</td></tr>
<tr class="codeline" data-linenumber="2434"><td class="num" id="LN2434">2434</td><td class="line">    <span class='keyword'>int</span> nread = read(fileno(<span class='macro'>stdin<span class='macro_popup'>stdin</span></span>),buf,4);</td></tr>
<tr class="codeline" data-linenumber="2435"><td class="num" id="LN2435">2435</td><td class="line">    buf[3] = '\0';</td></tr>
<tr class="codeline" data-linenumber="2436"><td class="num" id="LN2436">2436</td><td class="line">    <span class='keyword'>return</span> (nread != 0 &amp;&amp; !strcmp(<span class='string_literal'>"yes"</span>, buf));</td></tr>
<tr class="codeline" data-linenumber="2437"><td class="num" id="LN2437">2437</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2438"><td class="num" id="LN2438">2438</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2439"><td class="num" id="LN2439">2439</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> issueCommandRepeat(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv, <span class='keyword'>long</span> repeat) {</td></tr>
<tr class="codeline" data-linenumber="2440"><td class="num" id="LN2440">2440</td><td class="line">    <span class='comment'>/* In Lua debugging mode, we want to pass the "help" to Redis to get</span></td></tr>
<tr class="codeline" data-linenumber="2441"><td class="num" id="LN2441">2441</td><td class="line">     <span class='comment'>* it's own HELP message, rather than handle it by the CLI, see ldbRepl.</span></td></tr>
<tr class="codeline" data-linenumber="2442"><td class="num" id="LN2442">2442</td><td class="line">     <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2443"><td class="num" id="LN2443">2443</td><td class="line">     <span class='comment'>* For the normal Redis HELP, we can process it without a connection. */</span></td></tr>
<tr class="codeline" data-linenumber="2444"><td class="num" id="LN2444">2444</td><td class="line">    <span class='keyword'>if</span> (!config.eval_ldb &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2445"><td class="num" id="LN2445">2445</td><td class="line">        (!strcasecmp(argv[0],<span class='string_literal'>"help"</span>) || !strcasecmp(argv[0],<span class='string_literal'>"?"</span>)))</td></tr>
<tr class="codeline" data-linenumber="2446"><td class="num" id="LN2446">2446</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="2447"><td class="num" id="LN2447">2447</td><td class="line">        cliOutputHelp(--argc, ++argv);</td></tr>
<tr class="codeline" data-linenumber="2448"><td class="num" id="LN2448">2448</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2449"><td class="num" id="LN2449">2449</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2450"><td class="num" id="LN2450">2450</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2451"><td class="num" id="LN2451">2451</td><td class="line">    <span class='keyword'>while</span> (1) {</td></tr>
<tr class="codeline" data-linenumber="2452"><td class="num" id="LN2452">2452</td><td class="line">        <span class='keyword'>if</span> (config.cluster_reissue_command || context == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> ||</td></tr>
<tr class="codeline" data-linenumber="2453"><td class="num" id="LN2453">2453</td><td class="line">            context-&gt;err == <span class='macro'>REDIS_ERR_IO<span class='macro_popup'>1</span></span> || context-&gt;err == <span class='macro'>REDIS_ERR_EOF<span class='macro_popup'>3</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2454"><td class="num" id="LN2454">2454</td><td class="line">        {</td></tr>
<tr class="codeline" data-linenumber="2455"><td class="num" id="LN2455">2455</td><td class="line">            <span class='keyword'>if</span> (cliConnect(<span class='macro'>CC_FORCE<span class='macro_popup'>(1&lt;&lt;0)</span></span>) != <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2456"><td class="num" id="LN2456">2456</td><td class="line">                cliPrintContextError();</td></tr>
<tr class="codeline" data-linenumber="2457"><td class="num" id="LN2457">2457</td><td class="line">                config.cluster_reissue_command = 0;</td></tr>
<tr class="codeline" data-linenumber="2458"><td class="num" id="LN2458">2458</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2459"><td class="num" id="LN2459">2459</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2460"><td class="num" id="LN2460">2460</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2461"><td class="num" id="LN2461">2461</td><td class="line">        config.cluster_reissue_command = 0;</td></tr>
<tr class="codeline" data-linenumber="2462"><td class="num" id="LN2462">2462</td><td class="line">        <span class='keyword'>if</span> (config.cluster_send_asking) {</td></tr>
<tr class="codeline" data-linenumber="2463"><td class="num" id="LN2463">2463</td><td class="line">            <span class='keyword'>if</span> (cliSendAsking() != <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2464"><td class="num" id="LN2464">2464</td><td class="line">                cliPrintContextError();</td></tr>
<tr class="codeline" data-linenumber="2465"><td class="num" id="LN2465">2465</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2466"><td class="num" id="LN2466">2466</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2467"><td class="num" id="LN2467">2467</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2468"><td class="num" id="LN2468">2468</td><td class="line">        <span class='keyword'>if</span> (cliSendCommand(argc,argv,repeat) != <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2469"><td class="num" id="LN2469">2469</td><td class="line">            cliPrintContextError();</td></tr>
<tr class="codeline" data-linenumber="2470"><td class="num" id="LN2470">2470</td><td class="line">            redisFree(context);</td></tr>
<tr class="codeline" data-linenumber="2471"><td class="num" id="LN2471">2471</td><td class="line">            context = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2472"><td class="num" id="LN2472">2472</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2473"><td class="num" id="LN2473">2473</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2474"><td class="num" id="LN2474">2474</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2475"><td class="num" id="LN2475">2475</td><td class="line">        <span class='comment'>/* Issue the command again if we got redirected in cluster mode */</span></td></tr>
<tr class="codeline" data-linenumber="2476"><td class="num" id="LN2476">2476</td><td class="line">        <span class='keyword'>if</span> (config.cluster_mode &amp;&amp; config.cluster_reissue_command) {</td></tr>
<tr class="codeline" data-linenumber="2477"><td class="num" id="LN2477">2477</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="2478"><td class="num" id="LN2478">2478</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2479"><td class="num" id="LN2479">2479</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2480"><td class="num" id="LN2480">2480</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2481"><td class="num" id="LN2481">2481</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2482"><td class="num" id="LN2482">2482</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2483"><td class="num" id="LN2483">2483</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2484"><td class="num" id="LN2484">2484</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> issueCommand(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv) {</td></tr>
<tr class="codeline" data-linenumber="2485"><td class="num" id="LN2485">2485</td><td class="line">    <span class='keyword'>return</span> issueCommandRepeat(argc, argv, config.repeat);</td></tr>
<tr class="codeline" data-linenumber="2486"><td class="num" id="LN2486">2486</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2487"><td class="num" id="LN2487">2487</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2488"><td class="num" id="LN2488">2488</td><td class="line"><span class='comment'>/* Split the user provided command into multiple SDS arguments.</span></td></tr>
<tr class="codeline" data-linenumber="2489"><td class="num" id="LN2489">2489</td><td class="line"> <span class='comment'>* This function normally uses sdssplitargs() from sds.c which is able</span></td></tr>
<tr class="codeline" data-linenumber="2490"><td class="num" id="LN2490">2490</td><td class="line"> <span class='comment'>* to understand "quoted strings", escapes and so forth. However when</span></td></tr>
<tr class="codeline" data-linenumber="2491"><td class="num" id="LN2491">2491</td><td class="line"> <span class='comment'>* we are in Lua debugging mode and the "eval" command is used, we want</span></td></tr>
<tr class="codeline" data-linenumber="2492"><td class="num" id="LN2492">2492</td><td class="line"> <span class='comment'>* the remaining Lua script (after "e " or "eval ") to be passed verbatim</span></td></tr>
<tr class="codeline" data-linenumber="2493"><td class="num" id="LN2493">2493</td><td class="line"> <span class='comment'>* as a single big argument. */</span></td></tr>
<tr class="codeline" data-linenumber="2494"><td class="num" id="LN2494">2494</td><td class="line"><span class='keyword'>static</span> <span class='macro'>sds<span class='macro_popup'>hisds</span></span> *cliSplitArgs(<span class='keyword'>char</span> *line, <span class='keyword'>int</span> *argc) {</td></tr>
<tr class="codeline" data-linenumber="2495"><td class="num" id="LN2495">2495</td><td class="line">    <span class='keyword'>if</span> (config.eval_ldb &amp;&amp; (strstr(line,<span class='string_literal'>"eval "</span>) == line ||</td></tr>
<tr class="codeline" data-linenumber="2496"><td class="num" id="LN2496">2496</td><td class="line">                            strstr(line,<span class='string_literal'>"e "</span>) == line))</td></tr>
<tr class="codeline" data-linenumber="2497"><td class="num" id="LN2497">2497</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="2498"><td class="num" id="LN2498">2498</td><td class="line">        <span class='macro'>sds<span class='macro_popup'>hisds</span></span> *argv = <span class='macro'>sds_malloc<span class='macro_popup'>hi_sds_malloc</span></span>(<span class='keyword'>sizeof</span>(<span class='macro'>sds<span class='macro_popup'>hisds</span></span>)*2);</td></tr>
<tr class="codeline" data-linenumber="2499"><td class="num" id="LN2499">2499</td><td class="line">        *argc = 2;</td></tr>
<tr class="codeline" data-linenumber="2500"><td class="num" id="LN2500">2500</td><td class="line">        <span class='keyword'>int</span> len = strlen(line);</td></tr>
<tr class="codeline" data-linenumber="2501"><td class="num" id="LN2501">2501</td><td class="line">        <span class='keyword'>int</span> elen = line[1] == ' ' ? 2 : 5; <span class='comment'>/* "e " or "eval "? */</span></td></tr>
<tr class="codeline" data-linenumber="2502"><td class="num" id="LN2502">2502</td><td class="line">        argv[0] = <span class='macro'>sdsnewlen<span class='macro_popup'>hi_sdsnewlen</span></span>(line,elen-1);</td></tr>
<tr class="codeline" data-linenumber="2503"><td class="num" id="LN2503">2503</td><td class="line">        argv[1] = <span class='macro'>sdsnewlen<span class='macro_popup'>hi_sdsnewlen</span></span>(line+elen,len-elen);</td></tr>
<tr class="codeline" data-linenumber="2504"><td class="num" id="LN2504">2504</td><td class="line">        <span class='keyword'>return</span> argv;</td></tr>
<tr class="codeline" data-linenumber="2505"><td class="num" id="LN2505">2505</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2506"><td class="num" id="LN2506">2506</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>sdssplitargs<span class='macro_popup'>hi_sdssplitargs</span></span>(line,argc);</td></tr>
<tr class="codeline" data-linenumber="2507"><td class="num" id="LN2507">2507</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2508"><td class="num" id="LN2508">2508</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2509"><td class="num" id="LN2509">2509</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2510"><td class="num" id="LN2510">2510</td><td class="line"><span class='comment'>/* Set the CLI preferences. This function is invoked when an interactive</span></td></tr>
<tr class="codeline" data-linenumber="2511"><td class="num" id="LN2511">2511</td><td class="line"> <span class='comment'>* ":command" is called, or when reading ~/.redisclirc file, in order to</span></td></tr>
<tr class="codeline" data-linenumber="2512"><td class="num" id="LN2512">2512</td><td class="line"> <span class='comment'>* set user preferences. */</span></td></tr>
<tr class="codeline" data-linenumber="2513"><td class="num" id="LN2513">2513</td><td class="line"><span class='keyword'>void</span> cliSetPreferences(<span class='keyword'>char</span> **argv, <span class='keyword'>int</span> argc, <span class='keyword'>int</span> interactive) {</td></tr>
<tr class="codeline" data-linenumber="2514"><td class="num" id="LN2514">2514</td><td class="line">    <span class='keyword'>if</span> (!strcasecmp(argv[0],<span class='string_literal'>":set"</span>) &amp;&amp; argc &gt;= 2) {</td></tr>
<tr class="codeline" data-linenumber="2515"><td class="num" id="LN2515">2515</td><td class="line">        <span class='keyword'>if</span> (!strcasecmp(argv[1],<span class='string_literal'>"hints"</span>)) pref.hints = 1;</td></tr>
<tr class="codeline" data-linenumber="2516"><td class="num" id="LN2516">2516</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(argv[1],<span class='string_literal'>"nohints"</span>)) pref.hints = 0;</td></tr>
<tr class="codeline" data-linenumber="2517"><td class="num" id="LN2517">2517</td><td class="line">        <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2518"><td class="num" id="LN2518">2518</td><td class="line">            printf(<span class='string_literal'>"%sunknown redis-cli preference '%s'\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="2519"><td class="num" id="LN2519">2519</td><td class="line">                interactive ? <span class='string_literal'>""</span> : <span class='string_literal'>".redisclirc: "</span>,</td></tr>
<tr class="codeline" data-linenumber="2520"><td class="num" id="LN2520">2520</td><td class="line">                argv[1]);</td></tr>
<tr class="codeline" data-linenumber="2521"><td class="num" id="LN2521">2521</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2522"><td class="num" id="LN2522">2522</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2523"><td class="num" id="LN2523">2523</td><td class="line">        printf(<span class='string_literal'>"%sunknown redis-cli internal command '%s'\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="2524"><td class="num" id="LN2524">2524</td><td class="line">            interactive ? <span class='string_literal'>""</span> : <span class='string_literal'>".redisclirc: "</span>,</td></tr>
<tr class="codeline" data-linenumber="2525"><td class="num" id="LN2525">2525</td><td class="line">            argv[0]);</td></tr>
<tr class="codeline" data-linenumber="2526"><td class="num" id="LN2526">2526</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2527"><td class="num" id="LN2527">2527</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2528"><td class="num" id="LN2528">2528</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2529"><td class="num" id="LN2529">2529</td><td class="line"><span class='comment'>/* Load the ~/.redisclirc file if any. */</span></td></tr>
<tr class="codeline" data-linenumber="2530"><td class="num" id="LN2530">2530</td><td class="line"><span class='keyword'>void</span> cliLoadPreferences(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="2531"><td class="num" id="LN2531">2531</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> rcfile = getDotfilePath(<span class='macro'>REDIS_CLI_RCFILE_ENV<span class='macro_popup'>"REDISCLI_RCFILE"</span></span>,<span class='macro'>REDIS_CLI_RCFILE_DEFAULT<span class='macro_popup'>".redisclirc"</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2532"><td class="num" id="LN2532">2532</td><td class="line">    <span class='keyword'>if</span> (rcfile == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="2533"><td class="num" id="LN2533">2533</td><td class="line">    FILE *fp = fopen(rcfile,<span class='string_literal'>"r"</span>);</td></tr>
<tr class="codeline" data-linenumber="2534"><td class="num" id="LN2534">2534</td><td class="line">    <span class='keyword'>char</span> buf[1024];</td></tr>
<tr class="codeline" data-linenumber="2535"><td class="num" id="LN2535">2535</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2536"><td class="num" id="LN2536">2536</td><td class="line">    <span class='keyword'>if</span> (fp) {</td></tr>
<tr class="codeline" data-linenumber="2537"><td class="num" id="LN2537">2537</td><td class="line">        <span class='keyword'>while</span>(fgets(buf,<span class='keyword'>sizeof</span>(buf),fp) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2538"><td class="num" id="LN2538">2538</td><td class="line">            <span class='macro'>sds<span class='macro_popup'>hisds</span></span> *argv;</td></tr>
<tr class="codeline" data-linenumber="2539"><td class="num" id="LN2539">2539</td><td class="line">            <span class='keyword'>int</span> argc;</td></tr>
<tr class="codeline" data-linenumber="2540"><td class="num" id="LN2540">2540</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2541"><td class="num" id="LN2541">2541</td><td class="line">            argv = <span class='macro'>sdssplitargs<span class='macro_popup'>hi_sdssplitargs</span></span>(buf,&amp;argc);</td></tr>
<tr class="codeline" data-linenumber="2542"><td class="num" id="LN2542">2542</td><td class="line">            <span class='keyword'>if</span> (argc &gt; 0) cliSetPreferences(argv,argc,0);</td></tr>
<tr class="codeline" data-linenumber="2543"><td class="num" id="LN2543">2543</td><td class="line">            <span class='macro'>sdsfreesplitres<span class='macro_popup'>hi_sdsfreesplitres</span></span>(argv,argc);</td></tr>
<tr class="codeline" data-linenumber="2544"><td class="num" id="LN2544">2544</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2545"><td class="num" id="LN2545">2545</td><td class="line">        fclose(fp);</td></tr>
<tr class="codeline" data-linenumber="2546"><td class="num" id="LN2546">2546</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2547"><td class="num" id="LN2547">2547</td><td class="line">    <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(rcfile);</td></tr>
<tr class="codeline" data-linenumber="2548"><td class="num" id="LN2548">2548</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2549"><td class="num" id="LN2549">2549</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2550"><td class="num" id="LN2550">2550</td><td class="line"><span class='comment'>/* Some commands can include sensitive information and shouldn't be put in the</span></td></tr>
<tr class="codeline" data-linenumber="2551"><td class="num" id="LN2551">2551</td><td class="line"> <span class='comment'>* history file. Currently these commands are include:</span></td></tr>
<tr class="codeline" data-linenumber="2552"><td class="num" id="LN2552">2552</td><td class="line"> <span class='comment'>* - AUTH</span></td></tr>
<tr class="codeline" data-linenumber="2553"><td class="num" id="LN2553">2553</td><td class="line"> <span class='comment'>* - ACL SETUSER</span></td></tr>
<tr class="codeline" data-linenumber="2554"><td class="num" id="LN2554">2554</td><td class="line"> <span class='comment'>* - CONFIG SET masterauth/masteruser/requirepass</span></td></tr>
<tr class="codeline" data-linenumber="2555"><td class="num" id="LN2555">2555</td><td class="line"> <span class='comment'>* - HELLO with [AUTH username password]</span></td></tr>
<tr class="codeline" data-linenumber="2556"><td class="num" id="LN2556">2556</td><td class="line"> <span class='comment'>* - MIGRATE with [AUTH password] or [AUTH2 username password] */</span></td></tr>
<tr class="codeline" data-linenumber="2557"><td class="num" id="LN2557">2557</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> isSensitiveCommand(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv) {</td></tr>
<tr class="codeline" data-linenumber="2558"><td class="num" id="LN2558">2558</td><td class="line">    <span class='keyword'>if</span> (!strcasecmp(argv[0],<span class='string_literal'>"auth"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2559"><td class="num" id="LN2559">2559</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2560"><td class="num" id="LN2560">2560</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (argc &gt; 1 &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2561"><td class="num" id="LN2561">2561</td><td class="line">        !strcasecmp(argv[0],<span class='string_literal'>"acl"</span>) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2562"><td class="num" id="LN2562">2562</td><td class="line">        !strcasecmp(argv[1],<span class='string_literal'>"setuser"</span>))</td></tr>
<tr class="codeline" data-linenumber="2563"><td class="num" id="LN2563">2563</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="2564"><td class="num" id="LN2564">2564</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2565"><td class="num" id="LN2565">2565</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (argc &gt; 2 &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2566"><td class="num" id="LN2566">2566</td><td class="line">        !strcasecmp(argv[0],<span class='string_literal'>"config"</span>) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2567"><td class="num" id="LN2567">2567</td><td class="line">        !strcasecmp(argv[1],<span class='string_literal'>"set"</span>) &amp;&amp; (</td></tr>
<tr class="codeline" data-linenumber="2568"><td class="num" id="LN2568">2568</td><td class="line">            !strcasecmp(argv[2],<span class='string_literal'>"masterauth"</span>) ||</td></tr>
<tr class="codeline" data-linenumber="2569"><td class="num" id="LN2569">2569</td><td class="line">            !strcasecmp(argv[2],<span class='string_literal'>"masteruser"</span>) ||</td></tr>
<tr class="codeline" data-linenumber="2570"><td class="num" id="LN2570">2570</td><td class="line">            !strcasecmp(argv[2],<span class='string_literal'>"requirepass"</span>)))</td></tr>
<tr class="codeline" data-linenumber="2571"><td class="num" id="LN2571">2571</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="2572"><td class="num" id="LN2572">2572</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2573"><td class="num" id="LN2573">2573</td><td class="line">    <span class='comment'>/* HELLO [protover [AUTH username password] [SETNAME clientname]] */</span></td></tr>
<tr class="codeline" data-linenumber="2574"><td class="num" id="LN2574">2574</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (argc &gt; 4 &amp;&amp; !strcasecmp(argv[0],<span class='string_literal'>"hello"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2575"><td class="num" id="LN2575">2575</td><td class="line">        <span class='keyword'>for</span> (<span class='keyword'>int</span> j = 2; j &lt; argc; j++) {</td></tr>
<tr class="codeline" data-linenumber="2576"><td class="num" id="LN2576">2576</td><td class="line">            <span class='keyword'>int</span> moreargs = argc - 1 - j;</td></tr>
<tr class="codeline" data-linenumber="2577"><td class="num" id="LN2577">2577</td><td class="line">            <span class='keyword'>if</span> (!strcasecmp(argv[j],<span class='string_literal'>"AUTH"</span>) &amp;&amp; moreargs &gt;= 2) {</td></tr>
<tr class="codeline" data-linenumber="2578"><td class="num" id="LN2578">2578</td><td class="line">                <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2579"><td class="num" id="LN2579">2579</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(argv[j],<span class='string_literal'>"SETNAME"</span>) &amp;&amp; moreargs) {</td></tr>
<tr class="codeline" data-linenumber="2580"><td class="num" id="LN2580">2580</td><td class="line">                j++;</td></tr>
<tr class="codeline" data-linenumber="2581"><td class="num" id="LN2581">2581</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2582"><td class="num" id="LN2582">2582</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2583"><td class="num" id="LN2583">2583</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2584"><td class="num" id="LN2584">2584</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2585"><td class="num" id="LN2585">2585</td><td class="line">    <span class='comment'>/* MIGRATE host port key|"" destination-db timeout [COPY] [REPLACE]</span></td></tr>
<tr class="codeline" data-linenumber="2586"><td class="num" id="LN2586">2586</td><td class="line">     <span class='comment'>* [AUTH password] [AUTH2 username password] [KEYS key [key ...]] */</span></td></tr>
<tr class="codeline" data-linenumber="2587"><td class="num" id="LN2587">2587</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (argc &gt; 7 &amp;&amp; !strcasecmp(argv[0], <span class='string_literal'>"migrate"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2588"><td class="num" id="LN2588">2588</td><td class="line">        <span class='keyword'>for</span> (<span class='keyword'>int</span> j = 6; j &lt; argc; j++) {</td></tr>
<tr class="codeline" data-linenumber="2589"><td class="num" id="LN2589">2589</td><td class="line">            <span class='keyword'>int</span> moreargs = argc - 1 - j;</td></tr>
<tr class="codeline" data-linenumber="2590"><td class="num" id="LN2590">2590</td><td class="line">            <span class='keyword'>if</span> (!strcasecmp(argv[j],<span class='string_literal'>"auth"</span>) &amp;&amp; moreargs) {</td></tr>
<tr class="codeline" data-linenumber="2591"><td class="num" id="LN2591">2591</td><td class="line">                <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2592"><td class="num" id="LN2592">2592</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(argv[j],<span class='string_literal'>"auth2"</span>) &amp;&amp; moreargs &gt;= 2) {</td></tr>
<tr class="codeline" data-linenumber="2593"><td class="num" id="LN2593">2593</td><td class="line">                <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2594"><td class="num" id="LN2594">2594</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(argv[j],<span class='string_literal'>"keys"</span>) &amp;&amp; moreargs) {</td></tr>
<tr class="codeline" data-linenumber="2595"><td class="num" id="LN2595">2595</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2596"><td class="num" id="LN2596">2596</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2597"><td class="num" id="LN2597">2597</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2598"><td class="num" id="LN2598">2598</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2599"><td class="num" id="LN2599">2599</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2600"><td class="num" id="LN2600">2600</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2601"><td class="num" id="LN2601">2601</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2602"><td class="num" id="LN2602">2602</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> repl(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="2603"><td class="num" id="LN2603">2603</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> historyfile = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2604"><td class="num" id="LN2604">2604</td><td class="line">    <span class='keyword'>int</span> history = 0;</td></tr>
<tr class="codeline" data-linenumber="2605"><td class="num" id="LN2605">2605</td><td class="line">    <span class='keyword'>char</span> *line;</td></tr>
<tr class="codeline" data-linenumber="2606"><td class="num" id="LN2606">2606</td><td class="line">    <span class='keyword'>int</span> argc;</td></tr>
<tr class="codeline" data-linenumber="2607"><td class="num" id="LN2607">2607</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> *argv;</td></tr>
<tr class="codeline" data-linenumber="2608"><td class="num" id="LN2608">2608</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2609"><td class="num" id="LN2609">2609</td><td class="line">    <span class='comment'>/* There is no need to initialize redis HELP when we are in lua debugger mode.</span></td></tr>
<tr class="codeline" data-linenumber="2610"><td class="num" id="LN2610">2610</td><td class="line">     <span class='comment'>* It has its own HELP and commands (COMMAND or COMMAND DOCS will fail and got nothing).</span></td></tr>
<tr class="codeline" data-linenumber="2611"><td class="num" id="LN2611">2611</td><td class="line">     <span class='comment'>* We will initialize the redis HELP after the Lua debugging session ended.*/</span></td></tr>
<tr class="codeline" data-linenumber="2612"><td class="num" id="LN2612">2612</td><td class="line">    <span class='keyword'>if</span> (!config.eval_ldb) {</td></tr>
<tr class="codeline" data-linenumber="2613"><td class="num" id="LN2613">2613</td><td class="line">        <span class='comment'>/* Initialize the help using the results of the COMMAND command. */</span></td></tr>
<tr class="codeline" data-linenumber="2614"><td class="num" id="LN2614">2614</td><td class="line">        cliInitHelp();</td></tr>
<tr class="codeline" data-linenumber="2615"><td class="num" id="LN2615">2615</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2616"><td class="num" id="LN2616">2616</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2617"><td class="num" id="LN2617">2617</td><td class="line">    config.interactive = 1;</td></tr>
<tr class="codeline" data-linenumber="2618"><td class="num" id="LN2618">2618</td><td class="line">    linenoiseSetMultiLine(1);</td></tr>
<tr class="codeline" data-linenumber="2619"><td class="num" id="LN2619">2619</td><td class="line">    linenoiseSetCompletionCallback(completionCallback);</td></tr>
<tr class="codeline" data-linenumber="2620"><td class="num" id="LN2620">2620</td><td class="line">    linenoiseSetHintsCallback(hintsCallback);</td></tr>
<tr class="codeline" data-linenumber="2621"><td class="num" id="LN2621">2621</td><td class="line">    linenoiseSetFreeHintsCallback(freeHintsCallback);</td></tr>
<tr class="codeline" data-linenumber="2622"><td class="num" id="LN2622">2622</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2623"><td class="num" id="LN2623">2623</td><td class="line">    <span class='comment'>/* Only use history and load the rc file when stdin is a tty. */</span></td></tr>
<tr class="codeline" data-linenumber="2624"><td class="num" id="LN2624">2624</td><td class="line">    <span class='keyword'>if</span> (isatty(fileno(<span class='macro'>stdin<span class='macro_popup'>stdin</span></span>))) {</td></tr>
<tr class="codeline" data-linenumber="2625"><td class="num" id="LN2625">2625</td><td class="line">        historyfile = getDotfilePath(<span class='macro'>REDIS_CLI_HISTFILE_ENV<span class='macro_popup'>"REDISCLI_HISTFILE"</span></span>,<span class='macro'>REDIS_CLI_HISTFILE_DEFAULT<span class='macro_popup'>".rediscli_history"</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2626"><td class="num" id="LN2626">2626</td><td class="line">        <span class='comment'>//keep in-memory history always regardless if history file can be determined</span></td></tr>
<tr class="codeline" data-linenumber="2627"><td class="num" id="LN2627">2627</td><td class="line">        history = 1;</td></tr>
<tr class="codeline" data-linenumber="2628"><td class="num" id="LN2628">2628</td><td class="line">        <span class='keyword'>if</span> (historyfile != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2629"><td class="num" id="LN2629">2629</td><td class="line">            linenoiseHistoryLoad(historyfile);</td></tr>
<tr class="codeline" data-linenumber="2630"><td class="num" id="LN2630">2630</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2631"><td class="num" id="LN2631">2631</td><td class="line">        cliLoadPreferences();</td></tr>
<tr class="codeline" data-linenumber="2632"><td class="num" id="LN2632">2632</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2633"><td class="num" id="LN2633">2633</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2634"><td class="num" id="LN2634">2634</td><td class="line">    cliRefreshPrompt();</td></tr>
<tr class="codeline" data-linenumber="2635"><td class="num" id="LN2635">2635</td><td class="line">    <span class='keyword'>while</span>((line = linenoise(context ? config.prompt : <span class='string_literal'>"not connected&gt; "</span>)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2636"><td class="num" id="LN2636">2636</td><td class="line">        <span class='keyword'>if</span> (line[0] != '\0') {</td></tr>
<tr class="codeline" data-linenumber="2637"><td class="num" id="LN2637">2637</td><td class="line">            <span class='keyword'>long</span> repeat = 1;</td></tr>
<tr class="codeline" data-linenumber="2638"><td class="num" id="LN2638">2638</td><td class="line">            <span class='keyword'>int</span> skipargs = 0;</td></tr>
<tr class="codeline" data-linenumber="2639"><td class="num" id="LN2639">2639</td><td class="line">            <span class='keyword'>char</span> *endptr = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2640"><td class="num" id="LN2640">2640</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2641"><td class="num" id="LN2641">2641</td><td class="line">            argv = cliSplitArgs(line,&amp;argc);</td></tr>
<tr class="codeline" data-linenumber="2642"><td class="num" id="LN2642">2642</td><td class="line">            <span class='keyword'>if</span> (argv == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2643"><td class="num" id="LN2643">2643</td><td class="line">                printf(<span class='string_literal'>"Invalid argument(s)\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="2644"><td class="num" id="LN2644">2644</td><td class="line">                fflush(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2645"><td class="num" id="LN2645">2645</td><td class="line">                <span class='keyword'>if</span> (history) linenoiseHistoryAdd(line);</td></tr>
<tr class="codeline" data-linenumber="2646"><td class="num" id="LN2646">2646</td><td class="line">                <span class='keyword'>if</span> (historyfile) linenoiseHistorySave(historyfile);</td></tr>
<tr class="codeline" data-linenumber="2647"><td class="num" id="LN2647">2647</td><td class="line">                linenoiseFree(line);</td></tr>
<tr class="codeline" data-linenumber="2648"><td class="num" id="LN2648">2648</td><td class="line">                <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="2649"><td class="num" id="LN2649">2649</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (argc == 0) {</td></tr>
<tr class="codeline" data-linenumber="2650"><td class="num" id="LN2650">2650</td><td class="line">                <span class='macro'>sdsfreesplitres<span class='macro_popup'>hi_sdsfreesplitres</span></span>(argv,argc);</td></tr>
<tr class="codeline" data-linenumber="2651"><td class="num" id="LN2651">2651</td><td class="line">                linenoiseFree(line);</td></tr>
<tr class="codeline" data-linenumber="2652"><td class="num" id="LN2652">2652</td><td class="line">                <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="2653"><td class="num" id="LN2653">2653</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2654"><td class="num" id="LN2654">2654</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2655"><td class="num" id="LN2655">2655</td><td class="line">            <span class='comment'>/* check if we have a repeat command option and</span></td></tr>
<tr class="codeline" data-linenumber="2656"><td class="num" id="LN2656">2656</td><td class="line">             <span class='comment'>* need to skip the first arg */</span></td></tr>
<tr class="codeline" data-linenumber="2657"><td class="num" id="LN2657">2657</td><td class="line">            <span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span> = 0;</td></tr>
<tr class="codeline" data-linenumber="2658"><td class="num" id="LN2658">2658</td><td class="line">            repeat = strtol(argv[0], &amp;endptr, 10);</td></tr>
<tr class="codeline" data-linenumber="2659"><td class="num" id="LN2659">2659</td><td class="line">            <span class='keyword'>if</span> (argc &gt; 1 &amp;&amp; *endptr == '\0') {</td></tr>
<tr class="codeline" data-linenumber="2660"><td class="num" id="LN2660">2660</td><td class="line">                <span class='keyword'>if</span> (<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span> == <span class='macro'>ERANGE<span class='macro_popup'>34</span></span> || <span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span> == <span class='macro'>EINVAL<span class='macro_popup'>22</span></span> || repeat &lt;= 0) {</td></tr>
<tr class="codeline" data-linenumber="2661"><td class="num" id="LN2661">2661</td><td class="line">                    fputs(<span class='string_literal'>"Invalid redis-cli repeat command option value.\n"</span>, <span class='macro'>stdout<span class='macro_popup'>stdout</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2662"><td class="num" id="LN2662">2662</td><td class="line">                    <span class='macro'>sdsfreesplitres<span class='macro_popup'>hi_sdsfreesplitres</span></span>(argv, argc);</td></tr>
<tr class="codeline" data-linenumber="2663"><td class="num" id="LN2663">2663</td><td class="line">                    linenoiseFree(line);</td></tr>
<tr class="codeline" data-linenumber="2664"><td class="num" id="LN2664">2664</td><td class="line">                    <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="2665"><td class="num" id="LN2665">2665</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="2666"><td class="num" id="LN2666">2666</td><td class="line">                skipargs = 1;</td></tr>
<tr class="codeline" data-linenumber="2667"><td class="num" id="LN2667">2667</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2668"><td class="num" id="LN2668">2668</td><td class="line">                repeat = 1;</td></tr>
<tr class="codeline" data-linenumber="2669"><td class="num" id="LN2669">2669</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2670"><td class="num" id="LN2670">2670</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2671"><td class="num" id="LN2671">2671</td><td class="line">            <span class='keyword'>if</span> (!isSensitiveCommand(argc - skipargs, argv + skipargs)) {</td></tr>
<tr class="codeline" data-linenumber="2672"><td class="num" id="LN2672">2672</td><td class="line">                <span class='keyword'>if</span> (history) linenoiseHistoryAdd(line);</td></tr>
<tr class="codeline" data-linenumber="2673"><td class="num" id="LN2673">2673</td><td class="line">                <span class='keyword'>if</span> (historyfile) linenoiseHistorySave(historyfile);</td></tr>
<tr class="codeline" data-linenumber="2674"><td class="num" id="LN2674">2674</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2675"><td class="num" id="LN2675">2675</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2676"><td class="num" id="LN2676">2676</td><td class="line">            <span class='keyword'>if</span> (strcasecmp(argv[0],<span class='string_literal'>"quit"</span>) == 0 ||</td></tr>
<tr class="codeline" data-linenumber="2677"><td class="num" id="LN2677">2677</td><td class="line">                strcasecmp(argv[0],<span class='string_literal'>"exit"</span>) == 0)</td></tr>
<tr class="codeline" data-linenumber="2678"><td class="num" id="LN2678">2678</td><td class="line">            {</td></tr>
<tr class="codeline" data-linenumber="2679"><td class="num" id="LN2679">2679</td><td class="line">                exit(0);</td></tr>
<tr class="codeline" data-linenumber="2680"><td class="num" id="LN2680">2680</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (argv[0][0] == ':') {</td></tr>
<tr class="codeline" data-linenumber="2681"><td class="num" id="LN2681">2681</td><td class="line">                cliSetPreferences(argv,argc,1);</td></tr>
<tr class="codeline" data-linenumber="2682"><td class="num" id="LN2682">2682</td><td class="line">                <span class='macro'>sdsfreesplitres<span class='macro_popup'>hi_sdsfreesplitres</span></span>(argv,argc);</td></tr>
<tr class="codeline" data-linenumber="2683"><td class="num" id="LN2683">2683</td><td class="line">                linenoiseFree(line);</td></tr>
<tr class="codeline" data-linenumber="2684"><td class="num" id="LN2684">2684</td><td class="line">                <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="2685"><td class="num" id="LN2685">2685</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (strcasecmp(argv[0],<span class='string_literal'>"restart"</span>) == 0) {</td></tr>
<tr class="codeline" data-linenumber="2686"><td class="num" id="LN2686">2686</td><td class="line">                <span class='keyword'>if</span> (config.eval) {</td></tr>
<tr class="codeline" data-linenumber="2687"><td class="num" id="LN2687">2687</td><td class="line">                    config.eval_ldb = 1;</td></tr>
<tr class="codeline" data-linenumber="2688"><td class="num" id="LN2688">2688</td><td class="line">                    config.output = <span class='macro'>OUTPUT_RAW<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2689"><td class="num" id="LN2689">2689</td><td class="line">                    <span class='macro'>sdsfreesplitres<span class='macro_popup'>hi_sdsfreesplitres</span></span>(argv,argc);</td></tr>
<tr class="codeline" data-linenumber="2690"><td class="num" id="LN2690">2690</td><td class="line">                    linenoiseFree(line);</td></tr>
<tr class="codeline" data-linenumber="2691"><td class="num" id="LN2691">2691</td><td class="line">                    <span class='keyword'>return</span>; <span class='comment'>/* Return to evalMode to restart the session. */</span></td></tr>
<tr class="codeline" data-linenumber="2692"><td class="num" id="LN2692">2692</td><td class="line">                } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2693"><td class="num" id="LN2693">2693</td><td class="line">                    printf(<span class='string_literal'>"Use 'restart' only in Lua debugging mode.\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="2694"><td class="num" id="LN2694">2694</td><td class="line">                    fflush(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2695"><td class="num" id="LN2695">2695</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="2696"><td class="num" id="LN2696">2696</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (argc == 3 &amp;&amp; !strcasecmp(argv[0],<span class='string_literal'>"connect"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2697"><td class="num" id="LN2697">2697</td><td class="line">                <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(config.conn_info.hostip);</td></tr>
<tr class="codeline" data-linenumber="2698"><td class="num" id="LN2698">2698</td><td class="line">                config.conn_info.hostip = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(argv[1]);</td></tr>
<tr class="codeline" data-linenumber="2699"><td class="num" id="LN2699">2699</td><td class="line">                config.conn_info.hostport = atoi(argv[2]);</td></tr>
<tr class="codeline" data-linenumber="2700"><td class="num" id="LN2700">2700</td><td class="line">                cliRefreshPrompt();</td></tr>
<tr class="codeline" data-linenumber="2701"><td class="num" id="LN2701">2701</td><td class="line">                cliConnect(<span class='macro'>CC_FORCE<span class='macro_popup'>(1&lt;&lt;0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2702"><td class="num" id="LN2702">2702</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (argc == 1 &amp;&amp; !strcasecmp(argv[0],<span class='string_literal'>"clear"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2703"><td class="num" id="LN2703">2703</td><td class="line">                linenoiseClearScreen();</td></tr>
<tr class="codeline" data-linenumber="2704"><td class="num" id="LN2704">2704</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2705"><td class="num" id="LN2705">2705</td><td class="line">                <span class='keyword'>long</span> <span class='keyword'>long</span> start_time = mstime(), elapsed;</td></tr>
<tr class="codeline" data-linenumber="2706"><td class="num" id="LN2706">2706</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2707"><td class="num" id="LN2707">2707</td><td class="line">                issueCommandRepeat(argc-skipargs, argv+skipargs, repeat);</td></tr>
<tr class="codeline" data-linenumber="2708"><td class="num" id="LN2708">2708</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2709"><td class="num" id="LN2709">2709</td><td class="line">                <span class='comment'>/* If our debugging session ended, show the EVAL final</span></td></tr>
<tr class="codeline" data-linenumber="2710"><td class="num" id="LN2710">2710</td><td class="line">                    <span class='comment'>* reply. */</span></td></tr>
<tr class="codeline" data-linenumber="2711"><td class="num" id="LN2711">2711</td><td class="line">                <span class='keyword'>if</span> (config.eval_ldb_end) {</td></tr>
<tr class="codeline" data-linenumber="2712"><td class="num" id="LN2712">2712</td><td class="line">                    config.eval_ldb_end = 0;</td></tr>
<tr class="codeline" data-linenumber="2713"><td class="num" id="LN2713">2713</td><td class="line">                    cliReadReply(0);</td></tr>
<tr class="codeline" data-linenumber="2714"><td class="num" id="LN2714">2714</td><td class="line">                    printf(<span class='string_literal'>"\n(Lua debugging session ended%s)\n\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="2715"><td class="num" id="LN2715">2715</td><td class="line">                        config.eval_ldb_sync ? <span class='string_literal'>""</span> :</td></tr>
<tr class="codeline" data-linenumber="2716"><td class="num" id="LN2716">2716</td><td class="line">                        <span class='string_literal'>" -- dataset changes rolled back"</span>);</td></tr>
<tr class="codeline" data-linenumber="2717"><td class="num" id="LN2717">2717</td><td class="line">                    cliInitHelp();</td></tr>
<tr class="codeline" data-linenumber="2718"><td class="num" id="LN2718">2718</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="2719"><td class="num" id="LN2719">2719</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2720"><td class="num" id="LN2720">2720</td><td class="line">                elapsed = mstime()-start_time;</td></tr>
<tr class="codeline" data-linenumber="2721"><td class="num" id="LN2721">2721</td><td class="line">                <span class='keyword'>if</span> (elapsed &gt;= 500 &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2722"><td class="num" id="LN2722">2722</td><td class="line">                    config.output == <span class='macro'>OUTPUT_STANDARD<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2723"><td class="num" id="LN2723">2723</td><td class="line">                {</td></tr>
<tr class="codeline" data-linenumber="2724"><td class="num" id="LN2724">2724</td><td class="line">                    printf(<span class='string_literal'>"(%.2fs)\n"</span>,(<span class='keyword'>double</span>)elapsed/1000);</td></tr>
<tr class="codeline" data-linenumber="2725"><td class="num" id="LN2725">2725</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="2726"><td class="num" id="LN2726">2726</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2727"><td class="num" id="LN2727">2727</td><td class="line">            <span class='comment'>/* Free the argument vector */</span></td></tr>
<tr class="codeline" data-linenumber="2728"><td class="num" id="LN2728">2728</td><td class="line">            <span class='macro'>sdsfreesplitres<span class='macro_popup'>hi_sdsfreesplitres</span></span>(argv,argc);</td></tr>
<tr class="codeline" data-linenumber="2729"><td class="num" id="LN2729">2729</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2730"><td class="num" id="LN2730">2730</td><td class="line">        <span class='comment'>/* linenoise() returns malloc-ed lines like readline() */</span></td></tr>
<tr class="codeline" data-linenumber="2731"><td class="num" id="LN2731">2731</td><td class="line">        linenoiseFree(line);</td></tr>
<tr class="codeline" data-linenumber="2732"><td class="num" id="LN2732">2732</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2733"><td class="num" id="LN2733">2733</td><td class="line">    exit(0);</td></tr>
<tr class="codeline" data-linenumber="2734"><td class="num" id="LN2734">2734</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2735"><td class="num" id="LN2735">2735</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2736"><td class="num" id="LN2736">2736</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> noninteractive(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv) {</td></tr>
<tr class="codeline" data-linenumber="2737"><td class="num" id="LN2737">2737</td><td class="line">    <span class='keyword'>int</span> retval = 0;</td></tr>
<tr class="codeline" data-linenumber="2738"><td class="num" id="LN2738">2738</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> *sds_args = getSdsArrayFromArgv(argc, argv, config.quoted_input);</td></tr>
<tr class="codeline" data-linenumber="2739"><td class="num" id="LN2739">2739</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2740"><td class="num" id="LN2740">2740</td><td class="line">    <span class='keyword'>if</span> (!sds_args) {</td></tr>
<tr class="codeline" data-linenumber="2741"><td class="num" id="LN2741">2741</td><td class="line">        printf(<span class='string_literal'>"Invalid quoted string\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="2742"><td class="num" id="LN2742">2742</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2743"><td class="num" id="LN2743">2743</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2744"><td class="num" id="LN2744">2744</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2745"><td class="num" id="LN2745">2745</td><td class="line">    <span class='keyword'>if</span> (config.stdin_lastarg) {</td></tr>
<tr class="codeline" data-linenumber="2746"><td class="num" id="LN2746">2746</td><td class="line">        sds_args = <span class='macro'>sds_realloc<span class='macro_popup'>hi_sds_realloc</span></span>(sds_args, (argc + 1) * <span class='keyword'>sizeof</span>(<span class='macro'>sds<span class='macro_popup'>hisds</span></span>));</td></tr>
<tr class="codeline" data-linenumber="2747"><td class="num" id="LN2747">2747</td><td class="line">        sds_args[argc] = readArgFromStdin();</td></tr>
<tr class="codeline" data-linenumber="2748"><td class="num" id="LN2748">2748</td><td class="line">        argc++;</td></tr>
<tr class="codeline" data-linenumber="2749"><td class="num" id="LN2749">2749</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (config.stdin_tag_arg) {</td></tr>
<tr class="codeline" data-linenumber="2750"><td class="num" id="LN2750">2750</td><td class="line">        <span class='keyword'>int</span> i = 0, tag_match = 0;</td></tr>
<tr class="codeline" data-linenumber="2751"><td class="num" id="LN2751">2751</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2752"><td class="num" id="LN2752">2752</td><td class="line">        <span class='keyword'>for</span> (; i &lt; argc; i++) {</td></tr>
<tr class="codeline" data-linenumber="2753"><td class="num" id="LN2753">2753</td><td class="line">            <span class='keyword'>if</span> (strcmp(config.stdin_tag_name, sds_args[i]) != 0) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="2754"><td class="num" id="LN2754">2754</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2755"><td class="num" id="LN2755">2755</td><td class="line">            tag_match = 1;</td></tr>
<tr class="codeline" data-linenumber="2756"><td class="num" id="LN2756">2756</td><td class="line">            <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(sds_args[i]);</td></tr>
<tr class="codeline" data-linenumber="2757"><td class="num" id="LN2757">2757</td><td class="line">            sds_args[i] = readArgFromStdin();</td></tr>
<tr class="codeline" data-linenumber="2758"><td class="num" id="LN2758">2758</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2759"><td class="num" id="LN2759">2759</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2760"><td class="num" id="LN2760">2760</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2761"><td class="num" id="LN2761">2761</td><td class="line">        <span class='keyword'>if</span> (!tag_match) {</td></tr>
<tr class="codeline" data-linenumber="2762"><td class="num" id="LN2762">2762</td><td class="line">            <span class='macro'>sdsfreesplitres<span class='macro_popup'>hi_sdsfreesplitres</span></span>(sds_args, argc);</td></tr>
<tr class="codeline" data-linenumber="2763"><td class="num" id="LN2763">2763</td><td class="line">            fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Using -X option but stdin tag not match.\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="2764"><td class="num" id="LN2764">2764</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2765"><td class="num" id="LN2765">2765</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2766"><td class="num" id="LN2766">2766</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2767"><td class="num" id="LN2767">2767</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2768"><td class="num" id="LN2768">2768</td><td class="line">    retval = issueCommand(argc, sds_args);</td></tr>
<tr class="codeline" data-linenumber="2769"><td class="num" id="LN2769">2769</td><td class="line">    <span class='macro'>sdsfreesplitres<span class='macro_popup'>hi_sdsfreesplitres</span></span>(sds_args, argc);</td></tr>
<tr class="codeline" data-linenumber="2770"><td class="num" id="LN2770">2770</td><td class="line">    <span class='keyword'>return</span> retval == <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span> ? 0 : 1;</td></tr>
<tr class="codeline" data-linenumber="2771"><td class="num" id="LN2771">2771</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2772"><td class="num" id="LN2772">2772</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2773"><td class="num" id="LN2773">2773</td><td class="line"><span class='comment'>/*------------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="2774"><td class="num" id="LN2774">2774</td><td class="line"> <span class='comment'>* Eval mode</span></td></tr>
<tr class="codeline" data-linenumber="2775"><td class="num" id="LN2775">2775</td><td class="line"> <span class='comment'>*--------------------------------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="2776"><td class="num" id="LN2776">2776</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2777"><td class="num" id="LN2777">2777</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> evalMode(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv) {</td></tr>
<tr class="codeline" data-linenumber="2778"><td class="num" id="LN2778">2778</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> script = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2779"><td class="num" id="LN2779">2779</td><td class="line">    FILE *fp;</td></tr>
<tr class="codeline" data-linenumber="2780"><td class="num" id="LN2780">2780</td><td class="line">    <span class='keyword'>char</span> buf[1024];</td></tr>
<tr class="codeline" data-linenumber="2781"><td class="num" id="LN2781">2781</td><td class="line">    size_t nread;</td></tr>
<tr class="codeline" data-linenumber="2782"><td class="num" id="LN2782">2782</td><td class="line">    <span class='keyword'>char</span> **argv2;</td></tr>
<tr class="codeline" data-linenumber="2783"><td class="num" id="LN2783">2783</td><td class="line">    <span class='keyword'>int</span> j, got_comma, keys;</td></tr>
<tr class="codeline" data-linenumber="2784"><td class="num" id="LN2784">2784</td><td class="line">    <span class='keyword'>int</span> retval = <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2785"><td class="num" id="LN2785">2785</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2786"><td class="num" id="LN2786">2786</td><td class="line">    <span class='keyword'>while</span>(1) {</td></tr>
<tr class="codeline" data-linenumber="2787"><td class="num" id="LN2787">2787</td><td class="line">        <span class='keyword'>if</span> (config.eval_ldb) {</td></tr>
<tr class="codeline" data-linenumber="2788"><td class="num" id="LN2788">2788</td><td class="line">            printf(</td></tr>
<tr class="codeline" data-linenumber="2789"><td class="num" id="LN2789">2789</td><td class="line">            <span class='string_literal'>"Lua debugging session started, please use:\n"</span></td></tr>
<tr class="codeline" data-linenumber="2790"><td class="num" id="LN2790">2790</td><td class="line">            <span class='string_literal'>"quit    -- End the session.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2791"><td class="num" id="LN2791">2791</td><td class="line">            <span class='string_literal'>"restart -- Restart the script in debug mode again.\n"</span></td></tr>
<tr class="codeline" data-linenumber="2792"><td class="num" id="LN2792">2792</td><td class="line">            <span class='string_literal'>"help    -- Show Lua script debugging commands.\n\n"</span></td></tr>
<tr class="codeline" data-linenumber="2793"><td class="num" id="LN2793">2793</td><td class="line">            );</td></tr>
<tr class="codeline" data-linenumber="2794"><td class="num" id="LN2794">2794</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2795"><td class="num" id="LN2795">2795</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2796"><td class="num" id="LN2796">2796</td><td class="line">        <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(script);</td></tr>
<tr class="codeline" data-linenumber="2797"><td class="num" id="LN2797">2797</td><td class="line">        script = <span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>();</td></tr>
<tr class="codeline" data-linenumber="2798"><td class="num" id="LN2798">2798</td><td class="line">        got_comma = 0;</td></tr>
<tr class="codeline" data-linenumber="2799"><td class="num" id="LN2799">2799</td><td class="line">        keys = 0;</td></tr>
<tr class="codeline" data-linenumber="2800"><td class="num" id="LN2800">2800</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2801"><td class="num" id="LN2801">2801</td><td class="line">        <span class='comment'>/* Load the script from the file, as an sds string. */</span></td></tr>
<tr class="codeline" data-linenumber="2802"><td class="num" id="LN2802">2802</td><td class="line">        fp = fopen(config.eval,<span class='string_literal'>"r"</span>);</td></tr>
<tr class="codeline" data-linenumber="2803"><td class="num" id="LN2803">2803</td><td class="line">        <span class='keyword'>if</span> (!fp) {</td></tr>
<tr class="codeline" data-linenumber="2804"><td class="num" id="LN2804">2804</td><td class="line">            fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2805"><td class="num" id="LN2805">2805</td><td class="line">                <span class='string_literal'>"Can't open file '%s': %s\n"</span>, config.eval, strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="2806"><td class="num" id="LN2806">2806</td><td class="line">            exit(1);</td></tr>
<tr class="codeline" data-linenumber="2807"><td class="num" id="LN2807">2807</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2808"><td class="num" id="LN2808">2808</td><td class="line">        <span class='keyword'>while</span>((nread = fread(buf,1,<span class='keyword'>sizeof</span>(buf),fp)) != 0) {</td></tr>
<tr class="codeline" data-linenumber="2809"><td class="num" id="LN2809">2809</td><td class="line">            script = <span class='macro'>sdscatlen<span class='macro_popup'>hi_sdscatlen</span></span>(script,buf,nread);</td></tr>
<tr class="codeline" data-linenumber="2810"><td class="num" id="LN2810">2810</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2811"><td class="num" id="LN2811">2811</td><td class="line">        fclose(fp);</td></tr>
<tr class="codeline" data-linenumber="2812"><td class="num" id="LN2812">2812</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2813"><td class="num" id="LN2813">2813</td><td class="line">        <span class='comment'>/* If we are debugging a script, enable the Lua debugger. */</span></td></tr>
<tr class="codeline" data-linenumber="2814"><td class="num" id="LN2814">2814</td><td class="line">        <span class='keyword'>if</span> (config.eval_ldb) {</td></tr>
<tr class="codeline" data-linenumber="2815"><td class="num" id="LN2815">2815</td><td class="line">            redisReply *reply = redisCommand(context,</td></tr>
<tr class="codeline" data-linenumber="2816"><td class="num" id="LN2816">2816</td><td class="line">                    config.eval_ldb_sync ?</td></tr>
<tr class="codeline" data-linenumber="2817"><td class="num" id="LN2817">2817</td><td class="line">                    <span class='string_literal'>"SCRIPT DEBUG sync"</span>: <span class='string_literal'>"SCRIPT DEBUG yes"</span>);</td></tr>
<tr class="codeline" data-linenumber="2818"><td class="num" id="LN2818">2818</td><td class="line">            <span class='keyword'>if</span> (reply) freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="2819"><td class="num" id="LN2819">2819</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2820"><td class="num" id="LN2820">2820</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2821"><td class="num" id="LN2821">2821</td><td class="line">        <span class='comment'>/* Create our argument vector */</span></td></tr>
<tr class="codeline" data-linenumber="2822"><td class="num" id="LN2822">2822</td><td class="line">        argv2 = zmalloc(<span class='keyword'>sizeof</span>(<span class='macro'>sds<span class='macro_popup'>hisds</span></span>)*(argc+3));</td></tr>
<tr class="codeline" data-linenumber="2823"><td class="num" id="LN2823">2823</td><td class="line">        argv2[0] = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(<span class='string_literal'>"EVAL"</span>);</td></tr>
<tr class="codeline" data-linenumber="2824"><td class="num" id="LN2824">2824</td><td class="line">        argv2[1] = script;</td></tr>
<tr class="codeline" data-linenumber="2825"><td class="num" id="LN2825">2825</td><td class="line">        <span class='keyword'>for</span> (j = 0; j &lt; argc; j++) {</td></tr>
<tr class="codeline" data-linenumber="2826"><td class="num" id="LN2826">2826</td><td class="line">            <span class='keyword'>if</span> (!got_comma &amp;&amp; argv[j][0] == ',' &amp;&amp; argv[j][1] == 0) {</td></tr>
<tr class="codeline" data-linenumber="2827"><td class="num" id="LN2827">2827</td><td class="line">                got_comma = 1;</td></tr>
<tr class="codeline" data-linenumber="2828"><td class="num" id="LN2828">2828</td><td class="line">                <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="2829"><td class="num" id="LN2829">2829</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2830"><td class="num" id="LN2830">2830</td><td class="line">            argv2[j+3-got_comma] = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(argv[j]);</td></tr>
<tr class="codeline" data-linenumber="2831"><td class="num" id="LN2831">2831</td><td class="line">            <span class='keyword'>if</span> (!got_comma) keys++;</td></tr>
<tr class="codeline" data-linenumber="2832"><td class="num" id="LN2832">2832</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2833"><td class="num" id="LN2833">2833</td><td class="line">        argv2[2] = <span class='macro'>sdscatprintf<span class='macro_popup'>hi_sdscatprintf</span></span>(<span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>(),<span class='string_literal'>"%d"</span>,keys);</td></tr>
<tr class="codeline" data-linenumber="2834"><td class="num" id="LN2834">2834</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2835"><td class="num" id="LN2835">2835</td><td class="line">        <span class='comment'>/* Call it */</span></td></tr>
<tr class="codeline" data-linenumber="2836"><td class="num" id="LN2836">2836</td><td class="line">        <span class='keyword'>int</span> eval_ldb = config.eval_ldb; <span class='comment'>/* Save it, may be reverted. */</span></td></tr>
<tr class="codeline" data-linenumber="2837"><td class="num" id="LN2837">2837</td><td class="line">        retval = issueCommand(argc+3-got_comma, argv2);</td></tr>
<tr class="codeline" data-linenumber="2838"><td class="num" id="LN2838">2838</td><td class="line">        <span class='keyword'>if</span> (eval_ldb) {</td></tr>
<tr class="codeline" data-linenumber="2839"><td class="num" id="LN2839">2839</td><td class="line">            <span class='keyword'>if</span> (!config.eval_ldb) {</td></tr>
<tr class="codeline" data-linenumber="2840"><td class="num" id="LN2840">2840</td><td class="line">                <span class='comment'>/* If the debugging session ended immediately, there was an</span></td></tr>
<tr class="codeline" data-linenumber="2841"><td class="num" id="LN2841">2841</td><td class="line">                 <span class='comment'>* error compiling the script. Show it and they don't enter</span></td></tr>
<tr class="codeline" data-linenumber="2842"><td class="num" id="LN2842">2842</td><td class="line">                 <span class='comment'>* the REPL at all. */</span></td></tr>
<tr class="codeline" data-linenumber="2843"><td class="num" id="LN2843">2843</td><td class="line">                printf(<span class='string_literal'>"Eval debugging session can't start:\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="2844"><td class="num" id="LN2844">2844</td><td class="line">                cliReadReply(0);</td></tr>
<tr class="codeline" data-linenumber="2845"><td class="num" id="LN2845">2845</td><td class="line">                <span class='keyword'>break</span>; <span class='comment'>/* Return to the caller. */</span></td></tr>
<tr class="codeline" data-linenumber="2846"><td class="num" id="LN2846">2846</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2847"><td class="num" id="LN2847">2847</td><td class="line">                strncpy(config.prompt,<span class='string_literal'>"lua debugger&gt; "</span>,<span class='keyword'>sizeof</span>(config.prompt));</td></tr>
<tr class="codeline" data-linenumber="2848"><td class="num" id="LN2848">2848</td><td class="line">                repl();</td></tr>
<tr class="codeline" data-linenumber="2849"><td class="num" id="LN2849">2849</td><td class="line">                <span class='comment'>/* Restart the session if repl() returned. */</span></td></tr>
<tr class="codeline" data-linenumber="2850"><td class="num" id="LN2850">2850</td><td class="line">                cliConnect(<span class='macro'>CC_FORCE<span class='macro_popup'>(1&lt;&lt;0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2851"><td class="num" id="LN2851">2851</td><td class="line">                printf(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="2852"><td class="num" id="LN2852">2852</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2853"><td class="num" id="LN2853">2853</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2854"><td class="num" id="LN2854">2854</td><td class="line">            <span class='keyword'>break</span>; <span class='comment'>/* Return to the caller. */</span></td></tr>
<tr class="codeline" data-linenumber="2855"><td class="num" id="LN2855">2855</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2856"><td class="num" id="LN2856">2856</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2857"><td class="num" id="LN2857">2857</td><td class="line">    <span class='keyword'>return</span> retval == <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span> ? 0 : 1;</td></tr>
<tr class="codeline" data-linenumber="2858"><td class="num" id="LN2858">2858</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2859"><td class="num" id="LN2859">2859</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2860"><td class="num" id="LN2860">2860</td><td class="line"><span class='comment'>/*------------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="2861"><td class="num" id="LN2861">2861</td><td class="line"> <span class='comment'>* Cluster Manager</span></td></tr>
<tr class="codeline" data-linenumber="2862"><td class="num" id="LN2862">2862</td><td class="line"> <span class='comment'>*--------------------------------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="2863"><td class="num" id="LN2863">2863</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2864"><td class="num" id="LN2864">2864</td><td class="line"><span class='comment'>/* The Cluster Manager global structure */</span></td></tr>
<tr class="codeline" data-linenumber="2865"><td class="num" id="LN2865">2865</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>struct</span> clusterManager {</td></tr>
<tr class="codeline" data-linenumber="2866"><td class="num" id="LN2866">2866</td><td class="line">    list *nodes;    <span class='comment'>/* List of nodes in the configuration. */</span></td></tr>
<tr class="codeline" data-linenumber="2867"><td class="num" id="LN2867">2867</td><td class="line">    list *errors;</td></tr>
<tr class="codeline" data-linenumber="2868"><td class="num" id="LN2868">2868</td><td class="line">    <span class='keyword'>int</span> unreachable_masters;    <span class='comment'>/* Masters we are not able to reach. */</span></td></tr>
<tr class="codeline" data-linenumber="2869"><td class="num" id="LN2869">2869</td><td class="line">} cluster_manager;</td></tr>
<tr class="codeline" data-linenumber="2870"><td class="num" id="LN2870">2870</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2871"><td class="num" id="LN2871">2871</td><td class="line"><span class='comment'>/* Used by clusterManagerFixSlotsCoverage */</span></td></tr>
<tr class="codeline" data-linenumber="2872"><td class="num" id="LN2872">2872</td><td class="line">dict *clusterManagerUncoveredSlots = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2873"><td class="num" id="LN2873">2873</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2874"><td class="num" id="LN2874">2874</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> clusterManagerNode {</td></tr>
<tr class="codeline" data-linenumber="2875"><td class="num" id="LN2875">2875</td><td class="line">    redisContext *context;</td></tr>
<tr class="codeline" data-linenumber="2876"><td class="num" id="LN2876">2876</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> name;</td></tr>
<tr class="codeline" data-linenumber="2877"><td class="num" id="LN2877">2877</td><td class="line">    <span class='keyword'>char</span> *ip;</td></tr>
<tr class="codeline" data-linenumber="2878"><td class="num" id="LN2878">2878</td><td class="line">    <span class='keyword'>int</span> port;</td></tr>
<tr class="codeline" data-linenumber="2879"><td class="num" id="LN2879">2879</td><td class="line">    <span class='keyword'>int</span> bus_port; <span class='comment'>/* cluster-port */</span></td></tr>
<tr class="codeline" data-linenumber="2880"><td class="num" id="LN2880">2880</td><td class="line">    uint64_t current_epoch;</td></tr>
<tr class="codeline" data-linenumber="2881"><td class="num" id="LN2881">2881</td><td class="line">    time_t ping_sent;</td></tr>
<tr class="codeline" data-linenumber="2882"><td class="num" id="LN2882">2882</td><td class="line">    time_t ping_recv;</td></tr>
<tr class="codeline" data-linenumber="2883"><td class="num" id="LN2883">2883</td><td class="line">    <span class='keyword'>int</span> flags;</td></tr>
<tr class="codeline" data-linenumber="2884"><td class="num" id="LN2884">2884</td><td class="line">    list *flags_str; <span class='comment'>/* Flags string representations */</span></td></tr>
<tr class="codeline" data-linenumber="2885"><td class="num" id="LN2885">2885</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> replicate;  <span class='comment'>/* Master ID if node is a slave */</span></td></tr>
<tr class="codeline" data-linenumber="2886"><td class="num" id="LN2886">2886</td><td class="line">    <span class='keyword'>int</span> dirty;      <span class='comment'>/* Node has changes that can be flushed */</span></td></tr>
<tr class="codeline" data-linenumber="2887"><td class="num" id="LN2887">2887</td><td class="line">    uint8_t slots[<span class='macro'>CLUSTER_MANAGER_SLOTS<span class='macro_popup'>16384</span></span>];</td></tr>
<tr class="codeline" data-linenumber="2888"><td class="num" id="LN2888">2888</td><td class="line">    <span class='keyword'>int</span> slots_count;</td></tr>
<tr class="codeline" data-linenumber="2889"><td class="num" id="LN2889">2889</td><td class="line">    <span class='keyword'>int</span> replicas_count;</td></tr>
<tr class="codeline" data-linenumber="2890"><td class="num" id="LN2890">2890</td><td class="line">    list *friends;</td></tr>
<tr class="codeline" data-linenumber="2891"><td class="num" id="LN2891">2891</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> *migrating; <span class='comment'>/* An array of sds where even strings are slots and odd</span></td></tr>
<tr class="codeline" data-linenumber="2892"><td class="num" id="LN2892">2892</td><td class="line">                     <span class='comment'>* strings are the destination node IDs. */</span></td></tr>
<tr class="codeline" data-linenumber="2893"><td class="num" id="LN2893">2893</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> *importing; <span class='comment'>/* An array of sds where even strings are slots and odd</span></td></tr>
<tr class="codeline" data-linenumber="2894"><td class="num" id="LN2894">2894</td><td class="line">                     <span class='comment'>* strings are the source node IDs. */</span></td></tr>
<tr class="codeline" data-linenumber="2895"><td class="num" id="LN2895">2895</td><td class="line">    <span class='keyword'>int</span> migrating_count; <span class='comment'>/* Length of the migrating array (migrating slots*2) */</span></td></tr>
<tr class="codeline" data-linenumber="2896"><td class="num" id="LN2896">2896</td><td class="line">    <span class='keyword'>int</span> importing_count; <span class='comment'>/* Length of the importing array (importing slots*2) */</span></td></tr>
<tr class="codeline" data-linenumber="2897"><td class="num" id="LN2897">2897</td><td class="line">    <span class='keyword'>float</span> weight;   <span class='comment'>/* Weight used by rebalance */</span></td></tr>
<tr class="codeline" data-linenumber="2898"><td class="num" id="LN2898">2898</td><td class="line">    <span class='keyword'>int</span> balance;    <span class='comment'>/* Used by rebalance */</span></td></tr>
<tr class="codeline" data-linenumber="2899"><td class="num" id="LN2899">2899</td><td class="line">} clusterManagerNode;</td></tr>
<tr class="codeline" data-linenumber="2900"><td class="num" id="LN2900">2900</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2901"><td class="num" id="LN2901">2901</td><td class="line"><span class='comment'>/* Data structure used to represent a sequence of cluster nodes. */</span></td></tr>
<tr class="codeline" data-linenumber="2902"><td class="num" id="LN2902">2902</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> clusterManagerNodeArray {</td></tr>
<tr class="codeline" data-linenumber="2903"><td class="num" id="LN2903">2903</td><td class="line">    clusterManagerNode **nodes; <span class='comment'>/* Actual nodes array */</span></td></tr>
<tr class="codeline" data-linenumber="2904"><td class="num" id="LN2904">2904</td><td class="line">    clusterManagerNode **alloc; <span class='comment'>/* Pointer to the allocated memory */</span></td></tr>
<tr class="codeline" data-linenumber="2905"><td class="num" id="LN2905">2905</td><td class="line">    <span class='keyword'>int</span> len;                    <span class='comment'>/* Actual length of the array */</span></td></tr>
<tr class="codeline" data-linenumber="2906"><td class="num" id="LN2906">2906</td><td class="line">    <span class='keyword'>int</span> count;                  <span class='comment'>/* Non-NULL nodes count */</span></td></tr>
<tr class="codeline" data-linenumber="2907"><td class="num" id="LN2907">2907</td><td class="line">} clusterManagerNodeArray;</td></tr>
<tr class="codeline" data-linenumber="2908"><td class="num" id="LN2908">2908</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2909"><td class="num" id="LN2909">2909</td><td class="line"><span class='comment'>/* Used for the reshard table. */</span></td></tr>
<tr class="codeline" data-linenumber="2910"><td class="num" id="LN2910">2910</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> clusterManagerReshardTableItem {</td></tr>
<tr class="codeline" data-linenumber="2911"><td class="num" id="LN2911">2911</td><td class="line">    clusterManagerNode *source;</td></tr>
<tr class="codeline" data-linenumber="2912"><td class="num" id="LN2912">2912</td><td class="line">    <span class='keyword'>int</span> slot;</td></tr>
<tr class="codeline" data-linenumber="2913"><td class="num" id="LN2913">2913</td><td class="line">} clusterManagerReshardTableItem;</td></tr>
<tr class="codeline" data-linenumber="2914"><td class="num" id="LN2914">2914</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2915"><td class="num" id="LN2915">2915</td><td class="line"><span class='comment'>/* Info about a cluster internal link. */</span></td></tr>
<tr class="codeline" data-linenumber="2916"><td class="num" id="LN2916">2916</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2917"><td class="num" id="LN2917">2917</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> clusterManagerLink {</td></tr>
<tr class="codeline" data-linenumber="2918"><td class="num" id="LN2918">2918</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> node_name;</td></tr>
<tr class="codeline" data-linenumber="2919"><td class="num" id="LN2919">2919</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> node_addr;</td></tr>
<tr class="codeline" data-linenumber="2920"><td class="num" id="LN2920">2920</td><td class="line">    <span class='keyword'>int</span> connected;</td></tr>
<tr class="codeline" data-linenumber="2921"><td class="num" id="LN2921">2921</td><td class="line">    <span class='keyword'>int</span> handshaking;</td></tr>
<tr class="codeline" data-linenumber="2922"><td class="num" id="LN2922">2922</td><td class="line">} clusterManagerLink;</td></tr>
<tr class="codeline" data-linenumber="2923"><td class="num" id="LN2923">2923</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2924"><td class="num" id="LN2924">2924</td><td class="line"><span class='keyword'>static</span> dictType clusterManagerDictType = {</td></tr>
<tr class="codeline" data-linenumber="2925"><td class="num" id="LN2925">2925</td><td class="line">    dictSdsHash,               <span class='comment'>/* hash function */</span></td></tr>
<tr class="codeline" data-linenumber="2926"><td class="num" id="LN2926">2926</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                      <span class='comment'>/* key dup */</span></td></tr>
<tr class="codeline" data-linenumber="2927"><td class="num" id="LN2927">2927</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                      <span class='comment'>/* val dup */</span></td></tr>
<tr class="codeline" data-linenumber="2928"><td class="num" id="LN2928">2928</td><td class="line">    dictSdsKeyCompare,         <span class='comment'>/* key compare */</span></td></tr>
<tr class="codeline" data-linenumber="2929"><td class="num" id="LN2929">2929</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                      <span class='comment'>/* key destructor */</span></td></tr>
<tr class="codeline" data-linenumber="2930"><td class="num" id="LN2930">2930</td><td class="line">    dictSdsDestructor,         <span class='comment'>/* val destructor */</span></td></tr>
<tr class="codeline" data-linenumber="2931"><td class="num" id="LN2931">2931</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>                       <span class='comment'>/* allow to expand */</span></td></tr>
<tr class="codeline" data-linenumber="2932"><td class="num" id="LN2932">2932</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="2933"><td class="num" id="LN2933">2933</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2934"><td class="num" id="LN2934">2934</td><td class="line"><span class='keyword'>static</span> dictType clusterManagerLinkDictType = {</td></tr>
<tr class="codeline" data-linenumber="2935"><td class="num" id="LN2935">2935</td><td class="line">    dictSdsHash,               <span class='comment'>/* hash function */</span></td></tr>
<tr class="codeline" data-linenumber="2936"><td class="num" id="LN2936">2936</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                      <span class='comment'>/* key dup */</span></td></tr>
<tr class="codeline" data-linenumber="2937"><td class="num" id="LN2937">2937</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                      <span class='comment'>/* val dup */</span></td></tr>
<tr class="codeline" data-linenumber="2938"><td class="num" id="LN2938">2938</td><td class="line">    dictSdsKeyCompare,         <span class='comment'>/* key compare */</span></td></tr>
<tr class="codeline" data-linenumber="2939"><td class="num" id="LN2939">2939</td><td class="line">    dictSdsDestructor,         <span class='comment'>/* key destructor */</span></td></tr>
<tr class="codeline" data-linenumber="2940"><td class="num" id="LN2940">2940</td><td class="line">    dictListDestructor,        <span class='comment'>/* val destructor */</span></td></tr>
<tr class="codeline" data-linenumber="2941"><td class="num" id="LN2941">2941</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>                       <span class='comment'>/* allow to expand */</span></td></tr>
<tr class="codeline" data-linenumber="2942"><td class="num" id="LN2942">2942</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="2943"><td class="num" id="LN2943">2943</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2944"><td class="num" id="LN2944">2944</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>int</span> clusterManagerCommandProc(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv);</td></tr>
<tr class="codeline" data-linenumber="2945"><td class="num" id="LN2945">2945</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>int</span> (*clusterManagerOnReplyError)(redisReply *reply,</td></tr>
<tr class="codeline" data-linenumber="2946"><td class="num" id="LN2946">2946</td><td class="line">    clusterManagerNode *n, <span class='keyword'>int</span> bulk_idx);</td></tr>
<tr class="codeline" data-linenumber="2947"><td class="num" id="LN2947">2947</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2948"><td class="num" id="LN2948">2948</td><td class="line"><span class='comment'>/* Cluster Manager helper functions */</span></td></tr>
<tr class="codeline" data-linenumber="2949"><td class="num" id="LN2949">2949</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2950"><td class="num" id="LN2950">2950</td><td class="line"><span class='keyword'>static</span> clusterManagerNode *clusterManagerNewNode(<span class='keyword'>char</span> *ip, <span class='keyword'>int</span> port, <span class='keyword'>int</span> bus_port);</td></tr>
<tr class="codeline" data-linenumber="2951"><td class="num" id="LN2951">2951</td><td class="line"><span class='keyword'>static</span> clusterManagerNode *clusterManagerNodeByName(<span class='keyword'>const</span> <span class='keyword'>char</span> *name);</td></tr>
<tr class="codeline" data-linenumber="2952"><td class="num" id="LN2952">2952</td><td class="line"><span class='keyword'>static</span> clusterManagerNode *clusterManagerNodeByAbbreviatedName(<span class='keyword'>const</span> <span class='keyword'>char</span> *n);</td></tr>
<tr class="codeline" data-linenumber="2953"><td class="num" id="LN2953">2953</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> clusterManagerNodeResetSlots(clusterManagerNode *node);</td></tr>
<tr class="codeline" data-linenumber="2954"><td class="num" id="LN2954">2954</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerNodeIsCluster(clusterManagerNode *node, <span class='keyword'>char</span> **err);</td></tr>
<tr class="codeline" data-linenumber="2955"><td class="num" id="LN2955">2955</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> clusterManagerPrintNotClusterNodeError(clusterManagerNode *node,</td></tr>
<tr class="codeline" data-linenumber="2956"><td class="num" id="LN2956">2956</td><td class="line">                                                   <span class='keyword'>char</span> *err);</td></tr>
<tr class="codeline" data-linenumber="2957"><td class="num" id="LN2957">2957</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerNodeLoadInfo(clusterManagerNode *node, <span class='keyword'>int</span> opts,</td></tr>
<tr class="codeline" data-linenumber="2958"><td class="num" id="LN2958">2958</td><td class="line">                                      <span class='keyword'>char</span> **err);</td></tr>
<tr class="codeline" data-linenumber="2959"><td class="num" id="LN2959">2959</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerLoadInfoFromNode(clusterManagerNode *node);</td></tr>
<tr class="codeline" data-linenumber="2960"><td class="num" id="LN2960">2960</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerNodeIsEmpty(clusterManagerNode *node, <span class='keyword'>char</span> **err);</td></tr>
<tr class="codeline" data-linenumber="2961"><td class="num" id="LN2961">2961</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerGetAntiAffinityScore(clusterManagerNodeArray *ipnodes,</td></tr>
<tr class="codeline" data-linenumber="2962"><td class="num" id="LN2962">2962</td><td class="line">    <span class='keyword'>int</span> ip_count, clusterManagerNode ***offending, <span class='keyword'>int</span> *offending_len);</td></tr>
<tr class="codeline" data-linenumber="2963"><td class="num" id="LN2963">2963</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> clusterManagerOptimizeAntiAffinity(clusterManagerNodeArray *ipnodes,</td></tr>
<tr class="codeline" data-linenumber="2964"><td class="num" id="LN2964">2964</td><td class="line">    <span class='keyword'>int</span> ip_count);</td></tr>
<tr class="codeline" data-linenumber="2965"><td class="num" id="LN2965">2965</td><td class="line"><span class='keyword'>static</span> <span class='macro'>sds<span class='macro_popup'>hisds</span></span> clusterManagerNodeInfo(clusterManagerNode *node, <span class='keyword'>int</span> indent);</td></tr>
<tr class="codeline" data-linenumber="2966"><td class="num" id="LN2966">2966</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> clusterManagerShowNodes(<span class='keyword'>void</span>);</td></tr>
<tr class="codeline" data-linenumber="2967"><td class="num" id="LN2967">2967</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> clusterManagerShowClusterInfo(<span class='keyword'>void</span>);</td></tr>
<tr class="codeline" data-linenumber="2968"><td class="num" id="LN2968">2968</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerFlushNodeConfig(clusterManagerNode *node, <span class='keyword'>char</span> **err);</td></tr>
<tr class="codeline" data-linenumber="2969"><td class="num" id="LN2969">2969</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> clusterManagerWaitForClusterJoin(<span class='keyword'>void</span>);</td></tr>
<tr class="codeline" data-linenumber="2970"><td class="num" id="LN2970">2970</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerCheckCluster(<span class='keyword'>int</span> quiet);</td></tr>
<tr class="codeline" data-linenumber="2971"><td class="num" id="LN2971">2971</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> clusterManagerLog(<span class='keyword'>int</span> level, <span class='keyword'>const</span> <span class='keyword'>char</span>* fmt, ...);</td></tr>
<tr class="codeline" data-linenumber="2972"><td class="num" id="LN2972">2972</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerIsConfigConsistent(<span class='keyword'>void</span>);</td></tr>
<tr class="codeline" data-linenumber="2973"><td class="num" id="LN2973">2973</td><td class="line"><span class='keyword'>static</span> dict *clusterManagerGetLinkStatus(<span class='keyword'>void</span>);</td></tr>
<tr class="codeline" data-linenumber="2974"><td class="num" id="LN2974">2974</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> clusterManagerOnError(<span class='macro'>sds<span class='macro_popup'>hisds</span></span> err);</td></tr>
<tr class="codeline" data-linenumber="2975"><td class="num" id="LN2975">2975</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> clusterManagerNodeArrayInit(clusterManagerNodeArray *array,</td></tr>
<tr class="codeline" data-linenumber="2976"><td class="num" id="LN2976">2976</td><td class="line">                                        <span class='keyword'>int</span> len);</td></tr>
<tr class="codeline" data-linenumber="2977"><td class="num" id="LN2977">2977</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> clusterManagerNodeArrayReset(clusterManagerNodeArray *array);</td></tr>
<tr class="codeline" data-linenumber="2978"><td class="num" id="LN2978">2978</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> clusterManagerNodeArrayShift(clusterManagerNodeArray *array,</td></tr>
<tr class="codeline" data-linenumber="2979"><td class="num" id="LN2979">2979</td><td class="line">                                         clusterManagerNode **nodeptr);</td></tr>
<tr class="codeline" data-linenumber="2980"><td class="num" id="LN2980">2980</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> clusterManagerNodeArrayAdd(clusterManagerNodeArray *array,</td></tr>
<tr class="codeline" data-linenumber="2981"><td class="num" id="LN2981">2981</td><td class="line">                                       clusterManagerNode *node);</td></tr>
<tr class="codeline" data-linenumber="2982"><td class="num" id="LN2982">2982</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2983"><td class="num" id="LN2983">2983</td><td class="line"><span class='comment'>/* Cluster Manager commands. */</span></td></tr>
<tr class="codeline" data-linenumber="2984"><td class="num" id="LN2984">2984</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2985"><td class="num" id="LN2985">2985</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerCommandCreate(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv);</td></tr>
<tr class="codeline" data-linenumber="2986"><td class="num" id="LN2986">2986</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerCommandAddNode(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv);</td></tr>
<tr class="codeline" data-linenumber="2987"><td class="num" id="LN2987">2987</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerCommandDeleteNode(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv);</td></tr>
<tr class="codeline" data-linenumber="2988"><td class="num" id="LN2988">2988</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerCommandInfo(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv);</td></tr>
<tr class="codeline" data-linenumber="2989"><td class="num" id="LN2989">2989</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerCommandCheck(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv);</td></tr>
<tr class="codeline" data-linenumber="2990"><td class="num" id="LN2990">2990</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerCommandFix(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv);</td></tr>
<tr class="codeline" data-linenumber="2991"><td class="num" id="LN2991">2991</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerCommandReshard(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv);</td></tr>
<tr class="codeline" data-linenumber="2992"><td class="num" id="LN2992">2992</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerCommandRebalance(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv);</td></tr>
<tr class="codeline" data-linenumber="2993"><td class="num" id="LN2993">2993</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerCommandSetTimeout(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv);</td></tr>
<tr class="codeline" data-linenumber="2994"><td class="num" id="LN2994">2994</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerCommandImport(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv);</td></tr>
<tr class="codeline" data-linenumber="2995"><td class="num" id="LN2995">2995</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerCommandCall(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv);</td></tr>
<tr class="codeline" data-linenumber="2996"><td class="num" id="LN2996">2996</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerCommandHelp(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv);</td></tr>
<tr class="codeline" data-linenumber="2997"><td class="num" id="LN2997">2997</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerCommandBackup(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv);</td></tr>
<tr class="codeline" data-linenumber="2998"><td class="num" id="LN2998">2998</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2999"><td class="num" id="LN2999">2999</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> clusterManagerCommandDef {</td></tr>
<tr class="codeline" data-linenumber="3000"><td class="num" id="LN3000">3000</td><td class="line">    <span class='keyword'>char</span> *name;</td></tr>
<tr class="codeline" data-linenumber="3001"><td class="num" id="LN3001">3001</td><td class="line">    clusterManagerCommandProc *proc;</td></tr>
<tr class="codeline" data-linenumber="3002"><td class="num" id="LN3002">3002</td><td class="line">    <span class='keyword'>int</span> arity;</td></tr>
<tr class="codeline" data-linenumber="3003"><td class="num" id="LN3003">3003</td><td class="line">    <span class='keyword'>char</span> *args;</td></tr>
<tr class="codeline" data-linenumber="3004"><td class="num" id="LN3004">3004</td><td class="line">    <span class='keyword'>char</span> *options;</td></tr>
<tr class="codeline" data-linenumber="3005"><td class="num" id="LN3005">3005</td><td class="line">} clusterManagerCommandDef;</td></tr>
<tr class="codeline" data-linenumber="3006"><td class="num" id="LN3006">3006</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3007"><td class="num" id="LN3007">3007</td><td class="line">clusterManagerCommandDef clusterManagerCommands[] = {</td></tr>
<tr class="codeline" data-linenumber="3008"><td class="num" id="LN3008">3008</td><td class="line">    {<span class='string_literal'>"create"</span>, clusterManagerCommandCreate, -2, <span class='string_literal'>"host1:port1 ... hostN:portN"</span>,</td></tr>
<tr class="codeline" data-linenumber="3009"><td class="num" id="LN3009">3009</td><td class="line">     <span class='string_literal'>"replicas &lt;arg&gt;"</span>},</td></tr>
<tr class="codeline" data-linenumber="3010"><td class="num" id="LN3010">3010</td><td class="line">    {<span class='string_literal'>"check"</span>, clusterManagerCommandCheck, -1, <span class='string_literal'>"&lt;host:port&gt; or &lt;host&gt; &lt;port&gt; - separated by either colon or space"</span>,</td></tr>
<tr class="codeline" data-linenumber="3011"><td class="num" id="LN3011">3011</td><td class="line">     <span class='string_literal'>"search-multiple-owners"</span>},</td></tr>
<tr class="codeline" data-linenumber="3012"><td class="num" id="LN3012">3012</td><td class="line">    {<span class='string_literal'>"info"</span>, clusterManagerCommandInfo, -1, <span class='string_literal'>"&lt;host:port&gt; or &lt;host&gt; &lt;port&gt; - separated by either colon or space"</span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>},</td></tr>
<tr class="codeline" data-linenumber="3013"><td class="num" id="LN3013">3013</td><td class="line">    {<span class='string_literal'>"fix"</span>, clusterManagerCommandFix, -1, <span class='string_literal'>"&lt;host:port&gt; or &lt;host&gt; &lt;port&gt; - separated by either colon or space"</span>,</td></tr>
<tr class="codeline" data-linenumber="3014"><td class="num" id="LN3014">3014</td><td class="line">     <span class='string_literal'>"search-multiple-owners,fix-with-unreachable-masters"</span>},</td></tr>
<tr class="codeline" data-linenumber="3015"><td class="num" id="LN3015">3015</td><td class="line">    {<span class='string_literal'>"reshard"</span>, clusterManagerCommandReshard, -1, <span class='string_literal'>"&lt;host:port&gt; or &lt;host&gt; &lt;port&gt; - separated by either colon or space"</span>,</td></tr>
<tr class="codeline" data-linenumber="3016"><td class="num" id="LN3016">3016</td><td class="line">     <span class='string_literal'>"from &lt;arg&gt;,to &lt;arg&gt;,slots &lt;arg&gt;,yes,timeout &lt;arg&gt;,pipeline &lt;arg&gt;,"</span></td></tr>
<tr class="codeline" data-linenumber="3017"><td class="num" id="LN3017">3017</td><td class="line">     <span class='string_literal'>"replace"</span>},</td></tr>
<tr class="codeline" data-linenumber="3018"><td class="num" id="LN3018">3018</td><td class="line">    {<span class='string_literal'>"rebalance"</span>, clusterManagerCommandRebalance, -1, <span class='string_literal'>"&lt;host:port&gt; or &lt;host&gt; &lt;port&gt; - separated by either colon or space"</span>,</td></tr>
<tr class="codeline" data-linenumber="3019"><td class="num" id="LN3019">3019</td><td class="line">     <span class='string_literal'>"weight &lt;node1=w1...nodeN=wN&gt;,use-empty-masters,"</span></td></tr>
<tr class="codeline" data-linenumber="3020"><td class="num" id="LN3020">3020</td><td class="line">     <span class='string_literal'>"timeout &lt;arg&gt;,simulate,pipeline &lt;arg&gt;,threshold &lt;arg&gt;,replace"</span>},</td></tr>
<tr class="codeline" data-linenumber="3021"><td class="num" id="LN3021">3021</td><td class="line">    {<span class='string_literal'>"add-node"</span>, clusterManagerCommandAddNode, 2,</td></tr>
<tr class="codeline" data-linenumber="3022"><td class="num" id="LN3022">3022</td><td class="line">     <span class='string_literal'>"new_host:new_port existing_host:existing_port"</span>, <span class='string_literal'>"slave,master-id &lt;arg&gt;"</span>},</td></tr>
<tr class="codeline" data-linenumber="3023"><td class="num" id="LN3023">3023</td><td class="line">    {<span class='string_literal'>"del-node"</span>, clusterManagerCommandDeleteNode, 2, <span class='string_literal'>"host:port node_id"</span>,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>},</td></tr>
<tr class="codeline" data-linenumber="3024"><td class="num" id="LN3024">3024</td><td class="line">    {<span class='string_literal'>"call"</span>, clusterManagerCommandCall, -2,</td></tr>
<tr class="codeline" data-linenumber="3025"><td class="num" id="LN3025">3025</td><td class="line">        <span class='string_literal'>"host:port command arg arg .. arg"</span>, <span class='string_literal'>"only-masters,only-replicas"</span>},</td></tr>
<tr class="codeline" data-linenumber="3026"><td class="num" id="LN3026">3026</td><td class="line">    {<span class='string_literal'>"set-timeout"</span>, clusterManagerCommandSetTimeout, 2,</td></tr>
<tr class="codeline" data-linenumber="3027"><td class="num" id="LN3027">3027</td><td class="line">     <span class='string_literal'>"host:port milliseconds"</span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>},</td></tr>
<tr class="codeline" data-linenumber="3028"><td class="num" id="LN3028">3028</td><td class="line">    {<span class='string_literal'>"import"</span>, clusterManagerCommandImport, 1, <span class='string_literal'>"host:port"</span>,</td></tr>
<tr class="codeline" data-linenumber="3029"><td class="num" id="LN3029">3029</td><td class="line">     <span class='string_literal'>"from &lt;arg&gt;,from-user &lt;arg&gt;,from-pass &lt;arg&gt;,from-askpass,copy,replace"</span>},</td></tr>
<tr class="codeline" data-linenumber="3030"><td class="num" id="LN3030">3030</td><td class="line">    {<span class='string_literal'>"backup"</span>, clusterManagerCommandBackup, 2,  <span class='string_literal'>"host:port backup_directory"</span>,</td></tr>
<tr class="codeline" data-linenumber="3031"><td class="num" id="LN3031">3031</td><td class="line">     <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>},</td></tr>
<tr class="codeline" data-linenumber="3032"><td class="num" id="LN3032">3032</td><td class="line">    {<span class='string_literal'>"help"</span>, clusterManagerCommandHelp, 0, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>}</td></tr>
<tr class="codeline" data-linenumber="3033"><td class="num" id="LN3033">3033</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="3034"><td class="num" id="LN3034">3034</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3035"><td class="num" id="LN3035">3035</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> clusterManagerOptionDef {</td></tr>
<tr class="codeline" data-linenumber="3036"><td class="num" id="LN3036">3036</td><td class="line">    <span class='keyword'>char</span> *name;</td></tr>
<tr class="codeline" data-linenumber="3037"><td class="num" id="LN3037">3037</td><td class="line">    <span class='keyword'>char</span> *desc;</td></tr>
<tr class="codeline" data-linenumber="3038"><td class="num" id="LN3038">3038</td><td class="line">} clusterManagerOptionDef;</td></tr>
<tr class="codeline" data-linenumber="3039"><td class="num" id="LN3039">3039</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3040"><td class="num" id="LN3040">3040</td><td class="line">clusterManagerOptionDef clusterManagerOptions[] = {</td></tr>
<tr class="codeline" data-linenumber="3041"><td class="num" id="LN3041">3041</td><td class="line">    {<span class='string_literal'>"--cluster-yes"</span>, <span class='string_literal'>"Automatic yes to cluster commands prompts"</span>}</td></tr>
<tr class="codeline" data-linenumber="3042"><td class="num" id="LN3042">3042</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="3043"><td class="num" id="LN3043">3043</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3044"><td class="num" id="LN3044">3044</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> getRDB(clusterManagerNode *node);</td></tr>
<tr class="codeline" data-linenumber="3045"><td class="num" id="LN3045">3045</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3046"><td class="num" id="LN3046">3046</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> createClusterManagerCommand(<span class='keyword'>char</span> *cmdname, <span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv) {</td></tr>
<tr class="codeline" data-linenumber="3047"><td class="num" id="LN3047">3047</td><td class="line">    clusterManagerCommand *cmd = &amp;config.cluster_manager_command;</td></tr>
<tr class="codeline" data-linenumber="3048"><td class="num" id="LN3048">3048</td><td class="line">    cmd-&gt;name = cmdname;</td></tr>
<tr class="codeline" data-linenumber="3049"><td class="num" id="LN3049">3049</td><td class="line">    cmd-&gt;argc = argc;</td></tr>
<tr class="codeline" data-linenumber="3050"><td class="num" id="LN3050">3050</td><td class="line">    cmd-&gt;argv = argc ? argv : <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3051"><td class="num" id="LN3051">3051</td><td class="line">    <span class='keyword'>if</span> (isColorTerm()) cmd-&gt;flags |= <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_COLOR<span class='macro_popup'>1 &lt;&lt; 8</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3052"><td class="num" id="LN3052">3052</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3053"><td class="num" id="LN3053">3053</td><td class="line">    <span class='keyword'>if</span> (config.stdin_lastarg) {</td></tr>
<tr class="codeline" data-linenumber="3054"><td class="num" id="LN3054">3054</td><td class="line">        <span class='keyword'>char</span> **new_argv = zmalloc(<span class='keyword'>sizeof</span>(<span class='keyword'>char</span>*) * (cmd-&gt;argc+1));</td></tr>
<tr class="codeline" data-linenumber="3055"><td class="num" id="LN3055">3055</td><td class="line">        memcpy(new_argv, cmd-&gt;argv, <span class='keyword'>sizeof</span>(<span class='keyword'>char</span>*) * cmd-&gt;argc);</td></tr>
<tr class="codeline" data-linenumber="3056"><td class="num" id="LN3056">3056</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3057"><td class="num" id="LN3057">3057</td><td class="line">        cmd-&gt;stdin_arg = readArgFromStdin();</td></tr>
<tr class="codeline" data-linenumber="3058"><td class="num" id="LN3058">3058</td><td class="line">        new_argv[cmd-&gt;argc++] = cmd-&gt;stdin_arg;</td></tr>
<tr class="codeline" data-linenumber="3059"><td class="num" id="LN3059">3059</td><td class="line">        cmd-&gt;argv = new_argv;</td></tr>
<tr class="codeline" data-linenumber="3060"><td class="num" id="LN3060">3060</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (config.stdin_tag_arg) {</td></tr>
<tr class="codeline" data-linenumber="3061"><td class="num" id="LN3061">3061</td><td class="line">        <span class='keyword'>int</span> i = 0, tag_match = 0;</td></tr>
<tr class="codeline" data-linenumber="3062"><td class="num" id="LN3062">3062</td><td class="line">        cmd-&gt;stdin_arg = readArgFromStdin();</td></tr>
<tr class="codeline" data-linenumber="3063"><td class="num" id="LN3063">3063</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3064"><td class="num" id="LN3064">3064</td><td class="line">        <span class='keyword'>for</span> (; i &lt; argc; i++) {</td></tr>
<tr class="codeline" data-linenumber="3065"><td class="num" id="LN3065">3065</td><td class="line">            <span class='keyword'>if</span> (strcmp(argv[i], config.stdin_tag_name) != 0) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="3066"><td class="num" id="LN3066">3066</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3067"><td class="num" id="LN3067">3067</td><td class="line">            tag_match = 1;</td></tr>
<tr class="codeline" data-linenumber="3068"><td class="num" id="LN3068">3068</td><td class="line">            cmd-&gt;argv[i] = (<span class='keyword'>char</span> *)cmd-&gt;stdin_arg;</td></tr>
<tr class="codeline" data-linenumber="3069"><td class="num" id="LN3069">3069</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3070"><td class="num" id="LN3070">3070</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3071"><td class="num" id="LN3071">3071</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3072"><td class="num" id="LN3072">3072</td><td class="line">        <span class='keyword'>if</span> (!tag_match) {</td></tr>
<tr class="codeline" data-linenumber="3073"><td class="num" id="LN3073">3073</td><td class="line">            <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(cmd-&gt;stdin_arg);</td></tr>
<tr class="codeline" data-linenumber="3074"><td class="num" id="LN3074">3074</td><td class="line">            fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Using -X option but stdin tag not match.\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="3075"><td class="num" id="LN3075">3075</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="3076"><td class="num" id="LN3076">3076</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3077"><td class="num" id="LN3077">3077</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3078"><td class="num" id="LN3078">3078</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3079"><td class="num" id="LN3079">3079</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3080"><td class="num" id="LN3080">3080</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3081"><td class="num" id="LN3081">3081</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3082"><td class="num" id="LN3082">3082</td><td class="line"><span class='keyword'>static</span> clusterManagerCommandProc *validateClusterManagerCommand(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="3083"><td class="num" id="LN3083">3083</td><td class="line">    <span class='keyword'>int</span> i, commands_count = <span class='keyword'>sizeof</span>(clusterManagerCommands) /</td></tr>
<tr class="codeline" data-linenumber="3084"><td class="num" id="LN3084">3084</td><td class="line">                            <span class='keyword'>sizeof</span>(clusterManagerCommandDef);</td></tr>
<tr class="codeline" data-linenumber="3085"><td class="num" id="LN3085">3085</td><td class="line">    clusterManagerCommandProc *proc = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3086"><td class="num" id="LN3086">3086</td><td class="line">    <span class='keyword'>char</span> *cmdname = config.cluster_manager_command.name;</td></tr>
<tr class="codeline" data-linenumber="3087"><td class="num" id="LN3087">3087</td><td class="line">    <span class='keyword'>int</span> argc = config.cluster_manager_command.argc;</td></tr>
<tr class="codeline" data-linenumber="3088"><td class="num" id="LN3088">3088</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; commands_count; i++) {</td></tr>
<tr class="codeline" data-linenumber="3089"><td class="num" id="LN3089">3089</td><td class="line">        clusterManagerCommandDef cmddef = clusterManagerCommands[i];</td></tr>
<tr class="codeline" data-linenumber="3090"><td class="num" id="LN3090">3090</td><td class="line">        <span class='keyword'>if</span> (!strcmp(cmddef.name, cmdname)) {</td></tr>
<tr class="codeline" data-linenumber="3091"><td class="num" id="LN3091">3091</td><td class="line">            <span class='keyword'>if</span> ((cmddef.arity &gt; 0 &amp;&amp; argc != cmddef.arity) ||</td></tr>
<tr class="codeline" data-linenumber="3092"><td class="num" id="LN3092">3092</td><td class="line">                (cmddef.arity &lt; 0 &amp;&amp; argc &lt; (cmddef.arity * -1))) {</td></tr>
<tr class="codeline" data-linenumber="3093"><td class="num" id="LN3093">3093</td><td class="line">                fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"[ERR] Wrong number of arguments for "</span></td></tr>
<tr class="codeline" data-linenumber="3094"><td class="num" id="LN3094">3094</td><td class="line">                                <span class='string_literal'>"specified --cluster sub command\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="3095"><td class="num" id="LN3095">3095</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3096"><td class="num" id="LN3096">3096</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="3097"><td class="num" id="LN3097">3097</td><td class="line">            proc = cmddef.proc;</td></tr>
<tr class="codeline" data-linenumber="3098"><td class="num" id="LN3098">3098</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3099"><td class="num" id="LN3099">3099</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3100"><td class="num" id="LN3100">3100</td><td class="line">    <span class='keyword'>if</span> (!proc) fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Unknown --cluster subcommand\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="3101"><td class="num" id="LN3101">3101</td><td class="line">    <span class='keyword'>return</span> proc;</td></tr>
<tr class="codeline" data-linenumber="3102"><td class="num" id="LN3102">3102</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3103"><td class="num" id="LN3103">3103</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3104"><td class="num" id="LN3104">3104</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> parseClusterNodeAddress(<span class='keyword'>char</span> *addr, <span class='keyword'>char</span> **ip_ptr, <span class='keyword'>int</span> *port_ptr,</td></tr>
<tr class="codeline" data-linenumber="3105"><td class="num" id="LN3105">3105</td><td class="line">                                   <span class='keyword'>int</span> *bus_port_ptr)</td></tr>
<tr class="codeline" data-linenumber="3106"><td class="num" id="LN3106">3106</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3107"><td class="num" id="LN3107">3107</td><td class="line">    <span class='comment'>/* ip:port[@bus_port] */</span></td></tr>
<tr class="codeline" data-linenumber="3108"><td class="num" id="LN3108">3108</td><td class="line">    <span class='keyword'>char</span> *c = strrchr(addr, '@');</td></tr>
<tr class="codeline" data-linenumber="3109"><td class="num" id="LN3109">3109</td><td class="line">    <span class='keyword'>if</span> (c != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3110"><td class="num" id="LN3110">3110</td><td class="line">        *c = '\0';</td></tr>
<tr class="codeline" data-linenumber="3111"><td class="num" id="LN3111">3111</td><td class="line">        <span class='keyword'>if</span> (bus_port_ptr != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3112"><td class="num" id="LN3112">3112</td><td class="line">            *bus_port_ptr = atoi(c + 1);</td></tr>
<tr class="codeline" data-linenumber="3113"><td class="num" id="LN3113">3113</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3114"><td class="num" id="LN3114">3114</td><td class="line">    c = strrchr(addr, ':');</td></tr>
<tr class="codeline" data-linenumber="3115"><td class="num" id="LN3115">3115</td><td class="line">    <span class='keyword'>if</span> (c != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3116"><td class="num" id="LN3116">3116</td><td class="line">        *c = '\0';</td></tr>
<tr class="codeline" data-linenumber="3117"><td class="num" id="LN3117">3117</td><td class="line">        *ip_ptr = addr;</td></tr>
<tr class="codeline" data-linenumber="3118"><td class="num" id="LN3118">3118</td><td class="line">        *port_ptr = atoi(++c);</td></tr>
<tr class="codeline" data-linenumber="3119"><td class="num" id="LN3119">3119</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3120"><td class="num" id="LN3120">3120</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="3121"><td class="num" id="LN3121">3121</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3122"><td class="num" id="LN3122">3122</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3123"><td class="num" id="LN3123">3123</td><td class="line"><span class='comment'>/* Get host ip and port from command arguments. If only one argument has</span></td></tr>
<tr class="codeline" data-linenumber="3124"><td class="num" id="LN3124">3124</td><td class="line"> <span class='comment'>* been provided it must be in the form of 'ip:port', elsewhere</span></td></tr>
<tr class="codeline" data-linenumber="3125"><td class="num" id="LN3125">3125</td><td class="line"> <span class='comment'>* the first argument must be the ip and the second one the port.</span></td></tr>
<tr class="codeline" data-linenumber="3126"><td class="num" id="LN3126">3126</td><td class="line"> <span class='comment'>* If host and port can be detected, it returns 1 and it stores host and</span></td></tr>
<tr class="codeline" data-linenumber="3127"><td class="num" id="LN3127">3127</td><td class="line"> <span class='comment'>* port into variables referenced by 'ip_ptr' and 'port_ptr' pointers,</span></td></tr>
<tr class="codeline" data-linenumber="3128"><td class="num" id="LN3128">3128</td><td class="line"> <span class='comment'>* elsewhere it returns 0. */</span></td></tr>
<tr class="codeline" data-linenumber="3129"><td class="num" id="LN3129">3129</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> getClusterHostFromCmdArgs(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv,</td></tr>
<tr class="codeline" data-linenumber="3130"><td class="num" id="LN3130">3130</td><td class="line">                                     <span class='keyword'>char</span> **ip_ptr, <span class='keyword'>int</span> *port_ptr) {</td></tr>
<tr class="codeline" data-linenumber="3131"><td class="num" id="LN3131">3131</td><td class="line">    <span class='keyword'>int</span> port = 0;</td></tr>
<tr class="codeline" data-linenumber="3132"><td class="num" id="LN3132">3132</td><td class="line">    <span class='keyword'>char</span> *ip = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3133"><td class="num" id="LN3133">3133</td><td class="line">    <span class='keyword'>if</span> (argc == 1) {</td></tr>
<tr class="codeline" data-linenumber="3134"><td class="num" id="LN3134">3134</td><td class="line">        <span class='keyword'>char</span> *addr = argv[0];</td></tr>
<tr class="codeline" data-linenumber="3135"><td class="num" id="LN3135">3135</td><td class="line">        <span class='keyword'>if</span> (!parseClusterNodeAddress(addr, &amp;ip, &amp;port, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3136"><td class="num" id="LN3136">3136</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="3137"><td class="num" id="LN3137">3137</td><td class="line">        ip = argv[0];</td></tr>
<tr class="codeline" data-linenumber="3138"><td class="num" id="LN3138">3138</td><td class="line">        port = atoi(argv[1]);</td></tr>
<tr class="codeline" data-linenumber="3139"><td class="num" id="LN3139">3139</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3140"><td class="num" id="LN3140">3140</td><td class="line">    <span class='keyword'>if</span> (!ip || !port) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3141"><td class="num" id="LN3141">3141</td><td class="line">    <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="3142"><td class="num" id="LN3142">3142</td><td class="line">        *ip_ptr = ip;</td></tr>
<tr class="codeline" data-linenumber="3143"><td class="num" id="LN3143">3143</td><td class="line">        *port_ptr = port;</td></tr>
<tr class="codeline" data-linenumber="3144"><td class="num" id="LN3144">3144</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3145"><td class="num" id="LN3145">3145</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="3146"><td class="num" id="LN3146">3146</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3147"><td class="num" id="LN3147">3147</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3148"><td class="num" id="LN3148">3148</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> freeClusterManagerNodeFlags(list *flags) {</td></tr>
<tr class="codeline" data-linenumber="3149"><td class="num" id="LN3149">3149</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="3150"><td class="num" id="LN3150">3150</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="3151"><td class="num" id="LN3151">3151</td><td class="line">    listRewind(flags, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="3152"><td class="num" id="LN3152">3152</td><td class="line">    <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3153"><td class="num" id="LN3153">3153</td><td class="line">        <span class='macro'>sds<span class='macro_popup'>hisds</span></span> flag = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="3154"><td class="num" id="LN3154">3154</td><td class="line">        <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(flag);</td></tr>
<tr class="codeline" data-linenumber="3155"><td class="num" id="LN3155">3155</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3156"><td class="num" id="LN3156">3156</td><td class="line">    listRelease(flags);</td></tr>
<tr class="codeline" data-linenumber="3157"><td class="num" id="LN3157">3157</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3158"><td class="num" id="LN3158">3158</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3159"><td class="num" id="LN3159">3159</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> freeClusterManagerNode(clusterManagerNode *node) {</td></tr>
<tr class="codeline" data-linenumber="3160"><td class="num" id="LN3160">3160</td><td class="line">    <span class='keyword'>if</span> (node-&gt;context != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) redisFree(node-&gt;context);</td></tr>
<tr class="codeline" data-linenumber="3161"><td class="num" id="LN3161">3161</td><td class="line">    <span class='keyword'>if</span> (node-&gt;friends != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3162"><td class="num" id="LN3162">3162</td><td class="line">        listIter li;</td></tr>
<tr class="codeline" data-linenumber="3163"><td class="num" id="LN3163">3163</td><td class="line">        listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="3164"><td class="num" id="LN3164">3164</td><td class="line">        listRewind(node-&gt;friends,&amp;li);</td></tr>
<tr class="codeline" data-linenumber="3165"><td class="num" id="LN3165">3165</td><td class="line">        <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3166"><td class="num" id="LN3166">3166</td><td class="line">            clusterManagerNode *fn = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="3167"><td class="num" id="LN3167">3167</td><td class="line">            freeClusterManagerNode(fn);</td></tr>
<tr class="codeline" data-linenumber="3168"><td class="num" id="LN3168">3168</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3169"><td class="num" id="LN3169">3169</td><td class="line">        listRelease(node-&gt;friends);</td></tr>
<tr class="codeline" data-linenumber="3170"><td class="num" id="LN3170">3170</td><td class="line">        node-&gt;friends = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3171"><td class="num" id="LN3171">3171</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3172"><td class="num" id="LN3172">3172</td><td class="line">    <span class='keyword'>if</span> (node-&gt;name != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(node-&gt;name);</td></tr>
<tr class="codeline" data-linenumber="3173"><td class="num" id="LN3173">3173</td><td class="line">    <span class='keyword'>if</span> (node-&gt;replicate != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(node-&gt;replicate);</td></tr>
<tr class="codeline" data-linenumber="3174"><td class="num" id="LN3174">3174</td><td class="line">    <span class='keyword'>if</span> ((node-&gt;flags &amp; <span class='macro'>CLUSTER_MANAGER_FLAG_FRIEND<span class='macro_popup'>1 &lt;&lt; 2</span></span>) &amp;&amp; node-&gt;ip)</td></tr>
<tr class="codeline" data-linenumber="3175"><td class="num" id="LN3175">3175</td><td class="line">        <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(node-&gt;ip);</td></tr>
<tr class="codeline" data-linenumber="3176"><td class="num" id="LN3176">3176</td><td class="line">    <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="3177"><td class="num" id="LN3177">3177</td><td class="line">    <span class='keyword'>if</span> (node-&gt;migrating != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3178"><td class="num" id="LN3178">3178</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; node-&gt;migrating_count; i++) <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(node-&gt;migrating[i]);</td></tr>
<tr class="codeline" data-linenumber="3179"><td class="num" id="LN3179">3179</td><td class="line">        zfree(node-&gt;migrating);</td></tr>
<tr class="codeline" data-linenumber="3180"><td class="num" id="LN3180">3180</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3181"><td class="num" id="LN3181">3181</td><td class="line">    <span class='keyword'>if</span> (node-&gt;importing != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3182"><td class="num" id="LN3182">3182</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; node-&gt;importing_count; i++) <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(node-&gt;importing[i]);</td></tr>
<tr class="codeline" data-linenumber="3183"><td class="num" id="LN3183">3183</td><td class="line">        zfree(node-&gt;importing);</td></tr>
<tr class="codeline" data-linenumber="3184"><td class="num" id="LN3184">3184</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3185"><td class="num" id="LN3185">3185</td><td class="line">    <span class='keyword'>if</span> (node-&gt;flags_str != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3186"><td class="num" id="LN3186">3186</td><td class="line">        freeClusterManagerNodeFlags(node-&gt;flags_str);</td></tr>
<tr class="codeline" data-linenumber="3187"><td class="num" id="LN3187">3187</td><td class="line">        node-&gt;flags_str = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3188"><td class="num" id="LN3188">3188</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3189"><td class="num" id="LN3189">3189</td><td class="line">    zfree(node);</td></tr>
<tr class="codeline" data-linenumber="3190"><td class="num" id="LN3190">3190</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3191"><td class="num" id="LN3191">3191</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3192"><td class="num" id="LN3192">3192</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> freeClusterManager(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="3193"><td class="num" id="LN3193">3193</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="3194"><td class="num" id="LN3194">3194</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="3195"><td class="num" id="LN3195">3195</td><td class="line">    <span class='keyword'>if</span> (cluster_manager.nodes != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3196"><td class="num" id="LN3196">3196</td><td class="line">        listRewind(cluster_manager.nodes,&amp;li);</td></tr>
<tr class="codeline" data-linenumber="3197"><td class="num" id="LN3197">3197</td><td class="line">        <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3198"><td class="num" id="LN3198">3198</td><td class="line">            clusterManagerNode *n = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="3199"><td class="num" id="LN3199">3199</td><td class="line">            freeClusterManagerNode(n);</td></tr>
<tr class="codeline" data-linenumber="3200"><td class="num" id="LN3200">3200</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3201"><td class="num" id="LN3201">3201</td><td class="line">        listRelease(cluster_manager.nodes);</td></tr>
<tr class="codeline" data-linenumber="3202"><td class="num" id="LN3202">3202</td><td class="line">        cluster_manager.nodes = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3203"><td class="num" id="LN3203">3203</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3204"><td class="num" id="LN3204">3204</td><td class="line">    <span class='keyword'>if</span> (cluster_manager.errors != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3205"><td class="num" id="LN3205">3205</td><td class="line">        listRewind(cluster_manager.errors,&amp;li);</td></tr>
<tr class="codeline" data-linenumber="3206"><td class="num" id="LN3206">3206</td><td class="line">        <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3207"><td class="num" id="LN3207">3207</td><td class="line">            <span class='macro'>sds<span class='macro_popup'>hisds</span></span> err = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="3208"><td class="num" id="LN3208">3208</td><td class="line">            <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(err);</td></tr>
<tr class="codeline" data-linenumber="3209"><td class="num" id="LN3209">3209</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3210"><td class="num" id="LN3210">3210</td><td class="line">        listRelease(cluster_manager.errors);</td></tr>
<tr class="codeline" data-linenumber="3211"><td class="num" id="LN3211">3211</td><td class="line">        cluster_manager.errors = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3212"><td class="num" id="LN3212">3212</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3213"><td class="num" id="LN3213">3213</td><td class="line">    <span class='keyword'>if</span> (clusterManagerUncoveredSlots != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3214"><td class="num" id="LN3214">3214</td><td class="line">        dictRelease(clusterManagerUncoveredSlots);</td></tr>
<tr class="codeline" data-linenumber="3215"><td class="num" id="LN3215">3215</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3216"><td class="num" id="LN3216">3216</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3217"><td class="num" id="LN3217">3217</td><td class="line"><span class='keyword'>static</span> clusterManagerNode *clusterManagerNewNode(<span class='keyword'>char</span> *ip, <span class='keyword'>int</span> port, <span class='keyword'>int</span> bus_port) {</td></tr>
<tr class="codeline" data-linenumber="3218"><td class="num" id="LN3218">3218</td><td class="line">    clusterManagerNode *node = zmalloc(<span class='keyword'>sizeof</span>(*node));</td></tr>
<tr class="codeline" data-linenumber="3219"><td class="num" id="LN3219">3219</td><td class="line">    node-&gt;context = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3220"><td class="num" id="LN3220">3220</td><td class="line">    node-&gt;name = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3221"><td class="num" id="LN3221">3221</td><td class="line">    node-&gt;ip = ip;</td></tr>
<tr class="codeline" data-linenumber="3222"><td class="num" id="LN3222">3222</td><td class="line">    node-&gt;port = port;</td></tr>
<tr class="codeline" data-linenumber="3223"><td class="num" id="LN3223">3223</td><td class="line">    <span class='comment'>/* We don't need to know the bus_port, at this point this value may be wrong.</span></td></tr>
<tr class="codeline" data-linenumber="3224"><td class="num" id="LN3224">3224</td><td class="line">     <span class='comment'>* If it is used, it will be corrected in clusterManagerLoadInfoFromNode. */</span></td></tr>
<tr class="codeline" data-linenumber="3225"><td class="num" id="LN3225">3225</td><td class="line">    node-&gt;bus_port = bus_port ? bus_port : port + <span class='macro'>CLUSTER_MANAGER_PORT_INCR<span class='macro_popup'>10000</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3226"><td class="num" id="LN3226">3226</td><td class="line">    node-&gt;current_epoch = 0;</td></tr>
<tr class="codeline" data-linenumber="3227"><td class="num" id="LN3227">3227</td><td class="line">    node-&gt;ping_sent = 0;</td></tr>
<tr class="codeline" data-linenumber="3228"><td class="num" id="LN3228">3228</td><td class="line">    node-&gt;ping_recv = 0;</td></tr>
<tr class="codeline" data-linenumber="3229"><td class="num" id="LN3229">3229</td><td class="line">    node-&gt;flags = 0;</td></tr>
<tr class="codeline" data-linenumber="3230"><td class="num" id="LN3230">3230</td><td class="line">    node-&gt;flags_str = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3231"><td class="num" id="LN3231">3231</td><td class="line">    node-&gt;replicate = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3232"><td class="num" id="LN3232">3232</td><td class="line">    node-&gt;dirty = 0;</td></tr>
<tr class="codeline" data-linenumber="3233"><td class="num" id="LN3233">3233</td><td class="line">    node-&gt;friends = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3234"><td class="num" id="LN3234">3234</td><td class="line">    node-&gt;migrating = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3235"><td class="num" id="LN3235">3235</td><td class="line">    node-&gt;importing = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3236"><td class="num" id="LN3236">3236</td><td class="line">    node-&gt;migrating_count = 0;</td></tr>
<tr class="codeline" data-linenumber="3237"><td class="num" id="LN3237">3237</td><td class="line">    node-&gt;importing_count = 0;</td></tr>
<tr class="codeline" data-linenumber="3238"><td class="num" id="LN3238">3238</td><td class="line">    node-&gt;replicas_count = 0;</td></tr>
<tr class="codeline" data-linenumber="3239"><td class="num" id="LN3239">3239</td><td class="line">    node-&gt;weight = 1.0f;</td></tr>
<tr class="codeline" data-linenumber="3240"><td class="num" id="LN3240">3240</td><td class="line">    node-&gt;balance = 0;</td></tr>
<tr class="codeline" data-linenumber="3241"><td class="num" id="LN3241">3241</td><td class="line">    clusterManagerNodeResetSlots(node);</td></tr>
<tr class="codeline" data-linenumber="3242"><td class="num" id="LN3242">3242</td><td class="line">    <span class='keyword'>return</span> node;</td></tr>
<tr class="codeline" data-linenumber="3243"><td class="num" id="LN3243">3243</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3244"><td class="num" id="LN3244">3244</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3245"><td class="num" id="LN3245">3245</td><td class="line"><span class='keyword'>static</span> <span class='macro'>sds<span class='macro_popup'>hisds</span></span> clusterManagerGetNodeRDBFilename(clusterManagerNode *node) {</td></tr>
<tr class="codeline" data-linenumber="3246"><td class="num" id="LN3246">3246</td><td class="line">    <span class='macro'>assert(config.cluster_manager_command.backup_dir)<span class='macro_popup'>((config.cluster_manager_command.backup_dir) ? (void) (0) : __assert_fail<br> ("config.cluster_manager_command.backup_dir", "redis-cli.c",<br> 3246, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3247"><td class="num" id="LN3247">3247</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> filename = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(config.cluster_manager_command.backup_dir);</td></tr>
<tr class="codeline" data-linenumber="3248"><td class="num" id="LN3248">3248</td><td class="line">    <span class='keyword'>if</span> (filename[<span class='macro'>sdslen<span class='macro_popup'>hi_sdslen</span></span>(filename) - 1] != '/')</td></tr>
<tr class="codeline" data-linenumber="3249"><td class="num" id="LN3249">3249</td><td class="line">        filename = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(filename, <span class='string_literal'>"/"</span>);</td></tr>
<tr class="codeline" data-linenumber="3250"><td class="num" id="LN3250">3250</td><td class="line">    filename = <span class='macro'>sdscatprintf<span class='macro_popup'>hi_sdscatprintf</span></span>(filename, <span class='string_literal'>"redis-node-%s-%d-%s.rdb"</span>, node-&gt;ip,</td></tr>
<tr class="codeline" data-linenumber="3251"><td class="num" id="LN3251">3251</td><td class="line">                            node-&gt;port, node-&gt;name);</td></tr>
<tr class="codeline" data-linenumber="3252"><td class="num" id="LN3252">3252</td><td class="line">    <span class='keyword'>return</span> filename;</td></tr>
<tr class="codeline" data-linenumber="3253"><td class="num" id="LN3253">3253</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3254"><td class="num" id="LN3254">3254</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3255"><td class="num" id="LN3255">3255</td><td class="line"><span class='comment'>/* Check whether reply is NULL or its type is REDIS_REPLY_ERROR. In the</span></td></tr>
<tr class="codeline" data-linenumber="3256"><td class="num" id="LN3256">3256</td><td class="line"> <span class='comment'>* latest case, if the 'err' arg is not NULL, it gets allocated with a copy</span></td></tr>
<tr class="codeline" data-linenumber="3257"><td class="num" id="LN3257">3257</td><td class="line"> <span class='comment'>* of reply error (it's up to the caller function to free it), elsewhere</span></td></tr>
<tr class="codeline" data-linenumber="3258"><td class="num" id="LN3258">3258</td><td class="line"> <span class='comment'>* the error is directly printed. */</span></td></tr>
<tr class="codeline" data-linenumber="3259"><td class="num" id="LN3259">3259</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerCheckRedisReply(clusterManagerNode *n,</td></tr>
<tr class="codeline" data-linenumber="3260"><td class="num" id="LN3260">3260</td><td class="line">                                         redisReply *r, <span class='keyword'>char</span> **err)</td></tr>
<tr class="codeline" data-linenumber="3261"><td class="num" id="LN3261">3261</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3262"><td class="num" id="LN3262">3262</td><td class="line">    <span class='keyword'>int</span> is_err = 0;</td></tr>
<tr class="codeline" data-linenumber="3263"><td class="num" id="LN3263">3263</td><td class="line">    <span class='keyword'>if</span> (!r || (is_err = (r-&gt;type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>))) {</td></tr>
<tr class="codeline" data-linenumber="3264"><td class="num" id="LN3264">3264</td><td class="line">        <span class='keyword'>if</span> (is_err) {</td></tr>
<tr class="codeline" data-linenumber="3265"><td class="num" id="LN3265">3265</td><td class="line">            <span class='keyword'>if</span> (err != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3266"><td class="num" id="LN3266">3266</td><td class="line">                *err = zmalloc((r-&gt;len + 1) * <span class='keyword'>sizeof</span>(<span class='keyword'>char</span>));</td></tr>
<tr class="codeline" data-linenumber="3267"><td class="num" id="LN3267">3267</td><td class="line">                strcpy(*err, r-&gt;str);</td></tr>
<tr class="codeline" data-linenumber="3268"><td class="num" id="LN3268">3268</td><td class="line">            } <span class='keyword'>else</span> <span class='macro'>CLUSTER_MANAGER_PRINT_REPLY_ERROR(n, r-&gt;str)<span class='macro_popup'>clusterManagerLog(3,"Node %s:%d replied with error:\n%s\n", n<br>-&gt;ip, n-&gt;port, r-&gt;str);</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3269"><td class="num" id="LN3269">3269</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3270"><td class="num" id="LN3270">3270</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3271"><td class="num" id="LN3271">3271</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3272"><td class="num" id="LN3272">3272</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="3273"><td class="num" id="LN3273">3273</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3274"><td class="num" id="LN3274">3274</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3275"><td class="num" id="LN3275">3275</td><td class="line"><span class='comment'>/* Call MULTI command on a cluster node. */</span></td></tr>
<tr class="codeline" data-linenumber="3276"><td class="num" id="LN3276">3276</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerStartTransaction(clusterManagerNode *node) {</td></tr>
<tr class="codeline" data-linenumber="3277"><td class="num" id="LN3277">3277</td><td class="line">    redisReply *reply = <span class='macro'>CLUSTER_MANAGER_COMMAND(node, <span class='string_literal'>"MULTI"</span>)<span class='macro_popup'>(redisCommand(node-&gt;context, "MULTI"))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3278"><td class="num" id="LN3278">3278</td><td class="line">    <span class='keyword'>int</span> success = clusterManagerCheckRedisReply(node, reply, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3279"><td class="num" id="LN3279">3279</td><td class="line">    <span class='keyword'>if</span> (reply) freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="3280"><td class="num" id="LN3280">3280</td><td class="line">    <span class='keyword'>return</span> success;</td></tr>
<tr class="codeline" data-linenumber="3281"><td class="num" id="LN3281">3281</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3282"><td class="num" id="LN3282">3282</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3283"><td class="num" id="LN3283">3283</td><td class="line"><span class='comment'>/* Call EXEC command on a cluster node. */</span></td></tr>
<tr class="codeline" data-linenumber="3284"><td class="num" id="LN3284">3284</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerExecTransaction(clusterManagerNode *node,</td></tr>
<tr class="codeline" data-linenumber="3285"><td class="num" id="LN3285">3285</td><td class="line">                                         clusterManagerOnReplyError onerror)</td></tr>
<tr class="codeline" data-linenumber="3286"><td class="num" id="LN3286">3286</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3287"><td class="num" id="LN3287">3287</td><td class="line">    redisReply *reply = <span class='macro'>CLUSTER_MANAGER_COMMAND(node, <span class='string_literal'>"EXEC"</span>)<span class='macro_popup'>(redisCommand(node-&gt;context, "EXEC"))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3288"><td class="num" id="LN3288">3288</td><td class="line">    <span class='keyword'>int</span> success = clusterManagerCheckRedisReply(node, reply, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3289"><td class="num" id="LN3289">3289</td><td class="line">    <span class='keyword'>if</span> (success) {</td></tr>
<tr class="codeline" data-linenumber="3290"><td class="num" id="LN3290">3290</td><td class="line">        <span class='keyword'>if</span> (reply-&gt;type != <span class='macro'>REDIS_REPLY_ARRAY<span class='macro_popup'>2</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3291"><td class="num" id="LN3291">3291</td><td class="line">            success = 0;</td></tr>
<tr class="codeline" data-linenumber="3292"><td class="num" id="LN3292">3292</td><td class="line">            <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="3293"><td class="num" id="LN3293">3293</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3294"><td class="num" id="LN3294">3294</td><td class="line">        size_t i;</td></tr>
<tr class="codeline" data-linenumber="3295"><td class="num" id="LN3295">3295</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; reply-&gt;elements; i++) {</td></tr>
<tr class="codeline" data-linenumber="3296"><td class="num" id="LN3296">3296</td><td class="line">            redisReply *r = reply-&gt;element[i];</td></tr>
<tr class="codeline" data-linenumber="3297"><td class="num" id="LN3297">3297</td><td class="line">            <span class='keyword'>char</span> *err = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3298"><td class="num" id="LN3298">3298</td><td class="line">            success = clusterManagerCheckRedisReply(node, r, &amp;err);</td></tr>
<tr class="codeline" data-linenumber="3299"><td class="num" id="LN3299">3299</td><td class="line">            <span class='keyword'>if</span> (!success &amp;&amp; onerror) success = onerror(r, node, i);</td></tr>
<tr class="codeline" data-linenumber="3300"><td class="num" id="LN3300">3300</td><td class="line">            <span class='keyword'>if</span> (err) {</td></tr>
<tr class="codeline" data-linenumber="3301"><td class="num" id="LN3301">3301</td><td class="line">                <span class='keyword'>if</span> (!success)</td></tr>
<tr class="codeline" data-linenumber="3302"><td class="num" id="LN3302">3302</td><td class="line">                    <span class='macro'>CLUSTER_MANAGER_PRINT_REPLY_ERROR(node, err)<span class='macro_popup'>clusterManagerLog(3,"Node %s:%d replied with error:\n%s\n", node<br>-&gt;ip, node-&gt;port, err);</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3303"><td class="num" id="LN3303">3303</td><td class="line">                zfree(err);</td></tr>
<tr class="codeline" data-linenumber="3304"><td class="num" id="LN3304">3304</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="3305"><td class="num" id="LN3305">3305</td><td class="line">            <span class='keyword'>if</span> (!success) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3306"><td class="num" id="LN3306">3306</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3307"><td class="num" id="LN3307">3307</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3308"><td class="num" id="LN3308">3308</td><td class="line">cleanup:</td></tr>
<tr class="codeline" data-linenumber="3309"><td class="num" id="LN3309">3309</td><td class="line">    <span class='keyword'>if</span> (reply) freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="3310"><td class="num" id="LN3310">3310</td><td class="line">    <span class='keyword'>return</span> success;</td></tr>
<tr class="codeline" data-linenumber="3311"><td class="num" id="LN3311">3311</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3312"><td class="num" id="LN3312">3312</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3313"><td class="num" id="LN3313">3313</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerNodeConnect(clusterManagerNode *node) {</td></tr>
<tr class="codeline" data-linenumber="3314"><td class="num" id="LN3314">3314</td><td class="line">    <span class='keyword'>if</span> (node-&gt;context) redisFree(node-&gt;context);</td></tr>
<tr class="codeline" data-linenumber="3315"><td class="num" id="LN3315">3315</td><td class="line">    node-&gt;context = redisConnect(node-&gt;ip, node-&gt;port);</td></tr>
<tr class="codeline" data-linenumber="3316"><td class="num" id="LN3316">3316</td><td class="line">    <span class='keyword'>if</span> (!node-&gt;context-&gt;err &amp;&amp; config.tls) {</td></tr>
<tr class="codeline" data-linenumber="3317"><td class="num" id="LN3317">3317</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>char</span> *err = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3318"><td class="num" id="LN3318">3318</td><td class="line">        <span class='keyword'>if</span> (cliSecureConnection(node-&gt;context, config.sslconfig, &amp;err) == <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span> &amp;&amp; err) {</td></tr>
<tr class="codeline" data-linenumber="3319"><td class="num" id="LN3319">3319</td><td class="line">            fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"TLS Error: %s\n"</span>, err);</td></tr>
<tr class="codeline" data-linenumber="3320"><td class="num" id="LN3320">3320</td><td class="line">            redisFree(node-&gt;context);</td></tr>
<tr class="codeline" data-linenumber="3321"><td class="num" id="LN3321">3321</td><td class="line">            node-&gt;context = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3322"><td class="num" id="LN3322">3322</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3323"><td class="num" id="LN3323">3323</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3324"><td class="num" id="LN3324">3324</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3325"><td class="num" id="LN3325">3325</td><td class="line">    <span class='keyword'>if</span> (node-&gt;context-&gt;err) {</td></tr>
<tr class="codeline" data-linenumber="3326"><td class="num" id="LN3326">3326</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"Could not connect to Redis at "</span>);</td></tr>
<tr class="codeline" data-linenumber="3327"><td class="num" id="LN3327">3327</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"%s:%d: %s\n"</span>, node-&gt;ip, node-&gt;port,</td></tr>
<tr class="codeline" data-linenumber="3328"><td class="num" id="LN3328">3328</td><td class="line">                node-&gt;context-&gt;errstr);</td></tr>
<tr class="codeline" data-linenumber="3329"><td class="num" id="LN3329">3329</td><td class="line">        redisFree(node-&gt;context);</td></tr>
<tr class="codeline" data-linenumber="3330"><td class="num" id="LN3330">3330</td><td class="line">        node-&gt;context = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3331"><td class="num" id="LN3331">3331</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3332"><td class="num" id="LN3332">3332</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3333"><td class="num" id="LN3333">3333</td><td class="line">    <span class='comment'>/* Set aggressive KEEP_ALIVE socket option in the Redis context socket</span></td></tr>
<tr class="codeline" data-linenumber="3334"><td class="num" id="LN3334">3334</td><td class="line">     <span class='comment'>* in order to prevent timeouts caused by the execution of long</span></td></tr>
<tr class="codeline" data-linenumber="3335"><td class="num" id="LN3335">3335</td><td class="line">     <span class='comment'>* commands. At the same time this improves the detection of real</span></td></tr>
<tr class="codeline" data-linenumber="3336"><td class="num" id="LN3336">3336</td><td class="line">     <span class='comment'>* errors. */</span></td></tr>
<tr class="codeline" data-linenumber="3337"><td class="num" id="LN3337">3337</td><td class="line">    anetKeepAlive(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, node-&gt;context-&gt;fd, <span class='macro'>REDIS_CLI_KEEPALIVE_INTERVAL<span class='macro_popup'>15</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3338"><td class="num" id="LN3338">3338</td><td class="line">    <span class='keyword'>if</span> (config.conn_info.auth) {</td></tr>
<tr class="codeline" data-linenumber="3339"><td class="num" id="LN3339">3339</td><td class="line">        redisReply *reply;</td></tr>
<tr class="codeline" data-linenumber="3340"><td class="num" id="LN3340">3340</td><td class="line">        <span class='keyword'>if</span> (config.conn_info.user == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3341"><td class="num" id="LN3341">3341</td><td class="line">            reply = redisCommand(node-&gt;context,<span class='string_literal'>"AUTH %s"</span>, config.conn_info.auth);</td></tr>
<tr class="codeline" data-linenumber="3342"><td class="num" id="LN3342">3342</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="3343"><td class="num" id="LN3343">3343</td><td class="line">            reply = redisCommand(node-&gt;context,<span class='string_literal'>"AUTH %s %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="3344"><td class="num" id="LN3344">3344</td><td class="line">                                 config.conn_info.user,config.conn_info.auth);</td></tr>
<tr class="codeline" data-linenumber="3345"><td class="num" id="LN3345">3345</td><td class="line">        <span class='keyword'>int</span> ok = clusterManagerCheckRedisReply(node, reply, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3346"><td class="num" id="LN3346">3346</td><td class="line">        <span class='keyword'>if</span> (reply != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="3347"><td class="num" id="LN3347">3347</td><td class="line">        <span class='keyword'>if</span> (!ok) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3348"><td class="num" id="LN3348">3348</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3349"><td class="num" id="LN3349">3349</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="3350"><td class="num" id="LN3350">3350</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3351"><td class="num" id="LN3351">3351</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3352"><td class="num" id="LN3352">3352</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> clusterManagerRemoveNodeFromList(list *nodelist,</td></tr>
<tr class="codeline" data-linenumber="3353"><td class="num" id="LN3353">3353</td><td class="line">                                             clusterManagerNode *node) {</td></tr>
<tr class="codeline" data-linenumber="3354"><td class="num" id="LN3354">3354</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="3355"><td class="num" id="LN3355">3355</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="3356"><td class="num" id="LN3356">3356</td><td class="line">    listRewind(nodelist, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="3357"><td class="num" id="LN3357">3357</td><td class="line">    <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3358"><td class="num" id="LN3358">3358</td><td class="line">        <span class='keyword'>if</span> (node == ln-&gt;value) {</td></tr>
<tr class="codeline" data-linenumber="3359"><td class="num" id="LN3359">3359</td><td class="line">            listDelNode(nodelist, ln);</td></tr>
<tr class="codeline" data-linenumber="3360"><td class="num" id="LN3360">3360</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3361"><td class="num" id="LN3361">3361</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3362"><td class="num" id="LN3362">3362</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3363"><td class="num" id="LN3363">3363</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3364"><td class="num" id="LN3364">3364</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3365"><td class="num" id="LN3365">3365</td><td class="line"><span class='comment'>/* Return the node with the specified name (ID) or NULL. */</span></td></tr>
<tr class="codeline" data-linenumber="3366"><td class="num" id="LN3366">3366</td><td class="line"><span class='keyword'>static</span> clusterManagerNode *clusterManagerNodeByName(<span class='keyword'>const</span> <span class='keyword'>char</span> *name) {</td></tr>
<tr class="codeline" data-linenumber="3367"><td class="num" id="LN3367">3367</td><td class="line">    <span class='keyword'>if</span> (cluster_manager.nodes == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3368"><td class="num" id="LN3368">3368</td><td class="line">    clusterManagerNode *found = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3369"><td class="num" id="LN3369">3369</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> lcname = <span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>();</td></tr>
<tr class="codeline" data-linenumber="3370"><td class="num" id="LN3370">3370</td><td class="line">    lcname = <span class='macro'>sdscpy<span class='macro_popup'>hi_sdscpy</span></span>(lcname, name);</td></tr>
<tr class="codeline" data-linenumber="3371"><td class="num" id="LN3371">3371</td><td class="line">    <span class='macro'>sdstolower<span class='macro_popup'>hi_sdstolower</span></span>(lcname);</td></tr>
<tr class="codeline" data-linenumber="3372"><td class="num" id="LN3372">3372</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="3373"><td class="num" id="LN3373">3373</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="3374"><td class="num" id="LN3374">3374</td><td class="line">    listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="3375"><td class="num" id="LN3375">3375</td><td class="line">    <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3376"><td class="num" id="LN3376">3376</td><td class="line">        clusterManagerNode *n = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="3377"><td class="num" id="LN3377">3377</td><td class="line">        <span class='keyword'>if</span> (n-&gt;name &amp;&amp; !<span class='macro'>sdscmp<span class='macro_popup'>hi_sdscmp</span></span>(n-&gt;name, lcname)) {</td></tr>
<tr class="codeline" data-linenumber="3378"><td class="num" id="LN3378">3378</td><td class="line">            found = n;</td></tr>
<tr class="codeline" data-linenumber="3379"><td class="num" id="LN3379">3379</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3380"><td class="num" id="LN3380">3380</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3381"><td class="num" id="LN3381">3381</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3382"><td class="num" id="LN3382">3382</td><td class="line">    <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(lcname);</td></tr>
<tr class="codeline" data-linenumber="3383"><td class="num" id="LN3383">3383</td><td class="line">    <span class='keyword'>return</span> found;</td></tr>
<tr class="codeline" data-linenumber="3384"><td class="num" id="LN3384">3384</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3385"><td class="num" id="LN3385">3385</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3386"><td class="num" id="LN3386">3386</td><td class="line"><span class='comment'>/* Like clusterManagerNodeByName but the specified name can be just the first</span></td></tr>
<tr class="codeline" data-linenumber="3387"><td class="num" id="LN3387">3387</td><td class="line"> <span class='comment'>* part of the node ID as long as the prefix in unique across the</span></td></tr>
<tr class="codeline" data-linenumber="3388"><td class="num" id="LN3388">3388</td><td class="line"> <span class='comment'>* cluster.</span></td></tr>
<tr class="codeline" data-linenumber="3389"><td class="num" id="LN3389">3389</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3390"><td class="num" id="LN3390">3390</td><td class="line"><span class='keyword'>static</span> clusterManagerNode *clusterManagerNodeByAbbreviatedName(<span class='keyword'>const</span> <span class='keyword'>char</span>*name)</td></tr>
<tr class="codeline" data-linenumber="3391"><td class="num" id="LN3391">3391</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3392"><td class="num" id="LN3392">3392</td><td class="line">    <span class='keyword'>if</span> (cluster_manager.nodes == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3393"><td class="num" id="LN3393">3393</td><td class="line">    clusterManagerNode *found = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3394"><td class="num" id="LN3394">3394</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> lcname = <span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>();</td></tr>
<tr class="codeline" data-linenumber="3395"><td class="num" id="LN3395">3395</td><td class="line">    lcname = <span class='macro'>sdscpy<span class='macro_popup'>hi_sdscpy</span></span>(lcname, name);</td></tr>
<tr class="codeline" data-linenumber="3396"><td class="num" id="LN3396">3396</td><td class="line">    <span class='macro'>sdstolower<span class='macro_popup'>hi_sdstolower</span></span>(lcname);</td></tr>
<tr class="codeline" data-linenumber="3397"><td class="num" id="LN3397">3397</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="3398"><td class="num" id="LN3398">3398</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="3399"><td class="num" id="LN3399">3399</td><td class="line">    listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="3400"><td class="num" id="LN3400">3400</td><td class="line">    <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3401"><td class="num" id="LN3401">3401</td><td class="line">        clusterManagerNode *n = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="3402"><td class="num" id="LN3402">3402</td><td class="line">        <span class='keyword'>if</span> (n-&gt;name &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3403"><td class="num" id="LN3403">3403</td><td class="line">            strstr(n-&gt;name, lcname) == n-&gt;name) {</td></tr>
<tr class="codeline" data-linenumber="3404"><td class="num" id="LN3404">3404</td><td class="line">            found = n;</td></tr>
<tr class="codeline" data-linenumber="3405"><td class="num" id="LN3405">3405</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3406"><td class="num" id="LN3406">3406</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3407"><td class="num" id="LN3407">3407</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3408"><td class="num" id="LN3408">3408</td><td class="line">    <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(lcname);</td></tr>
<tr class="codeline" data-linenumber="3409"><td class="num" id="LN3409">3409</td><td class="line">    <span class='keyword'>return</span> found;</td></tr>
<tr class="codeline" data-linenumber="3410"><td class="num" id="LN3410">3410</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3411"><td class="num" id="LN3411">3411</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3412"><td class="num" id="LN3412">3412</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> clusterManagerNodeResetSlots(clusterManagerNode *node) {</td></tr>
<tr class="codeline" data-linenumber="3413"><td class="num" id="LN3413">3413</td><td class="line">    memset(node-&gt;slots, 0, <span class='keyword'>sizeof</span>(node-&gt;slots));</td></tr>
<tr class="codeline" data-linenumber="3414"><td class="num" id="LN3414">3414</td><td class="line">    node-&gt;slots_count = 0;</td></tr>
<tr class="codeline" data-linenumber="3415"><td class="num" id="LN3415">3415</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3416"><td class="num" id="LN3416">3416</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3417"><td class="num" id="LN3417">3417</td><td class="line"><span class='comment'>/* Call "INFO" redis command on the specified node and return the reply. */</span></td></tr>
<tr class="codeline" data-linenumber="3418"><td class="num" id="LN3418">3418</td><td class="line"><span class='keyword'>static</span> redisReply *clusterManagerGetNodeRedisInfo(clusterManagerNode *node,</td></tr>
<tr class="codeline" data-linenumber="3419"><td class="num" id="LN3419">3419</td><td class="line">                                                  <span class='keyword'>char</span> **err)</td></tr>
<tr class="codeline" data-linenumber="3420"><td class="num" id="LN3420">3420</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3421"><td class="num" id="LN3421">3421</td><td class="line">    redisReply *info = <span class='macro'>CLUSTER_MANAGER_COMMAND(node, <span class='string_literal'>"INFO"</span>)<span class='macro_popup'>(redisCommand(node-&gt;context, "INFO"))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3422"><td class="num" id="LN3422">3422</td><td class="line">    <span class='keyword'>if</span> (err != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) *err = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3423"><td class="num" id="LN3423">3423</td><td class="line">    <span class='keyword'>if</span> (info == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3424"><td class="num" id="LN3424">3424</td><td class="line">    <span class='keyword'>if</span> (info-&gt;type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3425"><td class="num" id="LN3425">3425</td><td class="line">        <span class='keyword'>if</span> (err != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3426"><td class="num" id="LN3426">3426</td><td class="line">            *err = zmalloc((info-&gt;len + 1) * <span class='keyword'>sizeof</span>(<span class='keyword'>char</span>));</td></tr>
<tr class="codeline" data-linenumber="3427"><td class="num" id="LN3427">3427</td><td class="line">            strcpy(*err, info-&gt;str);</td></tr>
<tr class="codeline" data-linenumber="3428"><td class="num" id="LN3428">3428</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3429"><td class="num" id="LN3429">3429</td><td class="line">        freeReplyObject(info);</td></tr>
<tr class="codeline" data-linenumber="3430"><td class="num" id="LN3430">3430</td><td class="line">        <span class='keyword'>return</span>  <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3431"><td class="num" id="LN3431">3431</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3432"><td class="num" id="LN3432">3432</td><td class="line">    <span class='keyword'>return</span> info;</td></tr>
<tr class="codeline" data-linenumber="3433"><td class="num" id="LN3433">3433</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3434"><td class="num" id="LN3434">3434</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3435"><td class="num" id="LN3435">3435</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerNodeIsCluster(clusterManagerNode *node, <span class='keyword'>char</span> **err) {</td></tr>
<tr class="codeline" data-linenumber="3436"><td class="num" id="LN3436">3436</td><td class="line">    redisReply *info = clusterManagerGetNodeRedisInfo(node, err);</td></tr>
<tr class="codeline" data-linenumber="3437"><td class="num" id="LN3437">3437</td><td class="line">    <span class='keyword'>if</span> (info == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3438"><td class="num" id="LN3438">3438</td><td class="line">    <span class='keyword'>int</span> is_cluster = (<span class='keyword'>int</span>) getLongInfoField(info-&gt;str, <span class='string_literal'>"cluster_enabled"</span>);</td></tr>
<tr class="codeline" data-linenumber="3439"><td class="num" id="LN3439">3439</td><td class="line">    freeReplyObject(info);</td></tr>
<tr class="codeline" data-linenumber="3440"><td class="num" id="LN3440">3440</td><td class="line">    <span class='keyword'>return</span> is_cluster;</td></tr>
<tr class="codeline" data-linenumber="3441"><td class="num" id="LN3441">3441</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3442"><td class="num" id="LN3442">3442</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3443"><td class="num" id="LN3443">3443</td><td class="line"><span class='comment'>/* Checks whether the node is empty. Node is considered not-empty if it has</span></td></tr>
<tr class="codeline" data-linenumber="3444"><td class="num" id="LN3444">3444</td><td class="line"> <span class='comment'>* some key or if it already knows other nodes */</span></td></tr>
<tr class="codeline" data-linenumber="3445"><td class="num" id="LN3445">3445</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerNodeIsEmpty(clusterManagerNode *node, <span class='keyword'>char</span> **err) {</td></tr>
<tr class="codeline" data-linenumber="3446"><td class="num" id="LN3446">3446</td><td class="line">    redisReply *info = clusterManagerGetNodeRedisInfo(node, err);</td></tr>
<tr class="codeline" data-linenumber="3447"><td class="num" id="LN3447">3447</td><td class="line">    <span class='keyword'>int</span> is_empty = 1;</td></tr>
<tr class="codeline" data-linenumber="3448"><td class="num" id="LN3448">3448</td><td class="line">    <span class='keyword'>if</span> (info == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3449"><td class="num" id="LN3449">3449</td><td class="line">    <span class='keyword'>if</span> (strstr(info-&gt;str, <span class='string_literal'>"db0:"</span>) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3450"><td class="num" id="LN3450">3450</td><td class="line">        is_empty = 0;</td></tr>
<tr class="codeline" data-linenumber="3451"><td class="num" id="LN3451">3451</td><td class="line">        <span class='keyword'>goto</span> result;</td></tr>
<tr class="codeline" data-linenumber="3452"><td class="num" id="LN3452">3452</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3453"><td class="num" id="LN3453">3453</td><td class="line">    freeReplyObject(info);</td></tr>
<tr class="codeline" data-linenumber="3454"><td class="num" id="LN3454">3454</td><td class="line">    info = <span class='macro'>CLUSTER_MANAGER_COMMAND(node, <span class='string_literal'>"CLUSTER INFO"</span>)<span class='macro_popup'>(redisCommand(node-&gt;context, "CLUSTER INFO"))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3455"><td class="num" id="LN3455">3455</td><td class="line">    <span class='keyword'>if</span> (err != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) *err = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3456"><td class="num" id="LN3456">3456</td><td class="line">    <span class='keyword'>if</span> (!clusterManagerCheckRedisReply(node, info, err)) {</td></tr>
<tr class="codeline" data-linenumber="3457"><td class="num" id="LN3457">3457</td><td class="line">        is_empty = 0;</td></tr>
<tr class="codeline" data-linenumber="3458"><td class="num" id="LN3458">3458</td><td class="line">        <span class='keyword'>goto</span> result;</td></tr>
<tr class="codeline" data-linenumber="3459"><td class="num" id="LN3459">3459</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3460"><td class="num" id="LN3460">3460</td><td class="line">    <span class='keyword'>long</span> known_nodes = getLongInfoField(info-&gt;str, <span class='string_literal'>"cluster_known_nodes"</span>);</td></tr>
<tr class="codeline" data-linenumber="3461"><td class="num" id="LN3461">3461</td><td class="line">    is_empty = (known_nodes == 1);</td></tr>
<tr class="codeline" data-linenumber="3462"><td class="num" id="LN3462">3462</td><td class="line">result:</td></tr>
<tr class="codeline" data-linenumber="3463"><td class="num" id="LN3463">3463</td><td class="line">    freeReplyObject(info);</td></tr>
<tr class="codeline" data-linenumber="3464"><td class="num" id="LN3464">3464</td><td class="line">    <span class='keyword'>return</span> is_empty;</td></tr>
<tr class="codeline" data-linenumber="3465"><td class="num" id="LN3465">3465</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3466"><td class="num" id="LN3466">3466</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3467"><td class="num" id="LN3467">3467</td><td class="line"><span class='comment'>/* Return the anti-affinity score, which is a measure of the amount of</span></td></tr>
<tr class="codeline" data-linenumber="3468"><td class="num" id="LN3468">3468</td><td class="line"> <span class='comment'>* violations of anti-affinity in the current cluster layout, that is, how</span></td></tr>
<tr class="codeline" data-linenumber="3469"><td class="num" id="LN3469">3469</td><td class="line"> <span class='comment'>* badly the masters and slaves are distributed in the different IP</span></td></tr>
<tr class="codeline" data-linenumber="3470"><td class="num" id="LN3470">3470</td><td class="line"> <span class='comment'>* addresses so that slaves of the same master are not in the master</span></td></tr>
<tr class="codeline" data-linenumber="3471"><td class="num" id="LN3471">3471</td><td class="line"> <span class='comment'>* host and are also in different hosts.</span></td></tr>
<tr class="codeline" data-linenumber="3472"><td class="num" id="LN3472">3472</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3473"><td class="num" id="LN3473">3473</td><td class="line"> <span class='comment'>* The score is calculated as follows:</span></td></tr>
<tr class="codeline" data-linenumber="3474"><td class="num" id="LN3474">3474</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3475"><td class="num" id="LN3475">3475</td><td class="line"> <span class='comment'>* SAME_AS_MASTER = 10000 * each slave in the same IP of its master.</span></td></tr>
<tr class="codeline" data-linenumber="3476"><td class="num" id="LN3476">3476</td><td class="line"> <span class='comment'>* SAME_AS_SLAVE  = 1 * each slave having the same IP as another slave</span></td></tr>
<tr class="codeline" data-linenumber="3477"><td class="num" id="LN3477">3477</td><td class="line">                      <span class='comment'>of the same master.</span></td></tr>
<tr class="codeline" data-linenumber="3478"><td class="num" id="LN3478">3478</td><td class="line"> <span class='comment'>* FINAL_SCORE = SAME_AS_MASTER + SAME_AS_SLAVE</span></td></tr>
<tr class="codeline" data-linenumber="3479"><td class="num" id="LN3479">3479</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3480"><td class="num" id="LN3480">3480</td><td class="line"> <span class='comment'>* So a greater score means a worse anti-affinity level, while zero</span></td></tr>
<tr class="codeline" data-linenumber="3481"><td class="num" id="LN3481">3481</td><td class="line"> <span class='comment'>* means perfect anti-affinity.</span></td></tr>
<tr class="codeline" data-linenumber="3482"><td class="num" id="LN3482">3482</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3483"><td class="num" id="LN3483">3483</td><td class="line"> <span class='comment'>* The anti affinity optimization will try to get a score as low as</span></td></tr>
<tr class="codeline" data-linenumber="3484"><td class="num" id="LN3484">3484</td><td class="line"> <span class='comment'>* possible. Since we do not want to sacrifice the fact that slaves should</span></td></tr>
<tr class="codeline" data-linenumber="3485"><td class="num" id="LN3485">3485</td><td class="line"> <span class='comment'>* not be in the same host as the master, we assign 10000 times the score</span></td></tr>
<tr class="codeline" data-linenumber="3486"><td class="num" id="LN3486">3486</td><td class="line"> <span class='comment'>* to this violation, so that we'll optimize for the second factor only</span></td></tr>
<tr class="codeline" data-linenumber="3487"><td class="num" id="LN3487">3487</td><td class="line"> <span class='comment'>* if it does not impact the first one.</span></td></tr>
<tr class="codeline" data-linenumber="3488"><td class="num" id="LN3488">3488</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3489"><td class="num" id="LN3489">3489</td><td class="line"> <span class='comment'>* The ipnodes argument is an array of clusterManagerNodeArray, one for</span></td></tr>
<tr class="codeline" data-linenumber="3490"><td class="num" id="LN3490">3490</td><td class="line"> <span class='comment'>* each IP, while ip_count is the total number of IPs in the configuration.</span></td></tr>
<tr class="codeline" data-linenumber="3491"><td class="num" id="LN3491">3491</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3492"><td class="num" id="LN3492">3492</td><td class="line"> <span class='comment'>* The function returns the above score, and the list of</span></td></tr>
<tr class="codeline" data-linenumber="3493"><td class="num" id="LN3493">3493</td><td class="line"> <span class='comment'>* offending slaves can be stored into the 'offending' argument,</span></td></tr>
<tr class="codeline" data-linenumber="3494"><td class="num" id="LN3494">3494</td><td class="line"> <span class='comment'>* so that the optimizer can try changing the configuration of the</span></td></tr>
<tr class="codeline" data-linenumber="3495"><td class="num" id="LN3495">3495</td><td class="line"> <span class='comment'>* slaves violating the anti-affinity goals. */</span></td></tr>
<tr class="codeline" data-linenumber="3496"><td class="num" id="LN3496">3496</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerGetAntiAffinityScore(clusterManagerNodeArray *ipnodes,</td></tr>
<tr class="codeline" data-linenumber="3497"><td class="num" id="LN3497">3497</td><td class="line">    <span class='keyword'>int</span> ip_count, clusterManagerNode ***offending, <span class='keyword'>int</span> *offending_len)</td></tr>
<tr class="codeline" data-linenumber="3498"><td class="num" id="LN3498">3498</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3499"><td class="num" id="LN3499">3499</td><td class="line">    <span class='keyword'>int</span> score = 0, i, j;</td></tr>
<tr class="codeline" data-linenumber="3500"><td class="num" id="LN3500">3500</td><td class="line">    <span class='keyword'>int</span> node_len = cluster_manager.nodes-&gt;len;</td></tr>
<tr class="codeline" data-linenumber="3501"><td class="num" id="LN3501">3501</td><td class="line">    clusterManagerNode **offending_p = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3502"><td class="num" id="LN3502">3502</td><td class="line">    <span class='keyword'>if</span> (offending != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3503"><td class="num" id="LN3503">3503</td><td class="line">        *offending = zcalloc(node_len * <span class='keyword'>sizeof</span>(clusterManagerNode*));</td></tr>
<tr class="codeline" data-linenumber="3504"><td class="num" id="LN3504">3504</td><td class="line">        offending_p = *offending;</td></tr>
<tr class="codeline" data-linenumber="3505"><td class="num" id="LN3505">3505</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3506"><td class="num" id="LN3506">3506</td><td class="line">    <span class='comment'>/* For each set of nodes in the same host, split by</span></td></tr>
<tr class="codeline" data-linenumber="3507"><td class="num" id="LN3507">3507</td><td class="line">     <span class='comment'>* related nodes (masters and slaves which are involved in</span></td></tr>
<tr class="codeline" data-linenumber="3508"><td class="num" id="LN3508">3508</td><td class="line">     <span class='comment'>* replication of each other) */</span></td></tr>
<tr class="codeline" data-linenumber="3509"><td class="num" id="LN3509">3509</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; ip_count; i++) {</td></tr>
<tr class="codeline" data-linenumber="3510"><td class="num" id="LN3510">3510</td><td class="line">        clusterManagerNodeArray *node_array = &amp;(ipnodes[i]);</td></tr>
<tr class="codeline" data-linenumber="3511"><td class="num" id="LN3511">3511</td><td class="line">        dict *related = dictCreate(&amp;clusterManagerDictType);</td></tr>
<tr class="codeline" data-linenumber="3512"><td class="num" id="LN3512">3512</td><td class="line">        <span class='keyword'>char</span> *ip = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3513"><td class="num" id="LN3513">3513</td><td class="line">        <span class='keyword'>for</span> (j = 0; j &lt; node_array-&gt;len; j++) {</td></tr>
<tr class="codeline" data-linenumber="3514"><td class="num" id="LN3514">3514</td><td class="line">            clusterManagerNode *node = node_array-&gt;nodes[j];</td></tr>
<tr class="codeline" data-linenumber="3515"><td class="num" id="LN3515">3515</td><td class="line">            <span class='keyword'>if</span> (node == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="3516"><td class="num" id="LN3516">3516</td><td class="line">            <span class='keyword'>if</span> (!ip) ip = node-&gt;ip;</td></tr>
<tr class="codeline" data-linenumber="3517"><td class="num" id="LN3517">3517</td><td class="line">            <span class='macro'>sds<span class='macro_popup'>hisds</span></span> types;</td></tr>
<tr class="codeline" data-linenumber="3518"><td class="num" id="LN3518">3518</td><td class="line">            <span class='comment'>/* We always use the Master ID as key. */</span></td></tr>
<tr class="codeline" data-linenumber="3519"><td class="num" id="LN3519">3519</td><td class="line">            <span class='macro'>sds<span class='macro_popup'>hisds</span></span> key = (!node-&gt;replicate ? node-&gt;name : node-&gt;replicate);</td></tr>
<tr class="codeline" data-linenumber="3520"><td class="num" id="LN3520">3520</td><td class="line">            <span class='macro'>assert(key != NULL)<span class='macro_popup'>((key != ((void*)0)) ? (void) (0) : __assert_fail ("key != NULL"<br>, "redis-cli.c", 3520, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3521"><td class="num" id="LN3521">3521</td><td class="line">            dictEntry *entry = dictFind(related, key);</td></tr>
<tr class="codeline" data-linenumber="3522"><td class="num" id="LN3522">3522</td><td class="line">            <span class='keyword'>if</span> (entry) types = <span class='macro'>sdsdup<span class='macro_popup'>hi_sdsdup</span></span>((<span class='macro'>sds<span class='macro_popup'>hisds</span></span>) <span class='macro'>dictGetVal(entry)<span class='macro_popup'>((entry)-&gt;v.val)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3523"><td class="num" id="LN3523">3523</td><td class="line">            <span class='keyword'>else</span> types = <span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>();</td></tr>
<tr class="codeline" data-linenumber="3524"><td class="num" id="LN3524">3524</td><td class="line">            <span class='comment'>/* Master type 'm' is always set as the first character of the</span></td></tr>
<tr class="codeline" data-linenumber="3525"><td class="num" id="LN3525">3525</td><td class="line">             <span class='comment'>* types string. */</span></td></tr>
<tr class="codeline" data-linenumber="3526"><td class="num" id="LN3526">3526</td><td class="line">            <span class='keyword'>if</span> (node-&gt;replicate) types = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(types, <span class='string_literal'>"s"</span>);</td></tr>
<tr class="codeline" data-linenumber="3527"><td class="num" id="LN3527">3527</td><td class="line">            <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="3528"><td class="num" id="LN3528">3528</td><td class="line">                <span class='macro'>sds<span class='macro_popup'>hisds</span></span> s = <span class='macro'>sdscatsds<span class='macro_popup'>hi_sdscatsds</span></span>(<span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(<span class='string_literal'>"m"</span>), types);</td></tr>
<tr class="codeline" data-linenumber="3529"><td class="num" id="LN3529">3529</td><td class="line">                <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(types);</td></tr>
<tr class="codeline" data-linenumber="3530"><td class="num" id="LN3530">3530</td><td class="line">                types = s;</td></tr>
<tr class="codeline" data-linenumber="3531"><td class="num" id="LN3531">3531</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="3532"><td class="num" id="LN3532">3532</td><td class="line">            dictReplace(related, key, types);</td></tr>
<tr class="codeline" data-linenumber="3533"><td class="num" id="LN3533">3533</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3534"><td class="num" id="LN3534">3534</td><td class="line">        <span class='comment'>/* Now it's trivial to check, for each related group having the</span></td></tr>
<tr class="codeline" data-linenumber="3535"><td class="num" id="LN3535">3535</td><td class="line">         <span class='comment'>* same host, what is their local score. */</span></td></tr>
<tr class="codeline" data-linenumber="3536"><td class="num" id="LN3536">3536</td><td class="line">        dictIterator *iter = dictGetIterator(related);</td></tr>
<tr class="codeline" data-linenumber="3537"><td class="num" id="LN3537">3537</td><td class="line">        dictEntry *entry;</td></tr>
<tr class="codeline" data-linenumber="3538"><td class="num" id="LN3538">3538</td><td class="line">        <span class='keyword'>while</span> ((entry = dictNext(iter)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3539"><td class="num" id="LN3539">3539</td><td class="line">            <span class='macro'>sds<span class='macro_popup'>hisds</span></span> types = (<span class='macro'>sds<span class='macro_popup'>hisds</span></span>) <span class='macro'>dictGetVal(entry)<span class='macro_popup'>((entry)-&gt;v.val)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3540"><td class="num" id="LN3540">3540</td><td class="line">            <span class='macro'>sds<span class='macro_popup'>hisds</span></span> name = (<span class='macro'>sds<span class='macro_popup'>hisds</span></span>) <span class='macro'>dictGetKey(entry)<span class='macro_popup'>((entry)-&gt;key)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3541"><td class="num" id="LN3541">3541</td><td class="line">            <span class='keyword'>int</span> typeslen = <span class='macro'>sdslen<span class='macro_popup'>hi_sdslen</span></span>(types);</td></tr>
<tr class="codeline" data-linenumber="3542"><td class="num" id="LN3542">3542</td><td class="line">            <span class='keyword'>if</span> (typeslen &lt; 2) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="3543"><td class="num" id="LN3543">3543</td><td class="line">            <span class='keyword'>if</span> (types[0] == 'm') score += (10000 * (typeslen - 1));</td></tr>
<tr class="codeline" data-linenumber="3544"><td class="num" id="LN3544">3544</td><td class="line">            <span class='keyword'>else</span> score += (1 * typeslen);</td></tr>
<tr class="codeline" data-linenumber="3545"><td class="num" id="LN3545">3545</td><td class="line">            <span class='keyword'>if</span> (offending == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="3546"><td class="num" id="LN3546">3546</td><td class="line">            <span class='comment'>/* Populate the list of offending nodes. */</span></td></tr>
<tr class="codeline" data-linenumber="3547"><td class="num" id="LN3547">3547</td><td class="line">            listIter li;</td></tr>
<tr class="codeline" data-linenumber="3548"><td class="num" id="LN3548">3548</td><td class="line">            listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="3549"><td class="num" id="LN3549">3549</td><td class="line">            listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="3550"><td class="num" id="LN3550">3550</td><td class="line">            <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3551"><td class="num" id="LN3551">3551</td><td class="line">                clusterManagerNode *n = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="3552"><td class="num" id="LN3552">3552</td><td class="line">                <span class='keyword'>if</span> (n-&gt;replicate == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="3553"><td class="num" id="LN3553">3553</td><td class="line">                <span class='keyword'>if</span> (!strcmp(n-&gt;replicate, name) &amp;&amp; !strcmp(n-&gt;ip, ip)) {</td></tr>
<tr class="codeline" data-linenumber="3554"><td class="num" id="LN3554">3554</td><td class="line">                    *(offending_p++) = n;</td></tr>
<tr class="codeline" data-linenumber="3555"><td class="num" id="LN3555">3555</td><td class="line">                    <span class='keyword'>if</span> (offending_len != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) (*offending_len)++;</td></tr>
<tr class="codeline" data-linenumber="3556"><td class="num" id="LN3556">3556</td><td class="line">                    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3557"><td class="num" id="LN3557">3557</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="3558"><td class="num" id="LN3558">3558</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="3559"><td class="num" id="LN3559">3559</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3560"><td class="num" id="LN3560">3560</td><td class="line">        <span class='comment'>//if (offending_len != NULL) *offending_len = offending_p - *offending;</span></td></tr>
<tr class="codeline" data-linenumber="3561"><td class="num" id="LN3561">3561</td><td class="line">        dictReleaseIterator(iter);</td></tr>
<tr class="codeline" data-linenumber="3562"><td class="num" id="LN3562">3562</td><td class="line">        dictRelease(related);</td></tr>
<tr class="codeline" data-linenumber="3563"><td class="num" id="LN3563">3563</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3564"><td class="num" id="LN3564">3564</td><td class="line">    <span class='keyword'>return</span> score;</td></tr>
<tr class="codeline" data-linenumber="3565"><td class="num" id="LN3565">3565</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3566"><td class="num" id="LN3566">3566</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3567"><td class="num" id="LN3567">3567</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> clusterManagerOptimizeAntiAffinity(clusterManagerNodeArray *ipnodes,</td></tr>
<tr class="codeline" data-linenumber="3568"><td class="num" id="LN3568">3568</td><td class="line">    <span class='keyword'>int</span> ip_count)</td></tr>
<tr class="codeline" data-linenumber="3569"><td class="num" id="LN3569">3569</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3570"><td class="num" id="LN3570">3570</td><td class="line">    clusterManagerNode **offenders = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3571"><td class="num" id="LN3571">3571</td><td class="line">    <span class='keyword'>int</span> score = clusterManagerGetAntiAffinityScore(ipnodes, ip_count,</td></tr>
<tr class="codeline" data-linenumber="3572"><td class="num" id="LN3572">3572</td><td class="line">                                                   <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3573"><td class="num" id="LN3573">3573</td><td class="line">    <span class='keyword'>if</span> (score == 0) <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="3574"><td class="num" id="LN3574">3574</td><td class="line">    <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Trying to optimize slaves allocation "<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Trying to optimize slaves allocation "<br> "for anti-affinity\n")</span></span></span></td></tr>
<tr class="codeline" data-linenumber="3575"><td class="num" id="LN3575">3575</td><td class="line">                          <span class='string_literal'><span class='macro'>"for anti-affinity\n"</span>)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Trying to optimize slaves allocation "<br> "for anti-affinity\n")</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3576"><td class="num" id="LN3576">3576</td><td class="line">    <span class='keyword'>int</span> node_len = cluster_manager.nodes-&gt;len;</td></tr>
<tr class="codeline" data-linenumber="3577"><td class="num" id="LN3577">3577</td><td class="line">    <span class='keyword'>int</span> maxiter = 500 * node_len; <span class='comment'>// Effort is proportional to cluster size...</span></td></tr>
<tr class="codeline" data-linenumber="3578"><td class="num" id="LN3578">3578</td><td class="line">    srand(time(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>));</td></tr>
<tr class="codeline" data-linenumber="3579"><td class="num" id="LN3579">3579</td><td class="line">    <span class='keyword'>while</span> (maxiter &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="3580"><td class="num" id="LN3580">3580</td><td class="line">        <span class='keyword'>int</span> offending_len = 0;</td></tr>
<tr class="codeline" data-linenumber="3581"><td class="num" id="LN3581">3581</td><td class="line">        <span class='keyword'>if</span> (offenders != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3582"><td class="num" id="LN3582">3582</td><td class="line">            zfree(offenders);</td></tr>
<tr class="codeline" data-linenumber="3583"><td class="num" id="LN3583">3583</td><td class="line">            offenders = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3584"><td class="num" id="LN3584">3584</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3585"><td class="num" id="LN3585">3585</td><td class="line">        score = clusterManagerGetAntiAffinityScore(ipnodes,</td></tr>
<tr class="codeline" data-linenumber="3586"><td class="num" id="LN3586">3586</td><td class="line">                                                   ip_count,</td></tr>
<tr class="codeline" data-linenumber="3587"><td class="num" id="LN3587">3587</td><td class="line">                                                   &amp;offenders,</td></tr>
<tr class="codeline" data-linenumber="3588"><td class="num" id="LN3588">3588</td><td class="line">                                                   &amp;offending_len);</td></tr>
<tr class="codeline" data-linenumber="3589"><td class="num" id="LN3589">3589</td><td class="line">        <span class='keyword'>if</span> (score == 0 || offending_len == 0) <span class='keyword'>break</span>; <span class='comment'>// Optimal anti affinity reached</span></td></tr>
<tr class="codeline" data-linenumber="3590"><td class="num" id="LN3590">3590</td><td class="line">        <span class='comment'>/* We'll try to randomly swap a slave's assigned master causing</span></td></tr>
<tr class="codeline" data-linenumber="3591"><td class="num" id="LN3591">3591</td><td class="line">         <span class='comment'>* an affinity problem with another random slave, to see if we</span></td></tr>
<tr class="codeline" data-linenumber="3592"><td class="num" id="LN3592">3592</td><td class="line">         <span class='comment'>* can improve the affinity. */</span></td></tr>
<tr class="codeline" data-linenumber="3593"><td class="num" id="LN3593">3593</td><td class="line">        <span class='keyword'>int</span> rand_idx = rand() % offending_len;</td></tr>
<tr class="codeline" data-linenumber="3594"><td class="num" id="LN3594">3594</td><td class="line">        clusterManagerNode *first = offenders[rand_idx],</td></tr>
<tr class="codeline" data-linenumber="3595"><td class="num" id="LN3595">3595</td><td class="line">                           *second = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3596"><td class="num" id="LN3596">3596</td><td class="line">        clusterManagerNode **other_replicas = zcalloc((node_len - 1) *</td></tr>
<tr class="codeline" data-linenumber="3597"><td class="num" id="LN3597">3597</td><td class="line">                                                      <span class='keyword'>sizeof</span>(*other_replicas));</td></tr>
<tr class="codeline" data-linenumber="3598"><td class="num" id="LN3598">3598</td><td class="line">        <span class='keyword'>int</span> other_replicas_count = 0;</td></tr>
<tr class="codeline" data-linenumber="3599"><td class="num" id="LN3599">3599</td><td class="line">        listIter li;</td></tr>
<tr class="codeline" data-linenumber="3600"><td class="num" id="LN3600">3600</td><td class="line">        listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="3601"><td class="num" id="LN3601">3601</td><td class="line">        listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="3602"><td class="num" id="LN3602">3602</td><td class="line">        <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3603"><td class="num" id="LN3603">3603</td><td class="line">            clusterManagerNode *n = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="3604"><td class="num" id="LN3604">3604</td><td class="line">            <span class='keyword'>if</span> (n != first &amp;&amp; n-&gt;replicate != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3605"><td class="num" id="LN3605">3605</td><td class="line">                other_replicas[other_replicas_count++] = n;</td></tr>
<tr class="codeline" data-linenumber="3606"><td class="num" id="LN3606">3606</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3607"><td class="num" id="LN3607">3607</td><td class="line">        <span class='keyword'>if</span> (other_replicas_count == 0) {</td></tr>
<tr class="codeline" data-linenumber="3608"><td class="num" id="LN3608">3608</td><td class="line">            zfree(other_replicas);</td></tr>
<tr class="codeline" data-linenumber="3609"><td class="num" id="LN3609">3609</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3610"><td class="num" id="LN3610">3610</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3611"><td class="num" id="LN3611">3611</td><td class="line">        rand_idx = rand() % other_replicas_count;</td></tr>
<tr class="codeline" data-linenumber="3612"><td class="num" id="LN3612">3612</td><td class="line">        second = other_replicas[rand_idx];</td></tr>
<tr class="codeline" data-linenumber="3613"><td class="num" id="LN3613">3613</td><td class="line">        <span class='keyword'>char</span> *first_master = first-&gt;replicate,</td></tr>
<tr class="codeline" data-linenumber="3614"><td class="num" id="LN3614">3614</td><td class="line">             *second_master = second-&gt;replicate;</td></tr>
<tr class="codeline" data-linenumber="3615"><td class="num" id="LN3615">3615</td><td class="line">        first-&gt;replicate = second_master, first-&gt;dirty = 1;</td></tr>
<tr class="codeline" data-linenumber="3616"><td class="num" id="LN3616">3616</td><td class="line">        second-&gt;replicate = first_master, second-&gt;dirty = 1;</td></tr>
<tr class="codeline" data-linenumber="3617"><td class="num" id="LN3617">3617</td><td class="line">        <span class='keyword'>int</span> new_score = clusterManagerGetAntiAffinityScore(ipnodes,</td></tr>
<tr class="codeline" data-linenumber="3618"><td class="num" id="LN3618">3618</td><td class="line">                                                           ip_count,</td></tr>
<tr class="codeline" data-linenumber="3619"><td class="num" id="LN3619">3619</td><td class="line">                                                           <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3620"><td class="num" id="LN3620">3620</td><td class="line">        <span class='comment'>/* If the change actually makes thing worse, revert. Otherwise</span></td></tr>
<tr class="codeline" data-linenumber="3621"><td class="num" id="LN3621">3621</td><td class="line">         <span class='comment'>* leave as it is because the best solution may need a few</span></td></tr>
<tr class="codeline" data-linenumber="3622"><td class="num" id="LN3622">3622</td><td class="line">         <span class='comment'>* combined swaps. */</span></td></tr>
<tr class="codeline" data-linenumber="3623"><td class="num" id="LN3623">3623</td><td class="line">        <span class='keyword'>if</span> (new_score &gt; score) {</td></tr>
<tr class="codeline" data-linenumber="3624"><td class="num" id="LN3624">3624</td><td class="line">            first-&gt;replicate = first_master;</td></tr>
<tr class="codeline" data-linenumber="3625"><td class="num" id="LN3625">3625</td><td class="line">            second-&gt;replicate = second_master;</td></tr>
<tr class="codeline" data-linenumber="3626"><td class="num" id="LN3626">3626</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3627"><td class="num" id="LN3627">3627</td><td class="line">        zfree(other_replicas);</td></tr>
<tr class="codeline" data-linenumber="3628"><td class="num" id="LN3628">3628</td><td class="line">        maxiter--;</td></tr>
<tr class="codeline" data-linenumber="3629"><td class="num" id="LN3629">3629</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3630"><td class="num" id="LN3630">3630</td><td class="line">    score = clusterManagerGetAntiAffinityScore(ipnodes, ip_count, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3631"><td class="num" id="LN3631">3631</td><td class="line">    <span class='keyword'>char</span> *msg;</td></tr>
<tr class="codeline" data-linenumber="3632"><td class="num" id="LN3632">3632</td><td class="line">    <span class='keyword'>int</span> perfect = (score == 0);</td></tr>
<tr class="codeline" data-linenumber="3633"><td class="num" id="LN3633">3633</td><td class="line">    <span class='keyword'>int</span> log_level = (perfect ? <span class='macro'>CLUSTER_MANAGER_LOG_LVL_SUCCESS<span class='macro_popup'>4</span></span> :</td></tr>
<tr class="codeline" data-linenumber="3634"><td class="num" id="LN3634">3634</td><td class="line">                               <span class='macro'>CLUSTER_MANAGER_LOG_LVL_WARN<span class='macro_popup'>2</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3635"><td class="num" id="LN3635">3635</td><td class="line">    <span class='keyword'>if</span> (perfect) msg = <span class='string_literal'>"[OK] Perfect anti-affinity obtained!"</span>;</td></tr>
<tr class="codeline" data-linenumber="3636"><td class="num" id="LN3636">3636</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (score &gt;= 10000)</td></tr>
<tr class="codeline" data-linenumber="3637"><td class="num" id="LN3637">3637</td><td class="line">        msg = (<span class='string_literal'>"[WARNING] Some slaves are in the same host as their master"</span>);</td></tr>
<tr class="codeline" data-linenumber="3638"><td class="num" id="LN3638">3638</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="3639"><td class="num" id="LN3639">3639</td><td class="line">        msg=(<span class='string_literal'>"[WARNING] Some slaves of the same master are in the same host"</span>);</td></tr>
<tr class="codeline" data-linenumber="3640"><td class="num" id="LN3640">3640</td><td class="line">    clusterManagerLog(log_level, <span class='string_literal'>"%s\n"</span>, msg);</td></tr>
<tr class="codeline" data-linenumber="3641"><td class="num" id="LN3641">3641</td><td class="line">cleanup:</td></tr>
<tr class="codeline" data-linenumber="3642"><td class="num" id="LN3642">3642</td><td class="line">    zfree(offenders);</td></tr>
<tr class="codeline" data-linenumber="3643"><td class="num" id="LN3643">3643</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3644"><td class="num" id="LN3644">3644</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3645"><td class="num" id="LN3645">3645</td><td class="line"><span class='comment'>/* Return a representable string of the node's flags */</span></td></tr>
<tr class="codeline" data-linenumber="3646"><td class="num" id="LN3646">3646</td><td class="line"><span class='keyword'>static</span> <span class='macro'>sds<span class='macro_popup'>hisds</span></span> clusterManagerNodeFlagString(clusterManagerNode *node) {</td></tr>
<tr class="codeline" data-linenumber="3647"><td class="num" id="LN3647">3647</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> flags = <span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>();</td></tr>
<tr class="codeline" data-linenumber="3648"><td class="num" id="LN3648">3648</td><td class="line">    <span class='keyword'>if</span> (!node-&gt;flags_str) <span class='keyword'>return</span> flags;</td></tr>
<tr class="codeline" data-linenumber="3649"><td class="num" id="LN3649">3649</td><td class="line">    <span class='keyword'>int</span> empty = 1;</td></tr>
<tr class="codeline" data-linenumber="3650"><td class="num" id="LN3650">3650</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="3651"><td class="num" id="LN3651">3651</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="3652"><td class="num" id="LN3652">3652</td><td class="line">    listRewind(node-&gt;flags_str, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="3653"><td class="num" id="LN3653">3653</td><td class="line">    <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3654"><td class="num" id="LN3654">3654</td><td class="line">        <span class='macro'>sds<span class='macro_popup'>hisds</span></span> flag = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="3655"><td class="num" id="LN3655">3655</td><td class="line">        <span class='keyword'>if</span> (strcmp(flag, <span class='string_literal'>"myself"</span>) == 0) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="3656"><td class="num" id="LN3656">3656</td><td class="line">        <span class='keyword'>if</span> (!empty) flags = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(flags, <span class='string_literal'>","</span>);</td></tr>
<tr class="codeline" data-linenumber="3657"><td class="num" id="LN3657">3657</td><td class="line">        flags = <span class='macro'>sdscatfmt<span class='macro_popup'>hi_sdscatfmt</span></span>(flags, <span class='string_literal'>"%S"</span>, flag);</td></tr>
<tr class="codeline" data-linenumber="3658"><td class="num" id="LN3658">3658</td><td class="line">        empty = 0;</td></tr>
<tr class="codeline" data-linenumber="3659"><td class="num" id="LN3659">3659</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3660"><td class="num" id="LN3660">3660</td><td class="line">    <span class='keyword'>return</span> flags;</td></tr>
<tr class="codeline" data-linenumber="3661"><td class="num" id="LN3661">3661</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3662"><td class="num" id="LN3662">3662</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3663"><td class="num" id="LN3663">3663</td><td class="line"><span class='comment'>/* Return a representable string of the node's slots */</span></td></tr>
<tr class="codeline" data-linenumber="3664"><td class="num" id="LN3664">3664</td><td class="line"><span class='keyword'>static</span> <span class='macro'>sds<span class='macro_popup'>hisds</span></span> clusterManagerNodeSlotsString(clusterManagerNode *node) {</td></tr>
<tr class="codeline" data-linenumber="3665"><td class="num" id="LN3665">3665</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> slots = <span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>();</td></tr>
<tr class="codeline" data-linenumber="3666"><td class="num" id="LN3666">3666</td><td class="line">    <span class='keyword'>int</span> first_range_idx = -1, last_slot_idx = -1, i;</td></tr>
<tr class="codeline" data-linenumber="3667"><td class="num" id="LN3667">3667</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; <span class='macro'>CLUSTER_MANAGER_SLOTS<span class='macro_popup'>16384</span></span>; i++) {</td></tr>
<tr class="codeline" data-linenumber="3668"><td class="num" id="LN3668">3668</td><td class="line">        <span class='keyword'>int</span> has_slot = node-&gt;slots[i];</td></tr>
<tr class="codeline" data-linenumber="3669"><td class="num" id="LN3669">3669</td><td class="line">        <span class='keyword'>if</span> (has_slot) {</td></tr>
<tr class="codeline" data-linenumber="3670"><td class="num" id="LN3670">3670</td><td class="line">            <span class='keyword'>if</span> (first_range_idx == -1) {</td></tr>
<tr class="codeline" data-linenumber="3671"><td class="num" id="LN3671">3671</td><td class="line">                <span class='keyword'>if</span> (<span class='macro'>sdslen<span class='macro_popup'>hi_sdslen</span></span>(slots)) slots = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(slots, <span class='string_literal'>","</span>);</td></tr>
<tr class="codeline" data-linenumber="3672"><td class="num" id="LN3672">3672</td><td class="line">                first_range_idx = i;</td></tr>
<tr class="codeline" data-linenumber="3673"><td class="num" id="LN3673">3673</td><td class="line">                slots = <span class='macro'>sdscatfmt<span class='macro_popup'>hi_sdscatfmt</span></span>(slots, <span class='string_literal'>"[%u"</span>, i);</td></tr>
<tr class="codeline" data-linenumber="3674"><td class="num" id="LN3674">3674</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="3675"><td class="num" id="LN3675">3675</td><td class="line">            last_slot_idx = i;</td></tr>
<tr class="codeline" data-linenumber="3676"><td class="num" id="LN3676">3676</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="3677"><td class="num" id="LN3677">3677</td><td class="line">            <span class='keyword'>if</span> (last_slot_idx &gt;= 0) {</td></tr>
<tr class="codeline" data-linenumber="3678"><td class="num" id="LN3678">3678</td><td class="line">                <span class='keyword'>if</span> (first_range_idx == last_slot_idx)</td></tr>
<tr class="codeline" data-linenumber="3679"><td class="num" id="LN3679">3679</td><td class="line">                    slots = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(slots, <span class='string_literal'>"]"</span>);</td></tr>
<tr class="codeline" data-linenumber="3680"><td class="num" id="LN3680">3680</td><td class="line">                <span class='keyword'>else</span> slots = <span class='macro'>sdscatfmt<span class='macro_popup'>hi_sdscatfmt</span></span>(slots, <span class='string_literal'>"-%u]"</span>, last_slot_idx);</td></tr>
<tr class="codeline" data-linenumber="3681"><td class="num" id="LN3681">3681</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="3682"><td class="num" id="LN3682">3682</td><td class="line">            last_slot_idx = -1;</td></tr>
<tr class="codeline" data-linenumber="3683"><td class="num" id="LN3683">3683</td><td class="line">            first_range_idx = -1;</td></tr>
<tr class="codeline" data-linenumber="3684"><td class="num" id="LN3684">3684</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3685"><td class="num" id="LN3685">3685</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3686"><td class="num" id="LN3686">3686</td><td class="line">    <span class='keyword'>if</span> (last_slot_idx &gt;= 0) {</td></tr>
<tr class="codeline" data-linenumber="3687"><td class="num" id="LN3687">3687</td><td class="line">        <span class='keyword'>if</span> (first_range_idx == last_slot_idx) slots = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(slots, <span class='string_literal'>"]"</span>);</td></tr>
<tr class="codeline" data-linenumber="3688"><td class="num" id="LN3688">3688</td><td class="line">        <span class='keyword'>else</span> slots = <span class='macro'>sdscatfmt<span class='macro_popup'>hi_sdscatfmt</span></span>(slots, <span class='string_literal'>"-%u]"</span>, last_slot_idx);</td></tr>
<tr class="codeline" data-linenumber="3689"><td class="num" id="LN3689">3689</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3690"><td class="num" id="LN3690">3690</td><td class="line">    <span class='keyword'>return</span> slots;</td></tr>
<tr class="codeline" data-linenumber="3691"><td class="num" id="LN3691">3691</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3692"><td class="num" id="LN3692">3692</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3693"><td class="num" id="LN3693">3693</td><td class="line"><span class='keyword'>static</span> <span class='macro'>sds<span class='macro_popup'>hisds</span></span> clusterManagerNodeGetJSON(clusterManagerNode *node,</td></tr>
<tr class="codeline" data-linenumber="3694"><td class="num" id="LN3694">3694</td><td class="line">                                     <span class='keyword'>unsigned</span> <span class='keyword'>long</span> error_count)</td></tr>
<tr class="codeline" data-linenumber="3695"><td class="num" id="LN3695">3695</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3696"><td class="num" id="LN3696">3696</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> json = <span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>();</td></tr>
<tr class="codeline" data-linenumber="3697"><td class="num" id="LN3697">3697</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> replicate = <span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>();</td></tr>
<tr class="codeline" data-linenumber="3698"><td class="num" id="LN3698">3698</td><td class="line">    <span class='keyword'>if</span> (node-&gt;replicate)</td></tr>
<tr class="codeline" data-linenumber="3699"><td class="num" id="LN3699">3699</td><td class="line">        replicate = <span class='macro'>sdscatprintf<span class='macro_popup'>hi_sdscatprintf</span></span>(replicate, <span class='string_literal'>"\"%s\""</span>, node-&gt;replicate);</td></tr>
<tr class="codeline" data-linenumber="3700"><td class="num" id="LN3700">3700</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="3701"><td class="num" id="LN3701">3701</td><td class="line">        replicate = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(replicate, <span class='string_literal'>"null"</span>);</td></tr>
<tr class="codeline" data-linenumber="3702"><td class="num" id="LN3702">3702</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> slots = clusterManagerNodeSlotsString(node);</td></tr>
<tr class="codeline" data-linenumber="3703"><td class="num" id="LN3703">3703</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> flags = clusterManagerNodeFlagString(node);</td></tr>
<tr class="codeline" data-linenumber="3704"><td class="num" id="LN3704">3704</td><td class="line">    <span class='keyword'>char</span> *p = slots;</td></tr>
<tr class="codeline" data-linenumber="3705"><td class="num" id="LN3705">3705</td><td class="line">    <span class='keyword'>while</span> ((p = strchr(p, '-')) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3706"><td class="num" id="LN3706">3706</td><td class="line">        *(p++) = ',';</td></tr>
<tr class="codeline" data-linenumber="3707"><td class="num" id="LN3707">3707</td><td class="line">    json = <span class='macro'>sdscatprintf<span class='macro_popup'>hi_sdscatprintf</span></span>(json,</td></tr>
<tr class="codeline" data-linenumber="3708"><td class="num" id="LN3708">3708</td><td class="line">        <span class='string_literal'>"  {\n"</span></td></tr>
<tr class="codeline" data-linenumber="3709"><td class="num" id="LN3709">3709</td><td class="line">        <span class='string_literal'>"    \"name\": \"%s\",\n"</span></td></tr>
<tr class="codeline" data-linenumber="3710"><td class="num" id="LN3710">3710</td><td class="line">        <span class='string_literal'>"    \"host\": \"%s\",\n"</span></td></tr>
<tr class="codeline" data-linenumber="3711"><td class="num" id="LN3711">3711</td><td class="line">        <span class='string_literal'>"    \"port\": %d,\n"</span></td></tr>
<tr class="codeline" data-linenumber="3712"><td class="num" id="LN3712">3712</td><td class="line">        <span class='string_literal'>"    \"replicate\": %s,\n"</span></td></tr>
<tr class="codeline" data-linenumber="3713"><td class="num" id="LN3713">3713</td><td class="line">        <span class='string_literal'>"    \"slots\": [%s],\n"</span></td></tr>
<tr class="codeline" data-linenumber="3714"><td class="num" id="LN3714">3714</td><td class="line">        <span class='string_literal'>"    \"slots_count\": %d,\n"</span></td></tr>
<tr class="codeline" data-linenumber="3715"><td class="num" id="LN3715">3715</td><td class="line">        <span class='string_literal'>"    \"flags\": \"%s\",\n"</span></td></tr>
<tr class="codeline" data-linenumber="3716"><td class="num" id="LN3716">3716</td><td class="line">        <span class='string_literal'>"    \"current_epoch\": %llu"</span>,</td></tr>
<tr class="codeline" data-linenumber="3717"><td class="num" id="LN3717">3717</td><td class="line">        node-&gt;name,</td></tr>
<tr class="codeline" data-linenumber="3718"><td class="num" id="LN3718">3718</td><td class="line">        node-&gt;ip,</td></tr>
<tr class="codeline" data-linenumber="3719"><td class="num" id="LN3719">3719</td><td class="line">        node-&gt;port,</td></tr>
<tr class="codeline" data-linenumber="3720"><td class="num" id="LN3720">3720</td><td class="line">        replicate,</td></tr>
<tr class="codeline" data-linenumber="3721"><td class="num" id="LN3721">3721</td><td class="line">        slots,</td></tr>
<tr class="codeline" data-linenumber="3722"><td class="num" id="LN3722">3722</td><td class="line">        node-&gt;slots_count,</td></tr>
<tr class="codeline" data-linenumber="3723"><td class="num" id="LN3723">3723</td><td class="line">        flags,</td></tr>
<tr class="codeline" data-linenumber="3724"><td class="num" id="LN3724">3724</td><td class="line">        (<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span>)node-&gt;current_epoch</td></tr>
<tr class="codeline" data-linenumber="3725"><td class="num" id="LN3725">3725</td><td class="line">    );</td></tr>
<tr class="codeline" data-linenumber="3726"><td class="num" id="LN3726">3726</td><td class="line">    <span class='keyword'>if</span> (error_count &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="3727"><td class="num" id="LN3727">3727</td><td class="line">        json = <span class='macro'>sdscatprintf<span class='macro_popup'>hi_sdscatprintf</span></span>(json, <span class='string_literal'>",\n    \"cluster_errors\": %lu"</span>,</td></tr>
<tr class="codeline" data-linenumber="3728"><td class="num" id="LN3728">3728</td><td class="line">                            error_count);</td></tr>
<tr class="codeline" data-linenumber="3729"><td class="num" id="LN3729">3729</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3730"><td class="num" id="LN3730">3730</td><td class="line">    <span class='keyword'>if</span> (node-&gt;migrating_count &gt; 0 &amp;&amp; node-&gt;migrating != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3731"><td class="num" id="LN3731">3731</td><td class="line">        <span class='keyword'>int</span> i = 0;</td></tr>
<tr class="codeline" data-linenumber="3732"><td class="num" id="LN3732">3732</td><td class="line">        <span class='macro'>sds<span class='macro_popup'>hisds</span></span> migrating = <span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>();</td></tr>
<tr class="codeline" data-linenumber="3733"><td class="num" id="LN3733">3733</td><td class="line">        <span class='keyword'>for</span> (; i &lt; node-&gt;migrating_count; i += 2) {</td></tr>
<tr class="codeline" data-linenumber="3734"><td class="num" id="LN3734">3734</td><td class="line">            <span class='macro'>sds<span class='macro_popup'>hisds</span></span> slot = node-&gt;migrating[i];</td></tr>
<tr class="codeline" data-linenumber="3735"><td class="num" id="LN3735">3735</td><td class="line">            <span class='macro'>sds<span class='macro_popup'>hisds</span></span> dest = node-&gt;migrating[i + 1];</td></tr>
<tr class="codeline" data-linenumber="3736"><td class="num" id="LN3736">3736</td><td class="line">            <span class='keyword'>if</span> (slot &amp;&amp; dest) {</td></tr>
<tr class="codeline" data-linenumber="3737"><td class="num" id="LN3737">3737</td><td class="line">                <span class='keyword'>if</span> (<span class='macro'>sdslen<span class='macro_popup'>hi_sdslen</span></span>(migrating) &gt; 0) migrating = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(migrating, <span class='string_literal'>","</span>);</td></tr>
<tr class="codeline" data-linenumber="3738"><td class="num" id="LN3738">3738</td><td class="line">                migrating = <span class='macro'>sdscatfmt<span class='macro_popup'>hi_sdscatfmt</span></span>(migrating, <span class='string_literal'>"\"%S\": \"%S\""</span>, slot, dest);</td></tr>
<tr class="codeline" data-linenumber="3739"><td class="num" id="LN3739">3739</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="3740"><td class="num" id="LN3740">3740</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3741"><td class="num" id="LN3741">3741</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>sdslen<span class='macro_popup'>hi_sdslen</span></span>(migrating) &gt; 0)</td></tr>
<tr class="codeline" data-linenumber="3742"><td class="num" id="LN3742">3742</td><td class="line">            json = <span class='macro'>sdscatfmt<span class='macro_popup'>hi_sdscatfmt</span></span>(json, <span class='string_literal'>",\n    \"migrating\": {%S}"</span>, migrating);</td></tr>
<tr class="codeline" data-linenumber="3743"><td class="num" id="LN3743">3743</td><td class="line">        <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(migrating);</td></tr>
<tr class="codeline" data-linenumber="3744"><td class="num" id="LN3744">3744</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3745"><td class="num" id="LN3745">3745</td><td class="line">    <span class='keyword'>if</span> (node-&gt;importing_count &gt; 0 &amp;&amp; node-&gt;importing != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3746"><td class="num" id="LN3746">3746</td><td class="line">        <span class='keyword'>int</span> i = 0;</td></tr>
<tr class="codeline" data-linenumber="3747"><td class="num" id="LN3747">3747</td><td class="line">        <span class='macro'>sds<span class='macro_popup'>hisds</span></span> importing = <span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>();</td></tr>
<tr class="codeline" data-linenumber="3748"><td class="num" id="LN3748">3748</td><td class="line">        <span class='keyword'>for</span> (; i &lt; node-&gt;importing_count; i += 2) {</td></tr>
<tr class="codeline" data-linenumber="3749"><td class="num" id="LN3749">3749</td><td class="line">            <span class='macro'>sds<span class='macro_popup'>hisds</span></span> slot = node-&gt;importing[i];</td></tr>
<tr class="codeline" data-linenumber="3750"><td class="num" id="LN3750">3750</td><td class="line">            <span class='macro'>sds<span class='macro_popup'>hisds</span></span> from = node-&gt;importing[i + 1];</td></tr>
<tr class="codeline" data-linenumber="3751"><td class="num" id="LN3751">3751</td><td class="line">            <span class='keyword'>if</span> (slot &amp;&amp; from) {</td></tr>
<tr class="codeline" data-linenumber="3752"><td class="num" id="LN3752">3752</td><td class="line">                <span class='keyword'>if</span> (<span class='macro'>sdslen<span class='macro_popup'>hi_sdslen</span></span>(importing) &gt; 0) importing = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(importing, <span class='string_literal'>","</span>);</td></tr>
<tr class="codeline" data-linenumber="3753"><td class="num" id="LN3753">3753</td><td class="line">                importing = <span class='macro'>sdscatfmt<span class='macro_popup'>hi_sdscatfmt</span></span>(importing, <span class='string_literal'>"\"%S\": \"%S\""</span>, slot, from);</td></tr>
<tr class="codeline" data-linenumber="3754"><td class="num" id="LN3754">3754</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="3755"><td class="num" id="LN3755">3755</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3756"><td class="num" id="LN3756">3756</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>sdslen<span class='macro_popup'>hi_sdslen</span></span>(importing) &gt; 0)</td></tr>
<tr class="codeline" data-linenumber="3757"><td class="num" id="LN3757">3757</td><td class="line">            json = <span class='macro'>sdscatfmt<span class='macro_popup'>hi_sdscatfmt</span></span>(json, <span class='string_literal'>",\n    \"importing\": {%S}"</span>, importing);</td></tr>
<tr class="codeline" data-linenumber="3758"><td class="num" id="LN3758">3758</td><td class="line">        <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(importing);</td></tr>
<tr class="codeline" data-linenumber="3759"><td class="num" id="LN3759">3759</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3760"><td class="num" id="LN3760">3760</td><td class="line">    json = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(json, <span class='string_literal'>"\n  }"</span>);</td></tr>
<tr class="codeline" data-linenumber="3761"><td class="num" id="LN3761">3761</td><td class="line">    <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(replicate);</td></tr>
<tr class="codeline" data-linenumber="3762"><td class="num" id="LN3762">3762</td><td class="line">    <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(slots);</td></tr>
<tr class="codeline" data-linenumber="3763"><td class="num" id="LN3763">3763</td><td class="line">    <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(flags);</td></tr>
<tr class="codeline" data-linenumber="3764"><td class="num" id="LN3764">3764</td><td class="line">    <span class='keyword'>return</span> json;</td></tr>
<tr class="codeline" data-linenumber="3765"><td class="num" id="LN3765">3765</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3766"><td class="num" id="LN3766">3766</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3767"><td class="num" id="LN3767">3767</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3768"><td class="num" id="LN3768">3768</td><td class="line"><span class='comment'>/* -----------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="3769"><td class="num" id="LN3769">3769</td><td class="line"> <span class='comment'>* Key space handling</span></td></tr>
<tr class="codeline" data-linenumber="3770"><td class="num" id="LN3770">3770</td><td class="line"> <span class='comment'>* -------------------------------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="3771"><td class="num" id="LN3771">3771</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3772"><td class="num" id="LN3772">3772</td><td class="line"><span class='comment'>/* We have 16384 hash slots. The hash slot of a given key is obtained</span></td></tr>
<tr class="codeline" data-linenumber="3773"><td class="num" id="LN3773">3773</td><td class="line"> <span class='comment'>* as the least significant 14 bits of the crc16 of the key.</span></td></tr>
<tr class="codeline" data-linenumber="3774"><td class="num" id="LN3774">3774</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3775"><td class="num" id="LN3775">3775</td><td class="line"> <span class='comment'>* However if the key contains the {...} pattern, only the part between</span></td></tr>
<tr class="codeline" data-linenumber="3776"><td class="num" id="LN3776">3776</td><td class="line"> <span class='comment'>* { and } is hashed. This may be useful in the future to force certain</span></td></tr>
<tr class="codeline" data-linenumber="3777"><td class="num" id="LN3777">3777</td><td class="line"> <span class='comment'>* keys to be in the same node (assuming no resharding is in progress). */</span></td></tr>
<tr class="codeline" data-linenumber="3778"><td class="num" id="LN3778">3778</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>unsigned</span> <span class='keyword'>int</span> clusterManagerKeyHashSlot(<span class='keyword'>char</span> *key, <span class='keyword'>int</span> keylen) {</td></tr>
<tr class="codeline" data-linenumber="3779"><td class="num" id="LN3779">3779</td><td class="line">    <span class='keyword'>int</span> s, e; <span class='comment'>/* start-end indexes of { and } */</span></td></tr>
<tr class="codeline" data-linenumber="3780"><td class="num" id="LN3780">3780</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3781"><td class="num" id="LN3781">3781</td><td class="line">    <span class='keyword'>for</span> (s = 0; s &lt; keylen; s++)</td></tr>
<tr class="codeline" data-linenumber="3782"><td class="num" id="LN3782">3782</td><td class="line">        <span class='keyword'>if</span> (key[s] == '{') <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3783"><td class="num" id="LN3783">3783</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3784"><td class="num" id="LN3784">3784</td><td class="line">    <span class='comment'>/* No '{' ? Hash the whole key. This is the base case. */</span></td></tr>
<tr class="codeline" data-linenumber="3785"><td class="num" id="LN3785">3785</td><td class="line">    <span class='keyword'>if</span> (s == keylen) <span class='keyword'>return</span> crc16(key,keylen) &amp; 0x3FFF;</td></tr>
<tr class="codeline" data-linenumber="3786"><td class="num" id="LN3786">3786</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3787"><td class="num" id="LN3787">3787</td><td class="line">    <span class='comment'>/* '{' found? Check if we have the corresponding '}'. */</span></td></tr>
<tr class="codeline" data-linenumber="3788"><td class="num" id="LN3788">3788</td><td class="line">    <span class='keyword'>for</span> (e = s+1; e &lt; keylen; e++)</td></tr>
<tr class="codeline" data-linenumber="3789"><td class="num" id="LN3789">3789</td><td class="line">        <span class='keyword'>if</span> (key[e] == '}') <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3790"><td class="num" id="LN3790">3790</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3791"><td class="num" id="LN3791">3791</td><td class="line">    <span class='comment'>/* No '}' or nothing between {} ? Hash the whole key. */</span></td></tr>
<tr class="codeline" data-linenumber="3792"><td class="num" id="LN3792">3792</td><td class="line">    <span class='keyword'>if</span> (e == keylen || e == s+1) <span class='keyword'>return</span> crc16(key,keylen) &amp; 0x3FFF;</td></tr>
<tr class="codeline" data-linenumber="3793"><td class="num" id="LN3793">3793</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3794"><td class="num" id="LN3794">3794</td><td class="line">    <span class='comment'>/* If we are here there is both a { and a } on its right. Hash</span></td></tr>
<tr class="codeline" data-linenumber="3795"><td class="num" id="LN3795">3795</td><td class="line">     <span class='comment'>* what is in the middle between { and }. */</span></td></tr>
<tr class="codeline" data-linenumber="3796"><td class="num" id="LN3796">3796</td><td class="line">    <span class='keyword'>return</span> crc16(key+s+1,e-s-1) &amp; 0x3FFF;</td></tr>
<tr class="codeline" data-linenumber="3797"><td class="num" id="LN3797">3797</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3798"><td class="num" id="LN3798">3798</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3799"><td class="num" id="LN3799">3799</td><td class="line"><span class='comment'>/* Return a string representation of the cluster node. */</span></td></tr>
<tr class="codeline" data-linenumber="3800"><td class="num" id="LN3800">3800</td><td class="line"><span class='keyword'>static</span> <span class='macro'>sds<span class='macro_popup'>hisds</span></span> clusterManagerNodeInfo(clusterManagerNode *node, <span class='keyword'>int</span> indent) {</td></tr>
<tr class="codeline" data-linenumber="3801"><td class="num" id="LN3801">3801</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> info = <span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>();</td></tr>
<tr class="codeline" data-linenumber="3802"><td class="num" id="LN3802">3802</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> spaces = <span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>();</td></tr>
<tr class="codeline" data-linenumber="3803"><td class="num" id="LN3803">3803</td><td class="line">    <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="3804"><td class="num" id="LN3804">3804</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; indent; i++) spaces = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(spaces, <span class='string_literal'>" "</span>);</td></tr>
<tr class="codeline" data-linenumber="3805"><td class="num" id="LN3805">3805</td><td class="line">    <span class='keyword'>if</span> (indent) info = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(info, spaces);</td></tr>
<tr class="codeline" data-linenumber="3806"><td class="num" id="LN3806">3806</td><td class="line">    <span class='keyword'>int</span> is_master = !(node-&gt;flags &amp; <span class='macro'>CLUSTER_MANAGER_FLAG_SLAVE<span class='macro_popup'>1 &lt;&lt; 1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3807"><td class="num" id="LN3807">3807</td><td class="line">    <span class='keyword'>char</span> *role = (is_master ? <span class='string_literal'>"M"</span> : <span class='string_literal'>"S"</span>);</td></tr>
<tr class="codeline" data-linenumber="3808"><td class="num" id="LN3808">3808</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> slots = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3809"><td class="num" id="LN3809">3809</td><td class="line">    <span class='keyword'>if</span> (node-&gt;dirty &amp;&amp; node-&gt;replicate != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3810"><td class="num" id="LN3810">3810</td><td class="line">        info = <span class='macro'>sdscatfmt<span class='macro_popup'>hi_sdscatfmt</span></span>(info, <span class='string_literal'>"S: %S %s:%u"</span>, node-&gt;name, node-&gt;ip, node-&gt;port);</td></tr>
<tr class="codeline" data-linenumber="3811"><td class="num" id="LN3811">3811</td><td class="line">    <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="3812"><td class="num" id="LN3812">3812</td><td class="line">        slots = clusterManagerNodeSlotsString(node);</td></tr>
<tr class="codeline" data-linenumber="3813"><td class="num" id="LN3813">3813</td><td class="line">        <span class='macro'>sds<span class='macro_popup'>hisds</span></span> flags = clusterManagerNodeFlagString(node);</td></tr>
<tr class="codeline" data-linenumber="3814"><td class="num" id="LN3814">3814</td><td class="line">        info = <span class='macro'>sdscatfmt<span class='macro_popup'>hi_sdscatfmt</span></span>(info, <span class='string_literal'>"%s: %S %s:%u\n"</span></td></tr>
<tr class="codeline" data-linenumber="3815"><td class="num" id="LN3815">3815</td><td class="line">                               <span class='string_literal'>"%s   slots:%S (%u slots) "</span></td></tr>
<tr class="codeline" data-linenumber="3816"><td class="num" id="LN3816">3816</td><td class="line">                               <span class='string_literal'>"%S"</span>,</td></tr>
<tr class="codeline" data-linenumber="3817"><td class="num" id="LN3817">3817</td><td class="line">                               role, node-&gt;name, node-&gt;ip, node-&gt;port, spaces,</td></tr>
<tr class="codeline" data-linenumber="3818"><td class="num" id="LN3818">3818</td><td class="line">                               slots, node-&gt;slots_count, flags);</td></tr>
<tr class="codeline" data-linenumber="3819"><td class="num" id="LN3819">3819</td><td class="line">        <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(slots);</td></tr>
<tr class="codeline" data-linenumber="3820"><td class="num" id="LN3820">3820</td><td class="line">        <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(flags);</td></tr>
<tr class="codeline" data-linenumber="3821"><td class="num" id="LN3821">3821</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3822"><td class="num" id="LN3822">3822</td><td class="line">    <span class='keyword'>if</span> (node-&gt;replicate != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3823"><td class="num" id="LN3823">3823</td><td class="line">        info = <span class='macro'>sdscatfmt<span class='macro_popup'>hi_sdscatfmt</span></span>(info, <span class='string_literal'>"\n%s   replicates %S"</span>, spaces, node-&gt;replicate);</td></tr>
<tr class="codeline" data-linenumber="3824"><td class="num" id="LN3824">3824</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (node-&gt;replicas_count)</td></tr>
<tr class="codeline" data-linenumber="3825"><td class="num" id="LN3825">3825</td><td class="line">        info = <span class='macro'>sdscatfmt<span class='macro_popup'>hi_sdscatfmt</span></span>(info, <span class='string_literal'>"\n%s   %U additional replica(s)"</span>,</td></tr>
<tr class="codeline" data-linenumber="3826"><td class="num" id="LN3826">3826</td><td class="line">                         spaces, node-&gt;replicas_count);</td></tr>
<tr class="codeline" data-linenumber="3827"><td class="num" id="LN3827">3827</td><td class="line">    <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(spaces);</td></tr>
<tr class="codeline" data-linenumber="3828"><td class="num" id="LN3828">3828</td><td class="line">    <span class='keyword'>return</span> info;</td></tr>
<tr class="codeline" data-linenumber="3829"><td class="num" id="LN3829">3829</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3830"><td class="num" id="LN3830">3830</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3831"><td class="num" id="LN3831">3831</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> clusterManagerShowNodes(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="3832"><td class="num" id="LN3832">3832</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="3833"><td class="num" id="LN3833">3833</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="3834"><td class="num" id="LN3834">3834</td><td class="line">    listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="3835"><td class="num" id="LN3835">3835</td><td class="line">    <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3836"><td class="num" id="LN3836">3836</td><td class="line">        clusterManagerNode *node = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="3837"><td class="num" id="LN3837">3837</td><td class="line">        <span class='macro'>sds<span class='macro_popup'>hisds</span></span> info = clusterManagerNodeInfo(node, 0);</td></tr>
<tr class="codeline" data-linenumber="3838"><td class="num" id="LN3838">3838</td><td class="line">        printf(<span class='string_literal'>"%s\n"</span>, (<span class='keyword'>char</span> *) info);</td></tr>
<tr class="codeline" data-linenumber="3839"><td class="num" id="LN3839">3839</td><td class="line">        <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(info);</td></tr>
<tr class="codeline" data-linenumber="3840"><td class="num" id="LN3840">3840</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3841"><td class="num" id="LN3841">3841</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3842"><td class="num" id="LN3842">3842</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3843"><td class="num" id="LN3843">3843</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> clusterManagerShowClusterInfo(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="3844"><td class="num" id="LN3844">3844</td><td class="line">    <span class='keyword'>int</span> masters = 0;</td></tr>
<tr class="codeline" data-linenumber="3845"><td class="num" id="LN3845">3845</td><td class="line">    <span class='keyword'>int</span> keys = 0;</td></tr>
<tr class="codeline" data-linenumber="3846"><td class="num" id="LN3846">3846</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="3847"><td class="num" id="LN3847">3847</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="3848"><td class="num" id="LN3848">3848</td><td class="line">    listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="3849"><td class="num" id="LN3849">3849</td><td class="line">    <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3850"><td class="num" id="LN3850">3850</td><td class="line">        clusterManagerNode *node = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="3851"><td class="num" id="LN3851">3851</td><td class="line">        <span class='keyword'>if</span> (!(node-&gt;flags &amp; <span class='macro'>CLUSTER_MANAGER_FLAG_SLAVE<span class='macro_popup'>1 &lt;&lt; 1</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="3852"><td class="num" id="LN3852">3852</td><td class="line">            <span class='keyword'>if</span> (!node-&gt;name) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="3853"><td class="num" id="LN3853">3853</td><td class="line">            <span class='keyword'>int</span> replicas = 0;</td></tr>
<tr class="codeline" data-linenumber="3854"><td class="num" id="LN3854">3854</td><td class="line">            <span class='keyword'>int</span> dbsize = -1;</td></tr>
<tr class="codeline" data-linenumber="3855"><td class="num" id="LN3855">3855</td><td class="line">            <span class='keyword'>char</span> name[9];</td></tr>
<tr class="codeline" data-linenumber="3856"><td class="num" id="LN3856">3856</td><td class="line">            memcpy(name, node-&gt;name, 8);</td></tr>
<tr class="codeline" data-linenumber="3857"><td class="num" id="LN3857">3857</td><td class="line">            name[8] = '\0';</td></tr>
<tr class="codeline" data-linenumber="3858"><td class="num" id="LN3858">3858</td><td class="line">            listIter ri;</td></tr>
<tr class="codeline" data-linenumber="3859"><td class="num" id="LN3859">3859</td><td class="line">            listNode *rn;</td></tr>
<tr class="codeline" data-linenumber="3860"><td class="num" id="LN3860">3860</td><td class="line">            listRewind(cluster_manager.nodes, &amp;ri);</td></tr>
<tr class="codeline" data-linenumber="3861"><td class="num" id="LN3861">3861</td><td class="line">            <span class='keyword'>while</span> ((rn = listNext(&amp;ri)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3862"><td class="num" id="LN3862">3862</td><td class="line">                clusterManagerNode *n = rn-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="3863"><td class="num" id="LN3863">3863</td><td class="line">                <span class='keyword'>if</span> (n == node || !(n-&gt;flags &amp; <span class='macro'>CLUSTER_MANAGER_FLAG_SLAVE<span class='macro_popup'>1 &lt;&lt; 1</span></span>))</td></tr>
<tr class="codeline" data-linenumber="3864"><td class="num" id="LN3864">3864</td><td class="line">                    <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="3865"><td class="num" id="LN3865">3865</td><td class="line">                <span class='keyword'>if</span> (n-&gt;replicate &amp;&amp; !strcmp(n-&gt;replicate, node-&gt;name))</td></tr>
<tr class="codeline" data-linenumber="3866"><td class="num" id="LN3866">3866</td><td class="line">                    replicas++;</td></tr>
<tr class="codeline" data-linenumber="3867"><td class="num" id="LN3867">3867</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="3868"><td class="num" id="LN3868">3868</td><td class="line">            redisReply *reply = <span class='macro'>CLUSTER_MANAGER_COMMAND(node, <span class='string_literal'>"DBSIZE"</span>)<span class='macro_popup'>(redisCommand(node-&gt;context, "DBSIZE"))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3869"><td class="num" id="LN3869">3869</td><td class="line">            <span class='keyword'>if</span> (reply != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> &amp;&amp; reply-&gt;type == <span class='macro'>REDIS_REPLY_INTEGER<span class='macro_popup'>3</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3870"><td class="num" id="LN3870">3870</td><td class="line">                dbsize = reply-&gt;integer;</td></tr>
<tr class="codeline" data-linenumber="3871"><td class="num" id="LN3871">3871</td><td class="line">            <span class='keyword'>if</span> (dbsize &lt; 0) {</td></tr>
<tr class="codeline" data-linenumber="3872"><td class="num" id="LN3872">3872</td><td class="line">                <span class='keyword'>char</span> *err = <span class='string_literal'>""</span>;</td></tr>
<tr class="codeline" data-linenumber="3873"><td class="num" id="LN3873">3873</td><td class="line">                <span class='keyword'>if</span> (reply != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> &amp;&amp; reply-&gt;type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3874"><td class="num" id="LN3874">3874</td><td class="line">                    err = reply-&gt;str;</td></tr>
<tr class="codeline" data-linenumber="3875"><td class="num" id="LN3875">3875</td><td class="line">                <span class='macro'>CLUSTER_MANAGER_PRINT_REPLY_ERROR(node, err)<span class='macro_popup'>clusterManagerLog(3,"Node %s:%d replied with error:\n%s\n", node<br>-&gt;ip, node-&gt;port, err);</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3876"><td class="num" id="LN3876">3876</td><td class="line">                <span class='keyword'>if</span> (reply != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="3877"><td class="num" id="LN3877">3877</td><td class="line">                <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="3878"><td class="num" id="LN3878">3878</td><td class="line">            };</td></tr>
<tr class="codeline" data-linenumber="3879"><td class="num" id="LN3879">3879</td><td class="line">            <span class='keyword'>if</span> (reply != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="3880"><td class="num" id="LN3880">3880</td><td class="line">            printf(<span class='string_literal'>"%s:%d (%s...) -&gt; %d keys | %d slots | %d slaves.\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="3881"><td class="num" id="LN3881">3881</td><td class="line">                   node-&gt;ip, node-&gt;port, name, dbsize,</td></tr>
<tr class="codeline" data-linenumber="3882"><td class="num" id="LN3882">3882</td><td class="line">                   node-&gt;slots_count, replicas);</td></tr>
<tr class="codeline" data-linenumber="3883"><td class="num" id="LN3883">3883</td><td class="line">            masters++;</td></tr>
<tr class="codeline" data-linenumber="3884"><td class="num" id="LN3884">3884</td><td class="line">            keys += dbsize;</td></tr>
<tr class="codeline" data-linenumber="3885"><td class="num" id="LN3885">3885</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3886"><td class="num" id="LN3886">3886</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3887"><td class="num" id="LN3887">3887</td><td class="line">    <span class='macro'>clusterManagerLogOk(<span class='string_literal'>"[OK] %d keys in %d masters.\n"</span>, keys, masters)<span class='macro_popup'>clusterManagerLog(4,"[OK] %d keys in %d masters.\n", keys, masters<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3888"><td class="num" id="LN3888">3888</td><td class="line">    <span class='keyword'>float</span> keys_per_slot = keys / (<span class='keyword'>float</span>) <span class='macro'>CLUSTER_MANAGER_SLOTS<span class='macro_popup'>16384</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3889"><td class="num" id="LN3889">3889</td><td class="line">    printf(<span class='string_literal'>"%.2f keys per slot on average.\n"</span>, keys_per_slot);</td></tr>
<tr class="codeline" data-linenumber="3890"><td class="num" id="LN3890">3890</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3891"><td class="num" id="LN3891">3891</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3892"><td class="num" id="LN3892">3892</td><td class="line"><span class='comment'>/* Flush dirty slots configuration of the node by calling CLUSTER ADDSLOTS */</span></td></tr>
<tr class="codeline" data-linenumber="3893"><td class="num" id="LN3893">3893</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerAddSlots(clusterManagerNode *node, <span class='keyword'>char</span>**err)</td></tr>
<tr class="codeline" data-linenumber="3894"><td class="num" id="LN3894">3894</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3895"><td class="num" id="LN3895">3895</td><td class="line">    redisReply *reply = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3896"><td class="num" id="LN3896">3896</td><td class="line">    <span class='keyword'>void</span> *_reply = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3897"><td class="num" id="LN3897">3897</td><td class="line">    <span class='keyword'>int</span> success = 1;</td></tr>
<tr class="codeline" data-linenumber="3898"><td class="num" id="LN3898">3898</td><td class="line">    <span class='comment'>/* First two args are used for the command itself. */</span></td></tr>
<tr class="codeline" data-linenumber="3899"><td class="num" id="LN3899">3899</td><td class="line">    <span class='keyword'>int</span> argc = node-&gt;slots_count + 2;</td></tr>
<tr class="codeline" data-linenumber="3900"><td class="num" id="LN3900">3900</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> *argv = zmalloc(argc * <span class='keyword'>sizeof</span>(*argv));</td></tr>
<tr class="codeline" data-linenumber="3901"><td class="num" id="LN3901">3901</td><td class="line">    size_t *argvlen = zmalloc(argc * <span class='keyword'>sizeof</span>(*argvlen));</td></tr>
<tr class="codeline" data-linenumber="3902"><td class="num" id="LN3902">3902</td><td class="line">    argv[0] = <span class='string_literal'>"CLUSTER"</span>;</td></tr>
<tr class="codeline" data-linenumber="3903"><td class="num" id="LN3903">3903</td><td class="line">    argv[1] = <span class='string_literal'>"ADDSLOTS"</span>;</td></tr>
<tr class="codeline" data-linenumber="3904"><td class="num" id="LN3904">3904</td><td class="line">    argvlen[0] = 7;</td></tr>
<tr class="codeline" data-linenumber="3905"><td class="num" id="LN3905">3905</td><td class="line">    argvlen[1] = 8;</td></tr>
<tr class="codeline" data-linenumber="3906"><td class="num" id="LN3906">3906</td><td class="line">    *err = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3907"><td class="num" id="LN3907">3907</td><td class="line">    <span class='keyword'>int</span> i, argv_idx = 2;</td></tr>
<tr class="codeline" data-linenumber="3908"><td class="num" id="LN3908">3908</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; <span class='macro'>CLUSTER_MANAGER_SLOTS<span class='macro_popup'>16384</span></span>; i++) {</td></tr>
<tr class="codeline" data-linenumber="3909"><td class="num" id="LN3909">3909</td><td class="line">        <span class='keyword'>if</span> (argv_idx &gt;= argc) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3910"><td class="num" id="LN3910">3910</td><td class="line">        <span class='keyword'>if</span> (node-&gt;slots[i]) {</td></tr>
<tr class="codeline" data-linenumber="3911"><td class="num" id="LN3911">3911</td><td class="line">            argv[argv_idx] = <span class='macro'>sdsfromlonglong<span class='macro_popup'>hi_sdsfromlonglong</span></span>((<span class='keyword'>long</span> <span class='keyword'>long</span>) i);</td></tr>
<tr class="codeline" data-linenumber="3912"><td class="num" id="LN3912">3912</td><td class="line">            argvlen[argv_idx] = <span class='macro'>sdslen<span class='macro_popup'>hi_sdslen</span></span>(argv[argv_idx]);</td></tr>
<tr class="codeline" data-linenumber="3913"><td class="num" id="LN3913">3913</td><td class="line">            argv_idx++;</td></tr>
<tr class="codeline" data-linenumber="3914"><td class="num" id="LN3914">3914</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3915"><td class="num" id="LN3915">3915</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3916"><td class="num" id="LN3916">3916</td><td class="line">    <span class='keyword'>if</span> (argv_idx == 2) {</td></tr>
<tr class="codeline" data-linenumber="3917"><td class="num" id="LN3917">3917</td><td class="line">        success = 0;</td></tr>
<tr class="codeline" data-linenumber="3918"><td class="num" id="LN3918">3918</td><td class="line">        <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="3919"><td class="num" id="LN3919">3919</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3920"><td class="num" id="LN3920">3920</td><td class="line">    redisAppendCommandArgv(node-&gt;context,argc,(<span class='keyword'>const</span> <span class='keyword'>char</span>**)argv,argvlen);</td></tr>
<tr class="codeline" data-linenumber="3921"><td class="num" id="LN3921">3921</td><td class="line">    <span class='keyword'>if</span> (redisGetReply(node-&gt;context, &amp;_reply) != <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3922"><td class="num" id="LN3922">3922</td><td class="line">        success = 0;</td></tr>
<tr class="codeline" data-linenumber="3923"><td class="num" id="LN3923">3923</td><td class="line">        <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="3924"><td class="num" id="LN3924">3924</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3925"><td class="num" id="LN3925">3925</td><td class="line">    reply = (redisReply*) _reply;</td></tr>
<tr class="codeline" data-linenumber="3926"><td class="num" id="LN3926">3926</td><td class="line">    success = clusterManagerCheckRedisReply(node, reply, err);</td></tr>
<tr class="codeline" data-linenumber="3927"><td class="num" id="LN3927">3927</td><td class="line">cleanup:</td></tr>
<tr class="codeline" data-linenumber="3928"><td class="num" id="LN3928">3928</td><td class="line">    zfree(argvlen);</td></tr>
<tr class="codeline" data-linenumber="3929"><td class="num" id="LN3929">3929</td><td class="line">    <span class='keyword'>if</span> (argv != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3930"><td class="num" id="LN3930">3930</td><td class="line">        <span class='keyword'>for</span> (i = 2; i &lt; argc; i++) <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(argv[i]);</td></tr>
<tr class="codeline" data-linenumber="3931"><td class="num" id="LN3931">3931</td><td class="line">        zfree(argv);</td></tr>
<tr class="codeline" data-linenumber="3932"><td class="num" id="LN3932">3932</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3933"><td class="num" id="LN3933">3933</td><td class="line">    <span class='keyword'>if</span> (reply != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="3934"><td class="num" id="LN3934">3934</td><td class="line">    <span class='keyword'>return</span> success;</td></tr>
<tr class="codeline" data-linenumber="3935"><td class="num" id="LN3935">3935</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3936"><td class="num" id="LN3936">3936</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3937"><td class="num" id="LN3937">3937</td><td class="line"><span class='comment'>/* Get the node the slot is assigned to from the point of view of node *n.</span></td></tr>
<tr class="codeline" data-linenumber="3938"><td class="num" id="LN3938">3938</td><td class="line"> <span class='comment'>* If the slot is unassigned or if the reply is an error, return NULL.</span></td></tr>
<tr class="codeline" data-linenumber="3939"><td class="num" id="LN3939">3939</td><td class="line"> <span class='comment'>* Use the **err argument in order to check whether the slot is unassigned</span></td></tr>
<tr class="codeline" data-linenumber="3940"><td class="num" id="LN3940">3940</td><td class="line"> <span class='comment'>* or the reply resulted in an error. */</span></td></tr>
<tr class="codeline" data-linenumber="3941"><td class="num" id="LN3941">3941</td><td class="line"><span class='keyword'>static</span> clusterManagerNode *clusterManagerGetSlotOwner(clusterManagerNode *n,</td></tr>
<tr class="codeline" data-linenumber="3942"><td class="num" id="LN3942">3942</td><td class="line">                                                      <span class='keyword'>int</span> slot, <span class='keyword'>char</span> **err)</td></tr>
<tr class="codeline" data-linenumber="3943"><td class="num" id="LN3943">3943</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3944"><td class="num" id="LN3944">3944</td><td class="line">    <span class='macro'>assert(slot &gt;= 0 &amp;&amp; slot &lt; CLUSTER_MANAGER_SLOTS)<span class='macro_popup'>((slot &gt;= 0 &amp;&amp; slot &lt; 16384) ? (void) (0) : __assert_fail<br> ("slot &gt;= 0 &amp;&amp; slot &lt; CLUSTER_MANAGER_SLOTS", "redis-cli.c"<br>, 3944, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3945"><td class="num" id="LN3945">3945</td><td class="line">    clusterManagerNode *owner = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3946"><td class="num" id="LN3946">3946</td><td class="line">    redisReply *reply = <span class='macro'>CLUSTER_MANAGER_COMMAND(n, <span class='string_literal'>"CLUSTER SLOTS"</span>)<span class='macro_popup'>(redisCommand(n-&gt;context, "CLUSTER SLOTS"))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3947"><td class="num" id="LN3947">3947</td><td class="line">    <span class='keyword'>if</span> (clusterManagerCheckRedisReply(n, reply, err)) {</td></tr>
<tr class="codeline" data-linenumber="3948"><td class="num" id="LN3948">3948</td><td class="line">        <span class='macro'>assert(reply-&gt;type == REDIS_REPLY_ARRAY)<span class='macro_popup'>((reply-&gt;type == 2) ? (void) (0) : __assert_fail ("reply-&gt;type == REDIS_REPLY_ARRAY"<br>, "redis-cli.c", 3948, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3949"><td class="num" id="LN3949">3949</td><td class="line">        size_t i;</td></tr>
<tr class="codeline" data-linenumber="3950"><td class="num" id="LN3950">3950</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; reply-&gt;elements; i++) {</td></tr>
<tr class="codeline" data-linenumber="3951"><td class="num" id="LN3951">3951</td><td class="line">            redisReply *r = reply-&gt;element[i];</td></tr>
<tr class="codeline" data-linenumber="3952"><td class="num" id="LN3952">3952</td><td class="line">            <span class='macro'>assert(r-&gt;type == REDIS_REPLY_ARRAY &amp;&amp; r-&gt;elements &gt;= 3)<span class='macro_popup'>((r-&gt;type == 2 &amp;&amp; r-&gt;elements &gt;= 3) ? (void)<br> (0) : __assert_fail ("r-&gt;type == REDIS_REPLY_ARRAY &amp;&amp; r-&gt;elements &gt;= 3"<br>, "redis-cli.c", 3952, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3953"><td class="num" id="LN3953">3953</td><td class="line">            <span class='keyword'>int</span> from, to;</td></tr>
<tr class="codeline" data-linenumber="3954"><td class="num" id="LN3954">3954</td><td class="line">            from = r-&gt;element[0]-&gt;integer;</td></tr>
<tr class="codeline" data-linenumber="3955"><td class="num" id="LN3955">3955</td><td class="line">            to = r-&gt;element[1]-&gt;integer;</td></tr>
<tr class="codeline" data-linenumber="3956"><td class="num" id="LN3956">3956</td><td class="line">            <span class='keyword'>if</span> (slot &lt; from || slot &gt; to) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="3957"><td class="num" id="LN3957">3957</td><td class="line">            redisReply *nr =  r-&gt;element[2];</td></tr>
<tr class="codeline" data-linenumber="3958"><td class="num" id="LN3958">3958</td><td class="line">            <span class='macro'>assert(nr-&gt;type == REDIS_REPLY_ARRAY &amp;&amp; nr-&gt;elements &gt;= 2)<span class='macro_popup'>((nr-&gt;type == 2 &amp;&amp; nr-&gt;elements &gt;= 2) ? (void<br>) (0) : __assert_fail ("nr-&gt;type == REDIS_REPLY_ARRAY &amp;&amp; nr-&gt;elements &gt;= 2"<br>, "redis-cli.c", 3958, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3959"><td class="num" id="LN3959">3959</td><td class="line">            <span class='keyword'>char</span> *name = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3960"><td class="num" id="LN3960">3960</td><td class="line">            <span class='keyword'>if</span> (nr-&gt;elements &gt;= 3)</td></tr>
<tr class="codeline" data-linenumber="3961"><td class="num" id="LN3961">3961</td><td class="line">                name =  nr-&gt;element[2]-&gt;str;</td></tr>
<tr class="codeline" data-linenumber="3962"><td class="num" id="LN3962">3962</td><td class="line">            <span class='keyword'>if</span> (name != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3963"><td class="num" id="LN3963">3963</td><td class="line">                owner = clusterManagerNodeByName(name);</td></tr>
<tr class="codeline" data-linenumber="3964"><td class="num" id="LN3964">3964</td><td class="line">            <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="3965"><td class="num" id="LN3965">3965</td><td class="line">                <span class='keyword'>char</span> *ip = nr-&gt;element[0]-&gt;str;</td></tr>
<tr class="codeline" data-linenumber="3966"><td class="num" id="LN3966">3966</td><td class="line">                <span class='macro'>assert(ip != NULL)<span class='macro_popup'>((ip != ((void*)0)) ? (void) (0) : __assert_fail ("ip != NULL"<br>, "redis-cli.c", 3966, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3967"><td class="num" id="LN3967">3967</td><td class="line">                <span class='keyword'>int</span> port = (<span class='keyword'>int</span>) nr-&gt;element[1]-&gt;integer;</td></tr>
<tr class="codeline" data-linenumber="3968"><td class="num" id="LN3968">3968</td><td class="line">                listIter li;</td></tr>
<tr class="codeline" data-linenumber="3969"><td class="num" id="LN3969">3969</td><td class="line">                listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="3970"><td class="num" id="LN3970">3970</td><td class="line">                listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="3971"><td class="num" id="LN3971">3971</td><td class="line">                <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3972"><td class="num" id="LN3972">3972</td><td class="line">                    clusterManagerNode *nd = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="3973"><td class="num" id="LN3973">3973</td><td class="line">                    <span class='keyword'>if</span> (strcmp(nd-&gt;ip, ip) == 0 &amp;&amp; port == nd-&gt;port) {</td></tr>
<tr class="codeline" data-linenumber="3974"><td class="num" id="LN3974">3974</td><td class="line">                        owner = nd;</td></tr>
<tr class="codeline" data-linenumber="3975"><td class="num" id="LN3975">3975</td><td class="line">                        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3976"><td class="num" id="LN3976">3976</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="3977"><td class="num" id="LN3977">3977</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="3978"><td class="num" id="LN3978">3978</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="3979"><td class="num" id="LN3979">3979</td><td class="line">            <span class='keyword'>if</span> (owner) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3980"><td class="num" id="LN3980">3980</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3981"><td class="num" id="LN3981">3981</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3982"><td class="num" id="LN3982">3982</td><td class="line">    <span class='keyword'>if</span> (reply) freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="3983"><td class="num" id="LN3983">3983</td><td class="line">    <span class='keyword'>return</span> owner;</td></tr>
<tr class="codeline" data-linenumber="3984"><td class="num" id="LN3984">3984</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3985"><td class="num" id="LN3985">3985</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3986"><td class="num" id="LN3986">3986</td><td class="line"><span class='comment'>/* Set slot status to "importing" or "migrating" */</span></td></tr>
<tr class="codeline" data-linenumber="3987"><td class="num" id="LN3987">3987</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerSetSlot(clusterManagerNode *node1,</td></tr>
<tr class="codeline" data-linenumber="3988"><td class="num" id="LN3988">3988</td><td class="line">                                 clusterManagerNode *node2,</td></tr>
<tr class="codeline" data-linenumber="3989"><td class="num" id="LN3989">3989</td><td class="line">                                 <span class='keyword'>int</span> slot, <span class='keyword'>const</span> <span class='keyword'>char</span> *status, <span class='keyword'>char</span> **err) {</td></tr>
<tr class="codeline" data-linenumber="3990"><td class="num" id="LN3990">3990</td><td class="line">    redisReply *reply = <span class='macro'>CLUSTER_MANAGER_COMMAND(node1, <span class='string_literal'>"CLUSTER "<span class='macro_popup'>(redisCommand(node1-&gt;context, "CLUSTER " "SETSLOT %d %s %s"<br>, slot, status, (char *) node2-&gt;name))</span></span></span></td></tr>
<tr class="codeline" data-linenumber="3991"><td class="num" id="LN3991">3991</td><td class="line">                                                <span class='string_literal'><span class='macro'>"SETSLOT %d %s %s"</span>,<span class='macro_popup'>(redisCommand(node1-&gt;context, "CLUSTER " "SETSLOT %d %s %s"<br>, slot, status, (char *) node2-&gt;name))</span></span></td></tr>
<tr class="codeline" data-linenumber="3992"><td class="num" id="LN3992">3992</td><td class="line">                                                <span class='macro'>slot, status,<span class='macro_popup'>(redisCommand(node1-&gt;context, "CLUSTER " "SETSLOT %d %s %s"<br>, slot, status, (char *) node2-&gt;name))</span></span></td></tr>
<tr class="codeline" data-linenumber="3993"><td class="num" id="LN3993">3993</td><td class="line">                                                <span class='macro'>(<span class='keyword'>char</span> *) node2-&gt;name)<span class='macro_popup'>(redisCommand(node1-&gt;context, "CLUSTER " "SETSLOT %d %s %s"<br>, slot, status, (char *) node2-&gt;name))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3994"><td class="num" id="LN3994">3994</td><td class="line">    <span class='keyword'>if</span> (err != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) *err = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3995"><td class="num" id="LN3995">3995</td><td class="line">    <span class='keyword'>if</span> (!reply) {</td></tr>
<tr class="codeline" data-linenumber="3996"><td class="num" id="LN3996">3996</td><td class="line">        <span class='keyword'>if</span> (err) *err = zstrdup(<span class='string_literal'>"CLUSTER SETSLOT failed to run"</span>);</td></tr>
<tr class="codeline" data-linenumber="3997"><td class="num" id="LN3997">3997</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3998"><td class="num" id="LN3998">3998</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3999"><td class="num" id="LN3999">3999</td><td class="line">    <span class='keyword'>int</span> success = 1;</td></tr>
<tr class="codeline" data-linenumber="4000"><td class="num" id="LN4000">4000</td><td class="line">    <span class='keyword'>if</span> (reply-&gt;type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4001"><td class="num" id="LN4001">4001</td><td class="line">        success = 0;</td></tr>
<tr class="codeline" data-linenumber="4002"><td class="num" id="LN4002">4002</td><td class="line">        <span class='keyword'>if</span> (err != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4003"><td class="num" id="LN4003">4003</td><td class="line">            *err = zmalloc((reply-&gt;len + 1) * <span class='keyword'>sizeof</span>(<span class='keyword'>char</span>));</td></tr>
<tr class="codeline" data-linenumber="4004"><td class="num" id="LN4004">4004</td><td class="line">            strcpy(*err, reply-&gt;str);</td></tr>
<tr class="codeline" data-linenumber="4005"><td class="num" id="LN4005">4005</td><td class="line">        } <span class='keyword'>else</span> <span class='macro'>CLUSTER_MANAGER_PRINT_REPLY_ERROR(node1, reply-&gt;str)<span class='macro_popup'>clusterManagerLog(3,"Node %s:%d replied with error:\n%s\n", node1<br>-&gt;ip, node1-&gt;port, reply-&gt;str);</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4006"><td class="num" id="LN4006">4006</td><td class="line">        <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="4007"><td class="num" id="LN4007">4007</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4008"><td class="num" id="LN4008">4008</td><td class="line">cleanup:</td></tr>
<tr class="codeline" data-linenumber="4009"><td class="num" id="LN4009">4009</td><td class="line">    freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="4010"><td class="num" id="LN4010">4010</td><td class="line">    <span class='keyword'>return</span> success;</td></tr>
<tr class="codeline" data-linenumber="4011"><td class="num" id="LN4011">4011</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4012"><td class="num" id="LN4012">4012</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4013"><td class="num" id="LN4013">4013</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerClearSlotStatus(clusterManagerNode *node, <span class='keyword'>int</span> slot) {</td></tr>
<tr class="codeline" data-linenumber="4014"><td class="num" id="LN4014">4014</td><td class="line">    redisReply *reply = <span class='macro'>CLUSTER_MANAGER_COMMAND(node,<span class='macro_popup'>(redisCommand(node-&gt;context, "CLUSTER SETSLOT %d %s", slot<br>, "STABLE"))</span></span></td></tr>
<tr class="codeline" data-linenumber="4015"><td class="num" id="LN4015">4015</td><td class="line">        <span class='string_literal'><span class='macro'>"CLUSTER SETSLOT %d %s"</span>, slot, <span class='string_literal'>"STABLE"</span>)<span class='macro_popup'>(redisCommand(node-&gt;context, "CLUSTER SETSLOT %d %s", slot<br>, "STABLE"))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4016"><td class="num" id="LN4016">4016</td><td class="line">    <span class='keyword'>int</span> success = clusterManagerCheckRedisReply(node, reply, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4017"><td class="num" id="LN4017">4017</td><td class="line">    <span class='keyword'>if</span> (reply) freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="4018"><td class="num" id="LN4018">4018</td><td class="line">    <span class='keyword'>return</span> success;</td></tr>
<tr class="codeline" data-linenumber="4019"><td class="num" id="LN4019">4019</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4020"><td class="num" id="LN4020">4020</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4021"><td class="num" id="LN4021">4021</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerDelSlot(clusterManagerNode *node, <span class='keyword'>int</span> slot,</td></tr>
<tr class="codeline" data-linenumber="4022"><td class="num" id="LN4022">4022</td><td class="line">                                 <span class='keyword'>int</span> ignore_unassigned_err)</td></tr>
<tr class="codeline" data-linenumber="4023"><td class="num" id="LN4023">4023</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="4024"><td class="num" id="LN4024">4024</td><td class="line">    redisReply *reply = <span class='macro'>CLUSTER_MANAGER_COMMAND(node,<span class='macro_popup'>(redisCommand(node-&gt;context, "CLUSTER DELSLOTS %d", slot))</span></span></td></tr>
<tr class="codeline" data-linenumber="4025"><td class="num" id="LN4025">4025</td><td class="line">        <span class='string_literal'><span class='macro'>"CLUSTER DELSLOTS %d"</span>, slot)<span class='macro_popup'>(redisCommand(node-&gt;context, "CLUSTER DELSLOTS %d", slot))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4026"><td class="num" id="LN4026">4026</td><td class="line">    <span class='keyword'>char</span> *err = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4027"><td class="num" id="LN4027">4027</td><td class="line">    <span class='keyword'>int</span> success = clusterManagerCheckRedisReply(node, reply, &amp;err);</td></tr>
<tr class="codeline" data-linenumber="4028"><td class="num" id="LN4028">4028</td><td class="line">    <span class='keyword'>if</span> (!success &amp;&amp; reply &amp;&amp; reply-&gt;type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="4029"><td class="num" id="LN4029">4029</td><td class="line">        ignore_unassigned_err)</td></tr>
<tr class="codeline" data-linenumber="4030"><td class="num" id="LN4030">4030</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="4031"><td class="num" id="LN4031">4031</td><td class="line">        <span class='keyword'>char</span> *get_owner_err = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4032"><td class="num" id="LN4032">4032</td><td class="line">        clusterManagerNode *assigned_to =</td></tr>
<tr class="codeline" data-linenumber="4033"><td class="num" id="LN4033">4033</td><td class="line">            clusterManagerGetSlotOwner(node, slot, &amp;get_owner_err);</td></tr>
<tr class="codeline" data-linenumber="4034"><td class="num" id="LN4034">4034</td><td class="line">        <span class='keyword'>if</span> (!assigned_to) {</td></tr>
<tr class="codeline" data-linenumber="4035"><td class="num" id="LN4035">4035</td><td class="line">            <span class='keyword'>if</span> (get_owner_err == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) success = 1;</td></tr>
<tr class="codeline" data-linenumber="4036"><td class="num" id="LN4036">4036</td><td class="line">            <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="4037"><td class="num" id="LN4037">4037</td><td class="line">                <span class='macro'>CLUSTER_MANAGER_PRINT_REPLY_ERROR(node, get_owner_err)<span class='macro_popup'>clusterManagerLog(3,"Node %s:%d replied with error:\n%s\n", node<br>-&gt;ip, node-&gt;port, get_owner_err);</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4038"><td class="num" id="LN4038">4038</td><td class="line">                zfree(get_owner_err);</td></tr>
<tr class="codeline" data-linenumber="4039"><td class="num" id="LN4039">4039</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="4040"><td class="num" id="LN4040">4040</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4041"><td class="num" id="LN4041">4041</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4042"><td class="num" id="LN4042">4042</td><td class="line">    <span class='keyword'>if</span> (!success &amp;&amp; err != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4043"><td class="num" id="LN4043">4043</td><td class="line">        <span class='macro'>CLUSTER_MANAGER_PRINT_REPLY_ERROR(node, err)<span class='macro_popup'>clusterManagerLog(3,"Node %s:%d replied with error:\n%s\n", node<br>-&gt;ip, node-&gt;port, err);</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4044"><td class="num" id="LN4044">4044</td><td class="line">        zfree(err);</td></tr>
<tr class="codeline" data-linenumber="4045"><td class="num" id="LN4045">4045</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4046"><td class="num" id="LN4046">4046</td><td class="line">    <span class='keyword'>if</span> (reply) freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="4047"><td class="num" id="LN4047">4047</td><td class="line">    <span class='keyword'>return</span> success;</td></tr>
<tr class="codeline" data-linenumber="4048"><td class="num" id="LN4048">4048</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4049"><td class="num" id="LN4049">4049</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4050"><td class="num" id="LN4050">4050</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerAddSlot(clusterManagerNode *node, <span class='keyword'>int</span> slot) {</td></tr>
<tr class="codeline" data-linenumber="4051"><td class="num" id="LN4051">4051</td><td class="line">    redisReply *reply = <span class='macro'>CLUSTER_MANAGER_COMMAND(node,<span class='macro_popup'>(redisCommand(node-&gt;context, "CLUSTER ADDSLOTS %d", slot))</span></span></td></tr>
<tr class="codeline" data-linenumber="4052"><td class="num" id="LN4052">4052</td><td class="line">        <span class='string_literal'><span class='macro'>"CLUSTER ADDSLOTS %d"</span>, slot)<span class='macro_popup'>(redisCommand(node-&gt;context, "CLUSTER ADDSLOTS %d", slot))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4053"><td class="num" id="LN4053">4053</td><td class="line">    <span class='keyword'>int</span> success = clusterManagerCheckRedisReply(node, reply, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4054"><td class="num" id="LN4054">4054</td><td class="line">    <span class='keyword'>if</span> (reply) freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="4055"><td class="num" id="LN4055">4055</td><td class="line">    <span class='keyword'>return</span> success;</td></tr>
<tr class="codeline" data-linenumber="4056"><td class="num" id="LN4056">4056</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4057"><td class="num" id="LN4057">4057</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4058"><td class="num" id="LN4058">4058</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>signed</span> <span class='keyword'>int</span> clusterManagerCountKeysInSlot(clusterManagerNode *node,</td></tr>
<tr class="codeline" data-linenumber="4059"><td class="num" id="LN4059">4059</td><td class="line">                                                <span class='keyword'>int</span> slot)</td></tr>
<tr class="codeline" data-linenumber="4060"><td class="num" id="LN4060">4060</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="4061"><td class="num" id="LN4061">4061</td><td class="line">    redisReply *reply = <span class='macro'>CLUSTER_MANAGER_COMMAND(node,<span class='macro_popup'>(redisCommand(node-&gt;context, "CLUSTER COUNTKEYSINSLOT %d",<br> slot))</span></span></td></tr>
<tr class="codeline" data-linenumber="4062"><td class="num" id="LN4062">4062</td><td class="line">        <span class='string_literal'><span class='macro'>"CLUSTER COUNTKEYSINSLOT %d"</span>, slot)<span class='macro_popup'>(redisCommand(node-&gt;context, "CLUSTER COUNTKEYSINSLOT %d",<br> slot))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4063"><td class="num" id="LN4063">4063</td><td class="line">    <span class='keyword'>int</span> count = -1;</td></tr>
<tr class="codeline" data-linenumber="4064"><td class="num" id="LN4064">4064</td><td class="line">    <span class='keyword'>int</span> success = clusterManagerCheckRedisReply(node, reply, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4065"><td class="num" id="LN4065">4065</td><td class="line">    <span class='keyword'>if</span> (success &amp;&amp; reply-&gt;type == <span class='macro'>REDIS_REPLY_INTEGER<span class='macro_popup'>3</span></span>) count = reply-&gt;integer;</td></tr>
<tr class="codeline" data-linenumber="4066"><td class="num" id="LN4066">4066</td><td class="line">    <span class='keyword'>if</span> (reply) freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="4067"><td class="num" id="LN4067">4067</td><td class="line">    <span class='keyword'>return</span> count;</td></tr>
<tr class="codeline" data-linenumber="4068"><td class="num" id="LN4068">4068</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4069"><td class="num" id="LN4069">4069</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4070"><td class="num" id="LN4070">4070</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerBumpEpoch(clusterManagerNode *node) {</td></tr>
<tr class="codeline" data-linenumber="4071"><td class="num" id="LN4071">4071</td><td class="line">    redisReply *reply = <span class='macro'>CLUSTER_MANAGER_COMMAND(node, <span class='string_literal'>"CLUSTER BUMPEPOCH"</span>)<span class='macro_popup'>(redisCommand(node-&gt;context, "CLUSTER BUMPEPOCH"))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4072"><td class="num" id="LN4072">4072</td><td class="line">    <span class='keyword'>int</span> success = clusterManagerCheckRedisReply(node, reply, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4073"><td class="num" id="LN4073">4073</td><td class="line">    <span class='keyword'>if</span> (reply) freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="4074"><td class="num" id="LN4074">4074</td><td class="line">    <span class='keyword'>return</span> success;</td></tr>
<tr class="codeline" data-linenumber="4075"><td class="num" id="LN4075">4075</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4076"><td class="num" id="LN4076">4076</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4077"><td class="num" id="LN4077">4077</td><td class="line"><span class='comment'>/* Callback used by clusterManagerSetSlotOwner transaction. It should ignore</span></td></tr>
<tr class="codeline" data-linenumber="4078"><td class="num" id="LN4078">4078</td><td class="line"> <span class='comment'>* errors except for ADDSLOTS errors.</span></td></tr>
<tr class="codeline" data-linenumber="4079"><td class="num" id="LN4079">4079</td><td class="line"> <span class='comment'>* Return 1 if the error should be ignored. */</span></td></tr>
<tr class="codeline" data-linenumber="4080"><td class="num" id="LN4080">4080</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerOnSetOwnerErr(redisReply *reply,</td></tr>
<tr class="codeline" data-linenumber="4081"><td class="num" id="LN4081">4081</td><td class="line">    clusterManagerNode *n, <span class='keyword'>int</span> bulk_idx)</td></tr>
<tr class="codeline" data-linenumber="4082"><td class="num" id="LN4082">4082</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="4083"><td class="num" id="LN4083">4083</td><td class="line">    <span class='macro'>UNUSED(reply)<span class='macro_popup'>((void) reply)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4084"><td class="num" id="LN4084">4084</td><td class="line">    <span class='macro'>UNUSED(n)<span class='macro_popup'>((void) n)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4085"><td class="num" id="LN4085">4085</td><td class="line">    <span class='comment'>/* Only raise error when ADDSLOTS fail (bulk_idx == 1). */</span></td></tr>
<tr class="codeline" data-linenumber="4086"><td class="num" id="LN4086">4086</td><td class="line">    <span class='keyword'>return</span> (bulk_idx != 1);</td></tr>
<tr class="codeline" data-linenumber="4087"><td class="num" id="LN4087">4087</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4088"><td class="num" id="LN4088">4088</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4089"><td class="num" id="LN4089">4089</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerSetSlotOwner(clusterManagerNode *owner,</td></tr>
<tr class="codeline" data-linenumber="4090"><td class="num" id="LN4090">4090</td><td class="line">                                      <span class='keyword'>int</span> slot,</td></tr>
<tr class="codeline" data-linenumber="4091"><td class="num" id="LN4091">4091</td><td class="line">                                      <span class='keyword'>int</span> do_clear)</td></tr>
<tr class="codeline" data-linenumber="4092"><td class="num" id="LN4092">4092</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="4093"><td class="num" id="LN4093">4093</td><td class="line">    <span class='keyword'>int</span> success = clusterManagerStartTransaction(owner);</td></tr>
<tr class="codeline" data-linenumber="4094"><td class="num" id="LN4094">4094</td><td class="line">    <span class='keyword'>if</span> (!success) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="4095"><td class="num" id="LN4095">4095</td><td class="line">    <span class='comment'>/* Ensure the slot is not already assigned. */</span></td></tr>
<tr class="codeline" data-linenumber="4096"><td class="num" id="LN4096">4096</td><td class="line">    clusterManagerDelSlot(owner, slot, 1);</td></tr>
<tr class="codeline" data-linenumber="4097"><td class="num" id="LN4097">4097</td><td class="line">    <span class='comment'>/* Add the slot and bump epoch. */</span></td></tr>
<tr class="codeline" data-linenumber="4098"><td class="num" id="LN4098">4098</td><td class="line">    clusterManagerAddSlot(owner, slot);</td></tr>
<tr class="codeline" data-linenumber="4099"><td class="num" id="LN4099">4099</td><td class="line">    <span class='keyword'>if</span> (do_clear) clusterManagerClearSlotStatus(owner, slot);</td></tr>
<tr class="codeline" data-linenumber="4100"><td class="num" id="LN4100">4100</td><td class="line">    clusterManagerBumpEpoch(owner);</td></tr>
<tr class="codeline" data-linenumber="4101"><td class="num" id="LN4101">4101</td><td class="line">    success = clusterManagerExecTransaction(owner, clusterManagerOnSetOwnerErr);</td></tr>
<tr class="codeline" data-linenumber="4102"><td class="num" id="LN4102">4102</td><td class="line">    <span class='keyword'>return</span> success;</td></tr>
<tr class="codeline" data-linenumber="4103"><td class="num" id="LN4103">4103</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4104"><td class="num" id="LN4104">4104</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4105"><td class="num" id="LN4105">4105</td><td class="line"><span class='comment'>/* Get the hash for the values of the specified keys in *keys_reply for the</span></td></tr>
<tr class="codeline" data-linenumber="4106"><td class="num" id="LN4106">4106</td><td class="line"> <span class='comment'>* specified nodes *n1 and *n2, by calling DEBUG DIGEST-VALUE redis command</span></td></tr>
<tr class="codeline" data-linenumber="4107"><td class="num" id="LN4107">4107</td><td class="line"> <span class='comment'>* on both nodes. Every key with same name on both nodes but having different</span></td></tr>
<tr class="codeline" data-linenumber="4108"><td class="num" id="LN4108">4108</td><td class="line"> <span class='comment'>* values will be added to the *diffs list. Return 0 in case of reply</span></td></tr>
<tr class="codeline" data-linenumber="4109"><td class="num" id="LN4109">4109</td><td class="line"> <span class='comment'>* error. */</span></td></tr>
<tr class="codeline" data-linenumber="4110"><td class="num" id="LN4110">4110</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerCompareKeysValues(clusterManagerNode *n1,</td></tr>
<tr class="codeline" data-linenumber="4111"><td class="num" id="LN4111">4111</td><td class="line">                                          clusterManagerNode *n2,</td></tr>
<tr class="codeline" data-linenumber="4112"><td class="num" id="LN4112">4112</td><td class="line">                                          redisReply *keys_reply,</td></tr>
<tr class="codeline" data-linenumber="4113"><td class="num" id="LN4113">4113</td><td class="line">                                          list *diffs)</td></tr>
<tr class="codeline" data-linenumber="4114"><td class="num" id="LN4114">4114</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="4115"><td class="num" id="LN4115">4115</td><td class="line">    size_t i, argc = keys_reply-&gt;elements + 2;</td></tr>
<tr class="codeline" data-linenumber="4116"><td class="num" id="LN4116">4116</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>char</span> *hash_zero = <span class='string_literal'>"0000000000000000000000000000000000000000"</span>;</td></tr>
<tr class="codeline" data-linenumber="4117"><td class="num" id="LN4117">4117</td><td class="line">    <span class='keyword'>char</span> **argv = zcalloc(argc * <span class='keyword'>sizeof</span>(<span class='keyword'>char</span> *));</td></tr>
<tr class="codeline" data-linenumber="4118"><td class="num" id="LN4118">4118</td><td class="line">    size_t  *argv_len = zcalloc(argc * <span class='keyword'>sizeof</span>(size_t));</td></tr>
<tr class="codeline" data-linenumber="4119"><td class="num" id="LN4119">4119</td><td class="line">    argv[0] = <span class='string_literal'>"DEBUG"</span>;</td></tr>
<tr class="codeline" data-linenumber="4120"><td class="num" id="LN4120">4120</td><td class="line">    argv_len[0] = 5;</td></tr>
<tr class="codeline" data-linenumber="4121"><td class="num" id="LN4121">4121</td><td class="line">    argv[1] = <span class='string_literal'>"DIGEST-VALUE"</span>;</td></tr>
<tr class="codeline" data-linenumber="4122"><td class="num" id="LN4122">4122</td><td class="line">    argv_len[1] = 12;</td></tr>
<tr class="codeline" data-linenumber="4123"><td class="num" id="LN4123">4123</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; keys_reply-&gt;elements; i++) {</td></tr>
<tr class="codeline" data-linenumber="4124"><td class="num" id="LN4124">4124</td><td class="line">        redisReply *entry = keys_reply-&gt;element[i];</td></tr>
<tr class="codeline" data-linenumber="4125"><td class="num" id="LN4125">4125</td><td class="line">        <span class='keyword'>int</span> idx = i + 2;</td></tr>
<tr class="codeline" data-linenumber="4126"><td class="num" id="LN4126">4126</td><td class="line">        argv[idx] = entry-&gt;str;</td></tr>
<tr class="codeline" data-linenumber="4127"><td class="num" id="LN4127">4127</td><td class="line">        argv_len[idx] = entry-&gt;len;</td></tr>
<tr class="codeline" data-linenumber="4128"><td class="num" id="LN4128">4128</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4129"><td class="num" id="LN4129">4129</td><td class="line">    <span class='keyword'>int</span> success = 0;</td></tr>
<tr class="codeline" data-linenumber="4130"><td class="num" id="LN4130">4130</td><td class="line">    <span class='keyword'>void</span> *_reply1 = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, *_reply2 = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4131"><td class="num" id="LN4131">4131</td><td class="line">    redisReply *r1 = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, *r2 = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4132"><td class="num" id="LN4132">4132</td><td class="line">    redisAppendCommandArgv(n1-&gt;context,argc, (<span class='keyword'>const</span> <span class='keyword'>char</span>**)argv,argv_len);</td></tr>
<tr class="codeline" data-linenumber="4133"><td class="num" id="LN4133">4133</td><td class="line">    success = (redisGetReply(n1-&gt;context, &amp;_reply1) == <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4134"><td class="num" id="LN4134">4134</td><td class="line">    <span class='keyword'>if</span> (!success) <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="4135"><td class="num" id="LN4135">4135</td><td class="line">    r1 = (redisReply *) _reply1;</td></tr>
<tr class="codeline" data-linenumber="4136"><td class="num" id="LN4136">4136</td><td class="line">    redisAppendCommandArgv(n2-&gt;context,argc, (<span class='keyword'>const</span> <span class='keyword'>char</span>**)argv,argv_len);</td></tr>
<tr class="codeline" data-linenumber="4137"><td class="num" id="LN4137">4137</td><td class="line">    success = (redisGetReply(n2-&gt;context, &amp;_reply2) == <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4138"><td class="num" id="LN4138">4138</td><td class="line">    <span class='keyword'>if</span> (!success) <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="4139"><td class="num" id="LN4139">4139</td><td class="line">    r2 = (redisReply *) _reply2;</td></tr>
<tr class="codeline" data-linenumber="4140"><td class="num" id="LN4140">4140</td><td class="line">    success = (r1-&gt;type != <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span> &amp;&amp; r2-&gt;type != <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4141"><td class="num" id="LN4141">4141</td><td class="line">    <span class='keyword'>if</span> (r1-&gt;type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4142"><td class="num" id="LN4142">4142</td><td class="line">        <span class='macro'>CLUSTER_MANAGER_PRINT_REPLY_ERROR(n1, r1-&gt;str)<span class='macro_popup'>clusterManagerLog(3,"Node %s:%d replied with error:\n%s\n", n1<br>-&gt;ip, n1-&gt;port, r1-&gt;str);</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4143"><td class="num" id="LN4143">4143</td><td class="line">        success = 0;</td></tr>
<tr class="codeline" data-linenumber="4144"><td class="num" id="LN4144">4144</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4145"><td class="num" id="LN4145">4145</td><td class="line">    <span class='keyword'>if</span> (r2-&gt;type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4146"><td class="num" id="LN4146">4146</td><td class="line">        <span class='macro'>CLUSTER_MANAGER_PRINT_REPLY_ERROR(n2, r2-&gt;str)<span class='macro_popup'>clusterManagerLog(3,"Node %s:%d replied with error:\n%s\n", n2<br>-&gt;ip, n2-&gt;port, r2-&gt;str);</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4147"><td class="num" id="LN4147">4147</td><td class="line">        success = 0;</td></tr>
<tr class="codeline" data-linenumber="4148"><td class="num" id="LN4148">4148</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4149"><td class="num" id="LN4149">4149</td><td class="line">    <span class='keyword'>if</span> (!success) <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="4150"><td class="num" id="LN4150">4150</td><td class="line">    <span class='macro'>assert(keys_reply-&gt;elements == r1-&gt;elements &amp;&amp;<span class='macro_popup'>((keys_reply-&gt;elements == r1-&gt;elements &amp;&amp; keys_reply<br>-&gt;elements == r2-&gt;elements) ? (void) (0) : __assert_fail<br> ("keys_reply-&gt;elements == r1-&gt;elements &amp;&amp; keys_reply-&gt;elements == r2-&gt;elements"<br>, "redis-cli.c", 4151, __extension__ __PRETTY_FUNCTION__))</span></span></td></tr>
<tr class="codeline" data-linenumber="4151"><td class="num" id="LN4151">4151</td><td class="line">           <span class='macro'>keys_reply-&gt;elements == r2-&gt;elements)<span class='macro_popup'>((keys_reply-&gt;elements == r1-&gt;elements &amp;&amp; keys_reply<br>-&gt;elements == r2-&gt;elements) ? (void) (0) : __assert_fail<br> ("keys_reply-&gt;elements == r1-&gt;elements &amp;&amp; keys_reply-&gt;elements == r2-&gt;elements"<br>, "redis-cli.c", 4151, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4152"><td class="num" id="LN4152">4152</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; keys_reply-&gt;elements; i++) {</td></tr>
<tr class="codeline" data-linenumber="4153"><td class="num" id="LN4153">4153</td><td class="line">        <span class='keyword'>char</span> *key = keys_reply-&gt;element[i]-&gt;str;</td></tr>
<tr class="codeline" data-linenumber="4154"><td class="num" id="LN4154">4154</td><td class="line">        <span class='keyword'>char</span> *hash1 = r1-&gt;element[i]-&gt;str;</td></tr>
<tr class="codeline" data-linenumber="4155"><td class="num" id="LN4155">4155</td><td class="line">        <span class='keyword'>char</span> *hash2 = r2-&gt;element[i]-&gt;str;</td></tr>
<tr class="codeline" data-linenumber="4156"><td class="num" id="LN4156">4156</td><td class="line">        <span class='comment'>/* Ignore keys that don't exist in both nodes. */</span></td></tr>
<tr class="codeline" data-linenumber="4157"><td class="num" id="LN4157">4157</td><td class="line">        <span class='keyword'>if</span> (strcmp(hash1, hash_zero) == 0 || strcmp(hash2, hash_zero) == 0)</td></tr>
<tr class="codeline" data-linenumber="4158"><td class="num" id="LN4158">4158</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="4159"><td class="num" id="LN4159">4159</td><td class="line">        <span class='keyword'>if</span> (strcmp(hash1, hash2) != 0) listAddNodeTail(diffs, key);</td></tr>
<tr class="codeline" data-linenumber="4160"><td class="num" id="LN4160">4160</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4161"><td class="num" id="LN4161">4161</td><td class="line">cleanup:</td></tr>
<tr class="codeline" data-linenumber="4162"><td class="num" id="LN4162">4162</td><td class="line">    <span class='keyword'>if</span> (r1) freeReplyObject(r1);</td></tr>
<tr class="codeline" data-linenumber="4163"><td class="num" id="LN4163">4163</td><td class="line">    <span class='keyword'>if</span> (r2) freeReplyObject(r2);</td></tr>
<tr class="codeline" data-linenumber="4164"><td class="num" id="LN4164">4164</td><td class="line">    zfree(argv);</td></tr>
<tr class="codeline" data-linenumber="4165"><td class="num" id="LN4165">4165</td><td class="line">    zfree(argv_len);</td></tr>
<tr class="codeline" data-linenumber="4166"><td class="num" id="LN4166">4166</td><td class="line">    <span class='keyword'>return</span> success;</td></tr>
<tr class="codeline" data-linenumber="4167"><td class="num" id="LN4167">4167</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4168"><td class="num" id="LN4168">4168</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4169"><td class="num" id="LN4169">4169</td><td class="line"><span class='comment'>/* Migrate keys taken from reply-&gt;elements. It returns the reply from the</span></td></tr>
<tr class="codeline" data-linenumber="4170"><td class="num" id="LN4170">4170</td><td class="line"> <span class='comment'>* MIGRATE command, or NULL if something goes wrong. If the argument 'dots'</span></td></tr>
<tr class="codeline" data-linenumber="4171"><td class="num" id="LN4171">4171</td><td class="line"> <span class='comment'>* is not NULL, a dot will be printed for every migrated key. */</span></td></tr>
<tr class="codeline" data-linenumber="4172"><td class="num" id="LN4172">4172</td><td class="line"><span class='keyword'>static</span> redisReply *clusterManagerMigrateKeysInReply(clusterManagerNode *source,</td></tr>
<tr class="codeline" data-linenumber="4173"><td class="num" id="LN4173">4173</td><td class="line">                                                    clusterManagerNode *target,</td></tr>
<tr class="codeline" data-linenumber="4174"><td class="num" id="LN4174">4174</td><td class="line">                                                    redisReply *reply,</td></tr>
<tr class="codeline" data-linenumber="4175"><td class="num" id="LN4175">4175</td><td class="line">                                                    <span class='keyword'>int</span> replace, <span class='keyword'>int</span> timeout,</td></tr>
<tr class="codeline" data-linenumber="4176"><td class="num" id="LN4176">4176</td><td class="line">                                                    <span class='keyword'>char</span> *dots)</td></tr>
<tr class="codeline" data-linenumber="4177"><td class="num" id="LN4177">4177</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="4178"><td class="num" id="LN4178">4178</td><td class="line">    redisReply *migrate_reply = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4179"><td class="num" id="LN4179">4179</td><td class="line">    <span class='keyword'>char</span> **argv = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4180"><td class="num" id="LN4180">4180</td><td class="line">    size_t *argv_len = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4181"><td class="num" id="LN4181">4181</td><td class="line">    <span class='keyword'>int</span> c = (replace ? 8 : 7);</td></tr>
<tr class="codeline" data-linenumber="4182"><td class="num" id="LN4182">4182</td><td class="line">    <span class='keyword'>if</span> (config.conn_info.auth) c += 2;</td></tr>
<tr class="codeline" data-linenumber="4183"><td class="num" id="LN4183">4183</td><td class="line">    <span class='keyword'>if</span> (config.conn_info.user) c += 1;</td></tr>
<tr class="codeline" data-linenumber="4184"><td class="num" id="LN4184">4184</td><td class="line">    size_t argc = c + reply-&gt;elements;</td></tr>
<tr class="codeline" data-linenumber="4185"><td class="num" id="LN4185">4185</td><td class="line">    size_t i, offset = 6; <span class='comment'>// Keys Offset</span></td></tr>
<tr class="codeline" data-linenumber="4186"><td class="num" id="LN4186">4186</td><td class="line">    argv = zcalloc(argc * <span class='keyword'>sizeof</span>(<span class='keyword'>char</span> *));</td></tr>
<tr class="codeline" data-linenumber="4187"><td class="num" id="LN4187">4187</td><td class="line">    argv_len = zcalloc(argc * <span class='keyword'>sizeof</span>(size_t));</td></tr>
<tr class="codeline" data-linenumber="4188"><td class="num" id="LN4188">4188</td><td class="line">    <span class='keyword'>char</span> portstr[255];</td></tr>
<tr class="codeline" data-linenumber="4189"><td class="num" id="LN4189">4189</td><td class="line">    <span class='keyword'>char</span> timeoutstr[255];</td></tr>
<tr class="codeline" data-linenumber="4190"><td class="num" id="LN4190">4190</td><td class="line">    snprintf(portstr, 10, <span class='string_literal'>"%d"</span>, target-&gt;port);</td></tr>
<tr class="codeline" data-linenumber="4191"><td class="num" id="LN4191">4191</td><td class="line">    snprintf(timeoutstr, 10, <span class='string_literal'>"%d"</span>, timeout);</td></tr>
<tr class="codeline" data-linenumber="4192"><td class="num" id="LN4192">4192</td><td class="line">    argv[0] = <span class='string_literal'>"MIGRATE"</span>;</td></tr>
<tr class="codeline" data-linenumber="4193"><td class="num" id="LN4193">4193</td><td class="line">    argv_len[0] = 7;</td></tr>
<tr class="codeline" data-linenumber="4194"><td class="num" id="LN4194">4194</td><td class="line">    argv[1] = target-&gt;ip;</td></tr>
<tr class="codeline" data-linenumber="4195"><td class="num" id="LN4195">4195</td><td class="line">    argv_len[1] = strlen(target-&gt;ip);</td></tr>
<tr class="codeline" data-linenumber="4196"><td class="num" id="LN4196">4196</td><td class="line">    argv[2] = portstr;</td></tr>
<tr class="codeline" data-linenumber="4197"><td class="num" id="LN4197">4197</td><td class="line">    argv_len[2] = strlen(portstr);</td></tr>
<tr class="codeline" data-linenumber="4198"><td class="num" id="LN4198">4198</td><td class="line">    argv[3] = <span class='string_literal'>""</span>;</td></tr>
<tr class="codeline" data-linenumber="4199"><td class="num" id="LN4199">4199</td><td class="line">    argv_len[3] = 0;</td></tr>
<tr class="codeline" data-linenumber="4200"><td class="num" id="LN4200">4200</td><td class="line">    argv[4] = <span class='string_literal'>"0"</span>;</td></tr>
<tr class="codeline" data-linenumber="4201"><td class="num" id="LN4201">4201</td><td class="line">    argv_len[4] = 1;</td></tr>
<tr class="codeline" data-linenumber="4202"><td class="num" id="LN4202">4202</td><td class="line">    argv[5] = timeoutstr;</td></tr>
<tr class="codeline" data-linenumber="4203"><td class="num" id="LN4203">4203</td><td class="line">    argv_len[5] = strlen(timeoutstr);</td></tr>
<tr class="codeline" data-linenumber="4204"><td class="num" id="LN4204">4204</td><td class="line">    <span class='keyword'>if</span> (replace) {</td></tr>
<tr class="codeline" data-linenumber="4205"><td class="num" id="LN4205">4205</td><td class="line">        argv[offset] = <span class='string_literal'>"REPLACE"</span>;</td></tr>
<tr class="codeline" data-linenumber="4206"><td class="num" id="LN4206">4206</td><td class="line">        argv_len[offset] = 7;</td></tr>
<tr class="codeline" data-linenumber="4207"><td class="num" id="LN4207">4207</td><td class="line">        offset++;</td></tr>
<tr class="codeline" data-linenumber="4208"><td class="num" id="LN4208">4208</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4209"><td class="num" id="LN4209">4209</td><td class="line">    <span class='keyword'>if</span> (config.conn_info.auth) {</td></tr>
<tr class="codeline" data-linenumber="4210"><td class="num" id="LN4210">4210</td><td class="line">        <span class='keyword'>if</span> (config.conn_info.user) {</td></tr>
<tr class="codeline" data-linenumber="4211"><td class="num" id="LN4211">4211</td><td class="line">            argv[offset] = <span class='string_literal'>"AUTH2"</span>;</td></tr>
<tr class="codeline" data-linenumber="4212"><td class="num" id="LN4212">4212</td><td class="line">            argv_len[offset] = 5;</td></tr>
<tr class="codeline" data-linenumber="4213"><td class="num" id="LN4213">4213</td><td class="line">            offset++;</td></tr>
<tr class="codeline" data-linenumber="4214"><td class="num" id="LN4214">4214</td><td class="line">            argv[offset] = config.conn_info.user;</td></tr>
<tr class="codeline" data-linenumber="4215"><td class="num" id="LN4215">4215</td><td class="line">            argv_len[offset] = strlen(config.conn_info.user);</td></tr>
<tr class="codeline" data-linenumber="4216"><td class="num" id="LN4216">4216</td><td class="line">            offset++;</td></tr>
<tr class="codeline" data-linenumber="4217"><td class="num" id="LN4217">4217</td><td class="line">            argv[offset] = config.conn_info.auth;</td></tr>
<tr class="codeline" data-linenumber="4218"><td class="num" id="LN4218">4218</td><td class="line">            argv_len[offset] = strlen(config.conn_info.auth);</td></tr>
<tr class="codeline" data-linenumber="4219"><td class="num" id="LN4219">4219</td><td class="line">            offset++;</td></tr>
<tr class="codeline" data-linenumber="4220"><td class="num" id="LN4220">4220</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="4221"><td class="num" id="LN4221">4221</td><td class="line">            argv[offset] = <span class='string_literal'>"AUTH"</span>;</td></tr>
<tr class="codeline" data-linenumber="4222"><td class="num" id="LN4222">4222</td><td class="line">            argv_len[offset] = 4;</td></tr>
<tr class="codeline" data-linenumber="4223"><td class="num" id="LN4223">4223</td><td class="line">            offset++;</td></tr>
<tr class="codeline" data-linenumber="4224"><td class="num" id="LN4224">4224</td><td class="line">            argv[offset] = config.conn_info.auth;</td></tr>
<tr class="codeline" data-linenumber="4225"><td class="num" id="LN4225">4225</td><td class="line">            argv_len[offset] = strlen(config.conn_info.auth);</td></tr>
<tr class="codeline" data-linenumber="4226"><td class="num" id="LN4226">4226</td><td class="line">            offset++;</td></tr>
<tr class="codeline" data-linenumber="4227"><td class="num" id="LN4227">4227</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4228"><td class="num" id="LN4228">4228</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4229"><td class="num" id="LN4229">4229</td><td class="line">    argv[offset] = <span class='string_literal'>"KEYS"</span>;</td></tr>
<tr class="codeline" data-linenumber="4230"><td class="num" id="LN4230">4230</td><td class="line">    argv_len[offset] = 4;</td></tr>
<tr class="codeline" data-linenumber="4231"><td class="num" id="LN4231">4231</td><td class="line">    offset++;</td></tr>
<tr class="codeline" data-linenumber="4232"><td class="num" id="LN4232">4232</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; reply-&gt;elements; i++) {</td></tr>
<tr class="codeline" data-linenumber="4233"><td class="num" id="LN4233">4233</td><td class="line">        redisReply *entry = reply-&gt;element[i];</td></tr>
<tr class="codeline" data-linenumber="4234"><td class="num" id="LN4234">4234</td><td class="line">        size_t idx = i + offset;</td></tr>
<tr class="codeline" data-linenumber="4235"><td class="num" id="LN4235">4235</td><td class="line">        <span class='macro'>assert(entry-&gt;type == REDIS_REPLY_STRING)<span class='macro_popup'>((entry-&gt;type == 1) ? (void) (0) : __assert_fail ("entry-&gt;type == REDIS_REPLY_STRING"<br>, "redis-cli.c", 4235, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4236"><td class="num" id="LN4236">4236</td><td class="line">        argv[idx] = (<span class='keyword'>char</span> *) <span class='macro'>sdsnewlen<span class='macro_popup'>hi_sdsnewlen</span></span>(entry-&gt;str, entry-&gt;len);</td></tr>
<tr class="codeline" data-linenumber="4237"><td class="num" id="LN4237">4237</td><td class="line">        argv_len[idx] = entry-&gt;len;</td></tr>
<tr class="codeline" data-linenumber="4238"><td class="num" id="LN4238">4238</td><td class="line">        <span class='keyword'>if</span> (dots) dots[i] = '.';</td></tr>
<tr class="codeline" data-linenumber="4239"><td class="num" id="LN4239">4239</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4240"><td class="num" id="LN4240">4240</td><td class="line">    <span class='keyword'>if</span> (dots) dots[reply-&gt;elements] = '\0';</td></tr>
<tr class="codeline" data-linenumber="4241"><td class="num" id="LN4241">4241</td><td class="line">    <span class='keyword'>void</span> *_reply = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4242"><td class="num" id="LN4242">4242</td><td class="line">    redisAppendCommandArgv(source-&gt;context,argc,</td></tr>
<tr class="codeline" data-linenumber="4243"><td class="num" id="LN4243">4243</td><td class="line">                           (<span class='keyword'>const</span> <span class='keyword'>char</span>**)argv,argv_len);</td></tr>
<tr class="codeline" data-linenumber="4244"><td class="num" id="LN4244">4244</td><td class="line">    <span class='keyword'>int</span> success = (redisGetReply(source-&gt;context, &amp;_reply) == <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4245"><td class="num" id="LN4245">4245</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; reply-&gt;elements; i++) <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(argv[i + offset]);</td></tr>
<tr class="codeline" data-linenumber="4246"><td class="num" id="LN4246">4246</td><td class="line">    <span class='keyword'>if</span> (!success) <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="4247"><td class="num" id="LN4247">4247</td><td class="line">    migrate_reply = (redisReply *) _reply;</td></tr>
<tr class="codeline" data-linenumber="4248"><td class="num" id="LN4248">4248</td><td class="line">cleanup:</td></tr>
<tr class="codeline" data-linenumber="4249"><td class="num" id="LN4249">4249</td><td class="line">    zfree(argv);</td></tr>
<tr class="codeline" data-linenumber="4250"><td class="num" id="LN4250">4250</td><td class="line">    zfree(argv_len);</td></tr>
<tr class="codeline" data-linenumber="4251"><td class="num" id="LN4251">4251</td><td class="line">    <span class='keyword'>return</span> migrate_reply;</td></tr>
<tr class="codeline" data-linenumber="4252"><td class="num" id="LN4252">4252</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4253"><td class="num" id="LN4253">4253</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4254"><td class="num" id="LN4254">4254</td><td class="line"><span class='comment'>/* Migrate all keys in the given slot from source to target.*/</span></td></tr>
<tr class="codeline" data-linenumber="4255"><td class="num" id="LN4255">4255</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerMigrateKeysInSlot(clusterManagerNode *source,</td></tr>
<tr class="codeline" data-linenumber="4256"><td class="num" id="LN4256">4256</td><td class="line">                                           clusterManagerNode *target,</td></tr>
<tr class="codeline" data-linenumber="4257"><td class="num" id="LN4257">4257</td><td class="line">                                           <span class='keyword'>int</span> slot, <span class='keyword'>int</span> timeout,</td></tr>
<tr class="codeline" data-linenumber="4258"><td class="num" id="LN4258">4258</td><td class="line">                                           <span class='keyword'>int</span> pipeline, <span class='keyword'>int</span> verbose,</td></tr>
<tr class="codeline" data-linenumber="4259"><td class="num" id="LN4259">4259</td><td class="line">                                           <span class='keyword'>char</span> **err)</td></tr>
<tr class="codeline" data-linenumber="4260"><td class="num" id="LN4260">4260</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="4261"><td class="num" id="LN4261">4261</td><td class="line">    <span class='keyword'>int</span> success = 1;</td></tr>
<tr class="codeline" data-linenumber="4262"><td class="num" id="LN4262">4262</td><td class="line">    <span class='keyword'>int</span> do_fix = config.cluster_manager_command.flags &amp;</td></tr>
<tr class="codeline" data-linenumber="4263"><td class="num" id="LN4263">4263</td><td class="line">                 <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_FIX<span class='macro_popup'>1 &lt;&lt; 0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4264"><td class="num" id="LN4264">4264</td><td class="line">    <span class='keyword'>int</span> do_replace = config.cluster_manager_command.flags &amp;</td></tr>
<tr class="codeline" data-linenumber="4265"><td class="num" id="LN4265">4265</td><td class="line">                     <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_REPLACE<span class='macro_popup'>1 &lt;&lt; 6</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4266"><td class="num" id="LN4266">4266</td><td class="line">    <span class='keyword'>while</span> (1) {</td></tr>
<tr class="codeline" data-linenumber="4267"><td class="num" id="LN4267">4267</td><td class="line">        <span class='keyword'>char</span> *dots = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4268"><td class="num" id="LN4268">4268</td><td class="line">        redisReply *reply = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, *migrate_reply = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4269"><td class="num" id="LN4269">4269</td><td class="line">        reply = <span class='macro'>CLUSTER_MANAGER_COMMAND(source, <span class='string_literal'>"CLUSTER "<span class='macro_popup'>(redisCommand(source-&gt;context, "CLUSTER " "GETKEYSINSLOT %d %d"<br>, slot, pipeline))</span></span></span></td></tr>
<tr class="codeline" data-linenumber="4270"><td class="num" id="LN4270">4270</td><td class="line">                                        <span class='string_literal'><span class='macro'>"GETKEYSINSLOT %d %d"</span>, slot,<span class='macro_popup'>(redisCommand(source-&gt;context, "CLUSTER " "GETKEYSINSLOT %d %d"<br>, slot, pipeline))</span></span></td></tr>
<tr class="codeline" data-linenumber="4271"><td class="num" id="LN4271">4271</td><td class="line">                                        <span class='macro'>pipeline)<span class='macro_popup'>(redisCommand(source-&gt;context, "CLUSTER " "GETKEYSINSLOT %d %d"<br>, slot, pipeline))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4272"><td class="num" id="LN4272">4272</td><td class="line">        success = (reply != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4273"><td class="num" id="LN4273">4273</td><td class="line">        <span class='keyword'>if</span> (!success) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="4274"><td class="num" id="LN4274">4274</td><td class="line">        <span class='keyword'>if</span> (reply-&gt;type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4275"><td class="num" id="LN4275">4275</td><td class="line">            success = 0;</td></tr>
<tr class="codeline" data-linenumber="4276"><td class="num" id="LN4276">4276</td><td class="line">            <span class='keyword'>if</span> (err != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4277"><td class="num" id="LN4277">4277</td><td class="line">                *err = zmalloc((reply-&gt;len + 1) * <span class='keyword'>sizeof</span>(<span class='keyword'>char</span>));</td></tr>
<tr class="codeline" data-linenumber="4278"><td class="num" id="LN4278">4278</td><td class="line">                strcpy(*err, reply-&gt;str);</td></tr>
<tr class="codeline" data-linenumber="4279"><td class="num" id="LN4279">4279</td><td class="line">                <span class='macro'>CLUSTER_MANAGER_PRINT_REPLY_ERROR(source, *err)<span class='macro_popup'>clusterManagerLog(3,"Node %s:%d replied with error:\n%s\n", source<br>-&gt;ip, source-&gt;port, *err);</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4280"><td class="num" id="LN4280">4280</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="4281"><td class="num" id="LN4281">4281</td><td class="line">            <span class='keyword'>goto</span> next;</td></tr>
<tr class="codeline" data-linenumber="4282"><td class="num" id="LN4282">4282</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4283"><td class="num" id="LN4283">4283</td><td class="line">        <span class='macro'>assert(reply-&gt;type == REDIS_REPLY_ARRAY)<span class='macro_popup'>((reply-&gt;type == 2) ? (void) (0) : __assert_fail ("reply-&gt;type == REDIS_REPLY_ARRAY"<br>, "redis-cli.c", 4283, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4284"><td class="num" id="LN4284">4284</td><td class="line">        size_t count = reply-&gt;elements;</td></tr>
<tr class="codeline" data-linenumber="4285"><td class="num" id="LN4285">4285</td><td class="line">        <span class='keyword'>if</span> (count == 0) {</td></tr>
<tr class="codeline" data-linenumber="4286"><td class="num" id="LN4286">4286</td><td class="line">            freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="4287"><td class="num" id="LN4287">4287</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4288"><td class="num" id="LN4288">4288</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4289"><td class="num" id="LN4289">4289</td><td class="line">        <span class='keyword'>if</span> (verbose) dots = zmalloc((count+1) * <span class='keyword'>sizeof</span>(<span class='keyword'>char</span>));</td></tr>
<tr class="codeline" data-linenumber="4290"><td class="num" id="LN4290">4290</td><td class="line">        <span class='comment'>/* Calling MIGRATE command. */</span></td></tr>
<tr class="codeline" data-linenumber="4291"><td class="num" id="LN4291">4291</td><td class="line">        migrate_reply = clusterManagerMigrateKeysInReply(source, target,</td></tr>
<tr class="codeline" data-linenumber="4292"><td class="num" id="LN4292">4292</td><td class="line">                                                         reply, 0, timeout,</td></tr>
<tr class="codeline" data-linenumber="4293"><td class="num" id="LN4293">4293</td><td class="line">                                                         dots);</td></tr>
<tr class="codeline" data-linenumber="4294"><td class="num" id="LN4294">4294</td><td class="line">        <span class='keyword'>if</span> (migrate_reply == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>goto</span> next;</td></tr>
<tr class="codeline" data-linenumber="4295"><td class="num" id="LN4295">4295</td><td class="line">        <span class='keyword'>if</span> (migrate_reply-&gt;type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4296"><td class="num" id="LN4296">4296</td><td class="line">            <span class='keyword'>int</span> is_busy = strstr(migrate_reply-&gt;str, <span class='string_literal'>"BUSYKEY"</span>) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4297"><td class="num" id="LN4297">4297</td><td class="line">            <span class='keyword'>int</span> not_served = 0;</td></tr>
<tr class="codeline" data-linenumber="4298"><td class="num" id="LN4298">4298</td><td class="line">            <span class='keyword'>if</span> (!is_busy) {</td></tr>
<tr class="codeline" data-linenumber="4299"><td class="num" id="LN4299">4299</td><td class="line">                <span class='comment'>/* Check if the slot is unassigned (not served) in the</span></td></tr>
<tr class="codeline" data-linenumber="4300"><td class="num" id="LN4300">4300</td><td class="line">                 <span class='comment'>* source node's configuration. */</span></td></tr>
<tr class="codeline" data-linenumber="4301"><td class="num" id="LN4301">4301</td><td class="line">                <span class='keyword'>char</span> *get_owner_err = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4302"><td class="num" id="LN4302">4302</td><td class="line">                clusterManagerNode *served_by =</td></tr>
<tr class="codeline" data-linenumber="4303"><td class="num" id="LN4303">4303</td><td class="line">                    clusterManagerGetSlotOwner(source, slot, &amp;get_owner_err);</td></tr>
<tr class="codeline" data-linenumber="4304"><td class="num" id="LN4304">4304</td><td class="line">                <span class='keyword'>if</span> (!served_by) {</td></tr>
<tr class="codeline" data-linenumber="4305"><td class="num" id="LN4305">4305</td><td class="line">                    <span class='keyword'>if</span> (get_owner_err == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) not_served = 1;</td></tr>
<tr class="codeline" data-linenumber="4306"><td class="num" id="LN4306">4306</td><td class="line">                    <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="4307"><td class="num" id="LN4307">4307</td><td class="line">                        <span class='macro'>CLUSTER_MANAGER_PRINT_REPLY_ERROR(source,<span class='macro_popup'>clusterManagerLog(3,"Node %s:%d replied with error:\n%s\n", source<br>-&gt;ip, source-&gt;port, get_owner_err);</span></span></td></tr>
<tr class="codeline" data-linenumber="4308"><td class="num" id="LN4308">4308</td><td class="line">                                                          <span class='macro'>get_owner_err)<span class='macro_popup'>clusterManagerLog(3,"Node %s:%d replied with error:\n%s\n", source<br>-&gt;ip, source-&gt;port, get_owner_err);</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4309"><td class="num" id="LN4309">4309</td><td class="line">                        zfree(get_owner_err);</td></tr>
<tr class="codeline" data-linenumber="4310"><td class="num" id="LN4310">4310</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="4311"><td class="num" id="LN4311">4311</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="4312"><td class="num" id="LN4312">4312</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="4313"><td class="num" id="LN4313">4313</td><td class="line">            <span class='comment'>/* Try to handle errors. */</span></td></tr>
<tr class="codeline" data-linenumber="4314"><td class="num" id="LN4314">4314</td><td class="line">            <span class='keyword'>if</span> (is_busy || not_served) {</td></tr>
<tr class="codeline" data-linenumber="4315"><td class="num" id="LN4315">4315</td><td class="line">                <span class='comment'>/* If the key's slot is not served, try to assign slot</span></td></tr>
<tr class="codeline" data-linenumber="4316"><td class="num" id="LN4316">4316</td><td class="line">                 <span class='comment'>* to the target node. */</span></td></tr>
<tr class="codeline" data-linenumber="4317"><td class="num" id="LN4317">4317</td><td class="line">                <span class='keyword'>if</span> (do_fix &amp;&amp; not_served) {</td></tr>
<tr class="codeline" data-linenumber="4318"><td class="num" id="LN4318">4318</td><td class="line">                    <span class='macro'>clusterManagerLogWarn(<span class='string_literal'>"*** Slot was not served, setting "<span class='macro_popup'>clusterManagerLog(2,"*** Slot was not served, setting " "owner to node %s:%d.\n"<br>, target-&gt;ip, target-&gt;port)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="4319"><td class="num" id="LN4319">4319</td><td class="line">                                          <span class='string_literal'><span class='macro'>"owner to node %s:%d.\n"</span>,<span class='macro_popup'>clusterManagerLog(2,"*** Slot was not served, setting " "owner to node %s:%d.\n"<br>, target-&gt;ip, target-&gt;port)</span></span></td></tr>
<tr class="codeline" data-linenumber="4320"><td class="num" id="LN4320">4320</td><td class="line">                                          <span class='macro'>target-&gt;ip, target-&gt;port)<span class='macro_popup'>clusterManagerLog(2,"*** Slot was not served, setting " "owner to node %s:%d.\n"<br>, target-&gt;ip, target-&gt;port)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4321"><td class="num" id="LN4321">4321</td><td class="line">                    clusterManagerSetSlot(source, target, slot, <span class='string_literal'>"node"</span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4322"><td class="num" id="LN4322">4322</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="4323"><td class="num" id="LN4323">4323</td><td class="line">                <span class='comment'>/* If the key already exists in the target node (BUSYKEY),</span></td></tr>
<tr class="codeline" data-linenumber="4324"><td class="num" id="LN4324">4324</td><td class="line">                 <span class='comment'>* check whether its value is the same in both nodes.</span></td></tr>
<tr class="codeline" data-linenumber="4325"><td class="num" id="LN4325">4325</td><td class="line">                 <span class='comment'>* In case of equal values, retry migration with the</span></td></tr>
<tr class="codeline" data-linenumber="4326"><td class="num" id="LN4326">4326</td><td class="line">                 <span class='comment'>* REPLACE option.</span></td></tr>
<tr class="codeline" data-linenumber="4327"><td class="num" id="LN4327">4327</td><td class="line">                 <span class='comment'>* In case of different values:</span></td></tr>
<tr class="codeline" data-linenumber="4328"><td class="num" id="LN4328">4328</td><td class="line">                 <span class='comment'>*  - If the migration is requested by the fix command, stop</span></td></tr>
<tr class="codeline" data-linenumber="4329"><td class="num" id="LN4329">4329</td><td class="line">                 <span class='comment'>*    and warn the user.</span></td></tr>
<tr class="codeline" data-linenumber="4330"><td class="num" id="LN4330">4330</td><td class="line">                 <span class='comment'>*  - In other cases (ie. reshard), proceed only if the user</span></td></tr>
<tr class="codeline" data-linenumber="4331"><td class="num" id="LN4331">4331</td><td class="line">                 <span class='comment'>*    launched the command with the --cluster-replace option.*/</span></td></tr>
<tr class="codeline" data-linenumber="4332"><td class="num" id="LN4332">4332</td><td class="line">                <span class='keyword'>if</span> (is_busy) {</td></tr>
<tr class="codeline" data-linenumber="4333"><td class="num" id="LN4333">4333</td><td class="line">                    <span class='macro'>clusterManagerLogWarn(<span class='string_literal'>"\n*** Target key exists\n"</span>)<span class='macro_popup'>clusterManagerLog(2,"\n*** Target key exists\n")</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4334"><td class="num" id="LN4334">4334</td><td class="line">                    <span class='keyword'>if</span> (!do_replace) {</td></tr>
<tr class="codeline" data-linenumber="4335"><td class="num" id="LN4335">4335</td><td class="line">                        <span class='macro'>clusterManagerLogWarn(<span class='string_literal'>"*** Checking key values on "<span class='macro_popup'>clusterManagerLog(2,"*** Checking key values on " "both nodes...\n"<br>)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="4336"><td class="num" id="LN4336">4336</td><td class="line">                                              <span class='string_literal'><span class='macro'>"both nodes...\n"</span>)<span class='macro_popup'>clusterManagerLog(2,"*** Checking key values on " "both nodes...\n"<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4337"><td class="num" id="LN4337">4337</td><td class="line">                        list *diffs = listCreate();</td></tr>
<tr class="codeline" data-linenumber="4338"><td class="num" id="LN4338">4338</td><td class="line">                        success = clusterManagerCompareKeysValues(source,</td></tr>
<tr class="codeline" data-linenumber="4339"><td class="num" id="LN4339">4339</td><td class="line">                            target, reply, diffs);</td></tr>
<tr class="codeline" data-linenumber="4340"><td class="num" id="LN4340">4340</td><td class="line">                        <span class='keyword'>if</span> (!success) {</td></tr>
<tr class="codeline" data-linenumber="4341"><td class="num" id="LN4341">4341</td><td class="line">                            <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"*** Value check failed!\n"</span>)<span class='macro_popup'>clusterManagerLog(3,"*** Value check failed!\n")</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4342"><td class="num" id="LN4342">4342</td><td class="line">                            listRelease(diffs);</td></tr>
<tr class="codeline" data-linenumber="4343"><td class="num" id="LN4343">4343</td><td class="line">                            <span class='keyword'>goto</span> next;</td></tr>
<tr class="codeline" data-linenumber="4344"><td class="num" id="LN4344">4344</td><td class="line">                        }</td></tr>
<tr class="codeline" data-linenumber="4345"><td class="num" id="LN4345">4345</td><td class="line">                        <span class='keyword'>if</span> (<span class='macro'>listLength(diffs)<span class='macro_popup'>((diffs)-&gt;len)</span></span> &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="4346"><td class="num" id="LN4346">4346</td><td class="line">                            success = 0;</td></tr>
<tr class="codeline" data-linenumber="4347"><td class="num" id="LN4347">4347</td><td class="line">                            <span class='macro'>clusterManagerLogErr(<span class='macro_popup'>clusterManagerLog(3,"*** Found %d key(s) in both source node and "<br> "target node having different values.\n" "    Source node: %s:%d\n"<br> "    Target node: %s:%d\n" "    Keys(s):\n", ((diffs)-&gt;len<br>), source-&gt;ip, source-&gt;port, target-&gt;ip, target-&gt;<br>port)</span></span></td></tr>
<tr class="codeline" data-linenumber="4348"><td class="num" id="LN4348">4348</td><td class="line">                                <span class='string_literal'><span class='macro'>"*** Found %d key(s) in both source node and "<span class='macro_popup'>clusterManagerLog(3,"*** Found %d key(s) in both source node and "<br> "target node having different values.\n" "    Source node: %s:%d\n"<br> "    Target node: %s:%d\n" "    Keys(s):\n", ((diffs)-&gt;len<br>), source-&gt;ip, source-&gt;port, target-&gt;ip, target-&gt;<br>port)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="4349"><td class="num" id="LN4349">4349</td><td class="line">                                <span class='string_literal'><span class='macro'>"target node having different values.\n"<span class='macro_popup'>clusterManagerLog(3,"*** Found %d key(s) in both source node and "<br> "target node having different values.\n" "    Source node: %s:%d\n"<br> "    Target node: %s:%d\n" "    Keys(s):\n", ((diffs)-&gt;len<br>), source-&gt;ip, source-&gt;port, target-&gt;ip, target-&gt;<br>port)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="4350"><td class="num" id="LN4350">4350</td><td class="line">                                <span class='string_literal'><span class='macro'>"    Source node: %s:%d\n"<span class='macro_popup'>clusterManagerLog(3,"*** Found %d key(s) in both source node and "<br> "target node having different values.\n" "    Source node: %s:%d\n"<br> "    Target node: %s:%d\n" "    Keys(s):\n", ((diffs)-&gt;len<br>), source-&gt;ip, source-&gt;port, target-&gt;ip, target-&gt;<br>port)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="4351"><td class="num" id="LN4351">4351</td><td class="line">                                <span class='string_literal'><span class='macro'>"    Target node: %s:%d\n"<span class='macro_popup'>clusterManagerLog(3,"*** Found %d key(s) in both source node and "<br> "target node having different values.\n" "    Source node: %s:%d\n"<br> "    Target node: %s:%d\n" "    Keys(s):\n", ((diffs)-&gt;len<br>), source-&gt;ip, source-&gt;port, target-&gt;ip, target-&gt;<br>port)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="4352"><td class="num" id="LN4352">4352</td><td class="line">                                <span class='string_literal'><span class='macro'>"    Keys(s):\n"</span>,<span class='macro_popup'>clusterManagerLog(3,"*** Found %d key(s) in both source node and "<br> "target node having different values.\n" "    Source node: %s:%d\n"<br> "    Target node: %s:%d\n" "    Keys(s):\n", ((diffs)-&gt;len<br>), source-&gt;ip, source-&gt;port, target-&gt;ip, target-&gt;<br>port)</span></span></td></tr>
<tr class="codeline" data-linenumber="4353"><td class="num" id="LN4353">4353</td><td class="line">                                <span class='macro'>listLength(diffs),<span class='macro_popup'>clusterManagerLog(3,"*** Found %d key(s) in both source node and "<br> "target node having different values.\n" "    Source node: %s:%d\n"<br> "    Target node: %s:%d\n" "    Keys(s):\n", ((diffs)-&gt;len<br>), source-&gt;ip, source-&gt;port, target-&gt;ip, target-&gt;<br>port)</span></span></td></tr>
<tr class="codeline" data-linenumber="4354"><td class="num" id="LN4354">4354</td><td class="line">                                <span class='macro'>source-&gt;ip, source-&gt;port,<span class='macro_popup'>clusterManagerLog(3,"*** Found %d key(s) in both source node and "<br> "target node having different values.\n" "    Source node: %s:%d\n"<br> "    Target node: %s:%d\n" "    Keys(s):\n", ((diffs)-&gt;len<br>), source-&gt;ip, source-&gt;port, target-&gt;ip, target-&gt;<br>port)</span></span></td></tr>
<tr class="codeline" data-linenumber="4355"><td class="num" id="LN4355">4355</td><td class="line">                                <span class='macro'>target-&gt;ip, target-&gt;port)<span class='macro_popup'>clusterManagerLog(3,"*** Found %d key(s) in both source node and "<br> "target node having different values.\n" "    Source node: %s:%d\n"<br> "    Target node: %s:%d\n" "    Keys(s):\n", ((diffs)-&gt;len<br>), source-&gt;ip, source-&gt;port, target-&gt;ip, target-&gt;<br>port)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4356"><td class="num" id="LN4356">4356</td><td class="line">                            listIter dli;</td></tr>
<tr class="codeline" data-linenumber="4357"><td class="num" id="LN4357">4357</td><td class="line">                            listNode *dln;</td></tr>
<tr class="codeline" data-linenumber="4358"><td class="num" id="LN4358">4358</td><td class="line">                            listRewind(diffs, &amp;dli);</td></tr>
<tr class="codeline" data-linenumber="4359"><td class="num" id="LN4359">4359</td><td class="line">                            <span class='keyword'>while</span>((dln = listNext(&amp;dli)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4360"><td class="num" id="LN4360">4360</td><td class="line">                                <span class='keyword'>char</span> *k = dln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="4361"><td class="num" id="LN4361">4361</td><td class="line">                                <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"    - %s\n"</span>, k)<span class='macro_popup'>clusterManagerLog(3,"    - %s\n", k)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4362"><td class="num" id="LN4362">4362</td><td class="line">                            }</td></tr>
<tr class="codeline" data-linenumber="4363"><td class="num" id="LN4363">4363</td><td class="line">                            <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"Please fix the above key(s) "<span class='macro_popup'>clusterManagerLog(3,"Please fix the above key(s) " "manually and try again "<br> "or relaunch the command \n" "with --cluster-replace " "option to force key "<br> "overriding.\n")</span></span></span></td></tr>
<tr class="codeline" data-linenumber="4364"><td class="num" id="LN4364">4364</td><td class="line">                                                 <span class='string_literal'><span class='macro'>"manually and try again "<span class='macro_popup'>clusterManagerLog(3,"Please fix the above key(s) " "manually and try again "<br> "or relaunch the command \n" "with --cluster-replace " "option to force key "<br> "overriding.\n")</span></span></span></td></tr>
<tr class="codeline" data-linenumber="4365"><td class="num" id="LN4365">4365</td><td class="line">                                                 <span class='string_literal'><span class='macro'>"or relaunch the command \n"<span class='macro_popup'>clusterManagerLog(3,"Please fix the above key(s) " "manually and try again "<br> "or relaunch the command \n" "with --cluster-replace " "option to force key "<br> "overriding.\n")</span></span></span></td></tr>
<tr class="codeline" data-linenumber="4366"><td class="num" id="LN4366">4366</td><td class="line">                                                 <span class='string_literal'><span class='macro'>"with --cluster-replace "<span class='macro_popup'>clusterManagerLog(3,"Please fix the above key(s) " "manually and try again "<br> "or relaunch the command \n" "with --cluster-replace " "option to force key "<br> "overriding.\n")</span></span></span></td></tr>
<tr class="codeline" data-linenumber="4367"><td class="num" id="LN4367">4367</td><td class="line">                                                 <span class='string_literal'><span class='macro'>"option to force key "<span class='macro_popup'>clusterManagerLog(3,"Please fix the above key(s) " "manually and try again "<br> "or relaunch the command \n" "with --cluster-replace " "option to force key "<br> "overriding.\n")</span></span></span></td></tr>
<tr class="codeline" data-linenumber="4368"><td class="num" id="LN4368">4368</td><td class="line">                                                 <span class='string_literal'><span class='macro'>"overriding.\n"</span>)<span class='macro_popup'>clusterManagerLog(3,"Please fix the above key(s) " "manually and try again "<br> "or relaunch the command \n" "with --cluster-replace " "option to force key "<br> "overriding.\n")</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4369"><td class="num" id="LN4369">4369</td><td class="line">                            listRelease(diffs);</td></tr>
<tr class="codeline" data-linenumber="4370"><td class="num" id="LN4370">4370</td><td class="line">                            <span class='keyword'>goto</span> next;</td></tr>
<tr class="codeline" data-linenumber="4371"><td class="num" id="LN4371">4371</td><td class="line">                        }</td></tr>
<tr class="codeline" data-linenumber="4372"><td class="num" id="LN4372">4372</td><td class="line">                        listRelease(diffs);</td></tr>
<tr class="codeline" data-linenumber="4373"><td class="num" id="LN4373">4373</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="4374"><td class="num" id="LN4374">4374</td><td class="line">                    <span class='macro'>clusterManagerLogWarn(<span class='string_literal'>"*** Replacing target keys...\n"</span>)<span class='macro_popup'>clusterManagerLog(2,"*** Replacing target keys...\n")</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4375"><td class="num" id="LN4375">4375</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="4376"><td class="num" id="LN4376">4376</td><td class="line">                freeReplyObject(migrate_reply);</td></tr>
<tr class="codeline" data-linenumber="4377"><td class="num" id="LN4377">4377</td><td class="line">                migrate_reply = clusterManagerMigrateKeysInReply(source,</td></tr>
<tr class="codeline" data-linenumber="4378"><td class="num" id="LN4378">4378</td><td class="line">                                                                 target,</td></tr>
<tr class="codeline" data-linenumber="4379"><td class="num" id="LN4379">4379</td><td class="line">                                                                 reply,</td></tr>
<tr class="codeline" data-linenumber="4380"><td class="num" id="LN4380">4380</td><td class="line">                                                                 is_busy,</td></tr>
<tr class="codeline" data-linenumber="4381"><td class="num" id="LN4381">4381</td><td class="line">                                                                 timeout,</td></tr>
<tr class="codeline" data-linenumber="4382"><td class="num" id="LN4382">4382</td><td class="line">                                                                 <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4383"><td class="num" id="LN4383">4383</td><td class="line">                success = (migrate_reply != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="4384"><td class="num" id="LN4384">4384</td><td class="line">                           migrate_reply-&gt;type != <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4385"><td class="num" id="LN4385">4385</td><td class="line">            } <span class='keyword'>else</span> success = 0;</td></tr>
<tr class="codeline" data-linenumber="4386"><td class="num" id="LN4386">4386</td><td class="line">            <span class='keyword'>if</span> (!success) {</td></tr>
<tr class="codeline" data-linenumber="4387"><td class="num" id="LN4387">4387</td><td class="line">                <span class='keyword'>if</span> (migrate_reply != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4388"><td class="num" id="LN4388">4388</td><td class="line">                    <span class='keyword'>if</span> (err) {</td></tr>
<tr class="codeline" data-linenumber="4389"><td class="num" id="LN4389">4389</td><td class="line">                        *err = zmalloc((migrate_reply-&gt;len + 1) * <span class='keyword'>sizeof</span>(<span class='keyword'>char</span>));</td></tr>
<tr class="codeline" data-linenumber="4390"><td class="num" id="LN4390">4390</td><td class="line">                        strcpy(*err, migrate_reply-&gt;str);</td></tr>
<tr class="codeline" data-linenumber="4391"><td class="num" id="LN4391">4391</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="4392"><td class="num" id="LN4392">4392</td><td class="line">                    printf(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4393"><td class="num" id="LN4393">4393</td><td class="line">                    <span class='macro'>CLUSTER_MANAGER_PRINT_REPLY_ERROR(source,<span class='macro_popup'>clusterManagerLog(3,"Node %s:%d replied with error:\n%s\n", source<br>-&gt;ip, source-&gt;port, migrate_reply-&gt;str);</span></span></td></tr>
<tr class="codeline" data-linenumber="4394"><td class="num" id="LN4394">4394</td><td class="line">                                                      <span class='macro'>migrate_reply-&gt;str)<span class='macro_popup'>clusterManagerLog(3,"Node %s:%d replied with error:\n%s\n", source<br>-&gt;ip, source-&gt;port, migrate_reply-&gt;str);</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4395"><td class="num" id="LN4395">4395</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="4396"><td class="num" id="LN4396">4396</td><td class="line">                <span class='keyword'>goto</span> next;</td></tr>
<tr class="codeline" data-linenumber="4397"><td class="num" id="LN4397">4397</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="4398"><td class="num" id="LN4398">4398</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4399"><td class="num" id="LN4399">4399</td><td class="line">        <span class='keyword'>if</span> (verbose) {</td></tr>
<tr class="codeline" data-linenumber="4400"><td class="num" id="LN4400">4400</td><td class="line">            printf(<span class='string_literal'>"%s"</span>, dots);</td></tr>
<tr class="codeline" data-linenumber="4401"><td class="num" id="LN4401">4401</td><td class="line">            fflush(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4402"><td class="num" id="LN4402">4402</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4403"><td class="num" id="LN4403">4403</td><td class="line">next:</td></tr>
<tr class="codeline" data-linenumber="4404"><td class="num" id="LN4404">4404</td><td class="line">        <span class='keyword'>if</span> (reply != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="4405"><td class="num" id="LN4405">4405</td><td class="line">        <span class='keyword'>if</span> (migrate_reply != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) freeReplyObject(migrate_reply);</td></tr>
<tr class="codeline" data-linenumber="4406"><td class="num" id="LN4406">4406</td><td class="line">        <span class='keyword'>if</span> (dots) zfree(dots);</td></tr>
<tr class="codeline" data-linenumber="4407"><td class="num" id="LN4407">4407</td><td class="line">        <span class='keyword'>if</span> (!success) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4408"><td class="num" id="LN4408">4408</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4409"><td class="num" id="LN4409">4409</td><td class="line">    <span class='keyword'>return</span> success;</td></tr>
<tr class="codeline" data-linenumber="4410"><td class="num" id="LN4410">4410</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4411"><td class="num" id="LN4411">4411</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4412"><td class="num" id="LN4412">4412</td><td class="line"><span class='comment'>/* Move slots between source and target nodes using MIGRATE.</span></td></tr>
<tr class="codeline" data-linenumber="4413"><td class="num" id="LN4413">4413</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="4414"><td class="num" id="LN4414">4414</td><td class="line"> <span class='comment'>* Options:</span></td></tr>
<tr class="codeline" data-linenumber="4415"><td class="num" id="LN4415">4415</td><td class="line"> <span class='comment'>* CLUSTER_MANAGER_OPT_VERBOSE -- Print a dot for every moved key.</span></td></tr>
<tr class="codeline" data-linenumber="4416"><td class="num" id="LN4416">4416</td><td class="line"> <span class='comment'>* CLUSTER_MANAGER_OPT_COLD    -- Move keys without opening slots /</span></td></tr>
<tr class="codeline" data-linenumber="4417"><td class="num" id="LN4417">4417</td><td class="line"> <span class='comment'>*                                reconfiguring the nodes.</span></td></tr>
<tr class="codeline" data-linenumber="4418"><td class="num" id="LN4418">4418</td><td class="line"> <span class='comment'>* CLUSTER_MANAGER_OPT_UPDATE  -- Update node-&gt;slots for source/target nodes.</span></td></tr>
<tr class="codeline" data-linenumber="4419"><td class="num" id="LN4419">4419</td><td class="line"> <span class='comment'>* CLUSTER_MANAGER_OPT_QUIET   -- Don't print info messages.</span></td></tr>
<tr class="codeline" data-linenumber="4420"><td class="num" id="LN4420">4420</td><td class="line"><span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4421"><td class="num" id="LN4421">4421</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerMoveSlot(clusterManagerNode *source,</td></tr>
<tr class="codeline" data-linenumber="4422"><td class="num" id="LN4422">4422</td><td class="line">                                  clusterManagerNode *target,</td></tr>
<tr class="codeline" data-linenumber="4423"><td class="num" id="LN4423">4423</td><td class="line">                                  <span class='keyword'>int</span> slot, <span class='keyword'>int</span> opts,  <span class='keyword'>char</span>**err)</td></tr>
<tr class="codeline" data-linenumber="4424"><td class="num" id="LN4424">4424</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="4425"><td class="num" id="LN4425">4425</td><td class="line">    <span class='keyword'>if</span> (!(opts &amp; <span class='macro'>CLUSTER_MANAGER_OPT_QUIET<span class='macro_popup'>1 &lt;&lt; 6</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="4426"><td class="num" id="LN4426">4426</td><td class="line">        printf(<span class='string_literal'>"Moving slot %d from %s:%d to %s:%d: "</span>, slot, source-&gt;ip,</td></tr>
<tr class="codeline" data-linenumber="4427"><td class="num" id="LN4427">4427</td><td class="line">               source-&gt;port, target-&gt;ip, target-&gt;port);</td></tr>
<tr class="codeline" data-linenumber="4428"><td class="num" id="LN4428">4428</td><td class="line">        fflush(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4429"><td class="num" id="LN4429">4429</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4430"><td class="num" id="LN4430">4430</td><td class="line">    <span class='keyword'>if</span> (err != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) *err = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4431"><td class="num" id="LN4431">4431</td><td class="line">    <span class='keyword'>int</span> pipeline = config.cluster_manager_command.pipeline,</td></tr>
<tr class="codeline" data-linenumber="4432"><td class="num" id="LN4432">4432</td><td class="line">        timeout = config.cluster_manager_command.timeout,</td></tr>
<tr class="codeline" data-linenumber="4433"><td class="num" id="LN4433">4433</td><td class="line">        print_dots = (opts &amp; <span class='macro'>CLUSTER_MANAGER_OPT_VERBOSE<span class='macro_popup'>1 &lt;&lt; 7</span></span>),</td></tr>
<tr class="codeline" data-linenumber="4434"><td class="num" id="LN4434">4434</td><td class="line">        option_cold = (opts &amp; <span class='macro'>CLUSTER_MANAGER_OPT_COLD<span class='macro_popup'>1 &lt;&lt; 1</span></span>),</td></tr>
<tr class="codeline" data-linenumber="4435"><td class="num" id="LN4435">4435</td><td class="line">        success = 1;</td></tr>
<tr class="codeline" data-linenumber="4436"><td class="num" id="LN4436">4436</td><td class="line">    <span class='keyword'>if</span> (!option_cold) {</td></tr>
<tr class="codeline" data-linenumber="4437"><td class="num" id="LN4437">4437</td><td class="line">        success = clusterManagerSetSlot(target, source, slot,</td></tr>
<tr class="codeline" data-linenumber="4438"><td class="num" id="LN4438">4438</td><td class="line">                                        <span class='string_literal'>"importing"</span>, err);</td></tr>
<tr class="codeline" data-linenumber="4439"><td class="num" id="LN4439">4439</td><td class="line">        <span class='keyword'>if</span> (!success) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="4440"><td class="num" id="LN4440">4440</td><td class="line">        success = clusterManagerSetSlot(source, target, slot,</td></tr>
<tr class="codeline" data-linenumber="4441"><td class="num" id="LN4441">4441</td><td class="line">                                        <span class='string_literal'>"migrating"</span>, err);</td></tr>
<tr class="codeline" data-linenumber="4442"><td class="num" id="LN4442">4442</td><td class="line">        <span class='keyword'>if</span> (!success) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="4443"><td class="num" id="LN4443">4443</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4444"><td class="num" id="LN4444">4444</td><td class="line">    success = clusterManagerMigrateKeysInSlot(source, target, slot, timeout,</td></tr>
<tr class="codeline" data-linenumber="4445"><td class="num" id="LN4445">4445</td><td class="line">                                              pipeline, print_dots, err);</td></tr>
<tr class="codeline" data-linenumber="4446"><td class="num" id="LN4446">4446</td><td class="line">    <span class='keyword'>if</span> (!(opts &amp; <span class='macro'>CLUSTER_MANAGER_OPT_QUIET<span class='macro_popup'>1 &lt;&lt; 6</span></span>)) printf(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4447"><td class="num" id="LN4447">4447</td><td class="line">    <span class='keyword'>if</span> (!success) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="4448"><td class="num" id="LN4448">4448</td><td class="line">    <span class='keyword'>if</span> (!option_cold) {</td></tr>
<tr class="codeline" data-linenumber="4449"><td class="num" id="LN4449">4449</td><td class="line">        <span class='comment'>/* Set the new node as the owner of the slot in all the known nodes.</span></td></tr>
<tr class="codeline" data-linenumber="4450"><td class="num" id="LN4450">4450</td><td class="line">         <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="4451"><td class="num" id="LN4451">4451</td><td class="line">         <span class='comment'>* We inform the target node first. It will propagate the information to</span></td></tr>
<tr class="codeline" data-linenumber="4452"><td class="num" id="LN4452">4452</td><td class="line">         <span class='comment'>* the rest of the cluster.</span></td></tr>
<tr class="codeline" data-linenumber="4453"><td class="num" id="LN4453">4453</td><td class="line">         <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="4454"><td class="num" id="LN4454">4454</td><td class="line">         <span class='comment'>* If we inform any other node first, it can happen that the target node</span></td></tr>
<tr class="codeline" data-linenumber="4455"><td class="num" id="LN4455">4455</td><td class="line">         <span class='comment'>* crashes before it is set as the new owner and then the slot is left</span></td></tr>
<tr class="codeline" data-linenumber="4456"><td class="num" id="LN4456">4456</td><td class="line">         <span class='comment'>* without an owner which results in redirect loops. See issue #7116. */</span></td></tr>
<tr class="codeline" data-linenumber="4457"><td class="num" id="LN4457">4457</td><td class="line">        success = clusterManagerSetSlot(target, target, slot, <span class='string_literal'>"node"</span>, err);</td></tr>
<tr class="codeline" data-linenumber="4458"><td class="num" id="LN4458">4458</td><td class="line">        <span class='keyword'>if</span> (!success) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="4459"><td class="num" id="LN4459">4459</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4460"><td class="num" id="LN4460">4460</td><td class="line">        <span class='comment'>/* Inform the source node. If the source node has just lost its last</span></td></tr>
<tr class="codeline" data-linenumber="4461"><td class="num" id="LN4461">4461</td><td class="line">         <span class='comment'>* slot and the target node has already informed the source node, the</span></td></tr>
<tr class="codeline" data-linenumber="4462"><td class="num" id="LN4462">4462</td><td class="line">         <span class='comment'>* source node has turned itself into a replica. This is not an error in</span></td></tr>
<tr class="codeline" data-linenumber="4463"><td class="num" id="LN4463">4463</td><td class="line">         <span class='comment'>* this scenario so we ignore it. See issue #9223. */</span></td></tr>
<tr class="codeline" data-linenumber="4464"><td class="num" id="LN4464">4464</td><td class="line">        success = clusterManagerSetSlot(source, target, slot, <span class='string_literal'>"node"</span>, err);</td></tr>
<tr class="codeline" data-linenumber="4465"><td class="num" id="LN4465">4465</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>char</span> *acceptable = <span class='string_literal'>"ERR Please use SETSLOT only with masters."</span>;</td></tr>
<tr class="codeline" data-linenumber="4466"><td class="num" id="LN4466">4466</td><td class="line">        <span class='keyword'>if</span> (!success &amp;&amp; err &amp;&amp; !strncmp(*err, acceptable, strlen(acceptable))) {</td></tr>
<tr class="codeline" data-linenumber="4467"><td class="num" id="LN4467">4467</td><td class="line">            zfree(*err);</td></tr>
<tr class="codeline" data-linenumber="4468"><td class="num" id="LN4468">4468</td><td class="line">            *err = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4469"><td class="num" id="LN4469">4469</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!success &amp;&amp; err) {</td></tr>
<tr class="codeline" data-linenumber="4470"><td class="num" id="LN4470">4470</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="4471"><td class="num" id="LN4471">4471</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4472"><td class="num" id="LN4472">4472</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4473"><td class="num" id="LN4473">4473</td><td class="line">        <span class='comment'>/* We also inform the other nodes to avoid redirects in case the target</span></td></tr>
<tr class="codeline" data-linenumber="4474"><td class="num" id="LN4474">4474</td><td class="line">         <span class='comment'>* node is slow to propagate the change to the entire cluster. */</span></td></tr>
<tr class="codeline" data-linenumber="4475"><td class="num" id="LN4475">4475</td><td class="line">        listIter li;</td></tr>
<tr class="codeline" data-linenumber="4476"><td class="num" id="LN4476">4476</td><td class="line">        listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="4477"><td class="num" id="LN4477">4477</td><td class="line">        listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="4478"><td class="num" id="LN4478">4478</td><td class="line">        <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4479"><td class="num" id="LN4479">4479</td><td class="line">            clusterManagerNode *n = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="4480"><td class="num" id="LN4480">4480</td><td class="line">            <span class='keyword'>if</span> (n == target || n == source) <span class='keyword'>continue</span>; <span class='comment'>/* already done */</span></td></tr>
<tr class="codeline" data-linenumber="4481"><td class="num" id="LN4481">4481</td><td class="line">            <span class='keyword'>if</span> (n-&gt;flags &amp; <span class='macro'>CLUSTER_MANAGER_FLAG_SLAVE<span class='macro_popup'>1 &lt;&lt; 1</span></span>) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="4482"><td class="num" id="LN4482">4482</td><td class="line">            success = clusterManagerSetSlot(n, target, slot, <span class='string_literal'>"node"</span>, err);</td></tr>
<tr class="codeline" data-linenumber="4483"><td class="num" id="LN4483">4483</td><td class="line">            <span class='keyword'>if</span> (!success) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="4484"><td class="num" id="LN4484">4484</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4485"><td class="num" id="LN4485">4485</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4486"><td class="num" id="LN4486">4486</td><td class="line">    <span class='comment'>/* Update the node logical config */</span></td></tr>
<tr class="codeline" data-linenumber="4487"><td class="num" id="LN4487">4487</td><td class="line">    <span class='keyword'>if</span> (opts &amp; <span class='macro'>CLUSTER_MANAGER_OPT_UPDATE<span class='macro_popup'>1 &lt;&lt; 2</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4488"><td class="num" id="LN4488">4488</td><td class="line">        source-&gt;slots[slot] = 0;</td></tr>
<tr class="codeline" data-linenumber="4489"><td class="num" id="LN4489">4489</td><td class="line">        target-&gt;slots[slot] = 1;</td></tr>
<tr class="codeline" data-linenumber="4490"><td class="num" id="LN4490">4490</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4491"><td class="num" id="LN4491">4491</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="4492"><td class="num" id="LN4492">4492</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4493"><td class="num" id="LN4493">4493</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4494"><td class="num" id="LN4494">4494</td><td class="line"><span class='comment'>/* Flush the dirty node configuration by calling replicate for slaves or</span></td></tr>
<tr class="codeline" data-linenumber="4495"><td class="num" id="LN4495">4495</td><td class="line"> <span class='comment'>* adding the slots defined in the masters. */</span></td></tr>
<tr class="codeline" data-linenumber="4496"><td class="num" id="LN4496">4496</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerFlushNodeConfig(clusterManagerNode *node, <span class='keyword'>char</span> **err) {</td></tr>
<tr class="codeline" data-linenumber="4497"><td class="num" id="LN4497">4497</td><td class="line">    <span class='keyword'>if</span> (!node-&gt;dirty) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="4498"><td class="num" id="LN4498">4498</td><td class="line">    redisReply *reply = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4499"><td class="num" id="LN4499">4499</td><td class="line">    <span class='keyword'>int</span> is_err = 0, success = 1;</td></tr>
<tr class="codeline" data-linenumber="4500"><td class="num" id="LN4500">4500</td><td class="line">    <span class='keyword'>if</span> (err != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) *err = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4501"><td class="num" id="LN4501">4501</td><td class="line">    <span class='keyword'>if</span> (node-&gt;replicate != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4502"><td class="num" id="LN4502">4502</td><td class="line">        reply = <span class='macro'>CLUSTER_MANAGER_COMMAND(node, <span class='string_literal'>"CLUSTER REPLICATE %s"</span>,<span class='macro_popup'>(redisCommand(node-&gt;context, "CLUSTER REPLICATE %s", node-&gt;<br>replicate))</span></span></td></tr>
<tr class="codeline" data-linenumber="4503"><td class="num" id="LN4503">4503</td><td class="line">                                        <span class='macro'>node-&gt;replicate)<span class='macro_popup'>(redisCommand(node-&gt;context, "CLUSTER REPLICATE %s", node-&gt;<br>replicate))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4504"><td class="num" id="LN4504">4504</td><td class="line">        <span class='keyword'>if</span> (reply == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> || (is_err = (reply-&gt;type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>))) {</td></tr>
<tr class="codeline" data-linenumber="4505"><td class="num" id="LN4505">4505</td><td class="line">            <span class='keyword'>if</span> (is_err &amp;&amp; err != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4506"><td class="num" id="LN4506">4506</td><td class="line">                *err = zmalloc((reply-&gt;len + 1) * <span class='keyword'>sizeof</span>(<span class='keyword'>char</span>));</td></tr>
<tr class="codeline" data-linenumber="4507"><td class="num" id="LN4507">4507</td><td class="line">                strcpy(*err, reply-&gt;str);</td></tr>
<tr class="codeline" data-linenumber="4508"><td class="num" id="LN4508">4508</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="4509"><td class="num" id="LN4509">4509</td><td class="line">            success = 0;</td></tr>
<tr class="codeline" data-linenumber="4510"><td class="num" id="LN4510">4510</td><td class="line">            <span class='comment'>/* If the cluster did not already joined it is possible that</span></td></tr>
<tr class="codeline" data-linenumber="4511"><td class="num" id="LN4511">4511</td><td class="line">             <span class='comment'>* the slave does not know the master node yet. So on errors</span></td></tr>
<tr class="codeline" data-linenumber="4512"><td class="num" id="LN4512">4512</td><td class="line">             <span class='comment'>* we return ASAP leaving the dirty flag set, to flush the</span></td></tr>
<tr class="codeline" data-linenumber="4513"><td class="num" id="LN4513">4513</td><td class="line">             <span class='comment'>* config later. */</span></td></tr>
<tr class="codeline" data-linenumber="4514"><td class="num" id="LN4514">4514</td><td class="line">            <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="4515"><td class="num" id="LN4515">4515</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4516"><td class="num" id="LN4516">4516</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="4517"><td class="num" id="LN4517">4517</td><td class="line">        <span class='keyword'>int</span> added = clusterManagerAddSlots(node, err);</td></tr>
<tr class="codeline" data-linenumber="4518"><td class="num" id="LN4518">4518</td><td class="line">        <span class='keyword'>if</span> (!added || *err != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) success = 0;</td></tr>
<tr class="codeline" data-linenumber="4519"><td class="num" id="LN4519">4519</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4520"><td class="num" id="LN4520">4520</td><td class="line">    node-&gt;dirty = 0;</td></tr>
<tr class="codeline" data-linenumber="4521"><td class="num" id="LN4521">4521</td><td class="line">cleanup:</td></tr>
<tr class="codeline" data-linenumber="4522"><td class="num" id="LN4522">4522</td><td class="line">    <span class='keyword'>if</span> (reply != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="4523"><td class="num" id="LN4523">4523</td><td class="line">    <span class='keyword'>return</span> success;</td></tr>
<tr class="codeline" data-linenumber="4524"><td class="num" id="LN4524">4524</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4525"><td class="num" id="LN4525">4525</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4526"><td class="num" id="LN4526">4526</td><td class="line"><span class='comment'>/* Wait until the cluster configuration is consistent. */</span></td></tr>
<tr class="codeline" data-linenumber="4527"><td class="num" id="LN4527">4527</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> clusterManagerWaitForClusterJoin(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="4528"><td class="num" id="LN4528">4528</td><td class="line">    printf(<span class='string_literal'>"Waiting for the cluster to join\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4529"><td class="num" id="LN4529">4529</td><td class="line">    <span class='keyword'>int</span> counter = 0,</td></tr>
<tr class="codeline" data-linenumber="4530"><td class="num" id="LN4530">4530</td><td class="line">        check_after = <span class='macro'>CLUSTER_JOIN_CHECK_AFTER<span class='macro_popup'>20</span></span> +</td></tr>
<tr class="codeline" data-linenumber="4531"><td class="num" id="LN4531">4531</td><td class="line">                      (<span class='keyword'>int</span>)(<span class='macro'>listLength(cluster_manager.nodes)<span class='macro_popup'>((cluster_manager.nodes)-&gt;len)</span></span> * 0.15f);</td></tr>
<tr class="codeline" data-linenumber="4532"><td class="num" id="LN4532">4532</td><td class="line">    <span class='keyword'>while</span>(!clusterManagerIsConfigConsistent()) {</td></tr>
<tr class="codeline" data-linenumber="4533"><td class="num" id="LN4533">4533</td><td class="line">        printf(<span class='string_literal'>"."</span>);</td></tr>
<tr class="codeline" data-linenumber="4534"><td class="num" id="LN4534">4534</td><td class="line">        fflush(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4535"><td class="num" id="LN4535">4535</td><td class="line">        sleep(1);</td></tr>
<tr class="codeline" data-linenumber="4536"><td class="num" id="LN4536">4536</td><td class="line">        <span class='keyword'>if</span> (++counter &gt; check_after) {</td></tr>
<tr class="codeline" data-linenumber="4537"><td class="num" id="LN4537">4537</td><td class="line">            dict *status = clusterManagerGetLinkStatus();</td></tr>
<tr class="codeline" data-linenumber="4538"><td class="num" id="LN4538">4538</td><td class="line">            dictIterator *iter = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4539"><td class="num" id="LN4539">4539</td><td class="line">            <span class='keyword'>if</span> (status != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> &amp;&amp; <span class='macro'>dictSize(status)<span class='macro_popup'>((status)-&gt;ht_used[0]+(status)-&gt;ht_used[1])</span></span> &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="4540"><td class="num" id="LN4540">4540</td><td class="line">                printf(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4541"><td class="num" id="LN4541">4541</td><td class="line">                <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"Warning: %d node(s) may "<span class='macro_popup'>clusterManagerLog(3,"Warning: %d node(s) may " "be unreachable\n"<br>, ((status)-&gt;ht_used[0]+(status)-&gt;ht_used[1]))</span></span></span></td></tr>
<tr class="codeline" data-linenumber="4542"><td class="num" id="LN4542">4542</td><td class="line">                                     <span class='string_literal'><span class='macro'>"be unreachable\n"</span>, dictSize(status))<span class='macro_popup'>clusterManagerLog(3,"Warning: %d node(s) may " "be unreachable\n"<br>, ((status)-&gt;ht_used[0]+(status)-&gt;ht_used[1]))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4543"><td class="num" id="LN4543">4543</td><td class="line">                iter = dictGetIterator(status);</td></tr>
<tr class="codeline" data-linenumber="4544"><td class="num" id="LN4544">4544</td><td class="line">                dictEntry *entry;</td></tr>
<tr class="codeline" data-linenumber="4545"><td class="num" id="LN4545">4545</td><td class="line">                <span class='keyword'>while</span> ((entry = dictNext(iter)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4546"><td class="num" id="LN4546">4546</td><td class="line">                    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> nodeaddr = (<span class='macro'>sds<span class='macro_popup'>hisds</span></span>) <span class='macro'>dictGetKey(entry)<span class='macro_popup'>((entry)-&gt;key)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4547"><td class="num" id="LN4547">4547</td><td class="line">                    <span class='keyword'>char</span> *node_ip = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4548"><td class="num" id="LN4548">4548</td><td class="line">                    <span class='keyword'>int</span> node_port = 0, node_bus_port = 0;</td></tr>
<tr class="codeline" data-linenumber="4549"><td class="num" id="LN4549">4549</td><td class="line">                    list *from = (list *) <span class='macro'>dictGetVal(entry)<span class='macro_popup'>((entry)-&gt;v.val)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4550"><td class="num" id="LN4550">4550</td><td class="line">                    <span class='keyword'>if</span> (parseClusterNodeAddress(nodeaddr, &amp;node_ip,</td></tr>
<tr class="codeline" data-linenumber="4551"><td class="num" id="LN4551">4551</td><td class="line">                        &amp;node_port, &amp;node_bus_port) &amp;&amp; node_bus_port) {</td></tr>
<tr class="codeline" data-linenumber="4552"><td class="num" id="LN4552">4552</td><td class="line">                        <span class='macro'>clusterManagerLogErr(<span class='string_literal'>" - The port %d of node %s may "<span class='macro_popup'>clusterManagerLog(3," - The port %d of node %s may " "be unreachable from:\n"<br>, node_bus_port, node_ip)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="4553"><td class="num" id="LN4553">4553</td><td class="line">                                             <span class='string_literal'><span class='macro'>"be unreachable from:\n"</span>,<span class='macro_popup'>clusterManagerLog(3," - The port %d of node %s may " "be unreachable from:\n"<br>, node_bus_port, node_ip)</span></span></td></tr>
<tr class="codeline" data-linenumber="4554"><td class="num" id="LN4554">4554</td><td class="line">                                             <span class='macro'>node_bus_port, node_ip)<span class='macro_popup'>clusterManagerLog(3," - The port %d of node %s may " "be unreachable from:\n"<br>, node_bus_port, node_ip)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4555"><td class="num" id="LN4555">4555</td><td class="line">                    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="4556"><td class="num" id="LN4556">4556</td><td class="line">                        <span class='macro'>clusterManagerLogErr(<span class='string_literal'>" - Node %s may be unreachable "<span class='macro_popup'>clusterManagerLog(3," - Node %s may be unreachable " "from:\n"<br>, nodeaddr)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="4557"><td class="num" id="LN4557">4557</td><td class="line">                                             <span class='string_literal'><span class='macro'>"from:\n"</span>, nodeaddr)<span class='macro_popup'>clusterManagerLog(3," - Node %s may be unreachable " "from:\n"<br>, nodeaddr)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4558"><td class="num" id="LN4558">4558</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="4559"><td class="num" id="LN4559">4559</td><td class="line">                    listIter li;</td></tr>
<tr class="codeline" data-linenumber="4560"><td class="num" id="LN4560">4560</td><td class="line">                    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="4561"><td class="num" id="LN4561">4561</td><td class="line">                    listRewind(from, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="4562"><td class="num" id="LN4562">4562</td><td class="line">                    <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4563"><td class="num" id="LN4563">4563</td><td class="line">                        <span class='macro'>sds<span class='macro_popup'>hisds</span></span> from_addr = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="4564"><td class="num" id="LN4564">4564</td><td class="line">                        <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"   %s\n"</span>, from_addr)<span class='macro_popup'>clusterManagerLog(3,"   %s\n", from_addr)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4565"><td class="num" id="LN4565">4565</td><td class="line">                        <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(from_addr);</td></tr>
<tr class="codeline" data-linenumber="4566"><td class="num" id="LN4566">4566</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="4567"><td class="num" id="LN4567">4567</td><td class="line">                    <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"Cluster bus ports must be reachable "<span class='macro_popup'>clusterManagerLog(3,"Cluster bus ports must be reachable " "by every node.\nRemember that "<br> "cluster bus ports are different " "from standard instance ports.\n"<br>)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="4568"><td class="num" id="LN4568">4568</td><td class="line">                                         <span class='string_literal'><span class='macro'>"by every node.\nRemember that "<span class='macro_popup'>clusterManagerLog(3,"Cluster bus ports must be reachable " "by every node.\nRemember that "<br> "cluster bus ports are different " "from standard instance ports.\n"<br>)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="4569"><td class="num" id="LN4569">4569</td><td class="line">                                         <span class='string_literal'><span class='macro'>"cluster bus ports are different "<span class='macro_popup'>clusterManagerLog(3,"Cluster bus ports must be reachable " "by every node.\nRemember that "<br> "cluster bus ports are different " "from standard instance ports.\n"<br>)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="4570"><td class="num" id="LN4570">4570</td><td class="line">                                         <span class='string_literal'><span class='macro'>"from standard instance ports.\n"</span>)<span class='macro_popup'>clusterManagerLog(3,"Cluster bus ports must be reachable " "by every node.\nRemember that "<br> "cluster bus ports are different " "from standard instance ports.\n"<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4571"><td class="num" id="LN4571">4571</td><td class="line">                    listEmpty(from);</td></tr>
<tr class="codeline" data-linenumber="4572"><td class="num" id="LN4572">4572</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="4573"><td class="num" id="LN4573">4573</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="4574"><td class="num" id="LN4574">4574</td><td class="line">            <span class='keyword'>if</span> (iter != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) dictReleaseIterator(iter);</td></tr>
<tr class="codeline" data-linenumber="4575"><td class="num" id="LN4575">4575</td><td class="line">            <span class='keyword'>if</span> (status != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) dictRelease(status);</td></tr>
<tr class="codeline" data-linenumber="4576"><td class="num" id="LN4576">4576</td><td class="line">            counter = 0;</td></tr>
<tr class="codeline" data-linenumber="4577"><td class="num" id="LN4577">4577</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4578"><td class="num" id="LN4578">4578</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4579"><td class="num" id="LN4579">4579</td><td class="line">    printf(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4580"><td class="num" id="LN4580">4580</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4581"><td class="num" id="LN4581">4581</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4582"><td class="num" id="LN4582">4582</td><td class="line"><span class='comment'>/* Load node's cluster configuration by calling "CLUSTER NODES" command.</span></td></tr>
<tr class="codeline" data-linenumber="4583"><td class="num" id="LN4583">4583</td><td class="line"> <span class='comment'>* Node's configuration (name, replicate, slots, ...) is then updated.</span></td></tr>
<tr class="codeline" data-linenumber="4584"><td class="num" id="LN4584">4584</td><td class="line"> <span class='comment'>* If CLUSTER_MANAGER_OPT_GETFRIENDS flag is set into 'opts' argument,</span></td></tr>
<tr class="codeline" data-linenumber="4585"><td class="num" id="LN4585">4585</td><td class="line"> <span class='comment'>* and node already knows other nodes, the node's friends list is populated</span></td></tr>
<tr class="codeline" data-linenumber="4586"><td class="num" id="LN4586">4586</td><td class="line"> <span class='comment'>* with the other nodes info. */</span></td></tr>
<tr class="codeline" data-linenumber="4587"><td class="num" id="LN4587">4587</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerNodeLoadInfo(clusterManagerNode *node, <span class='keyword'>int</span> opts,</td></tr>
<tr class="codeline" data-linenumber="4588"><td class="num" id="LN4588">4588</td><td class="line">                                      <span class='keyword'>char</span> **err)</td></tr>
<tr class="codeline" data-linenumber="4589"><td class="num" id="LN4589">4589</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="4590"><td class="num" id="LN4590">4590</td><td class="line">    redisReply *reply = <span class='macro'>CLUSTER_MANAGER_COMMAND(node, <span class='string_literal'>"CLUSTER NODES"</span>)<span class='macro_popup'>(redisCommand(node-&gt;context, "CLUSTER NODES"))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4591"><td class="num" id="LN4591">4591</td><td class="line">    <span class='keyword'>int</span> success = 1;</td></tr>
<tr class="codeline" data-linenumber="4592"><td class="num" id="LN4592">4592</td><td class="line">    *err = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4593"><td class="num" id="LN4593">4593</td><td class="line">    <span class='keyword'>if</span> (!clusterManagerCheckRedisReply(node, reply, err)) {</td></tr>
<tr class="codeline" data-linenumber="4594"><td class="num" id="LN4594">4594</td><td class="line">        success = 0;</td></tr>
<tr class="codeline" data-linenumber="4595"><td class="num" id="LN4595">4595</td><td class="line">        <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="4596"><td class="num" id="LN4596">4596</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4597"><td class="num" id="LN4597">4597</td><td class="line">    <span class='keyword'>int</span> getfriends = (opts &amp; <span class='macro'>CLUSTER_MANAGER_OPT_GETFRIENDS<span class='macro_popup'>1 &lt;&lt; 0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4598"><td class="num" id="LN4598">4598</td><td class="line">    <span class='keyword'>char</span> *lines = reply-&gt;str, *p, *line;</td></tr>
<tr class="codeline" data-linenumber="4599"><td class="num" id="LN4599">4599</td><td class="line">    <span class='keyword'>while</span> ((p = strstr(lines, <span class='string_literal'>"\n"</span>)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4600"><td class="num" id="LN4600">4600</td><td class="line">        *p = '\0';</td></tr>
<tr class="codeline" data-linenumber="4601"><td class="num" id="LN4601">4601</td><td class="line">        line = lines;</td></tr>
<tr class="codeline" data-linenumber="4602"><td class="num" id="LN4602">4602</td><td class="line">        lines = p + 1;</td></tr>
<tr class="codeline" data-linenumber="4603"><td class="num" id="LN4603">4603</td><td class="line">        <span class='keyword'>char</span> *name = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, *addr = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, *flags = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, *master_id = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="4604"><td class="num" id="LN4604">4604</td><td class="line">             *ping_sent = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, *ping_recv = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, *config_epoch = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="4605"><td class="num" id="LN4605">4605</td><td class="line">             *link_status = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4606"><td class="num" id="LN4606">4606</td><td class="line">        <span class='macro'>UNUSED(link_status)<span class='macro_popup'>((void) link_status)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4607"><td class="num" id="LN4607">4607</td><td class="line">        <span class='keyword'>int</span> i = 0;</td></tr>
<tr class="codeline" data-linenumber="4608"><td class="num" id="LN4608">4608</td><td class="line">        <span class='keyword'>while</span> ((p = strchr(line, ' ')) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4609"><td class="num" id="LN4609">4609</td><td class="line">            *p = '\0';</td></tr>
<tr class="codeline" data-linenumber="4610"><td class="num" id="LN4610">4610</td><td class="line">            <span class='keyword'>char</span> *token = line;</td></tr>
<tr class="codeline" data-linenumber="4611"><td class="num" id="LN4611">4611</td><td class="line">            line = p + 1;</td></tr>
<tr class="codeline" data-linenumber="4612"><td class="num" id="LN4612">4612</td><td class="line">            <span class='keyword'>switch</span>(i++){</td></tr>
<tr class="codeline" data-linenumber="4613"><td class="num" id="LN4613">4613</td><td class="line">            <span class='keyword'>case</span> 0: name = token; <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4614"><td class="num" id="LN4614">4614</td><td class="line">            <span class='keyword'>case</span> 1: addr = token; <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4615"><td class="num" id="LN4615">4615</td><td class="line">            <span class='keyword'>case</span> 2: flags = token; <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4616"><td class="num" id="LN4616">4616</td><td class="line">            <span class='keyword'>case</span> 3: master_id = token; <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4617"><td class="num" id="LN4617">4617</td><td class="line">            <span class='keyword'>case</span> 4: ping_sent = token; <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4618"><td class="num" id="LN4618">4618</td><td class="line">            <span class='keyword'>case</span> 5: ping_recv = token; <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4619"><td class="num" id="LN4619">4619</td><td class="line">            <span class='keyword'>case</span> 6: config_epoch = token; <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4620"><td class="num" id="LN4620">4620</td><td class="line">            <span class='keyword'>case</span> 7: link_status = token; <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4621"><td class="num" id="LN4621">4621</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="4622"><td class="num" id="LN4622">4622</td><td class="line">            <span class='keyword'>if</span> (i == 8) <span class='keyword'>break</span>; <span class='comment'>// Slots</span></td></tr>
<tr class="codeline" data-linenumber="4623"><td class="num" id="LN4623">4623</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4624"><td class="num" id="LN4624">4624</td><td class="line">        <span class='keyword'>if</span> (!flags) {</td></tr>
<tr class="codeline" data-linenumber="4625"><td class="num" id="LN4625">4625</td><td class="line">            success = 0;</td></tr>
<tr class="codeline" data-linenumber="4626"><td class="num" id="LN4626">4626</td><td class="line">            <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="4627"><td class="num" id="LN4627">4627</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4628"><td class="num" id="LN4628">4628</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4629"><td class="num" id="LN4629">4629</td><td class="line">        <span class='keyword'>char</span> *ip = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4630"><td class="num" id="LN4630">4630</td><td class="line">        <span class='keyword'>int</span> port = 0, bus_port = 0;</td></tr>
<tr class="codeline" data-linenumber="4631"><td class="num" id="LN4631">4631</td><td class="line">        <span class='keyword'>if</span> (addr == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> || !parseClusterNodeAddress(addr, &amp;ip, &amp;port, &amp;bus_port)) {</td></tr>
<tr class="codeline" data-linenumber="4632"><td class="num" id="LN4632">4632</td><td class="line">            fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Error: invalid CLUSTER NODES reply\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4633"><td class="num" id="LN4633">4633</td><td class="line">            success = 0;</td></tr>
<tr class="codeline" data-linenumber="4634"><td class="num" id="LN4634">4634</td><td class="line">            <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="4635"><td class="num" id="LN4635">4635</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4636"><td class="num" id="LN4636">4636</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4637"><td class="num" id="LN4637">4637</td><td class="line">        <span class='keyword'>int</span> myself = (strstr(flags, <span class='string_literal'>"myself"</span>) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4638"><td class="num" id="LN4638">4638</td><td class="line">        clusterManagerNode *currentNode = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4639"><td class="num" id="LN4639">4639</td><td class="line">        <span class='keyword'>if</span> (myself) {</td></tr>
<tr class="codeline" data-linenumber="4640"><td class="num" id="LN4640">4640</td><td class="line">            <span class='comment'>/* bus-port could be wrong, correct it here, see clusterManagerNewNode. */</span></td></tr>
<tr class="codeline" data-linenumber="4641"><td class="num" id="LN4641">4641</td><td class="line">            node-&gt;bus_port = bus_port;</td></tr>
<tr class="codeline" data-linenumber="4642"><td class="num" id="LN4642">4642</td><td class="line">            node-&gt;flags |= <span class='macro'>CLUSTER_MANAGER_FLAG_MYSELF<span class='macro_popup'>1 &lt;&lt; 0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4643"><td class="num" id="LN4643">4643</td><td class="line">            currentNode = node;</td></tr>
<tr class="codeline" data-linenumber="4644"><td class="num" id="LN4644">4644</td><td class="line">            clusterManagerNodeResetSlots(node);</td></tr>
<tr class="codeline" data-linenumber="4645"><td class="num" id="LN4645">4645</td><td class="line">            <span class='keyword'>if</span> (i == 8) {</td></tr>
<tr class="codeline" data-linenumber="4646"><td class="num" id="LN4646">4646</td><td class="line">                <span class='keyword'>int</span> remaining = strlen(line);</td></tr>
<tr class="codeline" data-linenumber="4647"><td class="num" id="LN4647">4647</td><td class="line">                <span class='keyword'>while</span> (remaining &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="4648"><td class="num" id="LN4648">4648</td><td class="line">                    p = strchr(line, ' ');</td></tr>
<tr class="codeline" data-linenumber="4649"><td class="num" id="LN4649">4649</td><td class="line">                    <span class='keyword'>if</span> (p == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) p = line + remaining;</td></tr>
<tr class="codeline" data-linenumber="4650"><td class="num" id="LN4650">4650</td><td class="line">                    remaining -= (p - line);</td></tr>
<tr class="codeline" data-linenumber="4651"><td class="num" id="LN4651">4651</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4652"><td class="num" id="LN4652">4652</td><td class="line">                    <span class='keyword'>char</span> *slotsdef = line;</td></tr>
<tr class="codeline" data-linenumber="4653"><td class="num" id="LN4653">4653</td><td class="line">                    *p = '\0';</td></tr>
<tr class="codeline" data-linenumber="4654"><td class="num" id="LN4654">4654</td><td class="line">                    <span class='keyword'>if</span> (remaining) {</td></tr>
<tr class="codeline" data-linenumber="4655"><td class="num" id="LN4655">4655</td><td class="line">                        line = p + 1;</td></tr>
<tr class="codeline" data-linenumber="4656"><td class="num" id="LN4656">4656</td><td class="line">                        remaining--;</td></tr>
<tr class="codeline" data-linenumber="4657"><td class="num" id="LN4657">4657</td><td class="line">                    } <span class='keyword'>else</span> line = p;</td></tr>
<tr class="codeline" data-linenumber="4658"><td class="num" id="LN4658">4658</td><td class="line">                    <span class='keyword'>char</span> *dash = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4659"><td class="num" id="LN4659">4659</td><td class="line">                    <span class='keyword'>if</span> (slotsdef[0] == '[') {</td></tr>
<tr class="codeline" data-linenumber="4660"><td class="num" id="LN4660">4660</td><td class="line">                        slotsdef++;</td></tr>
<tr class="codeline" data-linenumber="4661"><td class="num" id="LN4661">4661</td><td class="line">                        <span class='keyword'>if</span> ((p = strstr(slotsdef, <span class='string_literal'>"-&gt;-"</span>))) { <span class='comment'>// Migrating</span></td></tr>
<tr class="codeline" data-linenumber="4662"><td class="num" id="LN4662">4662</td><td class="line">                            *p = '\0';</td></tr>
<tr class="codeline" data-linenumber="4663"><td class="num" id="LN4663">4663</td><td class="line">                            p += 3;</td></tr>
<tr class="codeline" data-linenumber="4664"><td class="num" id="LN4664">4664</td><td class="line">                            <span class='keyword'>char</span> *closing_bracket = strchr(p, ']');</td></tr>
<tr class="codeline" data-linenumber="4665"><td class="num" id="LN4665">4665</td><td class="line">                            <span class='keyword'>if</span> (closing_bracket) *closing_bracket = '\0';</td></tr>
<tr class="codeline" data-linenumber="4666"><td class="num" id="LN4666">4666</td><td class="line">                            <span class='macro'>sds<span class='macro_popup'>hisds</span></span> slot = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(slotsdef);</td></tr>
<tr class="codeline" data-linenumber="4667"><td class="num" id="LN4667">4667</td><td class="line">                            <span class='macro'>sds<span class='macro_popup'>hisds</span></span> dst = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(p);</td></tr>
<tr class="codeline" data-linenumber="4668"><td class="num" id="LN4668">4668</td><td class="line">                            node-&gt;migrating_count += 2;</td></tr>
<tr class="codeline" data-linenumber="4669"><td class="num" id="LN4669">4669</td><td class="line">                            node-&gt;migrating = zrealloc(node-&gt;migrating,</td></tr>
<tr class="codeline" data-linenumber="4670"><td class="num" id="LN4670">4670</td><td class="line">                                (node-&gt;migrating_count * <span class='keyword'>sizeof</span>(<span class='macro'>sds<span class='macro_popup'>hisds</span></span>)));</td></tr>
<tr class="codeline" data-linenumber="4671"><td class="num" id="LN4671">4671</td><td class="line">                            node-&gt;migrating[node-&gt;migrating_count - 2] =</td></tr>
<tr class="codeline" data-linenumber="4672"><td class="num" id="LN4672">4672</td><td class="line">                                slot;</td></tr>
<tr class="codeline" data-linenumber="4673"><td class="num" id="LN4673">4673</td><td class="line">                            node-&gt;migrating[node-&gt;migrating_count - 1] =</td></tr>
<tr class="codeline" data-linenumber="4674"><td class="num" id="LN4674">4674</td><td class="line">                                dst;</td></tr>
<tr class="codeline" data-linenumber="4675"><td class="num" id="LN4675">4675</td><td class="line">                        }  <span class='keyword'>else</span> <span class='keyword'>if</span> ((p = strstr(slotsdef, <span class='string_literal'>"-&lt;-"</span>))) {<span class='comment'>//Importing</span></td></tr>
<tr class="codeline" data-linenumber="4676"><td class="num" id="LN4676">4676</td><td class="line">                            *p = '\0';</td></tr>
<tr class="codeline" data-linenumber="4677"><td class="num" id="LN4677">4677</td><td class="line">                            p += 3;</td></tr>
<tr class="codeline" data-linenumber="4678"><td class="num" id="LN4678">4678</td><td class="line">                            <span class='keyword'>char</span> *closing_bracket = strchr(p, ']');</td></tr>
<tr class="codeline" data-linenumber="4679"><td class="num" id="LN4679">4679</td><td class="line">                            <span class='keyword'>if</span> (closing_bracket) *closing_bracket = '\0';</td></tr>
<tr class="codeline" data-linenumber="4680"><td class="num" id="LN4680">4680</td><td class="line">                            <span class='macro'>sds<span class='macro_popup'>hisds</span></span> slot = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(slotsdef);</td></tr>
<tr class="codeline" data-linenumber="4681"><td class="num" id="LN4681">4681</td><td class="line">                            <span class='macro'>sds<span class='macro_popup'>hisds</span></span> src = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(p);</td></tr>
<tr class="codeline" data-linenumber="4682"><td class="num" id="LN4682">4682</td><td class="line">                            node-&gt;importing_count += 2;</td></tr>
<tr class="codeline" data-linenumber="4683"><td class="num" id="LN4683">4683</td><td class="line">                            node-&gt;importing = zrealloc(node-&gt;importing,</td></tr>
<tr class="codeline" data-linenumber="4684"><td class="num" id="LN4684">4684</td><td class="line">                                (node-&gt;importing_count * <span class='keyword'>sizeof</span>(<span class='macro'>sds<span class='macro_popup'>hisds</span></span>)));</td></tr>
<tr class="codeline" data-linenumber="4685"><td class="num" id="LN4685">4685</td><td class="line">                            node-&gt;importing[node-&gt;importing_count - 2] =</td></tr>
<tr class="codeline" data-linenumber="4686"><td class="num" id="LN4686">4686</td><td class="line">                                slot;</td></tr>
<tr class="codeline" data-linenumber="4687"><td class="num" id="LN4687">4687</td><td class="line">                            node-&gt;importing[node-&gt;importing_count - 1] =</td></tr>
<tr class="codeline" data-linenumber="4688"><td class="num" id="LN4688">4688</td><td class="line">                                src;</td></tr>
<tr class="codeline" data-linenumber="4689"><td class="num" id="LN4689">4689</td><td class="line">                        }</td></tr>
<tr class="codeline" data-linenumber="4690"><td class="num" id="LN4690">4690</td><td class="line">                    } <span class='keyword'>else</span> <span class='keyword'>if</span> ((dash = strchr(slotsdef, '-')) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4691"><td class="num" id="LN4691">4691</td><td class="line">                        p = dash;</td></tr>
<tr class="codeline" data-linenumber="4692"><td class="num" id="LN4692">4692</td><td class="line">                        <span class='keyword'>int</span> start, stop;</td></tr>
<tr class="codeline" data-linenumber="4693"><td class="num" id="LN4693">4693</td><td class="line">                        *p = '\0';</td></tr>
<tr class="codeline" data-linenumber="4694"><td class="num" id="LN4694">4694</td><td class="line">                        start = atoi(slotsdef);</td></tr>
<tr class="codeline" data-linenumber="4695"><td class="num" id="LN4695">4695</td><td class="line">                        stop = atoi(p + 1);</td></tr>
<tr class="codeline" data-linenumber="4696"><td class="num" id="LN4696">4696</td><td class="line">                        node-&gt;slots_count += (stop - (start - 1));</td></tr>
<tr class="codeline" data-linenumber="4697"><td class="num" id="LN4697">4697</td><td class="line">                        <span class='keyword'>while</span> (start &lt;= stop) node-&gt;slots[start++] = 1;</td></tr>
<tr class="codeline" data-linenumber="4698"><td class="num" id="LN4698">4698</td><td class="line">                    } <span class='keyword'>else</span> <span class='keyword'>if</span> (p &gt; slotsdef) {</td></tr>
<tr class="codeline" data-linenumber="4699"><td class="num" id="LN4699">4699</td><td class="line">                        node-&gt;slots[atoi(slotsdef)] = 1;</td></tr>
<tr class="codeline" data-linenumber="4700"><td class="num" id="LN4700">4700</td><td class="line">                        node-&gt;slots_count++;</td></tr>
<tr class="codeline" data-linenumber="4701"><td class="num" id="LN4701">4701</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="4702"><td class="num" id="LN4702">4702</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="4703"><td class="num" id="LN4703">4703</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="4704"><td class="num" id="LN4704">4704</td><td class="line">            node-&gt;dirty = 0;</td></tr>
<tr class="codeline" data-linenumber="4705"><td class="num" id="LN4705">4705</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!getfriends) {</td></tr>
<tr class="codeline" data-linenumber="4706"><td class="num" id="LN4706">4706</td><td class="line">            <span class='keyword'>if</span> (!(node-&gt;flags &amp; <span class='macro'>CLUSTER_MANAGER_FLAG_MYSELF<span class='macro_popup'>1 &lt;&lt; 0</span></span>)) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="4707"><td class="num" id="LN4707">4707</td><td class="line">            <span class='keyword'>else</span> <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4708"><td class="num" id="LN4708">4708</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="4709"><td class="num" id="LN4709">4709</td><td class="line">            currentNode = clusterManagerNewNode(<span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(ip), port, bus_port);</td></tr>
<tr class="codeline" data-linenumber="4710"><td class="num" id="LN4710">4710</td><td class="line">            currentNode-&gt;flags |= <span class='macro'>CLUSTER_MANAGER_FLAG_FRIEND<span class='macro_popup'>1 &lt;&lt; 2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4711"><td class="num" id="LN4711">4711</td><td class="line">            <span class='keyword'>if</span> (node-&gt;friends == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) node-&gt;friends = listCreate();</td></tr>
<tr class="codeline" data-linenumber="4712"><td class="num" id="LN4712">4712</td><td class="line">            listAddNodeTail(node-&gt;friends, currentNode);</td></tr>
<tr class="codeline" data-linenumber="4713"><td class="num" id="LN4713">4713</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4714"><td class="num" id="LN4714">4714</td><td class="line">        <span class='keyword'>if</span> (name != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4715"><td class="num" id="LN4715">4715</td><td class="line">            <span class='keyword'>if</span> (currentNode-&gt;name) <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(currentNode-&gt;name);</td></tr>
<tr class="codeline" data-linenumber="4716"><td class="num" id="LN4716">4716</td><td class="line">            currentNode-&gt;name = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(name);</td></tr>
<tr class="codeline" data-linenumber="4717"><td class="num" id="LN4717">4717</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4718"><td class="num" id="LN4718">4718</td><td class="line">        <span class='keyword'>if</span> (currentNode-&gt;flags_str != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4719"><td class="num" id="LN4719">4719</td><td class="line">            freeClusterManagerNodeFlags(currentNode-&gt;flags_str);</td></tr>
<tr class="codeline" data-linenumber="4720"><td class="num" id="LN4720">4720</td><td class="line">        currentNode-&gt;flags_str = listCreate();</td></tr>
<tr class="codeline" data-linenumber="4721"><td class="num" id="LN4721">4721</td><td class="line">        <span class='keyword'>int</span> flag_len;</td></tr>
<tr class="codeline" data-linenumber="4722"><td class="num" id="LN4722">4722</td><td class="line">        <span class='keyword'>while</span> ((flag_len = strlen(flags)) &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="4723"><td class="num" id="LN4723">4723</td><td class="line">            <span class='macro'>sds<span class='macro_popup'>hisds</span></span> flag = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4724"><td class="num" id="LN4724">4724</td><td class="line">            <span class='keyword'>char</span> *fp = strchr(flags, ',');</td></tr>
<tr class="codeline" data-linenumber="4725"><td class="num" id="LN4725">4725</td><td class="line">            <span class='keyword'>if</span> (fp) {</td></tr>
<tr class="codeline" data-linenumber="4726"><td class="num" id="LN4726">4726</td><td class="line">                *fp = '\0';</td></tr>
<tr class="codeline" data-linenumber="4727"><td class="num" id="LN4727">4727</td><td class="line">                flag = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(flags);</td></tr>
<tr class="codeline" data-linenumber="4728"><td class="num" id="LN4728">4728</td><td class="line">                flags = fp + 1;</td></tr>
<tr class="codeline" data-linenumber="4729"><td class="num" id="LN4729">4729</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="4730"><td class="num" id="LN4730">4730</td><td class="line">                flag = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(flags);</td></tr>
<tr class="codeline" data-linenumber="4731"><td class="num" id="LN4731">4731</td><td class="line">                flags += flag_len;</td></tr>
<tr class="codeline" data-linenumber="4732"><td class="num" id="LN4732">4732</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="4733"><td class="num" id="LN4733">4733</td><td class="line">            <span class='keyword'>if</span> (strcmp(flag, <span class='string_literal'>"noaddr"</span>) == 0)</td></tr>
<tr class="codeline" data-linenumber="4734"><td class="num" id="LN4734">4734</td><td class="line">                currentNode-&gt;flags |= <span class='macro'>CLUSTER_MANAGER_FLAG_NOADDR<span class='macro_popup'>1 &lt;&lt; 3</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4735"><td class="num" id="LN4735">4735</td><td class="line">            <span class='keyword'>else</span> <span class='keyword'>if</span> (strcmp(flag, <span class='string_literal'>"disconnected"</span>) == 0)</td></tr>
<tr class="codeline" data-linenumber="4736"><td class="num" id="LN4736">4736</td><td class="line">                currentNode-&gt;flags |= <span class='macro'>CLUSTER_MANAGER_FLAG_DISCONNECT<span class='macro_popup'>1 &lt;&lt; 4</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4737"><td class="num" id="LN4737">4737</td><td class="line">            <span class='keyword'>else</span> <span class='keyword'>if</span> (strcmp(flag, <span class='string_literal'>"fail"</span>) == 0)</td></tr>
<tr class="codeline" data-linenumber="4738"><td class="num" id="LN4738">4738</td><td class="line">                currentNode-&gt;flags |= <span class='macro'>CLUSTER_MANAGER_FLAG_FAIL<span class='macro_popup'>1 &lt;&lt; 5</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4739"><td class="num" id="LN4739">4739</td><td class="line">            <span class='keyword'>else</span> <span class='keyword'>if</span> (strcmp(flag, <span class='string_literal'>"slave"</span>) == 0) {</td></tr>
<tr class="codeline" data-linenumber="4740"><td class="num" id="LN4740">4740</td><td class="line">                currentNode-&gt;flags |= <span class='macro'>CLUSTER_MANAGER_FLAG_SLAVE<span class='macro_popup'>1 &lt;&lt; 1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4741"><td class="num" id="LN4741">4741</td><td class="line">                <span class='keyword'>if</span> (master_id != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4742"><td class="num" id="LN4742">4742</td><td class="line">                    <span class='keyword'>if</span> (currentNode-&gt;replicate) <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(currentNode-&gt;replicate);</td></tr>
<tr class="codeline" data-linenumber="4743"><td class="num" id="LN4743">4743</td><td class="line">                    currentNode-&gt;replicate = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(master_id);</td></tr>
<tr class="codeline" data-linenumber="4744"><td class="num" id="LN4744">4744</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="4745"><td class="num" id="LN4745">4745</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="4746"><td class="num" id="LN4746">4746</td><td class="line">            listAddNodeTail(currentNode-&gt;flags_str, flag);</td></tr>
<tr class="codeline" data-linenumber="4747"><td class="num" id="LN4747">4747</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4748"><td class="num" id="LN4748">4748</td><td class="line">        <span class='keyword'>if</span> (config_epoch != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4749"><td class="num" id="LN4749">4749</td><td class="line">            currentNode-&gt;current_epoch = atoll(config_epoch);</td></tr>
<tr class="codeline" data-linenumber="4750"><td class="num" id="LN4750">4750</td><td class="line">        <span class='keyword'>if</span> (ping_sent != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) currentNode-&gt;ping_sent = atoll(ping_sent);</td></tr>
<tr class="codeline" data-linenumber="4751"><td class="num" id="LN4751">4751</td><td class="line">        <span class='keyword'>if</span> (ping_recv != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) currentNode-&gt;ping_recv = atoll(ping_recv);</td></tr>
<tr class="codeline" data-linenumber="4752"><td class="num" id="LN4752">4752</td><td class="line">        <span class='keyword'>if</span> (!getfriends &amp;&amp; myself) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4753"><td class="num" id="LN4753">4753</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4754"><td class="num" id="LN4754">4754</td><td class="line">cleanup:</td></tr>
<tr class="codeline" data-linenumber="4755"><td class="num" id="LN4755">4755</td><td class="line">    <span class='keyword'>if</span> (reply) freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="4756"><td class="num" id="LN4756">4756</td><td class="line">    <span class='keyword'>return</span> success;</td></tr>
<tr class="codeline" data-linenumber="4757"><td class="num" id="LN4757">4757</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4758"><td class="num" id="LN4758">4758</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4759"><td class="num" id="LN4759">4759</td><td class="line"><span class='comment'>/* Retrieves info about the cluster using argument 'node' as the starting</span></td></tr>
<tr class="codeline" data-linenumber="4760"><td class="num" id="LN4760">4760</td><td class="line"> <span class='comment'>* point. All nodes will be loaded inside the cluster_manager.nodes list.</span></td></tr>
<tr class="codeline" data-linenumber="4761"><td class="num" id="LN4761">4761</td><td class="line"> <span class='comment'>* Warning: if something goes wrong, it will free the starting node before</span></td></tr>
<tr class="codeline" data-linenumber="4762"><td class="num" id="LN4762">4762</td><td class="line"> <span class='comment'>* returning 0. */</span></td></tr>
<tr class="codeline" data-linenumber="4763"><td class="num" id="LN4763">4763</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerLoadInfoFromNode(clusterManagerNode *node) {</td></tr>
<tr class="codeline" data-linenumber="4764"><td class="num" id="LN4764">4764</td><td class="line">    <span class='keyword'>if</span> (node-&gt;context == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> &amp;&amp; !clusterManagerNodeConnect(node)) {</td></tr>
<tr class="codeline" data-linenumber="4765"><td class="num" id="LN4765">4765</td><td class="line">        freeClusterManagerNode(node);</td></tr>
<tr class="codeline" data-linenumber="4766"><td class="num" id="LN4766">4766</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="4767"><td class="num" id="LN4767">4767</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4768"><td class="num" id="LN4768">4768</td><td class="line">    <span class='keyword'>char</span> *e = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4769"><td class="num" id="LN4769">4769</td><td class="line">    <span class='keyword'>if</span> (!clusterManagerNodeIsCluster(node, &amp;e)) {</td></tr>
<tr class="codeline" data-linenumber="4770"><td class="num" id="LN4770">4770</td><td class="line">        clusterManagerPrintNotClusterNodeError(node, e);</td></tr>
<tr class="codeline" data-linenumber="4771"><td class="num" id="LN4771">4771</td><td class="line">        <span class='keyword'>if</span> (e) zfree(e);</td></tr>
<tr class="codeline" data-linenumber="4772"><td class="num" id="LN4772">4772</td><td class="line">        freeClusterManagerNode(node);</td></tr>
<tr class="codeline" data-linenumber="4773"><td class="num" id="LN4773">4773</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="4774"><td class="num" id="LN4774">4774</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4775"><td class="num" id="LN4775">4775</td><td class="line">    e = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4776"><td class="num" id="LN4776">4776</td><td class="line">    <span class='keyword'>if</span> (!clusterManagerNodeLoadInfo(node, <span class='macro'>CLUSTER_MANAGER_OPT_GETFRIENDS<span class='macro_popup'>1 &lt;&lt; 0</span></span>, &amp;e)) {</td></tr>
<tr class="codeline" data-linenumber="4777"><td class="num" id="LN4777">4777</td><td class="line">        <span class='keyword'>if</span> (e) {</td></tr>
<tr class="codeline" data-linenumber="4778"><td class="num" id="LN4778">4778</td><td class="line">            <span class='macro'>CLUSTER_MANAGER_PRINT_REPLY_ERROR(node, e)<span class='macro_popup'>clusterManagerLog(3,"Node %s:%d replied with error:\n%s\n", node<br>-&gt;ip, node-&gt;port, e);</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4779"><td class="num" id="LN4779">4779</td><td class="line">            zfree(e);</td></tr>
<tr class="codeline" data-linenumber="4780"><td class="num" id="LN4780">4780</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4781"><td class="num" id="LN4781">4781</td><td class="line">        freeClusterManagerNode(node);</td></tr>
<tr class="codeline" data-linenumber="4782"><td class="num" id="LN4782">4782</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="4783"><td class="num" id="LN4783">4783</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4784"><td class="num" id="LN4784">4784</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="4785"><td class="num" id="LN4785">4785</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="4786"><td class="num" id="LN4786">4786</td><td class="line">    <span class='keyword'>if</span> (cluster_manager.nodes != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4787"><td class="num" id="LN4787">4787</td><td class="line">        listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="4788"><td class="num" id="LN4788">4788</td><td class="line">        <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4789"><td class="num" id="LN4789">4789</td><td class="line">            freeClusterManagerNode((clusterManagerNode *) ln-&gt;value);</td></tr>
<tr class="codeline" data-linenumber="4790"><td class="num" id="LN4790">4790</td><td class="line">        listRelease(cluster_manager.nodes);</td></tr>
<tr class="codeline" data-linenumber="4791"><td class="num" id="LN4791">4791</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4792"><td class="num" id="LN4792">4792</td><td class="line">    cluster_manager.nodes = listCreate();</td></tr>
<tr class="codeline" data-linenumber="4793"><td class="num" id="LN4793">4793</td><td class="line">    listAddNodeTail(cluster_manager.nodes, node);</td></tr>
<tr class="codeline" data-linenumber="4794"><td class="num" id="LN4794">4794</td><td class="line">    <span class='keyword'>if</span> (node-&gt;friends != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4795"><td class="num" id="LN4795">4795</td><td class="line">        listRewind(node-&gt;friends, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="4796"><td class="num" id="LN4796">4796</td><td class="line">        <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4797"><td class="num" id="LN4797">4797</td><td class="line">            clusterManagerNode *friend = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="4798"><td class="num" id="LN4798">4798</td><td class="line">            <span class='keyword'>if</span> (!friend-&gt;ip || !friend-&gt;port) <span class='keyword'>goto</span> invalid_friend;</td></tr>
<tr class="codeline" data-linenumber="4799"><td class="num" id="LN4799">4799</td><td class="line">            <span class='keyword'>if</span> (!friend-&gt;context &amp;&amp; !clusterManagerNodeConnect(friend))</td></tr>
<tr class="codeline" data-linenumber="4800"><td class="num" id="LN4800">4800</td><td class="line">                <span class='keyword'>goto</span> invalid_friend;</td></tr>
<tr class="codeline" data-linenumber="4801"><td class="num" id="LN4801">4801</td><td class="line">            e = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4802"><td class="num" id="LN4802">4802</td><td class="line">            <span class='keyword'>if</span> (clusterManagerNodeLoadInfo(friend, 0, &amp;e)) {</td></tr>
<tr class="codeline" data-linenumber="4803"><td class="num" id="LN4803">4803</td><td class="line">                <span class='keyword'>if</span> (friend-&gt;flags &amp; (<span class='macro'>CLUSTER_MANAGER_FLAG_NOADDR<span class='macro_popup'>1 &lt;&lt; 3</span></span> |</td></tr>
<tr class="codeline" data-linenumber="4804"><td class="num" id="LN4804">4804</td><td class="line">                                     <span class='macro'>CLUSTER_MANAGER_FLAG_DISCONNECT<span class='macro_popup'>1 &lt;&lt; 4</span></span> |</td></tr>
<tr class="codeline" data-linenumber="4805"><td class="num" id="LN4805">4805</td><td class="line">                                     <span class='macro'>CLUSTER_MANAGER_FLAG_FAIL<span class='macro_popup'>1 &lt;&lt; 5</span></span>))</td></tr>
<tr class="codeline" data-linenumber="4806"><td class="num" id="LN4806">4806</td><td class="line">                {</td></tr>
<tr class="codeline" data-linenumber="4807"><td class="num" id="LN4807">4807</td><td class="line">                    <span class='keyword'>goto</span> invalid_friend;</td></tr>
<tr class="codeline" data-linenumber="4808"><td class="num" id="LN4808">4808</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="4809"><td class="num" id="LN4809">4809</td><td class="line">                listAddNodeTail(cluster_manager.nodes, friend);</td></tr>
<tr class="codeline" data-linenumber="4810"><td class="num" id="LN4810">4810</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="4811"><td class="num" id="LN4811">4811</td><td class="line">                <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"[ERR] Unable to load info for "<span class='macro_popup'>clusterManagerLog(3,"[ERR] Unable to load info for " "node %s:%d\n"<br>, friend-&gt;ip, friend-&gt;port)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="4812"><td class="num" id="LN4812">4812</td><td class="line">                                     <span class='string_literal'><span class='macro'>"node %s:%d\n"</span>,<span class='macro_popup'>clusterManagerLog(3,"[ERR] Unable to load info for " "node %s:%d\n"<br>, friend-&gt;ip, friend-&gt;port)</span></span></td></tr>
<tr class="codeline" data-linenumber="4813"><td class="num" id="LN4813">4813</td><td class="line">                                     <span class='macro'>friend-&gt;ip, friend-&gt;port)<span class='macro_popup'>clusterManagerLog(3,"[ERR] Unable to load info for " "node %s:%d\n"<br>, friend-&gt;ip, friend-&gt;port)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4814"><td class="num" id="LN4814">4814</td><td class="line">                <span class='keyword'>goto</span> invalid_friend;</td></tr>
<tr class="codeline" data-linenumber="4815"><td class="num" id="LN4815">4815</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="4816"><td class="num" id="LN4816">4816</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="4817"><td class="num" id="LN4817">4817</td><td class="line">invalid_friend:</td></tr>
<tr class="codeline" data-linenumber="4818"><td class="num" id="LN4818">4818</td><td class="line">            <span class='keyword'>if</span> (!(friend-&gt;flags &amp; <span class='macro'>CLUSTER_MANAGER_FLAG_SLAVE<span class='macro_popup'>1 &lt;&lt; 1</span></span>))</td></tr>
<tr class="codeline" data-linenumber="4819"><td class="num" id="LN4819">4819</td><td class="line">                cluster_manager.unreachable_masters++;</td></tr>
<tr class="codeline" data-linenumber="4820"><td class="num" id="LN4820">4820</td><td class="line">            freeClusterManagerNode(friend);</td></tr>
<tr class="codeline" data-linenumber="4821"><td class="num" id="LN4821">4821</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4822"><td class="num" id="LN4822">4822</td><td class="line">        listRelease(node-&gt;friends);</td></tr>
<tr class="codeline" data-linenumber="4823"><td class="num" id="LN4823">4823</td><td class="line">        node-&gt;friends = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4824"><td class="num" id="LN4824">4824</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4825"><td class="num" id="LN4825">4825</td><td class="line">    <span class='comment'>// Count replicas for each node</span></td></tr>
<tr class="codeline" data-linenumber="4826"><td class="num" id="LN4826">4826</td><td class="line">    listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="4827"><td class="num" id="LN4827">4827</td><td class="line">    <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4828"><td class="num" id="LN4828">4828</td><td class="line">        clusterManagerNode *n = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="4829"><td class="num" id="LN4829">4829</td><td class="line">        <span class='keyword'>if</span> (n-&gt;replicate != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4830"><td class="num" id="LN4830">4830</td><td class="line">            clusterManagerNode *master = clusterManagerNodeByName(n-&gt;replicate);</td></tr>
<tr class="codeline" data-linenumber="4831"><td class="num" id="LN4831">4831</td><td class="line">            <span class='keyword'>if</span> (master == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4832"><td class="num" id="LN4832">4832</td><td class="line">                <span class='macro'>clusterManagerLogWarn(<span class='string_literal'>"*** WARNING: %s:%d claims to be "<span class='macro_popup'>clusterManagerLog(2,"*** WARNING: %s:%d claims to be " "slave of unknown node ID %s.\n"<br>, n-&gt;ip, n-&gt;port, n-&gt;replicate)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="4833"><td class="num" id="LN4833">4833</td><td class="line">                                      <span class='string_literal'><span class='macro'>"slave of unknown node ID %s.\n"</span>,<span class='macro_popup'>clusterManagerLog(2,"*** WARNING: %s:%d claims to be " "slave of unknown node ID %s.\n"<br>, n-&gt;ip, n-&gt;port, n-&gt;replicate)</span></span></td></tr>
<tr class="codeline" data-linenumber="4834"><td class="num" id="LN4834">4834</td><td class="line">                                      <span class='macro'>n-&gt;ip, n-&gt;port, n-&gt;replicate)<span class='macro_popup'>clusterManagerLog(2,"*** WARNING: %s:%d claims to be " "slave of unknown node ID %s.\n"<br>, n-&gt;ip, n-&gt;port, n-&gt;replicate)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4835"><td class="num" id="LN4835">4835</td><td class="line">            } <span class='keyword'>else</span> master-&gt;replicas_count++;</td></tr>
<tr class="codeline" data-linenumber="4836"><td class="num" id="LN4836">4836</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4837"><td class="num" id="LN4837">4837</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4838"><td class="num" id="LN4838">4838</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="4839"><td class="num" id="LN4839">4839</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4840"><td class="num" id="LN4840">4840</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4841"><td class="num" id="LN4841">4841</td><td class="line"><span class='comment'>/* Compare functions used by various sorting operations. */</span></td></tr>
<tr class="codeline" data-linenumber="4842"><td class="num" id="LN4842">4842</td><td class="line"><span class='keyword'>int</span> clusterManagerSlotCompare(<span class='keyword'>const</span> <span class='keyword'>void</span> *slot1, <span class='keyword'>const</span> <span class='keyword'>void</span> *slot2) {</td></tr>
<tr class="codeline" data-linenumber="4843"><td class="num" id="LN4843">4843</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>char</span> **i1 = (<span class='keyword'>const</span> <span class='keyword'>char</span> **)slot1;</td></tr>
<tr class="codeline" data-linenumber="4844"><td class="num" id="LN4844">4844</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>char</span> **i2 = (<span class='keyword'>const</span> <span class='keyword'>char</span> **)slot2;</td></tr>
<tr class="codeline" data-linenumber="4845"><td class="num" id="LN4845">4845</td><td class="line">    <span class='keyword'>return</span> strcmp(*i1, *i2);</td></tr>
<tr class="codeline" data-linenumber="4846"><td class="num" id="LN4846">4846</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4847"><td class="num" id="LN4847">4847</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4848"><td class="num" id="LN4848">4848</td><td class="line"><span class='keyword'>int</span> clusterManagerSlotCountCompareDesc(<span class='keyword'>const</span> <span class='keyword'>void</span> *n1, <span class='keyword'>const</span> <span class='keyword'>void</span> *n2) {</td></tr>
<tr class="codeline" data-linenumber="4849"><td class="num" id="LN4849">4849</td><td class="line">    clusterManagerNode *node1 = *((clusterManagerNode **) n1);</td></tr>
<tr class="codeline" data-linenumber="4850"><td class="num" id="LN4850">4850</td><td class="line">    clusterManagerNode *node2 = *((clusterManagerNode **) n2);</td></tr>
<tr class="codeline" data-linenumber="4851"><td class="num" id="LN4851">4851</td><td class="line">    <span class='keyword'>return</span> node2-&gt;slots_count - node1-&gt;slots_count;</td></tr>
<tr class="codeline" data-linenumber="4852"><td class="num" id="LN4852">4852</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4853"><td class="num" id="LN4853">4853</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4854"><td class="num" id="LN4854">4854</td><td class="line"><span class='keyword'>int</span> clusterManagerCompareNodeBalance(<span class='keyword'>const</span> <span class='keyword'>void</span> *n1, <span class='keyword'>const</span> <span class='keyword'>void</span> *n2) {</td></tr>
<tr class="codeline" data-linenumber="4855"><td class="num" id="LN4855">4855</td><td class="line">    clusterManagerNode *node1 = *((clusterManagerNode **) n1);</td></tr>
<tr class="codeline" data-linenumber="4856"><td class="num" id="LN4856">4856</td><td class="line">    clusterManagerNode *node2 = *((clusterManagerNode **) n2);</td></tr>
<tr class="codeline" data-linenumber="4857"><td class="num" id="LN4857">4857</td><td class="line">    <span class='keyword'>return</span> node1-&gt;balance - node2-&gt;balance;</td></tr>
<tr class="codeline" data-linenumber="4858"><td class="num" id="LN4858">4858</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4859"><td class="num" id="LN4859">4859</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4860"><td class="num" id="LN4860">4860</td><td class="line"><span class='keyword'>static</span> <span class='macro'>sds<span class='macro_popup'>hisds</span></span> clusterManagerGetConfigSignature(clusterManagerNode *node) {</td></tr>
<tr class="codeline" data-linenumber="4861"><td class="num" id="LN4861">4861</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> signature = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4862"><td class="num" id="LN4862">4862</td><td class="line">    <span class='keyword'>int</span> node_count = 0, i = 0, name_len = 0;</td></tr>
<tr class="codeline" data-linenumber="4863"><td class="num" id="LN4863">4863</td><td class="line">    <span class='keyword'>char</span> **node_configs = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4864"><td class="num" id="LN4864">4864</td><td class="line">    redisReply *reply = <span class='macro'>CLUSTER_MANAGER_COMMAND(node, <span class='string_literal'>"CLUSTER NODES"</span>)<span class='macro_popup'>(redisCommand(node-&gt;context, "CLUSTER NODES"))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4865"><td class="num" id="LN4865">4865</td><td class="line">    <span class='keyword'>if</span> (reply == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> || reply-&gt;type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4866"><td class="num" id="LN4866">4866</td><td class="line">        <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="4867"><td class="num" id="LN4867">4867</td><td class="line">    <span class='keyword'>char</span> *lines = reply-&gt;str, *p, *line;</td></tr>
<tr class="codeline" data-linenumber="4868"><td class="num" id="LN4868">4868</td><td class="line">    <span class='keyword'>while</span> ((p = strstr(lines, <span class='string_literal'>"\n"</span>)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4869"><td class="num" id="LN4869">4869</td><td class="line">        i = 0;</td></tr>
<tr class="codeline" data-linenumber="4870"><td class="num" id="LN4870">4870</td><td class="line">        *p = '\0';</td></tr>
<tr class="codeline" data-linenumber="4871"><td class="num" id="LN4871">4871</td><td class="line">        line = lines;</td></tr>
<tr class="codeline" data-linenumber="4872"><td class="num" id="LN4872">4872</td><td class="line">        lines = p + 1;</td></tr>
<tr class="codeline" data-linenumber="4873"><td class="num" id="LN4873">4873</td><td class="line">        <span class='keyword'>char</span> *nodename = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4874"><td class="num" id="LN4874">4874</td><td class="line">        <span class='keyword'>int</span> tot_size = 0;</td></tr>
<tr class="codeline" data-linenumber="4875"><td class="num" id="LN4875">4875</td><td class="line">        <span class='keyword'>while</span> ((p = strchr(line, ' ')) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4876"><td class="num" id="LN4876">4876</td><td class="line">            *p = '\0';</td></tr>
<tr class="codeline" data-linenumber="4877"><td class="num" id="LN4877">4877</td><td class="line">            <span class='keyword'>char</span> *token = line;</td></tr>
<tr class="codeline" data-linenumber="4878"><td class="num" id="LN4878">4878</td><td class="line">            line = p + 1;</td></tr>
<tr class="codeline" data-linenumber="4879"><td class="num" id="LN4879">4879</td><td class="line">            <span class='keyword'>if</span> (i == 0) {</td></tr>
<tr class="codeline" data-linenumber="4880"><td class="num" id="LN4880">4880</td><td class="line">                nodename = token;</td></tr>
<tr class="codeline" data-linenumber="4881"><td class="num" id="LN4881">4881</td><td class="line">                tot_size = (p - token);</td></tr>
<tr class="codeline" data-linenumber="4882"><td class="num" id="LN4882">4882</td><td class="line">                name_len = tot_size++; <span class='comment'>// Make room for ':' in tot_size</span></td></tr>
<tr class="codeline" data-linenumber="4883"><td class="num" id="LN4883">4883</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="4884"><td class="num" id="LN4884">4884</td><td class="line">            <span class='keyword'>if</span> (++i == 8) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4885"><td class="num" id="LN4885">4885</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4886"><td class="num" id="LN4886">4886</td><td class="line">        <span class='keyword'>if</span> (i != 8) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="4887"><td class="num" id="LN4887">4887</td><td class="line">        <span class='keyword'>if</span> (nodename == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="4888"><td class="num" id="LN4888">4888</td><td class="line">        <span class='keyword'>int</span> remaining = strlen(line);</td></tr>
<tr class="codeline" data-linenumber="4889"><td class="num" id="LN4889">4889</td><td class="line">        <span class='keyword'>if</span> (remaining == 0) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="4890"><td class="num" id="LN4890">4890</td><td class="line">        <span class='keyword'>char</span> **slots = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4891"><td class="num" id="LN4891">4891</td><td class="line">        <span class='keyword'>int</span> c = 0;</td></tr>
<tr class="codeline" data-linenumber="4892"><td class="num" id="LN4892">4892</td><td class="line">        <span class='keyword'>while</span> (remaining &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="4893"><td class="num" id="LN4893">4893</td><td class="line">            p = strchr(line, ' ');</td></tr>
<tr class="codeline" data-linenumber="4894"><td class="num" id="LN4894">4894</td><td class="line">            <span class='keyword'>if</span> (p == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) p = line + remaining;</td></tr>
<tr class="codeline" data-linenumber="4895"><td class="num" id="LN4895">4895</td><td class="line">            <span class='keyword'>int</span> size = (p - line);</td></tr>
<tr class="codeline" data-linenumber="4896"><td class="num" id="LN4896">4896</td><td class="line">            remaining -= size;</td></tr>
<tr class="codeline" data-linenumber="4897"><td class="num" id="LN4897">4897</td><td class="line">            tot_size += size;</td></tr>
<tr class="codeline" data-linenumber="4898"><td class="num" id="LN4898">4898</td><td class="line">            <span class='keyword'>char</span> *slotsdef = line;</td></tr>
<tr class="codeline" data-linenumber="4899"><td class="num" id="LN4899">4899</td><td class="line">            *p = '\0';</td></tr>
<tr class="codeline" data-linenumber="4900"><td class="num" id="LN4900">4900</td><td class="line">            <span class='keyword'>if</span> (remaining) {</td></tr>
<tr class="codeline" data-linenumber="4901"><td class="num" id="LN4901">4901</td><td class="line">                line = p + 1;</td></tr>
<tr class="codeline" data-linenumber="4902"><td class="num" id="LN4902">4902</td><td class="line">                remaining--;</td></tr>
<tr class="codeline" data-linenumber="4903"><td class="num" id="LN4903">4903</td><td class="line">            } <span class='keyword'>else</span> line = p;</td></tr>
<tr class="codeline" data-linenumber="4904"><td class="num" id="LN4904">4904</td><td class="line">            <span class='keyword'>if</span> (slotsdef[0] != '[') {</td></tr>
<tr class="codeline" data-linenumber="4905"><td class="num" id="LN4905">4905</td><td class="line">                c++;</td></tr>
<tr class="codeline" data-linenumber="4906"><td class="num" id="LN4906">4906</td><td class="line">                slots = zrealloc(slots, (c * <span class='keyword'>sizeof</span>(<span class='keyword'>char</span> *)));</td></tr>
<tr class="codeline" data-linenumber="4907"><td class="num" id="LN4907">4907</td><td class="line">                slots[c - 1] = slotsdef;</td></tr>
<tr class="codeline" data-linenumber="4908"><td class="num" id="LN4908">4908</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="4909"><td class="num" id="LN4909">4909</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4910"><td class="num" id="LN4910">4910</td><td class="line">        <span class='keyword'>if</span> (c &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="4911"><td class="num" id="LN4911">4911</td><td class="line">            <span class='keyword'>if</span> (c &gt; 1)</td></tr>
<tr class="codeline" data-linenumber="4912"><td class="num" id="LN4912">4912</td><td class="line">                qsort(slots, c, <span class='keyword'>sizeof</span>(<span class='keyword'>char</span> *), clusterManagerSlotCompare);</td></tr>
<tr class="codeline" data-linenumber="4913"><td class="num" id="LN4913">4913</td><td class="line">            node_count++;</td></tr>
<tr class="codeline" data-linenumber="4914"><td class="num" id="LN4914">4914</td><td class="line">            node_configs =</td></tr>
<tr class="codeline" data-linenumber="4915"><td class="num" id="LN4915">4915</td><td class="line">                zrealloc(node_configs, (node_count * <span class='keyword'>sizeof</span>(<span class='keyword'>char</span> *)));</td></tr>
<tr class="codeline" data-linenumber="4916"><td class="num" id="LN4916">4916</td><td class="line">            <span class='comment'>/* Make room for '|' separators. */</span></td></tr>
<tr class="codeline" data-linenumber="4917"><td class="num" id="LN4917">4917</td><td class="line">            tot_size += (<span class='keyword'>sizeof</span>(<span class='keyword'>char</span>) * (c - 1));</td></tr>
<tr class="codeline" data-linenumber="4918"><td class="num" id="LN4918">4918</td><td class="line">            <span class='keyword'>char</span> *cfg = zmalloc((<span class='keyword'>sizeof</span>(<span class='keyword'>char</span>) * tot_size) + 1);</td></tr>
<tr class="codeline" data-linenumber="4919"><td class="num" id="LN4919">4919</td><td class="line">            memcpy(cfg, nodename, name_len);</td></tr>
<tr class="codeline" data-linenumber="4920"><td class="num" id="LN4920">4920</td><td class="line">            <span class='keyword'>char</span> *sp = cfg + name_len;</td></tr>
<tr class="codeline" data-linenumber="4921"><td class="num" id="LN4921">4921</td><td class="line">            *(sp++) = ':';</td></tr>
<tr class="codeline" data-linenumber="4922"><td class="num" id="LN4922">4922</td><td class="line">            <span class='keyword'>for</span> (i = 0; i &lt; c; i++) {</td></tr>
<tr class="codeline" data-linenumber="4923"><td class="num" id="LN4923">4923</td><td class="line">                <span class='keyword'>if</span> (i &gt; 0) *(sp++) = ',';</td></tr>
<tr class="codeline" data-linenumber="4924"><td class="num" id="LN4924">4924</td><td class="line">                <span class='keyword'>int</span> slen = strlen(slots[i]);</td></tr>
<tr class="codeline" data-linenumber="4925"><td class="num" id="LN4925">4925</td><td class="line">                memcpy(sp, slots[i], slen);</td></tr>
<tr class="codeline" data-linenumber="4926"><td class="num" id="LN4926">4926</td><td class="line">                sp += slen;</td></tr>
<tr class="codeline" data-linenumber="4927"><td class="num" id="LN4927">4927</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="4928"><td class="num" id="LN4928">4928</td><td class="line">            *(sp++) = '\0';</td></tr>
<tr class="codeline" data-linenumber="4929"><td class="num" id="LN4929">4929</td><td class="line">            node_configs[node_count - 1] = cfg;</td></tr>
<tr class="codeline" data-linenumber="4930"><td class="num" id="LN4930">4930</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4931"><td class="num" id="LN4931">4931</td><td class="line">        zfree(slots);</td></tr>
<tr class="codeline" data-linenumber="4932"><td class="num" id="LN4932">4932</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4933"><td class="num" id="LN4933">4933</td><td class="line">    <span class='keyword'>if</span> (node_count &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="4934"><td class="num" id="LN4934">4934</td><td class="line">        <span class='keyword'>if</span> (node_count &gt; 1) {</td></tr>
<tr class="codeline" data-linenumber="4935"><td class="num" id="LN4935">4935</td><td class="line">            qsort(node_configs, node_count, <span class='keyword'>sizeof</span>(<span class='keyword'>char</span> *),</td></tr>
<tr class="codeline" data-linenumber="4936"><td class="num" id="LN4936">4936</td><td class="line">                  clusterManagerSlotCompare);</td></tr>
<tr class="codeline" data-linenumber="4937"><td class="num" id="LN4937">4937</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4938"><td class="num" id="LN4938">4938</td><td class="line">        signature = <span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>();</td></tr>
<tr class="codeline" data-linenumber="4939"><td class="num" id="LN4939">4939</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; node_count; i++) {</td></tr>
<tr class="codeline" data-linenumber="4940"><td class="num" id="LN4940">4940</td><td class="line">            <span class='keyword'>if</span> (i &gt; 0) signature = <span class='macro'>sdscatprintf<span class='macro_popup'>hi_sdscatprintf</span></span>(signature, <span class='string_literal'>"%c"</span>, '|');</td></tr>
<tr class="codeline" data-linenumber="4941"><td class="num" id="LN4941">4941</td><td class="line">            signature = <span class='macro'>sdscatfmt<span class='macro_popup'>hi_sdscatfmt</span></span>(signature, <span class='string_literal'>"%s"</span>, node_configs[i]);</td></tr>
<tr class="codeline" data-linenumber="4942"><td class="num" id="LN4942">4942</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4943"><td class="num" id="LN4943">4943</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4944"><td class="num" id="LN4944">4944</td><td class="line">cleanup:</td></tr>
<tr class="codeline" data-linenumber="4945"><td class="num" id="LN4945">4945</td><td class="line">    <span class='keyword'>if</span> (reply != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="4946"><td class="num" id="LN4946">4946</td><td class="line">    <span class='keyword'>if</span> (node_configs != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4947"><td class="num" id="LN4947">4947</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; node_count; i++) zfree(node_configs[i]);</td></tr>
<tr class="codeline" data-linenumber="4948"><td class="num" id="LN4948">4948</td><td class="line">        zfree(node_configs);</td></tr>
<tr class="codeline" data-linenumber="4949"><td class="num" id="LN4949">4949</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4950"><td class="num" id="LN4950">4950</td><td class="line">    <span class='keyword'>return</span> signature;</td></tr>
<tr class="codeline" data-linenumber="4951"><td class="num" id="LN4951">4951</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4952"><td class="num" id="LN4952">4952</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4953"><td class="num" id="LN4953">4953</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerIsConfigConsistent(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="4954"><td class="num" id="LN4954">4954</td><td class="line">    <span class='keyword'>if</span> (cluster_manager.nodes == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="4955"><td class="num" id="LN4955">4955</td><td class="line">    <span class='keyword'>int</span> consistent = (<span class='macro'>listLength(cluster_manager.nodes)<span class='macro_popup'>((cluster_manager.nodes)-&gt;len)</span></span> &lt;= 1);</td></tr>
<tr class="codeline" data-linenumber="4956"><td class="num" id="LN4956">4956</td><td class="line">    <span class='comment'>// If the Cluster has only one node, it's always consistent</span></td></tr>
<tr class="codeline" data-linenumber="4957"><td class="num" id="LN4957">4957</td><td class="line">    <span class='keyword'>if</span> (consistent) <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="4958"><td class="num" id="LN4958">4958</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> first_cfg = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4959"><td class="num" id="LN4959">4959</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="4960"><td class="num" id="LN4960">4960</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="4961"><td class="num" id="LN4961">4961</td><td class="line">    listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="4962"><td class="num" id="LN4962">4962</td><td class="line">    <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4963"><td class="num" id="LN4963">4963</td><td class="line">        clusterManagerNode *node = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="4964"><td class="num" id="LN4964">4964</td><td class="line">        <span class='macro'>sds<span class='macro_popup'>hisds</span></span> cfg = clusterManagerGetConfigSignature(node);</td></tr>
<tr class="codeline" data-linenumber="4965"><td class="num" id="LN4965">4965</td><td class="line">        <span class='keyword'>if</span> (cfg == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4966"><td class="num" id="LN4966">4966</td><td class="line">            consistent = 0;</td></tr>
<tr class="codeline" data-linenumber="4967"><td class="num" id="LN4967">4967</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4968"><td class="num" id="LN4968">4968</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4969"><td class="num" id="LN4969">4969</td><td class="line">        <span class='keyword'>if</span> (first_cfg == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) first_cfg = cfg;</td></tr>
<tr class="codeline" data-linenumber="4970"><td class="num" id="LN4970">4970</td><td class="line">        <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="4971"><td class="num" id="LN4971">4971</td><td class="line">            consistent = !<span class='macro'>sdscmp<span class='macro_popup'>hi_sdscmp</span></span>(first_cfg, cfg);</td></tr>
<tr class="codeline" data-linenumber="4972"><td class="num" id="LN4972">4972</td><td class="line">            <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(cfg);</td></tr>
<tr class="codeline" data-linenumber="4973"><td class="num" id="LN4973">4973</td><td class="line">            <span class='keyword'>if</span> (!consistent) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4974"><td class="num" id="LN4974">4974</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4975"><td class="num" id="LN4975">4975</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4976"><td class="num" id="LN4976">4976</td><td class="line">    <span class='keyword'>if</span> (first_cfg != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(first_cfg);</td></tr>
<tr class="codeline" data-linenumber="4977"><td class="num" id="LN4977">4977</td><td class="line">    <span class='keyword'>return</span> consistent;</td></tr>
<tr class="codeline" data-linenumber="4978"><td class="num" id="LN4978">4978</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4979"><td class="num" id="LN4979">4979</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4980"><td class="num" id="LN4980">4980</td><td class="line"><span class='keyword'>static</span> list *clusterManagerGetDisconnectedLinks(clusterManagerNode *node) {</td></tr>
<tr class="codeline" data-linenumber="4981"><td class="num" id="LN4981">4981</td><td class="line">    list *links = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4982"><td class="num" id="LN4982">4982</td><td class="line">    redisReply *reply = <span class='macro'>CLUSTER_MANAGER_COMMAND(node, <span class='string_literal'>"CLUSTER NODES"</span>)<span class='macro_popup'>(redisCommand(node-&gt;context, "CLUSTER NODES"))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4983"><td class="num" id="LN4983">4983</td><td class="line">    <span class='keyword'>if</span> (!clusterManagerCheckRedisReply(node, reply, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)) <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="4984"><td class="num" id="LN4984">4984</td><td class="line">    links = listCreate();</td></tr>
<tr class="codeline" data-linenumber="4985"><td class="num" id="LN4985">4985</td><td class="line">    <span class='keyword'>char</span> *lines = reply-&gt;str, *p, *line;</td></tr>
<tr class="codeline" data-linenumber="4986"><td class="num" id="LN4986">4986</td><td class="line">    <span class='keyword'>while</span> ((p = strstr(lines, <span class='string_literal'>"\n"</span>)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4987"><td class="num" id="LN4987">4987</td><td class="line">        <span class='keyword'>int</span> i = 0;</td></tr>
<tr class="codeline" data-linenumber="4988"><td class="num" id="LN4988">4988</td><td class="line">        *p = '\0';</td></tr>
<tr class="codeline" data-linenumber="4989"><td class="num" id="LN4989">4989</td><td class="line">        line = lines;</td></tr>
<tr class="codeline" data-linenumber="4990"><td class="num" id="LN4990">4990</td><td class="line">        lines = p + 1;</td></tr>
<tr class="codeline" data-linenumber="4991"><td class="num" id="LN4991">4991</td><td class="line">        <span class='keyword'>char</span> *nodename = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, *addr = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, *flags = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, *link_status = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4992"><td class="num" id="LN4992">4992</td><td class="line">        <span class='keyword'>while</span> ((p = strchr(line, ' ')) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4993"><td class="num" id="LN4993">4993</td><td class="line">            *p = '\0';</td></tr>
<tr class="codeline" data-linenumber="4994"><td class="num" id="LN4994">4994</td><td class="line">            <span class='keyword'>char</span> *token = line;</td></tr>
<tr class="codeline" data-linenumber="4995"><td class="num" id="LN4995">4995</td><td class="line">            line = p + 1;</td></tr>
<tr class="codeline" data-linenumber="4996"><td class="num" id="LN4996">4996</td><td class="line">            <span class='keyword'>if</span> (i == 0) nodename = token;</td></tr>
<tr class="codeline" data-linenumber="4997"><td class="num" id="LN4997">4997</td><td class="line">            <span class='keyword'>else</span> <span class='keyword'>if</span> (i == 1) addr = token;</td></tr>
<tr class="codeline" data-linenumber="4998"><td class="num" id="LN4998">4998</td><td class="line">            <span class='keyword'>else</span> <span class='keyword'>if</span> (i == 2) flags = token;</td></tr>
<tr class="codeline" data-linenumber="4999"><td class="num" id="LN4999">4999</td><td class="line">            <span class='keyword'>else</span> <span class='keyword'>if</span> (i == 7) link_status = token;</td></tr>
<tr class="codeline" data-linenumber="5000"><td class="num" id="LN5000">5000</td><td class="line">            <span class='keyword'>else</span> <span class='keyword'>if</span> (i == 8) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="5001"><td class="num" id="LN5001">5001</td><td class="line">            i++;</td></tr>
<tr class="codeline" data-linenumber="5002"><td class="num" id="LN5002">5002</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5003"><td class="num" id="LN5003">5003</td><td class="line">        <span class='keyword'>if</span> (i == 7) link_status = line;</td></tr>
<tr class="codeline" data-linenumber="5004"><td class="num" id="LN5004">5004</td><td class="line">        <span class='keyword'>if</span> (nodename == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> || addr == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> || flags == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> ||</td></tr>
<tr class="codeline" data-linenumber="5005"><td class="num" id="LN5005">5005</td><td class="line">            link_status == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="5006"><td class="num" id="LN5006">5006</td><td class="line">        <span class='keyword'>if</span> (strstr(flags, <span class='string_literal'>"myself"</span>) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="5007"><td class="num" id="LN5007">5007</td><td class="line">        <span class='keyword'>int</span> disconnected = ((strstr(flags, <span class='string_literal'>"disconnected"</span>) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) ||</td></tr>
<tr class="codeline" data-linenumber="5008"><td class="num" id="LN5008">5008</td><td class="line">                            (strstr(link_status, <span class='string_literal'>"disconnected"</span>)));</td></tr>
<tr class="codeline" data-linenumber="5009"><td class="num" id="LN5009">5009</td><td class="line">        <span class='keyword'>int</span> handshaking = (strstr(flags, <span class='string_literal'>"handshake"</span>) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5010"><td class="num" id="LN5010">5010</td><td class="line">        <span class='keyword'>if</span> (disconnected || handshaking) {</td></tr>
<tr class="codeline" data-linenumber="5011"><td class="num" id="LN5011">5011</td><td class="line">            clusterManagerLink *link = zmalloc(<span class='keyword'>sizeof</span>(*link));</td></tr>
<tr class="codeline" data-linenumber="5012"><td class="num" id="LN5012">5012</td><td class="line">            link-&gt;node_name = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(nodename);</td></tr>
<tr class="codeline" data-linenumber="5013"><td class="num" id="LN5013">5013</td><td class="line">            link-&gt;node_addr = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(addr);</td></tr>
<tr class="codeline" data-linenumber="5014"><td class="num" id="LN5014">5014</td><td class="line">            link-&gt;connected = 0;</td></tr>
<tr class="codeline" data-linenumber="5015"><td class="num" id="LN5015">5015</td><td class="line">            link-&gt;handshaking = handshaking;</td></tr>
<tr class="codeline" data-linenumber="5016"><td class="num" id="LN5016">5016</td><td class="line">            listAddNodeTail(links, link);</td></tr>
<tr class="codeline" data-linenumber="5017"><td class="num" id="LN5017">5017</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5018"><td class="num" id="LN5018">5018</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5019"><td class="num" id="LN5019">5019</td><td class="line">cleanup:</td></tr>
<tr class="codeline" data-linenumber="5020"><td class="num" id="LN5020">5020</td><td class="line">    <span class='keyword'>if</span> (reply != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="5021"><td class="num" id="LN5021">5021</td><td class="line">    <span class='keyword'>return</span> links;</td></tr>
<tr class="codeline" data-linenumber="5022"><td class="num" id="LN5022">5022</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5023"><td class="num" id="LN5023">5023</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5024"><td class="num" id="LN5024">5024</td><td class="line"><span class='comment'>/* Check for disconnected cluster links. It returns a dict whose keys</span></td></tr>
<tr class="codeline" data-linenumber="5025"><td class="num" id="LN5025">5025</td><td class="line"> <span class='comment'>* are the unreachable node addresses and the values are lists of</span></td></tr>
<tr class="codeline" data-linenumber="5026"><td class="num" id="LN5026">5026</td><td class="line"> <span class='comment'>* node addresses that cannot reach the unreachable node. */</span></td></tr>
<tr class="codeline" data-linenumber="5027"><td class="num" id="LN5027">5027</td><td class="line"><span class='keyword'>static</span> dict *clusterManagerGetLinkStatus(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="5028"><td class="num" id="LN5028">5028</td><td class="line">    <span class='keyword'>if</span> (cluster_manager.nodes == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5029"><td class="num" id="LN5029">5029</td><td class="line">    dict *status = dictCreate(&amp;clusterManagerLinkDictType);</td></tr>
<tr class="codeline" data-linenumber="5030"><td class="num" id="LN5030">5030</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="5031"><td class="num" id="LN5031">5031</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="5032"><td class="num" id="LN5032">5032</td><td class="line">    listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="5033"><td class="num" id="LN5033">5033</td><td class="line">    <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5034"><td class="num" id="LN5034">5034</td><td class="line">        clusterManagerNode *node = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5035"><td class="num" id="LN5035">5035</td><td class="line">        list *links = clusterManagerGetDisconnectedLinks(node);</td></tr>
<tr class="codeline" data-linenumber="5036"><td class="num" id="LN5036">5036</td><td class="line">        <span class='keyword'>if</span> (links) {</td></tr>
<tr class="codeline" data-linenumber="5037"><td class="num" id="LN5037">5037</td><td class="line">            listIter lli;</td></tr>
<tr class="codeline" data-linenumber="5038"><td class="num" id="LN5038">5038</td><td class="line">            listNode *lln;</td></tr>
<tr class="codeline" data-linenumber="5039"><td class="num" id="LN5039">5039</td><td class="line">            listRewind(links, &amp;lli);</td></tr>
<tr class="codeline" data-linenumber="5040"><td class="num" id="LN5040">5040</td><td class="line">            <span class='keyword'>while</span> ((lln = listNext(&amp;lli)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5041"><td class="num" id="LN5041">5041</td><td class="line">                clusterManagerLink *link = lln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5042"><td class="num" id="LN5042">5042</td><td class="line">                list *from = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5043"><td class="num" id="LN5043">5043</td><td class="line">                dictEntry *entry = dictFind(status, link-&gt;node_addr);</td></tr>
<tr class="codeline" data-linenumber="5044"><td class="num" id="LN5044">5044</td><td class="line">                <span class='keyword'>if</span> (entry) from = <span class='macro'>dictGetVal(entry)<span class='macro_popup'>((entry)-&gt;v.val)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5045"><td class="num" id="LN5045">5045</td><td class="line">                <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="5046"><td class="num" id="LN5046">5046</td><td class="line">                    from = listCreate();</td></tr>
<tr class="codeline" data-linenumber="5047"><td class="num" id="LN5047">5047</td><td class="line">                    dictAdd(status, <span class='macro'>sdsdup<span class='macro_popup'>hi_sdsdup</span></span>(link-&gt;node_addr), from);</td></tr>
<tr class="codeline" data-linenumber="5048"><td class="num" id="LN5048">5048</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="5049"><td class="num" id="LN5049">5049</td><td class="line">                <span class='macro'>sds<span class='macro_popup'>hisds</span></span> myaddr = <span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>();</td></tr>
<tr class="codeline" data-linenumber="5050"><td class="num" id="LN5050">5050</td><td class="line">                myaddr = <span class='macro'>sdscatfmt<span class='macro_popup'>hi_sdscatfmt</span></span>(myaddr, <span class='string_literal'>"%s:%u"</span>, node-&gt;ip, node-&gt;port);</td></tr>
<tr class="codeline" data-linenumber="5051"><td class="num" id="LN5051">5051</td><td class="line">                listAddNodeTail(from, myaddr);</td></tr>
<tr class="codeline" data-linenumber="5052"><td class="num" id="LN5052">5052</td><td class="line">                <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(link-&gt;node_name);</td></tr>
<tr class="codeline" data-linenumber="5053"><td class="num" id="LN5053">5053</td><td class="line">                <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(link-&gt;node_addr);</td></tr>
<tr class="codeline" data-linenumber="5054"><td class="num" id="LN5054">5054</td><td class="line">                zfree(link);</td></tr>
<tr class="codeline" data-linenumber="5055"><td class="num" id="LN5055">5055</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="5056"><td class="num" id="LN5056">5056</td><td class="line">            listRelease(links);</td></tr>
<tr class="codeline" data-linenumber="5057"><td class="num" id="LN5057">5057</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5058"><td class="num" id="LN5058">5058</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5059"><td class="num" id="LN5059">5059</td><td class="line">    <span class='keyword'>return</span> status;</td></tr>
<tr class="codeline" data-linenumber="5060"><td class="num" id="LN5060">5060</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5061"><td class="num" id="LN5061">5061</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5062"><td class="num" id="LN5062">5062</td><td class="line"><span class='comment'>/* Add the error string to cluster_manager.errors and print it. */</span></td></tr>
<tr class="codeline" data-linenumber="5063"><td class="num" id="LN5063">5063</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> clusterManagerOnError(<span class='macro'>sds<span class='macro_popup'>hisds</span></span> err) {</td></tr>
<tr class="codeline" data-linenumber="5064"><td class="num" id="LN5064">5064</td><td class="line">    <span class='keyword'>if</span> (cluster_manager.errors == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5065"><td class="num" id="LN5065">5065</td><td class="line">        cluster_manager.errors = listCreate();</td></tr>
<tr class="codeline" data-linenumber="5066"><td class="num" id="LN5066">5066</td><td class="line">    listAddNodeTail(cluster_manager.errors, err);</td></tr>
<tr class="codeline" data-linenumber="5067"><td class="num" id="LN5067">5067</td><td class="line">    <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"%s\n"</span>, (<span class='keyword'>char</span> *) err)<span class='macro_popup'>clusterManagerLog(3,"%s\n", (char *) err)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5068"><td class="num" id="LN5068">5068</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5069"><td class="num" id="LN5069">5069</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5070"><td class="num" id="LN5070">5070</td><td class="line"><span class='comment'>/* Check the slots coverage of the cluster. The 'all_slots' argument must be</span></td></tr>
<tr class="codeline" data-linenumber="5071"><td class="num" id="LN5071">5071</td><td class="line"> <span class='comment'>* and array of 16384 bytes. Every covered slot will be set to 1 in the</span></td></tr>
<tr class="codeline" data-linenumber="5072"><td class="num" id="LN5072">5072</td><td class="line"> <span class='comment'>* 'all_slots' array. The function returns the total number if covered slots.*/</span></td></tr>
<tr class="codeline" data-linenumber="5073"><td class="num" id="LN5073">5073</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerGetCoveredSlots(<span class='keyword'>char</span> *all_slots) {</td></tr>
<tr class="codeline" data-linenumber="5074"><td class="num" id="LN5074">5074</td><td class="line">    <span class='keyword'>if</span> (cluster_manager.nodes == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="5075"><td class="num" id="LN5075">5075</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="5076"><td class="num" id="LN5076">5076</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="5077"><td class="num" id="LN5077">5077</td><td class="line">    listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="5078"><td class="num" id="LN5078">5078</td><td class="line">    <span class='keyword'>int</span> totslots = 0, i;</td></tr>
<tr class="codeline" data-linenumber="5079"><td class="num" id="LN5079">5079</td><td class="line">    <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5080"><td class="num" id="LN5080">5080</td><td class="line">        clusterManagerNode *node = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5081"><td class="num" id="LN5081">5081</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; <span class='macro'>CLUSTER_MANAGER_SLOTS<span class='macro_popup'>16384</span></span>; i++) {</td></tr>
<tr class="codeline" data-linenumber="5082"><td class="num" id="LN5082">5082</td><td class="line">            <span class='keyword'>if</span> (node-&gt;slots[i] &amp;&amp; !all_slots[i]) {</td></tr>
<tr class="codeline" data-linenumber="5083"><td class="num" id="LN5083">5083</td><td class="line">                all_slots[i] = 1;</td></tr>
<tr class="codeline" data-linenumber="5084"><td class="num" id="LN5084">5084</td><td class="line">                totslots++;</td></tr>
<tr class="codeline" data-linenumber="5085"><td class="num" id="LN5085">5085</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="5086"><td class="num" id="LN5086">5086</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5087"><td class="num" id="LN5087">5087</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5088"><td class="num" id="LN5088">5088</td><td class="line">    <span class='keyword'>return</span> totslots;</td></tr>
<tr class="codeline" data-linenumber="5089"><td class="num" id="LN5089">5089</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5090"><td class="num" id="LN5090">5090</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5091"><td class="num" id="LN5091">5091</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> clusterManagerPrintSlotsList(list *slots) {</td></tr>
<tr class="codeline" data-linenumber="5092"><td class="num" id="LN5092">5092</td><td class="line">    clusterManagerNode n = {0};</td></tr>
<tr class="codeline" data-linenumber="5093"><td class="num" id="LN5093">5093</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="5094"><td class="num" id="LN5094">5094</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="5095"><td class="num" id="LN5095">5095</td><td class="line">    listRewind(slots, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="5096"><td class="num" id="LN5096">5096</td><td class="line">    <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5097"><td class="num" id="LN5097">5097</td><td class="line">        <span class='keyword'>int</span> slot = atoi(ln-&gt;value);</td></tr>
<tr class="codeline" data-linenumber="5098"><td class="num" id="LN5098">5098</td><td class="line">        <span class='keyword'>if</span> (slot &gt;= 0 &amp;&amp; slot &lt; <span class='macro'>CLUSTER_MANAGER_SLOTS<span class='macro_popup'>16384</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5099"><td class="num" id="LN5099">5099</td><td class="line">            n.slots[slot] = 1;</td></tr>
<tr class="codeline" data-linenumber="5100"><td class="num" id="LN5100">5100</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5101"><td class="num" id="LN5101">5101</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> nodeslist = clusterManagerNodeSlotsString(&amp;n);</td></tr>
<tr class="codeline" data-linenumber="5102"><td class="num" id="LN5102">5102</td><td class="line">    printf(<span class='string_literal'>"%s\n"</span>, nodeslist);</td></tr>
<tr class="codeline" data-linenumber="5103"><td class="num" id="LN5103">5103</td><td class="line">    <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(nodeslist);</td></tr>
<tr class="codeline" data-linenumber="5104"><td class="num" id="LN5104">5104</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5105"><td class="num" id="LN5105">5105</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5106"><td class="num" id="LN5106">5106</td><td class="line"><span class='comment'>/* Return the node, among 'nodes' with the greatest number of keys</span></td></tr>
<tr class="codeline" data-linenumber="5107"><td class="num" id="LN5107">5107</td><td class="line"> <span class='comment'>* in the specified slot. */</span></td></tr>
<tr class="codeline" data-linenumber="5108"><td class="num" id="LN5108">5108</td><td class="line"><span class='keyword'>static</span> clusterManagerNode * clusterManagerGetNodeWithMostKeysInSlot(list *nodes,</td></tr>
<tr class="codeline" data-linenumber="5109"><td class="num" id="LN5109">5109</td><td class="line">                                                                    <span class='keyword'>int</span> slot,</td></tr>
<tr class="codeline" data-linenumber="5110"><td class="num" id="LN5110">5110</td><td class="line">                                                                    <span class='keyword'>char</span> **err)</td></tr>
<tr class="codeline" data-linenumber="5111"><td class="num" id="LN5111">5111</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="5112"><td class="num" id="LN5112">5112</td><td class="line">    clusterManagerNode *node = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5113"><td class="num" id="LN5113">5113</td><td class="line">    <span class='keyword'>int</span> numkeys = 0;</td></tr>
<tr class="codeline" data-linenumber="5114"><td class="num" id="LN5114">5114</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="5115"><td class="num" id="LN5115">5115</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="5116"><td class="num" id="LN5116">5116</td><td class="line">    listRewind(nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="5117"><td class="num" id="LN5117">5117</td><td class="line">    <span class='keyword'>if</span> (err) *err = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5118"><td class="num" id="LN5118">5118</td><td class="line">    <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5119"><td class="num" id="LN5119">5119</td><td class="line">        clusterManagerNode *n = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5120"><td class="num" id="LN5120">5120</td><td class="line">        <span class='keyword'>if</span> (n-&gt;flags &amp; <span class='macro'>CLUSTER_MANAGER_FLAG_SLAVE<span class='macro_popup'>1 &lt;&lt; 1</span></span> || n-&gt;replicate)</td></tr>
<tr class="codeline" data-linenumber="5121"><td class="num" id="LN5121">5121</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="5122"><td class="num" id="LN5122">5122</td><td class="line">        redisReply *r =</td></tr>
<tr class="codeline" data-linenumber="5123"><td class="num" id="LN5123">5123</td><td class="line">            <span class='macro'>CLUSTER_MANAGER_COMMAND(n, <span class='string_literal'>"CLUSTER COUNTKEYSINSLOT %d"</span>, slot)<span class='macro_popup'>(redisCommand(n-&gt;context, "CLUSTER COUNTKEYSINSLOT %d", slot<br>))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5124"><td class="num" id="LN5124">5124</td><td class="line">        <span class='keyword'>int</span> success = clusterManagerCheckRedisReply(n, r, err);</td></tr>
<tr class="codeline" data-linenumber="5125"><td class="num" id="LN5125">5125</td><td class="line">        <span class='keyword'>if</span> (success) {</td></tr>
<tr class="codeline" data-linenumber="5126"><td class="num" id="LN5126">5126</td><td class="line">            <span class='keyword'>if</span> (r-&gt;integer &gt; numkeys || node == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5127"><td class="num" id="LN5127">5127</td><td class="line">                numkeys = r-&gt;integer;</td></tr>
<tr class="codeline" data-linenumber="5128"><td class="num" id="LN5128">5128</td><td class="line">                node = n;</td></tr>
<tr class="codeline" data-linenumber="5129"><td class="num" id="LN5129">5129</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="5130"><td class="num" id="LN5130">5130</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5131"><td class="num" id="LN5131">5131</td><td class="line">        <span class='keyword'>if</span> (r != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) freeReplyObject(r);</td></tr>
<tr class="codeline" data-linenumber="5132"><td class="num" id="LN5132">5132</td><td class="line">        <span class='comment'>/* If the reply contains errors */</span></td></tr>
<tr class="codeline" data-linenumber="5133"><td class="num" id="LN5133">5133</td><td class="line">        <span class='keyword'>if</span> (!success) {</td></tr>
<tr class="codeline" data-linenumber="5134"><td class="num" id="LN5134">5134</td><td class="line">            <span class='keyword'>if</span> (err != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> &amp;&amp; *err != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5135"><td class="num" id="LN5135">5135</td><td class="line">                <span class='macro'>CLUSTER_MANAGER_PRINT_REPLY_ERROR(n, err)<span class='macro_popup'>clusterManagerLog(3,"Node %s:%d replied with error:\n%s\n", n<br>-&gt;ip, n-&gt;port, err);</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5136"><td class="num" id="LN5136">5136</td><td class="line">            node = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5137"><td class="num" id="LN5137">5137</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="5138"><td class="num" id="LN5138">5138</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5139"><td class="num" id="LN5139">5139</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5140"><td class="num" id="LN5140">5140</td><td class="line">    <span class='keyword'>return</span> node;</td></tr>
<tr class="codeline" data-linenumber="5141"><td class="num" id="LN5141">5141</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5142"><td class="num" id="LN5142">5142</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5143"><td class="num" id="LN5143">5143</td><td class="line"><span class='comment'>/* This function returns the master that has the least number of replicas</span></td></tr>
<tr class="codeline" data-linenumber="5144"><td class="num" id="LN5144">5144</td><td class="line"> <span class='comment'>* in the cluster. If there are multiple masters with the same smaller</span></td></tr>
<tr class="codeline" data-linenumber="5145"><td class="num" id="LN5145">5145</td><td class="line"> <span class='comment'>* number of replicas, one at random is returned. */</span></td></tr>
<tr class="codeline" data-linenumber="5146"><td class="num" id="LN5146">5146</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5147"><td class="num" id="LN5147">5147</td><td class="line"><span class='keyword'>static</span> clusterManagerNode *clusterManagerNodeWithLeastReplicas() {</td></tr>
<tr class="codeline" data-linenumber="5148"><td class="num" id="LN5148">5148</td><td class="line">    clusterManagerNode *node = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5149"><td class="num" id="LN5149">5149</td><td class="line">    <span class='keyword'>int</span> lowest_count = 0;</td></tr>
<tr class="codeline" data-linenumber="5150"><td class="num" id="LN5150">5150</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="5151"><td class="num" id="LN5151">5151</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="5152"><td class="num" id="LN5152">5152</td><td class="line">    listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="5153"><td class="num" id="LN5153">5153</td><td class="line">    <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5154"><td class="num" id="LN5154">5154</td><td class="line">        clusterManagerNode *n = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5155"><td class="num" id="LN5155">5155</td><td class="line">        <span class='keyword'>if</span> (n-&gt;flags &amp; <span class='macro'>CLUSTER_MANAGER_FLAG_SLAVE<span class='macro_popup'>1 &lt;&lt; 1</span></span>) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="5156"><td class="num" id="LN5156">5156</td><td class="line">        <span class='keyword'>if</span> (node == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> || n-&gt;replicas_count &lt; lowest_count) {</td></tr>
<tr class="codeline" data-linenumber="5157"><td class="num" id="LN5157">5157</td><td class="line">            node = n;</td></tr>
<tr class="codeline" data-linenumber="5158"><td class="num" id="LN5158">5158</td><td class="line">            lowest_count = n-&gt;replicas_count;</td></tr>
<tr class="codeline" data-linenumber="5159"><td class="num" id="LN5159">5159</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5160"><td class="num" id="LN5160">5160</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5161"><td class="num" id="LN5161">5161</td><td class="line">    <span class='keyword'>return</span> node;</td></tr>
<tr class="codeline" data-linenumber="5162"><td class="num" id="LN5162">5162</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5163"><td class="num" id="LN5163">5163</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5164"><td class="num" id="LN5164">5164</td><td class="line"><span class='comment'>/* This function returns a random master node, return NULL if none */</span></td></tr>
<tr class="codeline" data-linenumber="5165"><td class="num" id="LN5165">5165</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5166"><td class="num" id="LN5166">5166</td><td class="line"><span class='keyword'>static</span> clusterManagerNode *clusterManagerNodeMasterRandom() {</td></tr>
<tr class="codeline" data-linenumber="5167"><td class="num" id="LN5167">5167</td><td class="line">    <span class='keyword'>int</span> master_count = 0;</td></tr>
<tr class="codeline" data-linenumber="5168"><td class="num" id="LN5168">5168</td><td class="line">    <span class='keyword'>int</span> idx;</td></tr>
<tr class="codeline" data-linenumber="5169"><td class="num" id="LN5169">5169</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="5170"><td class="num" id="LN5170">5170</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="5171"><td class="num" id="LN5171">5171</td><td class="line">    listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="5172"><td class="num" id="LN5172">5172</td><td class="line">    <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5173"><td class="num" id="LN5173">5173</td><td class="line">        clusterManagerNode *n = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5174"><td class="num" id="LN5174">5174</td><td class="line">        <span class='keyword'>if</span> (n-&gt;flags &amp; <span class='macro'>CLUSTER_MANAGER_FLAG_SLAVE<span class='macro_popup'>1 &lt;&lt; 1</span></span>) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="5175"><td class="num" id="LN5175">5175</td><td class="line">        master_count++;</td></tr>
<tr class="codeline" data-linenumber="5176"><td class="num" id="LN5176">5176</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5177"><td class="num" id="LN5177">5177</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5178"><td class="num" id="LN5178">5178</td><td class="line">    <span class='macro'>assert(master_count &gt; 0)<span class='macro_popup'>((master_count &gt; 0) ? (void) (0) : __assert_fail ("master_count &gt; 0"<br>, "redis-cli.c", 5178, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5179"><td class="num" id="LN5179">5179</td><td class="line">    srand(time(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>));</td></tr>
<tr class="codeline" data-linenumber="5180"><td class="num" id="LN5180">5180</td><td class="line">    idx = rand() % master_count;</td></tr>
<tr class="codeline" data-linenumber="5181"><td class="num" id="LN5181">5181</td><td class="line">    listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="5182"><td class="num" id="LN5182">5182</td><td class="line">    <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5183"><td class="num" id="LN5183">5183</td><td class="line">        clusterManagerNode *n = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5184"><td class="num" id="LN5184">5184</td><td class="line">        <span class='keyword'>if</span> (n-&gt;flags &amp; <span class='macro'>CLUSTER_MANAGER_FLAG_SLAVE<span class='macro_popup'>1 &lt;&lt; 1</span></span>) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="5185"><td class="num" id="LN5185">5185</td><td class="line">        <span class='keyword'>if</span> (!idx--) {</td></tr>
<tr class="codeline" data-linenumber="5186"><td class="num" id="LN5186">5186</td><td class="line">            <span class='keyword'>return</span> n;</td></tr>
<tr class="codeline" data-linenumber="5187"><td class="num" id="LN5187">5187</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5188"><td class="num" id="LN5188">5188</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5189"><td class="num" id="LN5189">5189</td><td class="line">    <span class='comment'>/* Can not be reached */</span></td></tr>
<tr class="codeline" data-linenumber="5190"><td class="num" id="LN5190">5190</td><td class="line">    <span class='macro'>assert(0)<span class='macro_popup'>((0) ? (void) (0) : __assert_fail ("0", "redis-cli.c", 5190, __extension__<br> __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5191"><td class="num" id="LN5191">5191</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5192"><td class="num" id="LN5192">5192</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5193"><td class="num" id="LN5193">5193</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerFixSlotsCoverage(<span class='keyword'>char</span> *all_slots) {</td></tr>
<tr class="codeline" data-linenumber="5194"><td class="num" id="LN5194">5194</td><td class="line">    <span class='keyword'>int</span> force_fix = config.cluster_manager_command.flags &amp;</td></tr>
<tr class="codeline" data-linenumber="5195"><td class="num" id="LN5195">5195</td><td class="line">                    <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_FIX_WITH_UNREACHABLE_MASTERS<span class='macro_popup'>1 &lt;&lt; 10</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5196"><td class="num" id="LN5196">5196</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5197"><td class="num" id="LN5197">5197</td><td class="line">    <span class='keyword'>if</span> (cluster_manager.unreachable_masters &gt; 0 &amp;&amp; !force_fix) {</td></tr>
<tr class="codeline" data-linenumber="5198"><td class="num" id="LN5198">5198</td><td class="line">        <span class='macro'>clusterManagerLogWarn(<span class='string_literal'>"*** Fixing slots coverage with %d unreachable masters is dangerous: redis-cli will assume that slots about masters that are not reachable are not covered, and will try to reassign them to the reachable nodes. This can cause data loss and is rarely what you want to do. If you really want to proceed use the --cluster-fix-with-unreachable-masters option.\n"</span>, cluster_manager.unreachable_masters)<span class='macro_popup'>clusterManagerLog(2,"*** Fixing slots coverage with %d unreachable masters is dangerous: redis-cli will assume that slots about masters that are not reachable are not covered, and will try to reassign them to the reachable nodes. This can cause data loss and is rarely what you want to do. If you really want to proceed use the --cluster-fix-with-unreachable-masters option.\n"<br>, cluster_manager.unreachable_masters)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5199"><td class="num" id="LN5199">5199</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="5200"><td class="num" id="LN5200">5200</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5201"><td class="num" id="LN5201">5201</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5202"><td class="num" id="LN5202">5202</td><td class="line">    <span class='keyword'>int</span> i, fixed = 0;</td></tr>
<tr class="codeline" data-linenumber="5203"><td class="num" id="LN5203">5203</td><td class="line">    list *none = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, *single = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, *multi = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5204"><td class="num" id="LN5204">5204</td><td class="line">    <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Fixing slots coverage...\n"</span>)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Fixing slots coverage...\n"<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5205"><td class="num" id="LN5205">5205</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; <span class='macro'>CLUSTER_MANAGER_SLOTS<span class='macro_popup'>16384</span></span>; i++) {</td></tr>
<tr class="codeline" data-linenumber="5206"><td class="num" id="LN5206">5206</td><td class="line">        <span class='keyword'>int</span> covered = all_slots[i];</td></tr>
<tr class="codeline" data-linenumber="5207"><td class="num" id="LN5207">5207</td><td class="line">        <span class='keyword'>if</span> (!covered) {</td></tr>
<tr class="codeline" data-linenumber="5208"><td class="num" id="LN5208">5208</td><td class="line">            <span class='macro'>sds<span class='macro_popup'>hisds</span></span> slot = <span class='macro'>sdsfromlonglong<span class='macro_popup'>hi_sdsfromlonglong</span></span>((<span class='keyword'>long</span> <span class='keyword'>long</span>) i);</td></tr>
<tr class="codeline" data-linenumber="5209"><td class="num" id="LN5209">5209</td><td class="line">            list *slot_nodes = listCreate();</td></tr>
<tr class="codeline" data-linenumber="5210"><td class="num" id="LN5210">5210</td><td class="line">            <span class='macro'>sds<span class='macro_popup'>hisds</span></span> slot_nodes_str = <span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>();</td></tr>
<tr class="codeline" data-linenumber="5211"><td class="num" id="LN5211">5211</td><td class="line">            listIter li;</td></tr>
<tr class="codeline" data-linenumber="5212"><td class="num" id="LN5212">5212</td><td class="line">            listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="5213"><td class="num" id="LN5213">5213</td><td class="line">            listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="5214"><td class="num" id="LN5214">5214</td><td class="line">            <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5215"><td class="num" id="LN5215">5215</td><td class="line">                clusterManagerNode *n = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5216"><td class="num" id="LN5216">5216</td><td class="line">                <span class='keyword'>if</span> (n-&gt;flags &amp; <span class='macro'>CLUSTER_MANAGER_FLAG_SLAVE<span class='macro_popup'>1 &lt;&lt; 1</span></span> || n-&gt;replicate)</td></tr>
<tr class="codeline" data-linenumber="5217"><td class="num" id="LN5217">5217</td><td class="line">                    <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="5218"><td class="num" id="LN5218">5218</td><td class="line">                redisReply *reply = <span class='macro'>CLUSTER_MANAGER_COMMAND(n,<span class='macro_popup'>(redisCommand(n-&gt;context, "CLUSTER GETKEYSINSLOT %d %d", i<br>, 1))</span></span></td></tr>
<tr class="codeline" data-linenumber="5219"><td class="num" id="LN5219">5219</td><td class="line">                    <span class='string_literal'><span class='macro'>"CLUSTER GETKEYSINSLOT %d %d"</span>, i, 1)<span class='macro_popup'>(redisCommand(n-&gt;context, "CLUSTER GETKEYSINSLOT %d %d", i<br>, 1))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5220"><td class="num" id="LN5220">5220</td><td class="line">                <span class='keyword'>if</span> (!clusterManagerCheckRedisReply(n, reply, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="5221"><td class="num" id="LN5221">5221</td><td class="line">                    fixed = -1;</td></tr>
<tr class="codeline" data-linenumber="5222"><td class="num" id="LN5222">5222</td><td class="line">                    <span class='keyword'>if</span> (reply) freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="5223"><td class="num" id="LN5223">5223</td><td class="line">                    <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="5224"><td class="num" id="LN5224">5224</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="5225"><td class="num" id="LN5225">5225</td><td class="line">                <span class='macro'>assert(reply-&gt;type == REDIS_REPLY_ARRAY)<span class='macro_popup'>((reply-&gt;type == 2) ? (void) (0) : __assert_fail ("reply-&gt;type == REDIS_REPLY_ARRAY"<br>, "redis-cli.c", 5225, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5226"><td class="num" id="LN5226">5226</td><td class="line">                <span class='keyword'>if</span> (reply-&gt;elements &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="5227"><td class="num" id="LN5227">5227</td><td class="line">                    listAddNodeTail(slot_nodes, n);</td></tr>
<tr class="codeline" data-linenumber="5228"><td class="num" id="LN5228">5228</td><td class="line">                    <span class='keyword'>if</span> (<span class='macro'>listLength(slot_nodes)<span class='macro_popup'>((slot_nodes)-&gt;len)</span></span> &gt; 1)</td></tr>
<tr class="codeline" data-linenumber="5229"><td class="num" id="LN5229">5229</td><td class="line">                        slot_nodes_str = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(slot_nodes_str, <span class='string_literal'>", "</span>);</td></tr>
<tr class="codeline" data-linenumber="5230"><td class="num" id="LN5230">5230</td><td class="line">                    slot_nodes_str = <span class='macro'>sdscatfmt<span class='macro_popup'>hi_sdscatfmt</span></span>(slot_nodes_str,</td></tr>
<tr class="codeline" data-linenumber="5231"><td class="num" id="LN5231">5231</td><td class="line">                                               <span class='string_literal'>"%s:%u"</span>, n-&gt;ip, n-&gt;port);</td></tr>
<tr class="codeline" data-linenumber="5232"><td class="num" id="LN5232">5232</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="5233"><td class="num" id="LN5233">5233</td><td class="line">                freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="5234"><td class="num" id="LN5234">5234</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="5235"><td class="num" id="LN5235">5235</td><td class="line">            <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(slot_nodes_str);</td></tr>
<tr class="codeline" data-linenumber="5236"><td class="num" id="LN5236">5236</td><td class="line">            dictAdd(clusterManagerUncoveredSlots, slot, slot_nodes);</td></tr>
<tr class="codeline" data-linenumber="5237"><td class="num" id="LN5237">5237</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5238"><td class="num" id="LN5238">5238</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5239"><td class="num" id="LN5239">5239</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5240"><td class="num" id="LN5240">5240</td><td class="line">    <span class='comment'>/* For every slot, take action depending on the actual condition:</span></td></tr>
<tr class="codeline" data-linenumber="5241"><td class="num" id="LN5241">5241</td><td class="line">     <span class='comment'>* 1) No node has keys for this slot.</span></td></tr>
<tr class="codeline" data-linenumber="5242"><td class="num" id="LN5242">5242</td><td class="line">     <span class='comment'>* 2) A single node has keys for this slot.</span></td></tr>
<tr class="codeline" data-linenumber="5243"><td class="num" id="LN5243">5243</td><td class="line">     <span class='comment'>* 3) Multiple nodes have keys for this slot. */</span></td></tr>
<tr class="codeline" data-linenumber="5244"><td class="num" id="LN5244">5244</td><td class="line">    none = listCreate();</td></tr>
<tr class="codeline" data-linenumber="5245"><td class="num" id="LN5245">5245</td><td class="line">    single = listCreate();</td></tr>
<tr class="codeline" data-linenumber="5246"><td class="num" id="LN5246">5246</td><td class="line">    multi = listCreate();</td></tr>
<tr class="codeline" data-linenumber="5247"><td class="num" id="LN5247">5247</td><td class="line">    dictIterator *iter = dictGetIterator(clusterManagerUncoveredSlots);</td></tr>
<tr class="codeline" data-linenumber="5248"><td class="num" id="LN5248">5248</td><td class="line">    dictEntry *entry;</td></tr>
<tr class="codeline" data-linenumber="5249"><td class="num" id="LN5249">5249</td><td class="line">    <span class='keyword'>while</span> ((entry = dictNext(iter)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5250"><td class="num" id="LN5250">5250</td><td class="line">        <span class='macro'>sds<span class='macro_popup'>hisds</span></span> slot = (<span class='macro'>sds<span class='macro_popup'>hisds</span></span>) <span class='macro'>dictGetKey(entry)<span class='macro_popup'>((entry)-&gt;key)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5251"><td class="num" id="LN5251">5251</td><td class="line">        list *nodes = (list *) <span class='macro'>dictGetVal(entry)<span class='macro_popup'>((entry)-&gt;v.val)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5252"><td class="num" id="LN5252">5252</td><td class="line">        <span class='keyword'>switch</span> (<span class='macro'>listLength(nodes)<span class='macro_popup'>((nodes)-&gt;len)</span></span>){</td></tr>
<tr class="codeline" data-linenumber="5253"><td class="num" id="LN5253">5253</td><td class="line">        <span class='keyword'>case</span> 0: listAddNodeTail(none, slot); <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="5254"><td class="num" id="LN5254">5254</td><td class="line">        <span class='keyword'>case</span> 1: listAddNodeTail(single, slot); <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="5255"><td class="num" id="LN5255">5255</td><td class="line">        <span class='keyword'>default</span>: listAddNodeTail(multi, slot); <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="5256"><td class="num" id="LN5256">5256</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5257"><td class="num" id="LN5257">5257</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5258"><td class="num" id="LN5258">5258</td><td class="line">    dictReleaseIterator(iter);</td></tr>
<tr class="codeline" data-linenumber="5259"><td class="num" id="LN5259">5259</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5260"><td class="num" id="LN5260">5260</td><td class="line">    <span class='comment'>/* we want explicit manual confirmation from users for all the fix cases */</span></td></tr>
<tr class="codeline" data-linenumber="5261"><td class="num" id="LN5261">5261</td><td class="line">    <span class='keyword'>int</span> ignore_force = 1;</td></tr>
<tr class="codeline" data-linenumber="5262"><td class="num" id="LN5262">5262</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5263"><td class="num" id="LN5263">5263</td><td class="line">    <span class='comment'>/*  Handle case "1": keys in no node. */</span></td></tr>
<tr class="codeline" data-linenumber="5264"><td class="num" id="LN5264">5264</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>listLength(none)<span class='macro_popup'>((none)-&gt;len)</span></span> &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="5265"><td class="num" id="LN5265">5265</td><td class="line">        printf(<span class='string_literal'>"The following uncovered slots have no keys "</span></td></tr>
<tr class="codeline" data-linenumber="5266"><td class="num" id="LN5266">5266</td><td class="line">               <span class='string_literal'>"across the cluster:\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="5267"><td class="num" id="LN5267">5267</td><td class="line">        clusterManagerPrintSlotsList(none);</td></tr>
<tr class="codeline" data-linenumber="5268"><td class="num" id="LN5268">5268</td><td class="line">        <span class='keyword'>if</span> (confirmWithYes(<span class='string_literal'>"Fix these slots by covering with a random node?"</span>,</td></tr>
<tr class="codeline" data-linenumber="5269"><td class="num" id="LN5269">5269</td><td class="line">                           ignore_force)) {</td></tr>
<tr class="codeline" data-linenumber="5270"><td class="num" id="LN5270">5270</td><td class="line">            listIter li;</td></tr>
<tr class="codeline" data-linenumber="5271"><td class="num" id="LN5271">5271</td><td class="line">            listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="5272"><td class="num" id="LN5272">5272</td><td class="line">            listRewind(none, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="5273"><td class="num" id="LN5273">5273</td><td class="line">            <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5274"><td class="num" id="LN5274">5274</td><td class="line">                <span class='macro'>sds<span class='macro_popup'>hisds</span></span> slot = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5275"><td class="num" id="LN5275">5275</td><td class="line">                <span class='keyword'>int</span> s = atoi(slot);</td></tr>
<tr class="codeline" data-linenumber="5276"><td class="num" id="LN5276">5276</td><td class="line">                clusterManagerNode *n = clusterManagerNodeMasterRandom();</td></tr>
<tr class="codeline" data-linenumber="5277"><td class="num" id="LN5277">5277</td><td class="line">                <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Covering slot %s with %s:%d\n"</span>,<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Covering slot %s with %s:%d\n"<br>, slot, n-&gt;ip, n-&gt;port)</span></span></td></tr>
<tr class="codeline" data-linenumber="5278"><td class="num" id="LN5278">5278</td><td class="line">                                      <span class='macro'>slot, n-&gt;ip, n-&gt;port)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Covering slot %s with %s:%d\n"<br>, slot, n-&gt;ip, n-&gt;port)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5279"><td class="num" id="LN5279">5279</td><td class="line">                <span class='keyword'>if</span> (!clusterManagerSetSlotOwner(n, s, 0)) {</td></tr>
<tr class="codeline" data-linenumber="5280"><td class="num" id="LN5280">5280</td><td class="line">                    fixed = -1;</td></tr>
<tr class="codeline" data-linenumber="5281"><td class="num" id="LN5281">5281</td><td class="line">                    <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="5282"><td class="num" id="LN5282">5282</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="5283"><td class="num" id="LN5283">5283</td><td class="line">                <span class='comment'>/* Since CLUSTER ADDSLOTS succeeded, we also update the slot</span></td></tr>
<tr class="codeline" data-linenumber="5284"><td class="num" id="LN5284">5284</td><td class="line">                 <span class='comment'>* info into the node struct, in order to keep it synced */</span></td></tr>
<tr class="codeline" data-linenumber="5285"><td class="num" id="LN5285">5285</td><td class="line">                n-&gt;slots[s] = 1;</td></tr>
<tr class="codeline" data-linenumber="5286"><td class="num" id="LN5286">5286</td><td class="line">                fixed++;</td></tr>
<tr class="codeline" data-linenumber="5287"><td class="num" id="LN5287">5287</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="5288"><td class="num" id="LN5288">5288</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5289"><td class="num" id="LN5289">5289</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5290"><td class="num" id="LN5290">5290</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5291"><td class="num" id="LN5291">5291</td><td class="line">    <span class='comment'>/*  Handle case "2": keys only in one node. */</span></td></tr>
<tr class="codeline" data-linenumber="5292"><td class="num" id="LN5292">5292</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>listLength(single)<span class='macro_popup'>((single)-&gt;len)</span></span> &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="5293"><td class="num" id="LN5293">5293</td><td class="line">        printf(<span class='string_literal'>"The following uncovered slots have keys in just one node:\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="5294"><td class="num" id="LN5294">5294</td><td class="line">        clusterManagerPrintSlotsList(single);</td></tr>
<tr class="codeline" data-linenumber="5295"><td class="num" id="LN5295">5295</td><td class="line">        <span class='keyword'>if</span> (confirmWithYes(<span class='string_literal'>"Fix these slots by covering with those nodes?"</span>,</td></tr>
<tr class="codeline" data-linenumber="5296"><td class="num" id="LN5296">5296</td><td class="line">                           ignore_force)) {</td></tr>
<tr class="codeline" data-linenumber="5297"><td class="num" id="LN5297">5297</td><td class="line">            listIter li;</td></tr>
<tr class="codeline" data-linenumber="5298"><td class="num" id="LN5298">5298</td><td class="line">            listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="5299"><td class="num" id="LN5299">5299</td><td class="line">            listRewind(single, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="5300"><td class="num" id="LN5300">5300</td><td class="line">            <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5301"><td class="num" id="LN5301">5301</td><td class="line">                <span class='macro'>sds<span class='macro_popup'>hisds</span></span> slot = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5302"><td class="num" id="LN5302">5302</td><td class="line">                <span class='keyword'>int</span> s = atoi(slot);</td></tr>
<tr class="codeline" data-linenumber="5303"><td class="num" id="LN5303">5303</td><td class="line">                dictEntry *entry = dictFind(clusterManagerUncoveredSlots, slot);</td></tr>
<tr class="codeline" data-linenumber="5304"><td class="num" id="LN5304">5304</td><td class="line">                <span class='macro'>assert(entry != NULL)<span class='macro_popup'>((entry != ((void*)0)) ? (void) (0) : __assert_fail ("entry != NULL"<br>, "redis-cli.c", 5304, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5305"><td class="num" id="LN5305">5305</td><td class="line">                list *nodes = (list *) <span class='macro'>dictGetVal(entry)<span class='macro_popup'>((entry)-&gt;v.val)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5306"><td class="num" id="LN5306">5306</td><td class="line">                listNode *fn = <span class='macro'>listFirst(nodes)<span class='macro_popup'>((nodes)-&gt;head)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5307"><td class="num" id="LN5307">5307</td><td class="line">                <span class='macro'>assert(fn != NULL)<span class='macro_popup'>((fn != ((void*)0)) ? (void) (0) : __assert_fail ("fn != NULL"<br>, "redis-cli.c", 5307, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5308"><td class="num" id="LN5308">5308</td><td class="line">                clusterManagerNode *n = fn-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5309"><td class="num" id="LN5309">5309</td><td class="line">                <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Covering slot %s with %s:%d\n"</span>,<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Covering slot %s with %s:%d\n"<br>, slot, n-&gt;ip, n-&gt;port)</span></span></td></tr>
<tr class="codeline" data-linenumber="5310"><td class="num" id="LN5310">5310</td><td class="line">                                      <span class='macro'>slot, n-&gt;ip, n-&gt;port)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Covering slot %s with %s:%d\n"<br>, slot, n-&gt;ip, n-&gt;port)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5311"><td class="num" id="LN5311">5311</td><td class="line">                <span class='keyword'>if</span> (!clusterManagerSetSlotOwner(n, s, 0)) {</td></tr>
<tr class="codeline" data-linenumber="5312"><td class="num" id="LN5312">5312</td><td class="line">                    fixed = -1;</td></tr>
<tr class="codeline" data-linenumber="5313"><td class="num" id="LN5313">5313</td><td class="line">                    <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="5314"><td class="num" id="LN5314">5314</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="5315"><td class="num" id="LN5315">5315</td><td class="line">                <span class='comment'>/* Since CLUSTER ADDSLOTS succeeded, we also update the slot</span></td></tr>
<tr class="codeline" data-linenumber="5316"><td class="num" id="LN5316">5316</td><td class="line">                 <span class='comment'>* info into the node struct, in order to keep it synced */</span></td></tr>
<tr class="codeline" data-linenumber="5317"><td class="num" id="LN5317">5317</td><td class="line">                n-&gt;slots[atoi(slot)] = 1;</td></tr>
<tr class="codeline" data-linenumber="5318"><td class="num" id="LN5318">5318</td><td class="line">                fixed++;</td></tr>
<tr class="codeline" data-linenumber="5319"><td class="num" id="LN5319">5319</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="5320"><td class="num" id="LN5320">5320</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5321"><td class="num" id="LN5321">5321</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5322"><td class="num" id="LN5322">5322</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5323"><td class="num" id="LN5323">5323</td><td class="line">    <span class='comment'>/* Handle case "3": keys in multiple nodes. */</span></td></tr>
<tr class="codeline" data-linenumber="5324"><td class="num" id="LN5324">5324</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>listLength(multi)<span class='macro_popup'>((multi)-&gt;len)</span></span> &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="5325"><td class="num" id="LN5325">5325</td><td class="line">        printf(<span class='string_literal'>"The following uncovered slots have keys in multiple nodes:\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="5326"><td class="num" id="LN5326">5326</td><td class="line">        clusterManagerPrintSlotsList(multi);</td></tr>
<tr class="codeline" data-linenumber="5327"><td class="num" id="LN5327">5327</td><td class="line">        <span class='keyword'>if</span> (confirmWithYes(<span class='string_literal'>"Fix these slots by moving keys "</span></td></tr>
<tr class="codeline" data-linenumber="5328"><td class="num" id="LN5328">5328</td><td class="line">                           <span class='string_literal'>"into a single node?"</span>, ignore_force)) {</td></tr>
<tr class="codeline" data-linenumber="5329"><td class="num" id="LN5329">5329</td><td class="line">            listIter li;</td></tr>
<tr class="codeline" data-linenumber="5330"><td class="num" id="LN5330">5330</td><td class="line">            listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="5331"><td class="num" id="LN5331">5331</td><td class="line">            listRewind(multi, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="5332"><td class="num" id="LN5332">5332</td><td class="line">            <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5333"><td class="num" id="LN5333">5333</td><td class="line">                <span class='macro'>sds<span class='macro_popup'>hisds</span></span> slot = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5334"><td class="num" id="LN5334">5334</td><td class="line">                dictEntry *entry = dictFind(clusterManagerUncoveredSlots, slot);</td></tr>
<tr class="codeline" data-linenumber="5335"><td class="num" id="LN5335">5335</td><td class="line">                <span class='macro'>assert(entry != NULL)<span class='macro_popup'>((entry != ((void*)0)) ? (void) (0) : __assert_fail ("entry != NULL"<br>, "redis-cli.c", 5335, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5336"><td class="num" id="LN5336">5336</td><td class="line">                list *nodes = (list *) <span class='macro'>dictGetVal(entry)<span class='macro_popup'>((entry)-&gt;v.val)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5337"><td class="num" id="LN5337">5337</td><td class="line">                <span class='keyword'>int</span> s = atoi(slot);</td></tr>
<tr class="codeline" data-linenumber="5338"><td class="num" id="LN5338">5338</td><td class="line">                clusterManagerNode *target =</td></tr>
<tr class="codeline" data-linenumber="5339"><td class="num" id="LN5339">5339</td><td class="line">                    clusterManagerGetNodeWithMostKeysInSlot(nodes, s, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5340"><td class="num" id="LN5340">5340</td><td class="line">                <span class='keyword'>if</span> (target == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5341"><td class="num" id="LN5341">5341</td><td class="line">                    fixed = -1;</td></tr>
<tr class="codeline" data-linenumber="5342"><td class="num" id="LN5342">5342</td><td class="line">                    <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="5343"><td class="num" id="LN5343">5343</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="5344"><td class="num" id="LN5344">5344</td><td class="line">                <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Covering slot %s moving keys "<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Covering slot %s moving keys "<br> "to %s:%d\n", slot, target-&gt;ip, target-&gt;port)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="5345"><td class="num" id="LN5345">5345</td><td class="line">                                      <span class='string_literal'><span class='macro'>"to %s:%d\n"</span>, slot,<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Covering slot %s moving keys "<br> "to %s:%d\n", slot, target-&gt;ip, target-&gt;port)</span></span></td></tr>
<tr class="codeline" data-linenumber="5346"><td class="num" id="LN5346">5346</td><td class="line">                                      <span class='macro'>target-&gt;ip, target-&gt;port)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Covering slot %s moving keys "<br> "to %s:%d\n", slot, target-&gt;ip, target-&gt;port)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5347"><td class="num" id="LN5347">5347</td><td class="line">                <span class='keyword'>if</span> (!clusterManagerSetSlotOwner(target, s, 1)) {</td></tr>
<tr class="codeline" data-linenumber="5348"><td class="num" id="LN5348">5348</td><td class="line">                    fixed = -1;</td></tr>
<tr class="codeline" data-linenumber="5349"><td class="num" id="LN5349">5349</td><td class="line">                    <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="5350"><td class="num" id="LN5350">5350</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="5351"><td class="num" id="LN5351">5351</td><td class="line">                <span class='comment'>/* Since CLUSTER ADDSLOTS succeeded, we also update the slot</span></td></tr>
<tr class="codeline" data-linenumber="5352"><td class="num" id="LN5352">5352</td><td class="line">                 <span class='comment'>* info into the node struct, in order to keep it synced */</span></td></tr>
<tr class="codeline" data-linenumber="5353"><td class="num" id="LN5353">5353</td><td class="line">                target-&gt;slots[atoi(slot)] = 1;</td></tr>
<tr class="codeline" data-linenumber="5354"><td class="num" id="LN5354">5354</td><td class="line">                listIter nli;</td></tr>
<tr class="codeline" data-linenumber="5355"><td class="num" id="LN5355">5355</td><td class="line">                listNode *nln;</td></tr>
<tr class="codeline" data-linenumber="5356"><td class="num" id="LN5356">5356</td><td class="line">                listRewind(nodes, &amp;nli);</td></tr>
<tr class="codeline" data-linenumber="5357"><td class="num" id="LN5357">5357</td><td class="line">                <span class='keyword'>while</span> ((nln = listNext(&amp;nli)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5358"><td class="num" id="LN5358">5358</td><td class="line">                    clusterManagerNode *src = nln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5359"><td class="num" id="LN5359">5359</td><td class="line">                    <span class='keyword'>if</span> (src == target) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="5360"><td class="num" id="LN5360">5360</td><td class="line">                    <span class='comment'>/* Assign the slot to target node in the source node. */</span></td></tr>
<tr class="codeline" data-linenumber="5361"><td class="num" id="LN5361">5361</td><td class="line">                    <span class='keyword'>if</span> (!clusterManagerSetSlot(src, target, s, <span class='string_literal'>"NODE"</span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>))</td></tr>
<tr class="codeline" data-linenumber="5362"><td class="num" id="LN5362">5362</td><td class="line">                        fixed = -1;</td></tr>
<tr class="codeline" data-linenumber="5363"><td class="num" id="LN5363">5363</td><td class="line">                    <span class='keyword'>if</span> (fixed &lt; 0) <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="5364"><td class="num" id="LN5364">5364</td><td class="line">                    <span class='comment'>/* Set the source node in 'importing' state</span></td></tr>
<tr class="codeline" data-linenumber="5365"><td class="num" id="LN5365">5365</td><td class="line">                     <span class='comment'>* (even if we will actually migrate keys away)</span></td></tr>
<tr class="codeline" data-linenumber="5366"><td class="num" id="LN5366">5366</td><td class="line">                     <span class='comment'>* in order to avoid receiving redirections</span></td></tr>
<tr class="codeline" data-linenumber="5367"><td class="num" id="LN5367">5367</td><td class="line">                     <span class='comment'>* for MIGRATE. */</span></td></tr>
<tr class="codeline" data-linenumber="5368"><td class="num" id="LN5368">5368</td><td class="line">                    <span class='keyword'>if</span> (!clusterManagerSetSlot(src, target, s,</td></tr>
<tr class="codeline" data-linenumber="5369"><td class="num" id="LN5369">5369</td><td class="line">                                               <span class='string_literal'>"IMPORTING"</span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)) fixed = -1;</td></tr>
<tr class="codeline" data-linenumber="5370"><td class="num" id="LN5370">5370</td><td class="line">                    <span class='keyword'>if</span> (fixed &lt; 0) <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="5371"><td class="num" id="LN5371">5371</td><td class="line">                    <span class='keyword'>int</span> opts = <span class='macro'>CLUSTER_MANAGER_OPT_VERBOSE<span class='macro_popup'>1 &lt;&lt; 7</span></span> |</td></tr>
<tr class="codeline" data-linenumber="5372"><td class="num" id="LN5372">5372</td><td class="line">                               <span class='macro'>CLUSTER_MANAGER_OPT_COLD<span class='macro_popup'>1 &lt;&lt; 1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5373"><td class="num" id="LN5373">5373</td><td class="line">                    <span class='keyword'>if</span> (!clusterManagerMoveSlot(src, target, s, opts, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="5374"><td class="num" id="LN5374">5374</td><td class="line">                        fixed = -1;</td></tr>
<tr class="codeline" data-linenumber="5375"><td class="num" id="LN5375">5375</td><td class="line">                        <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="5376"><td class="num" id="LN5376">5376</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="5377"><td class="num" id="LN5377">5377</td><td class="line">                    <span class='keyword'>if</span> (!clusterManagerClearSlotStatus(src, s))</td></tr>
<tr class="codeline" data-linenumber="5378"><td class="num" id="LN5378">5378</td><td class="line">                        fixed = -1;</td></tr>
<tr class="codeline" data-linenumber="5379"><td class="num" id="LN5379">5379</td><td class="line">                    <span class='keyword'>if</span> (fixed &lt; 0) <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="5380"><td class="num" id="LN5380">5380</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="5381"><td class="num" id="LN5381">5381</td><td class="line">                fixed++;</td></tr>
<tr class="codeline" data-linenumber="5382"><td class="num" id="LN5382">5382</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="5383"><td class="num" id="LN5383">5383</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5384"><td class="num" id="LN5384">5384</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5385"><td class="num" id="LN5385">5385</td><td class="line">cleanup:</td></tr>
<tr class="codeline" data-linenumber="5386"><td class="num" id="LN5386">5386</td><td class="line">    <span class='keyword'>if</span> (none) listRelease(none);</td></tr>
<tr class="codeline" data-linenumber="5387"><td class="num" id="LN5387">5387</td><td class="line">    <span class='keyword'>if</span> (single) listRelease(single);</td></tr>
<tr class="codeline" data-linenumber="5388"><td class="num" id="LN5388">5388</td><td class="line">    <span class='keyword'>if</span> (multi) listRelease(multi);</td></tr>
<tr class="codeline" data-linenumber="5389"><td class="num" id="LN5389">5389</td><td class="line">    <span class='keyword'>return</span> fixed;</td></tr>
<tr class="codeline" data-linenumber="5390"><td class="num" id="LN5390">5390</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5391"><td class="num" id="LN5391">5391</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5392"><td class="num" id="LN5392">5392</td><td class="line"><span class='comment'>/* Slot 'slot' was found to be in importing or migrating state in one or</span></td></tr>
<tr class="codeline" data-linenumber="5393"><td class="num" id="LN5393">5393</td><td class="line"> <span class='comment'>* more nodes. This function fixes this condition by migrating keys where</span></td></tr>
<tr class="codeline" data-linenumber="5394"><td class="num" id="LN5394">5394</td><td class="line"> <span class='comment'>* it seems more sensible. */</span></td></tr>
<tr class="codeline" data-linenumber="5395"><td class="num" id="LN5395">5395</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerFixOpenSlot(<span class='keyword'>int</span> slot) {</td></tr>
<tr class="codeline" data-linenumber="5396"><td class="num" id="LN5396">5396</td><td class="line">    <span class='keyword'>int</span> force_fix = config.cluster_manager_command.flags &amp;</td></tr>
<tr class="codeline" data-linenumber="5397"><td class="num" id="LN5397">5397</td><td class="line">                    <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_FIX_WITH_UNREACHABLE_MASTERS<span class='macro_popup'>1 &lt;&lt; 10</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5398"><td class="num" id="LN5398">5398</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5399"><td class="num" id="LN5399">5399</td><td class="line">    <span class='keyword'>if</span> (cluster_manager.unreachable_masters &gt; 0 &amp;&amp; !force_fix) {</td></tr>
<tr class="codeline" data-linenumber="5400"><td class="num" id="LN5400">5400</td><td class="line">        <span class='macro'>clusterManagerLogWarn(<span class='string_literal'>"*** Fixing open slots with %d unreachable masters is dangerous: redis-cli will assume that slots about masters that are not reachable are not covered, and will try to reassign them to the reachable nodes. This can cause data loss and is rarely what you want to do. If you really want to proceed use the --cluster-fix-with-unreachable-masters option.\n"</span>, cluster_manager.unreachable_masters)<span class='macro_popup'>clusterManagerLog(2,"*** Fixing open slots with %d unreachable masters is dangerous: redis-cli will assume that slots about masters that are not reachable are not covered, and will try to reassign them to the reachable nodes. This can cause data loss and is rarely what you want to do. If you really want to proceed use the --cluster-fix-with-unreachable-masters option.\n"<br>, cluster_manager.unreachable_masters)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5401"><td class="num" id="LN5401">5401</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="5402"><td class="num" id="LN5402">5402</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5403"><td class="num" id="LN5403">5403</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5404"><td class="num" id="LN5404">5404</td><td class="line">    <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Fixing open slot %d\n"</span>, slot)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Fixing open slot %d\n", slot<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5405"><td class="num" id="LN5405">5405</td><td class="line">    <span class='comment'>/* Try to obtain the current slot owner, according to the current</span></td></tr>
<tr class="codeline" data-linenumber="5406"><td class="num" id="LN5406">5406</td><td class="line">     <span class='comment'>* nodes configuration. */</span></td></tr>
<tr class="codeline" data-linenumber="5407"><td class="num" id="LN5407">5407</td><td class="line">    <span class='keyword'>int</span> success = 1;</td></tr>
<tr class="codeline" data-linenumber="5408"><td class="num" id="LN5408">5408</td><td class="line">    list *owners = listCreate();    <span class='comment'>/* List of nodes claiming some ownership.</span></td></tr>
<tr class="codeline" data-linenumber="5409"><td class="num" id="LN5409">5409</td><td class="line">                                       <span class='comment'>it could be stating in the configuration</span></td></tr>
<tr class="codeline" data-linenumber="5410"><td class="num" id="LN5410">5410</td><td class="line">                                       <span class='comment'>to have the node ownership, or just</span></td></tr>
<tr class="codeline" data-linenumber="5411"><td class="num" id="LN5411">5411</td><td class="line">                                       <span class='comment'>holding keys for such slot. */</span></td></tr>
<tr class="codeline" data-linenumber="5412"><td class="num" id="LN5412">5412</td><td class="line">    list *migrating = listCreate();</td></tr>
<tr class="codeline" data-linenumber="5413"><td class="num" id="LN5413">5413</td><td class="line">    list *importing = listCreate();</td></tr>
<tr class="codeline" data-linenumber="5414"><td class="num" id="LN5414">5414</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> migrating_str = <span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>();</td></tr>
<tr class="codeline" data-linenumber="5415"><td class="num" id="LN5415">5415</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> importing_str = <span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>();</td></tr>
<tr class="codeline" data-linenumber="5416"><td class="num" id="LN5416">5416</td><td class="line">    clusterManagerNode *owner = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>; <span class='comment'>/* The obvious slot owner if any. */</span></td></tr>
<tr class="codeline" data-linenumber="5417"><td class="num" id="LN5417">5417</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5418"><td class="num" id="LN5418">5418</td><td class="line">    <span class='comment'>/* Iterate all the nodes, looking for potential owners of this slot. */</span></td></tr>
<tr class="codeline" data-linenumber="5419"><td class="num" id="LN5419">5419</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="5420"><td class="num" id="LN5420">5420</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="5421"><td class="num" id="LN5421">5421</td><td class="line">    listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="5422"><td class="num" id="LN5422">5422</td><td class="line">    <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5423"><td class="num" id="LN5423">5423</td><td class="line">        clusterManagerNode *n = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5424"><td class="num" id="LN5424">5424</td><td class="line">        <span class='keyword'>if</span> (n-&gt;flags &amp; <span class='macro'>CLUSTER_MANAGER_FLAG_SLAVE<span class='macro_popup'>1 &lt;&lt; 1</span></span>) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="5425"><td class="num" id="LN5425">5425</td><td class="line">        <span class='keyword'>if</span> (n-&gt;slots[slot]) {</td></tr>
<tr class="codeline" data-linenumber="5426"><td class="num" id="LN5426">5426</td><td class="line">            listAddNodeTail(owners, n);</td></tr>
<tr class="codeline" data-linenumber="5427"><td class="num" id="LN5427">5427</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="5428"><td class="num" id="LN5428">5428</td><td class="line">            redisReply *r = <span class='macro'>CLUSTER_MANAGER_COMMAND(n,<span class='macro_popup'>(redisCommand(n-&gt;context, "CLUSTER COUNTKEYSINSLOT %d", slot<br>))</span></span></td></tr>
<tr class="codeline" data-linenumber="5429"><td class="num" id="LN5429">5429</td><td class="line">                <span class='string_literal'><span class='macro'>"CLUSTER COUNTKEYSINSLOT %d"</span>, slot)<span class='macro_popup'>(redisCommand(n-&gt;context, "CLUSTER COUNTKEYSINSLOT %d", slot<br>))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5430"><td class="num" id="LN5430">5430</td><td class="line">            success = clusterManagerCheckRedisReply(n, r, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5431"><td class="num" id="LN5431">5431</td><td class="line">            <span class='keyword'>if</span> (success &amp;&amp; r-&gt;integer &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="5432"><td class="num" id="LN5432">5432</td><td class="line">                <span class='macro'>clusterManagerLogWarn(<span class='string_literal'>"*** Found keys about slot %d "<span class='macro_popup'>clusterManagerLog(2,"*** Found keys about slot %d " "in non-owner node %s:%d!\n"<br>, slot, n-&gt;ip, n-&gt;port)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="5433"><td class="num" id="LN5433">5433</td><td class="line">                                      <span class='string_literal'><span class='macro'>"in non-owner node %s:%d!\n"</span>, slot,<span class='macro_popup'>clusterManagerLog(2,"*** Found keys about slot %d " "in non-owner node %s:%d!\n"<br>, slot, n-&gt;ip, n-&gt;port)</span></span></td></tr>
<tr class="codeline" data-linenumber="5434"><td class="num" id="LN5434">5434</td><td class="line">                                      <span class='macro'>n-&gt;ip, n-&gt;port)<span class='macro_popup'>clusterManagerLog(2,"*** Found keys about slot %d " "in non-owner node %s:%d!\n"<br>, slot, n-&gt;ip, n-&gt;port)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5435"><td class="num" id="LN5435">5435</td><td class="line">                listAddNodeTail(owners, n);</td></tr>
<tr class="codeline" data-linenumber="5436"><td class="num" id="LN5436">5436</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="5437"><td class="num" id="LN5437">5437</td><td class="line">            <span class='keyword'>if</span> (r) freeReplyObject(r);</td></tr>
<tr class="codeline" data-linenumber="5438"><td class="num" id="LN5438">5438</td><td class="line">            <span class='keyword'>if</span> (!success) <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="5439"><td class="num" id="LN5439">5439</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5440"><td class="num" id="LN5440">5440</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5441"><td class="num" id="LN5441">5441</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5442"><td class="num" id="LN5442">5442</td><td class="line">    <span class='comment'>/* If we have only a single potential owner for this slot,</span></td></tr>
<tr class="codeline" data-linenumber="5443"><td class="num" id="LN5443">5443</td><td class="line">     <span class='comment'>* set it as "owner". */</span></td></tr>
<tr class="codeline" data-linenumber="5444"><td class="num" id="LN5444">5444</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>listLength(owners)<span class='macro_popup'>((owners)-&gt;len)</span></span> == 1) owner = <span class='macro'>listFirst(owners)<span class='macro_popup'>((owners)-&gt;head)</span></span>-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5445"><td class="num" id="LN5445">5445</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5446"><td class="num" id="LN5446">5446</td><td class="line">    <span class='comment'>/* Scan the list of nodes again, in order to populate the</span></td></tr>
<tr class="codeline" data-linenumber="5447"><td class="num" id="LN5447">5447</td><td class="line">     <span class='comment'>* list of nodes in importing or migrating state for</span></td></tr>
<tr class="codeline" data-linenumber="5448"><td class="num" id="LN5448">5448</td><td class="line">     <span class='comment'>* this slot. */</span></td></tr>
<tr class="codeline" data-linenumber="5449"><td class="num" id="LN5449">5449</td><td class="line">    listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="5450"><td class="num" id="LN5450">5450</td><td class="line">    <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5451"><td class="num" id="LN5451">5451</td><td class="line">        clusterManagerNode *n = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5452"><td class="num" id="LN5452">5452</td><td class="line">        <span class='keyword'>if</span> (n-&gt;flags &amp; <span class='macro'>CLUSTER_MANAGER_FLAG_SLAVE<span class='macro_popup'>1 &lt;&lt; 1</span></span>) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="5453"><td class="num" id="LN5453">5453</td><td class="line">        <span class='keyword'>int</span> is_migrating = 0, is_importing = 0;</td></tr>
<tr class="codeline" data-linenumber="5454"><td class="num" id="LN5454">5454</td><td class="line">        <span class='keyword'>if</span> (n-&gt;migrating) {</td></tr>
<tr class="codeline" data-linenumber="5455"><td class="num" id="LN5455">5455</td><td class="line">            <span class='keyword'>for</span> (<span class='keyword'>int</span> i = 0; i &lt; n-&gt;migrating_count; i += 2) {</td></tr>
<tr class="codeline" data-linenumber="5456"><td class="num" id="LN5456">5456</td><td class="line">                <span class='macro'>sds<span class='macro_popup'>hisds</span></span> migrating_slot = n-&gt;migrating[i];</td></tr>
<tr class="codeline" data-linenumber="5457"><td class="num" id="LN5457">5457</td><td class="line">                <span class='keyword'>if</span> (atoi(migrating_slot) == slot) {</td></tr>
<tr class="codeline" data-linenumber="5458"><td class="num" id="LN5458">5458</td><td class="line">                    <span class='keyword'>char</span> *sep = (<span class='macro'>listLength(migrating)<span class='macro_popup'>((migrating)-&gt;len)</span></span> == 0 ? <span class='string_literal'>""</span> : <span class='string_literal'>","</span>);</td></tr>
<tr class="codeline" data-linenumber="5459"><td class="num" id="LN5459">5459</td><td class="line">                    migrating_str = <span class='macro'>sdscatfmt<span class='macro_popup'>hi_sdscatfmt</span></span>(migrating_str, <span class='string_literal'>"%s%s:%u"</span>,</td></tr>
<tr class="codeline" data-linenumber="5460"><td class="num" id="LN5460">5460</td><td class="line">                                              sep, n-&gt;ip, n-&gt;port);</td></tr>
<tr class="codeline" data-linenumber="5461"><td class="num" id="LN5461">5461</td><td class="line">                    listAddNodeTail(migrating, n);</td></tr>
<tr class="codeline" data-linenumber="5462"><td class="num" id="LN5462">5462</td><td class="line">                    is_migrating = 1;</td></tr>
<tr class="codeline" data-linenumber="5463"><td class="num" id="LN5463">5463</td><td class="line">                    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="5464"><td class="num" id="LN5464">5464</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="5465"><td class="num" id="LN5465">5465</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="5466"><td class="num" id="LN5466">5466</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5467"><td class="num" id="LN5467">5467</td><td class="line">        <span class='keyword'>if</span> (!is_migrating &amp;&amp; n-&gt;importing) {</td></tr>
<tr class="codeline" data-linenumber="5468"><td class="num" id="LN5468">5468</td><td class="line">            <span class='keyword'>for</span> (<span class='keyword'>int</span> i = 0; i &lt; n-&gt;importing_count; i += 2) {</td></tr>
<tr class="codeline" data-linenumber="5469"><td class="num" id="LN5469">5469</td><td class="line">                <span class='macro'>sds<span class='macro_popup'>hisds</span></span> importing_slot = n-&gt;importing[i];</td></tr>
<tr class="codeline" data-linenumber="5470"><td class="num" id="LN5470">5470</td><td class="line">                <span class='keyword'>if</span> (atoi(importing_slot) == slot) {</td></tr>
<tr class="codeline" data-linenumber="5471"><td class="num" id="LN5471">5471</td><td class="line">                    <span class='keyword'>char</span> *sep = (<span class='macro'>listLength(importing)<span class='macro_popup'>((importing)-&gt;len)</span></span> == 0 ? <span class='string_literal'>""</span> : <span class='string_literal'>","</span>);</td></tr>
<tr class="codeline" data-linenumber="5472"><td class="num" id="LN5472">5472</td><td class="line">                    importing_str = <span class='macro'>sdscatfmt<span class='macro_popup'>hi_sdscatfmt</span></span>(importing_str, <span class='string_literal'>"%s%s:%u"</span>,</td></tr>
<tr class="codeline" data-linenumber="5473"><td class="num" id="LN5473">5473</td><td class="line">                                              sep, n-&gt;ip, n-&gt;port);</td></tr>
<tr class="codeline" data-linenumber="5474"><td class="num" id="LN5474">5474</td><td class="line">                    listAddNodeTail(importing, n);</td></tr>
<tr class="codeline" data-linenumber="5475"><td class="num" id="LN5475">5475</td><td class="line">                    is_importing = 1;</td></tr>
<tr class="codeline" data-linenumber="5476"><td class="num" id="LN5476">5476</td><td class="line">                    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="5477"><td class="num" id="LN5477">5477</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="5478"><td class="num" id="LN5478">5478</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="5479"><td class="num" id="LN5479">5479</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5480"><td class="num" id="LN5480">5480</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5481"><td class="num" id="LN5481">5481</td><td class="line">        <span class='comment'>/* If the node is neither migrating nor importing and it's not</span></td></tr>
<tr class="codeline" data-linenumber="5482"><td class="num" id="LN5482">5482</td><td class="line">         <span class='comment'>* the owner, then is added to the importing list in case</span></td></tr>
<tr class="codeline" data-linenumber="5483"><td class="num" id="LN5483">5483</td><td class="line">         <span class='comment'>* it has keys in the slot. */</span></td></tr>
<tr class="codeline" data-linenumber="5484"><td class="num" id="LN5484">5484</td><td class="line">        <span class='keyword'>if</span> (!is_migrating &amp;&amp; !is_importing &amp;&amp; n != owner) {</td></tr>
<tr class="codeline" data-linenumber="5485"><td class="num" id="LN5485">5485</td><td class="line">            redisReply *r = <span class='macro'>CLUSTER_MANAGER_COMMAND(n,<span class='macro_popup'>(redisCommand(n-&gt;context, "CLUSTER COUNTKEYSINSLOT %d", slot<br>))</span></span></td></tr>
<tr class="codeline" data-linenumber="5486"><td class="num" id="LN5486">5486</td><td class="line">                <span class='string_literal'><span class='macro'>"CLUSTER COUNTKEYSINSLOT %d"</span>, slot)<span class='macro_popup'>(redisCommand(n-&gt;context, "CLUSTER COUNTKEYSINSLOT %d", slot<br>))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5487"><td class="num" id="LN5487">5487</td><td class="line">            success = clusterManagerCheckRedisReply(n, r, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5488"><td class="num" id="LN5488">5488</td><td class="line">            <span class='keyword'>if</span> (success &amp;&amp; r-&gt;integer &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="5489"><td class="num" id="LN5489">5489</td><td class="line">                <span class='macro'>clusterManagerLogWarn(<span class='string_literal'>"*** Found keys about slot %d "<span class='macro_popup'>clusterManagerLog(2,"*** Found keys about slot %d " "in node %s:%d!\n"<br>, slot, n-&gt;ip, n-&gt;port)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="5490"><td class="num" id="LN5490">5490</td><td class="line">                                      <span class='string_literal'><span class='macro'>"in node %s:%d!\n"</span>, slot, n-&gt;ip,<span class='macro_popup'>clusterManagerLog(2,"*** Found keys about slot %d " "in node %s:%d!\n"<br>, slot, n-&gt;ip, n-&gt;port)</span></span></td></tr>
<tr class="codeline" data-linenumber="5491"><td class="num" id="LN5491">5491</td><td class="line">                                      <span class='macro'>n-&gt;port)<span class='macro_popup'>clusterManagerLog(2,"*** Found keys about slot %d " "in node %s:%d!\n"<br>, slot, n-&gt;ip, n-&gt;port)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5492"><td class="num" id="LN5492">5492</td><td class="line">                <span class='keyword'>char</span> *sep = (<span class='macro'>listLength(importing)<span class='macro_popup'>((importing)-&gt;len)</span></span> == 0 ? <span class='string_literal'>""</span> : <span class='string_literal'>","</span>);</td></tr>
<tr class="codeline" data-linenumber="5493"><td class="num" id="LN5493">5493</td><td class="line">                importing_str = <span class='macro'>sdscatfmt<span class='macro_popup'>hi_sdscatfmt</span></span>(importing_str, <span class='string_literal'>"%s%s:%u"</span>,</td></tr>
<tr class="codeline" data-linenumber="5494"><td class="num" id="LN5494">5494</td><td class="line">                                          sep, n-&gt;ip, n-&gt;port);</td></tr>
<tr class="codeline" data-linenumber="5495"><td class="num" id="LN5495">5495</td><td class="line">                listAddNodeTail(importing, n);</td></tr>
<tr class="codeline" data-linenumber="5496"><td class="num" id="LN5496">5496</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="5497"><td class="num" id="LN5497">5497</td><td class="line">            <span class='keyword'>if</span> (r) freeReplyObject(r);</td></tr>
<tr class="codeline" data-linenumber="5498"><td class="num" id="LN5498">5498</td><td class="line">            <span class='keyword'>if</span> (!success) <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="5499"><td class="num" id="LN5499">5499</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5500"><td class="num" id="LN5500">5500</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5501"><td class="num" id="LN5501">5501</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>sdslen<span class='macro_popup'>hi_sdslen</span></span>(migrating_str) &gt; 0)</td></tr>
<tr class="codeline" data-linenumber="5502"><td class="num" id="LN5502">5502</td><td class="line">        printf(<span class='string_literal'>"Set as migrating in: %s\n"</span>, migrating_str);</td></tr>
<tr class="codeline" data-linenumber="5503"><td class="num" id="LN5503">5503</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>sdslen<span class='macro_popup'>hi_sdslen</span></span>(importing_str) &gt; 0)</td></tr>
<tr class="codeline" data-linenumber="5504"><td class="num" id="LN5504">5504</td><td class="line">        printf(<span class='string_literal'>"Set as importing in: %s\n"</span>, importing_str);</td></tr>
<tr class="codeline" data-linenumber="5505"><td class="num" id="LN5505">5505</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5506"><td class="num" id="LN5506">5506</td><td class="line">    <span class='comment'>/* If there is no slot owner, set as owner the node with the biggest</span></td></tr>
<tr class="codeline" data-linenumber="5507"><td class="num" id="LN5507">5507</td><td class="line">     <span class='comment'>* number of keys, among the set of migrating / importing nodes. */</span></td></tr>
<tr class="codeline" data-linenumber="5508"><td class="num" id="LN5508">5508</td><td class="line">    <span class='keyword'>if</span> (owner == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5509"><td class="num" id="LN5509">5509</td><td class="line">        <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; No single clear owner for the slot, "<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; No single clear owner for the slot, "<br> "selecting an owner by # of keys...\n")</span></span></span></td></tr>
<tr class="codeline" data-linenumber="5510"><td class="num" id="LN5510">5510</td><td class="line">                              <span class='string_literal'><span class='macro'>"selecting an owner by # of keys...\n"</span>)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; No single clear owner for the slot, "<br> "selecting an owner by # of keys...\n")</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5511"><td class="num" id="LN5511">5511</td><td class="line">        owner = clusterManagerGetNodeWithMostKeysInSlot(cluster_manager.nodes,</td></tr>
<tr class="codeline" data-linenumber="5512"><td class="num" id="LN5512">5512</td><td class="line">                                                        slot, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5513"><td class="num" id="LN5513">5513</td><td class="line">        <span class='comment'>// If we still don't have an owner, we can't fix it.</span></td></tr>
<tr class="codeline" data-linenumber="5514"><td class="num" id="LN5514">5514</td><td class="line">        <span class='keyword'>if</span> (owner == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5515"><td class="num" id="LN5515">5515</td><td class="line">            <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"[ERR] Can't select a slot owner. "<span class='macro_popup'>clusterManagerLog(3,"[ERR] Can't select a slot owner. " "Impossible to fix.\n"<br>)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="5516"><td class="num" id="LN5516">5516</td><td class="line">                                 <span class='string_literal'><span class='macro'>"Impossible to fix.\n"</span>)<span class='macro_popup'>clusterManagerLog(3,"[ERR] Can't select a slot owner. " "Impossible to fix.\n"<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5517"><td class="num" id="LN5517">5517</td><td class="line">            success = 0;</td></tr>
<tr class="codeline" data-linenumber="5518"><td class="num" id="LN5518">5518</td><td class="line">            <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="5519"><td class="num" id="LN5519">5519</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5520"><td class="num" id="LN5520">5520</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5521"><td class="num" id="LN5521">5521</td><td class="line">        <span class='comment'>// Use ADDSLOTS to assign the slot.</span></td></tr>
<tr class="codeline" data-linenumber="5522"><td class="num" id="LN5522">5522</td><td class="line">        <span class='macro'>clusterManagerLogWarn(<span class='string_literal'>"*** Configuring %s:%d as the slot owner\n"</span>,<span class='macro_popup'>clusterManagerLog(2,"*** Configuring %s:%d as the slot owner\n"<br>, owner-&gt;ip, owner-&gt;port)</span></span></td></tr>
<tr class="codeline" data-linenumber="5523"><td class="num" id="LN5523">5523</td><td class="line">                              <span class='macro'>owner-&gt;ip, owner-&gt;port)<span class='macro_popup'>clusterManagerLog(2,"*** Configuring %s:%d as the slot owner\n"<br>, owner-&gt;ip, owner-&gt;port)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5524"><td class="num" id="LN5524">5524</td><td class="line">        success = clusterManagerClearSlotStatus(owner, slot);</td></tr>
<tr class="codeline" data-linenumber="5525"><td class="num" id="LN5525">5525</td><td class="line">        <span class='keyword'>if</span> (!success) <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="5526"><td class="num" id="LN5526">5526</td><td class="line">        success = clusterManagerSetSlotOwner(owner, slot, 0);</td></tr>
<tr class="codeline" data-linenumber="5527"><td class="num" id="LN5527">5527</td><td class="line">        <span class='keyword'>if</span> (!success) <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="5528"><td class="num" id="LN5528">5528</td><td class="line">        <span class='comment'>/* Since CLUSTER ADDSLOTS succeeded, we also update the slot</span></td></tr>
<tr class="codeline" data-linenumber="5529"><td class="num" id="LN5529">5529</td><td class="line">         <span class='comment'>* info into the node struct, in order to keep it synced */</span></td></tr>
<tr class="codeline" data-linenumber="5530"><td class="num" id="LN5530">5530</td><td class="line">        owner-&gt;slots[slot] = 1;</td></tr>
<tr class="codeline" data-linenumber="5531"><td class="num" id="LN5531">5531</td><td class="line">        <span class='comment'>/* Remove the owner from the list of migrating/importing</span></td></tr>
<tr class="codeline" data-linenumber="5532"><td class="num" id="LN5532">5532</td><td class="line">         <span class='comment'>* nodes. */</span></td></tr>
<tr class="codeline" data-linenumber="5533"><td class="num" id="LN5533">5533</td><td class="line">        clusterManagerRemoveNodeFromList(migrating, owner);</td></tr>
<tr class="codeline" data-linenumber="5534"><td class="num" id="LN5534">5534</td><td class="line">        clusterManagerRemoveNodeFromList(importing, owner);</td></tr>
<tr class="codeline" data-linenumber="5535"><td class="num" id="LN5535">5535</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5536"><td class="num" id="LN5536">5536</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5537"><td class="num" id="LN5537">5537</td><td class="line">    <span class='comment'>/* If there are multiple owners of the slot, we need to fix it</span></td></tr>
<tr class="codeline" data-linenumber="5538"><td class="num" id="LN5538">5538</td><td class="line">     <span class='comment'>* so that a single node is the owner and all the other nodes</span></td></tr>
<tr class="codeline" data-linenumber="5539"><td class="num" id="LN5539">5539</td><td class="line">     <span class='comment'>* are in importing state. Later the fix can be handled by one</span></td></tr>
<tr class="codeline" data-linenumber="5540"><td class="num" id="LN5540">5540</td><td class="line">     <span class='comment'>* of the base cases above.</span></td></tr>
<tr class="codeline" data-linenumber="5541"><td class="num" id="LN5541">5541</td><td class="line">     <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="5542"><td class="num" id="LN5542">5542</td><td class="line">     <span class='comment'>* Note that this case also covers multiple nodes having the slot</span></td></tr>
<tr class="codeline" data-linenumber="5543"><td class="num" id="LN5543">5543</td><td class="line">     <span class='comment'>* in migrating state, since migrating is a valid state only for</span></td></tr>
<tr class="codeline" data-linenumber="5544"><td class="num" id="LN5544">5544</td><td class="line">     <span class='comment'>* slot owners. */</span></td></tr>
<tr class="codeline" data-linenumber="5545"><td class="num" id="LN5545">5545</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>listLength(owners)<span class='macro_popup'>((owners)-&gt;len)</span></span> &gt; 1) {</td></tr>
<tr class="codeline" data-linenumber="5546"><td class="num" id="LN5546">5546</td><td class="line">        <span class='comment'>/* Owner cannot be NULL at this point, since if there are more owners,</span></td></tr>
<tr class="codeline" data-linenumber="5547"><td class="num" id="LN5547">5547</td><td class="line">         <span class='comment'>* the owner has been set in the previous condition (owner == NULL). */</span></td></tr>
<tr class="codeline" data-linenumber="5548"><td class="num" id="LN5548">5548</td><td class="line">        <span class='macro'>assert(owner != NULL)<span class='macro_popup'>((owner != ((void*)0)) ? (void) (0) : __assert_fail ("owner != NULL"<br>, "redis-cli.c", 5548, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5549"><td class="num" id="LN5549">5549</td><td class="line">        listRewind(owners, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="5550"><td class="num" id="LN5550">5550</td><td class="line">        <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5551"><td class="num" id="LN5551">5551</td><td class="line">            clusterManagerNode *n = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5552"><td class="num" id="LN5552">5552</td><td class="line">            <span class='keyword'>if</span> (n == owner) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="5553"><td class="num" id="LN5553">5553</td><td class="line">            success = clusterManagerDelSlot(n, slot, 1);</td></tr>
<tr class="codeline" data-linenumber="5554"><td class="num" id="LN5554">5554</td><td class="line">            <span class='keyword'>if</span> (!success) <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="5555"><td class="num" id="LN5555">5555</td><td class="line">            n-&gt;slots[slot] = 0;</td></tr>
<tr class="codeline" data-linenumber="5556"><td class="num" id="LN5556">5556</td><td class="line">            <span class='comment'>/* Assign the slot to the owner in the node 'n' configuration.' */</span></td></tr>
<tr class="codeline" data-linenumber="5557"><td class="num" id="LN5557">5557</td><td class="line">            success = clusterManagerSetSlot(n, owner, slot, <span class='string_literal'>"node"</span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5558"><td class="num" id="LN5558">5558</td><td class="line">            <span class='keyword'>if</span> (!success) <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="5559"><td class="num" id="LN5559">5559</td><td class="line">            success = clusterManagerSetSlot(n, owner, slot, <span class='string_literal'>"importing"</span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5560"><td class="num" id="LN5560">5560</td><td class="line">            <span class='keyword'>if</span> (!success) <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="5561"><td class="num" id="LN5561">5561</td><td class="line">            <span class='comment'>/* Avoid duplicates. */</span></td></tr>
<tr class="codeline" data-linenumber="5562"><td class="num" id="LN5562">5562</td><td class="line">            clusterManagerRemoveNodeFromList(importing, n);</td></tr>
<tr class="codeline" data-linenumber="5563"><td class="num" id="LN5563">5563</td><td class="line">            listAddNodeTail(importing, n);</td></tr>
<tr class="codeline" data-linenumber="5564"><td class="num" id="LN5564">5564</td><td class="line">            <span class='comment'>/* Ensure that the node is not in the migrating list. */</span></td></tr>
<tr class="codeline" data-linenumber="5565"><td class="num" id="LN5565">5565</td><td class="line">            clusterManagerRemoveNodeFromList(migrating, n);</td></tr>
<tr class="codeline" data-linenumber="5566"><td class="num" id="LN5566">5566</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5567"><td class="num" id="LN5567">5567</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5568"><td class="num" id="LN5568">5568</td><td class="line">    <span class='keyword'>int</span> move_opts = <span class='macro'>CLUSTER_MANAGER_OPT_VERBOSE<span class='macro_popup'>1 &lt;&lt; 7</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5569"><td class="num" id="LN5569">5569</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5570"><td class="num" id="LN5570">5570</td><td class="line">    <span class='comment'>/* Case 1: The slot is in migrating state in one node, and in</span></td></tr>
<tr class="codeline" data-linenumber="5571"><td class="num" id="LN5571">5571</td><td class="line">     <span class='comment'>*         importing state in 1 node. That's trivial to address. */</span></td></tr>
<tr class="codeline" data-linenumber="5572"><td class="num" id="LN5572">5572</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>listLength(migrating)<span class='macro_popup'>((migrating)-&gt;len)</span></span> == 1 &amp;&amp; <span class='macro'>listLength(importing)<span class='macro_popup'>((importing)-&gt;len)</span></span> == 1) {</td></tr>
<tr class="codeline" data-linenumber="5573"><td class="num" id="LN5573">5573</td><td class="line">        clusterManagerNode *src = <span class='macro'>listFirst(migrating)<span class='macro_popup'>((migrating)-&gt;head)</span></span>-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5574"><td class="num" id="LN5574">5574</td><td class="line">        clusterManagerNode *dst = <span class='macro'>listFirst(importing)<span class='macro_popup'>((importing)-&gt;head)</span></span>-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5575"><td class="num" id="LN5575">5575</td><td class="line">        <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Case 1: Moving slot %d from "<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Case 1: Moving slot %d from "<br> "%s:%d to %s:%d\n", slot, src-&gt;ip, src-&gt;port, dst-&gt;<br>ip, dst-&gt;port)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="5576"><td class="num" id="LN5576">5576</td><td class="line">                              <span class='string_literal'><span class='macro'>"%s:%d to %s:%d\n"</span>, slot,<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Case 1: Moving slot %d from "<br> "%s:%d to %s:%d\n", slot, src-&gt;ip, src-&gt;port, dst-&gt;<br>ip, dst-&gt;port)</span></span></td></tr>
<tr class="codeline" data-linenumber="5577"><td class="num" id="LN5577">5577</td><td class="line">                              <span class='macro'>src-&gt;ip, src-&gt;port, dst-&gt;ip, dst-&gt;port)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Case 1: Moving slot %d from "<br> "%s:%d to %s:%d\n", slot, src-&gt;ip, src-&gt;port, dst-&gt;<br>ip, dst-&gt;port)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5578"><td class="num" id="LN5578">5578</td><td class="line">        move_opts |= <span class='macro'>CLUSTER_MANAGER_OPT_UPDATE<span class='macro_popup'>1 &lt;&lt; 2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5579"><td class="num" id="LN5579">5579</td><td class="line">        success = clusterManagerMoveSlot(src, dst, slot, move_opts, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5580"><td class="num" id="LN5580">5580</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5581"><td class="num" id="LN5581">5581</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5582"><td class="num" id="LN5582">5582</td><td class="line">    <span class='comment'>/* Case 2: There are multiple nodes that claim the slot as importing,</span></td></tr>
<tr class="codeline" data-linenumber="5583"><td class="num" id="LN5583">5583</td><td class="line">     <span class='comment'>* they probably got keys about the slot after a restart so opened</span></td></tr>
<tr class="codeline" data-linenumber="5584"><td class="num" id="LN5584">5584</td><td class="line">     <span class='comment'>* the slot. In this case we just move all the keys to the owner</span></td></tr>
<tr class="codeline" data-linenumber="5585"><td class="num" id="LN5585">5585</td><td class="line">     <span class='comment'>* according to the configuration. */</span></td></tr>
<tr class="codeline" data-linenumber="5586"><td class="num" id="LN5586">5586</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (<span class='macro'>listLength(migrating)<span class='macro_popup'>((migrating)-&gt;len)</span></span> == 0 &amp;&amp; <span class='macro'>listLength(importing)<span class='macro_popup'>((importing)-&gt;len)</span></span> &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="5587"><td class="num" id="LN5587">5587</td><td class="line">        <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Case 2: Moving all the %d slot keys to its "<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Case 2: Moving all the %d slot keys to its "<br> "owner %s:%d\n", slot, owner-&gt;ip, owner-&gt;port)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="5588"><td class="num" id="LN5588">5588</td><td class="line">                              <span class='string_literal'><span class='macro'>"owner %s:%d\n"</span>, slot, owner-&gt;ip, owner-&gt;port)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Case 2: Moving all the %d slot keys to its "<br> "owner %s:%d\n", slot, owner-&gt;ip, owner-&gt;port)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5589"><td class="num" id="LN5589">5589</td><td class="line">        move_opts |= <span class='macro'>CLUSTER_MANAGER_OPT_COLD<span class='macro_popup'>1 &lt;&lt; 1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5590"><td class="num" id="LN5590">5590</td><td class="line">        listRewind(importing, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="5591"><td class="num" id="LN5591">5591</td><td class="line">        <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5592"><td class="num" id="LN5592">5592</td><td class="line">            clusterManagerNode *n = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5593"><td class="num" id="LN5593">5593</td><td class="line">            <span class='keyword'>if</span> (n == owner) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="5594"><td class="num" id="LN5594">5594</td><td class="line">            success = clusterManagerMoveSlot(n, owner, slot, move_opts, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5595"><td class="num" id="LN5595">5595</td><td class="line">            <span class='keyword'>if</span> (!success) <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="5596"><td class="num" id="LN5596">5596</td><td class="line">            <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Setting %d as STABLE in "<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Setting %d as STABLE in " "%s:%d\n"<br>, slot, n-&gt;ip, n-&gt;port)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="5597"><td class="num" id="LN5597">5597</td><td class="line">                                  <span class='string_literal'><span class='macro'>"%s:%d\n"</span>, slot, n-&gt;ip, n-&gt;port)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Setting %d as STABLE in " "%s:%d\n"<br>, slot, n-&gt;ip, n-&gt;port)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5598"><td class="num" id="LN5598">5598</td><td class="line">            success = clusterManagerClearSlotStatus(n, slot);</td></tr>
<tr class="codeline" data-linenumber="5599"><td class="num" id="LN5599">5599</td><td class="line">            <span class='keyword'>if</span> (!success) <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="5600"><td class="num" id="LN5600">5600</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5601"><td class="num" id="LN5601">5601</td><td class="line">        <span class='comment'>/* Since the slot has been moved in "cold" mode, ensure that all the</span></td></tr>
<tr class="codeline" data-linenumber="5602"><td class="num" id="LN5602">5602</td><td class="line">         <span class='comment'>* other nodes update their own configuration about the slot itself. */</span></td></tr>
<tr class="codeline" data-linenumber="5603"><td class="num" id="LN5603">5603</td><td class="line">        listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="5604"><td class="num" id="LN5604">5604</td><td class="line">        <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5605"><td class="num" id="LN5605">5605</td><td class="line">            clusterManagerNode *n = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5606"><td class="num" id="LN5606">5606</td><td class="line">            <span class='keyword'>if</span> (n == owner) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="5607"><td class="num" id="LN5607">5607</td><td class="line">            <span class='keyword'>if</span> (n-&gt;flags &amp; <span class='macro'>CLUSTER_MANAGER_FLAG_SLAVE<span class='macro_popup'>1 &lt;&lt; 1</span></span>) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="5608"><td class="num" id="LN5608">5608</td><td class="line">            success = clusterManagerSetSlot(n, owner, slot, <span class='string_literal'>"NODE"</span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5609"><td class="num" id="LN5609">5609</td><td class="line">            <span class='keyword'>if</span> (!success) <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="5610"><td class="num" id="LN5610">5610</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5611"><td class="num" id="LN5611">5611</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5612"><td class="num" id="LN5612">5612</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5613"><td class="num" id="LN5613">5613</td><td class="line">    <span class='comment'>/* Case 3: The slot is in migrating state in one node but multiple</span></td></tr>
<tr class="codeline" data-linenumber="5614"><td class="num" id="LN5614">5614</td><td class="line">     <span class='comment'>* other nodes claim to be in importing state and don't have any key in</span></td></tr>
<tr class="codeline" data-linenumber="5615"><td class="num" id="LN5615">5615</td><td class="line">     <span class='comment'>* the slot. We search for the importing node having the same ID as</span></td></tr>
<tr class="codeline" data-linenumber="5616"><td class="num" id="LN5616">5616</td><td class="line">     <span class='comment'>* the destination node of the migrating node.</span></td></tr>
<tr class="codeline" data-linenumber="5617"><td class="num" id="LN5617">5617</td><td class="line">     <span class='comment'>* In that case we move the slot from the migrating node to this node and</span></td></tr>
<tr class="codeline" data-linenumber="5618"><td class="num" id="LN5618">5618</td><td class="line">     <span class='comment'>* we close the importing states on all the other importing nodes.</span></td></tr>
<tr class="codeline" data-linenumber="5619"><td class="num" id="LN5619">5619</td><td class="line">     <span class='comment'>* If no importing node has the same ID as the destination node of the</span></td></tr>
<tr class="codeline" data-linenumber="5620"><td class="num" id="LN5620">5620</td><td class="line">     <span class='comment'>* migrating node, the slot's state is closed on both the migrating node</span></td></tr>
<tr class="codeline" data-linenumber="5621"><td class="num" id="LN5621">5621</td><td class="line">     <span class='comment'>* and the importing nodes. */</span></td></tr>
<tr class="codeline" data-linenumber="5622"><td class="num" id="LN5622">5622</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (<span class='macro'>listLength(migrating)<span class='macro_popup'>((migrating)-&gt;len)</span></span> == 1 &amp;&amp; <span class='macro'>listLength(importing)<span class='macro_popup'>((importing)-&gt;len)</span></span> &gt; 1) {</td></tr>
<tr class="codeline" data-linenumber="5623"><td class="num" id="LN5623">5623</td><td class="line">        <span class='keyword'>int</span> try_to_fix = 1;</td></tr>
<tr class="codeline" data-linenumber="5624"><td class="num" id="LN5624">5624</td><td class="line">        clusterManagerNode *src = <span class='macro'>listFirst(migrating)<span class='macro_popup'>((migrating)-&gt;head)</span></span>-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5625"><td class="num" id="LN5625">5625</td><td class="line">        clusterManagerNode *dst = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5626"><td class="num" id="LN5626">5626</td><td class="line">        <span class='macro'>sds<span class='macro_popup'>hisds</span></span> target_id = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5627"><td class="num" id="LN5627">5627</td><td class="line">        <span class='keyword'>for</span> (<span class='keyword'>int</span> i = 0; i &lt; src-&gt;migrating_count; i += 2) {</td></tr>
<tr class="codeline" data-linenumber="5628"><td class="num" id="LN5628">5628</td><td class="line">            <span class='macro'>sds<span class='macro_popup'>hisds</span></span> migrating_slot = src-&gt;migrating[i];</td></tr>
<tr class="codeline" data-linenumber="5629"><td class="num" id="LN5629">5629</td><td class="line">            <span class='keyword'>if</span> (atoi(migrating_slot) == slot) {</td></tr>
<tr class="codeline" data-linenumber="5630"><td class="num" id="LN5630">5630</td><td class="line">                target_id = src-&gt;migrating[i + 1];</td></tr>
<tr class="codeline" data-linenumber="5631"><td class="num" id="LN5631">5631</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="5632"><td class="num" id="LN5632">5632</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="5633"><td class="num" id="LN5633">5633</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5634"><td class="num" id="LN5634">5634</td><td class="line">        <span class='macro'>assert(target_id != NULL)<span class='macro_popup'>((target_id != ((void*)0)) ? (void) (0) : __assert_fail ("target_id != NULL"<br>, "redis-cli.c", 5634, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5635"><td class="num" id="LN5635">5635</td><td class="line">        listIter li;</td></tr>
<tr class="codeline" data-linenumber="5636"><td class="num" id="LN5636">5636</td><td class="line">        listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="5637"><td class="num" id="LN5637">5637</td><td class="line">        listRewind(importing, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="5638"><td class="num" id="LN5638">5638</td><td class="line">        <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5639"><td class="num" id="LN5639">5639</td><td class="line">            clusterManagerNode *n = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5640"><td class="num" id="LN5640">5640</td><td class="line">            <span class='keyword'>int</span> count = clusterManagerCountKeysInSlot(n, slot);</td></tr>
<tr class="codeline" data-linenumber="5641"><td class="num" id="LN5641">5641</td><td class="line">            <span class='keyword'>if</span> (count &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="5642"><td class="num" id="LN5642">5642</td><td class="line">                try_to_fix = 0;</td></tr>
<tr class="codeline" data-linenumber="5643"><td class="num" id="LN5643">5643</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="5644"><td class="num" id="LN5644">5644</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="5645"><td class="num" id="LN5645">5645</td><td class="line">            <span class='keyword'>if</span> (strcmp(n-&gt;name, target_id) == 0) dst = n;</td></tr>
<tr class="codeline" data-linenumber="5646"><td class="num" id="LN5646">5646</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5647"><td class="num" id="LN5647">5647</td><td class="line">        <span class='keyword'>if</span> (!try_to_fix) <span class='keyword'>goto</span> unhandled_case;</td></tr>
<tr class="codeline" data-linenumber="5648"><td class="num" id="LN5648">5648</td><td class="line">        <span class='keyword'>if</span> (dst != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5649"><td class="num" id="LN5649">5649</td><td class="line">            <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Case 3: Moving slot %d from %s:%d to "<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Case 3: Moving slot %d from %s:%d to "<br> "%s:%d and closing it on all the other " "importing nodes.\n"<br>, slot, src-&gt;ip, src-&gt;port, dst-&gt;ip, dst-&gt;port)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="5650"><td class="num" id="LN5650">5650</td><td class="line">                                  <span class='string_literal'><span class='macro'>"%s:%d and closing it on all the other "<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Case 3: Moving slot %d from %s:%d to "<br> "%s:%d and closing it on all the other " "importing nodes.\n"<br>, slot, src-&gt;ip, src-&gt;port, dst-&gt;ip, dst-&gt;port)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="5651"><td class="num" id="LN5651">5651</td><td class="line">                                  <span class='string_literal'><span class='macro'>"importing nodes.\n"</span>,<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Case 3: Moving slot %d from %s:%d to "<br> "%s:%d and closing it on all the other " "importing nodes.\n"<br>, slot, src-&gt;ip, src-&gt;port, dst-&gt;ip, dst-&gt;port)</span></span></td></tr>
<tr class="codeline" data-linenumber="5652"><td class="num" id="LN5652">5652</td><td class="line">                                  <span class='macro'>slot, src-&gt;ip, src-&gt;port,<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Case 3: Moving slot %d from %s:%d to "<br> "%s:%d and closing it on all the other " "importing nodes.\n"<br>, slot, src-&gt;ip, src-&gt;port, dst-&gt;ip, dst-&gt;port)</span></span></td></tr>
<tr class="codeline" data-linenumber="5653"><td class="num" id="LN5653">5653</td><td class="line">                                  <span class='macro'>dst-&gt;ip, dst-&gt;port)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Case 3: Moving slot %d from %s:%d to "<br> "%s:%d and closing it on all the other " "importing nodes.\n"<br>, slot, src-&gt;ip, src-&gt;port, dst-&gt;ip, dst-&gt;port)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5654"><td class="num" id="LN5654">5654</td><td class="line">            <span class='comment'>/* Move the slot to the destination node. */</span></td></tr>
<tr class="codeline" data-linenumber="5655"><td class="num" id="LN5655">5655</td><td class="line">            success = clusterManagerMoveSlot(src, dst, slot, move_opts, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5656"><td class="num" id="LN5656">5656</td><td class="line">            <span class='keyword'>if</span> (!success) <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="5657"><td class="num" id="LN5657">5657</td><td class="line">            <span class='comment'>/* Close slot on all the other importing nodes. */</span></td></tr>
<tr class="codeline" data-linenumber="5658"><td class="num" id="LN5658">5658</td><td class="line">            listRewind(importing, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="5659"><td class="num" id="LN5659">5659</td><td class="line">            <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5660"><td class="num" id="LN5660">5660</td><td class="line">                clusterManagerNode *n = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5661"><td class="num" id="LN5661">5661</td><td class="line">                <span class='keyword'>if</span> (dst == n) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="5662"><td class="num" id="LN5662">5662</td><td class="line">                success = clusterManagerClearSlotStatus(n, slot);</td></tr>
<tr class="codeline" data-linenumber="5663"><td class="num" id="LN5663">5663</td><td class="line">                <span class='keyword'>if</span> (!success) <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="5664"><td class="num" id="LN5664">5664</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="5665"><td class="num" id="LN5665">5665</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="5666"><td class="num" id="LN5666">5666</td><td class="line">            <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Case 3: Closing slot %d on both "<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Case 3: Closing slot %d on both "<br> "migrating and importing nodes.\n", slot)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="5667"><td class="num" id="LN5667">5667</td><td class="line">                                  <span class='string_literal'><span class='macro'>"migrating and importing nodes.\n"</span>, slot)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Case 3: Closing slot %d on both "<br> "migrating and importing nodes.\n", slot)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5668"><td class="num" id="LN5668">5668</td><td class="line">            <span class='comment'>/* Close the slot on both the migrating node and the importing</span></td></tr>
<tr class="codeline" data-linenumber="5669"><td class="num" id="LN5669">5669</td><td class="line">             <span class='comment'>* nodes. */</span></td></tr>
<tr class="codeline" data-linenumber="5670"><td class="num" id="LN5670">5670</td><td class="line">            success = clusterManagerClearSlotStatus(src, slot);</td></tr>
<tr class="codeline" data-linenumber="5671"><td class="num" id="LN5671">5671</td><td class="line">            <span class='keyword'>if</span> (!success) <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="5672"><td class="num" id="LN5672">5672</td><td class="line">            listRewind(importing, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="5673"><td class="num" id="LN5673">5673</td><td class="line">            <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5674"><td class="num" id="LN5674">5674</td><td class="line">                clusterManagerNode *n = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5675"><td class="num" id="LN5675">5675</td><td class="line">                success = clusterManagerClearSlotStatus(n, slot);</td></tr>
<tr class="codeline" data-linenumber="5676"><td class="num" id="LN5676">5676</td><td class="line">                <span class='keyword'>if</span> (!success) <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="5677"><td class="num" id="LN5677">5677</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="5678"><td class="num" id="LN5678">5678</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5679"><td class="num" id="LN5679">5679</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="5680"><td class="num" id="LN5680">5680</td><td class="line">        <span class='keyword'>int</span> try_to_close_slot = (<span class='macro'>listLength(importing)<span class='macro_popup'>((importing)-&gt;len)</span></span> == 0 &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="5681"><td class="num" id="LN5681">5681</td><td class="line">                                 <span class='macro'>listLength(migrating)<span class='macro_popup'>((migrating)-&gt;len)</span></span> == 1);</td></tr>
<tr class="codeline" data-linenumber="5682"><td class="num" id="LN5682">5682</td><td class="line">        <span class='keyword'>if</span> (try_to_close_slot) {</td></tr>
<tr class="codeline" data-linenumber="5683"><td class="num" id="LN5683">5683</td><td class="line">            clusterManagerNode *n = <span class='macro'>listFirst(migrating)<span class='macro_popup'>((migrating)-&gt;head)</span></span>-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5684"><td class="num" id="LN5684">5684</td><td class="line">            <span class='keyword'>if</span> (!owner || owner != n) {</td></tr>
<tr class="codeline" data-linenumber="5685"><td class="num" id="LN5685">5685</td><td class="line">                redisReply *r = <span class='macro'>CLUSTER_MANAGER_COMMAND(n,<span class='macro_popup'>(redisCommand(n-&gt;context, "CLUSTER GETKEYSINSLOT %d %d", slot<br>, 10))</span></span></td></tr>
<tr class="codeline" data-linenumber="5686"><td class="num" id="LN5686">5686</td><td class="line">                    <span class='string_literal'><span class='macro'>"CLUSTER GETKEYSINSLOT %d %d"</span>, slot, 10)<span class='macro_popup'>(redisCommand(n-&gt;context, "CLUSTER GETKEYSINSLOT %d %d", slot<br>, 10))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5687"><td class="num" id="LN5687">5687</td><td class="line">                success = clusterManagerCheckRedisReply(n, r, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5688"><td class="num" id="LN5688">5688</td><td class="line">                <span class='keyword'>if</span> (r) {</td></tr>
<tr class="codeline" data-linenumber="5689"><td class="num" id="LN5689">5689</td><td class="line">                    <span class='keyword'>if</span> (success) try_to_close_slot = (r-&gt;elements == 0);</td></tr>
<tr class="codeline" data-linenumber="5690"><td class="num" id="LN5690">5690</td><td class="line">                    freeReplyObject(r);</td></tr>
<tr class="codeline" data-linenumber="5691"><td class="num" id="LN5691">5691</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="5692"><td class="num" id="LN5692">5692</td><td class="line">                <span class='keyword'>if</span> (!success) <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="5693"><td class="num" id="LN5693">5693</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="5694"><td class="num" id="LN5694">5694</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5695"><td class="num" id="LN5695">5695</td><td class="line">        <span class='comment'>/* Case 4: There are no slots claiming to be in importing state, but</span></td></tr>
<tr class="codeline" data-linenumber="5696"><td class="num" id="LN5696">5696</td><td class="line">         <span class='comment'>* there is a migrating node that actually don't have any key or is the</span></td></tr>
<tr class="codeline" data-linenumber="5697"><td class="num" id="LN5697">5697</td><td class="line">         <span class='comment'>* slot owner. We can just close the slot, probably a reshard</span></td></tr>
<tr class="codeline" data-linenumber="5698"><td class="num" id="LN5698">5698</td><td class="line">         <span class='comment'>* interrupted in the middle. */</span></td></tr>
<tr class="codeline" data-linenumber="5699"><td class="num" id="LN5699">5699</td><td class="line">        <span class='keyword'>if</span> (try_to_close_slot) {</td></tr>
<tr class="codeline" data-linenumber="5700"><td class="num" id="LN5700">5700</td><td class="line">            clusterManagerNode *n = <span class='macro'>listFirst(migrating)<span class='macro_popup'>((migrating)-&gt;head)</span></span>-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5701"><td class="num" id="LN5701">5701</td><td class="line">            <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Case 4: Closing slot %d on %s:%d\n"</span>,<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Case 4: Closing slot %d on %s:%d\n"<br>, slot, n-&gt;ip, n-&gt;port)</span></span></td></tr>
<tr class="codeline" data-linenumber="5702"><td class="num" id="LN5702">5702</td><td class="line">                                  <span class='macro'>slot, n-&gt;ip, n-&gt;port)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Case 4: Closing slot %d on %s:%d\n"<br>, slot, n-&gt;ip, n-&gt;port)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5703"><td class="num" id="LN5703">5703</td><td class="line">            redisReply *r = <span class='macro'>CLUSTER_MANAGER_COMMAND(n, <span class='string_literal'>"CLUSTER SETSLOT %d %s"</span>,<span class='macro_popup'>(redisCommand(n-&gt;context, "CLUSTER SETSLOT %d %s", slot, "STABLE"<br>))</span></span></td></tr>
<tr class="codeline" data-linenumber="5704"><td class="num" id="LN5704">5704</td><td class="line">                                                    <span class='macro'>slot, <span class='string_literal'>"STABLE"</span>)<span class='macro_popup'>(redisCommand(n-&gt;context, "CLUSTER SETSLOT %d %s", slot, "STABLE"<br>))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5705"><td class="num" id="LN5705">5705</td><td class="line">            success = clusterManagerCheckRedisReply(n, r, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5706"><td class="num" id="LN5706">5706</td><td class="line">            <span class='keyword'>if</span> (r) freeReplyObject(r);</td></tr>
<tr class="codeline" data-linenumber="5707"><td class="num" id="LN5707">5707</td><td class="line">            <span class='keyword'>if</span> (!success) <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="5708"><td class="num" id="LN5708">5708</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="5709"><td class="num" id="LN5709">5709</td><td class="line">unhandled_case:</td></tr>
<tr class="codeline" data-linenumber="5710"><td class="num" id="LN5710">5710</td><td class="line">            success = 0;</td></tr>
<tr class="codeline" data-linenumber="5711"><td class="num" id="LN5711">5711</td><td class="line">            <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"[ERR] Sorry, redis-cli can't fix this slot "<span class='macro_popup'>clusterManagerLog(3,"[ERR] Sorry, redis-cli can't fix this slot "<br> "yet (work in progress). Slot is set as " "migrating in %s, as importing in %s, "<br> "owner is %s:%d\n", migrating_str, importing_str, owner-&gt;<br>ip, owner-&gt;port)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="5712"><td class="num" id="LN5712">5712</td><td class="line">                                 <span class='string_literal'><span class='macro'>"yet (work in progress). Slot is set as "<span class='macro_popup'>clusterManagerLog(3,"[ERR] Sorry, redis-cli can't fix this slot "<br> "yet (work in progress). Slot is set as " "migrating in %s, as importing in %s, "<br> "owner is %s:%d\n", migrating_str, importing_str, owner-&gt;<br>ip, owner-&gt;port)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="5713"><td class="num" id="LN5713">5713</td><td class="line">                                 <span class='string_literal'><span class='macro'>"migrating in %s, as importing in %s, "<span class='macro_popup'>clusterManagerLog(3,"[ERR] Sorry, redis-cli can't fix this slot "<br> "yet (work in progress). Slot is set as " "migrating in %s, as importing in %s, "<br> "owner is %s:%d\n", migrating_str, importing_str, owner-&gt;<br>ip, owner-&gt;port)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="5714"><td class="num" id="LN5714">5714</td><td class="line">                                 <span class='string_literal'><span class='macro'>"owner is %s:%d\n"</span>, migrating_str,<span class='macro_popup'>clusterManagerLog(3,"[ERR] Sorry, redis-cli can't fix this slot "<br> "yet (work in progress). Slot is set as " "migrating in %s, as importing in %s, "<br> "owner is %s:%d\n", migrating_str, importing_str, owner-&gt;<br>ip, owner-&gt;port)</span></span></td></tr>
<tr class="codeline" data-linenumber="5715"><td class="num" id="LN5715">5715</td><td class="line">                                 <span class='macro'>importing_str, owner-&gt;ip, owner-&gt;port)<span class='macro_popup'>clusterManagerLog(3,"[ERR] Sorry, redis-cli can't fix this slot "<br> "yet (work in progress). Slot is set as " "migrating in %s, as importing in %s, "<br> "owner is %s:%d\n", migrating_str, importing_str, owner-&gt;<br>ip, owner-&gt;port)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5716"><td class="num" id="LN5716">5716</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5717"><td class="num" id="LN5717">5717</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5718"><td class="num" id="LN5718">5718</td><td class="line">cleanup:</td></tr>
<tr class="codeline" data-linenumber="5719"><td class="num" id="LN5719">5719</td><td class="line">    listRelease(owners);</td></tr>
<tr class="codeline" data-linenumber="5720"><td class="num" id="LN5720">5720</td><td class="line">    listRelease(migrating);</td></tr>
<tr class="codeline" data-linenumber="5721"><td class="num" id="LN5721">5721</td><td class="line">    listRelease(importing);</td></tr>
<tr class="codeline" data-linenumber="5722"><td class="num" id="LN5722">5722</td><td class="line">    <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(migrating_str);</td></tr>
<tr class="codeline" data-linenumber="5723"><td class="num" id="LN5723">5723</td><td class="line">    <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(importing_str);</td></tr>
<tr class="codeline" data-linenumber="5724"><td class="num" id="LN5724">5724</td><td class="line">    <span class='keyword'>return</span> success;</td></tr>
<tr class="codeline" data-linenumber="5725"><td class="num" id="LN5725">5725</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5726"><td class="num" id="LN5726">5726</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5727"><td class="num" id="LN5727">5727</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerFixMultipleSlotOwners(<span class='keyword'>int</span> slot, list *owners) {</td></tr>
<tr class="codeline" data-linenumber="5728"><td class="num" id="LN5728">5728</td><td class="line">    <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Fixing multiple owners for slot %d...\n"</span>, slot)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Fixing multiple owners for slot %d...\n"<br>, slot)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5729"><td class="num" id="LN5729">5729</td><td class="line">    <span class='keyword'>int</span> success = 0;</td></tr>
<tr class="codeline" data-linenumber="5730"><td class="num" id="LN5730">5730</td><td class="line">    <span class='macro'>assert(listLength(owners) &gt; 1)<span class='macro_popup'>((((owners)-&gt;len) &gt; 1) ? (void) (0) : __assert_fail ("listLength(owners) &gt; 1"<br>, "redis-cli.c", 5730, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5731"><td class="num" id="LN5731">5731</td><td class="line">    clusterManagerNode *owner = clusterManagerGetNodeWithMostKeysInSlot(owners,</td></tr>
<tr class="codeline" data-linenumber="5732"><td class="num" id="LN5732">5732</td><td class="line">                                                                        slot,</td></tr>
<tr class="codeline" data-linenumber="5733"><td class="num" id="LN5733">5733</td><td class="line">                                                                        <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5734"><td class="num" id="LN5734">5734</td><td class="line">    <span class='keyword'>if</span> (!owner) owner = <span class='macro'>listFirst(owners)<span class='macro_popup'>((owners)-&gt;head)</span></span>-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5735"><td class="num" id="LN5735">5735</td><td class="line">    <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Setting slot %d owner: %s:%d\n"</span>,<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Setting slot %d owner: %s:%d\n"<br>, slot, owner-&gt;ip, owner-&gt;port)</span></span></td></tr>
<tr class="codeline" data-linenumber="5736"><td class="num" id="LN5736">5736</td><td class="line">                          <span class='macro'>slot, owner-&gt;ip, owner-&gt;port)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Setting slot %d owner: %s:%d\n"<br>, slot, owner-&gt;ip, owner-&gt;port)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5737"><td class="num" id="LN5737">5737</td><td class="line">    <span class='comment'>/* Set the slot owner. */</span></td></tr>
<tr class="codeline" data-linenumber="5738"><td class="num" id="LN5738">5738</td><td class="line">    <span class='keyword'>if</span> (!clusterManagerSetSlotOwner(owner, slot, 0)) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="5739"><td class="num" id="LN5739">5739</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="5740"><td class="num" id="LN5740">5740</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="5741"><td class="num" id="LN5741">5741</td><td class="line">    listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="5742"><td class="num" id="LN5742">5742</td><td class="line">    <span class='comment'>/* Update configuration in all the other master nodes by assigning the slot</span></td></tr>
<tr class="codeline" data-linenumber="5743"><td class="num" id="LN5743">5743</td><td class="line">     <span class='comment'>* itself to the new owner, and by eventually migrating keys if the node</span></td></tr>
<tr class="codeline" data-linenumber="5744"><td class="num" id="LN5744">5744</td><td class="line">     <span class='comment'>* has keys for the slot. */</span></td></tr>
<tr class="codeline" data-linenumber="5745"><td class="num" id="LN5745">5745</td><td class="line">    <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5746"><td class="num" id="LN5746">5746</td><td class="line">        clusterManagerNode *n = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5747"><td class="num" id="LN5747">5747</td><td class="line">        <span class='keyword'>if</span> (n == owner) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="5748"><td class="num" id="LN5748">5748</td><td class="line">        <span class='keyword'>if</span> (n-&gt;flags &amp; <span class='macro'>CLUSTER_MANAGER_FLAG_SLAVE<span class='macro_popup'>1 &lt;&lt; 1</span></span>) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="5749"><td class="num" id="LN5749">5749</td><td class="line">        <span class='keyword'>int</span> count = clusterManagerCountKeysInSlot(n, slot);</td></tr>
<tr class="codeline" data-linenumber="5750"><td class="num" id="LN5750">5750</td><td class="line">        success = (count &gt;= 0);</td></tr>
<tr class="codeline" data-linenumber="5751"><td class="num" id="LN5751">5751</td><td class="line">        <span class='keyword'>if</span> (!success) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="5752"><td class="num" id="LN5752">5752</td><td class="line">        clusterManagerDelSlot(n, slot, 1);</td></tr>
<tr class="codeline" data-linenumber="5753"><td class="num" id="LN5753">5753</td><td class="line">        <span class='keyword'>if</span> (!clusterManagerSetSlot(n, owner, slot, <span class='string_literal'>"node"</span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="5754"><td class="num" id="LN5754">5754</td><td class="line">        <span class='keyword'>if</span> (count &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="5755"><td class="num" id="LN5755">5755</td><td class="line">            <span class='keyword'>int</span> opts = <span class='macro'>CLUSTER_MANAGER_OPT_VERBOSE<span class='macro_popup'>1 &lt;&lt; 7</span></span> |</td></tr>
<tr class="codeline" data-linenumber="5756"><td class="num" id="LN5756">5756</td><td class="line">                       <span class='macro'>CLUSTER_MANAGER_OPT_COLD<span class='macro_popup'>1 &lt;&lt; 1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5757"><td class="num" id="LN5757">5757</td><td class="line">            success = clusterManagerMoveSlot(n, owner, slot, opts, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5758"><td class="num" id="LN5758">5758</td><td class="line">            <span class='keyword'>if</span> (!success) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="5759"><td class="num" id="LN5759">5759</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5760"><td class="num" id="LN5760">5760</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5761"><td class="num" id="LN5761">5761</td><td class="line">    <span class='keyword'>return</span> success;</td></tr>
<tr class="codeline" data-linenumber="5762"><td class="num" id="LN5762">5762</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5763"><td class="num" id="LN5763">5763</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5764"><td class="num" id="LN5764">5764</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerCheckCluster(<span class='keyword'>int</span> quiet) {</td></tr>
<tr class="codeline" data-linenumber="5765"><td class="num" id="LN5765">5765</td><td class="line">    listNode *ln = <span class='macro'>listFirst(cluster_manager.nodes)<span class='macro_popup'>((cluster_manager.nodes)-&gt;head)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5766"><td class="num" id="LN5766">5766</td><td class="line">    <span class='keyword'>if</span> (!ln) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="5767"><td class="num" id="LN5767">5767</td><td class="line">    clusterManagerNode *node = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5768"><td class="num" id="LN5768">5768</td><td class="line">    <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Performing Cluster Check (using node %s:%d)\n"</span>,<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Performing Cluster Check (using node %s:%d)\n"<br>, node-&gt;ip, node-&gt;port)</span></span></td></tr>
<tr class="codeline" data-linenumber="5769"><td class="num" id="LN5769">5769</td><td class="line">                          <span class='macro'>node-&gt;ip, node-&gt;port)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Performing Cluster Check (using node %s:%d)\n"<br>, node-&gt;ip, node-&gt;port)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5770"><td class="num" id="LN5770">5770</td><td class="line">    <span class='keyword'>int</span> result = 1, consistent = 0;</td></tr>
<tr class="codeline" data-linenumber="5771"><td class="num" id="LN5771">5771</td><td class="line">    <span class='keyword'>int</span> do_fix = config.cluster_manager_command.flags &amp;</td></tr>
<tr class="codeline" data-linenumber="5772"><td class="num" id="LN5772">5772</td><td class="line">                 <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_FIX<span class='macro_popup'>1 &lt;&lt; 0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5773"><td class="num" id="LN5773">5773</td><td class="line">    <span class='keyword'>if</span> (!quiet) clusterManagerShowNodes();</td></tr>
<tr class="codeline" data-linenumber="5774"><td class="num" id="LN5774">5774</td><td class="line">    consistent = clusterManagerIsConfigConsistent();</td></tr>
<tr class="codeline" data-linenumber="5775"><td class="num" id="LN5775">5775</td><td class="line">    <span class='keyword'>if</span> (!consistent) {</td></tr>
<tr class="codeline" data-linenumber="5776"><td class="num" id="LN5776">5776</td><td class="line">        <span class='macro'>sds<span class='macro_popup'>hisds</span></span> err = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(<span class='string_literal'>"[ERR] Nodes don't agree about configuration!"</span>);</td></tr>
<tr class="codeline" data-linenumber="5777"><td class="num" id="LN5777">5777</td><td class="line">        clusterManagerOnError(err);</td></tr>
<tr class="codeline" data-linenumber="5778"><td class="num" id="LN5778">5778</td><td class="line">        result = 0;</td></tr>
<tr class="codeline" data-linenumber="5779"><td class="num" id="LN5779">5779</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="5780"><td class="num" id="LN5780">5780</td><td class="line">        <span class='macro'>clusterManagerLogOk(<span class='string_literal'>"[OK] All nodes agree about slots "<span class='macro_popup'>clusterManagerLog(4,"[OK] All nodes agree about slots " "configuration.\n"<br>)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="5781"><td class="num" id="LN5781">5781</td><td class="line">                            <span class='string_literal'><span class='macro'>"configuration.\n"</span>)<span class='macro_popup'>clusterManagerLog(4,"[OK] All nodes agree about slots " "configuration.\n"<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5782"><td class="num" id="LN5782">5782</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5783"><td class="num" id="LN5783">5783</td><td class="line">    <span class='comment'>/* Check open slots */</span></td></tr>
<tr class="codeline" data-linenumber="5784"><td class="num" id="LN5784">5784</td><td class="line">    <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Check for open slots...\n"</span>)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Check for open slots...\n")</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5785"><td class="num" id="LN5785">5785</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="5786"><td class="num" id="LN5786">5786</td><td class="line">    listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="5787"><td class="num" id="LN5787">5787</td><td class="line">    <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="5788"><td class="num" id="LN5788">5788</td><td class="line">    dict *open_slots = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5789"><td class="num" id="LN5789">5789</td><td class="line">    <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5790"><td class="num" id="LN5790">5790</td><td class="line">        clusterManagerNode *n = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5791"><td class="num" id="LN5791">5791</td><td class="line">        <span class='keyword'>if</span> (n-&gt;migrating != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5792"><td class="num" id="LN5792">5792</td><td class="line">            <span class='keyword'>if</span> (open_slots == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5793"><td class="num" id="LN5793">5793</td><td class="line">                open_slots = dictCreate(&amp;clusterManagerDictType);</td></tr>
<tr class="codeline" data-linenumber="5794"><td class="num" id="LN5794">5794</td><td class="line">            <span class='macro'>sds<span class='macro_popup'>hisds</span></span> errstr = <span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>();</td></tr>
<tr class="codeline" data-linenumber="5795"><td class="num" id="LN5795">5795</td><td class="line">            errstr = <span class='macro'>sdscatprintf<span class='macro_popup'>hi_sdscatprintf</span></span>(errstr,</td></tr>
<tr class="codeline" data-linenumber="5796"><td class="num" id="LN5796">5796</td><td class="line">                                <span class='string_literal'>"[WARNING] Node %s:%d has slots in "</span></td></tr>
<tr class="codeline" data-linenumber="5797"><td class="num" id="LN5797">5797</td><td class="line">                                <span class='string_literal'>"migrating state "</span>,</td></tr>
<tr class="codeline" data-linenumber="5798"><td class="num" id="LN5798">5798</td><td class="line">                                n-&gt;ip,</td></tr>
<tr class="codeline" data-linenumber="5799"><td class="num" id="LN5799">5799</td><td class="line">                                n-&gt;port);</td></tr>
<tr class="codeline" data-linenumber="5800"><td class="num" id="LN5800">5800</td><td class="line">            <span class='keyword'>for</span> (i = 0; i &lt; n-&gt;migrating_count; i += 2) {</td></tr>
<tr class="codeline" data-linenumber="5801"><td class="num" id="LN5801">5801</td><td class="line">                <span class='macro'>sds<span class='macro_popup'>hisds</span></span> slot = n-&gt;migrating[i];</td></tr>
<tr class="codeline" data-linenumber="5802"><td class="num" id="LN5802">5802</td><td class="line">                dictReplace(open_slots, slot, <span class='macro'>sdsdup<span class='macro_popup'>hi_sdsdup</span></span>(n-&gt;migrating[i + 1]));</td></tr>
<tr class="codeline" data-linenumber="5803"><td class="num" id="LN5803">5803</td><td class="line">                <span class='keyword'>char</span> *fmt = (i &gt; 0 ? <span class='string_literal'>",%S"</span> : <span class='string_literal'>"%S"</span>);</td></tr>
<tr class="codeline" data-linenumber="5804"><td class="num" id="LN5804">5804</td><td class="line">                errstr = <span class='macro'>sdscatfmt<span class='macro_popup'>hi_sdscatfmt</span></span>(errstr, fmt, slot);</td></tr>
<tr class="codeline" data-linenumber="5805"><td class="num" id="LN5805">5805</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="5806"><td class="num" id="LN5806">5806</td><td class="line">            errstr = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(errstr, <span class='string_literal'>"."</span>);</td></tr>
<tr class="codeline" data-linenumber="5807"><td class="num" id="LN5807">5807</td><td class="line">            clusterManagerOnError(errstr);</td></tr>
<tr class="codeline" data-linenumber="5808"><td class="num" id="LN5808">5808</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5809"><td class="num" id="LN5809">5809</td><td class="line">        <span class='keyword'>if</span> (n-&gt;importing != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5810"><td class="num" id="LN5810">5810</td><td class="line">            <span class='keyword'>if</span> (open_slots == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5811"><td class="num" id="LN5811">5811</td><td class="line">                open_slots = dictCreate(&amp;clusterManagerDictType);</td></tr>
<tr class="codeline" data-linenumber="5812"><td class="num" id="LN5812">5812</td><td class="line">            <span class='macro'>sds<span class='macro_popup'>hisds</span></span> errstr = <span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>();</td></tr>
<tr class="codeline" data-linenumber="5813"><td class="num" id="LN5813">5813</td><td class="line">            errstr = <span class='macro'>sdscatprintf<span class='macro_popup'>hi_sdscatprintf</span></span>(errstr,</td></tr>
<tr class="codeline" data-linenumber="5814"><td class="num" id="LN5814">5814</td><td class="line">                                <span class='string_literal'>"[WARNING] Node %s:%d has slots in "</span></td></tr>
<tr class="codeline" data-linenumber="5815"><td class="num" id="LN5815">5815</td><td class="line">                                <span class='string_literal'>"importing state "</span>,</td></tr>
<tr class="codeline" data-linenumber="5816"><td class="num" id="LN5816">5816</td><td class="line">                                n-&gt;ip,</td></tr>
<tr class="codeline" data-linenumber="5817"><td class="num" id="LN5817">5817</td><td class="line">                                n-&gt;port);</td></tr>
<tr class="codeline" data-linenumber="5818"><td class="num" id="LN5818">5818</td><td class="line">            <span class='keyword'>for</span> (i = 0; i &lt; n-&gt;importing_count; i += 2) {</td></tr>
<tr class="codeline" data-linenumber="5819"><td class="num" id="LN5819">5819</td><td class="line">                <span class='macro'>sds<span class='macro_popup'>hisds</span></span> slot = n-&gt;importing[i];</td></tr>
<tr class="codeline" data-linenumber="5820"><td class="num" id="LN5820">5820</td><td class="line">                dictReplace(open_slots, slot, <span class='macro'>sdsdup<span class='macro_popup'>hi_sdsdup</span></span>(n-&gt;importing[i + 1]));</td></tr>
<tr class="codeline" data-linenumber="5821"><td class="num" id="LN5821">5821</td><td class="line">                <span class='keyword'>char</span> *fmt = (i &gt; 0 ? <span class='string_literal'>",%S"</span> : <span class='string_literal'>"%S"</span>);</td></tr>
<tr class="codeline" data-linenumber="5822"><td class="num" id="LN5822">5822</td><td class="line">                errstr = <span class='macro'>sdscatfmt<span class='macro_popup'>hi_sdscatfmt</span></span>(errstr, fmt, slot);</td></tr>
<tr class="codeline" data-linenumber="5823"><td class="num" id="LN5823">5823</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="5824"><td class="num" id="LN5824">5824</td><td class="line">            errstr = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(errstr, <span class='string_literal'>"."</span>);</td></tr>
<tr class="codeline" data-linenumber="5825"><td class="num" id="LN5825">5825</td><td class="line">            clusterManagerOnError(errstr);</td></tr>
<tr class="codeline" data-linenumber="5826"><td class="num" id="LN5826">5826</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5827"><td class="num" id="LN5827">5827</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5828"><td class="num" id="LN5828">5828</td><td class="line">    <span class='keyword'>if</span> (open_slots != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5829"><td class="num" id="LN5829">5829</td><td class="line">        result = 0;</td></tr>
<tr class="codeline" data-linenumber="5830"><td class="num" id="LN5830">5830</td><td class="line">        dictIterator *iter = dictGetIterator(open_slots);</td></tr>
<tr class="codeline" data-linenumber="5831"><td class="num" id="LN5831">5831</td><td class="line">        dictEntry *entry;</td></tr>
<tr class="codeline" data-linenumber="5832"><td class="num" id="LN5832">5832</td><td class="line">        <span class='macro'>sds<span class='macro_popup'>hisds</span></span> errstr = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(<span class='string_literal'>"[WARNING] The following slots are open: "</span>);</td></tr>
<tr class="codeline" data-linenumber="5833"><td class="num" id="LN5833">5833</td><td class="line">        i = 0;</td></tr>
<tr class="codeline" data-linenumber="5834"><td class="num" id="LN5834">5834</td><td class="line">        <span class='keyword'>while</span> ((entry = dictNext(iter)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5835"><td class="num" id="LN5835">5835</td><td class="line">            <span class='macro'>sds<span class='macro_popup'>hisds</span></span> slot = (<span class='macro'>sds<span class='macro_popup'>hisds</span></span>) <span class='macro'>dictGetKey(entry)<span class='macro_popup'>((entry)-&gt;key)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5836"><td class="num" id="LN5836">5836</td><td class="line">            <span class='keyword'>char</span> *fmt = (i++ &gt; 0 ? <span class='string_literal'>",%S"</span> : <span class='string_literal'>"%S"</span>);</td></tr>
<tr class="codeline" data-linenumber="5837"><td class="num" id="LN5837">5837</td><td class="line">            errstr = <span class='macro'>sdscatfmt<span class='macro_popup'>hi_sdscatfmt</span></span>(errstr, fmt, slot);</td></tr>
<tr class="codeline" data-linenumber="5838"><td class="num" id="LN5838">5838</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5839"><td class="num" id="LN5839">5839</td><td class="line">        <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"%s.\n"</span>, (<span class='keyword'>char</span> *) errstr)<span class='macro_popup'>clusterManagerLog(3,"%s.\n", (char *) errstr)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5840"><td class="num" id="LN5840">5840</td><td class="line">        <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(errstr);</td></tr>
<tr class="codeline" data-linenumber="5841"><td class="num" id="LN5841">5841</td><td class="line">        <span class='keyword'>if</span> (do_fix) {</td></tr>
<tr class="codeline" data-linenumber="5842"><td class="num" id="LN5842">5842</td><td class="line">            <span class='comment'>/* Fix open slots. */</span></td></tr>
<tr class="codeline" data-linenumber="5843"><td class="num" id="LN5843">5843</td><td class="line">            dictReleaseIterator(iter);</td></tr>
<tr class="codeline" data-linenumber="5844"><td class="num" id="LN5844">5844</td><td class="line">            iter = dictGetIterator(open_slots);</td></tr>
<tr class="codeline" data-linenumber="5845"><td class="num" id="LN5845">5845</td><td class="line">            <span class='keyword'>while</span> ((entry = dictNext(iter)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5846"><td class="num" id="LN5846">5846</td><td class="line">                <span class='macro'>sds<span class='macro_popup'>hisds</span></span> slot = (<span class='macro'>sds<span class='macro_popup'>hisds</span></span>) <span class='macro'>dictGetKey(entry)<span class='macro_popup'>((entry)-&gt;key)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5847"><td class="num" id="LN5847">5847</td><td class="line">                result = clusterManagerFixOpenSlot(atoi(slot));</td></tr>
<tr class="codeline" data-linenumber="5848"><td class="num" id="LN5848">5848</td><td class="line">                <span class='keyword'>if</span> (!result) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="5849"><td class="num" id="LN5849">5849</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="5850"><td class="num" id="LN5850">5850</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5851"><td class="num" id="LN5851">5851</td><td class="line">        dictReleaseIterator(iter);</td></tr>
<tr class="codeline" data-linenumber="5852"><td class="num" id="LN5852">5852</td><td class="line">        dictRelease(open_slots);</td></tr>
<tr class="codeline" data-linenumber="5853"><td class="num" id="LN5853">5853</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5854"><td class="num" id="LN5854">5854</td><td class="line">    <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Check slots coverage...\n"</span>)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Check slots coverage...\n")</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5855"><td class="num" id="LN5855">5855</td><td class="line">    <span class='keyword'>char</span> slots[<span class='macro'>CLUSTER_MANAGER_SLOTS<span class='macro_popup'>16384</span></span>];</td></tr>
<tr class="codeline" data-linenumber="5856"><td class="num" id="LN5856">5856</td><td class="line">    memset(slots, 0, <span class='macro'>CLUSTER_MANAGER_SLOTS<span class='macro_popup'>16384</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5857"><td class="num" id="LN5857">5857</td><td class="line">    <span class='keyword'>int</span> coverage = clusterManagerGetCoveredSlots(slots);</td></tr>
<tr class="codeline" data-linenumber="5858"><td class="num" id="LN5858">5858</td><td class="line">    <span class='keyword'>if</span> (coverage == <span class='macro'>CLUSTER_MANAGER_SLOTS<span class='macro_popup'>16384</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5859"><td class="num" id="LN5859">5859</td><td class="line">        <span class='macro'>clusterManagerLogOk(<span class='string_literal'>"[OK] All %d slots covered.\n"</span>,<span class='macro_popup'>clusterManagerLog(4,"[OK] All %d slots covered.\n", 16384)</span></span></td></tr>
<tr class="codeline" data-linenumber="5860"><td class="num" id="LN5860">5860</td><td class="line">                            <span class='macro'>CLUSTER_MANAGER_SLOTS)<span class='macro_popup'>clusterManagerLog(4,"[OK] All %d slots covered.\n", 16384)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5861"><td class="num" id="LN5861">5861</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="5862"><td class="num" id="LN5862">5862</td><td class="line">        <span class='macro'>sds<span class='macro_popup'>hisds</span></span> err = <span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>();</td></tr>
<tr class="codeline" data-linenumber="5863"><td class="num" id="LN5863">5863</td><td class="line">        err = <span class='macro'>sdscatprintf<span class='macro_popup'>hi_sdscatprintf</span></span>(err, <span class='string_literal'>"[ERR] Not all %d slots are "</span></td></tr>
<tr class="codeline" data-linenumber="5864"><td class="num" id="LN5864">5864</td><td class="line">                                <span class='string_literal'>"covered by nodes.\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="5865"><td class="num" id="LN5865">5865</td><td class="line">                                <span class='macro'>CLUSTER_MANAGER_SLOTS<span class='macro_popup'>16384</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5866"><td class="num" id="LN5866">5866</td><td class="line">        clusterManagerOnError(err);</td></tr>
<tr class="codeline" data-linenumber="5867"><td class="num" id="LN5867">5867</td><td class="line">        result = 0;</td></tr>
<tr class="codeline" data-linenumber="5868"><td class="num" id="LN5868">5868</td><td class="line">        <span class='keyword'>if</span> (do_fix<span class='comment'>/* &amp;&amp; result*/</span>) {</td></tr>
<tr class="codeline" data-linenumber="5869"><td class="num" id="LN5869">5869</td><td class="line">            dictType dtype = clusterManagerDictType;</td></tr>
<tr class="codeline" data-linenumber="5870"><td class="num" id="LN5870">5870</td><td class="line">            dtype.keyDestructor = dictSdsDestructor;</td></tr>
<tr class="codeline" data-linenumber="5871"><td class="num" id="LN5871">5871</td><td class="line">            dtype.valDestructor = dictListDestructor;</td></tr>
<tr class="codeline" data-linenumber="5872"><td class="num" id="LN5872">5872</td><td class="line">            clusterManagerUncoveredSlots = dictCreate(&amp;dtype);</td></tr>
<tr class="codeline" data-linenumber="5873"><td class="num" id="LN5873">5873</td><td class="line">            <span class='keyword'>int</span> fixed = clusterManagerFixSlotsCoverage(slots);</td></tr>
<tr class="codeline" data-linenumber="5874"><td class="num" id="LN5874">5874</td><td class="line">            <span class='keyword'>if</span> (fixed &gt; 0) result = 1;</td></tr>
<tr class="codeline" data-linenumber="5875"><td class="num" id="LN5875">5875</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5876"><td class="num" id="LN5876">5876</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5877"><td class="num" id="LN5877">5877</td><td class="line">    <span class='keyword'>int</span> search_multiple_owners = config.cluster_manager_command.flags &amp;</td></tr>
<tr class="codeline" data-linenumber="5878"><td class="num" id="LN5878">5878</td><td class="line">                                 <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_CHECK_OWNERS<span class='macro_popup'>1 &lt;&lt; 9</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5879"><td class="num" id="LN5879">5879</td><td class="line">    <span class='keyword'>if</span> (search_multiple_owners) {</td></tr>
<tr class="codeline" data-linenumber="5880"><td class="num" id="LN5880">5880</td><td class="line">        <span class='comment'>/* Check whether there are multiple owners, even when slots are</span></td></tr>
<tr class="codeline" data-linenumber="5881"><td class="num" id="LN5881">5881</td><td class="line">         <span class='comment'>* fully covered and there are no open slots. */</span></td></tr>
<tr class="codeline" data-linenumber="5882"><td class="num" id="LN5882">5882</td><td class="line">        <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Check for multiple slot owners...\n"</span>)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Check for multiple slot owners...\n"<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5883"><td class="num" id="LN5883">5883</td><td class="line">        <span class='keyword'>int</span> slot = 0, slots_with_multiple_owners = 0;</td></tr>
<tr class="codeline" data-linenumber="5884"><td class="num" id="LN5884">5884</td><td class="line">        <span class='keyword'>for</span> (; slot &lt; <span class='macro'>CLUSTER_MANAGER_SLOTS<span class='macro_popup'>16384</span></span>; slot++) {</td></tr>
<tr class="codeline" data-linenumber="5885"><td class="num" id="LN5885">5885</td><td class="line">            listIter li;</td></tr>
<tr class="codeline" data-linenumber="5886"><td class="num" id="LN5886">5886</td><td class="line">            listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="5887"><td class="num" id="LN5887">5887</td><td class="line">            listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="5888"><td class="num" id="LN5888">5888</td><td class="line">            list *owners = listCreate();</td></tr>
<tr class="codeline" data-linenumber="5889"><td class="num" id="LN5889">5889</td><td class="line">            <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5890"><td class="num" id="LN5890">5890</td><td class="line">                clusterManagerNode *n = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5891"><td class="num" id="LN5891">5891</td><td class="line">                <span class='keyword'>if</span> (n-&gt;flags &amp; <span class='macro'>CLUSTER_MANAGER_FLAG_SLAVE<span class='macro_popup'>1 &lt;&lt; 1</span></span>) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="5892"><td class="num" id="LN5892">5892</td><td class="line">                <span class='keyword'>if</span> (n-&gt;slots[slot]) listAddNodeTail(owners, n);</td></tr>
<tr class="codeline" data-linenumber="5893"><td class="num" id="LN5893">5893</td><td class="line">                <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="5894"><td class="num" id="LN5894">5894</td><td class="line">                    <span class='comment'>/* Nodes having keys for the slot will be considered</span></td></tr>
<tr class="codeline" data-linenumber="5895"><td class="num" id="LN5895">5895</td><td class="line">                     <span class='comment'>* owners too. */</span></td></tr>
<tr class="codeline" data-linenumber="5896"><td class="num" id="LN5896">5896</td><td class="line">                    <span class='keyword'>int</span> count = clusterManagerCountKeysInSlot(n, slot);</td></tr>
<tr class="codeline" data-linenumber="5897"><td class="num" id="LN5897">5897</td><td class="line">                    <span class='keyword'>if</span> (count &gt; 0) listAddNodeTail(owners, n);</td></tr>
<tr class="codeline" data-linenumber="5898"><td class="num" id="LN5898">5898</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="5899"><td class="num" id="LN5899">5899</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="5900"><td class="num" id="LN5900">5900</td><td class="line">            <span class='keyword'>if</span> (<span class='macro'>listLength(owners)<span class='macro_popup'>((owners)-&gt;len)</span></span> &gt; 1) {</td></tr>
<tr class="codeline" data-linenumber="5901"><td class="num" id="LN5901">5901</td><td class="line">                result = 0;</td></tr>
<tr class="codeline" data-linenumber="5902"><td class="num" id="LN5902">5902</td><td class="line">                <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"[WARNING] Slot %d has %d owners:\n"</span>,<span class='macro_popup'>clusterManagerLog(3,"[WARNING] Slot %d has %d owners:\n", slot<br>, ((owners)-&gt;len))</span></span></td></tr>
<tr class="codeline" data-linenumber="5903"><td class="num" id="LN5903">5903</td><td class="line">                                     <span class='macro'>slot, listLength(owners))<span class='macro_popup'>clusterManagerLog(3,"[WARNING] Slot %d has %d owners:\n", slot<br>, ((owners)-&gt;len))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5904"><td class="num" id="LN5904">5904</td><td class="line">                listRewind(owners, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="5905"><td class="num" id="LN5905">5905</td><td class="line">                <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5906"><td class="num" id="LN5906">5906</td><td class="line">                    clusterManagerNode *n = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5907"><td class="num" id="LN5907">5907</td><td class="line">                    <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"    %s:%d\n"</span>, n-&gt;ip, n-&gt;port)<span class='macro_popup'>clusterManagerLog(3,"    %s:%d\n", n-&gt;ip, n-&gt;port)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5908"><td class="num" id="LN5908">5908</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="5909"><td class="num" id="LN5909">5909</td><td class="line">                slots_with_multiple_owners++;</td></tr>
<tr class="codeline" data-linenumber="5910"><td class="num" id="LN5910">5910</td><td class="line">                <span class='keyword'>if</span> (do_fix) {</td></tr>
<tr class="codeline" data-linenumber="5911"><td class="num" id="LN5911">5911</td><td class="line">                    result = clusterManagerFixMultipleSlotOwners(slot, owners);</td></tr>
<tr class="codeline" data-linenumber="5912"><td class="num" id="LN5912">5912</td><td class="line">                    <span class='keyword'>if</span> (!result) {</td></tr>
<tr class="codeline" data-linenumber="5913"><td class="num" id="LN5913">5913</td><td class="line">                        <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"Failed to fix multiple owners "<span class='macro_popup'>clusterManagerLog(3,"Failed to fix multiple owners " "for slot %d\n"<br>, slot)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="5914"><td class="num" id="LN5914">5914</td><td class="line">                                             <span class='string_literal'><span class='macro'>"for slot %d\n"</span>, slot)<span class='macro_popup'>clusterManagerLog(3,"Failed to fix multiple owners " "for slot %d\n"<br>, slot)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5915"><td class="num" id="LN5915">5915</td><td class="line">                        listRelease(owners);</td></tr>
<tr class="codeline" data-linenumber="5916"><td class="num" id="LN5916">5916</td><td class="line">                        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="5917"><td class="num" id="LN5917">5917</td><td class="line">                    } <span class='keyword'>else</span> slots_with_multiple_owners--;</td></tr>
<tr class="codeline" data-linenumber="5918"><td class="num" id="LN5918">5918</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="5919"><td class="num" id="LN5919">5919</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="5920"><td class="num" id="LN5920">5920</td><td class="line">            listRelease(owners);</td></tr>
<tr class="codeline" data-linenumber="5921"><td class="num" id="LN5921">5921</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5922"><td class="num" id="LN5922">5922</td><td class="line">        <span class='keyword'>if</span> (slots_with_multiple_owners == 0)</td></tr>
<tr class="codeline" data-linenumber="5923"><td class="num" id="LN5923">5923</td><td class="line">            <span class='macro'>clusterManagerLogOk(<span class='string_literal'>"[OK] No multiple owners found.\n"</span>)<span class='macro_popup'>clusterManagerLog(4,"[OK] No multiple owners found.\n")</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5924"><td class="num" id="LN5924">5924</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5925"><td class="num" id="LN5925">5925</td><td class="line">    <span class='keyword'>return</span> result;</td></tr>
<tr class="codeline" data-linenumber="5926"><td class="num" id="LN5926">5926</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5927"><td class="num" id="LN5927">5927</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5928"><td class="num" id="LN5928">5928</td><td class="line"><span class='keyword'>static</span> clusterManagerNode *clusterNodeForResharding(<span class='keyword'>char</span> *id,</td></tr>
<tr class="codeline" data-linenumber="5929"><td class="num" id="LN5929">5929</td><td class="line">                                                    clusterManagerNode *target,</td></tr>
<tr class="codeline" data-linenumber="5930"><td class="num" id="LN5930">5930</td><td class="line">                                                    <span class='keyword'>int</span> *raise_err)</td></tr>
<tr class="codeline" data-linenumber="5931"><td class="num" id="LN5931">5931</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="5932"><td class="num" id="LN5932">5932</td><td class="line">    clusterManagerNode *node = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5933"><td class="num" id="LN5933">5933</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>char</span> *invalid_node_msg = <span class='string_literal'>"*** The specified node (%s) is not known "</span></td></tr>
<tr class="codeline" data-linenumber="5934"><td class="num" id="LN5934">5934</td><td class="line">                                   <span class='string_literal'>"or not a master, please retry.\n"</span>;</td></tr>
<tr class="codeline" data-linenumber="5935"><td class="num" id="LN5935">5935</td><td class="line">    node = clusterManagerNodeByName(id);</td></tr>
<tr class="codeline" data-linenumber="5936"><td class="num" id="LN5936">5936</td><td class="line">    *raise_err = 0;</td></tr>
<tr class="codeline" data-linenumber="5937"><td class="num" id="LN5937">5937</td><td class="line">    <span class='keyword'>if</span> (!node || node-&gt;flags &amp; <span class='macro'>CLUSTER_MANAGER_FLAG_SLAVE<span class='macro_popup'>1 &lt;&lt; 1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5938"><td class="num" id="LN5938">5938</td><td class="line">        <span class='macro'>clusterManagerLogErr(invalid_node_msg, id)<span class='macro_popup'>clusterManagerLog(3,invalid_node_msg, id)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5939"><td class="num" id="LN5939">5939</td><td class="line">        *raise_err = 1;</td></tr>
<tr class="codeline" data-linenumber="5940"><td class="num" id="LN5940">5940</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5941"><td class="num" id="LN5941">5941</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (target != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5942"><td class="num" id="LN5942">5942</td><td class="line">        <span class='keyword'>if</span> (!strcmp(node-&gt;name, target-&gt;name)) {</td></tr>
<tr class="codeline" data-linenumber="5943"><td class="num" id="LN5943">5943</td><td class="line">            <span class='macro'>clusterManagerLogErr( <span class='string_literal'>"*** It is not possible to use "<span class='macro_popup'>clusterManagerLog(3,"*** It is not possible to use " "the target node as "<br> "source node.\n")</span></span></span></td></tr>
<tr class="codeline" data-linenumber="5944"><td class="num" id="LN5944">5944</td><td class="line">                                  <span class='string_literal'><span class='macro'>"the target node as "<span class='macro_popup'>clusterManagerLog(3,"*** It is not possible to use " "the target node as "<br> "source node.\n")</span></span></span></td></tr>
<tr class="codeline" data-linenumber="5945"><td class="num" id="LN5945">5945</td><td class="line">                                  <span class='string_literal'><span class='macro'>"source node.\n"</span>)<span class='macro_popup'>clusterManagerLog(3,"*** It is not possible to use " "the target node as "<br> "source node.\n")</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5946"><td class="num" id="LN5946">5946</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5947"><td class="num" id="LN5947">5947</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5948"><td class="num" id="LN5948">5948</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5949"><td class="num" id="LN5949">5949</td><td class="line">    <span class='keyword'>return</span> node;</td></tr>
<tr class="codeline" data-linenumber="5950"><td class="num" id="LN5950">5950</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5951"><td class="num" id="LN5951">5951</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5952"><td class="num" id="LN5952">5952</td><td class="line"><span class='keyword'>static</span> list *clusterManagerComputeReshardTable(list *sources, <span class='keyword'>int</span> numslots) {</td></tr>
<tr class="codeline" data-linenumber="5953"><td class="num" id="LN5953">5953</td><td class="line">    list *moved = listCreate();</td></tr>
<tr class="codeline" data-linenumber="5954"><td class="num" id="LN5954">5954</td><td class="line">    <span class='keyword'>int</span> src_count = <span class='macro'>listLength(sources)<span class='macro_popup'>((sources)-&gt;len)</span></span>, i = 0, tot_slots = 0, j;</td></tr>
<tr class="codeline" data-linenumber="5955"><td class="num" id="LN5955">5955</td><td class="line">    clusterManagerNode **sorted = zmalloc(src_count * <span class='keyword'>sizeof</span>(*sorted));</td></tr>
<tr class="codeline" data-linenumber="5956"><td class="num" id="LN5956">5956</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="5957"><td class="num" id="LN5957">5957</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="5958"><td class="num" id="LN5958">5958</td><td class="line">    listRewind(sources, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="5959"><td class="num" id="LN5959">5959</td><td class="line">    <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5960"><td class="num" id="LN5960">5960</td><td class="line">        clusterManagerNode *node = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5961"><td class="num" id="LN5961">5961</td><td class="line">        tot_slots += node-&gt;slots_count;</td></tr>
<tr class="codeline" data-linenumber="5962"><td class="num" id="LN5962">5962</td><td class="line">        sorted[i++] = node;</td></tr>
<tr class="codeline" data-linenumber="5963"><td class="num" id="LN5963">5963</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5964"><td class="num" id="LN5964">5964</td><td class="line">    qsort(sorted, src_count, <span class='keyword'>sizeof</span>(clusterManagerNode *),</td></tr>
<tr class="codeline" data-linenumber="5965"><td class="num" id="LN5965">5965</td><td class="line">          clusterManagerSlotCountCompareDesc);</td></tr>
<tr class="codeline" data-linenumber="5966"><td class="num" id="LN5966">5966</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; src_count; i++) {</td></tr>
<tr class="codeline" data-linenumber="5967"><td class="num" id="LN5967">5967</td><td class="line">        clusterManagerNode *node = sorted[i];</td></tr>
<tr class="codeline" data-linenumber="5968"><td class="num" id="LN5968">5968</td><td class="line">        <span class='keyword'>float</span> n = ((<span class='keyword'>float</span>) numslots / tot_slots * node-&gt;slots_count);</td></tr>
<tr class="codeline" data-linenumber="5969"><td class="num" id="LN5969">5969</td><td class="line">        <span class='keyword'>if</span> (i == 0) n = ceil(n);</td></tr>
<tr class="codeline" data-linenumber="5970"><td class="num" id="LN5970">5970</td><td class="line">        <span class='keyword'>else</span> n = floor(n);</td></tr>
<tr class="codeline" data-linenumber="5971"><td class="num" id="LN5971">5971</td><td class="line">        <span class='keyword'>int</span> max = (<span class='keyword'>int</span>) n, count = 0;</td></tr>
<tr class="codeline" data-linenumber="5972"><td class="num" id="LN5972">5972</td><td class="line">        <span class='keyword'>for</span> (j = 0; j &lt; <span class='macro'>CLUSTER_MANAGER_SLOTS<span class='macro_popup'>16384</span></span>; j++) {</td></tr>
<tr class="codeline" data-linenumber="5973"><td class="num" id="LN5973">5973</td><td class="line">            <span class='keyword'>int</span> slot = node-&gt;slots[j];</td></tr>
<tr class="codeline" data-linenumber="5974"><td class="num" id="LN5974">5974</td><td class="line">            <span class='keyword'>if</span> (!slot) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="5975"><td class="num" id="LN5975">5975</td><td class="line">            <span class='keyword'>if</span> (count &gt;= max || (<span class='keyword'>int</span>)<span class='macro'>listLength(moved)<span class='macro_popup'>((moved)-&gt;len)</span></span> &gt;= numslots) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="5976"><td class="num" id="LN5976">5976</td><td class="line">            clusterManagerReshardTableItem *item = zmalloc(<span class='keyword'>sizeof</span>(*item));</td></tr>
<tr class="codeline" data-linenumber="5977"><td class="num" id="LN5977">5977</td><td class="line">            item-&gt;source = node;</td></tr>
<tr class="codeline" data-linenumber="5978"><td class="num" id="LN5978">5978</td><td class="line">            item-&gt;slot = j;</td></tr>
<tr class="codeline" data-linenumber="5979"><td class="num" id="LN5979">5979</td><td class="line">            listAddNodeTail(moved, item);</td></tr>
<tr class="codeline" data-linenumber="5980"><td class="num" id="LN5980">5980</td><td class="line">            count++;</td></tr>
<tr class="codeline" data-linenumber="5981"><td class="num" id="LN5981">5981</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5982"><td class="num" id="LN5982">5982</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5983"><td class="num" id="LN5983">5983</td><td class="line">    zfree(sorted);</td></tr>
<tr class="codeline" data-linenumber="5984"><td class="num" id="LN5984">5984</td><td class="line">    <span class='keyword'>return</span> moved;</td></tr>
<tr class="codeline" data-linenumber="5985"><td class="num" id="LN5985">5985</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5986"><td class="num" id="LN5986">5986</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5987"><td class="num" id="LN5987">5987</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> clusterManagerShowReshardTable(list *table) {</td></tr>
<tr class="codeline" data-linenumber="5988"><td class="num" id="LN5988">5988</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="5989"><td class="num" id="LN5989">5989</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="5990"><td class="num" id="LN5990">5990</td><td class="line">    listRewind(table, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="5991"><td class="num" id="LN5991">5991</td><td class="line">    <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5992"><td class="num" id="LN5992">5992</td><td class="line">        clusterManagerReshardTableItem *item = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="5993"><td class="num" id="LN5993">5993</td><td class="line">        clusterManagerNode *n = item-&gt;source;</td></tr>
<tr class="codeline" data-linenumber="5994"><td class="num" id="LN5994">5994</td><td class="line">        printf(<span class='string_literal'>"    Moving slot %d from %s\n"</span>, item-&gt;slot, (<span class='keyword'>char</span> *) n-&gt;name);</td></tr>
<tr class="codeline" data-linenumber="5995"><td class="num" id="LN5995">5995</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5996"><td class="num" id="LN5996">5996</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5997"><td class="num" id="LN5997">5997</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5998"><td class="num" id="LN5998">5998</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> clusterManagerReleaseReshardTable(list *table) {</td></tr>
<tr class="codeline" data-linenumber="5999"><td class="num" id="LN5999">5999</td><td class="line">    <span class='keyword'>if</span> (table != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6000"><td class="num" id="LN6000">6000</td><td class="line">        listIter li;</td></tr>
<tr class="codeline" data-linenumber="6001"><td class="num" id="LN6001">6001</td><td class="line">        listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="6002"><td class="num" id="LN6002">6002</td><td class="line">        listRewind(table, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="6003"><td class="num" id="LN6003">6003</td><td class="line">        <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6004"><td class="num" id="LN6004">6004</td><td class="line">            clusterManagerReshardTableItem *item = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="6005"><td class="num" id="LN6005">6005</td><td class="line">            zfree(item);</td></tr>
<tr class="codeline" data-linenumber="6006"><td class="num" id="LN6006">6006</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6007"><td class="num" id="LN6007">6007</td><td class="line">        listRelease(table);</td></tr>
<tr class="codeline" data-linenumber="6008"><td class="num" id="LN6008">6008</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6009"><td class="num" id="LN6009">6009</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="6010"><td class="num" id="LN6010">6010</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6011"><td class="num" id="LN6011">6011</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> clusterManagerLog(<span class='keyword'>int</span> level, <span class='keyword'>const</span> <span class='keyword'>char</span>* fmt, ...) {</td></tr>
<tr class="codeline" data-linenumber="6012"><td class="num" id="LN6012">6012</td><td class="line">    <span class='keyword'>int</span> use_colors =</td></tr>
<tr class="codeline" data-linenumber="6013"><td class="num" id="LN6013">6013</td><td class="line">        (config.cluster_manager_command.flags &amp; <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_COLOR<span class='macro_popup'>1 &lt;&lt; 8</span></span>);</td></tr>
<tr class="codeline" data-linenumber="6014"><td class="num" id="LN6014">6014</td><td class="line">    <span class='keyword'>if</span> (use_colors) {</td></tr>
<tr class="codeline" data-linenumber="6015"><td class="num" id="LN6015">6015</td><td class="line">        printf(<span class='string_literal'>"\033["</span>);</td></tr>
<tr class="codeline" data-linenumber="6016"><td class="num" id="LN6016">6016</td><td class="line">        <span class='keyword'>switch</span> (level) {</td></tr>
<tr class="codeline" data-linenumber="6017"><td class="num" id="LN6017">6017</td><td class="line">        <span class='keyword'>case</span> <span class='macro'>CLUSTER_MANAGER_LOG_LVL_INFO<span class='macro_popup'>1</span></span>: printf(<span class='macro'>LOG_COLOR_BOLD<span class='macro_popup'>"29;1m"</span></span>); <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="6018"><td class="num" id="LN6018">6018</td><td class="line">        <span class='keyword'>case</span> <span class='macro'>CLUSTER_MANAGER_LOG_LVL_WARN<span class='macro_popup'>2</span></span>: printf(<span class='macro'>LOG_COLOR_YELLOW<span class='macro_popup'>"33;1m"</span></span>); <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="6019"><td class="num" id="LN6019">6019</td><td class="line">        <span class='keyword'>case</span> <span class='macro'>CLUSTER_MANAGER_LOG_LVL_ERR<span class='macro_popup'>3</span></span>: printf(<span class='macro'>LOG_COLOR_RED<span class='macro_popup'>"31;1m"</span></span>); <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="6020"><td class="num" id="LN6020">6020</td><td class="line">        <span class='keyword'>case</span> <span class='macro'>CLUSTER_MANAGER_LOG_LVL_SUCCESS<span class='macro_popup'>4</span></span>: printf(<span class='macro'>LOG_COLOR_GREEN<span class='macro_popup'>"32;1m"</span></span>); <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="6021"><td class="num" id="LN6021">6021</td><td class="line">        <span class='keyword'>default</span>: printf(<span class='macro'>LOG_COLOR_RESET<span class='macro_popup'>"0m"</span></span>); <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="6022"><td class="num" id="LN6022">6022</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6023"><td class="num" id="LN6023">6023</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6024"><td class="num" id="LN6024">6024</td><td class="line">    va_list ap;</td></tr>
<tr class="codeline" data-linenumber="6025"><td class="num" id="LN6025">6025</td><td class="line">    <span class='macro'>va_start(ap, fmt)<span class='macro_popup'>__builtin_va_start(ap, fmt)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6026"><td class="num" id="LN6026">6026</td><td class="line">    vprintf(fmt, ap);</td></tr>
<tr class="codeline" data-linenumber="6027"><td class="num" id="LN6027">6027</td><td class="line">    <span class='macro'>va_end(ap)<span class='macro_popup'>__builtin_va_end(ap)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6028"><td class="num" id="LN6028">6028</td><td class="line">    <span class='keyword'>if</span> (use_colors) printf(<span class='string_literal'>"\033["</span> <span class='macro'>LOG_COLOR_RESET<span class='macro_popup'>"0m"</span></span>);</td></tr>
<tr class="codeline" data-linenumber="6029"><td class="num" id="LN6029">6029</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="6030"><td class="num" id="LN6030">6030</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6031"><td class="num" id="LN6031">6031</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> clusterManagerNodeArrayInit(clusterManagerNodeArray *array,</td></tr>
<tr class="codeline" data-linenumber="6032"><td class="num" id="LN6032">6032</td><td class="line">                                        <span class='keyword'>int</span> alloc_len)</td></tr>
<tr class="codeline" data-linenumber="6033"><td class="num" id="LN6033">6033</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="6034"><td class="num" id="LN6034">6034</td><td class="line">    array-&gt;nodes = zcalloc(alloc_len * <span class='keyword'>sizeof</span>(clusterManagerNode*));</td></tr>
<tr class="codeline" data-linenumber="6035"><td class="num" id="LN6035">6035</td><td class="line">    array-&gt;alloc = array-&gt;nodes;</td></tr>
<tr class="codeline" data-linenumber="6036"><td class="num" id="LN6036">6036</td><td class="line">    array-&gt;len = alloc_len;</td></tr>
<tr class="codeline" data-linenumber="6037"><td class="num" id="LN6037">6037</td><td class="line">    array-&gt;count = 0;</td></tr>
<tr class="codeline" data-linenumber="6038"><td class="num" id="LN6038">6038</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="6039"><td class="num" id="LN6039">6039</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6040"><td class="num" id="LN6040">6040</td><td class="line"><span class='comment'>/* Reset array-&gt;nodes to the original array allocation and re-count non-NULL</span></td></tr>
<tr class="codeline" data-linenumber="6041"><td class="num" id="LN6041">6041</td><td class="line"> <span class='comment'>* nodes. */</span></td></tr>
<tr class="codeline" data-linenumber="6042"><td class="num" id="LN6042">6042</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> clusterManagerNodeArrayReset(clusterManagerNodeArray *array) {</td></tr>
<tr class="codeline" data-linenumber="6043"><td class="num" id="LN6043">6043</td><td class="line">    <span class='keyword'>if</span> (array-&gt;nodes &gt; array-&gt;alloc) {</td></tr>
<tr class="codeline" data-linenumber="6044"><td class="num" id="LN6044">6044</td><td class="line">        array-&gt;len = array-&gt;nodes - array-&gt;alloc;</td></tr>
<tr class="codeline" data-linenumber="6045"><td class="num" id="LN6045">6045</td><td class="line">        array-&gt;nodes = array-&gt;alloc;</td></tr>
<tr class="codeline" data-linenumber="6046"><td class="num" id="LN6046">6046</td><td class="line">        array-&gt;count = 0;</td></tr>
<tr class="codeline" data-linenumber="6047"><td class="num" id="LN6047">6047</td><td class="line">        <span class='keyword'>int</span> i = 0;</td></tr>
<tr class="codeline" data-linenumber="6048"><td class="num" id="LN6048">6048</td><td class="line">        <span class='keyword'>for</span>(; i &lt; array-&gt;len; i++) {</td></tr>
<tr class="codeline" data-linenumber="6049"><td class="num" id="LN6049">6049</td><td class="line">            <span class='keyword'>if</span> (array-&gt;nodes[i] != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) array-&gt;count++;</td></tr>
<tr class="codeline" data-linenumber="6050"><td class="num" id="LN6050">6050</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6051"><td class="num" id="LN6051">6051</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6052"><td class="num" id="LN6052">6052</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="6053"><td class="num" id="LN6053">6053</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6054"><td class="num" id="LN6054">6054</td><td class="line"><span class='comment'>/* Shift array-&gt;nodes and store the shifted node into 'nodeptr'. */</span></td></tr>
<tr class="codeline" data-linenumber="6055"><td class="num" id="LN6055">6055</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> clusterManagerNodeArrayShift(clusterManagerNodeArray *array,</td></tr>
<tr class="codeline" data-linenumber="6056"><td class="num" id="LN6056">6056</td><td class="line">                                         clusterManagerNode **nodeptr)</td></tr>
<tr class="codeline" data-linenumber="6057"><td class="num" id="LN6057">6057</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="6058"><td class="num" id="LN6058">6058</td><td class="line">    <span class='macro'>assert(array-&gt;len &gt; 0)<span class='macro_popup'>((array-&gt;len &gt; 0) ? (void) (0) : __assert_fail ("array-&gt;len &gt; 0"<br>, "redis-cli.c", 6058, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6059"><td class="num" id="LN6059">6059</td><td class="line">    <span class='comment'>/* If the first node to be shifted is not NULL, decrement count. */</span></td></tr>
<tr class="codeline" data-linenumber="6060"><td class="num" id="LN6060">6060</td><td class="line">    <span class='keyword'>if</span> (*array-&gt;nodes != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) array-&gt;count--;</td></tr>
<tr class="codeline" data-linenumber="6061"><td class="num" id="LN6061">6061</td><td class="line">    <span class='comment'>/* Store the first node to be shifted into 'nodeptr'. */</span></td></tr>
<tr class="codeline" data-linenumber="6062"><td class="num" id="LN6062">6062</td><td class="line">    *nodeptr = *array-&gt;nodes;</td></tr>
<tr class="codeline" data-linenumber="6063"><td class="num" id="LN6063">6063</td><td class="line">    <span class='comment'>/* Shift the nodes array and decrement length. */</span></td></tr>
<tr class="codeline" data-linenumber="6064"><td class="num" id="LN6064">6064</td><td class="line">    array-&gt;nodes++;</td></tr>
<tr class="codeline" data-linenumber="6065"><td class="num" id="LN6065">6065</td><td class="line">    array-&gt;len--;</td></tr>
<tr class="codeline" data-linenumber="6066"><td class="num" id="LN6066">6066</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="6067"><td class="num" id="LN6067">6067</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6068"><td class="num" id="LN6068">6068</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> clusterManagerNodeArrayAdd(clusterManagerNodeArray *array,</td></tr>
<tr class="codeline" data-linenumber="6069"><td class="num" id="LN6069">6069</td><td class="line">                                       clusterManagerNode *node)</td></tr>
<tr class="codeline" data-linenumber="6070"><td class="num" id="LN6070">6070</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="6071"><td class="num" id="LN6071">6071</td><td class="line">    <span class='macro'>assert(array-&gt;len &gt; 0)<span class='macro_popup'>((array-&gt;len &gt; 0) ? (void) (0) : __assert_fail ("array-&gt;len &gt; 0"<br>, "redis-cli.c", 6071, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6072"><td class="num" id="LN6072">6072</td><td class="line">    <span class='macro'>assert(node != NULL)<span class='macro_popup'>((node != ((void*)0)) ? (void) (0) : __assert_fail ("node != NULL"<br>, "redis-cli.c", 6072, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6073"><td class="num" id="LN6073">6073</td><td class="line">    <span class='macro'>assert(array-&gt;count &lt; array-&gt;len)<span class='macro_popup'>((array-&gt;count &lt; array-&gt;len) ? (void) (0) : __assert_fail<br> ("array-&gt;count &lt; array-&gt;len", "redis-cli.c", 6073, __extension__<br> __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6074"><td class="num" id="LN6074">6074</td><td class="line">    array-&gt;nodes[array-&gt;count++] = node;</td></tr>
<tr class="codeline" data-linenumber="6075"><td class="num" id="LN6075">6075</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="6076"><td class="num" id="LN6076">6076</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6077"><td class="num" id="LN6077">6077</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> clusterManagerPrintNotEmptyNodeError(clusterManagerNode *node,</td></tr>
<tr class="codeline" data-linenumber="6078"><td class="num" id="LN6078">6078</td><td class="line">                                                 <span class='keyword'>char</span> *err)</td></tr>
<tr class="codeline" data-linenumber="6079"><td class="num" id="LN6079">6079</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="6080"><td class="num" id="LN6080">6080</td><td class="line">    <span class='keyword'>char</span> *msg;</td></tr>
<tr class="codeline" data-linenumber="6081"><td class="num" id="LN6081">6081</td><td class="line">    <span class='keyword'>if</span> (err) msg = err;</td></tr>
<tr class="codeline" data-linenumber="6082"><td class="num" id="LN6082">6082</td><td class="line">    <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="6083"><td class="num" id="LN6083">6083</td><td class="line">        msg = <span class='string_literal'>"is not empty. Either the node already knows other "</span></td></tr>
<tr class="codeline" data-linenumber="6084"><td class="num" id="LN6084">6084</td><td class="line">              <span class='string_literal'>"nodes (check with CLUSTER NODES) or contains some "</span></td></tr>
<tr class="codeline" data-linenumber="6085"><td class="num" id="LN6085">6085</td><td class="line">              <span class='string_literal'>"key in database 0."</span>;</td></tr>
<tr class="codeline" data-linenumber="6086"><td class="num" id="LN6086">6086</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6087"><td class="num" id="LN6087">6087</td><td class="line">    <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"[ERR] Node %s:%d %s\n"</span>, node-&gt;ip, node-&gt;port, msg)<span class='macro_popup'>clusterManagerLog(3,"[ERR] Node %s:%d %s\n", node-&gt;ip, node<br>-&gt;port, msg)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6088"><td class="num" id="LN6088">6088</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="6089"><td class="num" id="LN6089">6089</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6090"><td class="num" id="LN6090">6090</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> clusterManagerPrintNotClusterNodeError(clusterManagerNode *node,</td></tr>
<tr class="codeline" data-linenumber="6091"><td class="num" id="LN6091">6091</td><td class="line">                                                   <span class='keyword'>char</span> *err)</td></tr>
<tr class="codeline" data-linenumber="6092"><td class="num" id="LN6092">6092</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="6093"><td class="num" id="LN6093">6093</td><td class="line">    <span class='keyword'>char</span> *msg = (err ? err : <span class='string_literal'>"is not configured as a cluster node."</span>);</td></tr>
<tr class="codeline" data-linenumber="6094"><td class="num" id="LN6094">6094</td><td class="line">    <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"[ERR] Node %s:%d %s\n"</span>, node-&gt;ip, node-&gt;port, msg)<span class='macro_popup'>clusterManagerLog(3,"[ERR] Node %s:%d %s\n", node-&gt;ip, node<br>-&gt;port, msg)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6095"><td class="num" id="LN6095">6095</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="6096"><td class="num" id="LN6096">6096</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6097"><td class="num" id="LN6097">6097</td><td class="line"><span class='comment'>/* Execute redis-cli in Cluster Manager mode */</span></td></tr>
<tr class="codeline" data-linenumber="6098"><td class="num" id="LN6098">6098</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> clusterManagerMode(clusterManagerCommandProc *proc) {</td></tr>
<tr class="codeline" data-linenumber="6099"><td class="num" id="LN6099">6099</td><td class="line">    <span class='keyword'>int</span> argc = config.cluster_manager_command.argc;</td></tr>
<tr class="codeline" data-linenumber="6100"><td class="num" id="LN6100">6100</td><td class="line">    <span class='keyword'>char</span> **argv = config.cluster_manager_command.argv;</td></tr>
<tr class="codeline" data-linenumber="6101"><td class="num" id="LN6101">6101</td><td class="line">    cluster_manager.nodes = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6102"><td class="num" id="LN6102">6102</td><td class="line">    <span class='keyword'>int</span> success = proc(argc, argv);</td></tr>
<tr class="codeline" data-linenumber="6103"><td class="num" id="LN6103">6103</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6104"><td class="num" id="LN6104">6104</td><td class="line">    <span class='comment'>/* Initialized in createClusterManagerCommand. */</span></td></tr>
<tr class="codeline" data-linenumber="6105"><td class="num" id="LN6105">6105</td><td class="line">    <span class='keyword'>if</span> (config.stdin_lastarg) {</td></tr>
<tr class="codeline" data-linenumber="6106"><td class="num" id="LN6106">6106</td><td class="line">        zfree(config.cluster_manager_command.argv);</td></tr>
<tr class="codeline" data-linenumber="6107"><td class="num" id="LN6107">6107</td><td class="line">        <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(config.cluster_manager_command.stdin_arg);</td></tr>
<tr class="codeline" data-linenumber="6108"><td class="num" id="LN6108">6108</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (config.stdin_tag_arg) {</td></tr>
<tr class="codeline" data-linenumber="6109"><td class="num" id="LN6109">6109</td><td class="line">        <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(config.cluster_manager_command.stdin_arg);</td></tr>
<tr class="codeline" data-linenumber="6110"><td class="num" id="LN6110">6110</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6111"><td class="num" id="LN6111">6111</td><td class="line">    freeClusterManager();</td></tr>
<tr class="codeline" data-linenumber="6112"><td class="num" id="LN6112">6112</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6113"><td class="num" id="LN6113">6113</td><td class="line">    exit(success ? 0 : 1);</td></tr>
<tr class="codeline" data-linenumber="6114"><td class="num" id="LN6114">6114</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="6115"><td class="num" id="LN6115">6115</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6116"><td class="num" id="LN6116">6116</td><td class="line"><span class='comment'>/* Cluster Manager Commands */</span></td></tr>
<tr class="codeline" data-linenumber="6117"><td class="num" id="LN6117">6117</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6118"><td class="num" id="LN6118">6118</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerCommandCreate(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv) {</td></tr>
<tr class="codeline" data-linenumber="6119"><td class="num" id="LN6119">6119</td><td class="line">    <span class='keyword'>int</span> i, j, success = 1;</td></tr>
<tr class="codeline" data-linenumber="6120"><td class="num" id="LN6120">6120</td><td class="line">    cluster_manager.nodes = listCreate();</td></tr>
<tr class="codeline" data-linenumber="6121"><td class="num" id="LN6121">6121</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; argc; i++) {</td></tr>
<tr class="codeline" data-linenumber="6122"><td class="num" id="LN6122">6122</td><td class="line">        <span class='keyword'>char</span> *addr = argv[i];</td></tr>
<tr class="codeline" data-linenumber="6123"><td class="num" id="LN6123">6123</td><td class="line">        <span class='keyword'>char</span> *ip = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6124"><td class="num" id="LN6124">6124</td><td class="line">        <span class='keyword'>int</span> port = 0;</td></tr>
<tr class="codeline" data-linenumber="6125"><td class="num" id="LN6125">6125</td><td class="line">        <span class='keyword'>if</span> (!parseClusterNodeAddress(addr, &amp;ip, &amp;port, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="6126"><td class="num" id="LN6126">6126</td><td class="line">            fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Invalid address format: %s\n"</span>, addr);</td></tr>
<tr class="codeline" data-linenumber="6127"><td class="num" id="LN6127">6127</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="6128"><td class="num" id="LN6128">6128</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6129"><td class="num" id="LN6129">6129</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6130"><td class="num" id="LN6130">6130</td><td class="line">        clusterManagerNode *node = clusterManagerNewNode(ip, port, 0);</td></tr>
<tr class="codeline" data-linenumber="6131"><td class="num" id="LN6131">6131</td><td class="line">        <span class='keyword'>if</span> (!clusterManagerNodeConnect(node)) {</td></tr>
<tr class="codeline" data-linenumber="6132"><td class="num" id="LN6132">6132</td><td class="line">            freeClusterManagerNode(node);</td></tr>
<tr class="codeline" data-linenumber="6133"><td class="num" id="LN6133">6133</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="6134"><td class="num" id="LN6134">6134</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6135"><td class="num" id="LN6135">6135</td><td class="line">        <span class='keyword'>char</span> *err = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6136"><td class="num" id="LN6136">6136</td><td class="line">        <span class='keyword'>if</span> (!clusterManagerNodeIsCluster(node, &amp;err)) {</td></tr>
<tr class="codeline" data-linenumber="6137"><td class="num" id="LN6137">6137</td><td class="line">            clusterManagerPrintNotClusterNodeError(node, err);</td></tr>
<tr class="codeline" data-linenumber="6138"><td class="num" id="LN6138">6138</td><td class="line">            <span class='keyword'>if</span> (err) zfree(err);</td></tr>
<tr class="codeline" data-linenumber="6139"><td class="num" id="LN6139">6139</td><td class="line">            freeClusterManagerNode(node);</td></tr>
<tr class="codeline" data-linenumber="6140"><td class="num" id="LN6140">6140</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="6141"><td class="num" id="LN6141">6141</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6142"><td class="num" id="LN6142">6142</td><td class="line">        err = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6143"><td class="num" id="LN6143">6143</td><td class="line">        <span class='keyword'>if</span> (!clusterManagerNodeLoadInfo(node, 0, &amp;err)) {</td></tr>
<tr class="codeline" data-linenumber="6144"><td class="num" id="LN6144">6144</td><td class="line">            <span class='keyword'>if</span> (err) {</td></tr>
<tr class="codeline" data-linenumber="6145"><td class="num" id="LN6145">6145</td><td class="line">                <span class='macro'>CLUSTER_MANAGER_PRINT_REPLY_ERROR(node, err)<span class='macro_popup'>clusterManagerLog(3,"Node %s:%d replied with error:\n%s\n", node<br>-&gt;ip, node-&gt;port, err);</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6146"><td class="num" id="LN6146">6146</td><td class="line">                zfree(err);</td></tr>
<tr class="codeline" data-linenumber="6147"><td class="num" id="LN6147">6147</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="6148"><td class="num" id="LN6148">6148</td><td class="line">            freeClusterManagerNode(node);</td></tr>
<tr class="codeline" data-linenumber="6149"><td class="num" id="LN6149">6149</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="6150"><td class="num" id="LN6150">6150</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6151"><td class="num" id="LN6151">6151</td><td class="line">        err = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6152"><td class="num" id="LN6152">6152</td><td class="line">        <span class='keyword'>if</span> (!clusterManagerNodeIsEmpty(node, &amp;err)) {</td></tr>
<tr class="codeline" data-linenumber="6153"><td class="num" id="LN6153">6153</td><td class="line">            clusterManagerPrintNotEmptyNodeError(node, err);</td></tr>
<tr class="codeline" data-linenumber="6154"><td class="num" id="LN6154">6154</td><td class="line">            <span class='keyword'>if</span> (err) zfree(err);</td></tr>
<tr class="codeline" data-linenumber="6155"><td class="num" id="LN6155">6155</td><td class="line">            freeClusterManagerNode(node);</td></tr>
<tr class="codeline" data-linenumber="6156"><td class="num" id="LN6156">6156</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="6157"><td class="num" id="LN6157">6157</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6158"><td class="num" id="LN6158">6158</td><td class="line">        listAddNodeTail(cluster_manager.nodes, node);</td></tr>
<tr class="codeline" data-linenumber="6159"><td class="num" id="LN6159">6159</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6160"><td class="num" id="LN6160">6160</td><td class="line">    <span class='keyword'>int</span> node_len = cluster_manager.nodes-&gt;len;</td></tr>
<tr class="codeline" data-linenumber="6161"><td class="num" id="LN6161">6161</td><td class="line">    <span class='keyword'>int</span> replicas = config.cluster_manager_command.replicas;</td></tr>
<tr class="codeline" data-linenumber="6162"><td class="num" id="LN6162">6162</td><td class="line">    <span class='keyword'>int</span> masters_count = <span class='macro'>CLUSTER_MANAGER_MASTERS_COUNT(node_len, replicas)<span class='macro_popup'>(node_len/(replicas + 1))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6163"><td class="num" id="LN6163">6163</td><td class="line">    <span class='keyword'>if</span> (masters_count &lt; 3) {</td></tr>
<tr class="codeline" data-linenumber="6164"><td class="num" id="LN6164">6164</td><td class="line">        <span class='macro'>clusterManagerLogErr(<span class='macro_popup'>clusterManagerLog(3,"*** ERROR: Invalid configuration for cluster creation.\n"<br> "*** Redis Cluster requires at least 3 master nodes.\n" "*** This is not possible with %d nodes and %d replicas per node."<br>, node_len, replicas)</span></span></td></tr>
<tr class="codeline" data-linenumber="6165"><td class="num" id="LN6165">6165</td><td class="line">            <span class='string_literal'><span class='macro'>"*** ERROR: Invalid configuration for cluster creation.\n"<span class='macro_popup'>clusterManagerLog(3,"*** ERROR: Invalid configuration for cluster creation.\n"<br> "*** Redis Cluster requires at least 3 master nodes.\n" "*** This is not possible with %d nodes and %d replicas per node."<br>, node_len, replicas)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="6166"><td class="num" id="LN6166">6166</td><td class="line">            <span class='string_literal'><span class='macro'>"*** Redis Cluster requires at least 3 master nodes.\n"<span class='macro_popup'>clusterManagerLog(3,"*** ERROR: Invalid configuration for cluster creation.\n"<br> "*** Redis Cluster requires at least 3 master nodes.\n" "*** This is not possible with %d nodes and %d replicas per node."<br>, node_len, replicas)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="6167"><td class="num" id="LN6167">6167</td><td class="line">            <span class='string_literal'><span class='macro'>"*** This is not possible with %d nodes and %d replicas per node."</span>,<span class='macro_popup'>clusterManagerLog(3,"*** ERROR: Invalid configuration for cluster creation.\n"<br> "*** Redis Cluster requires at least 3 master nodes.\n" "*** This is not possible with %d nodes and %d replicas per node."<br>, node_len, replicas)</span></span></td></tr>
<tr class="codeline" data-linenumber="6168"><td class="num" id="LN6168">6168</td><td class="line">            <span class='macro'>node_len, replicas)<span class='macro_popup'>clusterManagerLog(3,"*** ERROR: Invalid configuration for cluster creation.\n"<br> "*** Redis Cluster requires at least 3 master nodes.\n" "*** This is not possible with %d nodes and %d replicas per node."<br>, node_len, replicas)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6169"><td class="num" id="LN6169">6169</td><td class="line">        <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"\n*** At least %d nodes are required.\n"</span>,<span class='macro_popup'>clusterManagerLog(3,"\n*** At least %d nodes are required.\n"<br>, 3 * (replicas + 1))</span></span></td></tr>
<tr class="codeline" data-linenumber="6170"><td class="num" id="LN6170">6170</td><td class="line">                             <span class='macro'>3 * (replicas + 1))<span class='macro_popup'>clusterManagerLog(3,"\n*** At least %d nodes are required.\n"<br>, 3 * (replicas + 1))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6171"><td class="num" id="LN6171">6171</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="6172"><td class="num" id="LN6172">6172</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6173"><td class="num" id="LN6173">6173</td><td class="line">    <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Performing hash slots allocation "<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Performing hash slots allocation "<br> "on %d nodes...\n", node_len)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="6174"><td class="num" id="LN6174">6174</td><td class="line">                          <span class='string_literal'><span class='macro'>"on %d nodes...\n"</span>, node_len)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Performing hash slots allocation "<br> "on %d nodes...\n", node_len)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6175"><td class="num" id="LN6175">6175</td><td class="line">    <span class='keyword'>int</span> interleaved_len = 0, ip_count = 0;</td></tr>
<tr class="codeline" data-linenumber="6176"><td class="num" id="LN6176">6176</td><td class="line">    clusterManagerNode **interleaved = zcalloc(node_len*<span class='keyword'>sizeof</span>(**interleaved));</td></tr>
<tr class="codeline" data-linenumber="6177"><td class="num" id="LN6177">6177</td><td class="line">    <span class='keyword'>char</span> **ips = zcalloc(node_len * <span class='keyword'>sizeof</span>(<span class='keyword'>char</span>*));</td></tr>
<tr class="codeline" data-linenumber="6178"><td class="num" id="LN6178">6178</td><td class="line">    clusterManagerNodeArray *ip_nodes = zcalloc(node_len * <span class='keyword'>sizeof</span>(*ip_nodes));</td></tr>
<tr class="codeline" data-linenumber="6179"><td class="num" id="LN6179">6179</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="6180"><td class="num" id="LN6180">6180</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="6181"><td class="num" id="LN6181">6181</td><td class="line">    listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="6182"><td class="num" id="LN6182">6182</td><td class="line">    <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6183"><td class="num" id="LN6183">6183</td><td class="line">        clusterManagerNode *n = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="6184"><td class="num" id="LN6184">6184</td><td class="line">        <span class='keyword'>int</span> found = 0;</td></tr>
<tr class="codeline" data-linenumber="6185"><td class="num" id="LN6185">6185</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; ip_count; i++) {</td></tr>
<tr class="codeline" data-linenumber="6186"><td class="num" id="LN6186">6186</td><td class="line">            <span class='keyword'>char</span> *ip = ips[i];</td></tr>
<tr class="codeline" data-linenumber="6187"><td class="num" id="LN6187">6187</td><td class="line">            <span class='keyword'>if</span> (!strcmp(ip, n-&gt;ip)) {</td></tr>
<tr class="codeline" data-linenumber="6188"><td class="num" id="LN6188">6188</td><td class="line">                found = 1;</td></tr>
<tr class="codeline" data-linenumber="6189"><td class="num" id="LN6189">6189</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="6190"><td class="num" id="LN6190">6190</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="6191"><td class="num" id="LN6191">6191</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6192"><td class="num" id="LN6192">6192</td><td class="line">        <span class='keyword'>if</span> (!found) {</td></tr>
<tr class="codeline" data-linenumber="6193"><td class="num" id="LN6193">6193</td><td class="line">            ips[ip_count++] = n-&gt;ip;</td></tr>
<tr class="codeline" data-linenumber="6194"><td class="num" id="LN6194">6194</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6195"><td class="num" id="LN6195">6195</td><td class="line">        clusterManagerNodeArray *node_array = &amp;(ip_nodes[i]);</td></tr>
<tr class="codeline" data-linenumber="6196"><td class="num" id="LN6196">6196</td><td class="line">        <span class='keyword'>if</span> (node_array-&gt;nodes == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="6197"><td class="num" id="LN6197">6197</td><td class="line">            clusterManagerNodeArrayInit(node_array, node_len);</td></tr>
<tr class="codeline" data-linenumber="6198"><td class="num" id="LN6198">6198</td><td class="line">        clusterManagerNodeArrayAdd(node_array, n);</td></tr>
<tr class="codeline" data-linenumber="6199"><td class="num" id="LN6199">6199</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6200"><td class="num" id="LN6200">6200</td><td class="line">    <span class='keyword'>while</span> (interleaved_len &lt; node_len) {</td></tr>
<tr class="codeline" data-linenumber="6201"><td class="num" id="LN6201">6201</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; ip_count; i++) {</td></tr>
<tr class="codeline" data-linenumber="6202"><td class="num" id="LN6202">6202</td><td class="line">            clusterManagerNodeArray *node_array = &amp;(ip_nodes[i]);</td></tr>
<tr class="codeline" data-linenumber="6203"><td class="num" id="LN6203">6203</td><td class="line">            <span class='keyword'>if</span> (node_array-&gt;count &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="6204"><td class="num" id="LN6204">6204</td><td class="line">                clusterManagerNode *n = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6205"><td class="num" id="LN6205">6205</td><td class="line">                clusterManagerNodeArrayShift(node_array, &amp;n);</td></tr>
<tr class="codeline" data-linenumber="6206"><td class="num" id="LN6206">6206</td><td class="line">                interleaved[interleaved_len++] = n;</td></tr>
<tr class="codeline" data-linenumber="6207"><td class="num" id="LN6207">6207</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="6208"><td class="num" id="LN6208">6208</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6209"><td class="num" id="LN6209">6209</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6210"><td class="num" id="LN6210">6210</td><td class="line">    clusterManagerNode **masters = interleaved;</td></tr>
<tr class="codeline" data-linenumber="6211"><td class="num" id="LN6211">6211</td><td class="line">    interleaved += masters_count;</td></tr>
<tr class="codeline" data-linenumber="6212"><td class="num" id="LN6212">6212</td><td class="line">    interleaved_len -= masters_count;</td></tr>
<tr class="codeline" data-linenumber="6213"><td class="num" id="LN6213">6213</td><td class="line">    <span class='keyword'>float</span> slots_per_node = <span class='macro'>CLUSTER_MANAGER_SLOTS<span class='macro_popup'>16384</span></span> / (<span class='keyword'>float</span>) masters_count;</td></tr>
<tr class="codeline" data-linenumber="6214"><td class="num" id="LN6214">6214</td><td class="line">    <span class='keyword'>long</span> first = 0;</td></tr>
<tr class="codeline" data-linenumber="6215"><td class="num" id="LN6215">6215</td><td class="line">    <span class='keyword'>float</span> cursor = 0.0f;</td></tr>
<tr class="codeline" data-linenumber="6216"><td class="num" id="LN6216">6216</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; masters_count; i++) {</td></tr>
<tr class="codeline" data-linenumber="6217"><td class="num" id="LN6217">6217</td><td class="line">        clusterManagerNode *master = masters[i];</td></tr>
<tr class="codeline" data-linenumber="6218"><td class="num" id="LN6218">6218</td><td class="line">        <span class='keyword'>long</span> last = lround(cursor + slots_per_node - 1);</td></tr>
<tr class="codeline" data-linenumber="6219"><td class="num" id="LN6219">6219</td><td class="line">        <span class='keyword'>if</span> (last &gt; <span class='macro'>CLUSTER_MANAGER_SLOTS<span class='macro_popup'>16384</span></span> || i == (masters_count - 1))</td></tr>
<tr class="codeline" data-linenumber="6220"><td class="num" id="LN6220">6220</td><td class="line">            last = <span class='macro'>CLUSTER_MANAGER_SLOTS<span class='macro_popup'>16384</span></span> - 1;</td></tr>
<tr class="codeline" data-linenumber="6221"><td class="num" id="LN6221">6221</td><td class="line">        <span class='keyword'>if</span> (last &lt; first) last = first;</td></tr>
<tr class="codeline" data-linenumber="6222"><td class="num" id="LN6222">6222</td><td class="line">        printf(<span class='string_literal'>"Master[%d] -&gt; Slots %ld - %ld\n"</span>, i, first, last);</td></tr>
<tr class="codeline" data-linenumber="6223"><td class="num" id="LN6223">6223</td><td class="line">        master-&gt;slots_count = 0;</td></tr>
<tr class="codeline" data-linenumber="6224"><td class="num" id="LN6224">6224</td><td class="line">        <span class='keyword'>for</span> (j = first; j &lt;= last; j++) {</td></tr>
<tr class="codeline" data-linenumber="6225"><td class="num" id="LN6225">6225</td><td class="line">            master-&gt;slots[j] = 1;</td></tr>
<tr class="codeline" data-linenumber="6226"><td class="num" id="LN6226">6226</td><td class="line">            master-&gt;slots_count++;</td></tr>
<tr class="codeline" data-linenumber="6227"><td class="num" id="LN6227">6227</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6228"><td class="num" id="LN6228">6228</td><td class="line">        master-&gt;dirty = 1;</td></tr>
<tr class="codeline" data-linenumber="6229"><td class="num" id="LN6229">6229</td><td class="line">        first = last + 1;</td></tr>
<tr class="codeline" data-linenumber="6230"><td class="num" id="LN6230">6230</td><td class="line">        cursor += slots_per_node;</td></tr>
<tr class="codeline" data-linenumber="6231"><td class="num" id="LN6231">6231</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6232"><td class="num" id="LN6232">6232</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6233"><td class="num" id="LN6233">6233</td><td class="line">    <span class='comment'>/* Rotating the list sometimes helps to get better initial</span></td></tr>
<tr class="codeline" data-linenumber="6234"><td class="num" id="LN6234">6234</td><td class="line">     <span class='comment'>* anti-affinity before the optimizer runs. */</span></td></tr>
<tr class="codeline" data-linenumber="6235"><td class="num" id="LN6235">6235</td><td class="line">    clusterManagerNode *first_node = interleaved[0];</td></tr>
<tr class="codeline" data-linenumber="6236"><td class="num" id="LN6236">6236</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; (interleaved_len - 1); i++)</td></tr>
<tr class="codeline" data-linenumber="6237"><td class="num" id="LN6237">6237</td><td class="line">        interleaved[i] = interleaved[i + 1];</td></tr>
<tr class="codeline" data-linenumber="6238"><td class="num" id="LN6238">6238</td><td class="line">    interleaved[interleaved_len - 1] = first_node;</td></tr>
<tr class="codeline" data-linenumber="6239"><td class="num" id="LN6239">6239</td><td class="line">    <span class='keyword'>int</span> assign_unused = 0, available_count = interleaved_len;</td></tr>
<tr class="codeline" data-linenumber="6240"><td class="num" id="LN6240">6240</td><td class="line">assign_replicas:</td></tr>
<tr class="codeline" data-linenumber="6241"><td class="num" id="LN6241">6241</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; masters_count; i++) {</td></tr>
<tr class="codeline" data-linenumber="6242"><td class="num" id="LN6242">6242</td><td class="line">        clusterManagerNode *master = masters[i];</td></tr>
<tr class="codeline" data-linenumber="6243"><td class="num" id="LN6243">6243</td><td class="line">        <span class='keyword'>int</span> assigned_replicas = 0;</td></tr>
<tr class="codeline" data-linenumber="6244"><td class="num" id="LN6244">6244</td><td class="line">        <span class='keyword'>while</span> (assigned_replicas &lt; replicas) {</td></tr>
<tr class="codeline" data-linenumber="6245"><td class="num" id="LN6245">6245</td><td class="line">            <span class='keyword'>if</span> (available_count == 0) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="6246"><td class="num" id="LN6246">6246</td><td class="line">            clusterManagerNode *found = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, *slave = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6247"><td class="num" id="LN6247">6247</td><td class="line">            <span class='keyword'>int</span> firstNodeIdx = -1;</td></tr>
<tr class="codeline" data-linenumber="6248"><td class="num" id="LN6248">6248</td><td class="line">            <span class='keyword'>for</span> (j = 0; j &lt; interleaved_len; j++) {</td></tr>
<tr class="codeline" data-linenumber="6249"><td class="num" id="LN6249">6249</td><td class="line">                clusterManagerNode *n = interleaved[j];</td></tr>
<tr class="codeline" data-linenumber="6250"><td class="num" id="LN6250">6250</td><td class="line">                <span class='keyword'>if</span> (n == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="6251"><td class="num" id="LN6251">6251</td><td class="line">                <span class='keyword'>if</span> (strcmp(n-&gt;ip, master-&gt;ip)) {</td></tr>
<tr class="codeline" data-linenumber="6252"><td class="num" id="LN6252">6252</td><td class="line">                    found = n;</td></tr>
<tr class="codeline" data-linenumber="6253"><td class="num" id="LN6253">6253</td><td class="line">                    interleaved[j] = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6254"><td class="num" id="LN6254">6254</td><td class="line">                    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="6255"><td class="num" id="LN6255">6255</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="6256"><td class="num" id="LN6256">6256</td><td class="line">                <span class='keyword'>if</span> (firstNodeIdx &lt; 0) firstNodeIdx = j;</td></tr>
<tr class="codeline" data-linenumber="6257"><td class="num" id="LN6257">6257</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="6258"><td class="num" id="LN6258">6258</td><td class="line">            <span class='keyword'>if</span> (found) slave = found;</td></tr>
<tr class="codeline" data-linenumber="6259"><td class="num" id="LN6259">6259</td><td class="line">            <span class='keyword'>else</span> <span class='keyword'>if</span> (firstNodeIdx &gt;= 0) {</td></tr>
<tr class="codeline" data-linenumber="6260"><td class="num" id="LN6260">6260</td><td class="line">                slave = interleaved[firstNodeIdx];</td></tr>
<tr class="codeline" data-linenumber="6261"><td class="num" id="LN6261">6261</td><td class="line">                interleaved_len -= (firstNodeIdx + 1);</td></tr>
<tr class="codeline" data-linenumber="6262"><td class="num" id="LN6262">6262</td><td class="line">                interleaved += (firstNodeIdx + 1);</td></tr>
<tr class="codeline" data-linenumber="6263"><td class="num" id="LN6263">6263</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="6264"><td class="num" id="LN6264">6264</td><td class="line">            <span class='keyword'>if</span> (slave != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6265"><td class="num" id="LN6265">6265</td><td class="line">                assigned_replicas++;</td></tr>
<tr class="codeline" data-linenumber="6266"><td class="num" id="LN6266">6266</td><td class="line">                available_count--;</td></tr>
<tr class="codeline" data-linenumber="6267"><td class="num" id="LN6267">6267</td><td class="line">                <span class='keyword'>if</span> (slave-&gt;replicate) <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(slave-&gt;replicate);</td></tr>
<tr class="codeline" data-linenumber="6268"><td class="num" id="LN6268">6268</td><td class="line">                slave-&gt;replicate = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(master-&gt;name);</td></tr>
<tr class="codeline" data-linenumber="6269"><td class="num" id="LN6269">6269</td><td class="line">                slave-&gt;dirty = 1;</td></tr>
<tr class="codeline" data-linenumber="6270"><td class="num" id="LN6270">6270</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="6271"><td class="num" id="LN6271">6271</td><td class="line">            printf(<span class='string_literal'>"Adding replica %s:%d to %s:%d\n"</span>, slave-&gt;ip, slave-&gt;port,</td></tr>
<tr class="codeline" data-linenumber="6272"><td class="num" id="LN6272">6272</td><td class="line">                   master-&gt;ip, master-&gt;port);</td></tr>
<tr class="codeline" data-linenumber="6273"><td class="num" id="LN6273">6273</td><td class="line">            <span class='keyword'>if</span> (assign_unused) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="6274"><td class="num" id="LN6274">6274</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6275"><td class="num" id="LN6275">6275</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6276"><td class="num" id="LN6276">6276</td><td class="line">    <span class='keyword'>if</span> (!assign_unused &amp;&amp; available_count &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="6277"><td class="num" id="LN6277">6277</td><td class="line">        assign_unused = 1;</td></tr>
<tr class="codeline" data-linenumber="6278"><td class="num" id="LN6278">6278</td><td class="line">        printf(<span class='string_literal'>"Adding extra replicas...\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="6279"><td class="num" id="LN6279">6279</td><td class="line">        <span class='keyword'>goto</span> assign_replicas;</td></tr>
<tr class="codeline" data-linenumber="6280"><td class="num" id="LN6280">6280</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6281"><td class="num" id="LN6281">6281</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; ip_count; i++) {</td></tr>
<tr class="codeline" data-linenumber="6282"><td class="num" id="LN6282">6282</td><td class="line">        clusterManagerNodeArray *node_array = ip_nodes + i;</td></tr>
<tr class="codeline" data-linenumber="6283"><td class="num" id="LN6283">6283</td><td class="line">        clusterManagerNodeArrayReset(node_array);</td></tr>
<tr class="codeline" data-linenumber="6284"><td class="num" id="LN6284">6284</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6285"><td class="num" id="LN6285">6285</td><td class="line">    clusterManagerOptimizeAntiAffinity(ip_nodes, ip_count);</td></tr>
<tr class="codeline" data-linenumber="6286"><td class="num" id="LN6286">6286</td><td class="line">    clusterManagerShowNodes();</td></tr>
<tr class="codeline" data-linenumber="6287"><td class="num" id="LN6287">6287</td><td class="line">    <span class='keyword'>int</span> ignore_force = 0;</td></tr>
<tr class="codeline" data-linenumber="6288"><td class="num" id="LN6288">6288</td><td class="line">    <span class='keyword'>if</span> (confirmWithYes(<span class='string_literal'>"Can I set the above configuration?"</span>, ignore_force)) {</td></tr>
<tr class="codeline" data-linenumber="6289"><td class="num" id="LN6289">6289</td><td class="line">        listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="6290"><td class="num" id="LN6290">6290</td><td class="line">        <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6291"><td class="num" id="LN6291">6291</td><td class="line">            clusterManagerNode *node = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="6292"><td class="num" id="LN6292">6292</td><td class="line">            <span class='keyword'>char</span> *err = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6293"><td class="num" id="LN6293">6293</td><td class="line">            <span class='keyword'>int</span> flushed = clusterManagerFlushNodeConfig(node, &amp;err);</td></tr>
<tr class="codeline" data-linenumber="6294"><td class="num" id="LN6294">6294</td><td class="line">            <span class='keyword'>if</span> (!flushed &amp;&amp; node-&gt;dirty &amp;&amp; !node-&gt;replicate) {</td></tr>
<tr class="codeline" data-linenumber="6295"><td class="num" id="LN6295">6295</td><td class="line">                <span class='keyword'>if</span> (err != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6296"><td class="num" id="LN6296">6296</td><td class="line">                    <span class='macro'>CLUSTER_MANAGER_PRINT_REPLY_ERROR(node, err)<span class='macro_popup'>clusterManagerLog(3,"Node %s:%d replied with error:\n%s\n", node<br>-&gt;ip, node-&gt;port, err);</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6297"><td class="num" id="LN6297">6297</td><td class="line">                    zfree(err);</td></tr>
<tr class="codeline" data-linenumber="6298"><td class="num" id="LN6298">6298</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="6299"><td class="num" id="LN6299">6299</td><td class="line">                success = 0;</td></tr>
<tr class="codeline" data-linenumber="6300"><td class="num" id="LN6300">6300</td><td class="line">                <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="6301"><td class="num" id="LN6301">6301</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (err != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) zfree(err);</td></tr>
<tr class="codeline" data-linenumber="6302"><td class="num" id="LN6302">6302</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6303"><td class="num" id="LN6303">6303</td><td class="line">        <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Nodes configuration updated\n"</span>)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Nodes configuration updated\n"<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6304"><td class="num" id="LN6304">6304</td><td class="line">        <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Assign a different config epoch to "<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Assign a different config epoch to "<br> "each node\n")</span></span></span></td></tr>
<tr class="codeline" data-linenumber="6305"><td class="num" id="LN6305">6305</td><td class="line">                              <span class='string_literal'><span class='macro'>"each node\n"</span>)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Assign a different config epoch to "<br> "each node\n")</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6306"><td class="num" id="LN6306">6306</td><td class="line">        <span class='keyword'>int</span> config_epoch = 1;</td></tr>
<tr class="codeline" data-linenumber="6307"><td class="num" id="LN6307">6307</td><td class="line">        listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="6308"><td class="num" id="LN6308">6308</td><td class="line">        <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6309"><td class="num" id="LN6309">6309</td><td class="line">            clusterManagerNode *node = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="6310"><td class="num" id="LN6310">6310</td><td class="line">            redisReply *reply = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6311"><td class="num" id="LN6311">6311</td><td class="line">            reply = <span class='macro'>CLUSTER_MANAGER_COMMAND(node,<span class='macro_popup'>(redisCommand(node-&gt;context, "cluster set-config-epoch %d"<br>, config_epoch++))</span></span></td></tr>
<tr class="codeline" data-linenumber="6312"><td class="num" id="LN6312">6312</td><td class="line">                                            <span class='string_literal'><span class='macro'>"cluster set-config-epoch %d"</span>,<span class='macro_popup'>(redisCommand(node-&gt;context, "cluster set-config-epoch %d"<br>, config_epoch++))</span></span></td></tr>
<tr class="codeline" data-linenumber="6313"><td class="num" id="LN6313">6313</td><td class="line">                                            <span class='macro'>config_epoch++)<span class='macro_popup'>(redisCommand(node-&gt;context, "cluster set-config-epoch %d"<br>, config_epoch++))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6314"><td class="num" id="LN6314">6314</td><td class="line">            <span class='keyword'>if</span> (reply != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="6315"><td class="num" id="LN6315">6315</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6316"><td class="num" id="LN6316">6316</td><td class="line">        <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Sending CLUSTER MEET messages to join "<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Sending CLUSTER MEET messages to join "<br> "the cluster\n")</span></span></span></td></tr>
<tr class="codeline" data-linenumber="6317"><td class="num" id="LN6317">6317</td><td class="line">                              <span class='string_literal'><span class='macro'>"the cluster\n"</span>)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Sending CLUSTER MEET messages to join "<br> "the cluster\n")</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6318"><td class="num" id="LN6318">6318</td><td class="line">        clusterManagerNode *first = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6319"><td class="num" id="LN6319">6319</td><td class="line">        <span class='keyword'>char</span> first_ip[<span class='macro'>NET_IP_STR_LEN<span class='macro_popup'>46</span></span>]; <span class='comment'>/* first-&gt;ip may be a hostname */</span></td></tr>
<tr class="codeline" data-linenumber="6320"><td class="num" id="LN6320">6320</td><td class="line">        listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="6321"><td class="num" id="LN6321">6321</td><td class="line">        <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6322"><td class="num" id="LN6322">6322</td><td class="line">            clusterManagerNode *node = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="6323"><td class="num" id="LN6323">6323</td><td class="line">            <span class='keyword'>if</span> (first == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6324"><td class="num" id="LN6324">6324</td><td class="line">                first = node;</td></tr>
<tr class="codeline" data-linenumber="6325"><td class="num" id="LN6325">6325</td><td class="line">                <span class='comment'>/* Although hiredis supports connecting to a hostname, CLUSTER</span></td></tr>
<tr class="codeline" data-linenumber="6326"><td class="num" id="LN6326">6326</td><td class="line">                 <span class='comment'>* MEET requires an IP address, so we do a DNS lookup here. */</span></td></tr>
<tr class="codeline" data-linenumber="6327"><td class="num" id="LN6327">6327</td><td class="line">                <span class='keyword'>if</span> (anetResolve(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, first-&gt;ip, first_ip, <span class='keyword'>sizeof</span>(first_ip), <span class='macro'>ANET_NONE<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="6328"><td class="num" id="LN6328">6328</td><td class="line">                    == <span class='macro'>ANET_ERR<span class='macro_popup'>-1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="6329"><td class="num" id="LN6329">6329</td><td class="line">                {</td></tr>
<tr class="codeline" data-linenumber="6330"><td class="num" id="LN6330">6330</td><td class="line">                    fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Invalid IP address or hostname specified: %s\n"</span>, first-&gt;ip);</td></tr>
<tr class="codeline" data-linenumber="6331"><td class="num" id="LN6331">6331</td><td class="line">                    success = 0;</td></tr>
<tr class="codeline" data-linenumber="6332"><td class="num" id="LN6332">6332</td><td class="line">                    <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="6333"><td class="num" id="LN6333">6333</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="6334"><td class="num" id="LN6334">6334</td><td class="line">                <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="6335"><td class="num" id="LN6335">6335</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="6336"><td class="num" id="LN6336">6336</td><td class="line">            redisReply *reply = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6337"><td class="num" id="LN6337">6337</td><td class="line">            <span class='keyword'>if</span> (first-&gt;bus_port == 0 || (first-&gt;bus_port == first-&gt;port + <span class='macro'>CLUSTER_MANAGER_PORT_INCR<span class='macro_popup'>10000</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="6338"><td class="num" id="LN6338">6338</td><td class="line">                <span class='comment'>/* CLUSTER MEET bus-port parameter was added in 4.0.</span></td></tr>
<tr class="codeline" data-linenumber="6339"><td class="num" id="LN6339">6339</td><td class="line">                 <span class='comment'>* So if (bus_port == 0) or (bus_port == port + CLUSTER_MANAGER_PORT_INCR),</span></td></tr>
<tr class="codeline" data-linenumber="6340"><td class="num" id="LN6340">6340</td><td class="line">                 <span class='comment'>* we just call CLUSTER MEET with 2 arguments, using the old form. */</span></td></tr>
<tr class="codeline" data-linenumber="6341"><td class="num" id="LN6341">6341</td><td class="line">                reply = <span class='macro'>CLUSTER_MANAGER_COMMAND(node, <span class='string_literal'>"cluster meet %s %d"</span>,<span class='macro_popup'>(redisCommand(node-&gt;context, "cluster meet %s %d", first-&gt;<br>ip, first-&gt;port))</span></span></td></tr>
<tr class="codeline" data-linenumber="6342"><td class="num" id="LN6342">6342</td><td class="line">                                                <span class='macro'>first-&gt;ip, first-&gt;port)<span class='macro_popup'>(redisCommand(node-&gt;context, "cluster meet %s %d", first-&gt;<br>ip, first-&gt;port))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6343"><td class="num" id="LN6343">6343</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="6344"><td class="num" id="LN6344">6344</td><td class="line">                reply = <span class='macro'>CLUSTER_MANAGER_COMMAND(node, <span class='string_literal'>"cluster meet %s %d %d"</span>,<span class='macro_popup'>(redisCommand(node-&gt;context, "cluster meet %s %d %d", first<br>-&gt;ip, first-&gt;port, first-&gt;bus_port))</span></span></td></tr>
<tr class="codeline" data-linenumber="6345"><td class="num" id="LN6345">6345</td><td class="line">                                                <span class='macro'>first-&gt;ip, first-&gt;port, first-&gt;bus_port)<span class='macro_popup'>(redisCommand(node-&gt;context, "cluster meet %s %d %d", first<br>-&gt;ip, first-&gt;port, first-&gt;bus_port))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6346"><td class="num" id="LN6346">6346</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="6347"><td class="num" id="LN6347">6347</td><td class="line">            <span class='keyword'>int</span> is_err = 0;</td></tr>
<tr class="codeline" data-linenumber="6348"><td class="num" id="LN6348">6348</td><td class="line">            <span class='keyword'>if</span> (reply != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6349"><td class="num" id="LN6349">6349</td><td class="line">                <span class='keyword'>if</span> ((is_err = reply-&gt;type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>))</td></tr>
<tr class="codeline" data-linenumber="6350"><td class="num" id="LN6350">6350</td><td class="line">                    <span class='macro'>CLUSTER_MANAGER_PRINT_REPLY_ERROR(node, reply-&gt;str)<span class='macro_popup'>clusterManagerLog(3,"Node %s:%d replied with error:\n%s\n", node<br>-&gt;ip, node-&gt;port, reply-&gt;str);</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6351"><td class="num" id="LN6351">6351</td><td class="line">                freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="6352"><td class="num" id="LN6352">6352</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="6353"><td class="num" id="LN6353">6353</td><td class="line">                is_err = 1;</td></tr>
<tr class="codeline" data-linenumber="6354"><td class="num" id="LN6354">6354</td><td class="line">                fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Failed to send CLUSTER MEET command.\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="6355"><td class="num" id="LN6355">6355</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="6356"><td class="num" id="LN6356">6356</td><td class="line">            <span class='keyword'>if</span> (is_err) {</td></tr>
<tr class="codeline" data-linenumber="6357"><td class="num" id="LN6357">6357</td><td class="line">                success = 0;</td></tr>
<tr class="codeline" data-linenumber="6358"><td class="num" id="LN6358">6358</td><td class="line">                <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="6359"><td class="num" id="LN6359">6359</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="6360"><td class="num" id="LN6360">6360</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6361"><td class="num" id="LN6361">6361</td><td class="line">        <span class='comment'>/* Give one second for the join to start, in order to avoid that</span></td></tr>
<tr class="codeline" data-linenumber="6362"><td class="num" id="LN6362">6362</td><td class="line">         <span class='comment'>* waiting for cluster join will find all the nodes agree about</span></td></tr>
<tr class="codeline" data-linenumber="6363"><td class="num" id="LN6363">6363</td><td class="line">         <span class='comment'>* the config as they are still empty with unassigned slots. */</span></td></tr>
<tr class="codeline" data-linenumber="6364"><td class="num" id="LN6364">6364</td><td class="line">        sleep(1);</td></tr>
<tr class="codeline" data-linenumber="6365"><td class="num" id="LN6365">6365</td><td class="line">        clusterManagerWaitForClusterJoin();</td></tr>
<tr class="codeline" data-linenumber="6366"><td class="num" id="LN6366">6366</td><td class="line">        <span class='comment'>/* Useful for the replicas */</span></td></tr>
<tr class="codeline" data-linenumber="6367"><td class="num" id="LN6367">6367</td><td class="line">        listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="6368"><td class="num" id="LN6368">6368</td><td class="line">        <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6369"><td class="num" id="LN6369">6369</td><td class="line">            clusterManagerNode *node = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="6370"><td class="num" id="LN6370">6370</td><td class="line">            <span class='keyword'>if</span> (!node-&gt;dirty) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="6371"><td class="num" id="LN6371">6371</td><td class="line">            <span class='keyword'>char</span> *err = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6372"><td class="num" id="LN6372">6372</td><td class="line">            <span class='keyword'>int</span> flushed = clusterManagerFlushNodeConfig(node, &amp;err);</td></tr>
<tr class="codeline" data-linenumber="6373"><td class="num" id="LN6373">6373</td><td class="line">            <span class='keyword'>if</span> (!flushed &amp;&amp; !node-&gt;replicate) {</td></tr>
<tr class="codeline" data-linenumber="6374"><td class="num" id="LN6374">6374</td><td class="line">                <span class='keyword'>if</span> (err != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6375"><td class="num" id="LN6375">6375</td><td class="line">                    <span class='macro'>CLUSTER_MANAGER_PRINT_REPLY_ERROR(node, err)<span class='macro_popup'>clusterManagerLog(3,"Node %s:%d replied with error:\n%s\n", node<br>-&gt;ip, node-&gt;port, err);</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6376"><td class="num" id="LN6376">6376</td><td class="line">                    zfree(err);</td></tr>
<tr class="codeline" data-linenumber="6377"><td class="num" id="LN6377">6377</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="6378"><td class="num" id="LN6378">6378</td><td class="line">                success = 0;</td></tr>
<tr class="codeline" data-linenumber="6379"><td class="num" id="LN6379">6379</td><td class="line">                <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="6380"><td class="num" id="LN6380">6380</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (err != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6381"><td class="num" id="LN6381">6381</td><td class="line">                zfree(err);</td></tr>
<tr class="codeline" data-linenumber="6382"><td class="num" id="LN6382">6382</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="6383"><td class="num" id="LN6383">6383</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6384"><td class="num" id="LN6384">6384</td><td class="line">        <span class='comment'>// Reset Nodes</span></td></tr>
<tr class="codeline" data-linenumber="6385"><td class="num" id="LN6385">6385</td><td class="line">        listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="6386"><td class="num" id="LN6386">6386</td><td class="line">        clusterManagerNode *first_node = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6387"><td class="num" id="LN6387">6387</td><td class="line">        <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6388"><td class="num" id="LN6388">6388</td><td class="line">            clusterManagerNode *node = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="6389"><td class="num" id="LN6389">6389</td><td class="line">            <span class='keyword'>if</span> (!first_node) first_node = node;</td></tr>
<tr class="codeline" data-linenumber="6390"><td class="num" id="LN6390">6390</td><td class="line">            <span class='keyword'>else</span> freeClusterManagerNode(node);</td></tr>
<tr class="codeline" data-linenumber="6391"><td class="num" id="LN6391">6391</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6392"><td class="num" id="LN6392">6392</td><td class="line">        listEmpty(cluster_manager.nodes);</td></tr>
<tr class="codeline" data-linenumber="6393"><td class="num" id="LN6393">6393</td><td class="line">        <span class='keyword'>if</span> (!clusterManagerLoadInfoFromNode(first_node)) {</td></tr>
<tr class="codeline" data-linenumber="6394"><td class="num" id="LN6394">6394</td><td class="line">            success = 0;</td></tr>
<tr class="codeline" data-linenumber="6395"><td class="num" id="LN6395">6395</td><td class="line">            <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="6396"><td class="num" id="LN6396">6396</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6397"><td class="num" id="LN6397">6397</td><td class="line">        clusterManagerCheckCluster(0);</td></tr>
<tr class="codeline" data-linenumber="6398"><td class="num" id="LN6398">6398</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6399"><td class="num" id="LN6399">6399</td><td class="line">cleanup:</td></tr>
<tr class="codeline" data-linenumber="6400"><td class="num" id="LN6400">6400</td><td class="line">    <span class='comment'>/* Free everything */</span></td></tr>
<tr class="codeline" data-linenumber="6401"><td class="num" id="LN6401">6401</td><td class="line">    zfree(masters);</td></tr>
<tr class="codeline" data-linenumber="6402"><td class="num" id="LN6402">6402</td><td class="line">    zfree(ips);</td></tr>
<tr class="codeline" data-linenumber="6403"><td class="num" id="LN6403">6403</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; node_len; i++) {</td></tr>
<tr class="codeline" data-linenumber="6404"><td class="num" id="LN6404">6404</td><td class="line">        clusterManagerNodeArray *node_array = ip_nodes + i;</td></tr>
<tr class="codeline" data-linenumber="6405"><td class="num" id="LN6405">6405</td><td class="line">        <span class='macro'>CLUSTER_MANAGER_NODE_ARRAY_FREE(node_array)<span class='macro_popup'>zfree(node_array-&gt;alloc)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6406"><td class="num" id="LN6406">6406</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6407"><td class="num" id="LN6407">6407</td><td class="line">    zfree(ip_nodes);</td></tr>
<tr class="codeline" data-linenumber="6408"><td class="num" id="LN6408">6408</td><td class="line">    <span class='keyword'>return</span> success;</td></tr>
<tr class="codeline" data-linenumber="6409"><td class="num" id="LN6409">6409</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="6410"><td class="num" id="LN6410">6410</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6411"><td class="num" id="LN6411">6411</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerCommandAddNode(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv) {</td></tr>
<tr class="codeline" data-linenumber="6412"><td class="num" id="LN6412">6412</td><td class="line">    <span class='keyword'>int</span> success = 1;</td></tr>
<tr class="codeline" data-linenumber="6413"><td class="num" id="LN6413">6413</td><td class="line">    redisReply *reply = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6414"><td class="num" id="LN6414">6414</td><td class="line">    redisReply *function_restore_reply = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6415"><td class="num" id="LN6415">6415</td><td class="line">    redisReply *function_list_reply = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6416"><td class="num" id="LN6416">6416</td><td class="line">    <span class='keyword'>char</span> *ref_ip = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, *ip = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6417"><td class="num" id="LN6417">6417</td><td class="line">    <span class='keyword'>int</span> ref_port = 0, port = 0;</td></tr>
<tr class="codeline" data-linenumber="6418"><td class="num" id="LN6418">6418</td><td class="line">    <span class='keyword'>if</span> (!getClusterHostFromCmdArgs(argc - 1, argv + 1, &amp;ref_ip, &amp;ref_port))</td></tr>
<tr class="codeline" data-linenumber="6419"><td class="num" id="LN6419">6419</td><td class="line">        <span class='keyword'>goto</span> invalid_args;</td></tr>
<tr class="codeline" data-linenumber="6420"><td class="num" id="LN6420">6420</td><td class="line">    <span class='keyword'>if</span> (!getClusterHostFromCmdArgs(1, argv, &amp;ip, &amp;port))</td></tr>
<tr class="codeline" data-linenumber="6421"><td class="num" id="LN6421">6421</td><td class="line">        <span class='keyword'>goto</span> invalid_args;</td></tr>
<tr class="codeline" data-linenumber="6422"><td class="num" id="LN6422">6422</td><td class="line">    <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Adding node %s:%d to cluster %s:%d\n"</span>, ip, port,<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Adding node %s:%d to cluster %s:%d\n"<br>, ip, port, ref_ip, ref_port)</span></span></td></tr>
<tr class="codeline" data-linenumber="6423"><td class="num" id="LN6423">6423</td><td class="line">                          <span class='macro'>ref_ip, ref_port)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Adding node %s:%d to cluster %s:%d\n"<br>, ip, port, ref_ip, ref_port)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6424"><td class="num" id="LN6424">6424</td><td class="line">    <span class='comment'>// Check the existing cluster</span></td></tr>
<tr class="codeline" data-linenumber="6425"><td class="num" id="LN6425">6425</td><td class="line">    clusterManagerNode *refnode = clusterManagerNewNode(ref_ip, ref_port, 0);</td></tr>
<tr class="codeline" data-linenumber="6426"><td class="num" id="LN6426">6426</td><td class="line">    <span class='keyword'>if</span> (!clusterManagerLoadInfoFromNode(refnode)) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="6427"><td class="num" id="LN6427">6427</td><td class="line">    <span class='keyword'>if</span> (!clusterManagerCheckCluster(0)) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="6428"><td class="num" id="LN6428">6428</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6429"><td class="num" id="LN6429">6429</td><td class="line">    <span class='comment'>/* If --cluster-master-id was specified, try to resolve it now so that we</span></td></tr>
<tr class="codeline" data-linenumber="6430"><td class="num" id="LN6430">6430</td><td class="line">     <span class='comment'>* abort before starting with the node configuration. */</span></td></tr>
<tr class="codeline" data-linenumber="6431"><td class="num" id="LN6431">6431</td><td class="line">    clusterManagerNode *master_node = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6432"><td class="num" id="LN6432">6432</td><td class="line">    <span class='keyword'>if</span> (config.cluster_manager_command.flags &amp; <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_SLAVE<span class='macro_popup'>1 &lt;&lt; 1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6433"><td class="num" id="LN6433">6433</td><td class="line">        <span class='keyword'>char</span> *master_id = config.cluster_manager_command.master_id;</td></tr>
<tr class="codeline" data-linenumber="6434"><td class="num" id="LN6434">6434</td><td class="line">        <span class='keyword'>if</span> (master_id != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6435"><td class="num" id="LN6435">6435</td><td class="line">            master_node = clusterManagerNodeByName(master_id);</td></tr>
<tr class="codeline" data-linenumber="6436"><td class="num" id="LN6436">6436</td><td class="line">            <span class='keyword'>if</span> (master_node == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6437"><td class="num" id="LN6437">6437</td><td class="line">                <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"[ERR] No such master ID %s\n"</span>, master_id)<span class='macro_popup'>clusterManagerLog(3,"[ERR] No such master ID %s\n", master_id<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6438"><td class="num" id="LN6438">6438</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="6439"><td class="num" id="LN6439">6439</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="6440"><td class="num" id="LN6440">6440</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="6441"><td class="num" id="LN6441">6441</td><td class="line">            master_node = clusterManagerNodeWithLeastReplicas();</td></tr>
<tr class="codeline" data-linenumber="6442"><td class="num" id="LN6442">6442</td><td class="line">            <span class='macro'>assert(master_node != NULL)<span class='macro_popup'>((master_node != ((void*)0)) ? (void) (0) : __assert_fail ("master_node != NULL"<br>, "redis-cli.c", 6442, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6443"><td class="num" id="LN6443">6443</td><td class="line">            printf(<span class='string_literal'>"Automatically selected master %s:%d\n"</span>, master_node-&gt;ip,</td></tr>
<tr class="codeline" data-linenumber="6444"><td class="num" id="LN6444">6444</td><td class="line">                   master_node-&gt;port);</td></tr>
<tr class="codeline" data-linenumber="6445"><td class="num" id="LN6445">6445</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6446"><td class="num" id="LN6446">6446</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6447"><td class="num" id="LN6447">6447</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6448"><td class="num" id="LN6448">6448</td><td class="line">    <span class='comment'>// Add the new node</span></td></tr>
<tr class="codeline" data-linenumber="6449"><td class="num" id="LN6449">6449</td><td class="line">    clusterManagerNode *new_node = clusterManagerNewNode(ip, port, 0);</td></tr>
<tr class="codeline" data-linenumber="6450"><td class="num" id="LN6450">6450</td><td class="line">    <span class='keyword'>int</span> added = 0;</td></tr>
<tr class="codeline" data-linenumber="6451"><td class="num" id="LN6451">6451</td><td class="line">    <span class='keyword'>if</span> (!clusterManagerNodeConnect(new_node)) {</td></tr>
<tr class="codeline" data-linenumber="6452"><td class="num" id="LN6452">6452</td><td class="line">        <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"[ERR] Sorry, can't connect to node %s:%d\n"</span>,<span class='macro_popup'>clusterManagerLog(3,"[ERR] Sorry, can't connect to node %s:%d\n"<br>, ip, port)</span></span></td></tr>
<tr class="codeline" data-linenumber="6453"><td class="num" id="LN6453">6453</td><td class="line">                             <span class='macro'>ip, port)<span class='macro_popup'>clusterManagerLog(3,"[ERR] Sorry, can't connect to node %s:%d\n"<br>, ip, port)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6454"><td class="num" id="LN6454">6454</td><td class="line">        success = 0;</td></tr>
<tr class="codeline" data-linenumber="6455"><td class="num" id="LN6455">6455</td><td class="line">        <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="6456"><td class="num" id="LN6456">6456</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6457"><td class="num" id="LN6457">6457</td><td class="line">    <span class='keyword'>char</span> *err = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6458"><td class="num" id="LN6458">6458</td><td class="line">    <span class='keyword'>if</span> (!(success = clusterManagerNodeIsCluster(new_node, &amp;err))) {</td></tr>
<tr class="codeline" data-linenumber="6459"><td class="num" id="LN6459">6459</td><td class="line">        clusterManagerPrintNotClusterNodeError(new_node, err);</td></tr>
<tr class="codeline" data-linenumber="6460"><td class="num" id="LN6460">6460</td><td class="line">        <span class='keyword'>if</span> (err) zfree(err);</td></tr>
<tr class="codeline" data-linenumber="6461"><td class="num" id="LN6461">6461</td><td class="line">        <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="6462"><td class="num" id="LN6462">6462</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6463"><td class="num" id="LN6463">6463</td><td class="line">    <span class='keyword'>if</span> (!clusterManagerNodeLoadInfo(new_node, 0, &amp;err)) {</td></tr>
<tr class="codeline" data-linenumber="6464"><td class="num" id="LN6464">6464</td><td class="line">        <span class='keyword'>if</span> (err) {</td></tr>
<tr class="codeline" data-linenumber="6465"><td class="num" id="LN6465">6465</td><td class="line">            <span class='macro'>CLUSTER_MANAGER_PRINT_REPLY_ERROR(new_node, err)<span class='macro_popup'>clusterManagerLog(3,"Node %s:%d replied with error:\n%s\n", new_node<br>-&gt;ip, new_node-&gt;port, err);</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6466"><td class="num" id="LN6466">6466</td><td class="line">            zfree(err);</td></tr>
<tr class="codeline" data-linenumber="6467"><td class="num" id="LN6467">6467</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6468"><td class="num" id="LN6468">6468</td><td class="line">        success = 0;</td></tr>
<tr class="codeline" data-linenumber="6469"><td class="num" id="LN6469">6469</td><td class="line">        <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="6470"><td class="num" id="LN6470">6470</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6471"><td class="num" id="LN6471">6471</td><td class="line">    <span class='keyword'>if</span> (!(success = clusterManagerNodeIsEmpty(new_node, &amp;err))) {</td></tr>
<tr class="codeline" data-linenumber="6472"><td class="num" id="LN6472">6472</td><td class="line">        clusterManagerPrintNotEmptyNodeError(new_node, err);</td></tr>
<tr class="codeline" data-linenumber="6473"><td class="num" id="LN6473">6473</td><td class="line">        <span class='keyword'>if</span> (err) zfree(err);</td></tr>
<tr class="codeline" data-linenumber="6474"><td class="num" id="LN6474">6474</td><td class="line">        <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="6475"><td class="num" id="LN6475">6475</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6476"><td class="num" id="LN6476">6476</td><td class="line">    clusterManagerNode *first = <span class='macro'>listFirst(cluster_manager.nodes)<span class='macro_popup'>((cluster_manager.nodes)-&gt;head)</span></span>-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="6477"><td class="num" id="LN6477">6477</td><td class="line">    listAddNodeTail(cluster_manager.nodes, new_node);</td></tr>
<tr class="codeline" data-linenumber="6478"><td class="num" id="LN6478">6478</td><td class="line">    added = 1;</td></tr>
<tr class="codeline" data-linenumber="6479"><td class="num" id="LN6479">6479</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6480"><td class="num" id="LN6480">6480</td><td class="line">    <span class='keyword'>if</span> (!master_node) {</td></tr>
<tr class="codeline" data-linenumber="6481"><td class="num" id="LN6481">6481</td><td class="line">        <span class='comment'>/* Send functions to the new node, if new node is a replica it will get the functions from its primary. */</span></td></tr>
<tr class="codeline" data-linenumber="6482"><td class="num" id="LN6482">6482</td><td class="line">        <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Getting functions from cluster\n"</span>)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Getting functions from cluster\n"<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6483"><td class="num" id="LN6483">6483</td><td class="line">        reply = <span class='macro'>CLUSTER_MANAGER_COMMAND(refnode, <span class='string_literal'>"FUNCTION DUMP"</span>)<span class='macro_popup'>(redisCommand(refnode-&gt;context, "FUNCTION DUMP"))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6484"><td class="num" id="LN6484">6484</td><td class="line">        <span class='keyword'>if</span> (!clusterManagerCheckRedisReply(refnode, reply, &amp;err)) {</td></tr>
<tr class="codeline" data-linenumber="6485"><td class="num" id="LN6485">6485</td><td class="line">            <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Failed retrieving Functions from the cluster, "<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Failed retrieving Functions from the cluster, "<br> "skip this step as Redis version do not support function command (error = '%s')\n"<br>, err? err : "NULL reply")</span></span></span></td></tr>
<tr class="codeline" data-linenumber="6486"><td class="num" id="LN6486">6486</td><td class="line">                    <span class='string_literal'><span class='macro'>"skip this step as Redis version do not support function command (error = '%s')\n"</span>, err? err : <span class='string_literal'>"NULL reply"</span>)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Failed retrieving Functions from the cluster, "<br> "skip this step as Redis version do not support function command (error = '%s')\n"<br>, err? err : "NULL reply")</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6487"><td class="num" id="LN6487">6487</td><td class="line">            <span class='keyword'>if</span> (err) zfree(err);</td></tr>
<tr class="codeline" data-linenumber="6488"><td class="num" id="LN6488">6488</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="6489"><td class="num" id="LN6489">6489</td><td class="line">            <span class='macro'>assert(reply-&gt;type == REDIS_REPLY_STRING)<span class='macro_popup'>((reply-&gt;type == 1) ? (void) (0) : __assert_fail ("reply-&gt;type == REDIS_REPLY_STRING"<br>, "redis-cli.c", 6489, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6490"><td class="num" id="LN6490">6490</td><td class="line">            <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Send FUNCTION LIST to %s:%d to verify there is no functions in it\n"</span>, ip, port)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Send FUNCTION LIST to %s:%d to verify there is no functions in it\n"<br>, ip, port)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6491"><td class="num" id="LN6491">6491</td><td class="line">            function_list_reply = <span class='macro'>CLUSTER_MANAGER_COMMAND(new_node, <span class='string_literal'>"FUNCTION LIST"</span>)<span class='macro_popup'>(redisCommand(new_node-&gt;context, "FUNCTION LIST"))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6492"><td class="num" id="LN6492">6492</td><td class="line">            <span class='keyword'>if</span> (!clusterManagerCheckRedisReply(new_node, function_list_reply, &amp;err)) {</td></tr>
<tr class="codeline" data-linenumber="6493"><td class="num" id="LN6493">6493</td><td class="line">                <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"&gt;&gt;&gt; Failed on CLUSTER LIST (error = '%s')\r\n"</span>, err? err : <span class='string_literal'>"NULL reply"</span>)<span class='macro_popup'>clusterManagerLog(3,"&gt;&gt;&gt; Failed on CLUSTER LIST (error = '%s')\r\n"<br>, err? err : "NULL reply")</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6494"><td class="num" id="LN6494">6494</td><td class="line">                <span class='keyword'>if</span> (err) zfree(err);</td></tr>
<tr class="codeline" data-linenumber="6495"><td class="num" id="LN6495">6495</td><td class="line">                success = 0;</td></tr>
<tr class="codeline" data-linenumber="6496"><td class="num" id="LN6496">6496</td><td class="line">                <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="6497"><td class="num" id="LN6497">6497</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="6498"><td class="num" id="LN6498">6498</td><td class="line">            <span class='macro'>assert(function_list_reply-&gt;type == REDIS_REPLY_ARRAY)<span class='macro_popup'>((function_list_reply-&gt;type == 2) ? (void) (0) : __assert_fail<br> ("function_list_reply-&gt;type == REDIS_REPLY_ARRAY", "redis-cli.c"<br>, 6498, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6499"><td class="num" id="LN6499">6499</td><td class="line">            <span class='keyword'>if</span> (function_list_reply-&gt;elements &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="6500"><td class="num" id="LN6500">6500</td><td class="line">                <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"&gt;&gt;&gt; New node already contains functions and can not be added to the cluster. Use FUNCTION FLUSH and try again.\r\n"</span>)<span class='macro_popup'>clusterManagerLog(3,"&gt;&gt;&gt; New node already contains functions and can not be added to the cluster. Use FUNCTION FLUSH and try again.\r\n"<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6501"><td class="num" id="LN6501">6501</td><td class="line">                success = 0;</td></tr>
<tr class="codeline" data-linenumber="6502"><td class="num" id="LN6502">6502</td><td class="line">                <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="6503"><td class="num" id="LN6503">6503</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="6504"><td class="num" id="LN6504">6504</td><td class="line">            <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Send FUNCTION RESTORE to %s:%d\n"</span>, ip, port)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Send FUNCTION RESTORE to %s:%d\n"<br>, ip, port)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6505"><td class="num" id="LN6505">6505</td><td class="line">            function_restore_reply = <span class='macro'>CLUSTER_MANAGER_COMMAND(new_node, <span class='string_literal'>"FUNCTION RESTORE %b"</span>, reply-&gt;str, reply-&gt;len)<span class='macro_popup'>(redisCommand(new_node-&gt;context, "FUNCTION RESTORE %b", reply<br>-&gt;str, reply-&gt;len))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6506"><td class="num" id="LN6506">6506</td><td class="line">            <span class='keyword'>if</span> (!clusterManagerCheckRedisReply(new_node, function_restore_reply, &amp;err)) {</td></tr>
<tr class="codeline" data-linenumber="6507"><td class="num" id="LN6507">6507</td><td class="line">                <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"&gt;&gt;&gt; Failed loading functions to the new node (error = '%s')\r\n"</span>, err? err : <span class='string_literal'>"NULL reply"</span>)<span class='macro_popup'>clusterManagerLog(3,"&gt;&gt;&gt; Failed loading functions to the new node (error = '%s')\r\n"<br>, err? err : "NULL reply")</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6508"><td class="num" id="LN6508">6508</td><td class="line">                <span class='keyword'>if</span> (err) zfree(err);</td></tr>
<tr class="codeline" data-linenumber="6509"><td class="num" id="LN6509">6509</td><td class="line">                success = 0;</td></tr>
<tr class="codeline" data-linenumber="6510"><td class="num" id="LN6510">6510</td><td class="line">                <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="6511"><td class="num" id="LN6511">6511</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="6512"><td class="num" id="LN6512">6512</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6513"><td class="num" id="LN6513">6513</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6514"><td class="num" id="LN6514">6514</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6515"><td class="num" id="LN6515">6515</td><td class="line">    <span class='keyword'>if</span> (reply) freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="6516"><td class="num" id="LN6516">6516</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6517"><td class="num" id="LN6517">6517</td><td class="line">    <span class='comment'>// Send CLUSTER MEET command to the new node</span></td></tr>
<tr class="codeline" data-linenumber="6518"><td class="num" id="LN6518">6518</td><td class="line">    <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Send CLUSTER MEET to node %s:%d to make it "<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Send CLUSTER MEET to node %s:%d to make it "<br> "join the cluster.\n", ip, port)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="6519"><td class="num" id="LN6519">6519</td><td class="line">                          <span class='string_literal'><span class='macro'>"join the cluster.\n"</span>, ip, port)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Send CLUSTER MEET to node %s:%d to make it "<br> "join the cluster.\n", ip, port)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6520"><td class="num" id="LN6520">6520</td><td class="line">    <span class='comment'>/* CLUSTER MEET requires an IP address, so we do a DNS lookup here. */</span></td></tr>
<tr class="codeline" data-linenumber="6521"><td class="num" id="LN6521">6521</td><td class="line">    <span class='keyword'>char</span> first_ip[<span class='macro'>NET_IP_STR_LEN<span class='macro_popup'>46</span></span>];</td></tr>
<tr class="codeline" data-linenumber="6522"><td class="num" id="LN6522">6522</td><td class="line">    <span class='keyword'>if</span> (anetResolve(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, first-&gt;ip, first_ip, <span class='keyword'>sizeof</span>(first_ip), <span class='macro'>ANET_NONE<span class='macro_popup'>0</span></span>) == <span class='macro'>ANET_ERR<span class='macro_popup'>-1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6523"><td class="num" id="LN6523">6523</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Invalid IP address or hostname specified: %s\n"</span>, first-&gt;ip);</td></tr>
<tr class="codeline" data-linenumber="6524"><td class="num" id="LN6524">6524</td><td class="line">        success = 0;</td></tr>
<tr class="codeline" data-linenumber="6525"><td class="num" id="LN6525">6525</td><td class="line">        <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="6526"><td class="num" id="LN6526">6526</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6527"><td class="num" id="LN6527">6527</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6528"><td class="num" id="LN6528">6528</td><td class="line">    <span class='keyword'>if</span> (first-&gt;bus_port == 0 || (first-&gt;bus_port == first-&gt;port + <span class='macro'>CLUSTER_MANAGER_PORT_INCR<span class='macro_popup'>10000</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="6529"><td class="num" id="LN6529">6529</td><td class="line">        <span class='comment'>/* CLUSTER MEET bus-port parameter was added in 4.0.</span></td></tr>
<tr class="codeline" data-linenumber="6530"><td class="num" id="LN6530">6530</td><td class="line">         <span class='comment'>* So if (bus_port == 0) or (bus_port == port + CLUSTER_MANAGER_PORT_INCR),</span></td></tr>
<tr class="codeline" data-linenumber="6531"><td class="num" id="LN6531">6531</td><td class="line">         <span class='comment'>* we just call CLUSTER MEET with 2 arguments, using the old form. */</span></td></tr>
<tr class="codeline" data-linenumber="6532"><td class="num" id="LN6532">6532</td><td class="line">        reply = <span class='macro'>CLUSTER_MANAGER_COMMAND(new_node, <span class='string_literal'>"CLUSTER MEET %s %d"</span>,<span class='macro_popup'>(redisCommand(new_node-&gt;context, "CLUSTER MEET %s %d", first_ip<br>, first-&gt;port))</span></span></td></tr>
<tr class="codeline" data-linenumber="6533"><td class="num" id="LN6533">6533</td><td class="line">                                        <span class='macro'>first_ip, first-&gt;port)<span class='macro_popup'>(redisCommand(new_node-&gt;context, "CLUSTER MEET %s %d", first_ip<br>, first-&gt;port))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6534"><td class="num" id="LN6534">6534</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="6535"><td class="num" id="LN6535">6535</td><td class="line">        reply = <span class='macro'>CLUSTER_MANAGER_COMMAND(new_node, <span class='string_literal'>"CLUSTER MEET %s %d %d"</span>,<span class='macro_popup'>(redisCommand(new_node-&gt;context, "CLUSTER MEET %s %d %d", first<br>-&gt;ip, first-&gt;port, first-&gt;bus_port))</span></span></td></tr>
<tr class="codeline" data-linenumber="6536"><td class="num" id="LN6536">6536</td><td class="line">                                        <span class='macro'>first-&gt;ip, first-&gt;port, first-&gt;bus_port)<span class='macro_popup'>(redisCommand(new_node-&gt;context, "CLUSTER MEET %s %d %d", first<br>-&gt;ip, first-&gt;port, first-&gt;bus_port))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6537"><td class="num" id="LN6537">6537</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6538"><td class="num" id="LN6538">6538</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6539"><td class="num" id="LN6539">6539</td><td class="line">    <span class='keyword'>if</span> (!(success = clusterManagerCheckRedisReply(new_node, reply, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)))</td></tr>
<tr class="codeline" data-linenumber="6540"><td class="num" id="LN6540">6540</td><td class="line">        <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="6541"><td class="num" id="LN6541">6541</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6542"><td class="num" id="LN6542">6542</td><td class="line">    <span class='comment'>/* Additional configuration is needed if the node is added as a slave. */</span></td></tr>
<tr class="codeline" data-linenumber="6543"><td class="num" id="LN6543">6543</td><td class="line">    <span class='keyword'>if</span> (master_node) {</td></tr>
<tr class="codeline" data-linenumber="6544"><td class="num" id="LN6544">6544</td><td class="line">        sleep(1);</td></tr>
<tr class="codeline" data-linenumber="6545"><td class="num" id="LN6545">6545</td><td class="line">        clusterManagerWaitForClusterJoin();</td></tr>
<tr class="codeline" data-linenumber="6546"><td class="num" id="LN6546">6546</td><td class="line">        <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Configure node as replica of %s:%d.\n"</span>,<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Configure node as replica of %s:%d.\n"<br>, master_node-&gt;ip, master_node-&gt;port)</span></span></td></tr>
<tr class="codeline" data-linenumber="6547"><td class="num" id="LN6547">6547</td><td class="line">                              <span class='macro'>master_node-&gt;ip, master_node-&gt;port)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Configure node as replica of %s:%d.\n"<br>, master_node-&gt;ip, master_node-&gt;port)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6548"><td class="num" id="LN6548">6548</td><td class="line">        freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="6549"><td class="num" id="LN6549">6549</td><td class="line">        reply = <span class='macro'>CLUSTER_MANAGER_COMMAND(new_node, <span class='string_literal'>"CLUSTER REPLICATE %s"</span>,<span class='macro_popup'>(redisCommand(new_node-&gt;context, "CLUSTER REPLICATE %s", master_node<br>-&gt;name))</span></span></td></tr>
<tr class="codeline" data-linenumber="6550"><td class="num" id="LN6550">6550</td><td class="line">                                        <span class='macro'>master_node-&gt;name)<span class='macro_popup'>(redisCommand(new_node-&gt;context, "CLUSTER REPLICATE %s", master_node<br>-&gt;name))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6551"><td class="num" id="LN6551">6551</td><td class="line">        <span class='keyword'>if</span> (!(success = clusterManagerCheckRedisReply(new_node, reply, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)))</td></tr>
<tr class="codeline" data-linenumber="6552"><td class="num" id="LN6552">6552</td><td class="line">            <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="6553"><td class="num" id="LN6553">6553</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6554"><td class="num" id="LN6554">6554</td><td class="line">    <span class='macro'>clusterManagerLogOk(<span class='string_literal'>"[OK] New node added correctly.\n"</span>)<span class='macro_popup'>clusterManagerLog(4,"[OK] New node added correctly.\n")</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6555"><td class="num" id="LN6555">6555</td><td class="line">cleanup:</td></tr>
<tr class="codeline" data-linenumber="6556"><td class="num" id="LN6556">6556</td><td class="line">    <span class='keyword'>if</span> (!added &amp;&amp; new_node) freeClusterManagerNode(new_node);</td></tr>
<tr class="codeline" data-linenumber="6557"><td class="num" id="LN6557">6557</td><td class="line">    <span class='keyword'>if</span> (reply) freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="6558"><td class="num" id="LN6558">6558</td><td class="line">    <span class='keyword'>if</span> (function_restore_reply) freeReplyObject(function_restore_reply);</td></tr>
<tr class="codeline" data-linenumber="6559"><td class="num" id="LN6559">6559</td><td class="line">    <span class='keyword'>if</span> (function_list_reply) freeReplyObject(function_list_reply);</td></tr>
<tr class="codeline" data-linenumber="6560"><td class="num" id="LN6560">6560</td><td class="line">    <span class='keyword'>return</span> success;</td></tr>
<tr class="codeline" data-linenumber="6561"><td class="num" id="LN6561">6561</td><td class="line">invalid_args:</td></tr>
<tr class="codeline" data-linenumber="6562"><td class="num" id="LN6562">6562</td><td class="line">    fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='macro'>CLUSTER_MANAGER_INVALID_HOST_ARG<span class='macro_popup'>"[ERR] Invalid arguments: you need to pass either a valid " "address (ie. 120.0.0.1:7000) or space separated IP "<br> "and port (ie. 120.0.0.1 7000)\n"</span></span>);</td></tr>
<tr class="codeline" data-linenumber="6563"><td class="num" id="LN6563">6563</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="6564"><td class="num" id="LN6564">6564</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="6565"><td class="num" id="LN6565">6565</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6566"><td class="num" id="LN6566">6566</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerCommandDeleteNode(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv) {</td></tr>
<tr class="codeline" data-linenumber="6567"><td class="num" id="LN6567">6567</td><td class="line">    <span class='macro'>UNUSED(argc)<span class='macro_popup'>((void) argc)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6568"><td class="num" id="LN6568">6568</td><td class="line">    <span class='keyword'>int</span> success = 1;</td></tr>
<tr class="codeline" data-linenumber="6569"><td class="num" id="LN6569">6569</td><td class="line">    <span class='keyword'>int</span> port = 0;</td></tr>
<tr class="codeline" data-linenumber="6570"><td class="num" id="LN6570">6570</td><td class="line">    <span class='keyword'>char</span> *ip = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6571"><td class="num" id="LN6571">6571</td><td class="line">    <span class='keyword'>if</span> (!getClusterHostFromCmdArgs(1, argv, &amp;ip, &amp;port)) <span class='keyword'>goto</span> invalid_args;</td></tr>
<tr class="codeline" data-linenumber="6572"><td class="num" id="LN6572">6572</td><td class="line">    <span class='keyword'>char</span> *node_id = argv[1];</td></tr>
<tr class="codeline" data-linenumber="6573"><td class="num" id="LN6573">6573</td><td class="line">    <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Removing node %s from cluster %s:%d\n"</span>,<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Removing node %s from cluster %s:%d\n"<br>, node_id, ip, port)</span></span></td></tr>
<tr class="codeline" data-linenumber="6574"><td class="num" id="LN6574">6574</td><td class="line">                          <span class='macro'>node_id, ip, port)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Removing node %s from cluster %s:%d\n"<br>, node_id, ip, port)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6575"><td class="num" id="LN6575">6575</td><td class="line">    clusterManagerNode *ref_node = clusterManagerNewNode(ip, port, 0);</td></tr>
<tr class="codeline" data-linenumber="6576"><td class="num" id="LN6576">6576</td><td class="line">    clusterManagerNode *node = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6577"><td class="num" id="LN6577">6577</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6578"><td class="num" id="LN6578">6578</td><td class="line">    <span class='comment'>// Load cluster information</span></td></tr>
<tr class="codeline" data-linenumber="6579"><td class="num" id="LN6579">6579</td><td class="line">    <span class='keyword'>if</span> (!clusterManagerLoadInfoFromNode(ref_node)) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="6580"><td class="num" id="LN6580">6580</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6581"><td class="num" id="LN6581">6581</td><td class="line">    <span class='comment'>// Check if the node exists and is not empty</span></td></tr>
<tr class="codeline" data-linenumber="6582"><td class="num" id="LN6582">6582</td><td class="line">    node = clusterManagerNodeByName(node_id);</td></tr>
<tr class="codeline" data-linenumber="6583"><td class="num" id="LN6583">6583</td><td class="line">    <span class='keyword'>if</span> (node == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6584"><td class="num" id="LN6584">6584</td><td class="line">        <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"[ERR] No such node ID %s\n"</span>, node_id)<span class='macro_popup'>clusterManagerLog(3,"[ERR] No such node ID %s\n", node_id)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6585"><td class="num" id="LN6585">6585</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="6586"><td class="num" id="LN6586">6586</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6587"><td class="num" id="LN6587">6587</td><td class="line">    <span class='keyword'>if</span> (node-&gt;slots_count != 0) {</td></tr>
<tr class="codeline" data-linenumber="6588"><td class="num" id="LN6588">6588</td><td class="line">        <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"[ERR] Node %s:%d is not empty! Reshard data "<span class='macro_popup'>clusterManagerLog(3,"[ERR] Node %s:%d is not empty! Reshard data "<br> "away and try again.\n", node-&gt;ip, node-&gt;port)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="6589"><td class="num" id="LN6589">6589</td><td class="line">                             <span class='string_literal'><span class='macro'>"away and try again.\n"</span>, node-&gt;ip, node-&gt;port)<span class='macro_popup'>clusterManagerLog(3,"[ERR] Node %s:%d is not empty! Reshard data "<br> "away and try again.\n", node-&gt;ip, node-&gt;port)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6590"><td class="num" id="LN6590">6590</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="6591"><td class="num" id="LN6591">6591</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6592"><td class="num" id="LN6592">6592</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6593"><td class="num" id="LN6593">6593</td><td class="line">    <span class='comment'>// Send CLUSTER FORGET to all the nodes but the node to remove</span></td></tr>
<tr class="codeline" data-linenumber="6594"><td class="num" id="LN6594">6594</td><td class="line">    <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Sending CLUSTER FORGET messages to the "<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Sending CLUSTER FORGET messages to the "<br> "cluster...\n")</span></span></span></td></tr>
<tr class="codeline" data-linenumber="6595"><td class="num" id="LN6595">6595</td><td class="line">                          <span class='string_literal'><span class='macro'>"cluster...\n"</span>)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Sending CLUSTER FORGET messages to the "<br> "cluster...\n")</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6596"><td class="num" id="LN6596">6596</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="6597"><td class="num" id="LN6597">6597</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="6598"><td class="num" id="LN6598">6598</td><td class="line">    listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="6599"><td class="num" id="LN6599">6599</td><td class="line">    <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6600"><td class="num" id="LN6600">6600</td><td class="line">        clusterManagerNode *n = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="6601"><td class="num" id="LN6601">6601</td><td class="line">        <span class='keyword'>if</span> (n == node) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="6602"><td class="num" id="LN6602">6602</td><td class="line">        <span class='keyword'>if</span> (n-&gt;replicate &amp;&amp; !strcasecmp(n-&gt;replicate, node_id)) {</td></tr>
<tr class="codeline" data-linenumber="6603"><td class="num" id="LN6603">6603</td><td class="line">            <span class='comment'>// Reconfigure the slave to replicate with some other node</span></td></tr>
<tr class="codeline" data-linenumber="6604"><td class="num" id="LN6604">6604</td><td class="line">            clusterManagerNode *master = clusterManagerNodeWithLeastReplicas();</td></tr>
<tr class="codeline" data-linenumber="6605"><td class="num" id="LN6605">6605</td><td class="line">            <span class='macro'>assert(master != NULL)<span class='macro_popup'>((master != ((void*)0)) ? (void) (0) : __assert_fail ("master != NULL"<br>, "redis-cli.c", 6605, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6606"><td class="num" id="LN6606">6606</td><td class="line">            <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; %s:%d as replica of %s:%d\n"</span>,<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; %s:%d as replica of %s:%d\n"<br>, n-&gt;ip, n-&gt;port, master-&gt;ip, master-&gt;port)</span></span></td></tr>
<tr class="codeline" data-linenumber="6607"><td class="num" id="LN6607">6607</td><td class="line">                                  <span class='macro'>n-&gt;ip, n-&gt;port, master-&gt;ip, master-&gt;port)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; %s:%d as replica of %s:%d\n"<br>, n-&gt;ip, n-&gt;port, master-&gt;ip, master-&gt;port)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6608"><td class="num" id="LN6608">6608</td><td class="line">            redisReply *r = <span class='macro'>CLUSTER_MANAGER_COMMAND(n, <span class='string_literal'>"CLUSTER REPLICATE %s"</span>,<span class='macro_popup'>(redisCommand(n-&gt;context, "CLUSTER REPLICATE %s", master-&gt;<br>name))</span></span></td></tr>
<tr class="codeline" data-linenumber="6609"><td class="num" id="LN6609">6609</td><td class="line">                                                    <span class='macro'>master-&gt;name)<span class='macro_popup'>(redisCommand(n-&gt;context, "CLUSTER REPLICATE %s", master-&gt;<br>name))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6610"><td class="num" id="LN6610">6610</td><td class="line">            success = clusterManagerCheckRedisReply(n, r, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="6611"><td class="num" id="LN6611">6611</td><td class="line">            <span class='keyword'>if</span> (r) freeReplyObject(r);</td></tr>
<tr class="codeline" data-linenumber="6612"><td class="num" id="LN6612">6612</td><td class="line">            <span class='keyword'>if</span> (!success) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="6613"><td class="num" id="LN6613">6613</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6614"><td class="num" id="LN6614">6614</td><td class="line">        redisReply *r = <span class='macro'>CLUSTER_MANAGER_COMMAND(n, <span class='string_literal'>"CLUSTER FORGET %s"</span>,<span class='macro_popup'>(redisCommand(n-&gt;context, "CLUSTER FORGET %s", node_id))</span></span></td></tr>
<tr class="codeline" data-linenumber="6615"><td class="num" id="LN6615">6615</td><td class="line">                                                <span class='macro'>node_id)<span class='macro_popup'>(redisCommand(n-&gt;context, "CLUSTER FORGET %s", node_id))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6616"><td class="num" id="LN6616">6616</td><td class="line">        success = clusterManagerCheckRedisReply(n, r, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="6617"><td class="num" id="LN6617">6617</td><td class="line">        <span class='keyword'>if</span> (r) freeReplyObject(r);</td></tr>
<tr class="codeline" data-linenumber="6618"><td class="num" id="LN6618">6618</td><td class="line">        <span class='keyword'>if</span> (!success) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="6619"><td class="num" id="LN6619">6619</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6620"><td class="num" id="LN6620">6620</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6621"><td class="num" id="LN6621">6621</td><td class="line">    <span class='comment'>/* Finally send CLUSTER RESET to the node. */</span></td></tr>
<tr class="codeline" data-linenumber="6622"><td class="num" id="LN6622">6622</td><td class="line">    <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Sending CLUSTER RESET SOFT to the "<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Sending CLUSTER RESET SOFT to the "<br> "deleted node.\n")</span></span></span></td></tr>
<tr class="codeline" data-linenumber="6623"><td class="num" id="LN6623">6623</td><td class="line">                          <span class='string_literal'><span class='macro'>"deleted node.\n"</span>)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Sending CLUSTER RESET SOFT to the "<br> "deleted node.\n")</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6624"><td class="num" id="LN6624">6624</td><td class="line">    redisReply *r = redisCommand(node-&gt;context, <span class='string_literal'>"CLUSTER RESET %s"</span>, <span class='string_literal'>"SOFT"</span>);</td></tr>
<tr class="codeline" data-linenumber="6625"><td class="num" id="LN6625">6625</td><td class="line">    success = clusterManagerCheckRedisReply(node, r, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="6626"><td class="num" id="LN6626">6626</td><td class="line">    <span class='keyword'>if</span> (r) freeReplyObject(r);</td></tr>
<tr class="codeline" data-linenumber="6627"><td class="num" id="LN6627">6627</td><td class="line">    <span class='keyword'>return</span> success;</td></tr>
<tr class="codeline" data-linenumber="6628"><td class="num" id="LN6628">6628</td><td class="line">invalid_args:</td></tr>
<tr class="codeline" data-linenumber="6629"><td class="num" id="LN6629">6629</td><td class="line">    fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='macro'>CLUSTER_MANAGER_INVALID_HOST_ARG<span class='macro_popup'>"[ERR] Invalid arguments: you need to pass either a valid " "address (ie. 120.0.0.1:7000) or space separated IP "<br> "and port (ie. 120.0.0.1 7000)\n"</span></span>);</td></tr>
<tr class="codeline" data-linenumber="6630"><td class="num" id="LN6630">6630</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="6631"><td class="num" id="LN6631">6631</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="6632"><td class="num" id="LN6632">6632</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6633"><td class="num" id="LN6633">6633</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerCommandInfo(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv) {</td></tr>
<tr class="codeline" data-linenumber="6634"><td class="num" id="LN6634">6634</td><td class="line">    <span class='keyword'>int</span> port = 0;</td></tr>
<tr class="codeline" data-linenumber="6635"><td class="num" id="LN6635">6635</td><td class="line">    <span class='keyword'>char</span> *ip = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6636"><td class="num" id="LN6636">6636</td><td class="line">    <span class='keyword'>if</span> (!getClusterHostFromCmdArgs(argc, argv, &amp;ip, &amp;port)) <span class='keyword'>goto</span> invalid_args;</td></tr>
<tr class="codeline" data-linenumber="6637"><td class="num" id="LN6637">6637</td><td class="line">    clusterManagerNode *node = clusterManagerNewNode(ip, port, 0);</td></tr>
<tr class="codeline" data-linenumber="6638"><td class="num" id="LN6638">6638</td><td class="line">    <span class='keyword'>if</span> (!clusterManagerLoadInfoFromNode(node)) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="6639"><td class="num" id="LN6639">6639</td><td class="line">    clusterManagerShowClusterInfo();</td></tr>
<tr class="codeline" data-linenumber="6640"><td class="num" id="LN6640">6640</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="6641"><td class="num" id="LN6641">6641</td><td class="line">invalid_args:</td></tr>
<tr class="codeline" data-linenumber="6642"><td class="num" id="LN6642">6642</td><td class="line">    fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='macro'>CLUSTER_MANAGER_INVALID_HOST_ARG<span class='macro_popup'>"[ERR] Invalid arguments: you need to pass either a valid " "address (ie. 120.0.0.1:7000) or space separated IP "<br> "and port (ie. 120.0.0.1 7000)\n"</span></span>);</td></tr>
<tr class="codeline" data-linenumber="6643"><td class="num" id="LN6643">6643</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="6644"><td class="num" id="LN6644">6644</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="6645"><td class="num" id="LN6645">6645</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6646"><td class="num" id="LN6646">6646</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerCommandCheck(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv) {</td></tr>
<tr class="codeline" data-linenumber="6647"><td class="num" id="LN6647">6647</td><td class="line">    <span class='keyword'>int</span> port = 0;</td></tr>
<tr class="codeline" data-linenumber="6648"><td class="num" id="LN6648">6648</td><td class="line">    <span class='keyword'>char</span> *ip = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6649"><td class="num" id="LN6649">6649</td><td class="line">    <span class='keyword'>if</span> (!getClusterHostFromCmdArgs(argc, argv, &amp;ip, &amp;port)) <span class='keyword'>goto</span> invalid_args;</td></tr>
<tr class="codeline" data-linenumber="6650"><td class="num" id="LN6650">6650</td><td class="line">    clusterManagerNode *node = clusterManagerNewNode(ip, port, 0);</td></tr>
<tr class="codeline" data-linenumber="6651"><td class="num" id="LN6651">6651</td><td class="line">    <span class='keyword'>if</span> (!clusterManagerLoadInfoFromNode(node)) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="6652"><td class="num" id="LN6652">6652</td><td class="line">    clusterManagerShowClusterInfo();</td></tr>
<tr class="codeline" data-linenumber="6653"><td class="num" id="LN6653">6653</td><td class="line">    <span class='keyword'>return</span> clusterManagerCheckCluster(0);</td></tr>
<tr class="codeline" data-linenumber="6654"><td class="num" id="LN6654">6654</td><td class="line">invalid_args:</td></tr>
<tr class="codeline" data-linenumber="6655"><td class="num" id="LN6655">6655</td><td class="line">    fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='macro'>CLUSTER_MANAGER_INVALID_HOST_ARG<span class='macro_popup'>"[ERR] Invalid arguments: you need to pass either a valid " "address (ie. 120.0.0.1:7000) or space separated IP "<br> "and port (ie. 120.0.0.1 7000)\n"</span></span>);</td></tr>
<tr class="codeline" data-linenumber="6656"><td class="num" id="LN6656">6656</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="6657"><td class="num" id="LN6657">6657</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="6658"><td class="num" id="LN6658">6658</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6659"><td class="num" id="LN6659">6659</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerCommandFix(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv) {</td></tr>
<tr class="codeline" data-linenumber="6660"><td class="num" id="LN6660">6660</td><td class="line">    config.cluster_manager_command.flags |= <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_FIX<span class='macro_popup'>1 &lt;&lt; 0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6661"><td class="num" id="LN6661">6661</td><td class="line">    <span class='keyword'>return</span> clusterManagerCommandCheck(argc, argv);</td></tr>
<tr class="codeline" data-linenumber="6662"><td class="num" id="LN6662">6662</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="6663"><td class="num" id="LN6663">6663</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6664"><td class="num" id="LN6664">6664</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerCommandReshard(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv) {</td></tr>
<tr class="codeline" data-linenumber="6665"><td class="num" id="LN6665">6665</td><td class="line">    <span class='keyword'>int</span> port = 0;</td></tr>
<tr class="codeline" data-linenumber="6666"><td class="num" id="LN6666">6666</td><td class="line">    <span class='keyword'>char</span> *ip = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6667"><td class="num" id="LN6667">6667</td><td class="line">    <span class='keyword'>if</span> (!getClusterHostFromCmdArgs(argc, argv, &amp;ip, &amp;port)) <span class='keyword'>goto</span> invalid_args;</td></tr>
<tr class="codeline" data-linenumber="6668"><td class="num" id="LN6668">6668</td><td class="line">    clusterManagerNode *node = clusterManagerNewNode(ip, port, 0);</td></tr>
<tr class="codeline" data-linenumber="6669"><td class="num" id="LN6669">6669</td><td class="line">    <span class='keyword'>if</span> (!clusterManagerLoadInfoFromNode(node)) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="6670"><td class="num" id="LN6670">6670</td><td class="line">    clusterManagerCheckCluster(0);</td></tr>
<tr class="codeline" data-linenumber="6671"><td class="num" id="LN6671">6671</td><td class="line">    <span class='keyword'>if</span> (cluster_manager.errors &amp;&amp; <span class='macro'>listLength(cluster_manager.errors)<span class='macro_popup'>((cluster_manager.errors)-&gt;len)</span></span> &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="6672"><td class="num" id="LN6672">6672</td><td class="line">        fflush(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>);</td></tr>
<tr class="codeline" data-linenumber="6673"><td class="num" id="LN6673">6673</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,</td></tr>
<tr class="codeline" data-linenumber="6674"><td class="num" id="LN6674">6674</td><td class="line">                <span class='string_literal'>"*** Please fix your cluster problems before resharding\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="6675"><td class="num" id="LN6675">6675</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="6676"><td class="num" id="LN6676">6676</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6677"><td class="num" id="LN6677">6677</td><td class="line">    <span class='keyword'>int</span> slots = config.cluster_manager_command.slots;</td></tr>
<tr class="codeline" data-linenumber="6678"><td class="num" id="LN6678">6678</td><td class="line">    <span class='keyword'>if</span> (!slots) {</td></tr>
<tr class="codeline" data-linenumber="6679"><td class="num" id="LN6679">6679</td><td class="line">        <span class='keyword'>while</span> (slots &lt;= 0 || slots &gt; <span class='macro'>CLUSTER_MANAGER_SLOTS<span class='macro_popup'>16384</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6680"><td class="num" id="LN6680">6680</td><td class="line">            printf(<span class='string_literal'>"How many slots do you want to move (from 1 to %d)? "</span>,</td></tr>
<tr class="codeline" data-linenumber="6681"><td class="num" id="LN6681">6681</td><td class="line">                   <span class='macro'>CLUSTER_MANAGER_SLOTS<span class='macro_popup'>16384</span></span>);</td></tr>
<tr class="codeline" data-linenumber="6682"><td class="num" id="LN6682">6682</td><td class="line">            fflush(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>);</td></tr>
<tr class="codeline" data-linenumber="6683"><td class="num" id="LN6683">6683</td><td class="line">            <span class='keyword'>char</span> buf[6];</td></tr>
<tr class="codeline" data-linenumber="6684"><td class="num" id="LN6684">6684</td><td class="line">            <span class='keyword'>int</span> nread = read(fileno(<span class='macro'>stdin<span class='macro_popup'>stdin</span></span>),buf,6);</td></tr>
<tr class="codeline" data-linenumber="6685"><td class="num" id="LN6685">6685</td><td class="line">            <span class='keyword'>if</span> (nread &lt;= 0) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="6686"><td class="num" id="LN6686">6686</td><td class="line">            <span class='keyword'>int</span> last_idx = nread - 1;</td></tr>
<tr class="codeline" data-linenumber="6687"><td class="num" id="LN6687">6687</td><td class="line">            <span class='keyword'>if</span> (buf[last_idx] != '\n') {</td></tr>
<tr class="codeline" data-linenumber="6688"><td class="num" id="LN6688">6688</td><td class="line">                <span class='keyword'>int</span> ch;</td></tr>
<tr class="codeline" data-linenumber="6689"><td class="num" id="LN6689">6689</td><td class="line">                <span class='keyword'>while</span> ((ch = getchar()) != '\n' &amp;&amp; ch != <span class='macro'>EOF<span class='macro_popup'>(-1)</span></span>) {}</td></tr>
<tr class="codeline" data-linenumber="6690"><td class="num" id="LN6690">6690</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="6691"><td class="num" id="LN6691">6691</td><td class="line">            buf[last_idx] = '\0';</td></tr>
<tr class="codeline" data-linenumber="6692"><td class="num" id="LN6692">6692</td><td class="line">            slots = atoi(buf);</td></tr>
<tr class="codeline" data-linenumber="6693"><td class="num" id="LN6693">6693</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6694"><td class="num" id="LN6694">6694</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6695"><td class="num" id="LN6695">6695</td><td class="line">    <span class='keyword'>char</span> buf[255];</td></tr>
<tr class="codeline" data-linenumber="6696"><td class="num" id="LN6696">6696</td><td class="line">    <span class='keyword'>char</span> *to = config.cluster_manager_command.to,</td></tr>
<tr class="codeline" data-linenumber="6697"><td class="num" id="LN6697">6697</td><td class="line">         *from = config.cluster_manager_command.from;</td></tr>
<tr class="codeline" data-linenumber="6698"><td class="num" id="LN6698">6698</td><td class="line">    <span class='keyword'>while</span> (to == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6699"><td class="num" id="LN6699">6699</td><td class="line">        printf(<span class='string_literal'>"What is the receiving node ID? "</span>);</td></tr>
<tr class="codeline" data-linenumber="6700"><td class="num" id="LN6700">6700</td><td class="line">        fflush(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>);</td></tr>
<tr class="codeline" data-linenumber="6701"><td class="num" id="LN6701">6701</td><td class="line">        <span class='keyword'>int</span> nread = read(fileno(<span class='macro'>stdin<span class='macro_popup'>stdin</span></span>),buf,255);</td></tr>
<tr class="codeline" data-linenumber="6702"><td class="num" id="LN6702">6702</td><td class="line">        <span class='keyword'>if</span> (nread &lt;= 0) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="6703"><td class="num" id="LN6703">6703</td><td class="line">        <span class='keyword'>int</span> last_idx = nread - 1;</td></tr>
<tr class="codeline" data-linenumber="6704"><td class="num" id="LN6704">6704</td><td class="line">        <span class='keyword'>if</span> (buf[last_idx] != '\n') {</td></tr>
<tr class="codeline" data-linenumber="6705"><td class="num" id="LN6705">6705</td><td class="line">            <span class='keyword'>int</span> ch;</td></tr>
<tr class="codeline" data-linenumber="6706"><td class="num" id="LN6706">6706</td><td class="line">            <span class='keyword'>while</span> ((ch = getchar()) != '\n' &amp;&amp; ch != <span class='macro'>EOF<span class='macro_popup'>(-1)</span></span>) {}</td></tr>
<tr class="codeline" data-linenumber="6707"><td class="num" id="LN6707">6707</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6708"><td class="num" id="LN6708">6708</td><td class="line">        buf[last_idx] = '\0';</td></tr>
<tr class="codeline" data-linenumber="6709"><td class="num" id="LN6709">6709</td><td class="line">        <span class='keyword'>if</span> (strlen(buf) &gt; 0) to = buf;</td></tr>
<tr class="codeline" data-linenumber="6710"><td class="num" id="LN6710">6710</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6711"><td class="num" id="LN6711">6711</td><td class="line">    <span class='keyword'>int</span> raise_err = 0;</td></tr>
<tr class="codeline" data-linenumber="6712"><td class="num" id="LN6712">6712</td><td class="line">    clusterManagerNode *target = clusterNodeForResharding(to, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, &amp;raise_err);</td></tr>
<tr class="codeline" data-linenumber="6713"><td class="num" id="LN6713">6713</td><td class="line">    <span class='keyword'>if</span> (target == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="6714"><td class="num" id="LN6714">6714</td><td class="line">    list *sources = listCreate();</td></tr>
<tr class="codeline" data-linenumber="6715"><td class="num" id="LN6715">6715</td><td class="line">    list *table = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6716"><td class="num" id="LN6716">6716</td><td class="line">    <span class='keyword'>int</span> all = 0, result = 1;</td></tr>
<tr class="codeline" data-linenumber="6717"><td class="num" id="LN6717">6717</td><td class="line">    <span class='keyword'>if</span> (from == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6718"><td class="num" id="LN6718">6718</td><td class="line">        printf(<span class='string_literal'>"Please enter all the source node IDs.\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="6719"><td class="num" id="LN6719">6719</td><td class="line">        printf(<span class='string_literal'>"  Type 'all' to use all the nodes as source nodes for "</span></td></tr>
<tr class="codeline" data-linenumber="6720"><td class="num" id="LN6720">6720</td><td class="line">               <span class='string_literal'>"the hash slots.\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="6721"><td class="num" id="LN6721">6721</td><td class="line">        printf(<span class='string_literal'>"  Type 'done' once you entered all the source nodes IDs.\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="6722"><td class="num" id="LN6722">6722</td><td class="line">        <span class='keyword'>while</span> (1) {</td></tr>
<tr class="codeline" data-linenumber="6723"><td class="num" id="LN6723">6723</td><td class="line">            printf(<span class='string_literal'>"Source node #%lu: "</span>, <span class='macro'>listLength(sources)<span class='macro_popup'>((sources)-&gt;len)</span></span> + 1);</td></tr>
<tr class="codeline" data-linenumber="6724"><td class="num" id="LN6724">6724</td><td class="line">            fflush(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>);</td></tr>
<tr class="codeline" data-linenumber="6725"><td class="num" id="LN6725">6725</td><td class="line">            <span class='keyword'>int</span> nread = read(fileno(<span class='macro'>stdin<span class='macro_popup'>stdin</span></span>),buf,255);</td></tr>
<tr class="codeline" data-linenumber="6726"><td class="num" id="LN6726">6726</td><td class="line">            <span class='keyword'>if</span> (nread &lt;= 0) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="6727"><td class="num" id="LN6727">6727</td><td class="line">            <span class='keyword'>int</span> last_idx = nread - 1;</td></tr>
<tr class="codeline" data-linenumber="6728"><td class="num" id="LN6728">6728</td><td class="line">            <span class='keyword'>if</span> (buf[last_idx] != '\n') {</td></tr>
<tr class="codeline" data-linenumber="6729"><td class="num" id="LN6729">6729</td><td class="line">                <span class='keyword'>int</span> ch;</td></tr>
<tr class="codeline" data-linenumber="6730"><td class="num" id="LN6730">6730</td><td class="line">                <span class='keyword'>while</span> ((ch = getchar()) != '\n' &amp;&amp; ch != <span class='macro'>EOF<span class='macro_popup'>(-1)</span></span>) {}</td></tr>
<tr class="codeline" data-linenumber="6731"><td class="num" id="LN6731">6731</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="6732"><td class="num" id="LN6732">6732</td><td class="line">            buf[last_idx] = '\0';</td></tr>
<tr class="codeline" data-linenumber="6733"><td class="num" id="LN6733">6733</td><td class="line">            <span class='keyword'>if</span> (!strcmp(buf, <span class='string_literal'>"done"</span>)) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="6734"><td class="num" id="LN6734">6734</td><td class="line">            <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(buf, <span class='string_literal'>"all"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="6735"><td class="num" id="LN6735">6735</td><td class="line">                all = 1;</td></tr>
<tr class="codeline" data-linenumber="6736"><td class="num" id="LN6736">6736</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="6737"><td class="num" id="LN6737">6737</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="6738"><td class="num" id="LN6738">6738</td><td class="line">                clusterManagerNode *src =</td></tr>
<tr class="codeline" data-linenumber="6739"><td class="num" id="LN6739">6739</td><td class="line">                    clusterNodeForResharding(buf, target, &amp;raise_err);</td></tr>
<tr class="codeline" data-linenumber="6740"><td class="num" id="LN6740">6740</td><td class="line">                <span class='keyword'>if</span> (src != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) listAddNodeTail(sources, src);</td></tr>
<tr class="codeline" data-linenumber="6741"><td class="num" id="LN6741">6741</td><td class="line">                <span class='keyword'>else</span> <span class='keyword'>if</span> (raise_err) {</td></tr>
<tr class="codeline" data-linenumber="6742"><td class="num" id="LN6742">6742</td><td class="line">                    result = 0;</td></tr>
<tr class="codeline" data-linenumber="6743"><td class="num" id="LN6743">6743</td><td class="line">                    <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="6744"><td class="num" id="LN6744">6744</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="6745"><td class="num" id="LN6745">6745</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="6746"><td class="num" id="LN6746">6746</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6747"><td class="num" id="LN6747">6747</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="6748"><td class="num" id="LN6748">6748</td><td class="line">        <span class='keyword'>char</span> *p;</td></tr>
<tr class="codeline" data-linenumber="6749"><td class="num" id="LN6749">6749</td><td class="line">        <span class='keyword'>while</span>((p = strchr(from, ',')) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6750"><td class="num" id="LN6750">6750</td><td class="line">            *p = '\0';</td></tr>
<tr class="codeline" data-linenumber="6751"><td class="num" id="LN6751">6751</td><td class="line">            <span class='keyword'>if</span> (!strcmp(from, <span class='string_literal'>"all"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="6752"><td class="num" id="LN6752">6752</td><td class="line">                all = 1;</td></tr>
<tr class="codeline" data-linenumber="6753"><td class="num" id="LN6753">6753</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="6754"><td class="num" id="LN6754">6754</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="6755"><td class="num" id="LN6755">6755</td><td class="line">                clusterManagerNode *src =</td></tr>
<tr class="codeline" data-linenumber="6756"><td class="num" id="LN6756">6756</td><td class="line">                    clusterNodeForResharding(from, target, &amp;raise_err);</td></tr>
<tr class="codeline" data-linenumber="6757"><td class="num" id="LN6757">6757</td><td class="line">                <span class='keyword'>if</span> (src != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) listAddNodeTail(sources, src);</td></tr>
<tr class="codeline" data-linenumber="6758"><td class="num" id="LN6758">6758</td><td class="line">                <span class='keyword'>else</span> <span class='keyword'>if</span> (raise_err) {</td></tr>
<tr class="codeline" data-linenumber="6759"><td class="num" id="LN6759">6759</td><td class="line">                    result = 0;</td></tr>
<tr class="codeline" data-linenumber="6760"><td class="num" id="LN6760">6760</td><td class="line">                    <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="6761"><td class="num" id="LN6761">6761</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="6762"><td class="num" id="LN6762">6762</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="6763"><td class="num" id="LN6763">6763</td><td class="line">            from = p + 1;</td></tr>
<tr class="codeline" data-linenumber="6764"><td class="num" id="LN6764">6764</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6765"><td class="num" id="LN6765">6765</td><td class="line">        <span class='comment'>/* Check if there's still another source to process. */</span></td></tr>
<tr class="codeline" data-linenumber="6766"><td class="num" id="LN6766">6766</td><td class="line">        <span class='keyword'>if</span> (!all &amp;&amp; strlen(from) &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="6767"><td class="num" id="LN6767">6767</td><td class="line">            <span class='keyword'>if</span> (!strcmp(from, <span class='string_literal'>"all"</span>)) all = 1;</td></tr>
<tr class="codeline" data-linenumber="6768"><td class="num" id="LN6768">6768</td><td class="line">            <span class='keyword'>if</span> (!all) {</td></tr>
<tr class="codeline" data-linenumber="6769"><td class="num" id="LN6769">6769</td><td class="line">                clusterManagerNode *src =</td></tr>
<tr class="codeline" data-linenumber="6770"><td class="num" id="LN6770">6770</td><td class="line">                    clusterNodeForResharding(from, target, &amp;raise_err);</td></tr>
<tr class="codeline" data-linenumber="6771"><td class="num" id="LN6771">6771</td><td class="line">                <span class='keyword'>if</span> (src != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) listAddNodeTail(sources, src);</td></tr>
<tr class="codeline" data-linenumber="6772"><td class="num" id="LN6772">6772</td><td class="line">                <span class='keyword'>else</span> <span class='keyword'>if</span> (raise_err) {</td></tr>
<tr class="codeline" data-linenumber="6773"><td class="num" id="LN6773">6773</td><td class="line">                    result = 0;</td></tr>
<tr class="codeline" data-linenumber="6774"><td class="num" id="LN6774">6774</td><td class="line">                    <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="6775"><td class="num" id="LN6775">6775</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="6776"><td class="num" id="LN6776">6776</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="6777"><td class="num" id="LN6777">6777</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6778"><td class="num" id="LN6778">6778</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6779"><td class="num" id="LN6779">6779</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="6780"><td class="num" id="LN6780">6780</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="6781"><td class="num" id="LN6781">6781</td><td class="line">    <span class='keyword'>if</span> (all) {</td></tr>
<tr class="codeline" data-linenumber="6782"><td class="num" id="LN6782">6782</td><td class="line">        listEmpty(sources);</td></tr>
<tr class="codeline" data-linenumber="6783"><td class="num" id="LN6783">6783</td><td class="line">        listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="6784"><td class="num" id="LN6784">6784</td><td class="line">        <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6785"><td class="num" id="LN6785">6785</td><td class="line">            clusterManagerNode *n = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="6786"><td class="num" id="LN6786">6786</td><td class="line">            <span class='keyword'>if</span> (n-&gt;flags &amp; <span class='macro'>CLUSTER_MANAGER_FLAG_SLAVE<span class='macro_popup'>1 &lt;&lt; 1</span></span> || n-&gt;replicate)</td></tr>
<tr class="codeline" data-linenumber="6787"><td class="num" id="LN6787">6787</td><td class="line">                <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="6788"><td class="num" id="LN6788">6788</td><td class="line">            <span class='keyword'>if</span> (!<span class='macro'>sdscmp<span class='macro_popup'>hi_sdscmp</span></span>(n-&gt;name, target-&gt;name)) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="6789"><td class="num" id="LN6789">6789</td><td class="line">            listAddNodeTail(sources, n);</td></tr>
<tr class="codeline" data-linenumber="6790"><td class="num" id="LN6790">6790</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6791"><td class="num" id="LN6791">6791</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6792"><td class="num" id="LN6792">6792</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>listLength(sources)<span class='macro_popup'>((sources)-&gt;len)</span></span> == 0) {</td></tr>
<tr class="codeline" data-linenumber="6793"><td class="num" id="LN6793">6793</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"*** No source nodes given, operation aborted.\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="6794"><td class="num" id="LN6794">6794</td><td class="line">        result = 0;</td></tr>
<tr class="codeline" data-linenumber="6795"><td class="num" id="LN6795">6795</td><td class="line">        <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="6796"><td class="num" id="LN6796">6796</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6797"><td class="num" id="LN6797">6797</td><td class="line">    printf(<span class='string_literal'>"\nReady to move %d slots.\n"</span>, slots);</td></tr>
<tr class="codeline" data-linenumber="6798"><td class="num" id="LN6798">6798</td><td class="line">    printf(<span class='string_literal'>"  Source nodes:\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="6799"><td class="num" id="LN6799">6799</td><td class="line">    listRewind(sources, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="6800"><td class="num" id="LN6800">6800</td><td class="line">    <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6801"><td class="num" id="LN6801">6801</td><td class="line">        clusterManagerNode *src = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="6802"><td class="num" id="LN6802">6802</td><td class="line">        <span class='macro'>sds<span class='macro_popup'>hisds</span></span> info = clusterManagerNodeInfo(src, 4);</td></tr>
<tr class="codeline" data-linenumber="6803"><td class="num" id="LN6803">6803</td><td class="line">        printf(<span class='string_literal'>"%s\n"</span>, info);</td></tr>
<tr class="codeline" data-linenumber="6804"><td class="num" id="LN6804">6804</td><td class="line">        <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(info);</td></tr>
<tr class="codeline" data-linenumber="6805"><td class="num" id="LN6805">6805</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6806"><td class="num" id="LN6806">6806</td><td class="line">    printf(<span class='string_literal'>"  Destination node:\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="6807"><td class="num" id="LN6807">6807</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> info = clusterManagerNodeInfo(target, 4);</td></tr>
<tr class="codeline" data-linenumber="6808"><td class="num" id="LN6808">6808</td><td class="line">    printf(<span class='string_literal'>"%s\n"</span>, info);</td></tr>
<tr class="codeline" data-linenumber="6809"><td class="num" id="LN6809">6809</td><td class="line">    <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(info);</td></tr>
<tr class="codeline" data-linenumber="6810"><td class="num" id="LN6810">6810</td><td class="line">    table = clusterManagerComputeReshardTable(sources, slots);</td></tr>
<tr class="codeline" data-linenumber="6811"><td class="num" id="LN6811">6811</td><td class="line">    printf(<span class='string_literal'>"  Resharding plan:\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="6812"><td class="num" id="LN6812">6812</td><td class="line">    clusterManagerShowReshardTable(table);</td></tr>
<tr class="codeline" data-linenumber="6813"><td class="num" id="LN6813">6813</td><td class="line">    <span class='keyword'>if</span> (!(config.cluster_manager_command.flags &amp;</td></tr>
<tr class="codeline" data-linenumber="6814"><td class="num" id="LN6814">6814</td><td class="line">          <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_YES<span class='macro_popup'>1 &lt;&lt; 2</span></span>))</td></tr>
<tr class="codeline" data-linenumber="6815"><td class="num" id="LN6815">6815</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="6816"><td class="num" id="LN6816">6816</td><td class="line">        printf(<span class='string_literal'>"Do you want to proceed with the proposed "</span></td></tr>
<tr class="codeline" data-linenumber="6817"><td class="num" id="LN6817">6817</td><td class="line">               <span class='string_literal'>"reshard plan (yes/no)? "</span>);</td></tr>
<tr class="codeline" data-linenumber="6818"><td class="num" id="LN6818">6818</td><td class="line">        fflush(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>);</td></tr>
<tr class="codeline" data-linenumber="6819"><td class="num" id="LN6819">6819</td><td class="line">        <span class='keyword'>char</span> buf[4];</td></tr>
<tr class="codeline" data-linenumber="6820"><td class="num" id="LN6820">6820</td><td class="line">        <span class='keyword'>int</span> nread = read(fileno(<span class='macro'>stdin<span class='macro_popup'>stdin</span></span>),buf,4);</td></tr>
<tr class="codeline" data-linenumber="6821"><td class="num" id="LN6821">6821</td><td class="line">        buf[3] = '\0';</td></tr>
<tr class="codeline" data-linenumber="6822"><td class="num" id="LN6822">6822</td><td class="line">        <span class='keyword'>if</span> (nread &lt;= 0 || strcmp(<span class='string_literal'>"yes"</span>, buf) != 0) {</td></tr>
<tr class="codeline" data-linenumber="6823"><td class="num" id="LN6823">6823</td><td class="line">            result = 0;</td></tr>
<tr class="codeline" data-linenumber="6824"><td class="num" id="LN6824">6824</td><td class="line">            <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="6825"><td class="num" id="LN6825">6825</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6826"><td class="num" id="LN6826">6826</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6827"><td class="num" id="LN6827">6827</td><td class="line">    <span class='keyword'>int</span> opts = <span class='macro'>CLUSTER_MANAGER_OPT_VERBOSE<span class='macro_popup'>1 &lt;&lt; 7</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6828"><td class="num" id="LN6828">6828</td><td class="line">    listRewind(table, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="6829"><td class="num" id="LN6829">6829</td><td class="line">    <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6830"><td class="num" id="LN6830">6830</td><td class="line">        clusterManagerReshardTableItem *item = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="6831"><td class="num" id="LN6831">6831</td><td class="line">        <span class='keyword'>char</span> *err = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6832"><td class="num" id="LN6832">6832</td><td class="line">        result = clusterManagerMoveSlot(item-&gt;source, target, item-&gt;slot,</td></tr>
<tr class="codeline" data-linenumber="6833"><td class="num" id="LN6833">6833</td><td class="line">                                        opts, &amp;err);</td></tr>
<tr class="codeline" data-linenumber="6834"><td class="num" id="LN6834">6834</td><td class="line">        <span class='keyword'>if</span> (!result) {</td></tr>
<tr class="codeline" data-linenumber="6835"><td class="num" id="LN6835">6835</td><td class="line">            <span class='keyword'>if</span> (err != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6836"><td class="num" id="LN6836">6836</td><td class="line">                <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"clusterManagerMoveSlot failed: %s\n"</span>, err)<span class='macro_popup'>clusterManagerLog(3,"clusterManagerMoveSlot failed: %s\n", err<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6837"><td class="num" id="LN6837">6837</td><td class="line">                zfree(err);</td></tr>
<tr class="codeline" data-linenumber="6838"><td class="num" id="LN6838">6838</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="6839"><td class="num" id="LN6839">6839</td><td class="line">            <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="6840"><td class="num" id="LN6840">6840</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6841"><td class="num" id="LN6841">6841</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6842"><td class="num" id="LN6842">6842</td><td class="line">cleanup:</td></tr>
<tr class="codeline" data-linenumber="6843"><td class="num" id="LN6843">6843</td><td class="line">    listRelease(sources);</td></tr>
<tr class="codeline" data-linenumber="6844"><td class="num" id="LN6844">6844</td><td class="line">    clusterManagerReleaseReshardTable(table);</td></tr>
<tr class="codeline" data-linenumber="6845"><td class="num" id="LN6845">6845</td><td class="line">    <span class='keyword'>return</span> result;</td></tr>
<tr class="codeline" data-linenumber="6846"><td class="num" id="LN6846">6846</td><td class="line">invalid_args:</td></tr>
<tr class="codeline" data-linenumber="6847"><td class="num" id="LN6847">6847</td><td class="line">    fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='macro'>CLUSTER_MANAGER_INVALID_HOST_ARG<span class='macro_popup'>"[ERR] Invalid arguments: you need to pass either a valid " "address (ie. 120.0.0.1:7000) or space separated IP "<br> "and port (ie. 120.0.0.1 7000)\n"</span></span>);</td></tr>
<tr class="codeline" data-linenumber="6848"><td class="num" id="LN6848">6848</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="6849"><td class="num" id="LN6849">6849</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="6850"><td class="num" id="LN6850">6850</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6851"><td class="num" id="LN6851">6851</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerCommandRebalance(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv) {</td></tr>
<tr class="codeline" data-linenumber="6852"><td class="num" id="LN6852">6852</td><td class="line">    <span class='keyword'>int</span> port = 0;</td></tr>
<tr class="codeline" data-linenumber="6853"><td class="num" id="LN6853">6853</td><td class="line">    <span class='keyword'>char</span> *ip = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6854"><td class="num" id="LN6854">6854</td><td class="line">    clusterManagerNode **weightedNodes = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6855"><td class="num" id="LN6855">6855</td><td class="line">    list *involved = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6856"><td class="num" id="LN6856">6856</td><td class="line">    <span class='keyword'>if</span> (!getClusterHostFromCmdArgs(argc, argv, &amp;ip, &amp;port)) <span class='keyword'>goto</span> invalid_args;</td></tr>
<tr class="codeline" data-linenumber="6857"><td class="num" id="LN6857">6857</td><td class="line">    clusterManagerNode *node = clusterManagerNewNode(ip, port, 0);</td></tr>
<tr class="codeline" data-linenumber="6858"><td class="num" id="LN6858">6858</td><td class="line">    <span class='keyword'>if</span> (!clusterManagerLoadInfoFromNode(node)) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="6859"><td class="num" id="LN6859">6859</td><td class="line">    <span class='keyword'>int</span> result = 1, i;</td></tr>
<tr class="codeline" data-linenumber="6860"><td class="num" id="LN6860">6860</td><td class="line">    <span class='keyword'>if</span> (config.cluster_manager_command.weight != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6861"><td class="num" id="LN6861">6861</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; config.cluster_manager_command.weight_argc; i++) {</td></tr>
<tr class="codeline" data-linenumber="6862"><td class="num" id="LN6862">6862</td><td class="line">            <span class='keyword'>char</span> *name = config.cluster_manager_command.weight[i];</td></tr>
<tr class="codeline" data-linenumber="6863"><td class="num" id="LN6863">6863</td><td class="line">            <span class='keyword'>char</span> *p = strchr(name, '=');</td></tr>
<tr class="codeline" data-linenumber="6864"><td class="num" id="LN6864">6864</td><td class="line">            <span class='keyword'>if</span> (p == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6865"><td class="num" id="LN6865">6865</td><td class="line">                <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"*** invalid input %s\n"</span>, name)<span class='macro_popup'>clusterManagerLog(3,"*** invalid input %s\n", name)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6866"><td class="num" id="LN6866">6866</td><td class="line">                result = 0;</td></tr>
<tr class="codeline" data-linenumber="6867"><td class="num" id="LN6867">6867</td><td class="line">                <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="6868"><td class="num" id="LN6868">6868</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="6869"><td class="num" id="LN6869">6869</td><td class="line">            *p = '\0';</td></tr>
<tr class="codeline" data-linenumber="6870"><td class="num" id="LN6870">6870</td><td class="line">            <span class='keyword'>float</span> w = atof(++p);</td></tr>
<tr class="codeline" data-linenumber="6871"><td class="num" id="LN6871">6871</td><td class="line">            clusterManagerNode *n = clusterManagerNodeByAbbreviatedName(name);</td></tr>
<tr class="codeline" data-linenumber="6872"><td class="num" id="LN6872">6872</td><td class="line">            <span class='keyword'>if</span> (n == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6873"><td class="num" id="LN6873">6873</td><td class="line">                <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"*** No such master node %s\n"</span>, name)<span class='macro_popup'>clusterManagerLog(3,"*** No such master node %s\n", name)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6874"><td class="num" id="LN6874">6874</td><td class="line">                result = 0;</td></tr>
<tr class="codeline" data-linenumber="6875"><td class="num" id="LN6875">6875</td><td class="line">                <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="6876"><td class="num" id="LN6876">6876</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="6877"><td class="num" id="LN6877">6877</td><td class="line">            n-&gt;weight = w;</td></tr>
<tr class="codeline" data-linenumber="6878"><td class="num" id="LN6878">6878</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6879"><td class="num" id="LN6879">6879</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6880"><td class="num" id="LN6880">6880</td><td class="line">    <span class='keyword'>float</span> total_weight = 0;</td></tr>
<tr class="codeline" data-linenumber="6881"><td class="num" id="LN6881">6881</td><td class="line">    <span class='keyword'>int</span> nodes_involved = 0;</td></tr>
<tr class="codeline" data-linenumber="6882"><td class="num" id="LN6882">6882</td><td class="line">    <span class='keyword'>int</span> use_empty = config.cluster_manager_command.flags &amp;</td></tr>
<tr class="codeline" data-linenumber="6883"><td class="num" id="LN6883">6883</td><td class="line">                    <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_EMPTYMASTER<span class='macro_popup'>1 &lt;&lt; 4</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6884"><td class="num" id="LN6884">6884</td><td class="line">    involved = listCreate();</td></tr>
<tr class="codeline" data-linenumber="6885"><td class="num" id="LN6885">6885</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="6886"><td class="num" id="LN6886">6886</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="6887"><td class="num" id="LN6887">6887</td><td class="line">    listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="6888"><td class="num" id="LN6888">6888</td><td class="line">    <span class='comment'>/* Compute the total cluster weight. */</span></td></tr>
<tr class="codeline" data-linenumber="6889"><td class="num" id="LN6889">6889</td><td class="line">    <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6890"><td class="num" id="LN6890">6890</td><td class="line">        clusterManagerNode *n = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="6891"><td class="num" id="LN6891">6891</td><td class="line">        <span class='keyword'>if</span> (n-&gt;flags &amp; <span class='macro'>CLUSTER_MANAGER_FLAG_SLAVE<span class='macro_popup'>1 &lt;&lt; 1</span></span> || n-&gt;replicate)</td></tr>
<tr class="codeline" data-linenumber="6892"><td class="num" id="LN6892">6892</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="6893"><td class="num" id="LN6893">6893</td><td class="line">        <span class='keyword'>if</span> (!use_empty &amp;&amp; n-&gt;slots_count == 0) {</td></tr>
<tr class="codeline" data-linenumber="6894"><td class="num" id="LN6894">6894</td><td class="line">            n-&gt;weight = 0;</td></tr>
<tr class="codeline" data-linenumber="6895"><td class="num" id="LN6895">6895</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="6896"><td class="num" id="LN6896">6896</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6897"><td class="num" id="LN6897">6897</td><td class="line">        total_weight += n-&gt;weight;</td></tr>
<tr class="codeline" data-linenumber="6898"><td class="num" id="LN6898">6898</td><td class="line">        nodes_involved++;</td></tr>
<tr class="codeline" data-linenumber="6899"><td class="num" id="LN6899">6899</td><td class="line">        listAddNodeTail(involved, n);</td></tr>
<tr class="codeline" data-linenumber="6900"><td class="num" id="LN6900">6900</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6901"><td class="num" id="LN6901">6901</td><td class="line">    weightedNodes = zmalloc(nodes_involved * <span class='keyword'>sizeof</span>(clusterManagerNode *));</td></tr>
<tr class="codeline" data-linenumber="6902"><td class="num" id="LN6902">6902</td><td class="line">    <span class='keyword'>if</span> (weightedNodes == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="6903"><td class="num" id="LN6903">6903</td><td class="line">    <span class='comment'>/* Check cluster, only proceed if it looks sane. */</span></td></tr>
<tr class="codeline" data-linenumber="6904"><td class="num" id="LN6904">6904</td><td class="line">    clusterManagerCheckCluster(1);</td></tr>
<tr class="codeline" data-linenumber="6905"><td class="num" id="LN6905">6905</td><td class="line">    <span class='keyword'>if</span> (cluster_manager.errors &amp;&amp; <span class='macro'>listLength(cluster_manager.errors)<span class='macro_popup'>((cluster_manager.errors)-&gt;len)</span></span> &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="6906"><td class="num" id="LN6906">6906</td><td class="line">        <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"*** Please fix your cluster problems "<span class='macro_popup'>clusterManagerLog(3,"*** Please fix your cluster problems " "before rebalancing\n"<br>)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="6907"><td class="num" id="LN6907">6907</td><td class="line">                             <span class='string_literal'><span class='macro'>"before rebalancing\n"</span>)<span class='macro_popup'>clusterManagerLog(3,"*** Please fix your cluster problems " "before rebalancing\n"<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6908"><td class="num" id="LN6908">6908</td><td class="line">        result = 0;</td></tr>
<tr class="codeline" data-linenumber="6909"><td class="num" id="LN6909">6909</td><td class="line">        <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="6910"><td class="num" id="LN6910">6910</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6911"><td class="num" id="LN6911">6911</td><td class="line">    <span class='comment'>/* Calculate the slots balance for each node. It's the number of</span></td></tr>
<tr class="codeline" data-linenumber="6912"><td class="num" id="LN6912">6912</td><td class="line">     <span class='comment'>* slots the node should lose (if positive) or gain (if negative)</span></td></tr>
<tr class="codeline" data-linenumber="6913"><td class="num" id="LN6913">6913</td><td class="line">     <span class='comment'>* in order to be balanced. */</span></td></tr>
<tr class="codeline" data-linenumber="6914"><td class="num" id="LN6914">6914</td><td class="line">    <span class='keyword'>int</span> threshold_reached = 0, total_balance = 0;</td></tr>
<tr class="codeline" data-linenumber="6915"><td class="num" id="LN6915">6915</td><td class="line">    <span class='keyword'>float</span> threshold = config.cluster_manager_command.threshold;</td></tr>
<tr class="codeline" data-linenumber="6916"><td class="num" id="LN6916">6916</td><td class="line">    i = 0;</td></tr>
<tr class="codeline" data-linenumber="6917"><td class="num" id="LN6917">6917</td><td class="line">    listRewind(involved, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="6918"><td class="num" id="LN6918">6918</td><td class="line">    <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6919"><td class="num" id="LN6919">6919</td><td class="line">        clusterManagerNode *n = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="6920"><td class="num" id="LN6920">6920</td><td class="line">        weightedNodes[i++] = n;</td></tr>
<tr class="codeline" data-linenumber="6921"><td class="num" id="LN6921">6921</td><td class="line">        <span class='keyword'>int</span> expected = (<span class='keyword'>int</span>) (((<span class='keyword'>float</span>)<span class='macro'>CLUSTER_MANAGER_SLOTS<span class='macro_popup'>16384</span></span> / total_weight) *</td></tr>
<tr class="codeline" data-linenumber="6922"><td class="num" id="LN6922">6922</td><td class="line">                        n-&gt;weight);</td></tr>
<tr class="codeline" data-linenumber="6923"><td class="num" id="LN6923">6923</td><td class="line">        n-&gt;balance = n-&gt;slots_count - expected;</td></tr>
<tr class="codeline" data-linenumber="6924"><td class="num" id="LN6924">6924</td><td class="line">        total_balance += n-&gt;balance;</td></tr>
<tr class="codeline" data-linenumber="6925"><td class="num" id="LN6925">6925</td><td class="line">        <span class='comment'>/* Compute the percentage of difference between the</span></td></tr>
<tr class="codeline" data-linenumber="6926"><td class="num" id="LN6926">6926</td><td class="line">         <span class='comment'>* expected number of slots and the real one, to see</span></td></tr>
<tr class="codeline" data-linenumber="6927"><td class="num" id="LN6927">6927</td><td class="line">         <span class='comment'>* if it's over the threshold specified by the user. */</span></td></tr>
<tr class="codeline" data-linenumber="6928"><td class="num" id="LN6928">6928</td><td class="line">        <span class='keyword'>int</span> over_threshold = 0;</td></tr>
<tr class="codeline" data-linenumber="6929"><td class="num" id="LN6929">6929</td><td class="line">        <span class='keyword'>if</span> (threshold &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="6930"><td class="num" id="LN6930">6930</td><td class="line">            <span class='keyword'>if</span> (n-&gt;slots_count &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="6931"><td class="num" id="LN6931">6931</td><td class="line">                <span class='keyword'>float</span> err_perc = fabs((100-(100.0*expected/n-&gt;slots_count)));</td></tr>
<tr class="codeline" data-linenumber="6932"><td class="num" id="LN6932">6932</td><td class="line">                <span class='keyword'>if</span> (err_perc &gt; threshold) over_threshold = 1;</td></tr>
<tr class="codeline" data-linenumber="6933"><td class="num" id="LN6933">6933</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (expected &gt; 1) {</td></tr>
<tr class="codeline" data-linenumber="6934"><td class="num" id="LN6934">6934</td><td class="line">                over_threshold = 1;</td></tr>
<tr class="codeline" data-linenumber="6935"><td class="num" id="LN6935">6935</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="6936"><td class="num" id="LN6936">6936</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6937"><td class="num" id="LN6937">6937</td><td class="line">        <span class='keyword'>if</span> (over_threshold) threshold_reached = 1;</td></tr>
<tr class="codeline" data-linenumber="6938"><td class="num" id="LN6938">6938</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6939"><td class="num" id="LN6939">6939</td><td class="line">    <span class='keyword'>if</span> (!threshold_reached) {</td></tr>
<tr class="codeline" data-linenumber="6940"><td class="num" id="LN6940">6940</td><td class="line">        <span class='macro'>clusterManagerLogWarn(<span class='string_literal'>"*** No rebalancing needed! "<span class='macro_popup'>clusterManagerLog(2,"*** No rebalancing needed! " "All nodes are within the %.2f%% threshold.\n"<br>, config.cluster_manager_command.threshold)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="6941"><td class="num" id="LN6941">6941</td><td class="line">                             <span class='string_literal'><span class='macro'>"All nodes are within the %.2f%% threshold.\n"</span>,<span class='macro_popup'>clusterManagerLog(2,"*** No rebalancing needed! " "All nodes are within the %.2f%% threshold.\n"<br>, config.cluster_manager_command.threshold)</span></span></td></tr>
<tr class="codeline" data-linenumber="6942"><td class="num" id="LN6942">6942</td><td class="line">                             <span class='macro'>config.cluster_manager_command.threshold)<span class='macro_popup'>clusterManagerLog(2,"*** No rebalancing needed! " "All nodes are within the %.2f%% threshold.\n"<br>, config.cluster_manager_command.threshold)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6943"><td class="num" id="LN6943">6943</td><td class="line">        <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="6944"><td class="num" id="LN6944">6944</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6945"><td class="num" id="LN6945">6945</td><td class="line">    <span class='comment'>/* Because of rounding, it is possible that the balance of all nodes</span></td></tr>
<tr class="codeline" data-linenumber="6946"><td class="num" id="LN6946">6946</td><td class="line">     <span class='comment'>* summed does not give 0. Make sure that nodes that have to provide</span></td></tr>
<tr class="codeline" data-linenumber="6947"><td class="num" id="LN6947">6947</td><td class="line">     <span class='comment'>* slots are always matched by nodes receiving slots. */</span></td></tr>
<tr class="codeline" data-linenumber="6948"><td class="num" id="LN6948">6948</td><td class="line">    <span class='keyword'>while</span> (total_balance &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="6949"><td class="num" id="LN6949">6949</td><td class="line">        listRewind(involved, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="6950"><td class="num" id="LN6950">6950</td><td class="line">        <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="6951"><td class="num" id="LN6951">6951</td><td class="line">            clusterManagerNode *n = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="6952"><td class="num" id="LN6952">6952</td><td class="line">            <span class='keyword'>if</span> (n-&gt;balance &lt;= 0 &amp;&amp; total_balance &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="6953"><td class="num" id="LN6953">6953</td><td class="line">                n-&gt;balance--;</td></tr>
<tr class="codeline" data-linenumber="6954"><td class="num" id="LN6954">6954</td><td class="line">                total_balance--;</td></tr>
<tr class="codeline" data-linenumber="6955"><td class="num" id="LN6955">6955</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="6956"><td class="num" id="LN6956">6956</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6957"><td class="num" id="LN6957">6957</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6958"><td class="num" id="LN6958">6958</td><td class="line">    <span class='comment'>/* Sort nodes by their slots balance. */</span></td></tr>
<tr class="codeline" data-linenumber="6959"><td class="num" id="LN6959">6959</td><td class="line">    qsort(weightedNodes, nodes_involved, <span class='keyword'>sizeof</span>(clusterManagerNode *),</td></tr>
<tr class="codeline" data-linenumber="6960"><td class="num" id="LN6960">6960</td><td class="line">          clusterManagerCompareNodeBalance);</td></tr>
<tr class="codeline" data-linenumber="6961"><td class="num" id="LN6961">6961</td><td class="line">    <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Rebalancing across %d nodes. "<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Rebalancing across %d nodes. "<br> "Total weight = %.2f\n", nodes_involved, total_weight)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="6962"><td class="num" id="LN6962">6962</td><td class="line">                          <span class='string_literal'><span class='macro'>"Total weight = %.2f\n"</span>,<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Rebalancing across %d nodes. "<br> "Total weight = %.2f\n", nodes_involved, total_weight)</span></span></td></tr>
<tr class="codeline" data-linenumber="6963"><td class="num" id="LN6963">6963</td><td class="line">                          <span class='macro'>nodes_involved, total_weight)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Rebalancing across %d nodes. "<br> "Total weight = %.2f\n", nodes_involved, total_weight)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6964"><td class="num" id="LN6964">6964</td><td class="line">    <span class='keyword'>if</span> (config.verbose) {</td></tr>
<tr class="codeline" data-linenumber="6965"><td class="num" id="LN6965">6965</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; nodes_involved; i++) {</td></tr>
<tr class="codeline" data-linenumber="6966"><td class="num" id="LN6966">6966</td><td class="line">            clusterManagerNode *n = weightedNodes[i];</td></tr>
<tr class="codeline" data-linenumber="6967"><td class="num" id="LN6967">6967</td><td class="line">            printf(<span class='string_literal'>"%s:%d balance is %d slots\n"</span>, n-&gt;ip, n-&gt;port, n-&gt;balance);</td></tr>
<tr class="codeline" data-linenumber="6968"><td class="num" id="LN6968">6968</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="6969"><td class="num" id="LN6969">6969</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="6970"><td class="num" id="LN6970">6970</td><td class="line">    <span class='comment'>/* Now we have at the start of the 'sn' array nodes that should get</span></td></tr>
<tr class="codeline" data-linenumber="6971"><td class="num" id="LN6971">6971</td><td class="line">     <span class='comment'>* slots, at the end nodes that must give slots.</span></td></tr>
<tr class="codeline" data-linenumber="6972"><td class="num" id="LN6972">6972</td><td class="line">     <span class='comment'>* We take two indexes, one at the start, and one at the end,</span></td></tr>
<tr class="codeline" data-linenumber="6973"><td class="num" id="LN6973">6973</td><td class="line">     <span class='comment'>* incrementing or decrementing the indexes accordingly til we</span></td></tr>
<tr class="codeline" data-linenumber="6974"><td class="num" id="LN6974">6974</td><td class="line">     <span class='comment'>* find nodes that need to get/provide slots. */</span></td></tr>
<tr class="codeline" data-linenumber="6975"><td class="num" id="LN6975">6975</td><td class="line">    <span class='keyword'>int</span> dst_idx = 0;</td></tr>
<tr class="codeline" data-linenumber="6976"><td class="num" id="LN6976">6976</td><td class="line">    <span class='keyword'>int</span> src_idx = nodes_involved - 1;</td></tr>
<tr class="codeline" data-linenumber="6977"><td class="num" id="LN6977">6977</td><td class="line">    <span class='keyword'>int</span> simulate = config.cluster_manager_command.flags &amp;</td></tr>
<tr class="codeline" data-linenumber="6978"><td class="num" id="LN6978">6978</td><td class="line">                   <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_SIMULATE<span class='macro_popup'>1 &lt;&lt; 5</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6979"><td class="num" id="LN6979">6979</td><td class="line">    <span class='keyword'>while</span> (dst_idx &lt; src_idx) {</td></tr>
<tr class="codeline" data-linenumber="6980"><td class="num" id="LN6980">6980</td><td class="line">        clusterManagerNode *dst = weightedNodes[dst_idx];</td></tr>
<tr class="codeline" data-linenumber="6981"><td class="num" id="LN6981">6981</td><td class="line">        clusterManagerNode *src = weightedNodes[src_idx];</td></tr>
<tr class="codeline" data-linenumber="6982"><td class="num" id="LN6982">6982</td><td class="line">        <span class='keyword'>int</span> db = abs(dst-&gt;balance);</td></tr>
<tr class="codeline" data-linenumber="6983"><td class="num" id="LN6983">6983</td><td class="line">        <span class='keyword'>int</span> sb = abs(src-&gt;balance);</td></tr>
<tr class="codeline" data-linenumber="6984"><td class="num" id="LN6984">6984</td><td class="line">        <span class='keyword'>int</span> numslots = (db &lt; sb ? db : sb);</td></tr>
<tr class="codeline" data-linenumber="6985"><td class="num" id="LN6985">6985</td><td class="line">        <span class='keyword'>if</span> (numslots &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="6986"><td class="num" id="LN6986">6986</td><td class="line">            printf(<span class='string_literal'>"Moving %d slots from %s:%d to %s:%d\n"</span>, numslots,</td></tr>
<tr class="codeline" data-linenumber="6987"><td class="num" id="LN6987">6987</td><td class="line">                                                            src-&gt;ip,</td></tr>
<tr class="codeline" data-linenumber="6988"><td class="num" id="LN6988">6988</td><td class="line">                                                            src-&gt;port,</td></tr>
<tr class="codeline" data-linenumber="6989"><td class="num" id="LN6989">6989</td><td class="line">                                                            dst-&gt;ip,</td></tr>
<tr class="codeline" data-linenumber="6990"><td class="num" id="LN6990">6990</td><td class="line">                                                            dst-&gt;port);</td></tr>
<tr class="codeline" data-linenumber="6991"><td class="num" id="LN6991">6991</td><td class="line">            <span class='comment'>/* Actually move the slots. */</span></td></tr>
<tr class="codeline" data-linenumber="6992"><td class="num" id="LN6992">6992</td><td class="line">            list *lsrc = listCreate(), *table = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6993"><td class="num" id="LN6993">6993</td><td class="line">            listAddNodeTail(lsrc, src);</td></tr>
<tr class="codeline" data-linenumber="6994"><td class="num" id="LN6994">6994</td><td class="line">            table = clusterManagerComputeReshardTable(lsrc, numslots);</td></tr>
<tr class="codeline" data-linenumber="6995"><td class="num" id="LN6995">6995</td><td class="line">            listRelease(lsrc);</td></tr>
<tr class="codeline" data-linenumber="6996"><td class="num" id="LN6996">6996</td><td class="line">            <span class='keyword'>int</span> table_len = (<span class='keyword'>int</span>) <span class='macro'>listLength(table)<span class='macro_popup'>((table)-&gt;len)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="6997"><td class="num" id="LN6997">6997</td><td class="line">            <span class='keyword'>if</span> (!table || table_len != numslots) {</td></tr>
<tr class="codeline" data-linenumber="6998"><td class="num" id="LN6998">6998</td><td class="line">                <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"*** Assertion failed: Reshard table "<span class='macro_popup'>clusterManagerLog(3,"*** Assertion failed: Reshard table " "!= number of slots"<br>)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="6999"><td class="num" id="LN6999">6999</td><td class="line">                                     <span class='string_literal'><span class='macro'>"!= number of slots"</span>)<span class='macro_popup'>clusterManagerLog(3,"*** Assertion failed: Reshard table " "!= number of slots"<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7000"><td class="num" id="LN7000">7000</td><td class="line">                result = 0;</td></tr>
<tr class="codeline" data-linenumber="7001"><td class="num" id="LN7001">7001</td><td class="line">                <span class='keyword'>goto</span> end_move;</td></tr>
<tr class="codeline" data-linenumber="7002"><td class="num" id="LN7002">7002</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="7003"><td class="num" id="LN7003">7003</td><td class="line">            <span class='keyword'>if</span> (simulate) {</td></tr>
<tr class="codeline" data-linenumber="7004"><td class="num" id="LN7004">7004</td><td class="line">                <span class='keyword'>for</span> (i = 0; i &lt; table_len; i++) printf(<span class='string_literal'>"#"</span>);</td></tr>
<tr class="codeline" data-linenumber="7005"><td class="num" id="LN7005">7005</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="7006"><td class="num" id="LN7006">7006</td><td class="line">                <span class='keyword'>int</span> opts = <span class='macro'>CLUSTER_MANAGER_OPT_QUIET<span class='macro_popup'>1 &lt;&lt; 6</span></span> |</td></tr>
<tr class="codeline" data-linenumber="7007"><td class="num" id="LN7007">7007</td><td class="line">                           <span class='macro'>CLUSTER_MANAGER_OPT_UPDATE<span class='macro_popup'>1 &lt;&lt; 2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7008"><td class="num" id="LN7008">7008</td><td class="line">                listRewind(table, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="7009"><td class="num" id="LN7009">7009</td><td class="line">                <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="7010"><td class="num" id="LN7010">7010</td><td class="line">                    clusterManagerReshardTableItem *item = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="7011"><td class="num" id="LN7011">7011</td><td class="line">                    <span class='keyword'>char</span> *err;</td></tr>
<tr class="codeline" data-linenumber="7012"><td class="num" id="LN7012">7012</td><td class="line">                    result = clusterManagerMoveSlot(item-&gt;source,</td></tr>
<tr class="codeline" data-linenumber="7013"><td class="num" id="LN7013">7013</td><td class="line">                                                    dst,</td></tr>
<tr class="codeline" data-linenumber="7014"><td class="num" id="LN7014">7014</td><td class="line">                                                    item-&gt;slot,</td></tr>
<tr class="codeline" data-linenumber="7015"><td class="num" id="LN7015">7015</td><td class="line">                                                    opts, &amp;err);</td></tr>
<tr class="codeline" data-linenumber="7016"><td class="num" id="LN7016">7016</td><td class="line">                    <span class='keyword'>if</span> (!result) {</td></tr>
<tr class="codeline" data-linenumber="7017"><td class="num" id="LN7017">7017</td><td class="line">                        <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"*** clusterManagerMoveSlot: %s\n"</span>, err)<span class='macro_popup'>clusterManagerLog(3,"*** clusterManagerMoveSlot: %s\n", err)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7018"><td class="num" id="LN7018">7018</td><td class="line">                        zfree(err);</td></tr>
<tr class="codeline" data-linenumber="7019"><td class="num" id="LN7019">7019</td><td class="line">                        <span class='keyword'>goto</span> end_move;</td></tr>
<tr class="codeline" data-linenumber="7020"><td class="num" id="LN7020">7020</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="7021"><td class="num" id="LN7021">7021</td><td class="line">                    printf(<span class='string_literal'>"#"</span>);</td></tr>
<tr class="codeline" data-linenumber="7022"><td class="num" id="LN7022">7022</td><td class="line">                    fflush(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>);</td></tr>
<tr class="codeline" data-linenumber="7023"><td class="num" id="LN7023">7023</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="7024"><td class="num" id="LN7024">7024</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7025"><td class="num" id="LN7025">7025</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="7026"><td class="num" id="LN7026">7026</td><td class="line">            printf(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="7027"><td class="num" id="LN7027">7027</td><td class="line">end_move:</td></tr>
<tr class="codeline" data-linenumber="7028"><td class="num" id="LN7028">7028</td><td class="line">            clusterManagerReleaseReshardTable(table);</td></tr>
<tr class="codeline" data-linenumber="7029"><td class="num" id="LN7029">7029</td><td class="line">            <span class='keyword'>if</span> (!result) <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="7030"><td class="num" id="LN7030">7030</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="7031"><td class="num" id="LN7031">7031</td><td class="line">        <span class='comment'>/* Update nodes balance. */</span></td></tr>
<tr class="codeline" data-linenumber="7032"><td class="num" id="LN7032">7032</td><td class="line">        dst-&gt;balance += numslots;</td></tr>
<tr class="codeline" data-linenumber="7033"><td class="num" id="LN7033">7033</td><td class="line">        src-&gt;balance -= numslots;</td></tr>
<tr class="codeline" data-linenumber="7034"><td class="num" id="LN7034">7034</td><td class="line">        <span class='keyword'>if</span> (dst-&gt;balance == 0) dst_idx++;</td></tr>
<tr class="codeline" data-linenumber="7035"><td class="num" id="LN7035">7035</td><td class="line">        <span class='keyword'>if</span> (src-&gt;balance == 0) src_idx --;</td></tr>
<tr class="codeline" data-linenumber="7036"><td class="num" id="LN7036">7036</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7037"><td class="num" id="LN7037">7037</td><td class="line">cleanup:</td></tr>
<tr class="codeline" data-linenumber="7038"><td class="num" id="LN7038">7038</td><td class="line">    <span class='keyword'>if</span> (involved != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) listRelease(involved);</td></tr>
<tr class="codeline" data-linenumber="7039"><td class="num" id="LN7039">7039</td><td class="line">    <span class='keyword'>if</span> (weightedNodes != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) zfree(weightedNodes);</td></tr>
<tr class="codeline" data-linenumber="7040"><td class="num" id="LN7040">7040</td><td class="line">    <span class='keyword'>return</span> result;</td></tr>
<tr class="codeline" data-linenumber="7041"><td class="num" id="LN7041">7041</td><td class="line">invalid_args:</td></tr>
<tr class="codeline" data-linenumber="7042"><td class="num" id="LN7042">7042</td><td class="line">    fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='macro'>CLUSTER_MANAGER_INVALID_HOST_ARG<span class='macro_popup'>"[ERR] Invalid arguments: you need to pass either a valid " "address (ie. 120.0.0.1:7000) or space separated IP "<br> "and port (ie. 120.0.0.1 7000)\n"</span></span>);</td></tr>
<tr class="codeline" data-linenumber="7043"><td class="num" id="LN7043">7043</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="7044"><td class="num" id="LN7044">7044</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="7045"><td class="num" id="LN7045">7045</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7046"><td class="num" id="LN7046">7046</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerCommandSetTimeout(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv) {</td></tr>
<tr class="codeline" data-linenumber="7047"><td class="num" id="LN7047">7047</td><td class="line">    <span class='macro'>UNUSED(argc)<span class='macro_popup'>((void) argc)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7048"><td class="num" id="LN7048">7048</td><td class="line">    <span class='keyword'>int</span> port = 0;</td></tr>
<tr class="codeline" data-linenumber="7049"><td class="num" id="LN7049">7049</td><td class="line">    <span class='keyword'>char</span> *ip = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7050"><td class="num" id="LN7050">7050</td><td class="line">    <span class='keyword'>if</span> (!getClusterHostFromCmdArgs(1, argv, &amp;ip, &amp;port)) <span class='keyword'>goto</span> invalid_args;</td></tr>
<tr class="codeline" data-linenumber="7051"><td class="num" id="LN7051">7051</td><td class="line">    <span class='keyword'>int</span> timeout = atoi(argv[1]);</td></tr>
<tr class="codeline" data-linenumber="7052"><td class="num" id="LN7052">7052</td><td class="line">    <span class='keyword'>if</span> (timeout &lt; 100) {</td></tr>
<tr class="codeline" data-linenumber="7053"><td class="num" id="LN7053">7053</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Setting a node timeout of less than 100 "</span></td></tr>
<tr class="codeline" data-linenumber="7054"><td class="num" id="LN7054">7054</td><td class="line">                <span class='string_literal'>"milliseconds is a bad idea.\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="7055"><td class="num" id="LN7055">7055</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="7056"><td class="num" id="LN7056">7056</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7057"><td class="num" id="LN7057">7057</td><td class="line">    <span class='comment'>// Load cluster information</span></td></tr>
<tr class="codeline" data-linenumber="7058"><td class="num" id="LN7058">7058</td><td class="line">    clusterManagerNode *node = clusterManagerNewNode(ip, port, 0);</td></tr>
<tr class="codeline" data-linenumber="7059"><td class="num" id="LN7059">7059</td><td class="line">    <span class='keyword'>if</span> (!clusterManagerLoadInfoFromNode(node)) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="7060"><td class="num" id="LN7060">7060</td><td class="line">    <span class='keyword'>int</span> ok_count = 0, err_count = 0;</td></tr>
<tr class="codeline" data-linenumber="7061"><td class="num" id="LN7061">7061</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7062"><td class="num" id="LN7062">7062</td><td class="line">    <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Reconfiguring node timeout in every "<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Reconfiguring node timeout in every "<br> "cluster node...\n")</span></span></span></td></tr>
<tr class="codeline" data-linenumber="7063"><td class="num" id="LN7063">7063</td><td class="line">                          <span class='string_literal'><span class='macro'>"cluster node...\n"</span>)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Reconfiguring node timeout in every "<br> "cluster node...\n")</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7064"><td class="num" id="LN7064">7064</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="7065"><td class="num" id="LN7065">7065</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="7066"><td class="num" id="LN7066">7066</td><td class="line">    listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="7067"><td class="num" id="LN7067">7067</td><td class="line">    <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="7068"><td class="num" id="LN7068">7068</td><td class="line">        clusterManagerNode *n = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="7069"><td class="num" id="LN7069">7069</td><td class="line">        <span class='keyword'>char</span> *err = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7070"><td class="num" id="LN7070">7070</td><td class="line">        redisReply *reply = <span class='macro'>CLUSTER_MANAGER_COMMAND(n, <span class='string_literal'>"CONFIG %s %s %d"</span>,<span class='macro_popup'>(redisCommand(n-&gt;context, "CONFIG %s %s %d", "SET", "cluster-node-timeout"<br>, timeout))</span></span></td></tr>
<tr class="codeline" data-linenumber="7071"><td class="num" id="LN7071">7071</td><td class="line">                                                    <span class='string_literal'><span class='macro'>"SET"</span>,<span class='macro_popup'>(redisCommand(n-&gt;context, "CONFIG %s %s %d", "SET", "cluster-node-timeout"<br>, timeout))</span></span></td></tr>
<tr class="codeline" data-linenumber="7072"><td class="num" id="LN7072">7072</td><td class="line">                                                    <span class='string_literal'><span class='macro'>"cluster-node-timeout"</span>,<span class='macro_popup'>(redisCommand(n-&gt;context, "CONFIG %s %s %d", "SET", "cluster-node-timeout"<br>, timeout))</span></span></td></tr>
<tr class="codeline" data-linenumber="7073"><td class="num" id="LN7073">7073</td><td class="line">                                                    <span class='macro'>timeout)<span class='macro_popup'>(redisCommand(n-&gt;context, "CONFIG %s %s %d", "SET", "cluster-node-timeout"<br>, timeout))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7074"><td class="num" id="LN7074">7074</td><td class="line">        <span class='keyword'>if</span> (reply == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>goto</span> reply_err;</td></tr>
<tr class="codeline" data-linenumber="7075"><td class="num" id="LN7075">7075</td><td class="line">        <span class='keyword'>int</span> ok = clusterManagerCheckRedisReply(n, reply, &amp;err);</td></tr>
<tr class="codeline" data-linenumber="7076"><td class="num" id="LN7076">7076</td><td class="line">        freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="7077"><td class="num" id="LN7077">7077</td><td class="line">        <span class='keyword'>if</span> (!ok) <span class='keyword'>goto</span> reply_err;</td></tr>
<tr class="codeline" data-linenumber="7078"><td class="num" id="LN7078">7078</td><td class="line">        reply = <span class='macro'>CLUSTER_MANAGER_COMMAND(n, <span class='string_literal'>"CONFIG %s"</span>, <span class='string_literal'>"REWRITE"</span>)<span class='macro_popup'>(redisCommand(n-&gt;context, "CONFIG %s", "REWRITE"))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7079"><td class="num" id="LN7079">7079</td><td class="line">        <span class='keyword'>if</span> (reply == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>goto</span> reply_err;</td></tr>
<tr class="codeline" data-linenumber="7080"><td class="num" id="LN7080">7080</td><td class="line">        ok = clusterManagerCheckRedisReply(n, reply, &amp;err);</td></tr>
<tr class="codeline" data-linenumber="7081"><td class="num" id="LN7081">7081</td><td class="line">        freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="7082"><td class="num" id="LN7082">7082</td><td class="line">        <span class='keyword'>if</span> (!ok) <span class='keyword'>goto</span> reply_err;</td></tr>
<tr class="codeline" data-linenumber="7083"><td class="num" id="LN7083">7083</td><td class="line">        <span class='macro'>clusterManagerLogWarn(<span class='string_literal'>"*** New timeout set for %s:%d\n"</span>, n-&gt;ip,<span class='macro_popup'>clusterManagerLog(2,"*** New timeout set for %s:%d\n", n-&gt;<br>ip, n-&gt;port)</span></span></td></tr>
<tr class="codeline" data-linenumber="7084"><td class="num" id="LN7084">7084</td><td class="line">                              <span class='macro'>n-&gt;port)<span class='macro_popup'>clusterManagerLog(2,"*** New timeout set for %s:%d\n", n-&gt;<br>ip, n-&gt;port)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7085"><td class="num" id="LN7085">7085</td><td class="line">        ok_count++;</td></tr>
<tr class="codeline" data-linenumber="7086"><td class="num" id="LN7086">7086</td><td class="line">        <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="7087"><td class="num" id="LN7087">7087</td><td class="line">reply_err:;</td></tr>
<tr class="codeline" data-linenumber="7088"><td class="num" id="LN7088">7088</td><td class="line">        <span class='keyword'>int</span> need_free = 0;</td></tr>
<tr class="codeline" data-linenumber="7089"><td class="num" id="LN7089">7089</td><td class="line">        <span class='keyword'>if</span> (err == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) err = <span class='string_literal'>""</span>;</td></tr>
<tr class="codeline" data-linenumber="7090"><td class="num" id="LN7090">7090</td><td class="line">        <span class='keyword'>else</span> need_free = 1;</td></tr>
<tr class="codeline" data-linenumber="7091"><td class="num" id="LN7091">7091</td><td class="line">        <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"ERR setting node-timeout for %s:%d: %s\n"</span>, n-&gt;ip,<span class='macro_popup'>clusterManagerLog(3,"ERR setting node-timeout for %s:%d: %s\n"<br>, n-&gt;ip, n-&gt;port, err)</span></span></td></tr>
<tr class="codeline" data-linenumber="7092"><td class="num" id="LN7092">7092</td><td class="line">                             <span class='macro'>n-&gt;port, err)<span class='macro_popup'>clusterManagerLog(3,"ERR setting node-timeout for %s:%d: %s\n"<br>, n-&gt;ip, n-&gt;port, err)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7093"><td class="num" id="LN7093">7093</td><td class="line">        <span class='keyword'>if</span> (need_free) zfree(err);</td></tr>
<tr class="codeline" data-linenumber="7094"><td class="num" id="LN7094">7094</td><td class="line">        err_count++;</td></tr>
<tr class="codeline" data-linenumber="7095"><td class="num" id="LN7095">7095</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7096"><td class="num" id="LN7096">7096</td><td class="line">    <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; New node timeout set. %d OK, %d ERR.\n"</span>,<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; New node timeout set. %d OK, %d ERR.\n"<br>, ok_count, err_count)</span></span></td></tr>
<tr class="codeline" data-linenumber="7097"><td class="num" id="LN7097">7097</td><td class="line">                          <span class='macro'>ok_count, err_count)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; New node timeout set. %d OK, %d ERR.\n"<br>, ok_count, err_count)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7098"><td class="num" id="LN7098">7098</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="7099"><td class="num" id="LN7099">7099</td><td class="line">invalid_args:</td></tr>
<tr class="codeline" data-linenumber="7100"><td class="num" id="LN7100">7100</td><td class="line">    fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='macro'>CLUSTER_MANAGER_INVALID_HOST_ARG<span class='macro_popup'>"[ERR] Invalid arguments: you need to pass either a valid " "address (ie. 120.0.0.1:7000) or space separated IP "<br> "and port (ie. 120.0.0.1 7000)\n"</span></span>);</td></tr>
<tr class="codeline" data-linenumber="7101"><td class="num" id="LN7101">7101</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="7102"><td class="num" id="LN7102">7102</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="7103"><td class="num" id="LN7103">7103</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7104"><td class="num" id="LN7104">7104</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerCommandImport(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv) {</td></tr>
<tr class="codeline" data-linenumber="7105"><td class="num" id="LN7105">7105</td><td class="line">    <span class='keyword'>int</span> success = 1;</td></tr>
<tr class="codeline" data-linenumber="7106"><td class="num" id="LN7106">7106</td><td class="line">    <span class='keyword'>int</span> port = 0, src_port = 0;</td></tr>
<tr class="codeline" data-linenumber="7107"><td class="num" id="LN7107">7107</td><td class="line">    <span class='keyword'>char</span> *ip = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, *src_ip = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7108"><td class="num" id="LN7108">7108</td><td class="line">    <span class='keyword'>char</span> *invalid_args_msg = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7109"><td class="num" id="LN7109">7109</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> cmdfmt = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7110"><td class="num" id="LN7110">7110</td><td class="line">    <span class='keyword'>if</span> (!getClusterHostFromCmdArgs(argc, argv, &amp;ip, &amp;port)) {</td></tr>
<tr class="codeline" data-linenumber="7111"><td class="num" id="LN7111">7111</td><td class="line">        invalid_args_msg = <span class='macro'>CLUSTER_MANAGER_INVALID_HOST_ARG<span class='macro_popup'>"[ERR] Invalid arguments: you need to pass either a valid " "address (ie. 120.0.0.1:7000) or space separated IP "<br> "and port (ie. 120.0.0.1 7000)\n"</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7112"><td class="num" id="LN7112">7112</td><td class="line">        <span class='keyword'>goto</span> invalid_args;</td></tr>
<tr class="codeline" data-linenumber="7113"><td class="num" id="LN7113">7113</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7114"><td class="num" id="LN7114">7114</td><td class="line">    <span class='keyword'>if</span> (config.cluster_manager_command.from == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="7115"><td class="num" id="LN7115">7115</td><td class="line">        invalid_args_msg = <span class='string_literal'>"[ERR] Option '--cluster-from' is required for "</span></td></tr>
<tr class="codeline" data-linenumber="7116"><td class="num" id="LN7116">7116</td><td class="line">                           <span class='string_literal'>"subcommand 'import'.\n"</span>;</td></tr>
<tr class="codeline" data-linenumber="7117"><td class="num" id="LN7117">7117</td><td class="line">        <span class='keyword'>goto</span> invalid_args;</td></tr>
<tr class="codeline" data-linenumber="7118"><td class="num" id="LN7118">7118</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7119"><td class="num" id="LN7119">7119</td><td class="line">    <span class='keyword'>char</span> *src_host[] = {config.cluster_manager_command.from};</td></tr>
<tr class="codeline" data-linenumber="7120"><td class="num" id="LN7120">7120</td><td class="line">    <span class='keyword'>if</span> (!getClusterHostFromCmdArgs(1, src_host, &amp;src_ip, &amp;src_port)) {</td></tr>
<tr class="codeline" data-linenumber="7121"><td class="num" id="LN7121">7121</td><td class="line">        invalid_args_msg = <span class='string_literal'>"[ERR] Invalid --cluster-from host. You need to "</span></td></tr>
<tr class="codeline" data-linenumber="7122"><td class="num" id="LN7122">7122</td><td class="line">                           <span class='string_literal'>"pass a valid address (ie. 120.0.0.1:7000).\n"</span>;</td></tr>
<tr class="codeline" data-linenumber="7123"><td class="num" id="LN7123">7123</td><td class="line">        <span class='keyword'>goto</span> invalid_args;</td></tr>
<tr class="codeline" data-linenumber="7124"><td class="num" id="LN7124">7124</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7125"><td class="num" id="LN7125">7125</td><td class="line">    <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Importing data from %s:%d to cluster %s:%d\n"</span>,<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Importing data from %s:%d to cluster %s:%d\n"<br>, src_ip, src_port, ip, port)</span></span></td></tr>
<tr class="codeline" data-linenumber="7126"><td class="num" id="LN7126">7126</td><td class="line">                          <span class='macro'>src_ip, src_port, ip, port)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Importing data from %s:%d to cluster %s:%d\n"<br>, src_ip, src_port, ip, port)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7127"><td class="num" id="LN7127">7127</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7128"><td class="num" id="LN7128">7128</td><td class="line">    clusterManagerNode *refnode = clusterManagerNewNode(ip, port, 0);</td></tr>
<tr class="codeline" data-linenumber="7129"><td class="num" id="LN7129">7129</td><td class="line">    <span class='keyword'>if</span> (!clusterManagerLoadInfoFromNode(refnode)) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="7130"><td class="num" id="LN7130">7130</td><td class="line">    <span class='keyword'>if</span> (!clusterManagerCheckCluster(0)) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="7131"><td class="num" id="LN7131">7131</td><td class="line">    <span class='keyword'>char</span> *reply_err = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7132"><td class="num" id="LN7132">7132</td><td class="line">    redisReply *src_reply = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7133"><td class="num" id="LN7133">7133</td><td class="line">    <span class='comment'>// Connect to the source node.</span></td></tr>
<tr class="codeline" data-linenumber="7134"><td class="num" id="LN7134">7134</td><td class="line">    redisContext *src_ctx = redisConnect(src_ip, src_port);</td></tr>
<tr class="codeline" data-linenumber="7135"><td class="num" id="LN7135">7135</td><td class="line">    <span class='keyword'>if</span> (src_ctx-&gt;err) {</td></tr>
<tr class="codeline" data-linenumber="7136"><td class="num" id="LN7136">7136</td><td class="line">        success = 0;</td></tr>
<tr class="codeline" data-linenumber="7137"><td class="num" id="LN7137">7137</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"Could not connect to Redis at %s:%d: %s.\n"</span>, src_ip,</td></tr>
<tr class="codeline" data-linenumber="7138"><td class="num" id="LN7138">7138</td><td class="line">                src_port, src_ctx-&gt;errstr);</td></tr>
<tr class="codeline" data-linenumber="7139"><td class="num" id="LN7139">7139</td><td class="line">        <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="7140"><td class="num" id="LN7140">7140</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7141"><td class="num" id="LN7141">7141</td><td class="line">    <span class='comment'>// Auth for the source node. </span></td></tr>
<tr class="codeline" data-linenumber="7142"><td class="num" id="LN7142">7142</td><td class="line">    <span class='keyword'>char</span> *from_user = config.cluster_manager_command.from_user;</td></tr>
<tr class="codeline" data-linenumber="7143"><td class="num" id="LN7143">7143</td><td class="line">    <span class='keyword'>char</span> *from_pass = config.cluster_manager_command.from_pass;</td></tr>
<tr class="codeline" data-linenumber="7144"><td class="num" id="LN7144">7144</td><td class="line">    <span class='keyword'>if</span> (cliAuth(src_ctx, from_user, from_pass) == <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="7145"><td class="num" id="LN7145">7145</td><td class="line">        success = 0;</td></tr>
<tr class="codeline" data-linenumber="7146"><td class="num" id="LN7146">7146</td><td class="line">        <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="7147"><td class="num" id="LN7147">7147</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7148"><td class="num" id="LN7148">7148</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7149"><td class="num" id="LN7149">7149</td><td class="line">    src_reply = reconnectingRedisCommand(src_ctx, <span class='string_literal'>"INFO"</span>);</td></tr>
<tr class="codeline" data-linenumber="7150"><td class="num" id="LN7150">7150</td><td class="line">    <span class='keyword'>if</span> (!src_reply || src_reply-&gt;type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="7151"><td class="num" id="LN7151">7151</td><td class="line">        <span class='keyword'>if</span> (src_reply &amp;&amp; src_reply-&gt;str) reply_err = src_reply-&gt;str;</td></tr>
<tr class="codeline" data-linenumber="7152"><td class="num" id="LN7152">7152</td><td class="line">        success = 0;</td></tr>
<tr class="codeline" data-linenumber="7153"><td class="num" id="LN7153">7153</td><td class="line">        <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="7154"><td class="num" id="LN7154">7154</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7155"><td class="num" id="LN7155">7155</td><td class="line">    <span class='keyword'>if</span> (getLongInfoField(src_reply-&gt;str, <span class='string_literal'>"cluster_enabled"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="7156"><td class="num" id="LN7156">7156</td><td class="line">        <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"[ERR] The source node should not be a "<span class='macro_popup'>clusterManagerLog(3,"[ERR] The source node should not be a " "cluster node.\n"<br>)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="7157"><td class="num" id="LN7157">7157</td><td class="line">                             <span class='string_literal'><span class='macro'>"cluster node.\n"</span>)<span class='macro_popup'>clusterManagerLog(3,"[ERR] The source node should not be a " "cluster node.\n"<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7158"><td class="num" id="LN7158">7158</td><td class="line">        success = 0;</td></tr>
<tr class="codeline" data-linenumber="7159"><td class="num" id="LN7159">7159</td><td class="line">        <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="7160"><td class="num" id="LN7160">7160</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7161"><td class="num" id="LN7161">7161</td><td class="line">    freeReplyObject(src_reply);</td></tr>
<tr class="codeline" data-linenumber="7162"><td class="num" id="LN7162">7162</td><td class="line">    src_reply = reconnectingRedisCommand(src_ctx, <span class='string_literal'>"DBSIZE"</span>);</td></tr>
<tr class="codeline" data-linenumber="7163"><td class="num" id="LN7163">7163</td><td class="line">    <span class='keyword'>if</span> (!src_reply || src_reply-&gt;type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="7164"><td class="num" id="LN7164">7164</td><td class="line">        <span class='keyword'>if</span> (src_reply &amp;&amp; src_reply-&gt;str) reply_err = src_reply-&gt;str;</td></tr>
<tr class="codeline" data-linenumber="7165"><td class="num" id="LN7165">7165</td><td class="line">        success = 0;</td></tr>
<tr class="codeline" data-linenumber="7166"><td class="num" id="LN7166">7166</td><td class="line">        <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="7167"><td class="num" id="LN7167">7167</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7168"><td class="num" id="LN7168">7168</td><td class="line">    <span class='keyword'>int</span> size = src_reply-&gt;integer, i;</td></tr>
<tr class="codeline" data-linenumber="7169"><td class="num" id="LN7169">7169</td><td class="line">    <span class='macro'>clusterManagerLogWarn(<span class='string_literal'>"*** Importing %d keys from DB 0\n"</span>, size)<span class='macro_popup'>clusterManagerLog(2,"*** Importing %d keys from DB 0\n", size<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7170"><td class="num" id="LN7170">7170</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7171"><td class="num" id="LN7171">7171</td><td class="line">    <span class='comment'>// Build a slot -&gt; node map</span></td></tr>
<tr class="codeline" data-linenumber="7172"><td class="num" id="LN7172">7172</td><td class="line">    clusterManagerNode  *slots_map[<span class='macro'>CLUSTER_MANAGER_SLOTS<span class='macro_popup'>16384</span></span>];</td></tr>
<tr class="codeline" data-linenumber="7173"><td class="num" id="LN7173">7173</td><td class="line">    memset(slots_map, 0, <span class='keyword'>sizeof</span>(slots_map));</td></tr>
<tr class="codeline" data-linenumber="7174"><td class="num" id="LN7174">7174</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="7175"><td class="num" id="LN7175">7175</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="7176"><td class="num" id="LN7176">7176</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; <span class='macro'>CLUSTER_MANAGER_SLOTS<span class='macro_popup'>16384</span></span>; i++) {</td></tr>
<tr class="codeline" data-linenumber="7177"><td class="num" id="LN7177">7177</td><td class="line">        listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="7178"><td class="num" id="LN7178">7178</td><td class="line">        <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="7179"><td class="num" id="LN7179">7179</td><td class="line">            clusterManagerNode *n = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="7180"><td class="num" id="LN7180">7180</td><td class="line">            <span class='keyword'>if</span> (n-&gt;flags &amp; <span class='macro'>CLUSTER_MANAGER_FLAG_SLAVE<span class='macro_popup'>1 &lt;&lt; 1</span></span>) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="7181"><td class="num" id="LN7181">7181</td><td class="line">            <span class='keyword'>if</span> (n-&gt;slots_count == 0) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="7182"><td class="num" id="LN7182">7182</td><td class="line">            <span class='keyword'>if</span> (n-&gt;slots[i]) {</td></tr>
<tr class="codeline" data-linenumber="7183"><td class="num" id="LN7183">7183</td><td class="line">                slots_map[i] = n;</td></tr>
<tr class="codeline" data-linenumber="7184"><td class="num" id="LN7184">7184</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="7185"><td class="num" id="LN7185">7185</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="7186"><td class="num" id="LN7186">7186</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="7187"><td class="num" id="LN7187">7187</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7188"><td class="num" id="LN7188">7188</td><td class="line">    cmdfmt = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(<span class='string_literal'>"MIGRATE %s %d %s %d %d"</span>);</td></tr>
<tr class="codeline" data-linenumber="7189"><td class="num" id="LN7189">7189</td><td class="line">    <span class='keyword'>if</span> (config.conn_info.auth) {</td></tr>
<tr class="codeline" data-linenumber="7190"><td class="num" id="LN7190">7190</td><td class="line">        <span class='keyword'>if</span> (config.conn_info.user) {</td></tr>
<tr class="codeline" data-linenumber="7191"><td class="num" id="LN7191">7191</td><td class="line">            cmdfmt = <span class='macro'>sdscatfmt<span class='macro_popup'>hi_sdscatfmt</span></span>(cmdfmt,<span class='string_literal'>" AUTH2 %s %s"</span>, config.conn_info.user, config.conn_info.auth); </td></tr>
<tr class="codeline" data-linenumber="7192"><td class="num" id="LN7192">7192</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="7193"><td class="num" id="LN7193">7193</td><td class="line">            cmdfmt = <span class='macro'>sdscatfmt<span class='macro_popup'>hi_sdscatfmt</span></span>(cmdfmt,<span class='string_literal'>" AUTH %s"</span>, config.conn_info.auth);</td></tr>
<tr class="codeline" data-linenumber="7194"><td class="num" id="LN7194">7194</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="7195"><td class="num" id="LN7195">7195</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7196"><td class="num" id="LN7196">7196</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7197"><td class="num" id="LN7197">7197</td><td class="line">    <span class='keyword'>if</span> (config.cluster_manager_command.flags &amp; <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_COPY<span class='macro_popup'>1 &lt;&lt; 7</span></span>)</td></tr>
<tr class="codeline" data-linenumber="7198"><td class="num" id="LN7198">7198</td><td class="line">        cmdfmt = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(cmdfmt,<span class='string_literal'>" COPY"</span>);</td></tr>
<tr class="codeline" data-linenumber="7199"><td class="num" id="LN7199">7199</td><td class="line">    <span class='keyword'>if</span> (config.cluster_manager_command.flags &amp; <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_REPLACE<span class='macro_popup'>1 &lt;&lt; 6</span></span>)</td></tr>
<tr class="codeline" data-linenumber="7200"><td class="num" id="LN7200">7200</td><td class="line">        cmdfmt = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(cmdfmt,<span class='string_literal'>" REPLACE"</span>);</td></tr>
<tr class="codeline" data-linenumber="7201"><td class="num" id="LN7201">7201</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7202"><td class="num" id="LN7202">7202</td><td class="line">    <span class='comment'>/* Use SCAN to iterate over the keys, migrating to the</span></td></tr>
<tr class="codeline" data-linenumber="7203"><td class="num" id="LN7203">7203</td><td class="line">     <span class='comment'>* right node as needed. */</span></td></tr>
<tr class="codeline" data-linenumber="7204"><td class="num" id="LN7204">7204</td><td class="line">    <span class='keyword'>int</span> cursor = -999, timeout = config.cluster_manager_command.timeout;</td></tr>
<tr class="codeline" data-linenumber="7205"><td class="num" id="LN7205">7205</td><td class="line">    <span class='keyword'>while</span> (cursor != 0) {</td></tr>
<tr class="codeline" data-linenumber="7206"><td class="num" id="LN7206">7206</td><td class="line">        <span class='keyword'>if</span> (cursor &lt; 0) cursor = 0;</td></tr>
<tr class="codeline" data-linenumber="7207"><td class="num" id="LN7207">7207</td><td class="line">        freeReplyObject(src_reply);</td></tr>
<tr class="codeline" data-linenumber="7208"><td class="num" id="LN7208">7208</td><td class="line">        src_reply = reconnectingRedisCommand(src_ctx, <span class='string_literal'>"SCAN %d COUNT %d"</span>,</td></tr>
<tr class="codeline" data-linenumber="7209"><td class="num" id="LN7209">7209</td><td class="line">                                             cursor, 1000);</td></tr>
<tr class="codeline" data-linenumber="7210"><td class="num" id="LN7210">7210</td><td class="line">        <span class='keyword'>if</span> (!src_reply || src_reply-&gt;type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="7211"><td class="num" id="LN7211">7211</td><td class="line">            <span class='keyword'>if</span> (src_reply &amp;&amp; src_reply-&gt;str) reply_err = src_reply-&gt;str;</td></tr>
<tr class="codeline" data-linenumber="7212"><td class="num" id="LN7212">7212</td><td class="line">            success = 0;</td></tr>
<tr class="codeline" data-linenumber="7213"><td class="num" id="LN7213">7213</td><td class="line">            <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="7214"><td class="num" id="LN7214">7214</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="7215"><td class="num" id="LN7215">7215</td><td class="line">        <span class='macro'>assert(src_reply-&gt;type == REDIS_REPLY_ARRAY)<span class='macro_popup'>((src_reply-&gt;type == 2) ? (void) (0) : __assert_fail ("src_reply-&gt;type == REDIS_REPLY_ARRAY"<br>, "redis-cli.c", 7215, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7216"><td class="num" id="LN7216">7216</td><td class="line">        <span class='macro'>assert(src_reply-&gt;elements &gt;= 2)<span class='macro_popup'>((src_reply-&gt;elements &gt;= 2) ? (void) (0) : __assert_fail<br> ("src_reply-&gt;elements &gt;= 2", "redis-cli.c", 7216, __extension__<br> __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7217"><td class="num" id="LN7217">7217</td><td class="line">        <span class='macro'>assert(src_reply-&gt;element[1]-&gt;type == REDIS_REPLY_ARRAY)<span class='macro_popup'>((src_reply-&gt;element[1]-&gt;type == 2) ? (void) (0) : __assert_fail<br> ("src_reply-&gt;element[1]-&gt;type == REDIS_REPLY_ARRAY", "redis-cli.c"<br>, 7217, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7218"><td class="num" id="LN7218">7218</td><td class="line">        <span class='keyword'>if</span> (src_reply-&gt;element[0]-&gt;type == <span class='macro'>REDIS_REPLY_STRING<span class='macro_popup'>1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="7219"><td class="num" id="LN7219">7219</td><td class="line">            cursor = atoi(src_reply-&gt;element[0]-&gt;str);</td></tr>
<tr class="codeline" data-linenumber="7220"><td class="num" id="LN7220">7220</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (src_reply-&gt;element[0]-&gt;type == <span class='macro'>REDIS_REPLY_INTEGER<span class='macro_popup'>3</span></span>)</td></tr>
<tr class="codeline" data-linenumber="7221"><td class="num" id="LN7221">7221</td><td class="line">            cursor = src_reply-&gt;element[0]-&gt;integer;</td></tr>
<tr class="codeline" data-linenumber="7222"><td class="num" id="LN7222">7222</td><td class="line">        <span class='keyword'>int</span> keycount = src_reply-&gt;element[1]-&gt;elements;</td></tr>
<tr class="codeline" data-linenumber="7223"><td class="num" id="LN7223">7223</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; keycount; i++) {</td></tr>
<tr class="codeline" data-linenumber="7224"><td class="num" id="LN7224">7224</td><td class="line">            redisReply *kr = src_reply-&gt;element[1]-&gt;element[i];</td></tr>
<tr class="codeline" data-linenumber="7225"><td class="num" id="LN7225">7225</td><td class="line">            <span class='macro'>assert(kr-&gt;type == REDIS_REPLY_STRING)<span class='macro_popup'>((kr-&gt;type == 1) ? (void) (0) : __assert_fail ("kr-&gt;type == REDIS_REPLY_STRING"<br>, "redis-cli.c", 7225, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7226"><td class="num" id="LN7226">7226</td><td class="line">            <span class='keyword'>char</span> *key = kr-&gt;str;</td></tr>
<tr class="codeline" data-linenumber="7227"><td class="num" id="LN7227">7227</td><td class="line">            uint16_t slot = clusterManagerKeyHashSlot(key, kr-&gt;len);</td></tr>
<tr class="codeline" data-linenumber="7228"><td class="num" id="LN7228">7228</td><td class="line">            clusterManagerNode *target = slots_map[slot];</td></tr>
<tr class="codeline" data-linenumber="7229"><td class="num" id="LN7229">7229</td><td class="line">            printf(<span class='string_literal'>"Migrating %s to %s:%d: "</span>, key, target-&gt;ip, target-&gt;port);</td></tr>
<tr class="codeline" data-linenumber="7230"><td class="num" id="LN7230">7230</td><td class="line">            redisReply *r = reconnectingRedisCommand(src_ctx, cmdfmt,</td></tr>
<tr class="codeline" data-linenumber="7231"><td class="num" id="LN7231">7231</td><td class="line">                                                     target-&gt;ip, target-&gt;port,</td></tr>
<tr class="codeline" data-linenumber="7232"><td class="num" id="LN7232">7232</td><td class="line">                                                     key, 0, timeout);</td></tr>
<tr class="codeline" data-linenumber="7233"><td class="num" id="LN7233">7233</td><td class="line">            <span class='keyword'>if</span> (!r || r-&gt;type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="7234"><td class="num" id="LN7234">7234</td><td class="line">                <span class='keyword'>if</span> (r &amp;&amp; r-&gt;str) {</td></tr>
<tr class="codeline" data-linenumber="7235"><td class="num" id="LN7235">7235</td><td class="line">                    <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"Source %s:%d replied with "<span class='macro_popup'>clusterManagerLog(3,"Source %s:%d replied with " "error:\n%s\n"<br>, src_ip, src_port, r-&gt;str)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="7236"><td class="num" id="LN7236">7236</td><td class="line">                                         <span class='string_literal'><span class='macro'>"error:\n%s\n"</span>, src_ip, src_port,<span class='macro_popup'>clusterManagerLog(3,"Source %s:%d replied with " "error:\n%s\n"<br>, src_ip, src_port, r-&gt;str)</span></span></td></tr>
<tr class="codeline" data-linenumber="7237"><td class="num" id="LN7237">7237</td><td class="line">                                         <span class='macro'>r-&gt;str)<span class='macro_popup'>clusterManagerLog(3,"Source %s:%d replied with " "error:\n%s\n"<br>, src_ip, src_port, r-&gt;str)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7238"><td class="num" id="LN7238">7238</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="7239"><td class="num" id="LN7239">7239</td><td class="line">                success = 0;</td></tr>
<tr class="codeline" data-linenumber="7240"><td class="num" id="LN7240">7240</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="7241"><td class="num" id="LN7241">7241</td><td class="line">            freeReplyObject(r);</td></tr>
<tr class="codeline" data-linenumber="7242"><td class="num" id="LN7242">7242</td><td class="line">            <span class='keyword'>if</span> (!success) <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="7243"><td class="num" id="LN7243">7243</td><td class="line">            <span class='macro'>clusterManagerLogOk(<span class='string_literal'>"OK\n"</span>)<span class='macro_popup'>clusterManagerLog(4,"OK\n")</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7244"><td class="num" id="LN7244">7244</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="7245"><td class="num" id="LN7245">7245</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7246"><td class="num" id="LN7246">7246</td><td class="line">cleanup:</td></tr>
<tr class="codeline" data-linenumber="7247"><td class="num" id="LN7247">7247</td><td class="line">    <span class='keyword'>if</span> (reply_err)</td></tr>
<tr class="codeline" data-linenumber="7248"><td class="num" id="LN7248">7248</td><td class="line">        <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"Source %s:%d replied with error:\n%s\n"</span>,<span class='macro_popup'>clusterManagerLog(3,"Source %s:%d replied with error:\n%s\n",<br> src_ip, src_port, reply_err)</span></span></td></tr>
<tr class="codeline" data-linenumber="7249"><td class="num" id="LN7249">7249</td><td class="line">                             <span class='macro'>src_ip, src_port, reply_err)<span class='macro_popup'>clusterManagerLog(3,"Source %s:%d replied with error:\n%s\n",<br> src_ip, src_port, reply_err)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7250"><td class="num" id="LN7250">7250</td><td class="line">    <span class='keyword'>if</span> (src_ctx) redisFree(src_ctx);</td></tr>
<tr class="codeline" data-linenumber="7251"><td class="num" id="LN7251">7251</td><td class="line">    <span class='keyword'>if</span> (src_reply) freeReplyObject(src_reply);</td></tr>
<tr class="codeline" data-linenumber="7252"><td class="num" id="LN7252">7252</td><td class="line">    <span class='keyword'>if</span> (cmdfmt) <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(cmdfmt);</td></tr>
<tr class="codeline" data-linenumber="7253"><td class="num" id="LN7253">7253</td><td class="line">    <span class='keyword'>return</span> success;</td></tr>
<tr class="codeline" data-linenumber="7254"><td class="num" id="LN7254">7254</td><td class="line">invalid_args:</td></tr>
<tr class="codeline" data-linenumber="7255"><td class="num" id="LN7255">7255</td><td class="line">    fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"%s"</span>, invalid_args_msg);</td></tr>
<tr class="codeline" data-linenumber="7256"><td class="num" id="LN7256">7256</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="7257"><td class="num" id="LN7257">7257</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="7258"><td class="num" id="LN7258">7258</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7259"><td class="num" id="LN7259">7259</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerCommandCall(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv) {</td></tr>
<tr class="codeline" data-linenumber="7260"><td class="num" id="LN7260">7260</td><td class="line">    <span class='keyword'>int</span> port = 0, i;</td></tr>
<tr class="codeline" data-linenumber="7261"><td class="num" id="LN7261">7261</td><td class="line">    <span class='keyword'>char</span> *ip = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7262"><td class="num" id="LN7262">7262</td><td class="line">    <span class='keyword'>if</span> (!getClusterHostFromCmdArgs(1, argv, &amp;ip, &amp;port)) <span class='keyword'>goto</span> invalid_args;</td></tr>
<tr class="codeline" data-linenumber="7263"><td class="num" id="LN7263">7263</td><td class="line">    clusterManagerNode *refnode = clusterManagerNewNode(ip, port, 0);</td></tr>
<tr class="codeline" data-linenumber="7264"><td class="num" id="LN7264">7264</td><td class="line">    <span class='keyword'>if</span> (!clusterManagerLoadInfoFromNode(refnode)) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="7265"><td class="num" id="LN7265">7265</td><td class="line">    argc--;</td></tr>
<tr class="codeline" data-linenumber="7266"><td class="num" id="LN7266">7266</td><td class="line">    argv++;</td></tr>
<tr class="codeline" data-linenumber="7267"><td class="num" id="LN7267">7267</td><td class="line">    size_t *argvlen = zmalloc(argc*<span class='keyword'>sizeof</span>(size_t));</td></tr>
<tr class="codeline" data-linenumber="7268"><td class="num" id="LN7268">7268</td><td class="line">    <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Calling"</span>)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Calling")</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7269"><td class="num" id="LN7269">7269</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; argc; i++) {</td></tr>
<tr class="codeline" data-linenumber="7270"><td class="num" id="LN7270">7270</td><td class="line">        argvlen[i] = strlen(argv[i]);</td></tr>
<tr class="codeline" data-linenumber="7271"><td class="num" id="LN7271">7271</td><td class="line">        printf(<span class='string_literal'>" %s"</span>, argv[i]);</td></tr>
<tr class="codeline" data-linenumber="7272"><td class="num" id="LN7272">7272</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7273"><td class="num" id="LN7273">7273</td><td class="line">    printf(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="7274"><td class="num" id="LN7274">7274</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="7275"><td class="num" id="LN7275">7275</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="7276"><td class="num" id="LN7276">7276</td><td class="line">    listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="7277"><td class="num" id="LN7277">7277</td><td class="line">    <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="7278"><td class="num" id="LN7278">7278</td><td class="line">        clusterManagerNode *n = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="7279"><td class="num" id="LN7279">7279</td><td class="line">        <span class='keyword'>if</span> ((config.cluster_manager_command.flags &amp; <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_MASTERS_ONLY<span class='macro_popup'>1 &lt;&lt; 11</span></span>)</td></tr>
<tr class="codeline" data-linenumber="7280"><td class="num" id="LN7280">7280</td><td class="line">              &amp;&amp; (n-&gt;replicate != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)) <span class='keyword'>continue</span>;  <span class='comment'>// continue if node is slave</span></td></tr>
<tr class="codeline" data-linenumber="7281"><td class="num" id="LN7281">7281</td><td class="line">        <span class='keyword'>if</span> ((config.cluster_manager_command.flags &amp; <span class='macro'>CLUSTER_MANAGER_CMD_FLAG_SLAVES_ONLY<span class='macro_popup'>1 &lt;&lt; 12</span></span>)</td></tr>
<tr class="codeline" data-linenumber="7282"><td class="num" id="LN7282">7282</td><td class="line">              &amp;&amp; (n-&gt;replicate == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)) <span class='keyword'>continue</span>;   <span class='comment'>// continue if node is master</span></td></tr>
<tr class="codeline" data-linenumber="7283"><td class="num" id="LN7283">7283</td><td class="line">        <span class='keyword'>if</span> (!n-&gt;context &amp;&amp; !clusterManagerNodeConnect(n)) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="7284"><td class="num" id="LN7284">7284</td><td class="line">        redisReply *reply = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7285"><td class="num" id="LN7285">7285</td><td class="line">        redisAppendCommandArgv(n-&gt;context, argc, (<span class='keyword'>const</span> <span class='keyword'>char</span> **) argv, argvlen);</td></tr>
<tr class="codeline" data-linenumber="7286"><td class="num" id="LN7286">7286</td><td class="line">        <span class='keyword'>int</span> status = redisGetReply(n-&gt;context, (<span class='keyword'>void</span> **)(&amp;reply));</td></tr>
<tr class="codeline" data-linenumber="7287"><td class="num" id="LN7287">7287</td><td class="line">        <span class='keyword'>if</span> (status != <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span> || reply == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> )</td></tr>
<tr class="codeline" data-linenumber="7288"><td class="num" id="LN7288">7288</td><td class="line">            printf(<span class='string_literal'>"%s:%d: Failed!\n"</span>, n-&gt;ip, n-&gt;port);</td></tr>
<tr class="codeline" data-linenumber="7289"><td class="num" id="LN7289">7289</td><td class="line">        <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="7290"><td class="num" id="LN7290">7290</td><td class="line">            <span class='macro'>sds<span class='macro_popup'>hisds</span></span> formatted_reply = cliFormatReplyRaw(reply);</td></tr>
<tr class="codeline" data-linenumber="7291"><td class="num" id="LN7291">7291</td><td class="line">            printf(<span class='string_literal'>"%s:%d: %s\n"</span>, n-&gt;ip, n-&gt;port, (<span class='keyword'>char</span> *) formatted_reply);</td></tr>
<tr class="codeline" data-linenumber="7292"><td class="num" id="LN7292">7292</td><td class="line">            <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(formatted_reply);</td></tr>
<tr class="codeline" data-linenumber="7293"><td class="num" id="LN7293">7293</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="7294"><td class="num" id="LN7294">7294</td><td class="line">        <span class='keyword'>if</span> (reply != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="7295"><td class="num" id="LN7295">7295</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7296"><td class="num" id="LN7296">7296</td><td class="line">    zfree(argvlen);</td></tr>
<tr class="codeline" data-linenumber="7297"><td class="num" id="LN7297">7297</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="7298"><td class="num" id="LN7298">7298</td><td class="line">invalid_args:</td></tr>
<tr class="codeline" data-linenumber="7299"><td class="num" id="LN7299">7299</td><td class="line">    fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='macro'>CLUSTER_MANAGER_INVALID_HOST_ARG<span class='macro_popup'>"[ERR] Invalid arguments: you need to pass either a valid " "address (ie. 120.0.0.1:7000) or space separated IP "<br> "and port (ie. 120.0.0.1 7000)\n"</span></span>);</td></tr>
<tr class="codeline" data-linenumber="7300"><td class="num" id="LN7300">7300</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="7301"><td class="num" id="LN7301">7301</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="7302"><td class="num" id="LN7302">7302</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7303"><td class="num" id="LN7303">7303</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerCommandBackup(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv) {</td></tr>
<tr class="codeline" data-linenumber="7304"><td class="num" id="LN7304">7304</td><td class="line">    <span class='macro'>UNUSED(argc)<span class='macro_popup'>((void) argc)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7305"><td class="num" id="LN7305">7305</td><td class="line">    <span class='keyword'>int</span> success = 1, port = 0;</td></tr>
<tr class="codeline" data-linenumber="7306"><td class="num" id="LN7306">7306</td><td class="line">    <span class='keyword'>char</span> *ip = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7307"><td class="num" id="LN7307">7307</td><td class="line">    <span class='keyword'>if</span> (!getClusterHostFromCmdArgs(1, argv, &amp;ip, &amp;port)) <span class='keyword'>goto</span> invalid_args;</td></tr>
<tr class="codeline" data-linenumber="7308"><td class="num" id="LN7308">7308</td><td class="line">    clusterManagerNode *refnode = clusterManagerNewNode(ip, port, 0);</td></tr>
<tr class="codeline" data-linenumber="7309"><td class="num" id="LN7309">7309</td><td class="line">    <span class='keyword'>if</span> (!clusterManagerLoadInfoFromNode(refnode)) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="7310"><td class="num" id="LN7310">7310</td><td class="line">    <span class='keyword'>int</span> no_issues = clusterManagerCheckCluster(0);</td></tr>
<tr class="codeline" data-linenumber="7311"><td class="num" id="LN7311">7311</td><td class="line">    <span class='keyword'>int</span> cluster_errors_count = (no_issues ? 0 :</td></tr>
<tr class="codeline" data-linenumber="7312"><td class="num" id="LN7312">7312</td><td class="line">                                <span class='macro'>listLength(cluster_manager.errors)<span class='macro_popup'>((cluster_manager.errors)-&gt;len)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="7313"><td class="num" id="LN7313">7313</td><td class="line">    config.cluster_manager_command.backup_dir = argv[1];</td></tr>
<tr class="codeline" data-linenumber="7314"><td class="num" id="LN7314">7314</td><td class="line">    <span class='comment'>/* TODO: check if backup_dir is a valid directory. */</span></td></tr>
<tr class="codeline" data-linenumber="7315"><td class="num" id="LN7315">7315</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> json = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(<span class='string_literal'>"[\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="7316"><td class="num" id="LN7316">7316</td><td class="line">    <span class='keyword'>int</span> first_node = 0;</td></tr>
<tr class="codeline" data-linenumber="7317"><td class="num" id="LN7317">7317</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="7318"><td class="num" id="LN7318">7318</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="7319"><td class="num" id="LN7319">7319</td><td class="line">    listRewind(cluster_manager.nodes, &amp;li);</td></tr>
<tr class="codeline" data-linenumber="7320"><td class="num" id="LN7320">7320</td><td class="line">    <span class='keyword'>while</span> ((ln = listNext(&amp;li)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="7321"><td class="num" id="LN7321">7321</td><td class="line">        <span class='keyword'>if</span> (!first_node) first_node = 1;</td></tr>
<tr class="codeline" data-linenumber="7322"><td class="num" id="LN7322">7322</td><td class="line">        <span class='keyword'>else</span> json = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(json, <span class='string_literal'>",\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="7323"><td class="num" id="LN7323">7323</td><td class="line">        clusterManagerNode *node = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="7324"><td class="num" id="LN7324">7324</td><td class="line">        <span class='macro'>sds<span class='macro_popup'>hisds</span></span> node_json = clusterManagerNodeGetJSON(node, cluster_errors_count);</td></tr>
<tr class="codeline" data-linenumber="7325"><td class="num" id="LN7325">7325</td><td class="line">        json = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(json, node_json);</td></tr>
<tr class="codeline" data-linenumber="7326"><td class="num" id="LN7326">7326</td><td class="line">        <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(node_json);</td></tr>
<tr class="codeline" data-linenumber="7327"><td class="num" id="LN7327">7327</td><td class="line">        <span class='keyword'>if</span> (node-&gt;replicate)</td></tr>
<tr class="codeline" data-linenumber="7328"><td class="num" id="LN7328">7328</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="7329"><td class="num" id="LN7329">7329</td><td class="line">        <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"&gt;&gt;&gt; Node %s:%d -&gt; Saving RDB...\n"</span>,<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Node %s:%d -&gt; Saving RDB...\n"<br>, node-&gt;ip, node-&gt;port)</span></span></td></tr>
<tr class="codeline" data-linenumber="7330"><td class="num" id="LN7330">7330</td><td class="line">                              <span class='macro'>node-&gt;ip, node-&gt;port)<span class='macro_popup'>clusterManagerLog(1,"&gt;&gt;&gt; Node %s:%d -&gt; Saving RDB...\n"<br>, node-&gt;ip, node-&gt;port)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7331"><td class="num" id="LN7331">7331</td><td class="line">        fflush(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>);</td></tr>
<tr class="codeline" data-linenumber="7332"><td class="num" id="LN7332">7332</td><td class="line">        getRDB(node);</td></tr>
<tr class="codeline" data-linenumber="7333"><td class="num" id="LN7333">7333</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7334"><td class="num" id="LN7334">7334</td><td class="line">    json = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(json, <span class='string_literal'>"\n]"</span>);</td></tr>
<tr class="codeline" data-linenumber="7335"><td class="num" id="LN7335">7335</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> jsonpath = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(config.cluster_manager_command.backup_dir);</td></tr>
<tr class="codeline" data-linenumber="7336"><td class="num" id="LN7336">7336</td><td class="line">    <span class='keyword'>if</span> (jsonpath[<span class='macro'>sdslen<span class='macro_popup'>hi_sdslen</span></span>(jsonpath) - 1] != '/')</td></tr>
<tr class="codeline" data-linenumber="7337"><td class="num" id="LN7337">7337</td><td class="line">        jsonpath = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(jsonpath, <span class='string_literal'>"/"</span>);</td></tr>
<tr class="codeline" data-linenumber="7338"><td class="num" id="LN7338">7338</td><td class="line">    jsonpath = <span class='macro'>sdscat<span class='macro_popup'>hi_sdscat</span></span>(jsonpath, <span class='string_literal'>"nodes.json"</span>);</td></tr>
<tr class="codeline" data-linenumber="7339"><td class="num" id="LN7339">7339</td><td class="line">    fflush(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>);</td></tr>
<tr class="codeline" data-linenumber="7340"><td class="num" id="LN7340">7340</td><td class="line">    <span class='macro'>clusterManagerLogInfo(<span class='string_literal'>"Saving cluster configuration to: %s\n"</span>, jsonpath)<span class='macro_popup'>clusterManagerLog(1,"Saving cluster configuration to: %s\n", jsonpath<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7341"><td class="num" id="LN7341">7341</td><td class="line">    FILE *out = fopen(jsonpath, <span class='string_literal'>"w+"</span>);</td></tr>
<tr class="codeline" data-linenumber="7342"><td class="num" id="LN7342">7342</td><td class="line">    <span class='keyword'>if</span> (!out) {</td></tr>
<tr class="codeline" data-linenumber="7343"><td class="num" id="LN7343">7343</td><td class="line">        <span class='macro'>clusterManagerLogErr(<span class='string_literal'>"Could not save nodes to: %s\n"</span>, jsonpath)<span class='macro_popup'>clusterManagerLog(3,"Could not save nodes to: %s\n", jsonpath<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7344"><td class="num" id="LN7344">7344</td><td class="line">        success = 0;</td></tr>
<tr class="codeline" data-linenumber="7345"><td class="num" id="LN7345">7345</td><td class="line">        <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="7346"><td class="num" id="LN7346">7346</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7347"><td class="num" id="LN7347">7347</td><td class="line">    fputs(json, out);</td></tr>
<tr class="codeline" data-linenumber="7348"><td class="num" id="LN7348">7348</td><td class="line">    fclose(out);</td></tr>
<tr class="codeline" data-linenumber="7349"><td class="num" id="LN7349">7349</td><td class="line">cleanup:</td></tr>
<tr class="codeline" data-linenumber="7350"><td class="num" id="LN7350">7350</td><td class="line">    <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(json);</td></tr>
<tr class="codeline" data-linenumber="7351"><td class="num" id="LN7351">7351</td><td class="line">    <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(jsonpath);</td></tr>
<tr class="codeline" data-linenumber="7352"><td class="num" id="LN7352">7352</td><td class="line">    <span class='keyword'>if</span> (success) {</td></tr>
<tr class="codeline" data-linenumber="7353"><td class="num" id="LN7353">7353</td><td class="line">        <span class='keyword'>if</span> (!no_issues) {</td></tr>
<tr class="codeline" data-linenumber="7354"><td class="num" id="LN7354">7354</td><td class="line">            <span class='macro'>clusterManagerLogWarn(<span class='string_literal'>"*** Cluster seems to have some problems, "<span class='macro_popup'>clusterManagerLog(2,"*** Cluster seems to have some problems, "<br> "please be aware of it if you're going " "to restore this backup.\n"<br>)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="7355"><td class="num" id="LN7355">7355</td><td class="line">                                  <span class='string_literal'><span class='macro'>"please be aware of it if you're going "<span class='macro_popup'>clusterManagerLog(2,"*** Cluster seems to have some problems, "<br> "please be aware of it if you're going " "to restore this backup.\n"<br>)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="7356"><td class="num" id="LN7356">7356</td><td class="line">                                  <span class='string_literal'><span class='macro'>"to restore this backup.\n"</span>)<span class='macro_popup'>clusterManagerLog(2,"*** Cluster seems to have some problems, "<br> "please be aware of it if you're going " "to restore this backup.\n"<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7357"><td class="num" id="LN7357">7357</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="7358"><td class="num" id="LN7358">7358</td><td class="line">        <span class='macro'>clusterManagerLogOk(<span class='string_literal'>"[OK] Backup created into: %s\n"</span>,<span class='macro_popup'>clusterManagerLog(4,"[OK] Backup created into: %s\n", config.<br>cluster_manager_command.backup_dir)</span></span></td></tr>
<tr class="codeline" data-linenumber="7359"><td class="num" id="LN7359">7359</td><td class="line">                            <span class='macro'>config.cluster_manager_command.backup_dir)<span class='macro_popup'>clusterManagerLog(4,"[OK] Backup created into: %s\n", config.<br>cluster_manager_command.backup_dir)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7360"><td class="num" id="LN7360">7360</td><td class="line">    } <span class='keyword'>else</span> <span class='macro'>clusterManagerLogOk(<span class='string_literal'>"[ERR] Failed to back cluster!\n"</span>)<span class='macro_popup'>clusterManagerLog(4,"[ERR] Failed to back cluster!\n")</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7361"><td class="num" id="LN7361">7361</td><td class="line">    <span class='keyword'>return</span> success;</td></tr>
<tr class="codeline" data-linenumber="7362"><td class="num" id="LN7362">7362</td><td class="line">invalid_args:</td></tr>
<tr class="codeline" data-linenumber="7363"><td class="num" id="LN7363">7363</td><td class="line">    fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='macro'>CLUSTER_MANAGER_INVALID_HOST_ARG<span class='macro_popup'>"[ERR] Invalid arguments: you need to pass either a valid " "address (ie. 120.0.0.1:7000) or space separated IP "<br> "and port (ie. 120.0.0.1 7000)\n"</span></span>);</td></tr>
<tr class="codeline" data-linenumber="7364"><td class="num" id="LN7364">7364</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="7365"><td class="num" id="LN7365">7365</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="7366"><td class="num" id="LN7366">7366</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7367"><td class="num" id="LN7367">7367</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> clusterManagerCommandHelp(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv) {</td></tr>
<tr class="codeline" data-linenumber="7368"><td class="num" id="LN7368">7368</td><td class="line">    <span class='macro'>UNUSED(argc)<span class='macro_popup'>((void) argc)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7369"><td class="num" id="LN7369">7369</td><td class="line">    <span class='macro'>UNUSED(argv)<span class='macro_popup'>((void) argv)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7370"><td class="num" id="LN7370">7370</td><td class="line">    <span class='keyword'>int</span> commands_count = <span class='keyword'>sizeof</span>(clusterManagerCommands) /</td></tr>
<tr class="codeline" data-linenumber="7371"><td class="num" id="LN7371">7371</td><td class="line">                         <span class='keyword'>sizeof</span>(clusterManagerCommandDef);</td></tr>
<tr class="codeline" data-linenumber="7372"><td class="num" id="LN7372">7372</td><td class="line">    <span class='keyword'>int</span> i = 0, j;</td></tr>
<tr class="codeline" data-linenumber="7373"><td class="num" id="LN7373">7373</td><td class="line">    fprintf(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>, <span class='string_literal'>"Cluster Manager Commands:\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="7374"><td class="num" id="LN7374">7374</td><td class="line">    <span class='keyword'>int</span> padding = 15;</td></tr>
<tr class="codeline" data-linenumber="7375"><td class="num" id="LN7375">7375</td><td class="line">    <span class='keyword'>for</span> (; i &lt; commands_count; i++) {</td></tr>
<tr class="codeline" data-linenumber="7376"><td class="num" id="LN7376">7376</td><td class="line">        clusterManagerCommandDef *def = &amp;(clusterManagerCommands[i]);</td></tr>
<tr class="codeline" data-linenumber="7377"><td class="num" id="LN7377">7377</td><td class="line">        <span class='keyword'>int</span> namelen = strlen(def-&gt;name), padlen = padding - namelen;</td></tr>
<tr class="codeline" data-linenumber="7378"><td class="num" id="LN7378">7378</td><td class="line">        fprintf(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>, <span class='string_literal'>"  %s"</span>, def-&gt;name);</td></tr>
<tr class="codeline" data-linenumber="7379"><td class="num" id="LN7379">7379</td><td class="line">        <span class='keyword'>for</span> (j = 0; j &lt; padlen; j++) fprintf(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>, <span class='string_literal'>" "</span>);</td></tr>
<tr class="codeline" data-linenumber="7380"><td class="num" id="LN7380">7380</td><td class="line">        fprintf(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>, <span class='string_literal'>"%s\n"</span>, (def-&gt;args ? def-&gt;args : <span class='string_literal'>""</span>));</td></tr>
<tr class="codeline" data-linenumber="7381"><td class="num" id="LN7381">7381</td><td class="line">        <span class='keyword'>if</span> (def-&gt;options != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="7382"><td class="num" id="LN7382">7382</td><td class="line">            <span class='keyword'>int</span> optslen = strlen(def-&gt;options);</td></tr>
<tr class="codeline" data-linenumber="7383"><td class="num" id="LN7383">7383</td><td class="line">            <span class='keyword'>char</span> *p = def-&gt;options, *eos = p + optslen;</td></tr>
<tr class="codeline" data-linenumber="7384"><td class="num" id="LN7384">7384</td><td class="line">            <span class='keyword'>char</span> *comma = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7385"><td class="num" id="LN7385">7385</td><td class="line">            <span class='keyword'>while</span> ((comma = strchr(p, ',')) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="7386"><td class="num" id="LN7386">7386</td><td class="line">                <span class='keyword'>int</span> deflen = (<span class='keyword'>int</span>)(comma - p);</td></tr>
<tr class="codeline" data-linenumber="7387"><td class="num" id="LN7387">7387</td><td class="line">                <span class='keyword'>char</span> buf[255];</td></tr>
<tr class="codeline" data-linenumber="7388"><td class="num" id="LN7388">7388</td><td class="line">                memcpy(buf, p, deflen);</td></tr>
<tr class="codeline" data-linenumber="7389"><td class="num" id="LN7389">7389</td><td class="line">                buf[deflen] = '\0';</td></tr>
<tr class="codeline" data-linenumber="7390"><td class="num" id="LN7390">7390</td><td class="line">                <span class='keyword'>for</span> (j = 0; j &lt; padding; j++) fprintf(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>, <span class='string_literal'>" "</span>);</td></tr>
<tr class="codeline" data-linenumber="7391"><td class="num" id="LN7391">7391</td><td class="line">                fprintf(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>, <span class='string_literal'>"  --cluster-%s\n"</span>, buf);</td></tr>
<tr class="codeline" data-linenumber="7392"><td class="num" id="LN7392">7392</td><td class="line">                p = comma + 1;</td></tr>
<tr class="codeline" data-linenumber="7393"><td class="num" id="LN7393">7393</td><td class="line">                <span class='keyword'>if</span> (p &gt;= eos) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="7394"><td class="num" id="LN7394">7394</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="7395"><td class="num" id="LN7395">7395</td><td class="line">            <span class='keyword'>if</span> (p &lt; eos) {</td></tr>
<tr class="codeline" data-linenumber="7396"><td class="num" id="LN7396">7396</td><td class="line">                <span class='keyword'>for</span> (j = 0; j &lt; padding; j++) fprintf(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>, <span class='string_literal'>" "</span>);</td></tr>
<tr class="codeline" data-linenumber="7397"><td class="num" id="LN7397">7397</td><td class="line">                fprintf(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>, <span class='string_literal'>"  --cluster-%s\n"</span>, p);</td></tr>
<tr class="codeline" data-linenumber="7398"><td class="num" id="LN7398">7398</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="7399"><td class="num" id="LN7399">7399</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="7400"><td class="num" id="LN7400">7400</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7401"><td class="num" id="LN7401">7401</td><td class="line">    fprintf(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>, <span class='string_literal'>"\nFor check, fix, reshard, del-node, set-timeout, "</span></td></tr>
<tr class="codeline" data-linenumber="7402"><td class="num" id="LN7402">7402</td><td class="line">                    <span class='string_literal'>"info, rebalance, call, import, backup you "</span></td></tr>
<tr class="codeline" data-linenumber="7403"><td class="num" id="LN7403">7403</td><td class="line">                    <span class='string_literal'>"can specify the host and port of any working node in "</span></td></tr>
<tr class="codeline" data-linenumber="7404"><td class="num" id="LN7404">7404</td><td class="line">                    <span class='string_literal'>"the cluster.\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="7405"><td class="num" id="LN7405">7405</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7406"><td class="num" id="LN7406">7406</td><td class="line">    <span class='keyword'>int</span> options_count = <span class='keyword'>sizeof</span>(clusterManagerOptions) /</td></tr>
<tr class="codeline" data-linenumber="7407"><td class="num" id="LN7407">7407</td><td class="line">                        <span class='keyword'>sizeof</span>(clusterManagerOptionDef);</td></tr>
<tr class="codeline" data-linenumber="7408"><td class="num" id="LN7408">7408</td><td class="line">    i = 0;</td></tr>
<tr class="codeline" data-linenumber="7409"><td class="num" id="LN7409">7409</td><td class="line">    fprintf(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>, <span class='string_literal'>"\nCluster Manager Options:\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="7410"><td class="num" id="LN7410">7410</td><td class="line">    <span class='keyword'>for</span> (; i &lt; options_count; i++) {</td></tr>
<tr class="codeline" data-linenumber="7411"><td class="num" id="LN7411">7411</td><td class="line">        clusterManagerOptionDef *def = &amp;(clusterManagerOptions[i]);</td></tr>
<tr class="codeline" data-linenumber="7412"><td class="num" id="LN7412">7412</td><td class="line">        <span class='keyword'>int</span> namelen = strlen(def-&gt;name), padlen = padding - namelen;</td></tr>
<tr class="codeline" data-linenumber="7413"><td class="num" id="LN7413">7413</td><td class="line">        fprintf(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>, <span class='string_literal'>"  %s"</span>, def-&gt;name);</td></tr>
<tr class="codeline" data-linenumber="7414"><td class="num" id="LN7414">7414</td><td class="line">        <span class='keyword'>for</span> (j = 0; j &lt; padlen; j++) fprintf(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>, <span class='string_literal'>" "</span>);</td></tr>
<tr class="codeline" data-linenumber="7415"><td class="num" id="LN7415">7415</td><td class="line">        fprintf(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>, <span class='string_literal'>"%s\n"</span>, def-&gt;desc);</td></tr>
<tr class="codeline" data-linenumber="7416"><td class="num" id="LN7416">7416</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7417"><td class="num" id="LN7417">7417</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7418"><td class="num" id="LN7418">7418</td><td class="line">    fprintf(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>, <span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="7419"><td class="num" id="LN7419">7419</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="7420"><td class="num" id="LN7420">7420</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="7421"><td class="num" id="LN7421">7421</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7422"><td class="num" id="LN7422">7422</td><td class="line"><span class='comment'>/*------------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="7423"><td class="num" id="LN7423">7423</td><td class="line"> <span class='comment'>* Latency and latency history modes</span></td></tr>
<tr class="codeline" data-linenumber="7424"><td class="num" id="LN7424">7424</td><td class="line"> <span class='comment'>*--------------------------------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="7425"><td class="num" id="LN7425">7425</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7426"><td class="num" id="LN7426">7426</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> latencyModePrint(<span class='keyword'>long</span> <span class='keyword'>long</span> min, <span class='keyword'>long</span> <span class='keyword'>long</span> max, <span class='keyword'>double</span> avg, <span class='keyword'>long</span> <span class='keyword'>long</span> count) {</td></tr>
<tr class="codeline" data-linenumber="7427"><td class="num" id="LN7427">7427</td><td class="line">    <span class='keyword'>if</span> (config.output == <span class='macro'>OUTPUT_STANDARD<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="7428"><td class="num" id="LN7428">7428</td><td class="line">        printf(<span class='string_literal'>"min: %lld, max: %lld, avg: %.2f (%lld samples)"</span>,</td></tr>
<tr class="codeline" data-linenumber="7429"><td class="num" id="LN7429">7429</td><td class="line">                min, max, avg, count);</td></tr>
<tr class="codeline" data-linenumber="7430"><td class="num" id="LN7430">7430</td><td class="line">        fflush(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>);</td></tr>
<tr class="codeline" data-linenumber="7431"><td class="num" id="LN7431">7431</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (config.output == <span class='macro'>OUTPUT_CSV<span class='macro_popup'>2</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="7432"><td class="num" id="LN7432">7432</td><td class="line">        printf(<span class='string_literal'>"%lld,%lld,%.2f,%lld\n"</span>, min, max, avg, count);</td></tr>
<tr class="codeline" data-linenumber="7433"><td class="num" id="LN7433">7433</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (config.output == <span class='macro'>OUTPUT_RAW<span class='macro_popup'>1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="7434"><td class="num" id="LN7434">7434</td><td class="line">        printf(<span class='string_literal'>"%lld %lld %.2f %lld\n"</span>, min, max, avg, count);</td></tr>
<tr class="codeline" data-linenumber="7435"><td class="num" id="LN7435">7435</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (config.output == <span class='macro'>OUTPUT_JSON<span class='macro_popup'>3</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="7436"><td class="num" id="LN7436">7436</td><td class="line">        printf(<span class='string_literal'>"{\"min\": %lld, \"max\": %lld, \"avg\": %.2f, \"count\": %lld}\n"</span>, min, max, avg, count);</td></tr>
<tr class="codeline" data-linenumber="7437"><td class="num" id="LN7437">7437</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7438"><td class="num" id="LN7438">7438</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="7439"><td class="num" id="LN7439">7439</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7440"><td class="num" id="LN7440">7440</td><td class="line"><span class='directive'>#define <span class='macro'>LATENCY_SAMPLE_RATE<span class='macro_popup'>10</span></span> 10 /* milliseconds. */</span></td></tr>
<tr class="codeline" data-linenumber="7441"><td class="num" id="LN7441">7441</td><td class="line"><span class='directive'>#define <span class='macro'>LATENCY_HISTORY_DEFAULT_INTERVAL<span class='macro_popup'>15000</span></span> 15000 /* milliseconds. */</span></td></tr>
<tr class="codeline" data-linenumber="7442"><td class="num" id="LN7442">7442</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> latencyMode(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="7443"><td class="num" id="LN7443">7443</td><td class="line">    redisReply *reply;</td></tr>
<tr class="codeline" data-linenumber="7444"><td class="num" id="LN7444">7444</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> start, latency, min = 0, max = 0, tot = 0, count = 0;</td></tr>
<tr class="codeline" data-linenumber="7445"><td class="num" id="LN7445">7445</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> history_interval =</td></tr>
<tr class="codeline" data-linenumber="7446"><td class="num" id="LN7446">7446</td><td class="line">        config.interval ? config.interval/1000 :</td></tr>
<tr class="codeline" data-linenumber="7447"><td class="num" id="LN7447">7447</td><td class="line">                          <span class='macro'>LATENCY_HISTORY_DEFAULT_INTERVAL<span class='macro_popup'>15000</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7448"><td class="num" id="LN7448">7448</td><td class="line">    <span class='keyword'>double</span> avg;</td></tr>
<tr class="codeline" data-linenumber="7449"><td class="num" id="LN7449">7449</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> history_start = mstime();</td></tr>
<tr class="codeline" data-linenumber="7450"><td class="num" id="LN7450">7450</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7451"><td class="num" id="LN7451">7451</td><td class="line">    <span class='comment'>/* Set a default for the interval in case of --latency option</span></td></tr>
<tr class="codeline" data-linenumber="7452"><td class="num" id="LN7452">7452</td><td class="line">     <span class='comment'>* with --raw, --csv or when it is redirected to non tty. */</span></td></tr>
<tr class="codeline" data-linenumber="7453"><td class="num" id="LN7453">7453</td><td class="line">    <span class='keyword'>if</span> (config.interval == 0) {</td></tr>
<tr class="codeline" data-linenumber="7454"><td class="num" id="LN7454">7454</td><td class="line">        config.interval = 1000;</td></tr>
<tr class="codeline" data-linenumber="7455"><td class="num" id="LN7455">7455</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="7456"><td class="num" id="LN7456">7456</td><td class="line">        config.interval /= 1000; <span class='comment'>/* We need to convert to milliseconds. */</span></td></tr>
<tr class="codeline" data-linenumber="7457"><td class="num" id="LN7457">7457</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7458"><td class="num" id="LN7458">7458</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7459"><td class="num" id="LN7459">7459</td><td class="line">    <span class='keyword'>if</span> (!context) exit(1);</td></tr>
<tr class="codeline" data-linenumber="7460"><td class="num" id="LN7460">7460</td><td class="line">    <span class='keyword'>while</span>(1) {</td></tr>
<tr class="codeline" data-linenumber="7461"><td class="num" id="LN7461">7461</td><td class="line">        start = mstime();</td></tr>
<tr class="codeline" data-linenumber="7462"><td class="num" id="LN7462">7462</td><td class="line">        reply = reconnectingRedisCommand(context,<span class='string_literal'>"PING"</span>);</td></tr>
<tr class="codeline" data-linenumber="7463"><td class="num" id="LN7463">7463</td><td class="line">        <span class='keyword'>if</span> (reply == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="7464"><td class="num" id="LN7464">7464</td><td class="line">            fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"\nI/O error\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="7465"><td class="num" id="LN7465">7465</td><td class="line">            exit(1);</td></tr>
<tr class="codeline" data-linenumber="7466"><td class="num" id="LN7466">7466</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="7467"><td class="num" id="LN7467">7467</td><td class="line">        latency = mstime()-start;</td></tr>
<tr class="codeline" data-linenumber="7468"><td class="num" id="LN7468">7468</td><td class="line">        freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="7469"><td class="num" id="LN7469">7469</td><td class="line">        count++;</td></tr>
<tr class="codeline" data-linenumber="7470"><td class="num" id="LN7470">7470</td><td class="line">        <span class='keyword'>if</span> (count == 1) {</td></tr>
<tr class="codeline" data-linenumber="7471"><td class="num" id="LN7471">7471</td><td class="line">            min = max = tot = latency;</td></tr>
<tr class="codeline" data-linenumber="7472"><td class="num" id="LN7472">7472</td><td class="line">            avg = (<span class='keyword'>double</span>) latency;</td></tr>
<tr class="codeline" data-linenumber="7473"><td class="num" id="LN7473">7473</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="7474"><td class="num" id="LN7474">7474</td><td class="line">            <span class='keyword'>if</span> (latency &lt; min) min = latency;</td></tr>
<tr class="codeline" data-linenumber="7475"><td class="num" id="LN7475">7475</td><td class="line">            <span class='keyword'>if</span> (latency &gt; max) max = latency;</td></tr>
<tr class="codeline" data-linenumber="7476"><td class="num" id="LN7476">7476</td><td class="line">            tot += latency;</td></tr>
<tr class="codeline" data-linenumber="7477"><td class="num" id="LN7477">7477</td><td class="line">            avg = (<span class='keyword'>double</span>) tot/count;</td></tr>
<tr class="codeline" data-linenumber="7478"><td class="num" id="LN7478">7478</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="7479"><td class="num" id="LN7479">7479</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7480"><td class="num" id="LN7480">7480</td><td class="line">        <span class='keyword'>if</span> (config.output == <span class='macro'>OUTPUT_STANDARD<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="7481"><td class="num" id="LN7481">7481</td><td class="line">            printf(<span class='string_literal'>"\x1b[0G\x1b[2K"</span>); <span class='comment'>/* Clear the line. */</span></td></tr>
<tr class="codeline" data-linenumber="7482"><td class="num" id="LN7482">7482</td><td class="line">            latencyModePrint(min,max,avg,count);</td></tr>
<tr class="codeline" data-linenumber="7483"><td class="num" id="LN7483">7483</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="7484"><td class="num" id="LN7484">7484</td><td class="line">            <span class='keyword'>if</span> (config.latency_history) {</td></tr>
<tr class="codeline" data-linenumber="7485"><td class="num" id="LN7485">7485</td><td class="line">                latencyModePrint(min,max,avg,count);</td></tr>
<tr class="codeline" data-linenumber="7486"><td class="num" id="LN7486">7486</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (mstime()-history_start &gt; config.interval) {</td></tr>
<tr class="codeline" data-linenumber="7487"><td class="num" id="LN7487">7487</td><td class="line">                latencyModePrint(min,max,avg,count);</td></tr>
<tr class="codeline" data-linenumber="7488"><td class="num" id="LN7488">7488</td><td class="line">                exit(0);</td></tr>
<tr class="codeline" data-linenumber="7489"><td class="num" id="LN7489">7489</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="7490"><td class="num" id="LN7490">7490</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="7491"><td class="num" id="LN7491">7491</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7492"><td class="num" id="LN7492">7492</td><td class="line">        <span class='keyword'>if</span> (config.latency_history &amp;&amp; mstime()-history_start &gt; history_interval)</td></tr>
<tr class="codeline" data-linenumber="7493"><td class="num" id="LN7493">7493</td><td class="line">        {</td></tr>
<tr class="codeline" data-linenumber="7494"><td class="num" id="LN7494">7494</td><td class="line">            printf(<span class='string_literal'>" -- %.2f seconds range\n"</span>, (<span class='keyword'>float</span>)(mstime()-history_start)/1000);</td></tr>
<tr class="codeline" data-linenumber="7495"><td class="num" id="LN7495">7495</td><td class="line">            history_start = mstime();</td></tr>
<tr class="codeline" data-linenumber="7496"><td class="num" id="LN7496">7496</td><td class="line">            min = max = tot = count = 0;</td></tr>
<tr class="codeline" data-linenumber="7497"><td class="num" id="LN7497">7497</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="7498"><td class="num" id="LN7498">7498</td><td class="line">        usleep(<span class='macro'>LATENCY_SAMPLE_RATE<span class='macro_popup'>10</span></span> * 1000);</td></tr>
<tr class="codeline" data-linenumber="7499"><td class="num" id="LN7499">7499</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7500"><td class="num" id="LN7500">7500</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="7501"><td class="num" id="LN7501">7501</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7502"><td class="num" id="LN7502">7502</td><td class="line"><span class='comment'>/*------------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="7503"><td class="num" id="LN7503">7503</td><td class="line"> <span class='comment'>* Latency distribution mode -- requires 256 colors xterm</span></td></tr>
<tr class="codeline" data-linenumber="7504"><td class="num" id="LN7504">7504</td><td class="line"> <span class='comment'>*--------------------------------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="7505"><td class="num" id="LN7505">7505</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7506"><td class="num" id="LN7506">7506</td><td class="line"><span class='directive'>#define <span class='macro'>LATENCY_DIST_DEFAULT_INTERVAL<span class='macro_popup'>1000</span></span> 1000 /* milliseconds. */</span></td></tr>
<tr class="codeline" data-linenumber="7507"><td class="num" id="LN7507">7507</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7508"><td class="num" id="LN7508">7508</td><td class="line"><span class='comment'>/* Structure to store samples distribution. */</span></td></tr>
<tr class="codeline" data-linenumber="7509"><td class="num" id="LN7509">7509</td><td class="line"><span class='keyword'>struct</span> distsamples {</td></tr>
<tr class="codeline" data-linenumber="7510"><td class="num" id="LN7510">7510</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> max;   <span class='comment'>/* Max latency to fit into this interval (usec). */</span></td></tr>
<tr class="codeline" data-linenumber="7511"><td class="num" id="LN7511">7511</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> count; <span class='comment'>/* Number of samples in this interval. */</span></td></tr>
<tr class="codeline" data-linenumber="7512"><td class="num" id="LN7512">7512</td><td class="line">    <span class='keyword'>int</span> character;   <span class='comment'>/* Associated character in visualization. */</span></td></tr>
<tr class="codeline" data-linenumber="7513"><td class="num" id="LN7513">7513</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="7514"><td class="num" id="LN7514">7514</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7515"><td class="num" id="LN7515">7515</td><td class="line"><span class='comment'>/* Helper function for latencyDistMode(). Performs the spectrum visualization</span></td></tr>
<tr class="codeline" data-linenumber="7516"><td class="num" id="LN7516">7516</td><td class="line"> <span class='comment'>* of the collected samples targeting an xterm 256 terminal.</span></td></tr>
<tr class="codeline" data-linenumber="7517"><td class="num" id="LN7517">7517</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="7518"><td class="num" id="LN7518">7518</td><td class="line"> <span class='comment'>* Takes an array of distsamples structures, ordered from smaller to bigger</span></td></tr>
<tr class="codeline" data-linenumber="7519"><td class="num" id="LN7519">7519</td><td class="line"> <span class='comment'>* 'max' value. Last sample max must be 0, to mean that it holds all the</span></td></tr>
<tr class="codeline" data-linenumber="7520"><td class="num" id="LN7520">7520</td><td class="line"> <span class='comment'>* samples greater than the previous one, and is also the stop sentinel.</span></td></tr>
<tr class="codeline" data-linenumber="7521"><td class="num" id="LN7521">7521</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="7522"><td class="num" id="LN7522">7522</td><td class="line"> <span class='comment'>* "tot' is the total number of samples in the different buckets, so it</span></td></tr>
<tr class="codeline" data-linenumber="7523"><td class="num" id="LN7523">7523</td><td class="line"> <span class='comment'>* is the SUM(samples[i].count) for i to 0 up to the max sample.</span></td></tr>
<tr class="codeline" data-linenumber="7524"><td class="num" id="LN7524">7524</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="7525"><td class="num" id="LN7525">7525</td><td class="line"> <span class='comment'>* As a side effect the function sets all the buckets count to 0. */</span></td></tr>
<tr class="codeline" data-linenumber="7526"><td class="num" id="LN7526">7526</td><td class="line"><span class='keyword'>void</span> showLatencyDistSamples(<span class='keyword'>struct</span> distsamples *samples, <span class='keyword'>long</span> <span class='keyword'>long</span> tot) {</td></tr>
<tr class="codeline" data-linenumber="7527"><td class="num" id="LN7527">7527</td><td class="line">    <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="7528"><td class="num" id="LN7528">7528</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7529"><td class="num" id="LN7529">7529</td><td class="line">     <span class='comment'>/* We convert samples into an index inside the palette</span></td></tr>
<tr class="codeline" data-linenumber="7530"><td class="num" id="LN7530">7530</td><td class="line">     <span class='comment'>* proportional to the percentage a given bucket represents.</span></td></tr>
<tr class="codeline" data-linenumber="7531"><td class="num" id="LN7531">7531</td><td class="line">     <span class='comment'>* This way intensity of the different parts of the spectrum</span></td></tr>
<tr class="codeline" data-linenumber="7532"><td class="num" id="LN7532">7532</td><td class="line">     <span class='comment'>* don't change relative to the number of requests, which avoids to</span></td></tr>
<tr class="codeline" data-linenumber="7533"><td class="num" id="LN7533">7533</td><td class="line">     <span class='comment'>* pollute the visualization with non-latency related info. */</span></td></tr>
<tr class="codeline" data-linenumber="7534"><td class="num" id="LN7534">7534</td><td class="line">    printf(<span class='string_literal'>"\033[38;5;0m"</span>); <span class='comment'>/* Set foreground color to black. */</span></td></tr>
<tr class="codeline" data-linenumber="7535"><td class="num" id="LN7535">7535</td><td class="line">    <span class='keyword'>for</span> (j = 0; ; j++) {</td></tr>
<tr class="codeline" data-linenumber="7536"><td class="num" id="LN7536">7536</td><td class="line">        <span class='keyword'>int</span> coloridx =</td></tr>
<tr class="codeline" data-linenumber="7537"><td class="num" id="LN7537">7537</td><td class="line">            ceil((<span class='keyword'>double</span>) samples[j].count / tot * (spectrum_palette_size-1));</td></tr>
<tr class="codeline" data-linenumber="7538"><td class="num" id="LN7538">7538</td><td class="line">        <span class='keyword'>int</span> color = spectrum_palette[coloridx];</td></tr>
<tr class="codeline" data-linenumber="7539"><td class="num" id="LN7539">7539</td><td class="line">        printf(<span class='string_literal'>"\033[48;5;%dm%c"</span>, (<span class='keyword'>int</span>)color, samples[j].character);</td></tr>
<tr class="codeline" data-linenumber="7540"><td class="num" id="LN7540">7540</td><td class="line">        samples[j].count = 0;</td></tr>
<tr class="codeline" data-linenumber="7541"><td class="num" id="LN7541">7541</td><td class="line">        <span class='keyword'>if</span> (samples[j].max == 0) <span class='keyword'>break</span>; <span class='comment'>/* Last sample. */</span></td></tr>
<tr class="codeline" data-linenumber="7542"><td class="num" id="LN7542">7542</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7543"><td class="num" id="LN7543">7543</td><td class="line">    printf(<span class='string_literal'>"\033[0m\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="7544"><td class="num" id="LN7544">7544</td><td class="line">    fflush(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>);</td></tr>
<tr class="codeline" data-linenumber="7545"><td class="num" id="LN7545">7545</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="7546"><td class="num" id="LN7546">7546</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7547"><td class="num" id="LN7547">7547</td><td class="line"><span class='comment'>/* Show the legend: different buckets values and colors meaning, so</span></td></tr>
<tr class="codeline" data-linenumber="7548"><td class="num" id="LN7548">7548</td><td class="line"> <span class='comment'>* that the spectrum is more easily readable. */</span></td></tr>
<tr class="codeline" data-linenumber="7549"><td class="num" id="LN7549">7549</td><td class="line"><span class='keyword'>void</span> showLatencyDistLegend(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="7550"><td class="num" id="LN7550">7550</td><td class="line">    <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="7551"><td class="num" id="LN7551">7551</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7552"><td class="num" id="LN7552">7552</td><td class="line">    printf(<span class='string_literal'>"---------------------------------------------\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="7553"><td class="num" id="LN7553">7553</td><td class="line">    printf(<span class='string_literal'>". - * #          .01 .125 .25 .5 milliseconds\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="7554"><td class="num" id="LN7554">7554</td><td class="line">    printf(<span class='string_literal'>"1,2,3,...,9      from 1 to 9     milliseconds\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="7555"><td class="num" id="LN7555">7555</td><td class="line">    printf(<span class='string_literal'>"A,B,C,D,E        10,20,30,40,50  milliseconds\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="7556"><td class="num" id="LN7556">7556</td><td class="line">    printf(<span class='string_literal'>"F,G,H,I,J        .1,.2,.3,.4,.5       seconds\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="7557"><td class="num" id="LN7557">7557</td><td class="line">    printf(<span class='string_literal'>"K,L,M,N,O,P,Q,?  1,2,4,8,16,30,60,&gt;60 seconds\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="7558"><td class="num" id="LN7558">7558</td><td class="line">    printf(<span class='string_literal'>"From 0 to 100%%: "</span>);</td></tr>
<tr class="codeline" data-linenumber="7559"><td class="num" id="LN7559">7559</td><td class="line">    <span class='keyword'>for</span> (j = 0; j &lt; spectrum_palette_size; j++) {</td></tr>
<tr class="codeline" data-linenumber="7560"><td class="num" id="LN7560">7560</td><td class="line">        printf(<span class='string_literal'>"\033[48;5;%dm "</span>, spectrum_palette[j]);</td></tr>
<tr class="codeline" data-linenumber="7561"><td class="num" id="LN7561">7561</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7562"><td class="num" id="LN7562">7562</td><td class="line">    printf(<span class='string_literal'>"\033[0m\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="7563"><td class="num" id="LN7563">7563</td><td class="line">    printf(<span class='string_literal'>"---------------------------------------------\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="7564"><td class="num" id="LN7564">7564</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="7565"><td class="num" id="LN7565">7565</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7566"><td class="num" id="LN7566">7566</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> latencyDistMode(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="7567"><td class="num" id="LN7567">7567</td><td class="line">    redisReply *reply;</td></tr>
<tr class="codeline" data-linenumber="7568"><td class="num" id="LN7568">7568</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> start, latency, count = 0;</td></tr>
<tr class="codeline" data-linenumber="7569"><td class="num" id="LN7569">7569</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> history_interval =</td></tr>
<tr class="codeline" data-linenumber="7570"><td class="num" id="LN7570">7570</td><td class="line">        config.interval ? config.interval/1000 :</td></tr>
<tr class="codeline" data-linenumber="7571"><td class="num" id="LN7571">7571</td><td class="line">                          <span class='macro'>LATENCY_DIST_DEFAULT_INTERVAL<span class='macro_popup'>1000</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7572"><td class="num" id="LN7572">7572</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> history_start = ustime();</td></tr>
<tr class="codeline" data-linenumber="7573"><td class="num" id="LN7573">7573</td><td class="line">    <span class='keyword'>int</span> j, outputs = 0;</td></tr>
<tr class="codeline" data-linenumber="7574"><td class="num" id="LN7574">7574</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7575"><td class="num" id="LN7575">7575</td><td class="line">    <span class='keyword'>struct</span> distsamples samples[] = {</td></tr>
<tr class="codeline" data-linenumber="7576"><td class="num" id="LN7576">7576</td><td class="line">        <span class='comment'>/* We use a mostly logarithmic scale, with certain linear intervals</span></td></tr>
<tr class="codeline" data-linenumber="7577"><td class="num" id="LN7577">7577</td><td class="line">         <span class='comment'>* which are more interesting than others, like 1-10 milliseconds</span></td></tr>
<tr class="codeline" data-linenumber="7578"><td class="num" id="LN7578">7578</td><td class="line">         <span class='comment'>* range. */</span></td></tr>
<tr class="codeline" data-linenumber="7579"><td class="num" id="LN7579">7579</td><td class="line">        {10,0,'.'},         <span class='comment'>/* 0.01 ms */</span></td></tr>
<tr class="codeline" data-linenumber="7580"><td class="num" id="LN7580">7580</td><td class="line">        {125,0,'-'},        <span class='comment'>/* 0.125 ms */</span></td></tr>
<tr class="codeline" data-linenumber="7581"><td class="num" id="LN7581">7581</td><td class="line">        {250,0,'*'},        <span class='comment'>/* 0.25 ms */</span></td></tr>
<tr class="codeline" data-linenumber="7582"><td class="num" id="LN7582">7582</td><td class="line">        {500,0,'#'},        <span class='comment'>/* 0.5 ms */</span></td></tr>
<tr class="codeline" data-linenumber="7583"><td class="num" id="LN7583">7583</td><td class="line">        {1000,0,'1'},       <span class='comment'>/* 1 ms */</span></td></tr>
<tr class="codeline" data-linenumber="7584"><td class="num" id="LN7584">7584</td><td class="line">        {2000,0,'2'},       <span class='comment'>/* 2 ms */</span></td></tr>
<tr class="codeline" data-linenumber="7585"><td class="num" id="LN7585">7585</td><td class="line">        {3000,0,'3'},       <span class='comment'>/* 3 ms */</span></td></tr>
<tr class="codeline" data-linenumber="7586"><td class="num" id="LN7586">7586</td><td class="line">        {4000,0,'4'},       <span class='comment'>/* 4 ms */</span></td></tr>
<tr class="codeline" data-linenumber="7587"><td class="num" id="LN7587">7587</td><td class="line">        {5000,0,'5'},       <span class='comment'>/* 5 ms */</span></td></tr>
<tr class="codeline" data-linenumber="7588"><td class="num" id="LN7588">7588</td><td class="line">        {6000,0,'6'},       <span class='comment'>/* 6 ms */</span></td></tr>
<tr class="codeline" data-linenumber="7589"><td class="num" id="LN7589">7589</td><td class="line">        {7000,0,'7'},       <span class='comment'>/* 7 ms */</span></td></tr>
<tr class="codeline" data-linenumber="7590"><td class="num" id="LN7590">7590</td><td class="line">        {8000,0,'8'},       <span class='comment'>/* 8 ms */</span></td></tr>
<tr class="codeline" data-linenumber="7591"><td class="num" id="LN7591">7591</td><td class="line">        {9000,0,'9'},       <span class='comment'>/* 9 ms */</span></td></tr>
<tr class="codeline" data-linenumber="7592"><td class="num" id="LN7592">7592</td><td class="line">        {10000,0,'A'},      <span class='comment'>/* 10 ms */</span></td></tr>
<tr class="codeline" data-linenumber="7593"><td class="num" id="LN7593">7593</td><td class="line">        {20000,0,'B'},      <span class='comment'>/* 20 ms */</span></td></tr>
<tr class="codeline" data-linenumber="7594"><td class="num" id="LN7594">7594</td><td class="line">        {30000,0,'C'},      <span class='comment'>/* 30 ms */</span></td></tr>
<tr class="codeline" data-linenumber="7595"><td class="num" id="LN7595">7595</td><td class="line">        {40000,0,'D'},      <span class='comment'>/* 40 ms */</span></td></tr>
<tr class="codeline" data-linenumber="7596"><td class="num" id="LN7596">7596</td><td class="line">        {50000,0,'E'},      <span class='comment'>/* 50 ms */</span></td></tr>
<tr class="codeline" data-linenumber="7597"><td class="num" id="LN7597">7597</td><td class="line">        {100000,0,'F'},     <span class='comment'>/* 0.1 s */</span></td></tr>
<tr class="codeline" data-linenumber="7598"><td class="num" id="LN7598">7598</td><td class="line">        {200000,0,'G'},     <span class='comment'>/* 0.2 s */</span></td></tr>
<tr class="codeline" data-linenumber="7599"><td class="num" id="LN7599">7599</td><td class="line">        {300000,0,'H'},     <span class='comment'>/* 0.3 s */</span></td></tr>
<tr class="codeline" data-linenumber="7600"><td class="num" id="LN7600">7600</td><td class="line">        {400000,0,'I'},     <span class='comment'>/* 0.4 s */</span></td></tr>
<tr class="codeline" data-linenumber="7601"><td class="num" id="LN7601">7601</td><td class="line">        {500000,0,'J'},     <span class='comment'>/* 0.5 s */</span></td></tr>
<tr class="codeline" data-linenumber="7602"><td class="num" id="LN7602">7602</td><td class="line">        {1000000,0,'K'},    <span class='comment'>/* 1 s */</span></td></tr>
<tr class="codeline" data-linenumber="7603"><td class="num" id="LN7603">7603</td><td class="line">        {2000000,0,'L'},    <span class='comment'>/* 2 s */</span></td></tr>
<tr class="codeline" data-linenumber="7604"><td class="num" id="LN7604">7604</td><td class="line">        {4000000,0,'M'},    <span class='comment'>/* 4 s */</span></td></tr>
<tr class="codeline" data-linenumber="7605"><td class="num" id="LN7605">7605</td><td class="line">        {8000000,0,'N'},    <span class='comment'>/* 8 s */</span></td></tr>
<tr class="codeline" data-linenumber="7606"><td class="num" id="LN7606">7606</td><td class="line">        {16000000,0,'O'},   <span class='comment'>/* 16 s */</span></td></tr>
<tr class="codeline" data-linenumber="7607"><td class="num" id="LN7607">7607</td><td class="line">        {30000000,0,'P'},   <span class='comment'>/* 30 s */</span></td></tr>
<tr class="codeline" data-linenumber="7608"><td class="num" id="LN7608">7608</td><td class="line">        {60000000,0,'Q'},   <span class='comment'>/* 1 minute */</span></td></tr>
<tr class="codeline" data-linenumber="7609"><td class="num" id="LN7609">7609</td><td class="line">        {0,0,'?'},          <span class='comment'>/* &gt; 1 minute */</span></td></tr>
<tr class="codeline" data-linenumber="7610"><td class="num" id="LN7610">7610</td><td class="line">    };</td></tr>
<tr class="codeline" data-linenumber="7611"><td class="num" id="LN7611">7611</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7612"><td class="num" id="LN7612">7612</td><td class="line">    <span class='keyword'>if</span> (!context) exit(1);</td></tr>
<tr class="codeline" data-linenumber="7613"><td class="num" id="LN7613">7613</td><td class="line">    <span class='keyword'>while</span>(1) {</td></tr>
<tr class="codeline" data-linenumber="7614"><td class="num" id="LN7614">7614</td><td class="line">        start = ustime();</td></tr>
<tr class="codeline" data-linenumber="7615"><td class="num" id="LN7615">7615</td><td class="line">        reply = reconnectingRedisCommand(context,<span class='string_literal'>"PING"</span>);</td></tr>
<tr class="codeline" data-linenumber="7616"><td class="num" id="LN7616">7616</td><td class="line">        <span class='keyword'>if</span> (reply == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="7617"><td class="num" id="LN7617">7617</td><td class="line">            fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"\nI/O error\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="7618"><td class="num" id="LN7618">7618</td><td class="line">            exit(1);</td></tr>
<tr class="codeline" data-linenumber="7619"><td class="num" id="LN7619">7619</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="7620"><td class="num" id="LN7620">7620</td><td class="line">        latency = ustime()-start;</td></tr>
<tr class="codeline" data-linenumber="7621"><td class="num" id="LN7621">7621</td><td class="line">        freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="7622"><td class="num" id="LN7622">7622</td><td class="line">        count++;</td></tr>
<tr class="codeline" data-linenumber="7623"><td class="num" id="LN7623">7623</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7624"><td class="num" id="LN7624">7624</td><td class="line">        <span class='comment'>/* Populate the relevant bucket. */</span></td></tr>
<tr class="codeline" data-linenumber="7625"><td class="num" id="LN7625">7625</td><td class="line">        <span class='keyword'>for</span> (j = 0; ; j++) {</td></tr>
<tr class="codeline" data-linenumber="7626"><td class="num" id="LN7626">7626</td><td class="line">            <span class='keyword'>if</span> (samples[j].max == 0 || latency &lt;= samples[j].max) {</td></tr>
<tr class="codeline" data-linenumber="7627"><td class="num" id="LN7627">7627</td><td class="line">                samples[j].count++;</td></tr>
<tr class="codeline" data-linenumber="7628"><td class="num" id="LN7628">7628</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="7629"><td class="num" id="LN7629">7629</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="7630"><td class="num" id="LN7630">7630</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="7631"><td class="num" id="LN7631">7631</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7632"><td class="num" id="LN7632">7632</td><td class="line">        <span class='comment'>/* From time to time show the spectrum. */</span></td></tr>
<tr class="codeline" data-linenumber="7633"><td class="num" id="LN7633">7633</td><td class="line">        <span class='keyword'>if</span> (count &amp;&amp; (ustime()-history_start)/1000 &gt; history_interval) {</td></tr>
<tr class="codeline" data-linenumber="7634"><td class="num" id="LN7634">7634</td><td class="line">            <span class='keyword'>if</span> ((outputs++ % 20) == 0)</td></tr>
<tr class="codeline" data-linenumber="7635"><td class="num" id="LN7635">7635</td><td class="line">                showLatencyDistLegend();</td></tr>
<tr class="codeline" data-linenumber="7636"><td class="num" id="LN7636">7636</td><td class="line">            showLatencyDistSamples(samples,count);</td></tr>
<tr class="codeline" data-linenumber="7637"><td class="num" id="LN7637">7637</td><td class="line">            history_start = ustime();</td></tr>
<tr class="codeline" data-linenumber="7638"><td class="num" id="LN7638">7638</td><td class="line">            count = 0;</td></tr>
<tr class="codeline" data-linenumber="7639"><td class="num" id="LN7639">7639</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="7640"><td class="num" id="LN7640">7640</td><td class="line">        usleep(<span class='macro'>LATENCY_SAMPLE_RATE<span class='macro_popup'>10</span></span> * 1000);</td></tr>
<tr class="codeline" data-linenumber="7641"><td class="num" id="LN7641">7641</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7642"><td class="num" id="LN7642">7642</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="7643"><td class="num" id="LN7643">7643</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7644"><td class="num" id="LN7644">7644</td><td class="line"><span class='comment'>/*------------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="7645"><td class="num" id="LN7645">7645</td><td class="line"> <span class='comment'>* Slave mode</span></td></tr>
<tr class="codeline" data-linenumber="7646"><td class="num" id="LN7646">7646</td><td class="line"> <span class='comment'>*--------------------------------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="7647"><td class="num" id="LN7647">7647</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7648"><td class="num" id="LN7648">7648</td><td class="line"><span class='directive'>#define <span class='macro'>RDB_EOF_MARK_SIZE<span class='macro_popup'>40</span></span> 40</span></td></tr>
<tr class="codeline" data-linenumber="7649"><td class="num" id="LN7649">7649</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7650"><td class="num" id="LN7650">7650</td><td class="line"><span class='keyword'>int</span> sendReplconf(<span class='keyword'>const</span> <span class='keyword'>char</span>* arg1, <span class='keyword'>const</span> <span class='keyword'>char</span>* arg2) {</td></tr>
<tr class="codeline" data-linenumber="7651"><td class="num" id="LN7651">7651</td><td class="line">    <span class='keyword'>int</span> res = 1;</td></tr>
<tr class="codeline" data-linenumber="7652"><td class="num" id="LN7652">7652</td><td class="line">    fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"sending REPLCONF %s %s\n"</span>, arg1, arg2);</td></tr>
<tr class="codeline" data-linenumber="7653"><td class="num" id="LN7653">7653</td><td class="line">    redisReply *reply = redisCommand(context, <span class='string_literal'>"REPLCONF %s %s"</span>, arg1, arg2);</td></tr>
<tr class="codeline" data-linenumber="7654"><td class="num" id="LN7654">7654</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7655"><td class="num" id="LN7655">7655</td><td class="line">    <span class='comment'>/* Handle any error conditions */</span></td></tr>
<tr class="codeline" data-linenumber="7656"><td class="num" id="LN7656">7656</td><td class="line">    <span class='keyword'>if</span>(reply == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="7657"><td class="num" id="LN7657">7657</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"\nI/O error\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="7658"><td class="num" id="LN7658">7658</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="7659"><td class="num" id="LN7659">7659</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span>(reply-&gt;type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="7660"><td class="num" id="LN7660">7660</td><td class="line">        <span class='comment'>/* non fatal, old versions may not support it */</span></td></tr>
<tr class="codeline" data-linenumber="7661"><td class="num" id="LN7661">7661</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"REPLCONF %s error: %s\n"</span>, arg1, reply-&gt;str);</td></tr>
<tr class="codeline" data-linenumber="7662"><td class="num" id="LN7662">7662</td><td class="line">        res = 0;</td></tr>
<tr class="codeline" data-linenumber="7663"><td class="num" id="LN7663">7663</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7664"><td class="num" id="LN7664">7664</td><td class="line">    freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="7665"><td class="num" id="LN7665">7665</td><td class="line">    <span class='keyword'>return</span> res;</td></tr>
<tr class="codeline" data-linenumber="7666"><td class="num" id="LN7666">7666</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="7667"><td class="num" id="LN7667">7667</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7668"><td class="num" id="LN7668">7668</td><td class="line"><span class='keyword'>void</span> sendCapa() {</td></tr>
<tr class="codeline" data-linenumber="7669"><td class="num" id="LN7669">7669</td><td class="line">    sendReplconf(<span class='string_literal'>"capa"</span>, <span class='string_literal'>"eof"</span>);</td></tr>
<tr class="codeline" data-linenumber="7670"><td class="num" id="LN7670">7670</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="7671"><td class="num" id="LN7671">7671</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7672"><td class="num" id="LN7672">7672</td><td class="line"><span class='keyword'>void</span> sendRdbOnly(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="7673"><td class="num" id="LN7673">7673</td><td class="line">    sendReplconf(<span class='string_literal'>"rdb-only"</span>, <span class='string_literal'>"1"</span>);</td></tr>
<tr class="codeline" data-linenumber="7674"><td class="num" id="LN7674">7674</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="7675"><td class="num" id="LN7675">7675</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7676"><td class="num" id="LN7676">7676</td><td class="line"><span class='comment'>/* Read raw bytes through a redisContext. The read operation is not greedy</span></td></tr>
<tr class="codeline" data-linenumber="7677"><td class="num" id="LN7677">7677</td><td class="line"> <span class='comment'>* and may not fill the buffer entirely.</span></td></tr>
<tr class="codeline" data-linenumber="7678"><td class="num" id="LN7678">7678</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="7679"><td class="num" id="LN7679">7679</td><td class="line"><span class='keyword'>static</span> ssize_t readConn(redisContext *c, <span class='keyword'>char</span> *buf, size_t len)</td></tr>
<tr class="codeline" data-linenumber="7680"><td class="num" id="LN7680">7680</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="7681"><td class="num" id="LN7681">7681</td><td class="line">    <span class='keyword'>return</span> c-&gt;funcs-&gt;read(c, buf, len);</td></tr>
<tr class="codeline" data-linenumber="7682"><td class="num" id="LN7682">7682</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="7683"><td class="num" id="LN7683">7683</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7684"><td class="num" id="LN7684">7684</td><td class="line"><span class='comment'>/* Sends SYNC and reads the number of bytes in the payload. Used both by</span></td></tr>
<tr class="codeline" data-linenumber="7685"><td class="num" id="LN7685">7685</td><td class="line"> <span class='comment'>* slaveMode() and getRDB().</span></td></tr>
<tr class="codeline" data-linenumber="7686"><td class="num" id="LN7686">7686</td><td class="line"> <span class='comment'>* returns 0 in case an EOF marker is used. */</span></td></tr>
<tr class="codeline" data-linenumber="7687"><td class="num" id="LN7687">7687</td><td class="line"><span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> sendSync(redisContext *c, <span class='keyword'>char</span> *out_eof) {</td></tr>
<tr class="codeline" data-linenumber="7688"><td class="num" id="LN7688">7688</td><td class="line">    <span class='comment'>/* To start we need to send the SYNC command and return the payload.</span></td></tr>
<tr class="codeline" data-linenumber="7689"><td class="num" id="LN7689">7689</td><td class="line">     <span class='comment'>* The hiredis client lib does not understand this part of the protocol</span></td></tr>
<tr class="codeline" data-linenumber="7690"><td class="num" id="LN7690">7690</td><td class="line">     <span class='comment'>* and we don't want to mess with its buffers, so everything is performed</span></td></tr>
<tr class="codeline" data-linenumber="7691"><td class="num" id="LN7691">7691</td><td class="line">     <span class='comment'>* using direct low-level I/O. */</span></td></tr>
<tr class="codeline" data-linenumber="7692"><td class="num" id="LN7692">7692</td><td class="line">    <span class='keyword'>char</span> buf[4096], *p;</td></tr>
<tr class="codeline" data-linenumber="7693"><td class="num" id="LN7693">7693</td><td class="line">    ssize_t nread;</td></tr>
<tr class="codeline" data-linenumber="7694"><td class="num" id="LN7694">7694</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7695"><td class="num" id="LN7695">7695</td><td class="line">    <span class='comment'>/* Send the SYNC command. */</span></td></tr>
<tr class="codeline" data-linenumber="7696"><td class="num" id="LN7696">7696</td><td class="line">    <span class='keyword'>if</span> (cliWriteConn(c, <span class='string_literal'>"SYNC\r\n"</span>, 6) != 6) {</td></tr>
<tr class="codeline" data-linenumber="7697"><td class="num" id="LN7697">7697</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"Error writing to master\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="7698"><td class="num" id="LN7698">7698</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="7699"><td class="num" id="LN7699">7699</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7700"><td class="num" id="LN7700">7700</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7701"><td class="num" id="LN7701">7701</td><td class="line">    <span class='comment'>/* Read $&lt;payload&gt;\r\n, making sure to read just up to "\n" */</span></td></tr>
<tr class="codeline" data-linenumber="7702"><td class="num" id="LN7702">7702</td><td class="line">    p = buf;</td></tr>
<tr class="codeline" data-linenumber="7703"><td class="num" id="LN7703">7703</td><td class="line">    <span class='keyword'>while</span>(1) {</td></tr>
<tr class="codeline" data-linenumber="7704"><td class="num" id="LN7704">7704</td><td class="line">        nread = readConn(c,p,1);</td></tr>
<tr class="codeline" data-linenumber="7705"><td class="num" id="LN7705">7705</td><td class="line">        <span class='keyword'>if</span> (nread &lt;= 0) {</td></tr>
<tr class="codeline" data-linenumber="7706"><td class="num" id="LN7706">7706</td><td class="line">            fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"Error reading bulk length while SYNCing\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="7707"><td class="num" id="LN7707">7707</td><td class="line">            exit(1);</td></tr>
<tr class="codeline" data-linenumber="7708"><td class="num" id="LN7708">7708</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="7709"><td class="num" id="LN7709">7709</td><td class="line">        <span class='keyword'>if</span> (*p == '\n' &amp;&amp; p != buf) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="7710"><td class="num" id="LN7710">7710</td><td class="line">        <span class='keyword'>if</span> (*p != '\n') p++;</td></tr>
<tr class="codeline" data-linenumber="7711"><td class="num" id="LN7711">7711</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7712"><td class="num" id="LN7712">7712</td><td class="line">    *p = '\0';</td></tr>
<tr class="codeline" data-linenumber="7713"><td class="num" id="LN7713">7713</td><td class="line">    <span class='keyword'>if</span> (buf[0] == '-') {</td></tr>
<tr class="codeline" data-linenumber="7714"><td class="num" id="LN7714">7714</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"SYNC with master failed: %s\n"</span>, buf);</td></tr>
<tr class="codeline" data-linenumber="7715"><td class="num" id="LN7715">7715</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="7716"><td class="num" id="LN7716">7716</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7717"><td class="num" id="LN7717">7717</td><td class="line">    <span class='keyword'>if</span> (strncmp(buf+1,<span class='string_literal'>"EOF:"</span>,4) == 0 &amp;&amp; strlen(buf+5) &gt;= <span class='macro'>RDB_EOF_MARK_SIZE<span class='macro_popup'>40</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="7718"><td class="num" id="LN7718">7718</td><td class="line">        memcpy(out_eof, buf+5, <span class='macro'>RDB_EOF_MARK_SIZE<span class='macro_popup'>40</span></span>);</td></tr>
<tr class="codeline" data-linenumber="7719"><td class="num" id="LN7719">7719</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="7720"><td class="num" id="LN7720">7720</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7721"><td class="num" id="LN7721">7721</td><td class="line">    <span class='keyword'>return</span> strtoull(buf+1,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,10);</td></tr>
<tr class="codeline" data-linenumber="7722"><td class="num" id="LN7722">7722</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="7723"><td class="num" id="LN7723">7723</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7724"><td class="num" id="LN7724">7724</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> slaveMode(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="7725"><td class="num" id="LN7725">7725</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>char</span> eofmark[<span class='macro'>RDB_EOF_MARK_SIZE<span class='macro_popup'>40</span></span>];</td></tr>
<tr class="codeline" data-linenumber="7726"><td class="num" id="LN7726">7726</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>char</span> lastbytes[<span class='macro'>RDB_EOF_MARK_SIZE<span class='macro_popup'>40</span></span>];</td></tr>
<tr class="codeline" data-linenumber="7727"><td class="num" id="LN7727">7727</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>int</span> usemark = 0;</td></tr>
<tr class="codeline" data-linenumber="7728"><td class="num" id="LN7728">7728</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> payload = sendSync(context,eofmark);</td></tr>
<tr class="codeline" data-linenumber="7729"><td class="num" id="LN7729">7729</td><td class="line">    <span class='keyword'>char</span> buf[1024];</td></tr>
<tr class="codeline" data-linenumber="7730"><td class="num" id="LN7730">7730</td><td class="line">    <span class='keyword'>int</span> original_output = config.output;</td></tr>
<tr class="codeline" data-linenumber="7731"><td class="num" id="LN7731">7731</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7732"><td class="num" id="LN7732">7732</td><td class="line">    <span class='keyword'>if</span> (payload == 0) {</td></tr>
<tr class="codeline" data-linenumber="7733"><td class="num" id="LN7733">7733</td><td class="line">        payload = <span class='macro'>ULLONG_MAX<span class='macro_popup'>(9223372036854775807LL*2ULL+1ULL)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7734"><td class="num" id="LN7734">7734</td><td class="line">        memset(lastbytes,0,<span class='macro'>RDB_EOF_MARK_SIZE<span class='macro_popup'>40</span></span>);</td></tr>
<tr class="codeline" data-linenumber="7735"><td class="num" id="LN7735">7735</td><td class="line">        usemark = 1;</td></tr>
<tr class="codeline" data-linenumber="7736"><td class="num" id="LN7736">7736</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"SYNC with master, discarding "</span></td></tr>
<tr class="codeline" data-linenumber="7737"><td class="num" id="LN7737">7737</td><td class="line">                       <span class='string_literal'>"bytes of bulk transfer until EOF marker...\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="7738"><td class="num" id="LN7738">7738</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="7739"><td class="num" id="LN7739">7739</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"SYNC with master, discarding %llu "</span></td></tr>
<tr class="codeline" data-linenumber="7740"><td class="num" id="LN7740">7740</td><td class="line">                       <span class='string_literal'>"bytes of bulk transfer...\n"</span>, payload);</td></tr>
<tr class="codeline" data-linenumber="7741"><td class="num" id="LN7741">7741</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7742"><td class="num" id="LN7742">7742</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7743"><td class="num" id="LN7743">7743</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7744"><td class="num" id="LN7744">7744</td><td class="line">    <span class='comment'>/* Discard the payload. */</span></td></tr>
<tr class="codeline" data-linenumber="7745"><td class="num" id="LN7745">7745</td><td class="line">    <span class='keyword'>while</span>(payload) {</td></tr>
<tr class="codeline" data-linenumber="7746"><td class="num" id="LN7746">7746</td><td class="line">        ssize_t nread;</td></tr>
<tr class="codeline" data-linenumber="7747"><td class="num" id="LN7747">7747</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7748"><td class="num" id="LN7748">7748</td><td class="line">        nread = readConn(context,buf,(payload &gt; <span class='keyword'>sizeof</span>(buf)) ? <span class='keyword'>sizeof</span>(buf) : payload);</td></tr>
<tr class="codeline" data-linenumber="7749"><td class="num" id="LN7749">7749</td><td class="line">        <span class='keyword'>if</span> (nread &lt;= 0) {</td></tr>
<tr class="codeline" data-linenumber="7750"><td class="num" id="LN7750">7750</td><td class="line">            fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"Error reading RDB payload while SYNCing\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="7751"><td class="num" id="LN7751">7751</td><td class="line">            exit(1);</td></tr>
<tr class="codeline" data-linenumber="7752"><td class="num" id="LN7752">7752</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="7753"><td class="num" id="LN7753">7753</td><td class="line">        payload -= nread;</td></tr>
<tr class="codeline" data-linenumber="7754"><td class="num" id="LN7754">7754</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7755"><td class="num" id="LN7755">7755</td><td class="line">        <span class='keyword'>if</span> (usemark) {</td></tr>
<tr class="codeline" data-linenumber="7756"><td class="num" id="LN7756">7756</td><td class="line">            <span class='comment'>/* Update the last bytes array, and check if it matches our delimiter.*/</span></td></tr>
<tr class="codeline" data-linenumber="7757"><td class="num" id="LN7757">7757</td><td class="line">            <span class='keyword'>if</span> (nread &gt;= <span class='macro'>RDB_EOF_MARK_SIZE<span class='macro_popup'>40</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="7758"><td class="num" id="LN7758">7758</td><td class="line">                memcpy(lastbytes,buf+nread-<span class='macro'>RDB_EOF_MARK_SIZE<span class='macro_popup'>40</span></span>,<span class='macro'>RDB_EOF_MARK_SIZE<span class='macro_popup'>40</span></span>);</td></tr>
<tr class="codeline" data-linenumber="7759"><td class="num" id="LN7759">7759</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="7760"><td class="num" id="LN7760">7760</td><td class="line">                <span class='keyword'>int</span> rem = <span class='macro'>RDB_EOF_MARK_SIZE<span class='macro_popup'>40</span></span>-nread;</td></tr>
<tr class="codeline" data-linenumber="7761"><td class="num" id="LN7761">7761</td><td class="line">                memmove(lastbytes,lastbytes+nread,rem);</td></tr>
<tr class="codeline" data-linenumber="7762"><td class="num" id="LN7762">7762</td><td class="line">                memcpy(lastbytes+rem,buf,nread);</td></tr>
<tr class="codeline" data-linenumber="7763"><td class="num" id="LN7763">7763</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="7764"><td class="num" id="LN7764">7764</td><td class="line">            <span class='keyword'>if</span> (memcmp(lastbytes,eofmark,<span class='macro'>RDB_EOF_MARK_SIZE<span class='macro_popup'>40</span></span>) == 0)</td></tr>
<tr class="codeline" data-linenumber="7765"><td class="num" id="LN7765">7765</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="7766"><td class="num" id="LN7766">7766</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="7767"><td class="num" id="LN7767">7767</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7768"><td class="num" id="LN7768">7768</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7769"><td class="num" id="LN7769">7769</td><td class="line">    <span class='keyword'>if</span> (usemark) {</td></tr>
<tr class="codeline" data-linenumber="7770"><td class="num" id="LN7770">7770</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> offset = <span class='macro'>ULLONG_MAX<span class='macro_popup'>(9223372036854775807LL*2ULL+1ULL)</span></span> - payload;</td></tr>
<tr class="codeline" data-linenumber="7771"><td class="num" id="LN7771">7771</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"SYNC done after %llu bytes. Logging commands from master.\n"</span>, offset);</td></tr>
<tr class="codeline" data-linenumber="7772"><td class="num" id="LN7772">7772</td><td class="line">        <span class='comment'>/* put the slave online */</span></td></tr>
<tr class="codeline" data-linenumber="7773"><td class="num" id="LN7773">7773</td><td class="line">        sleep(1);</td></tr>
<tr class="codeline" data-linenumber="7774"><td class="num" id="LN7774">7774</td><td class="line">        sendReplconf(<span class='string_literal'>"ACK"</span>, <span class='string_literal'>"0"</span>);</td></tr>
<tr class="codeline" data-linenumber="7775"><td class="num" id="LN7775">7775</td><td class="line">    } <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="7776"><td class="num" id="LN7776">7776</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"SYNC done. Logging commands from master.\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="7777"><td class="num" id="LN7777">7777</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7778"><td class="num" id="LN7778">7778</td><td class="line">    <span class='comment'>/* Now we can use hiredis to read the incoming protocol. */</span></td></tr>
<tr class="codeline" data-linenumber="7779"><td class="num" id="LN7779">7779</td><td class="line">    config.output = <span class='macro'>OUTPUT_CSV<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7780"><td class="num" id="LN7780">7780</td><td class="line">    <span class='keyword'>while</span> (cliReadReply(0) == <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="7781"><td class="num" id="LN7781">7781</td><td class="line">    config.output = original_output;</td></tr>
<tr class="codeline" data-linenumber="7782"><td class="num" id="LN7782">7782</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="7783"><td class="num" id="LN7783">7783</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7784"><td class="num" id="LN7784">7784</td><td class="line"><span class='comment'>/*------------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="7785"><td class="num" id="LN7785">7785</td><td class="line"> <span class='comment'>* RDB transfer mode</span></td></tr>
<tr class="codeline" data-linenumber="7786"><td class="num" id="LN7786">7786</td><td class="line"> <span class='comment'>*--------------------------------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="7787"><td class="num" id="LN7787">7787</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7788"><td class="num" id="LN7788">7788</td><td class="line"><span class='comment'>/* This function implements --rdb, so it uses the replication protocol in order</span></td></tr>
<tr class="codeline" data-linenumber="7789"><td class="num" id="LN7789">7789</td><td class="line"> <span class='comment'>* to fetch the RDB file from a remote server. */</span></td></tr>
<tr class="codeline" data-linenumber="7790"><td class="num" id="LN7790">7790</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> getRDB(clusterManagerNode *node) {</td></tr>
<tr class="codeline" data-linenumber="7791"><td class="num" id="LN7791">7791</td><td class="line">    <span class='keyword'>int</span> fd;</td></tr>
<tr class="codeline" data-linenumber="7792"><td class="num" id="LN7792">7792</td><td class="line">    redisContext *s;</td></tr>
<tr class="codeline" data-linenumber="7793"><td class="num" id="LN7793">7793</td><td class="line">    <span class='keyword'>char</span> *filename;</td></tr>
<tr class="codeline" data-linenumber="7794"><td class="num" id="LN7794">7794</td><td class="line">    <span class='keyword'>if</span> (node != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="7795"><td class="num" id="LN7795">7795</td><td class="line">        <span class='macro'>assert(node-&gt;context)<span class='macro_popup'>((node-&gt;context) ? (void) (0) : __assert_fail ("node-&gt;context"<br>, "redis-cli.c", 7795, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7796"><td class="num" id="LN7796">7796</td><td class="line">        s = node-&gt;context;</td></tr>
<tr class="codeline" data-linenumber="7797"><td class="num" id="LN7797">7797</td><td class="line">        filename = clusterManagerGetNodeRDBFilename(node);</td></tr>
<tr class="codeline" data-linenumber="7798"><td class="num" id="LN7798">7798</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="7799"><td class="num" id="LN7799">7799</td><td class="line">        s = context;</td></tr>
<tr class="codeline" data-linenumber="7800"><td class="num" id="LN7800">7800</td><td class="line">        filename = config.rdb_filename;</td></tr>
<tr class="codeline" data-linenumber="7801"><td class="num" id="LN7801">7801</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7802"><td class="num" id="LN7802">7802</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>char</span> eofmark[<span class='macro'>RDB_EOF_MARK_SIZE<span class='macro_popup'>40</span></span>];</td></tr>
<tr class="codeline" data-linenumber="7803"><td class="num" id="LN7803">7803</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>char</span> lastbytes[<span class='macro'>RDB_EOF_MARK_SIZE<span class='macro_popup'>40</span></span>];</td></tr>
<tr class="codeline" data-linenumber="7804"><td class="num" id="LN7804">7804</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>int</span> usemark = 0;</td></tr>
<tr class="codeline" data-linenumber="7805"><td class="num" id="LN7805">7805</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> payload = sendSync(s, eofmark);</td></tr>
<tr class="codeline" data-linenumber="7806"><td class="num" id="LN7806">7806</td><td class="line">    <span class='keyword'>char</span> buf[4096];</td></tr>
<tr class="codeline" data-linenumber="7807"><td class="num" id="LN7807">7807</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7808"><td class="num" id="LN7808">7808</td><td class="line">    <span class='keyword'>if</span> (payload == 0) {</td></tr>
<tr class="codeline" data-linenumber="7809"><td class="num" id="LN7809">7809</td><td class="line">        payload = <span class='macro'>ULLONG_MAX<span class='macro_popup'>(9223372036854775807LL*2ULL+1ULL)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7810"><td class="num" id="LN7810">7810</td><td class="line">        memset(lastbytes,0,<span class='macro'>RDB_EOF_MARK_SIZE<span class='macro_popup'>40</span></span>);</td></tr>
<tr class="codeline" data-linenumber="7811"><td class="num" id="LN7811">7811</td><td class="line">        usemark = 1;</td></tr>
<tr class="codeline" data-linenumber="7812"><td class="num" id="LN7812">7812</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"SYNC sent to master, writing bytes of bulk transfer "</span></td></tr>
<tr class="codeline" data-linenumber="7813"><td class="num" id="LN7813">7813</td><td class="line">                <span class='string_literal'>"until EOF marker to '%s'\n"</span>, filename);</td></tr>
<tr class="codeline" data-linenumber="7814"><td class="num" id="LN7814">7814</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="7815"><td class="num" id="LN7815">7815</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"SYNC sent to master, writing %llu bytes to '%s'\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="7816"><td class="num" id="LN7816">7816</td><td class="line">            payload, filename);</td></tr>
<tr class="codeline" data-linenumber="7817"><td class="num" id="LN7817">7817</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7818"><td class="num" id="LN7818">7818</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7819"><td class="num" id="LN7819">7819</td><td class="line">    <span class='keyword'>int</span> write_to_stdout = !strcmp(filename,<span class='string_literal'>"-"</span>);</td></tr>
<tr class="codeline" data-linenumber="7820"><td class="num" id="LN7820">7820</td><td class="line">    <span class='comment'>/* Write to file. */</span></td></tr>
<tr class="codeline" data-linenumber="7821"><td class="num" id="LN7821">7821</td><td class="line">    <span class='keyword'>if</span> (write_to_stdout) {</td></tr>
<tr class="codeline" data-linenumber="7822"><td class="num" id="LN7822">7822</td><td class="line">        fd = <span class='macro'>STDOUT_FILENO<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7823"><td class="num" id="LN7823">7823</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="7824"><td class="num" id="LN7824">7824</td><td class="line">        fd = open(filename, <span class='macro'>O_CREAT<span class='macro_popup'>0100</span></span>|<span class='macro'>O_WRONLY<span class='macro_popup'>01</span></span>, 0644);</td></tr>
<tr class="codeline" data-linenumber="7825"><td class="num" id="LN7825">7825</td><td class="line">        <span class='keyword'>if</span> (fd == -1) {</td></tr>
<tr class="codeline" data-linenumber="7826"><td class="num" id="LN7826">7826</td><td class="line">            fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Error opening '%s': %s\n"</span>, filename,</td></tr>
<tr class="codeline" data-linenumber="7827"><td class="num" id="LN7827">7827</td><td class="line">                strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="7828"><td class="num" id="LN7828">7828</td><td class="line">            exit(1);</td></tr>
<tr class="codeline" data-linenumber="7829"><td class="num" id="LN7829">7829</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="7830"><td class="num" id="LN7830">7830</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7831"><td class="num" id="LN7831">7831</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7832"><td class="num" id="LN7832">7832</td><td class="line">    <span class='keyword'>while</span>(payload) {</td></tr>
<tr class="codeline" data-linenumber="7833"><td class="num" id="LN7833">7833</td><td class="line">        ssize_t nread, nwritten;</td></tr>
<tr class="codeline" data-linenumber="7834"><td class="num" id="LN7834">7834</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7835"><td class="num" id="LN7835">7835</td><td class="line">        nread = readConn(s,buf,(payload &gt; <span class='keyword'>sizeof</span>(buf)) ? <span class='keyword'>sizeof</span>(buf) : payload);</td></tr>
<tr class="codeline" data-linenumber="7836"><td class="num" id="LN7836">7836</td><td class="line">        <span class='keyword'>if</span> (nread &lt;= 0) {</td></tr>
<tr class="codeline" data-linenumber="7837"><td class="num" id="LN7837">7837</td><td class="line">            fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"I/O Error reading RDB payload from socket\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="7838"><td class="num" id="LN7838">7838</td><td class="line">            exit(1);</td></tr>
<tr class="codeline" data-linenumber="7839"><td class="num" id="LN7839">7839</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="7840"><td class="num" id="LN7840">7840</td><td class="line">        nwritten = write(fd, buf, nread);</td></tr>
<tr class="codeline" data-linenumber="7841"><td class="num" id="LN7841">7841</td><td class="line">        <span class='keyword'>if</span> (nwritten != nread) {</td></tr>
<tr class="codeline" data-linenumber="7842"><td class="num" id="LN7842">7842</td><td class="line">            fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"Error writing data to file: %s\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="7843"><td class="num" id="LN7843">7843</td><td class="line">                (nwritten == -1) ? strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>) : <span class='string_literal'>"short write"</span>);</td></tr>
<tr class="codeline" data-linenumber="7844"><td class="num" id="LN7844">7844</td><td class="line">            exit(1);</td></tr>
<tr class="codeline" data-linenumber="7845"><td class="num" id="LN7845">7845</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="7846"><td class="num" id="LN7846">7846</td><td class="line">        payload -= nread;</td></tr>
<tr class="codeline" data-linenumber="7847"><td class="num" id="LN7847">7847</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7848"><td class="num" id="LN7848">7848</td><td class="line">        <span class='keyword'>if</span> (usemark) {</td></tr>
<tr class="codeline" data-linenumber="7849"><td class="num" id="LN7849">7849</td><td class="line">            <span class='comment'>/* Update the last bytes array, and check if it matches our delimiter.*/</span></td></tr>
<tr class="codeline" data-linenumber="7850"><td class="num" id="LN7850">7850</td><td class="line">            <span class='keyword'>if</span> (nread &gt;= <span class='macro'>RDB_EOF_MARK_SIZE<span class='macro_popup'>40</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="7851"><td class="num" id="LN7851">7851</td><td class="line">                memcpy(lastbytes,buf+nread-<span class='macro'>RDB_EOF_MARK_SIZE<span class='macro_popup'>40</span></span>,<span class='macro'>RDB_EOF_MARK_SIZE<span class='macro_popup'>40</span></span>);</td></tr>
<tr class="codeline" data-linenumber="7852"><td class="num" id="LN7852">7852</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="7853"><td class="num" id="LN7853">7853</td><td class="line">                <span class='keyword'>int</span> rem = <span class='macro'>RDB_EOF_MARK_SIZE<span class='macro_popup'>40</span></span>-nread;</td></tr>
<tr class="codeline" data-linenumber="7854"><td class="num" id="LN7854">7854</td><td class="line">                memmove(lastbytes,lastbytes+nread,rem);</td></tr>
<tr class="codeline" data-linenumber="7855"><td class="num" id="LN7855">7855</td><td class="line">                memcpy(lastbytes+rem,buf,nread);</td></tr>
<tr class="codeline" data-linenumber="7856"><td class="num" id="LN7856">7856</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="7857"><td class="num" id="LN7857">7857</td><td class="line">            <span class='keyword'>if</span> (memcmp(lastbytes,eofmark,<span class='macro'>RDB_EOF_MARK_SIZE<span class='macro_popup'>40</span></span>) == 0)</td></tr>
<tr class="codeline" data-linenumber="7858"><td class="num" id="LN7858">7858</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="7859"><td class="num" id="LN7859">7859</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="7860"><td class="num" id="LN7860">7860</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7861"><td class="num" id="LN7861">7861</td><td class="line">    <span class='keyword'>if</span> (usemark) {</td></tr>
<tr class="codeline" data-linenumber="7862"><td class="num" id="LN7862">7862</td><td class="line">        payload = <span class='macro'>ULLONG_MAX<span class='macro_popup'>(9223372036854775807LL*2ULL+1ULL)</span></span> - payload - <span class='macro'>RDB_EOF_MARK_SIZE<span class='macro_popup'>40</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7863"><td class="num" id="LN7863">7863</td><td class="line">        <span class='keyword'>if</span> (!write_to_stdout &amp;&amp; ftruncate(fd, payload) == -1)</td></tr>
<tr class="codeline" data-linenumber="7864"><td class="num" id="LN7864">7864</td><td class="line">            fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"ftruncate failed: %s.\n"</span>, strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="7865"><td class="num" id="LN7865">7865</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"Transfer finished with success after %llu bytes\n"</span>, payload);</td></tr>
<tr class="codeline" data-linenumber="7866"><td class="num" id="LN7866">7866</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="7867"><td class="num" id="LN7867">7867</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"Transfer finished with success.\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="7868"><td class="num" id="LN7868">7868</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7869"><td class="num" id="LN7869">7869</td><td class="line">    redisFree(s); <span class='comment'>/* Close the connection ASAP as fsync() may take time. */</span></td></tr>
<tr class="codeline" data-linenumber="7870"><td class="num" id="LN7870">7870</td><td class="line">    <span class='keyword'>if</span> (node)</td></tr>
<tr class="codeline" data-linenumber="7871"><td class="num" id="LN7871">7871</td><td class="line">        node-&gt;context = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7872"><td class="num" id="LN7872">7872</td><td class="line">    <span class='keyword'>if</span> (!write_to_stdout &amp;&amp; fsync(fd) == -1) {</td></tr>
<tr class="codeline" data-linenumber="7873"><td class="num" id="LN7873">7873</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"Fail to fsync '%s': %s\n"</span>, filename, strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="7874"><td class="num" id="LN7874">7874</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="7875"><td class="num" id="LN7875">7875</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7876"><td class="num" id="LN7876">7876</td><td class="line">    close(fd);</td></tr>
<tr class="codeline" data-linenumber="7877"><td class="num" id="LN7877">7877</td><td class="line">    <span class='keyword'>if</span> (node) {</td></tr>
<tr class="codeline" data-linenumber="7878"><td class="num" id="LN7878">7878</td><td class="line">        <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(filename);</td></tr>
<tr class="codeline" data-linenumber="7879"><td class="num" id="LN7879">7879</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="7880"><td class="num" id="LN7880">7880</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7881"><td class="num" id="LN7881">7881</td><td class="line">    exit(0);</td></tr>
<tr class="codeline" data-linenumber="7882"><td class="num" id="LN7882">7882</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="7883"><td class="num" id="LN7883">7883</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7884"><td class="num" id="LN7884">7884</td><td class="line"><span class='comment'>/*------------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="7885"><td class="num" id="LN7885">7885</td><td class="line"> <span class='comment'>* Bulk import (pipe) mode</span></td></tr>
<tr class="codeline" data-linenumber="7886"><td class="num" id="LN7886">7886</td><td class="line"> <span class='comment'>*--------------------------------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="7887"><td class="num" id="LN7887">7887</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7888"><td class="num" id="LN7888">7888</td><td class="line"><span class='directive'>#define <span class='macro'>PIPEMODE_WRITE_LOOP_MAX_BYTES<span class='macro_popup'>(128*1024)</span></span> (128*1024)</span></td></tr>
<tr class="codeline" data-linenumber="7889"><td class="num" id="LN7889">7889</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> pipeMode(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="7890"><td class="num" id="LN7890">7890</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> errors = 0, replies = 0, obuf_len = 0, obuf_pos = 0;</td></tr>
<tr class="codeline" data-linenumber="7891"><td class="num" id="LN7891">7891</td><td class="line">    <span class='keyword'>char</span> obuf[1024*16]; <span class='comment'>/* Output buffer */</span></td></tr>
<tr class="codeline" data-linenumber="7892"><td class="num" id="LN7892">7892</td><td class="line">    <span class='keyword'>char</span> aneterr[<span class='macro'>ANET_ERR_LEN<span class='macro_popup'>256</span></span>];</td></tr>
<tr class="codeline" data-linenumber="7893"><td class="num" id="LN7893">7893</td><td class="line">    redisReply *reply;</td></tr>
<tr class="codeline" data-linenumber="7894"><td class="num" id="LN7894">7894</td><td class="line">    <span class='keyword'>int</span> eof = 0; <span class='comment'>/* True once we consumed all the standard input. */</span></td></tr>
<tr class="codeline" data-linenumber="7895"><td class="num" id="LN7895">7895</td><td class="line">    <span class='keyword'>int</span> done = 0;</td></tr>
<tr class="codeline" data-linenumber="7896"><td class="num" id="LN7896">7896</td><td class="line">    <span class='keyword'>char</span> magic[20]; <span class='comment'>/* Special reply we recognize. */</span></td></tr>
<tr class="codeline" data-linenumber="7897"><td class="num" id="LN7897">7897</td><td class="line">    time_t last_read_time = time(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="7898"><td class="num" id="LN7898">7898</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7899"><td class="num" id="LN7899">7899</td><td class="line">    srand(time(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>));</td></tr>
<tr class="codeline" data-linenumber="7900"><td class="num" id="LN7900">7900</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7901"><td class="num" id="LN7901">7901</td><td class="line">    <span class='comment'>/* Use non blocking I/O. */</span></td></tr>
<tr class="codeline" data-linenumber="7902"><td class="num" id="LN7902">7902</td><td class="line">    <span class='keyword'>if</span> (anetNonBlock(aneterr,context-&gt;fd) == <span class='macro'>ANET_ERR<span class='macro_popup'>-1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="7903"><td class="num" id="LN7903">7903</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Can't set the socket in non blocking mode: %s\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="7904"><td class="num" id="LN7904">7904</td><td class="line">            aneterr);</td></tr>
<tr class="codeline" data-linenumber="7905"><td class="num" id="LN7905">7905</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="7906"><td class="num" id="LN7906">7906</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="7907"><td class="num" id="LN7907">7907</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7908"><td class="num" id="LN7908">7908</td><td class="line">    context-&gt;flags &amp;= ~<span class='macro'>REDIS_BLOCK<span class='macro_popup'>0x1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7909"><td class="num" id="LN7909">7909</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7910"><td class="num" id="LN7910">7910</td><td class="line">    <span class='comment'>/* Transfer raw protocol and read replies from the server at the same</span></td></tr>
<tr class="codeline" data-linenumber="7911"><td class="num" id="LN7911">7911</td><td class="line">     <span class='comment'>* time. */</span></td></tr>
<tr class="codeline" data-linenumber="7912"><td class="num" id="LN7912">7912</td><td class="line">    <span class='keyword'>while</span>(!done) {</td></tr>
<tr class="codeline" data-linenumber="7913"><td class="num" id="LN7913">7913</td><td class="line">        <span class='keyword'>int</span> mask = <span class='macro'>AE_READABLE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7914"><td class="num" id="LN7914">7914</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7915"><td class="num" id="LN7915">7915</td><td class="line">        <span class='keyword'>if</span> (!eof || obuf_len != 0) mask |= <span class='macro'>AE_WRITABLE<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7916"><td class="num" id="LN7916">7916</td><td class="line">        mask = aeWait(context-&gt;fd,mask,1000);</td></tr>
<tr class="codeline" data-linenumber="7917"><td class="num" id="LN7917">7917</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7918"><td class="num" id="LN7918">7918</td><td class="line">        <span class='comment'>/* Handle the readable state: we can read replies from the server. */</span></td></tr>
<tr class="codeline" data-linenumber="7919"><td class="num" id="LN7919">7919</td><td class="line">        <span class='keyword'>if</span> (mask &amp; <span class='macro'>AE_READABLE<span class='macro_popup'>1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="7920"><td class="num" id="LN7920">7920</td><td class="line">            <span class='keyword'>int</span> read_error = 0;</td></tr>
<tr class="codeline" data-linenumber="7921"><td class="num" id="LN7921">7921</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7922"><td class="num" id="LN7922">7922</td><td class="line">            <span class='keyword'>do</span> {</td></tr>
<tr class="codeline" data-linenumber="7923"><td class="num" id="LN7923">7923</td><td class="line">                <span class='keyword'>if</span> (!read_error &amp;&amp; redisBufferRead(context) == <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="7924"><td class="num" id="LN7924">7924</td><td class="line">                    read_error = 1;</td></tr>
<tr class="codeline" data-linenumber="7925"><td class="num" id="LN7925">7925</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="7926"><td class="num" id="LN7926">7926</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7927"><td class="num" id="LN7927">7927</td><td class="line">                reply = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="7928"><td class="num" id="LN7928">7928</td><td class="line">                <span class='keyword'>if</span> (redisGetReply(context, (<span class='keyword'>void</span> **) &amp;reply) == <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="7929"><td class="num" id="LN7929">7929</td><td class="line">                    fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Error reading replies from server\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="7930"><td class="num" id="LN7930">7930</td><td class="line">                    exit(1);</td></tr>
<tr class="codeline" data-linenumber="7931"><td class="num" id="LN7931">7931</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="7932"><td class="num" id="LN7932">7932</td><td class="line">                <span class='keyword'>if</span> (reply) {</td></tr>
<tr class="codeline" data-linenumber="7933"><td class="num" id="LN7933">7933</td><td class="line">                    last_read_time = time(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="7934"><td class="num" id="LN7934">7934</td><td class="line">                    <span class='keyword'>if</span> (reply-&gt;type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="7935"><td class="num" id="LN7935">7935</td><td class="line">                        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"%s\n"</span>, reply-&gt;str);</td></tr>
<tr class="codeline" data-linenumber="7936"><td class="num" id="LN7936">7936</td><td class="line">                        errors++;</td></tr>
<tr class="codeline" data-linenumber="7937"><td class="num" id="LN7937">7937</td><td class="line">                    } <span class='keyword'>else</span> <span class='keyword'>if</span> (eof &amp;&amp; reply-&gt;type == <span class='macro'>REDIS_REPLY_STRING<span class='macro_popup'>1</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="7938"><td class="num" id="LN7938">7938</td><td class="line">                                      reply-&gt;len == 20) {</td></tr>
<tr class="codeline" data-linenumber="7939"><td class="num" id="LN7939">7939</td><td class="line">                        <span class='comment'>/* Check if this is the reply to our final ECHO</span></td></tr>
<tr class="codeline" data-linenumber="7940"><td class="num" id="LN7940">7940</td><td class="line">                         <span class='comment'>* command. If so everything was received</span></td></tr>
<tr class="codeline" data-linenumber="7941"><td class="num" id="LN7941">7941</td><td class="line">                         <span class='comment'>* from the server. */</span></td></tr>
<tr class="codeline" data-linenumber="7942"><td class="num" id="LN7942">7942</td><td class="line">                        <span class='keyword'>if</span> (memcmp(reply-&gt;str,magic,20) == 0) {</td></tr>
<tr class="codeline" data-linenumber="7943"><td class="num" id="LN7943">7943</td><td class="line">                            printf(<span class='string_literal'>"Last reply received from server.\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="7944"><td class="num" id="LN7944">7944</td><td class="line">                            done = 1;</td></tr>
<tr class="codeline" data-linenumber="7945"><td class="num" id="LN7945">7945</td><td class="line">                            replies--;</td></tr>
<tr class="codeline" data-linenumber="7946"><td class="num" id="LN7946">7946</td><td class="line">                        }</td></tr>
<tr class="codeline" data-linenumber="7947"><td class="num" id="LN7947">7947</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="7948"><td class="num" id="LN7948">7948</td><td class="line">                    replies++;</td></tr>
<tr class="codeline" data-linenumber="7949"><td class="num" id="LN7949">7949</td><td class="line">                    freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="7950"><td class="num" id="LN7950">7950</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="7951"><td class="num" id="LN7951">7951</td><td class="line">            } <span class='keyword'>while</span>(reply);</td></tr>
<tr class="codeline" data-linenumber="7952"><td class="num" id="LN7952">7952</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7953"><td class="num" id="LN7953">7953</td><td class="line">            <span class='comment'>/* Abort on read errors. We abort here because it is important</span></td></tr>
<tr class="codeline" data-linenumber="7954"><td class="num" id="LN7954">7954</td><td class="line">             <span class='comment'>* to consume replies even after a read error: this way we can</span></td></tr>
<tr class="codeline" data-linenumber="7955"><td class="num" id="LN7955">7955</td><td class="line">             <span class='comment'>* show a potential problem to the user. */</span></td></tr>
<tr class="codeline" data-linenumber="7956"><td class="num" id="LN7956">7956</td><td class="line">            <span class='keyword'>if</span> (read_error) exit(1);</td></tr>
<tr class="codeline" data-linenumber="7957"><td class="num" id="LN7957">7957</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="7958"><td class="num" id="LN7958">7958</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7959"><td class="num" id="LN7959">7959</td><td class="line">        <span class='comment'>/* Handle the writable state: we can send protocol to the server. */</span></td></tr>
<tr class="codeline" data-linenumber="7960"><td class="num" id="LN7960">7960</td><td class="line">        <span class='keyword'>if</span> (mask &amp; <span class='macro'>AE_WRITABLE<span class='macro_popup'>2</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="7961"><td class="num" id="LN7961">7961</td><td class="line">            ssize_t loop_nwritten = 0;</td></tr>
<tr class="codeline" data-linenumber="7962"><td class="num" id="LN7962">7962</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7963"><td class="num" id="LN7963">7963</td><td class="line">            <span class='keyword'>while</span>(1) {</td></tr>
<tr class="codeline" data-linenumber="7964"><td class="num" id="LN7964">7964</td><td class="line">                <span class='comment'>/* Transfer current buffer to server. */</span></td></tr>
<tr class="codeline" data-linenumber="7965"><td class="num" id="LN7965">7965</td><td class="line">                <span class='keyword'>if</span> (obuf_len != 0) {</td></tr>
<tr class="codeline" data-linenumber="7966"><td class="num" id="LN7966">7966</td><td class="line">                    ssize_t nwritten = cliWriteConn(context,obuf+obuf_pos,obuf_len);</td></tr>
<tr class="codeline" data-linenumber="7967"><td class="num" id="LN7967">7967</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7968"><td class="num" id="LN7968">7968</td><td class="line">                    <span class='keyword'>if</span> (nwritten == -1) {</td></tr>
<tr class="codeline" data-linenumber="7969"><td class="num" id="LN7969">7969</td><td class="line">                        <span class='keyword'>if</span> (<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span> != <span class='macro'>EAGAIN<span class='macro_popup'>11</span></span> &amp;&amp; <span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span> != <span class='macro'>EINTR<span class='macro_popup'>4</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="7970"><td class="num" id="LN7970">7970</td><td class="line">                            fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Error writing to the server: %s\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="7971"><td class="num" id="LN7971">7971</td><td class="line">                                strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="7972"><td class="num" id="LN7972">7972</td><td class="line">                            exit(1);</td></tr>
<tr class="codeline" data-linenumber="7973"><td class="num" id="LN7973">7973</td><td class="line">                        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="7974"><td class="num" id="LN7974">7974</td><td class="line">                            nwritten = 0;</td></tr>
<tr class="codeline" data-linenumber="7975"><td class="num" id="LN7975">7975</td><td class="line">                        }</td></tr>
<tr class="codeline" data-linenumber="7976"><td class="num" id="LN7976">7976</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="7977"><td class="num" id="LN7977">7977</td><td class="line">                    obuf_len -= nwritten;</td></tr>
<tr class="codeline" data-linenumber="7978"><td class="num" id="LN7978">7978</td><td class="line">                    obuf_pos += nwritten;</td></tr>
<tr class="codeline" data-linenumber="7979"><td class="num" id="LN7979">7979</td><td class="line">                    loop_nwritten += nwritten;</td></tr>
<tr class="codeline" data-linenumber="7980"><td class="num" id="LN7980">7980</td><td class="line">                    <span class='keyword'>if</span> (obuf_len != 0) <span class='keyword'>break</span>; <span class='comment'>/* Can't accept more data. */</span></td></tr>
<tr class="codeline" data-linenumber="7981"><td class="num" id="LN7981">7981</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="7982"><td class="num" id="LN7982">7982</td><td class="line">                <span class='keyword'>if</span> (context-&gt;err) {</td></tr>
<tr class="codeline" data-linenumber="7983"><td class="num" id="LN7983">7983</td><td class="line">                    fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Server I/O Error: %s\n"</span>, context-&gt;errstr);</td></tr>
<tr class="codeline" data-linenumber="7984"><td class="num" id="LN7984">7984</td><td class="line">                    exit(1);</td></tr>
<tr class="codeline" data-linenumber="7985"><td class="num" id="LN7985">7985</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="7986"><td class="num" id="LN7986">7986</td><td class="line">                <span class='comment'>/* If buffer is empty, load from stdin. */</span></td></tr>
<tr class="codeline" data-linenumber="7987"><td class="num" id="LN7987">7987</td><td class="line">                <span class='keyword'>if</span> (obuf_len == 0 &amp;&amp; !eof) {</td></tr>
<tr class="codeline" data-linenumber="7988"><td class="num" id="LN7988">7988</td><td class="line">                    ssize_t nread = read(<span class='macro'>STDIN_FILENO<span class='macro_popup'>0</span></span>,obuf,<span class='keyword'>sizeof</span>(obuf));</td></tr>
<tr class="codeline" data-linenumber="7989"><td class="num" id="LN7989">7989</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7990"><td class="num" id="LN7990">7990</td><td class="line">                    <span class='keyword'>if</span> (nread == 0) {</td></tr>
<tr class="codeline" data-linenumber="7991"><td class="num" id="LN7991">7991</td><td class="line">                        <span class='comment'>/* The ECHO sequence starts with a "\r\n" so that if there</span></td></tr>
<tr class="codeline" data-linenumber="7992"><td class="num" id="LN7992">7992</td><td class="line">                         <span class='comment'>* is garbage in the protocol we read from stdin, the ECHO</span></td></tr>
<tr class="codeline" data-linenumber="7993"><td class="num" id="LN7993">7993</td><td class="line">                         <span class='comment'>* will likely still be properly formatted.</span></td></tr>
<tr class="codeline" data-linenumber="7994"><td class="num" id="LN7994">7994</td><td class="line">                         <span class='comment'>* CRLF is ignored by Redis, so it has no effects. */</span></td></tr>
<tr class="codeline" data-linenumber="7995"><td class="num" id="LN7995">7995</td><td class="line">                        <span class='keyword'>char</span> echo[] =</td></tr>
<tr class="codeline" data-linenumber="7996"><td class="num" id="LN7996">7996</td><td class="line">                        <span class='string_literal'>"\r\n*2\r\n$4\r\nECHO\r\n$20\r\n01234567890123456789\r\n"</span>;</td></tr>
<tr class="codeline" data-linenumber="7997"><td class="num" id="LN7997">7997</td><td class="line">                        <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="7998"><td class="num" id="LN7998">7998</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7999"><td class="num" id="LN7999">7999</td><td class="line">                        eof = 1;</td></tr>
<tr class="codeline" data-linenumber="8000"><td class="num" id="LN8000">8000</td><td class="line">                        <span class='comment'>/* Everything transferred, so we queue a special</span></td></tr>
<tr class="codeline" data-linenumber="8001"><td class="num" id="LN8001">8001</td><td class="line">                         <span class='comment'>* ECHO command that we can match in the replies</span></td></tr>
<tr class="codeline" data-linenumber="8002"><td class="num" id="LN8002">8002</td><td class="line">                         <span class='comment'>* to make sure everything was read from the server. */</span></td></tr>
<tr class="codeline" data-linenumber="8003"><td class="num" id="LN8003">8003</td><td class="line">                        <span class='keyword'>for</span> (j = 0; j &lt; 20; j++)</td></tr>
<tr class="codeline" data-linenumber="8004"><td class="num" id="LN8004">8004</td><td class="line">                            magic[j] = rand() &amp; 0xff;</td></tr>
<tr class="codeline" data-linenumber="8005"><td class="num" id="LN8005">8005</td><td class="line">                        memcpy(echo+21,magic,20);</td></tr>
<tr class="codeline" data-linenumber="8006"><td class="num" id="LN8006">8006</td><td class="line">                        memcpy(obuf,echo,<span class='keyword'>sizeof</span>(echo)-1);</td></tr>
<tr class="codeline" data-linenumber="8007"><td class="num" id="LN8007">8007</td><td class="line">                        obuf_len = <span class='keyword'>sizeof</span>(echo)-1;</td></tr>
<tr class="codeline" data-linenumber="8008"><td class="num" id="LN8008">8008</td><td class="line">                        obuf_pos = 0;</td></tr>
<tr class="codeline" data-linenumber="8009"><td class="num" id="LN8009">8009</td><td class="line">                        printf(<span class='string_literal'>"All data transferred. Waiting for the last reply...\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="8010"><td class="num" id="LN8010">8010</td><td class="line">                    } <span class='keyword'>else</span> <span class='keyword'>if</span> (nread == -1) {</td></tr>
<tr class="codeline" data-linenumber="8011"><td class="num" id="LN8011">8011</td><td class="line">                        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Error reading from stdin: %s\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="8012"><td class="num" id="LN8012">8012</td><td class="line">                            strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="8013"><td class="num" id="LN8013">8013</td><td class="line">                        exit(1);</td></tr>
<tr class="codeline" data-linenumber="8014"><td class="num" id="LN8014">8014</td><td class="line">                    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="8015"><td class="num" id="LN8015">8015</td><td class="line">                        obuf_len = nread;</td></tr>
<tr class="codeline" data-linenumber="8016"><td class="num" id="LN8016">8016</td><td class="line">                        obuf_pos = 0;</td></tr>
<tr class="codeline" data-linenumber="8017"><td class="num" id="LN8017">8017</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="8018"><td class="num" id="LN8018">8018</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="8019"><td class="num" id="LN8019">8019</td><td class="line">                <span class='keyword'>if</span> ((obuf_len == 0 &amp;&amp; eof) ||</td></tr>
<tr class="codeline" data-linenumber="8020"><td class="num" id="LN8020">8020</td><td class="line">                    loop_nwritten &gt; <span class='macro'>PIPEMODE_WRITE_LOOP_MAX_BYTES<span class='macro_popup'>(128*1024)</span></span>) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="8021"><td class="num" id="LN8021">8021</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="8022"><td class="num" id="LN8022">8022</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="8023"><td class="num" id="LN8023">8023</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8024"><td class="num" id="LN8024">8024</td><td class="line">        <span class='comment'>/* Handle timeout, that is, we reached EOF, and we are not getting</span></td></tr>
<tr class="codeline" data-linenumber="8025"><td class="num" id="LN8025">8025</td><td class="line">         <span class='comment'>* replies from the server for a few seconds, nor the final ECHO is</span></td></tr>
<tr class="codeline" data-linenumber="8026"><td class="num" id="LN8026">8026</td><td class="line">         <span class='comment'>* received. */</span></td></tr>
<tr class="codeline" data-linenumber="8027"><td class="num" id="LN8027">8027</td><td class="line">        <span class='keyword'>if</span> (eof &amp;&amp; config.pipe_timeout &gt; 0 &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="8028"><td class="num" id="LN8028">8028</td><td class="line">            time(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)-last_read_time &gt; config.pipe_timeout)</td></tr>
<tr class="codeline" data-linenumber="8029"><td class="num" id="LN8029">8029</td><td class="line">        {</td></tr>
<tr class="codeline" data-linenumber="8030"><td class="num" id="LN8030">8030</td><td class="line">            fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"No replies for %d seconds: exiting.\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="8031"><td class="num" id="LN8031">8031</td><td class="line">                config.pipe_timeout);</td></tr>
<tr class="codeline" data-linenumber="8032"><td class="num" id="LN8032">8032</td><td class="line">            errors++;</td></tr>
<tr class="codeline" data-linenumber="8033"><td class="num" id="LN8033">8033</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="8034"><td class="num" id="LN8034">8034</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="8035"><td class="num" id="LN8035">8035</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="8036"><td class="num" id="LN8036">8036</td><td class="line">    printf(<span class='string_literal'>"errors: %lld, replies: %lld\n"</span>, errors, replies);</td></tr>
<tr class="codeline" data-linenumber="8037"><td class="num" id="LN8037">8037</td><td class="line">    <span class='keyword'>if</span> (errors)</td></tr>
<tr class="codeline" data-linenumber="8038"><td class="num" id="LN8038">8038</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="8039"><td class="num" id="LN8039">8039</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="8040"><td class="num" id="LN8040">8040</td><td class="line">        exit(0);</td></tr>
<tr class="codeline" data-linenumber="8041"><td class="num" id="LN8041">8041</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="8042"><td class="num" id="LN8042">8042</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8043"><td class="num" id="LN8043">8043</td><td class="line"><span class='comment'>/*------------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="8044"><td class="num" id="LN8044">8044</td><td class="line"> <span class='comment'>* Find big keys</span></td></tr>
<tr class="codeline" data-linenumber="8045"><td class="num" id="LN8045">8045</td><td class="line"> <span class='comment'>*--------------------------------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="8046"><td class="num" id="LN8046">8046</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8047"><td class="num" id="LN8047">8047</td><td class="line"><span class='keyword'>static</span> redisReply *sendScan(<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> *it) {</td></tr>
<tr class="codeline" data-linenumber="8048"><td class="num" id="LN8048">8048</td><td class="line">    redisReply *reply;</td></tr>
<tr class="codeline" data-linenumber="8049"><td class="num" id="LN8049">8049</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8050"><td class="num" id="LN8050">8050</td><td class="line">    <span class='keyword'>if</span> (config.pattern)</td></tr>
<tr class="codeline" data-linenumber="8051"><td class="num" id="LN8051">8051</td><td class="line">        reply = redisCommand(context, <span class='string_literal'>"SCAN %llu MATCH %b"</span>,</td></tr>
<tr class="codeline" data-linenumber="8052"><td class="num" id="LN8052">8052</td><td class="line">            *it, config.pattern, <span class='macro'>sdslen<span class='macro_popup'>hi_sdslen</span></span>(config.pattern));</td></tr>
<tr class="codeline" data-linenumber="8053"><td class="num" id="LN8053">8053</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="8054"><td class="num" id="LN8054">8054</td><td class="line">        reply = redisCommand(context,<span class='string_literal'>"SCAN %llu"</span>,*it);</td></tr>
<tr class="codeline" data-linenumber="8055"><td class="num" id="LN8055">8055</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8056"><td class="num" id="LN8056">8056</td><td class="line">    <span class='comment'>/* Handle any error conditions */</span></td></tr>
<tr class="codeline" data-linenumber="8057"><td class="num" id="LN8057">8057</td><td class="line">    <span class='keyword'>if</span>(reply == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="8058"><td class="num" id="LN8058">8058</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"\nI/O error\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="8059"><td class="num" id="LN8059">8059</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="8060"><td class="num" id="LN8060">8060</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span>(reply-&gt;type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="8061"><td class="num" id="LN8061">8061</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"SCAN error: %s\n"</span>, reply-&gt;str);</td></tr>
<tr class="codeline" data-linenumber="8062"><td class="num" id="LN8062">8062</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="8063"><td class="num" id="LN8063">8063</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span>(reply-&gt;type != <span class='macro'>REDIS_REPLY_ARRAY<span class='macro_popup'>2</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="8064"><td class="num" id="LN8064">8064</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Non ARRAY response from SCAN!\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="8065"><td class="num" id="LN8065">8065</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="8066"><td class="num" id="LN8066">8066</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span>(reply-&gt;elements != 2) {</td></tr>
<tr class="codeline" data-linenumber="8067"><td class="num" id="LN8067">8067</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Invalid element count from SCAN!\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="8068"><td class="num" id="LN8068">8068</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="8069"><td class="num" id="LN8069">8069</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="8070"><td class="num" id="LN8070">8070</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8071"><td class="num" id="LN8071">8071</td><td class="line">    <span class='comment'>/* Validate our types are correct */</span></td></tr>
<tr class="codeline" data-linenumber="8072"><td class="num" id="LN8072">8072</td><td class="line">    <span class='macro'>assert(reply-&gt;element[0]-&gt;type == REDIS_REPLY_STRING)<span class='macro_popup'>((reply-&gt;element[0]-&gt;type == 1) ? (void) (0) : __assert_fail<br> ("reply-&gt;element[0]-&gt;type == REDIS_REPLY_STRING", "redis-cli.c"<br>, 8072, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8073"><td class="num" id="LN8073">8073</td><td class="line">    <span class='macro'>assert(reply-&gt;element[1]-&gt;type == REDIS_REPLY_ARRAY)<span class='macro_popup'>((reply-&gt;element[1]-&gt;type == 2) ? (void) (0) : __assert_fail<br> ("reply-&gt;element[1]-&gt;type == REDIS_REPLY_ARRAY", "redis-cli.c"<br>, 8073, __extension__ __PRETTY_FUNCTION__))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8074"><td class="num" id="LN8074">8074</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8075"><td class="num" id="LN8075">8075</td><td class="line">    <span class='comment'>/* Update iterator */</span></td></tr>
<tr class="codeline" data-linenumber="8076"><td class="num" id="LN8076">8076</td><td class="line">    *it = strtoull(reply-&gt;element[0]-&gt;str, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, 10);</td></tr>
<tr class="codeline" data-linenumber="8077"><td class="num" id="LN8077">8077</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8078"><td class="num" id="LN8078">8078</td><td class="line">    <span class='keyword'>return</span> reply;</td></tr>
<tr class="codeline" data-linenumber="8079"><td class="num" id="LN8079">8079</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="8080"><td class="num" id="LN8080">8080</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8081"><td class="num" id="LN8081">8081</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> getDbSize(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="8082"><td class="num" id="LN8082">8082</td><td class="line">    redisReply *reply;</td></tr>
<tr class="codeline" data-linenumber="8083"><td class="num" id="LN8083">8083</td><td class="line">    <span class='keyword'>int</span> size;</td></tr>
<tr class="codeline" data-linenumber="8084"><td class="num" id="LN8084">8084</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8085"><td class="num" id="LN8085">8085</td><td class="line">    reply = redisCommand(context, <span class='string_literal'>"DBSIZE"</span>);</td></tr>
<tr class="codeline" data-linenumber="8086"><td class="num" id="LN8086">8086</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8087"><td class="num" id="LN8087">8087</td><td class="line">    <span class='keyword'>if</span> (reply == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="8088"><td class="num" id="LN8088">8088</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"\nI/O error\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="8089"><td class="num" id="LN8089">8089</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="8090"><td class="num" id="LN8090">8090</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (reply-&gt;type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="8091"><td class="num" id="LN8091">8091</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Couldn't determine DBSIZE: %s\n"</span>, reply-&gt;str);</td></tr>
<tr class="codeline" data-linenumber="8092"><td class="num" id="LN8092">8092</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="8093"><td class="num" id="LN8093">8093</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (reply-&gt;type != <span class='macro'>REDIS_REPLY_INTEGER<span class='macro_popup'>3</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="8094"><td class="num" id="LN8094">8094</td><td class="line">        fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Non INTEGER response from DBSIZE!\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="8095"><td class="num" id="LN8095">8095</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="8096"><td class="num" id="LN8096">8096</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="8097"><td class="num" id="LN8097">8097</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8098"><td class="num" id="LN8098">8098</td><td class="line">    <span class='comment'>/* Grab the number of keys and free our reply */</span></td></tr>
<tr class="codeline" data-linenumber="8099"><td class="num" id="LN8099">8099</td><td class="line">    size = reply-&gt;integer;</td></tr>
<tr class="codeline" data-linenumber="8100"><td class="num" id="LN8100">8100</td><td class="line">    freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="8101"><td class="num" id="LN8101">8101</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8102"><td class="num" id="LN8102">8102</td><td class="line">    <span class='keyword'>return</span> size;</td></tr>
<tr class="codeline" data-linenumber="8103"><td class="num" id="LN8103">8103</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="8104"><td class="num" id="LN8104">8104</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8105"><td class="num" id="LN8105">8105</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> {</td></tr>
<tr class="codeline" data-linenumber="8106"><td class="num" id="LN8106">8106</td><td class="line">    <span class='keyword'>char</span> *name;</td></tr>
<tr class="codeline" data-linenumber="8107"><td class="num" id="LN8107">8107</td><td class="line">    <span class='keyword'>char</span> *sizecmd;</td></tr>
<tr class="codeline" data-linenumber="8108"><td class="num" id="LN8108">8108</td><td class="line">    <span class='keyword'>char</span> *sizeunit;</td></tr>
<tr class="codeline" data-linenumber="8109"><td class="num" id="LN8109">8109</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> biggest;</td></tr>
<tr class="codeline" data-linenumber="8110"><td class="num" id="LN8110">8110</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> count;</td></tr>
<tr class="codeline" data-linenumber="8111"><td class="num" id="LN8111">8111</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> totalsize;</td></tr>
<tr class="codeline" data-linenumber="8112"><td class="num" id="LN8112">8112</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> biggest_key;</td></tr>
<tr class="codeline" data-linenumber="8113"><td class="num" id="LN8113">8113</td><td class="line">} typeinfo;</td></tr>
<tr class="codeline" data-linenumber="8114"><td class="num" id="LN8114">8114</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8115"><td class="num" id="LN8115">8115</td><td class="line">typeinfo type_string = { <span class='string_literal'>"string"</span>, <span class='string_literal'>"STRLEN"</span>, <span class='string_literal'>"bytes"</span> };</td></tr>
<tr class="codeline" data-linenumber="8116"><td class="num" id="LN8116">8116</td><td class="line">typeinfo type_list = { <span class='string_literal'>"list"</span>, <span class='string_literal'>"LLEN"</span>, <span class='string_literal'>"items"</span> };</td></tr>
<tr class="codeline" data-linenumber="8117"><td class="num" id="LN8117">8117</td><td class="line">typeinfo type_set = { <span class='string_literal'>"set"</span>, <span class='string_literal'>"SCARD"</span>, <span class='string_literal'>"members"</span> };</td></tr>
<tr class="codeline" data-linenumber="8118"><td class="num" id="LN8118">8118</td><td class="line">typeinfo type_hash = { <span class='string_literal'>"hash"</span>, <span class='string_literal'>"HLEN"</span>, <span class='string_literal'>"fields"</span> };</td></tr>
<tr class="codeline" data-linenumber="8119"><td class="num" id="LN8119">8119</td><td class="line">typeinfo type_zset = { <span class='string_literal'>"zset"</span>, <span class='string_literal'>"ZCARD"</span>, <span class='string_literal'>"members"</span> };</td></tr>
<tr class="codeline" data-linenumber="8120"><td class="num" id="LN8120">8120</td><td class="line">typeinfo type_stream = { <span class='string_literal'>"stream"</span>, <span class='string_literal'>"XLEN"</span>, <span class='string_literal'>"entries"</span> };</td></tr>
<tr class="codeline" data-linenumber="8121"><td class="num" id="LN8121">8121</td><td class="line">typeinfo type_other = { <span class='string_literal'>"other"</span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='string_literal'>"?"</span> };</td></tr>
<tr class="codeline" data-linenumber="8122"><td class="num" id="LN8122">8122</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8123"><td class="num" id="LN8123">8123</td><td class="line"><span class='keyword'>static</span> typeinfo* typeinfo_add(dict *types, <span class='keyword'>char</span>* name, typeinfo* type_template) {</td></tr>
<tr class="codeline" data-linenumber="8124"><td class="num" id="LN8124">8124</td><td class="line">    typeinfo *info = zmalloc(<span class='keyword'>sizeof</span>(typeinfo));</td></tr>
<tr class="codeline" data-linenumber="8125"><td class="num" id="LN8125">8125</td><td class="line">    *info = *type_template;</td></tr>
<tr class="codeline" data-linenumber="8126"><td class="num" id="LN8126">8126</td><td class="line">    info-&gt;name = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(name);</td></tr>
<tr class="codeline" data-linenumber="8127"><td class="num" id="LN8127">8127</td><td class="line">    dictAdd(types, info-&gt;name, info);</td></tr>
<tr class="codeline" data-linenumber="8128"><td class="num" id="LN8128">8128</td><td class="line">    <span class='keyword'>return</span> info;</td></tr>
<tr class="codeline" data-linenumber="8129"><td class="num" id="LN8129">8129</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="8130"><td class="num" id="LN8130">8130</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8131"><td class="num" id="LN8131">8131</td><td class="line"><span class='keyword'>void</span> type_free(dict *d, <span class='keyword'>void</span>* val) {</td></tr>
<tr class="codeline" data-linenumber="8132"><td class="num" id="LN8132">8132</td><td class="line">    typeinfo *info = val;</td></tr>
<tr class="codeline" data-linenumber="8133"><td class="num" id="LN8133">8133</td><td class="line">    <span class='macro'>UNUSED(d)<span class='macro_popup'>((void) d)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8134"><td class="num" id="LN8134">8134</td><td class="line">    <span class='keyword'>if</span> (info-&gt;biggest_key)</td></tr>
<tr class="codeline" data-linenumber="8135"><td class="num" id="LN8135">8135</td><td class="line">        <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(info-&gt;biggest_key);</td></tr>
<tr class="codeline" data-linenumber="8136"><td class="num" id="LN8136">8136</td><td class="line">    <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(info-&gt;name);</td></tr>
<tr class="codeline" data-linenumber="8137"><td class="num" id="LN8137">8137</td><td class="line">    zfree(info);</td></tr>
<tr class="codeline" data-linenumber="8138"><td class="num" id="LN8138">8138</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="8139"><td class="num" id="LN8139">8139</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8140"><td class="num" id="LN8140">8140</td><td class="line"><span class='keyword'>static</span> dictType typeinfoDictType = {</td></tr>
<tr class="codeline" data-linenumber="8141"><td class="num" id="LN8141">8141</td><td class="line">    dictSdsHash,               <span class='comment'>/* hash function */</span></td></tr>
<tr class="codeline" data-linenumber="8142"><td class="num" id="LN8142">8142</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                      <span class='comment'>/* key dup */</span></td></tr>
<tr class="codeline" data-linenumber="8143"><td class="num" id="LN8143">8143</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                      <span class='comment'>/* val dup */</span></td></tr>
<tr class="codeline" data-linenumber="8144"><td class="num" id="LN8144">8144</td><td class="line">    dictSdsKeyCompare,         <span class='comment'>/* key compare */</span></td></tr>
<tr class="codeline" data-linenumber="8145"><td class="num" id="LN8145">8145</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                      <span class='comment'>/* key destructor (owned by the value)*/</span></td></tr>
<tr class="codeline" data-linenumber="8146"><td class="num" id="LN8146">8146</td><td class="line">    type_free,                 <span class='comment'>/* val destructor */</span></td></tr>
<tr class="codeline" data-linenumber="8147"><td class="num" id="LN8147">8147</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>                       <span class='comment'>/* allow to expand */</span></td></tr>
<tr class="codeline" data-linenumber="8148"><td class="num" id="LN8148">8148</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="8149"><td class="num" id="LN8149">8149</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8150"><td class="num" id="LN8150">8150</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> getKeyTypes(dict *types_dict, redisReply *keys, typeinfo **types) {</td></tr>
<tr class="codeline" data-linenumber="8151"><td class="num" id="LN8151">8151</td><td class="line">    redisReply *reply;</td></tr>
<tr class="codeline" data-linenumber="8152"><td class="num" id="LN8152">8152</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="8153"><td class="num" id="LN8153">8153</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8154"><td class="num" id="LN8154">8154</td><td class="line">    <span class='comment'>/* Pipeline TYPE commands */</span></td></tr>
<tr class="codeline" data-linenumber="8155"><td class="num" id="LN8155">8155</td><td class="line">    <span class='keyword'>for</span>(i=0;i&lt;keys-&gt;elements;i++) {</td></tr>
<tr class="codeline" data-linenumber="8156"><td class="num" id="LN8156">8156</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>char</span>* argv[] = {<span class='string_literal'>"TYPE"</span>, keys-&gt;element[i]-&gt;str};</td></tr>
<tr class="codeline" data-linenumber="8157"><td class="num" id="LN8157">8157</td><td class="line">        size_t lens[] = {4, keys-&gt;element[i]-&gt;len};</td></tr>
<tr class="codeline" data-linenumber="8158"><td class="num" id="LN8158">8158</td><td class="line">        redisAppendCommandArgv(context, 2, argv, lens);</td></tr>
<tr class="codeline" data-linenumber="8159"><td class="num" id="LN8159">8159</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="8160"><td class="num" id="LN8160">8160</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8161"><td class="num" id="LN8161">8161</td><td class="line">    <span class='comment'>/* Retrieve types */</span></td></tr>
<tr class="codeline" data-linenumber="8162"><td class="num" id="LN8162">8162</td><td class="line">    <span class='keyword'>for</span>(i=0;i&lt;keys-&gt;elements;i++) {</td></tr>
<tr class="codeline" data-linenumber="8163"><td class="num" id="LN8163">8163</td><td class="line">        <span class='keyword'>if</span>(redisGetReply(context, (<span class='keyword'>void</span>**)&amp;reply)!=<span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="8164"><td class="num" id="LN8164">8164</td><td class="line">            fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Error getting type for key '%s' (%d: %s)\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="8165"><td class="num" id="LN8165">8165</td><td class="line">                keys-&gt;element[i]-&gt;str, context-&gt;err, context-&gt;errstr);</td></tr>
<tr class="codeline" data-linenumber="8166"><td class="num" id="LN8166">8166</td><td class="line">            exit(1);</td></tr>
<tr class="codeline" data-linenumber="8167"><td class="num" id="LN8167">8167</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span>(reply-&gt;type != <span class='macro'>REDIS_REPLY_STATUS<span class='macro_popup'>5</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="8168"><td class="num" id="LN8168">8168</td><td class="line">            <span class='keyword'>if</span>(reply-&gt;type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="8169"><td class="num" id="LN8169">8169</td><td class="line">                fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"TYPE returned an error: %s\n"</span>, reply-&gt;str);</td></tr>
<tr class="codeline" data-linenumber="8170"><td class="num" id="LN8170">8170</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="8171"><td class="num" id="LN8171">8171</td><td class="line">                fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,</td></tr>
<tr class="codeline" data-linenumber="8172"><td class="num" id="LN8172">8172</td><td class="line">                    <span class='string_literal'>"Invalid reply type (%d) for TYPE on key '%s'!\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="8173"><td class="num" id="LN8173">8173</td><td class="line">                    reply-&gt;type, keys-&gt;element[i]-&gt;str);</td></tr>
<tr class="codeline" data-linenumber="8174"><td class="num" id="LN8174">8174</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="8175"><td class="num" id="LN8175">8175</td><td class="line">            exit(1);</td></tr>
<tr class="codeline" data-linenumber="8176"><td class="num" id="LN8176">8176</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="8177"><td class="num" id="LN8177">8177</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8178"><td class="num" id="LN8178">8178</td><td class="line">        <span class='macro'>sds<span class='macro_popup'>hisds</span></span> typereply = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(reply-&gt;str);</td></tr>
<tr class="codeline" data-linenumber="8179"><td class="num" id="LN8179">8179</td><td class="line">        dictEntry *de = dictFind(types_dict, typereply);</td></tr>
<tr class="codeline" data-linenumber="8180"><td class="num" id="LN8180">8180</td><td class="line">        <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(typereply);</td></tr>
<tr class="codeline" data-linenumber="8181"><td class="num" id="LN8181">8181</td><td class="line">        typeinfo *type = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8182"><td class="num" id="LN8182">8182</td><td class="line">        <span class='keyword'>if</span> (de)</td></tr>
<tr class="codeline" data-linenumber="8183"><td class="num" id="LN8183">8183</td><td class="line">            type = <span class='macro'>dictGetVal(de)<span class='macro_popup'>((de)-&gt;v.val)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8184"><td class="num" id="LN8184">8184</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (strcmp(reply-&gt;str, <span class='string_literal'>"none"</span>)) <span class='comment'>/* create new types for modules, (but not for deleted keys) */</span></td></tr>
<tr class="codeline" data-linenumber="8185"><td class="num" id="LN8185">8185</td><td class="line">            type = typeinfo_add(types_dict, reply-&gt;str, &amp;type_other);</td></tr>
<tr class="codeline" data-linenumber="8186"><td class="num" id="LN8186">8186</td><td class="line">        types[i] = type;</td></tr>
<tr class="codeline" data-linenumber="8187"><td class="num" id="LN8187">8187</td><td class="line">        freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="8188"><td class="num" id="LN8188">8188</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="8189"><td class="num" id="LN8189">8189</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="8190"><td class="num" id="LN8190">8190</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8191"><td class="num" id="LN8191">8191</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> getKeySizes(redisReply *keys, typeinfo **types,</td></tr>
<tr class="codeline" data-linenumber="8192"><td class="num" id="LN8192">8192</td><td class="line">                        <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> *sizes, <span class='keyword'>int</span> memkeys,</td></tr>
<tr class="codeline" data-linenumber="8193"><td class="num" id="LN8193">8193</td><td class="line">                        <span class='keyword'>unsigned</span> memkeys_samples)</td></tr>
<tr class="codeline" data-linenumber="8194"><td class="num" id="LN8194">8194</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="8195"><td class="num" id="LN8195">8195</td><td class="line">    redisReply *reply;</td></tr>
<tr class="codeline" data-linenumber="8196"><td class="num" id="LN8196">8196</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="8197"><td class="num" id="LN8197">8197</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8198"><td class="num" id="LN8198">8198</td><td class="line">    <span class='comment'>/* Pipeline size commands */</span></td></tr>
<tr class="codeline" data-linenumber="8199"><td class="num" id="LN8199">8199</td><td class="line">    <span class='keyword'>for</span>(i=0;i&lt;keys-&gt;elements;i++) {</td></tr>
<tr class="codeline" data-linenumber="8200"><td class="num" id="LN8200">8200</td><td class="line">        <span class='comment'>/* Skip keys that disappeared between SCAN and TYPE (or unknown types when not in memkeys mode) */</span></td></tr>
<tr class="codeline" data-linenumber="8201"><td class="num" id="LN8201">8201</td><td class="line">        <span class='keyword'>if</span>(!types[i] || (!types[i]-&gt;sizecmd &amp;&amp; !memkeys))</td></tr>
<tr class="codeline" data-linenumber="8202"><td class="num" id="LN8202">8202</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="8203"><td class="num" id="LN8203">8203</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8204"><td class="num" id="LN8204">8204</td><td class="line">        <span class='keyword'>if</span> (!memkeys) {</td></tr>
<tr class="codeline" data-linenumber="8205"><td class="num" id="LN8205">8205</td><td class="line">            <span class='keyword'>const</span> <span class='keyword'>char</span>* argv[] = {types[i]-&gt;sizecmd, keys-&gt;element[i]-&gt;str};</td></tr>
<tr class="codeline" data-linenumber="8206"><td class="num" id="LN8206">8206</td><td class="line">            size_t lens[] = {strlen(types[i]-&gt;sizecmd), keys-&gt;element[i]-&gt;len};</td></tr>
<tr class="codeline" data-linenumber="8207"><td class="num" id="LN8207">8207</td><td class="line">            redisAppendCommandArgv(context, 2, argv, lens);</td></tr>
<tr class="codeline" data-linenumber="8208"><td class="num" id="LN8208">8208</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (memkeys_samples==0) {</td></tr>
<tr class="codeline" data-linenumber="8209"><td class="num" id="LN8209">8209</td><td class="line">            <span class='keyword'>const</span> <span class='keyword'>char</span>* argv[] = {<span class='string_literal'>"MEMORY"</span>, <span class='string_literal'>"USAGE"</span>, keys-&gt;element[i]-&gt;str};</td></tr>
<tr class="codeline" data-linenumber="8210"><td class="num" id="LN8210">8210</td><td class="line">            size_t lens[] = {6, 5, keys-&gt;element[i]-&gt;len};</td></tr>
<tr class="codeline" data-linenumber="8211"><td class="num" id="LN8211">8211</td><td class="line">            redisAppendCommandArgv(context, 3, argv, lens);</td></tr>
<tr class="codeline" data-linenumber="8212"><td class="num" id="LN8212">8212</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="8213"><td class="num" id="LN8213">8213</td><td class="line">            <span class='macro'>sds<span class='macro_popup'>hisds</span></span> samplesstr = <span class='macro'>sdsfromlonglong<span class='macro_popup'>hi_sdsfromlonglong</span></span>(memkeys_samples);</td></tr>
<tr class="codeline" data-linenumber="8214"><td class="num" id="LN8214">8214</td><td class="line">            <span class='keyword'>const</span> <span class='keyword'>char</span>* argv[] = {<span class='string_literal'>"MEMORY"</span>, <span class='string_literal'>"USAGE"</span>, keys-&gt;element[i]-&gt;str, <span class='string_literal'>"SAMPLES"</span>, samplesstr};</td></tr>
<tr class="codeline" data-linenumber="8215"><td class="num" id="LN8215">8215</td><td class="line">            size_t lens[] = {6, 5, keys-&gt;element[i]-&gt;len, 7, <span class='macro'>sdslen<span class='macro_popup'>hi_sdslen</span></span>(samplesstr)};</td></tr>
<tr class="codeline" data-linenumber="8216"><td class="num" id="LN8216">8216</td><td class="line">            redisAppendCommandArgv(context, 5, argv, lens);</td></tr>
<tr class="codeline" data-linenumber="8217"><td class="num" id="LN8217">8217</td><td class="line">            <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(samplesstr);</td></tr>
<tr class="codeline" data-linenumber="8218"><td class="num" id="LN8218">8218</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="8219"><td class="num" id="LN8219">8219</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="8220"><td class="num" id="LN8220">8220</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8221"><td class="num" id="LN8221">8221</td><td class="line">    <span class='comment'>/* Retrieve sizes */</span></td></tr>
<tr class="codeline" data-linenumber="8222"><td class="num" id="LN8222">8222</td><td class="line">    <span class='keyword'>for</span>(i=0;i&lt;keys-&gt;elements;i++) {</td></tr>
<tr class="codeline" data-linenumber="8223"><td class="num" id="LN8223">8223</td><td class="line">        <span class='comment'>/* Skip keys that disappeared between SCAN and TYPE (or unknown types when not in memkeys mode) */</span></td></tr>
<tr class="codeline" data-linenumber="8224"><td class="num" id="LN8224">8224</td><td class="line">        <span class='keyword'>if</span>(!types[i] || (!types[i]-&gt;sizecmd &amp;&amp; !memkeys)) {</td></tr>
<tr class="codeline" data-linenumber="8225"><td class="num" id="LN8225">8225</td><td class="line">            sizes[i] = 0;</td></tr>
<tr class="codeline" data-linenumber="8226"><td class="num" id="LN8226">8226</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="8227"><td class="num" id="LN8227">8227</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="8228"><td class="num" id="LN8228">8228</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8229"><td class="num" id="LN8229">8229</td><td class="line">        <span class='comment'>/* Retrieve size */</span></td></tr>
<tr class="codeline" data-linenumber="8230"><td class="num" id="LN8230">8230</td><td class="line">        <span class='keyword'>if</span>(redisGetReply(context, (<span class='keyword'>void</span>**)&amp;reply)!=<span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="8231"><td class="num" id="LN8231">8231</td><td class="line">            fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Error getting size for key '%s' (%d: %s)\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="8232"><td class="num" id="LN8232">8232</td><td class="line">                keys-&gt;element[i]-&gt;str, context-&gt;err, context-&gt;errstr);</td></tr>
<tr class="codeline" data-linenumber="8233"><td class="num" id="LN8233">8233</td><td class="line">            exit(1);</td></tr>
<tr class="codeline" data-linenumber="8234"><td class="num" id="LN8234">8234</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span>(reply-&gt;type != <span class='macro'>REDIS_REPLY_INTEGER<span class='macro_popup'>3</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="8235"><td class="num" id="LN8235">8235</td><td class="line">            <span class='comment'>/* Theoretically the key could have been removed and</span></td></tr>
<tr class="codeline" data-linenumber="8236"><td class="num" id="LN8236">8236</td><td class="line">             <span class='comment'>* added as a different type between TYPE and SIZE */</span></td></tr>
<tr class="codeline" data-linenumber="8237"><td class="num" id="LN8237">8237</td><td class="line">            fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,</td></tr>
<tr class="codeline" data-linenumber="8238"><td class="num" id="LN8238">8238</td><td class="line">                <span class='string_literal'>"Warning:  %s on '%s' failed (may have changed type)\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="8239"><td class="num" id="LN8239">8239</td><td class="line">                !memkeys? types[i]-&gt;sizecmd: <span class='string_literal'>"MEMORY USAGE"</span>,</td></tr>
<tr class="codeline" data-linenumber="8240"><td class="num" id="LN8240">8240</td><td class="line">                keys-&gt;element[i]-&gt;str);</td></tr>
<tr class="codeline" data-linenumber="8241"><td class="num" id="LN8241">8241</td><td class="line">            sizes[i] = 0;</td></tr>
<tr class="codeline" data-linenumber="8242"><td class="num" id="LN8242">8242</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="8243"><td class="num" id="LN8243">8243</td><td class="line">            sizes[i] = reply-&gt;integer;</td></tr>
<tr class="codeline" data-linenumber="8244"><td class="num" id="LN8244">8244</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="8245"><td class="num" id="LN8245">8245</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8246"><td class="num" id="LN8246">8246</td><td class="line">        freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="8247"><td class="num" id="LN8247">8247</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="8248"><td class="num" id="LN8248">8248</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="8249"><td class="num" id="LN8249">8249</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8250"><td class="num" id="LN8250">8250</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> longStatLoopModeStop(<span class='keyword'>int</span> s) {</td></tr>
<tr class="codeline" data-linenumber="8251"><td class="num" id="LN8251">8251</td><td class="line">    <span class='macro'>UNUSED(s)<span class='macro_popup'>((void) s)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8252"><td class="num" id="LN8252">8252</td><td class="line">    force_cancel_loop = 1;</td></tr>
<tr class="codeline" data-linenumber="8253"><td class="num" id="LN8253">8253</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="8254"><td class="num" id="LN8254">8254</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8255"><td class="num" id="LN8255">8255</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> findBigKeys(<span class='keyword'>int</span> memkeys, <span class='keyword'>unsigned</span> memkeys_samples) {</td></tr>
<tr class="codeline" data-linenumber="8256"><td class="num" id="LN8256">8256</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> sampled = 0, total_keys, totlen=0, *sizes=<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, it=0, scan_loops = 0;</td></tr>
<tr class="codeline" data-linenumber="8257"><td class="num" id="LN8257">8257</td><td class="line">    redisReply *reply, *keys;</td></tr>
<tr class="codeline" data-linenumber="8258"><td class="num" id="LN8258">8258</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> arrsize=0, i;</td></tr>
<tr class="codeline" data-linenumber="8259"><td class="num" id="LN8259">8259</td><td class="line">    dictIterator *di;</td></tr>
<tr class="codeline" data-linenumber="8260"><td class="num" id="LN8260">8260</td><td class="line">    dictEntry *de;</td></tr>
<tr class="codeline" data-linenumber="8261"><td class="num" id="LN8261">8261</td><td class="line">    typeinfo **types = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8262"><td class="num" id="LN8262">8262</td><td class="line">    <span class='keyword'>double</span> pct;</td></tr>
<tr class="codeline" data-linenumber="8263"><td class="num" id="LN8263">8263</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8264"><td class="num" id="LN8264">8264</td><td class="line">    dict *types_dict = dictCreate(&amp;typeinfoDictType);</td></tr>
<tr class="codeline" data-linenumber="8265"><td class="num" id="LN8265">8265</td><td class="line">    typeinfo_add(types_dict, <span class='string_literal'>"string"</span>, &amp;type_string);</td></tr>
<tr class="codeline" data-linenumber="8266"><td class="num" id="LN8266">8266</td><td class="line">    typeinfo_add(types_dict, <span class='string_literal'>"list"</span>, &amp;type_list);</td></tr>
<tr class="codeline" data-linenumber="8267"><td class="num" id="LN8267">8267</td><td class="line">    typeinfo_add(types_dict, <span class='string_literal'>"set"</span>, &amp;type_set);</td></tr>
<tr class="codeline" data-linenumber="8268"><td class="num" id="LN8268">8268</td><td class="line">    typeinfo_add(types_dict, <span class='string_literal'>"hash"</span>, &amp;type_hash);</td></tr>
<tr class="codeline" data-linenumber="8269"><td class="num" id="LN8269">8269</td><td class="line">    typeinfo_add(types_dict, <span class='string_literal'>"zset"</span>, &amp;type_zset);</td></tr>
<tr class="codeline" data-linenumber="8270"><td class="num" id="LN8270">8270</td><td class="line">    typeinfo_add(types_dict, <span class='string_literal'>"stream"</span>, &amp;type_stream);</td></tr>
<tr class="codeline" data-linenumber="8271"><td class="num" id="LN8271">8271</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8272"><td class="num" id="LN8272">8272</td><td class="line">    signal(<span class='macro'>SIGINT<span class='macro_popup'>2</span></span>, longStatLoopModeStop);</td></tr>
<tr class="codeline" data-linenumber="8273"><td class="num" id="LN8273">8273</td><td class="line">    <span class='comment'>/* Total keys pre scanning */</span></td></tr>
<tr class="codeline" data-linenumber="8274"><td class="num" id="LN8274">8274</td><td class="line">    total_keys = getDbSize();</td></tr>
<tr class="codeline" data-linenumber="8275"><td class="num" id="LN8275">8275</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8276"><td class="num" id="LN8276">8276</td><td class="line">    <span class='comment'>/* Status message */</span></td></tr>
<tr class="codeline" data-linenumber="8277"><td class="num" id="LN8277">8277</td><td class="line">    printf(<span class='string_literal'>"\n# Scanning the entire keyspace to find biggest keys as well as\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="8278"><td class="num" id="LN8278">8278</td><td class="line">    printf(<span class='string_literal'>"# average sizes per key type.  You can use -i 0.1 to sleep 0.1 sec\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="8279"><td class="num" id="LN8279">8279</td><td class="line">    printf(<span class='string_literal'>"# per 100 SCAN commands (not usually needed).\n\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="8280"><td class="num" id="LN8280">8280</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8281"><td class="num" id="LN8281">8281</td><td class="line">    <span class='comment'>/* SCAN loop */</span></td></tr>
<tr class="codeline" data-linenumber="8282"><td class="num" id="LN8282">8282</td><td class="line">    <span class='keyword'>do</span> {</td></tr>
<tr class="codeline" data-linenumber="8283"><td class="num" id="LN8283">8283</td><td class="line">        <span class='comment'>/* Calculate approximate percentage completion */</span></td></tr>
<tr class="codeline" data-linenumber="8284"><td class="num" id="LN8284">8284</td><td class="line">        pct = 100 * (<span class='keyword'>double</span>)sampled/total_keys;</td></tr>
<tr class="codeline" data-linenumber="8285"><td class="num" id="LN8285">8285</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8286"><td class="num" id="LN8286">8286</td><td class="line">        <span class='comment'>/* Grab some keys and point to the keys array */</span></td></tr>
<tr class="codeline" data-linenumber="8287"><td class="num" id="LN8287">8287</td><td class="line">        reply = sendScan(&amp;it);</td></tr>
<tr class="codeline" data-linenumber="8288"><td class="num" id="LN8288">8288</td><td class="line">        scan_loops++;</td></tr>
<tr class="codeline" data-linenumber="8289"><td class="num" id="LN8289">8289</td><td class="line">        keys  = reply-&gt;element[1];</td></tr>
<tr class="codeline" data-linenumber="8290"><td class="num" id="LN8290">8290</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8291"><td class="num" id="LN8291">8291</td><td class="line">        <span class='comment'>/* Reallocate our type and size array if we need to */</span></td></tr>
<tr class="codeline" data-linenumber="8292"><td class="num" id="LN8292">8292</td><td class="line">        <span class='keyword'>if</span>(keys-&gt;elements &gt; arrsize) {</td></tr>
<tr class="codeline" data-linenumber="8293"><td class="num" id="LN8293">8293</td><td class="line">            types = zrealloc(types, <span class='keyword'>sizeof</span>(typeinfo*)*keys-&gt;elements);</td></tr>
<tr class="codeline" data-linenumber="8294"><td class="num" id="LN8294">8294</td><td class="line">            sizes = zrealloc(sizes, <span class='keyword'>sizeof</span>(<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span>)*keys-&gt;elements);</td></tr>
<tr class="codeline" data-linenumber="8295"><td class="num" id="LN8295">8295</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8296"><td class="num" id="LN8296">8296</td><td class="line">            <span class='keyword'>if</span>(!types || !sizes) {</td></tr>
<tr class="codeline" data-linenumber="8297"><td class="num" id="LN8297">8297</td><td class="line">                fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Failed to allocate storage for keys!\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="8298"><td class="num" id="LN8298">8298</td><td class="line">                exit(1);</td></tr>
<tr class="codeline" data-linenumber="8299"><td class="num" id="LN8299">8299</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="8300"><td class="num" id="LN8300">8300</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8301"><td class="num" id="LN8301">8301</td><td class="line">            arrsize = keys-&gt;elements;</td></tr>
<tr class="codeline" data-linenumber="8302"><td class="num" id="LN8302">8302</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="8303"><td class="num" id="LN8303">8303</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8304"><td class="num" id="LN8304">8304</td><td class="line">        <span class='comment'>/* Retrieve types and then sizes */</span></td></tr>
<tr class="codeline" data-linenumber="8305"><td class="num" id="LN8305">8305</td><td class="line">        getKeyTypes(types_dict, keys, types);</td></tr>
<tr class="codeline" data-linenumber="8306"><td class="num" id="LN8306">8306</td><td class="line">        getKeySizes(keys, types, sizes, memkeys, memkeys_samples);</td></tr>
<tr class="codeline" data-linenumber="8307"><td class="num" id="LN8307">8307</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8308"><td class="num" id="LN8308">8308</td><td class="line">        <span class='comment'>/* Now update our stats */</span></td></tr>
<tr class="codeline" data-linenumber="8309"><td class="num" id="LN8309">8309</td><td class="line">        <span class='keyword'>for</span>(i=0;i&lt;keys-&gt;elements;i++) {</td></tr>
<tr class="codeline" data-linenumber="8310"><td class="num" id="LN8310">8310</td><td class="line">            typeinfo *type = types[i];</td></tr>
<tr class="codeline" data-linenumber="8311"><td class="num" id="LN8311">8311</td><td class="line">            <span class='comment'>/* Skip keys that disappeared between SCAN and TYPE */</span></td></tr>
<tr class="codeline" data-linenumber="8312"><td class="num" id="LN8312">8312</td><td class="line">            <span class='keyword'>if</span>(!type)</td></tr>
<tr class="codeline" data-linenumber="8313"><td class="num" id="LN8313">8313</td><td class="line">                <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="8314"><td class="num" id="LN8314">8314</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8315"><td class="num" id="LN8315">8315</td><td class="line">            type-&gt;totalsize += sizes[i];</td></tr>
<tr class="codeline" data-linenumber="8316"><td class="num" id="LN8316">8316</td><td class="line">            type-&gt;count++;</td></tr>
<tr class="codeline" data-linenumber="8317"><td class="num" id="LN8317">8317</td><td class="line">            totlen += keys-&gt;element[i]-&gt;len;</td></tr>
<tr class="codeline" data-linenumber="8318"><td class="num" id="LN8318">8318</td><td class="line">            sampled++;</td></tr>
<tr class="codeline" data-linenumber="8319"><td class="num" id="LN8319">8319</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8320"><td class="num" id="LN8320">8320</td><td class="line">            <span class='keyword'>if</span>(type-&gt;biggest&lt;sizes[i]) {</td></tr>
<tr class="codeline" data-linenumber="8321"><td class="num" id="LN8321">8321</td><td class="line">                <span class='comment'>/* Keep track of biggest key name for this type */</span></td></tr>
<tr class="codeline" data-linenumber="8322"><td class="num" id="LN8322">8322</td><td class="line">                <span class='keyword'>if</span> (type-&gt;biggest_key)</td></tr>
<tr class="codeline" data-linenumber="8323"><td class="num" id="LN8323">8323</td><td class="line">                    <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(type-&gt;biggest_key);</td></tr>
<tr class="codeline" data-linenumber="8324"><td class="num" id="LN8324">8324</td><td class="line">                type-&gt;biggest_key = <span class='macro'>sdscatrepr<span class='macro_popup'>hi_sdscatrepr</span></span>(<span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>(), keys-&gt;element[i]-&gt;str, keys-&gt;element[i]-&gt;len);</td></tr>
<tr class="codeline" data-linenumber="8325"><td class="num" id="LN8325">8325</td><td class="line">                <span class='keyword'>if</span>(!type-&gt;biggest_key) {</td></tr>
<tr class="codeline" data-linenumber="8326"><td class="num" id="LN8326">8326</td><td class="line">                    fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Failed to allocate memory for key!\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="8327"><td class="num" id="LN8327">8327</td><td class="line">                    exit(1);</td></tr>
<tr class="codeline" data-linenumber="8328"><td class="num" id="LN8328">8328</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="8329"><td class="num" id="LN8329">8329</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8330"><td class="num" id="LN8330">8330</td><td class="line">                printf(</td></tr>
<tr class="codeline" data-linenumber="8331"><td class="num" id="LN8331">8331</td><td class="line">                   <span class='string_literal'>"[%05.2f%%] Biggest %-6s found so far '%s' with %llu %s\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="8332"><td class="num" id="LN8332">8332</td><td class="line">                   pct, type-&gt;name, type-&gt;biggest_key, sizes[i],</td></tr>
<tr class="codeline" data-linenumber="8333"><td class="num" id="LN8333">8333</td><td class="line">                   !memkeys? type-&gt;sizeunit: <span class='string_literal'>"bytes"</span>);</td></tr>
<tr class="codeline" data-linenumber="8334"><td class="num" id="LN8334">8334</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8335"><td class="num" id="LN8335">8335</td><td class="line">                <span class='comment'>/* Keep track of the biggest size for this type */</span></td></tr>
<tr class="codeline" data-linenumber="8336"><td class="num" id="LN8336">8336</td><td class="line">                type-&gt;biggest = sizes[i];</td></tr>
<tr class="codeline" data-linenumber="8337"><td class="num" id="LN8337">8337</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="8338"><td class="num" id="LN8338">8338</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8339"><td class="num" id="LN8339">8339</td><td class="line">            <span class='comment'>/* Update overall progress */</span></td></tr>
<tr class="codeline" data-linenumber="8340"><td class="num" id="LN8340">8340</td><td class="line">            <span class='keyword'>if</span>(sampled % 1000000 == 0) {</td></tr>
<tr class="codeline" data-linenumber="8341"><td class="num" id="LN8341">8341</td><td class="line">                printf(<span class='string_literal'>"[%05.2f%%] Sampled %llu keys so far\n"</span>, pct, sampled);</td></tr>
<tr class="codeline" data-linenumber="8342"><td class="num" id="LN8342">8342</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="8343"><td class="num" id="LN8343">8343</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="8344"><td class="num" id="LN8344">8344</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8345"><td class="num" id="LN8345">8345</td><td class="line">        <span class='comment'>/* Sleep if we've been directed to do so */</span></td></tr>
<tr class="codeline" data-linenumber="8346"><td class="num" id="LN8346">8346</td><td class="line">        <span class='keyword'>if</span> (config.interval &amp;&amp; (scan_loops % 100) == 0) {</td></tr>
<tr class="codeline" data-linenumber="8347"><td class="num" id="LN8347">8347</td><td class="line">            usleep(config.interval);</td></tr>
<tr class="codeline" data-linenumber="8348"><td class="num" id="LN8348">8348</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="8349"><td class="num" id="LN8349">8349</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8350"><td class="num" id="LN8350">8350</td><td class="line">        freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="8351"><td class="num" id="LN8351">8351</td><td class="line">    } <span class='keyword'>while</span>(force_cancel_loop == 0 &amp;&amp; it != 0);</td></tr>
<tr class="codeline" data-linenumber="8352"><td class="num" id="LN8352">8352</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8353"><td class="num" id="LN8353">8353</td><td class="line">    <span class='keyword'>if</span>(types) zfree(types);</td></tr>
<tr class="codeline" data-linenumber="8354"><td class="num" id="LN8354">8354</td><td class="line">    <span class='keyword'>if</span>(sizes) zfree(sizes);</td></tr>
<tr class="codeline" data-linenumber="8355"><td class="num" id="LN8355">8355</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8356"><td class="num" id="LN8356">8356</td><td class="line">    <span class='comment'>/* We're done */</span></td></tr>
<tr class="codeline" data-linenumber="8357"><td class="num" id="LN8357">8357</td><td class="line">    printf(<span class='string_literal'>"\n-------- summary -------\n\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="8358"><td class="num" id="LN8358">8358</td><td class="line">    <span class='keyword'>if</span> (force_cancel_loop) printf(<span class='string_literal'>"[%05.2f%%] "</span>, pct);</td></tr>
<tr class="codeline" data-linenumber="8359"><td class="num" id="LN8359">8359</td><td class="line">    printf(<span class='string_literal'>"Sampled %llu keys in the keyspace!\n"</span>, sampled);</td></tr>
<tr class="codeline" data-linenumber="8360"><td class="num" id="LN8360">8360</td><td class="line">    printf(<span class='string_literal'>"Total key length in bytes is %llu (avg len %.2f)\n\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="8361"><td class="num" id="LN8361">8361</td><td class="line">       totlen, totlen ? (<span class='keyword'>double</span>)totlen/sampled : 0);</td></tr>
<tr class="codeline" data-linenumber="8362"><td class="num" id="LN8362">8362</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8363"><td class="num" id="LN8363">8363</td><td class="line">    <span class='comment'>/* Output the biggest keys we found, for types we did find */</span></td></tr>
<tr class="codeline" data-linenumber="8364"><td class="num" id="LN8364">8364</td><td class="line">    di = dictGetIterator(types_dict);</td></tr>
<tr class="codeline" data-linenumber="8365"><td class="num" id="LN8365">8365</td><td class="line">    <span class='keyword'>while</span> ((de = dictNext(di))) {</td></tr>
<tr class="codeline" data-linenumber="8366"><td class="num" id="LN8366">8366</td><td class="line">        typeinfo *type = <span class='macro'>dictGetVal(de)<span class='macro_popup'>((de)-&gt;v.val)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8367"><td class="num" id="LN8367">8367</td><td class="line">        <span class='keyword'>if</span>(type-&gt;biggest_key) {</td></tr>
<tr class="codeline" data-linenumber="8368"><td class="num" id="LN8368">8368</td><td class="line">            printf(<span class='string_literal'>"Biggest %6s found '%s' has %llu %s\n"</span>, type-&gt;name, type-&gt;biggest_key,</td></tr>
<tr class="codeline" data-linenumber="8369"><td class="num" id="LN8369">8369</td><td class="line">               type-&gt;biggest, !memkeys? type-&gt;sizeunit: <span class='string_literal'>"bytes"</span>);</td></tr>
<tr class="codeline" data-linenumber="8370"><td class="num" id="LN8370">8370</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="8371"><td class="num" id="LN8371">8371</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="8372"><td class="num" id="LN8372">8372</td><td class="line">    dictReleaseIterator(di);</td></tr>
<tr class="codeline" data-linenumber="8373"><td class="num" id="LN8373">8373</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8374"><td class="num" id="LN8374">8374</td><td class="line">    printf(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="8375"><td class="num" id="LN8375">8375</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8376"><td class="num" id="LN8376">8376</td><td class="line">    di = dictGetIterator(types_dict);</td></tr>
<tr class="codeline" data-linenumber="8377"><td class="num" id="LN8377">8377</td><td class="line">    <span class='keyword'>while</span> ((de = dictNext(di))) {</td></tr>
<tr class="codeline" data-linenumber="8378"><td class="num" id="LN8378">8378</td><td class="line">        typeinfo *type = <span class='macro'>dictGetVal(de)<span class='macro_popup'>((de)-&gt;v.val)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8379"><td class="num" id="LN8379">8379</td><td class="line">        printf(<span class='string_literal'>"%llu %ss with %llu %s (%05.2f%% of keys, avg size %.2f)\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="8380"><td class="num" id="LN8380">8380</td><td class="line">           type-&gt;count, type-&gt;name, type-&gt;totalsize, !memkeys? type-&gt;sizeunit: <span class='string_literal'>"bytes"</span>,</td></tr>
<tr class="codeline" data-linenumber="8381"><td class="num" id="LN8381">8381</td><td class="line">           sampled ? 100 * (<span class='keyword'>double</span>)type-&gt;count/sampled : 0,</td></tr>
<tr class="codeline" data-linenumber="8382"><td class="num" id="LN8382">8382</td><td class="line">           type-&gt;count ? (<span class='keyword'>double</span>)type-&gt;totalsize/type-&gt;count : 0);</td></tr>
<tr class="codeline" data-linenumber="8383"><td class="num" id="LN8383">8383</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="8384"><td class="num" id="LN8384">8384</td><td class="line">    dictReleaseIterator(di);</td></tr>
<tr class="codeline" data-linenumber="8385"><td class="num" id="LN8385">8385</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8386"><td class="num" id="LN8386">8386</td><td class="line">    dictRelease(types_dict);</td></tr>
<tr class="codeline" data-linenumber="8387"><td class="num" id="LN8387">8387</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8388"><td class="num" id="LN8388">8388</td><td class="line">    <span class='comment'>/* Success! */</span></td></tr>
<tr class="codeline" data-linenumber="8389"><td class="num" id="LN8389">8389</td><td class="line">    exit(0);</td></tr>
<tr class="codeline" data-linenumber="8390"><td class="num" id="LN8390">8390</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="8391"><td class="num" id="LN8391">8391</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8392"><td class="num" id="LN8392">8392</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> getKeyFreqs(redisReply *keys, <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> *freqs) {</td></tr>
<tr class="codeline" data-linenumber="8393"><td class="num" id="LN8393">8393</td><td class="line">    redisReply *reply;</td></tr>
<tr class="codeline" data-linenumber="8394"><td class="num" id="LN8394">8394</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="8395"><td class="num" id="LN8395">8395</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8396"><td class="num" id="LN8396">8396</td><td class="line">    <span class='comment'>/* Pipeline OBJECT freq commands */</span></td></tr>
<tr class="codeline" data-linenumber="8397"><td class="num" id="LN8397">8397</td><td class="line">    <span class='keyword'>for</span>(i=0;i&lt;keys-&gt;elements;i++) {</td></tr>
<tr class="codeline" data-linenumber="8398"><td class="num" id="LN8398">8398</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>char</span>* argv[] = {<span class='string_literal'>"OBJECT"</span>, <span class='string_literal'>"FREQ"</span>, keys-&gt;element[i]-&gt;str};</td></tr>
<tr class="codeline" data-linenumber="8399"><td class="num" id="LN8399">8399</td><td class="line">        size_t lens[] = {6, 4, keys-&gt;element[i]-&gt;len};</td></tr>
<tr class="codeline" data-linenumber="8400"><td class="num" id="LN8400">8400</td><td class="line">        redisAppendCommandArgv(context, 3, argv, lens);</td></tr>
<tr class="codeline" data-linenumber="8401"><td class="num" id="LN8401">8401</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="8402"><td class="num" id="LN8402">8402</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8403"><td class="num" id="LN8403">8403</td><td class="line">    <span class='comment'>/* Retrieve freqs */</span></td></tr>
<tr class="codeline" data-linenumber="8404"><td class="num" id="LN8404">8404</td><td class="line">    <span class='keyword'>for</span>(i=0;i&lt;keys-&gt;elements;i++) {</td></tr>
<tr class="codeline" data-linenumber="8405"><td class="num" id="LN8405">8405</td><td class="line">        <span class='keyword'>if</span>(redisGetReply(context, (<span class='keyword'>void</span>**)&amp;reply)!=<span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="8406"><td class="num" id="LN8406">8406</td><td class="line">            <span class='macro'>sds<span class='macro_popup'>hisds</span></span> keyname = <span class='macro'>sdscatrepr<span class='macro_popup'>hi_sdscatrepr</span></span>(<span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>(), keys-&gt;element[i]-&gt;str, keys-&gt;element[i]-&gt;len);</td></tr>
<tr class="codeline" data-linenumber="8407"><td class="num" id="LN8407">8407</td><td class="line">            fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Error getting freq for key '%s' (%d: %s)\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="8408"><td class="num" id="LN8408">8408</td><td class="line">                keyname, context-&gt;err, context-&gt;errstr);</td></tr>
<tr class="codeline" data-linenumber="8409"><td class="num" id="LN8409">8409</td><td class="line">            <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(keyname);</td></tr>
<tr class="codeline" data-linenumber="8410"><td class="num" id="LN8410">8410</td><td class="line">            exit(1);</td></tr>
<tr class="codeline" data-linenumber="8411"><td class="num" id="LN8411">8411</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span>(reply-&gt;type != <span class='macro'>REDIS_REPLY_INTEGER<span class='macro_popup'>3</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="8412"><td class="num" id="LN8412">8412</td><td class="line">            <span class='keyword'>if</span>(reply-&gt;type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="8413"><td class="num" id="LN8413">8413</td><td class="line">                fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Error: %s\n"</span>, reply-&gt;str);</td></tr>
<tr class="codeline" data-linenumber="8414"><td class="num" id="LN8414">8414</td><td class="line">                exit(1);</td></tr>
<tr class="codeline" data-linenumber="8415"><td class="num" id="LN8415">8415</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="8416"><td class="num" id="LN8416">8416</td><td class="line">                <span class='macro'>sds<span class='macro_popup'>hisds</span></span> keyname = <span class='macro'>sdscatrepr<span class='macro_popup'>hi_sdscatrepr</span></span>(<span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>(), keys-&gt;element[i]-&gt;str, keys-&gt;element[i]-&gt;len);</td></tr>
<tr class="codeline" data-linenumber="8417"><td class="num" id="LN8417">8417</td><td class="line">                fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Warning: OBJECT freq on '%s' failed (may have been deleted)\n"</span>, keyname);</td></tr>
<tr class="codeline" data-linenumber="8418"><td class="num" id="LN8418">8418</td><td class="line">                <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(keyname);</td></tr>
<tr class="codeline" data-linenumber="8419"><td class="num" id="LN8419">8419</td><td class="line">                freqs[i] = 0;</td></tr>
<tr class="codeline" data-linenumber="8420"><td class="num" id="LN8420">8420</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="8421"><td class="num" id="LN8421">8421</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="8422"><td class="num" id="LN8422">8422</td><td class="line">            freqs[i] = reply-&gt;integer;</td></tr>
<tr class="codeline" data-linenumber="8423"><td class="num" id="LN8423">8423</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="8424"><td class="num" id="LN8424">8424</td><td class="line">        freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="8425"><td class="num" id="LN8425">8425</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="8426"><td class="num" id="LN8426">8426</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="8427"><td class="num" id="LN8427">8427</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8428"><td class="num" id="LN8428">8428</td><td class="line"><span class='directive'>#define <span class='macro'>HOTKEYS_SAMPLE<span class='macro_popup'>16</span></span> 16</span></td></tr>
<tr class="codeline" data-linenumber="8429"><td class="num" id="LN8429">8429</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> findHotKeys(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="8430"><td class="num" id="LN8430">8430</td><td class="line">    redisReply *keys, *reply;</td></tr>
<tr class="codeline" data-linenumber="8431"><td class="num" id="LN8431">8431</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> counters[<span class='macro'>HOTKEYS_SAMPLE<span class='macro_popup'>16</span></span>] = {0};</td></tr>
<tr class="codeline" data-linenumber="8432"><td class="num" id="LN8432">8432</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> hotkeys[<span class='macro'>HOTKEYS_SAMPLE<span class='macro_popup'>16</span></span>] = {<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>};</td></tr>
<tr class="codeline" data-linenumber="8433"><td class="num" id="LN8433">8433</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> sampled = 0, total_keys, *freqs = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, it = 0, scan_loops = 0;</td></tr>
<tr class="codeline" data-linenumber="8434"><td class="num" id="LN8434">8434</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> arrsize = 0, i, k;</td></tr>
<tr class="codeline" data-linenumber="8435"><td class="num" id="LN8435">8435</td><td class="line">    <span class='keyword'>double</span> pct;</td></tr>
<tr class="codeline" data-linenumber="8436"><td class="num" id="LN8436">8436</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8437"><td class="num" id="LN8437">8437</td><td class="line">    signal(<span class='macro'>SIGINT<span class='macro_popup'>2</span></span>, longStatLoopModeStop);</td></tr>
<tr class="codeline" data-linenumber="8438"><td class="num" id="LN8438">8438</td><td class="line">    <span class='comment'>/* Total keys pre scanning */</span></td></tr>
<tr class="codeline" data-linenumber="8439"><td class="num" id="LN8439">8439</td><td class="line">    total_keys = getDbSize();</td></tr>
<tr class="codeline" data-linenumber="8440"><td class="num" id="LN8440">8440</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8441"><td class="num" id="LN8441">8441</td><td class="line">    <span class='comment'>/* Status message */</span></td></tr>
<tr class="codeline" data-linenumber="8442"><td class="num" id="LN8442">8442</td><td class="line">    printf(<span class='string_literal'>"\n# Scanning the entire keyspace to find hot keys as well as\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="8443"><td class="num" id="LN8443">8443</td><td class="line">    printf(<span class='string_literal'>"# average sizes per key type.  You can use -i 0.1 to sleep 0.1 sec\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="8444"><td class="num" id="LN8444">8444</td><td class="line">    printf(<span class='string_literal'>"# per 100 SCAN commands (not usually needed).\n\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="8445"><td class="num" id="LN8445">8445</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8446"><td class="num" id="LN8446">8446</td><td class="line">    <span class='comment'>/* SCAN loop */</span></td></tr>
<tr class="codeline" data-linenumber="8447"><td class="num" id="LN8447">8447</td><td class="line">    <span class='keyword'>do</span> {</td></tr>
<tr class="codeline" data-linenumber="8448"><td class="num" id="LN8448">8448</td><td class="line">        <span class='comment'>/* Calculate approximate percentage completion */</span></td></tr>
<tr class="codeline" data-linenumber="8449"><td class="num" id="LN8449">8449</td><td class="line">        pct = 100 * (<span class='keyword'>double</span>)sampled/total_keys;</td></tr>
<tr class="codeline" data-linenumber="8450"><td class="num" id="LN8450">8450</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8451"><td class="num" id="LN8451">8451</td><td class="line">        <span class='comment'>/* Grab some keys and point to the keys array */</span></td></tr>
<tr class="codeline" data-linenumber="8452"><td class="num" id="LN8452">8452</td><td class="line">        reply = sendScan(&amp;it);</td></tr>
<tr class="codeline" data-linenumber="8453"><td class="num" id="LN8453">8453</td><td class="line">        scan_loops++;</td></tr>
<tr class="codeline" data-linenumber="8454"><td class="num" id="LN8454">8454</td><td class="line">        keys  = reply-&gt;element[1];</td></tr>
<tr class="codeline" data-linenumber="8455"><td class="num" id="LN8455">8455</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8456"><td class="num" id="LN8456">8456</td><td class="line">        <span class='comment'>/* Reallocate our freqs array if we need to */</span></td></tr>
<tr class="codeline" data-linenumber="8457"><td class="num" id="LN8457">8457</td><td class="line">        <span class='keyword'>if</span>(keys-&gt;elements &gt; arrsize) {</td></tr>
<tr class="codeline" data-linenumber="8458"><td class="num" id="LN8458">8458</td><td class="line">            freqs = zrealloc(freqs, <span class='keyword'>sizeof</span>(<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span>)*keys-&gt;elements);</td></tr>
<tr class="codeline" data-linenumber="8459"><td class="num" id="LN8459">8459</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8460"><td class="num" id="LN8460">8460</td><td class="line">            <span class='keyword'>if</span>(!freqs) {</td></tr>
<tr class="codeline" data-linenumber="8461"><td class="num" id="LN8461">8461</td><td class="line">                fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Failed to allocate storage for keys!\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="8462"><td class="num" id="LN8462">8462</td><td class="line">                exit(1);</td></tr>
<tr class="codeline" data-linenumber="8463"><td class="num" id="LN8463">8463</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="8464"><td class="num" id="LN8464">8464</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8465"><td class="num" id="LN8465">8465</td><td class="line">            arrsize = keys-&gt;elements;</td></tr>
<tr class="codeline" data-linenumber="8466"><td class="num" id="LN8466">8466</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="8467"><td class="num" id="LN8467">8467</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8468"><td class="num" id="LN8468">8468</td><td class="line">        getKeyFreqs(keys, freqs);</td></tr>
<tr class="codeline" data-linenumber="8469"><td class="num" id="LN8469">8469</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8470"><td class="num" id="LN8470">8470</td><td class="line">        <span class='comment'>/* Now update our stats */</span></td></tr>
<tr class="codeline" data-linenumber="8471"><td class="num" id="LN8471">8471</td><td class="line">        <span class='keyword'>for</span>(i=0;i&lt;keys-&gt;elements;i++) {</td></tr>
<tr class="codeline" data-linenumber="8472"><td class="num" id="LN8472">8472</td><td class="line">            sampled++;</td></tr>
<tr class="codeline" data-linenumber="8473"><td class="num" id="LN8473">8473</td><td class="line">            <span class='comment'>/* Update overall progress */</span></td></tr>
<tr class="codeline" data-linenumber="8474"><td class="num" id="LN8474">8474</td><td class="line">            <span class='keyword'>if</span>(sampled % 1000000 == 0) {</td></tr>
<tr class="codeline" data-linenumber="8475"><td class="num" id="LN8475">8475</td><td class="line">                printf(<span class='string_literal'>"[%05.2f%%] Sampled %llu keys so far\n"</span>, pct, sampled);</td></tr>
<tr class="codeline" data-linenumber="8476"><td class="num" id="LN8476">8476</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="8477"><td class="num" id="LN8477">8477</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8478"><td class="num" id="LN8478">8478</td><td class="line">            <span class='comment'>/* Use eviction pool here */</span></td></tr>
<tr class="codeline" data-linenumber="8479"><td class="num" id="LN8479">8479</td><td class="line">            k = 0;</td></tr>
<tr class="codeline" data-linenumber="8480"><td class="num" id="LN8480">8480</td><td class="line">            <span class='keyword'>while</span> (k &lt; <span class='macro'>HOTKEYS_SAMPLE<span class='macro_popup'>16</span></span> &amp;&amp; freqs[i] &gt; counters[k]) k++;</td></tr>
<tr class="codeline" data-linenumber="8481"><td class="num" id="LN8481">8481</td><td class="line">            <span class='keyword'>if</span> (k == 0) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="8482"><td class="num" id="LN8482">8482</td><td class="line">            k--;</td></tr>
<tr class="codeline" data-linenumber="8483"><td class="num" id="LN8483">8483</td><td class="line">            <span class='keyword'>if</span> (k == 0 || counters[k] == 0) {</td></tr>
<tr class="codeline" data-linenumber="8484"><td class="num" id="LN8484">8484</td><td class="line">                <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(hotkeys[k]);</td></tr>
<tr class="codeline" data-linenumber="8485"><td class="num" id="LN8485">8485</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="8486"><td class="num" id="LN8486">8486</td><td class="line">                <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(hotkeys[0]);</td></tr>
<tr class="codeline" data-linenumber="8487"><td class="num" id="LN8487">8487</td><td class="line">                memmove(counters,counters+1,<span class='keyword'>sizeof</span>(counters[0])*k);</td></tr>
<tr class="codeline" data-linenumber="8488"><td class="num" id="LN8488">8488</td><td class="line">                memmove(hotkeys,hotkeys+1,<span class='keyword'>sizeof</span>(hotkeys[0])*k);</td></tr>
<tr class="codeline" data-linenumber="8489"><td class="num" id="LN8489">8489</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="8490"><td class="num" id="LN8490">8490</td><td class="line">            counters[k] = freqs[i];</td></tr>
<tr class="codeline" data-linenumber="8491"><td class="num" id="LN8491">8491</td><td class="line">            hotkeys[k] = <span class='macro'>sdscatrepr<span class='macro_popup'>hi_sdscatrepr</span></span>(<span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>(), keys-&gt;element[i]-&gt;str, keys-&gt;element[i]-&gt;len);</td></tr>
<tr class="codeline" data-linenumber="8492"><td class="num" id="LN8492">8492</td><td class="line">            printf(</td></tr>
<tr class="codeline" data-linenumber="8493"><td class="num" id="LN8493">8493</td><td class="line">               <span class='string_literal'>"[%05.2f%%] Hot key '%s' found so far with counter %llu\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="8494"><td class="num" id="LN8494">8494</td><td class="line">               pct, hotkeys[k], freqs[i]);</td></tr>
<tr class="codeline" data-linenumber="8495"><td class="num" id="LN8495">8495</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="8496"><td class="num" id="LN8496">8496</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8497"><td class="num" id="LN8497">8497</td><td class="line">        <span class='comment'>/* Sleep if we've been directed to do so */</span></td></tr>
<tr class="codeline" data-linenumber="8498"><td class="num" id="LN8498">8498</td><td class="line">        <span class='keyword'>if</span> (config.interval &amp;&amp; (scan_loops % 100) == 0) {</td></tr>
<tr class="codeline" data-linenumber="8499"><td class="num" id="LN8499">8499</td><td class="line">            usleep(config.interval);</td></tr>
<tr class="codeline" data-linenumber="8500"><td class="num" id="LN8500">8500</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="8501"><td class="num" id="LN8501">8501</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8502"><td class="num" id="LN8502">8502</td><td class="line">        freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="8503"><td class="num" id="LN8503">8503</td><td class="line">    } <span class='keyword'>while</span>(force_cancel_loop ==0 &amp;&amp; it != 0);</td></tr>
<tr class="codeline" data-linenumber="8504"><td class="num" id="LN8504">8504</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8505"><td class="num" id="LN8505">8505</td><td class="line">    <span class='keyword'>if</span> (freqs) zfree(freqs);</td></tr>
<tr class="codeline" data-linenumber="8506"><td class="num" id="LN8506">8506</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8507"><td class="num" id="LN8507">8507</td><td class="line">    <span class='comment'>/* We're done */</span></td></tr>
<tr class="codeline" data-linenumber="8508"><td class="num" id="LN8508">8508</td><td class="line">    printf(<span class='string_literal'>"\n-------- summary -------\n\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="8509"><td class="num" id="LN8509">8509</td><td class="line">    <span class='keyword'>if</span>(force_cancel_loop)printf(<span class='string_literal'>"[%05.2f%%] "</span>,pct);</td></tr>
<tr class="codeline" data-linenumber="8510"><td class="num" id="LN8510">8510</td><td class="line">    printf(<span class='string_literal'>"Sampled %llu keys in the keyspace!\n"</span>, sampled);</td></tr>
<tr class="codeline" data-linenumber="8511"><td class="num" id="LN8511">8511</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8512"><td class="num" id="LN8512">8512</td><td class="line">    <span class='keyword'>for</span> (i=1; i&lt;= <span class='macro'>HOTKEYS_SAMPLE<span class='macro_popup'>16</span></span>; i++) {</td></tr>
<tr class="codeline" data-linenumber="8513"><td class="num" id="LN8513">8513</td><td class="line">        k = <span class='macro'>HOTKEYS_SAMPLE<span class='macro_popup'>16</span></span> - i;</td></tr>
<tr class="codeline" data-linenumber="8514"><td class="num" id="LN8514">8514</td><td class="line">        <span class='keyword'>if</span>(counters[k]&gt;0) {</td></tr>
<tr class="codeline" data-linenumber="8515"><td class="num" id="LN8515">8515</td><td class="line">            printf(<span class='string_literal'>"hot key found with counter: %llu\tkeyname: %s\n"</span>, counters[k], hotkeys[k]);</td></tr>
<tr class="codeline" data-linenumber="8516"><td class="num" id="LN8516">8516</td><td class="line">            <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(hotkeys[k]);</td></tr>
<tr class="codeline" data-linenumber="8517"><td class="num" id="LN8517">8517</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="8518"><td class="num" id="LN8518">8518</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="8519"><td class="num" id="LN8519">8519</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8520"><td class="num" id="LN8520">8520</td><td class="line">    exit(0);</td></tr>
<tr class="codeline" data-linenumber="8521"><td class="num" id="LN8521">8521</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="8522"><td class="num" id="LN8522">8522</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8523"><td class="num" id="LN8523">8523</td><td class="line"><span class='comment'>/*------------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="8524"><td class="num" id="LN8524">8524</td><td class="line"> <span class='comment'>* Stats mode</span></td></tr>
<tr class="codeline" data-linenumber="8525"><td class="num" id="LN8525">8525</td><td class="line"> <span class='comment'>*--------------------------------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="8526"><td class="num" id="LN8526">8526</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8527"><td class="num" id="LN8527">8527</td><td class="line"><span class='comment'>/* Return the specified INFO field from the INFO command output "info".</span></td></tr>
<tr class="codeline" data-linenumber="8528"><td class="num" id="LN8528">8528</td><td class="line"> <span class='comment'>* A new buffer is allocated for the result, that needs to be free'd.</span></td></tr>
<tr class="codeline" data-linenumber="8529"><td class="num" id="LN8529">8529</td><td class="line"> <span class='comment'>* If the field is not found NULL is returned. */</span></td></tr>
<tr class="codeline" data-linenumber="8530"><td class="num" id="LN8530">8530</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>char</span> *getInfoField(<span class='keyword'>char</span> *info, <span class='keyword'>char</span> *field) {</td></tr>
<tr class="codeline" data-linenumber="8531"><td class="num" id="LN8531">8531</td><td class="line">    <span class='keyword'>char</span> *p = strstr(info,field);</td></tr>
<tr class="codeline" data-linenumber="8532"><td class="num" id="LN8532">8532</td><td class="line">    <span class='keyword'>char</span> *n1, *n2;</td></tr>
<tr class="codeline" data-linenumber="8533"><td class="num" id="LN8533">8533</td><td class="line">    <span class='keyword'>char</span> *result;</td></tr>
<tr class="codeline" data-linenumber="8534"><td class="num" id="LN8534">8534</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8535"><td class="num" id="LN8535">8535</td><td class="line">    <span class='keyword'>if</span> (!p) <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8536"><td class="num" id="LN8536">8536</td><td class="line">    p += strlen(field)+1;</td></tr>
<tr class="codeline" data-linenumber="8537"><td class="num" id="LN8537">8537</td><td class="line">    n1 = strchr(p,'\r');</td></tr>
<tr class="codeline" data-linenumber="8538"><td class="num" id="LN8538">8538</td><td class="line">    n2 = strchr(p,',');</td></tr>
<tr class="codeline" data-linenumber="8539"><td class="num" id="LN8539">8539</td><td class="line">    <span class='keyword'>if</span> (n2 &amp;&amp; n2 &lt; n1) n1 = n2;</td></tr>
<tr class="codeline" data-linenumber="8540"><td class="num" id="LN8540">8540</td><td class="line">    result = zmalloc(<span class='keyword'>sizeof</span>(<span class='keyword'>char</span>)*(n1-p)+1);</td></tr>
<tr class="codeline" data-linenumber="8541"><td class="num" id="LN8541">8541</td><td class="line">    memcpy(result,p,(n1-p));</td></tr>
<tr class="codeline" data-linenumber="8542"><td class="num" id="LN8542">8542</td><td class="line">    result[n1-p] = '\0';</td></tr>
<tr class="codeline" data-linenumber="8543"><td class="num" id="LN8543">8543</td><td class="line">    <span class='keyword'>return</span> result;</td></tr>
<tr class="codeline" data-linenumber="8544"><td class="num" id="LN8544">8544</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="8545"><td class="num" id="LN8545">8545</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8546"><td class="num" id="LN8546">8546</td><td class="line"><span class='comment'>/* Like the above function but automatically convert the result into</span></td></tr>
<tr class="codeline" data-linenumber="8547"><td class="num" id="LN8547">8547</td><td class="line"> <span class='comment'>* a long. On error (missing field) LONG_MIN is returned. */</span></td></tr>
<tr class="codeline" data-linenumber="8548"><td class="num" id="LN8548">8548</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>long</span> getLongInfoField(<span class='keyword'>char</span> *info, <span class='keyword'>char</span> *field) {</td></tr>
<tr class="codeline" data-linenumber="8549"><td class="num" id="LN8549">8549</td><td class="line">    <span class='keyword'>char</span> *value = getInfoField(info,field);</td></tr>
<tr class="codeline" data-linenumber="8550"><td class="num" id="LN8550">8550</td><td class="line">    <span class='keyword'>long</span> l;</td></tr>
<tr class="codeline" data-linenumber="8551"><td class="num" id="LN8551">8551</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8552"><td class="num" id="LN8552">8552</td><td class="line">    <span class='keyword'>if</span> (!value) <span class='keyword'>return</span> <span class='macro'>LONG_MIN<span class='macro_popup'>(-9223372036854775807L -1L)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8553"><td class="num" id="LN8553">8553</td><td class="line">    l = strtol(value,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,10);</td></tr>
<tr class="codeline" data-linenumber="8554"><td class="num" id="LN8554">8554</td><td class="line">    zfree(value);</td></tr>
<tr class="codeline" data-linenumber="8555"><td class="num" id="LN8555">8555</td><td class="line">    <span class='keyword'>return</span> l;</td></tr>
<tr class="codeline" data-linenumber="8556"><td class="num" id="LN8556">8556</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="8557"><td class="num" id="LN8557">8557</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8558"><td class="num" id="LN8558">8558</td><td class="line"><span class='comment'>/* Convert number of bytes into a human readable string of the form:</span></td></tr>
<tr class="codeline" data-linenumber="8559"><td class="num" id="LN8559">8559</td><td class="line"> <span class='comment'>* 100B, 2G, 100M, 4K, and so forth. */</span></td></tr>
<tr class="codeline" data-linenumber="8560"><td class="num" id="LN8560">8560</td><td class="line"><span class='keyword'>void</span> bytesToHuman(<span class='keyword'>char</span> *s, <span class='keyword'>long</span> <span class='keyword'>long</span> n) {</td></tr>
<tr class="codeline" data-linenumber="8561"><td class="num" id="LN8561">8561</td><td class="line">    <span class='keyword'>double</span> d;</td></tr>
<tr class="codeline" data-linenumber="8562"><td class="num" id="LN8562">8562</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8563"><td class="num" id="LN8563">8563</td><td class="line">    <span class='keyword'>if</span> (n &lt; 0) {</td></tr>
<tr class="codeline" data-linenumber="8564"><td class="num" id="LN8564">8564</td><td class="line">        *s = '-';</td></tr>
<tr class="codeline" data-linenumber="8565"><td class="num" id="LN8565">8565</td><td class="line">        s++;</td></tr>
<tr class="codeline" data-linenumber="8566"><td class="num" id="LN8566">8566</td><td class="line">        n = -n;</td></tr>
<tr class="codeline" data-linenumber="8567"><td class="num" id="LN8567">8567</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="8568"><td class="num" id="LN8568">8568</td><td class="line">    <span class='keyword'>if</span> (n &lt; 1024) {</td></tr>
<tr class="codeline" data-linenumber="8569"><td class="num" id="LN8569">8569</td><td class="line">        <span class='comment'>/* Bytes */</span></td></tr>
<tr class="codeline" data-linenumber="8570"><td class="num" id="LN8570">8570</td><td class="line">        sprintf(s,<span class='string_literal'>"%lldB"</span>,n);</td></tr>
<tr class="codeline" data-linenumber="8571"><td class="num" id="LN8571">8571</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="8572"><td class="num" id="LN8572">8572</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (n &lt; (1024*1024)) {</td></tr>
<tr class="codeline" data-linenumber="8573"><td class="num" id="LN8573">8573</td><td class="line">        d = (<span class='keyword'>double</span>)n/(1024);</td></tr>
<tr class="codeline" data-linenumber="8574"><td class="num" id="LN8574">8574</td><td class="line">        sprintf(s,<span class='string_literal'>"%.2fK"</span>,d);</td></tr>
<tr class="codeline" data-linenumber="8575"><td class="num" id="LN8575">8575</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (n &lt; (1024LL*1024*1024)) {</td></tr>
<tr class="codeline" data-linenumber="8576"><td class="num" id="LN8576">8576</td><td class="line">        d = (<span class='keyword'>double</span>)n/(1024*1024);</td></tr>
<tr class="codeline" data-linenumber="8577"><td class="num" id="LN8577">8577</td><td class="line">        sprintf(s,<span class='string_literal'>"%.2fM"</span>,d);</td></tr>
<tr class="codeline" data-linenumber="8578"><td class="num" id="LN8578">8578</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (n &lt; (1024LL*1024*1024*1024)) {</td></tr>
<tr class="codeline" data-linenumber="8579"><td class="num" id="LN8579">8579</td><td class="line">        d = (<span class='keyword'>double</span>)n/(1024LL*1024*1024);</td></tr>
<tr class="codeline" data-linenumber="8580"><td class="num" id="LN8580">8580</td><td class="line">        sprintf(s,<span class='string_literal'>"%.2fG"</span>,d);</td></tr>
<tr class="codeline" data-linenumber="8581"><td class="num" id="LN8581">8581</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="8582"><td class="num" id="LN8582">8582</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="8583"><td class="num" id="LN8583">8583</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8584"><td class="num" id="LN8584">8584</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> statMode(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="8585"><td class="num" id="LN8585">8585</td><td class="line">    redisReply *reply;</td></tr>
<tr class="codeline" data-linenumber="8586"><td class="num" id="LN8586">8586</td><td class="line">    <span class='keyword'>long</span> aux, requests = 0;</td></tr>
<tr class="codeline" data-linenumber="8587"><td class="num" id="LN8587">8587</td><td class="line">    <span class='keyword'>int</span> i = 0;</td></tr>
<tr class="codeline" data-linenumber="8588"><td class="num" id="LN8588">8588</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8589"><td class="num" id="LN8589">8589</td><td class="line">    <span class='keyword'>while</span>(1) {</td></tr>
<tr class="codeline" data-linenumber="8590"><td class="num" id="LN8590">8590</td><td class="line">        <span class='keyword'>char</span> buf[64];</td></tr>
<tr class="codeline" data-linenumber="8591"><td class="num" id="LN8591">8591</td><td class="line">        <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="8592"><td class="num" id="LN8592">8592</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8593"><td class="num" id="LN8593">8593</td><td class="line">        reply = reconnectingRedisCommand(context,<span class='string_literal'>"INFO"</span>);</td></tr>
<tr class="codeline" data-linenumber="8594"><td class="num" id="LN8594">8594</td><td class="line">        <span class='keyword'>if</span> (reply == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="8595"><td class="num" id="LN8595">8595</td><td class="line">            fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"\nI/O error\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="8596"><td class="num" id="LN8596">8596</td><td class="line">            exit(1);</td></tr>
<tr class="codeline" data-linenumber="8597"><td class="num" id="LN8597">8597</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (reply-&gt;type == <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="8598"><td class="num" id="LN8598">8598</td><td class="line">            fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"ERROR: %s\n"</span>, reply-&gt;str);</td></tr>
<tr class="codeline" data-linenumber="8599"><td class="num" id="LN8599">8599</td><td class="line">            exit(1);</td></tr>
<tr class="codeline" data-linenumber="8600"><td class="num" id="LN8600">8600</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="8601"><td class="num" id="LN8601">8601</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8602"><td class="num" id="LN8602">8602</td><td class="line">        <span class='keyword'>if</span> ((i++ % 20) == 0) {</td></tr>
<tr class="codeline" data-linenumber="8603"><td class="num" id="LN8603">8603</td><td class="line">            printf(</td></tr>
<tr class="codeline" data-linenumber="8604"><td class="num" id="LN8604">8604</td><td class="line"><span class='string_literal'>"------- data ------ --------------------- load -------------------- - child -\n"</span></td></tr>
<tr class="codeline" data-linenumber="8605"><td class="num" id="LN8605">8605</td><td class="line"><span class='string_literal'>"keys       mem      clients blocked requests            connections          \n"</span>);</td></tr>
<tr class="codeline" data-linenumber="8606"><td class="num" id="LN8606">8606</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="8607"><td class="num" id="LN8607">8607</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8608"><td class="num" id="LN8608">8608</td><td class="line">        <span class='comment'>/* Keys */</span></td></tr>
<tr class="codeline" data-linenumber="8609"><td class="num" id="LN8609">8609</td><td class="line">        aux = 0;</td></tr>
<tr class="codeline" data-linenumber="8610"><td class="num" id="LN8610">8610</td><td class="line">        <span class='keyword'>for</span> (j = 0; j &lt; 20; j++) {</td></tr>
<tr class="codeline" data-linenumber="8611"><td class="num" id="LN8611">8611</td><td class="line">            <span class='keyword'>long</span> k;</td></tr>
<tr class="codeline" data-linenumber="8612"><td class="num" id="LN8612">8612</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8613"><td class="num" id="LN8613">8613</td><td class="line">            sprintf(buf,<span class='string_literal'>"db%d:keys"</span>,j);</td></tr>
<tr class="codeline" data-linenumber="8614"><td class="num" id="LN8614">8614</td><td class="line">            k = getLongInfoField(reply-&gt;str,buf);</td></tr>
<tr class="codeline" data-linenumber="8615"><td class="num" id="LN8615">8615</td><td class="line">            <span class='keyword'>if</span> (k == <span class='macro'>LONG_MIN<span class='macro_popup'>(-9223372036854775807L -1L)</span></span>) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="8616"><td class="num" id="LN8616">8616</td><td class="line">            aux += k;</td></tr>
<tr class="codeline" data-linenumber="8617"><td class="num" id="LN8617">8617</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="8618"><td class="num" id="LN8618">8618</td><td class="line">        sprintf(buf,<span class='string_literal'>"%ld"</span>,aux);</td></tr>
<tr class="codeline" data-linenumber="8619"><td class="num" id="LN8619">8619</td><td class="line">        printf(<span class='string_literal'>"%-11s"</span>,buf);</td></tr>
<tr class="codeline" data-linenumber="8620"><td class="num" id="LN8620">8620</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8621"><td class="num" id="LN8621">8621</td><td class="line">        <span class='comment'>/* Used memory */</span></td></tr>
<tr class="codeline" data-linenumber="8622"><td class="num" id="LN8622">8622</td><td class="line">        aux = getLongInfoField(reply-&gt;str,<span class='string_literal'>"used_memory"</span>);</td></tr>
<tr class="codeline" data-linenumber="8623"><td class="num" id="LN8623">8623</td><td class="line">        bytesToHuman(buf,aux);</td></tr>
<tr class="codeline" data-linenumber="8624"><td class="num" id="LN8624">8624</td><td class="line">        printf(<span class='string_literal'>"%-8s"</span>,buf);</td></tr>
<tr class="codeline" data-linenumber="8625"><td class="num" id="LN8625">8625</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8626"><td class="num" id="LN8626">8626</td><td class="line">        <span class='comment'>/* Clients */</span></td></tr>
<tr class="codeline" data-linenumber="8627"><td class="num" id="LN8627">8627</td><td class="line">        aux = getLongInfoField(reply-&gt;str,<span class='string_literal'>"connected_clients"</span>);</td></tr>
<tr class="codeline" data-linenumber="8628"><td class="num" id="LN8628">8628</td><td class="line">        sprintf(buf,<span class='string_literal'>"%ld"</span>,aux);</td></tr>
<tr class="codeline" data-linenumber="8629"><td class="num" id="LN8629">8629</td><td class="line">        printf(<span class='string_literal'>" %-8s"</span>,buf);</td></tr>
<tr class="codeline" data-linenumber="8630"><td class="num" id="LN8630">8630</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8631"><td class="num" id="LN8631">8631</td><td class="line">        <span class='comment'>/* Blocked (BLPOPPING) Clients */</span></td></tr>
<tr class="codeline" data-linenumber="8632"><td class="num" id="LN8632">8632</td><td class="line">        aux = getLongInfoField(reply-&gt;str,<span class='string_literal'>"blocked_clients"</span>);</td></tr>
<tr class="codeline" data-linenumber="8633"><td class="num" id="LN8633">8633</td><td class="line">        sprintf(buf,<span class='string_literal'>"%ld"</span>,aux);</td></tr>
<tr class="codeline" data-linenumber="8634"><td class="num" id="LN8634">8634</td><td class="line">        printf(<span class='string_literal'>"%-8s"</span>,buf);</td></tr>
<tr class="codeline" data-linenumber="8635"><td class="num" id="LN8635">8635</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8636"><td class="num" id="LN8636">8636</td><td class="line">        <span class='comment'>/* Requests */</span></td></tr>
<tr class="codeline" data-linenumber="8637"><td class="num" id="LN8637">8637</td><td class="line">        aux = getLongInfoField(reply-&gt;str,<span class='string_literal'>"total_commands_processed"</span>);</td></tr>
<tr class="codeline" data-linenumber="8638"><td class="num" id="LN8638">8638</td><td class="line">        sprintf(buf,<span class='string_literal'>"%ld (+%ld)"</span>,aux,requests == 0 ? 0 : aux-requests);</td></tr>
<tr class="codeline" data-linenumber="8639"><td class="num" id="LN8639">8639</td><td class="line">        printf(<span class='string_literal'>"%-19s"</span>,buf);</td></tr>
<tr class="codeline" data-linenumber="8640"><td class="num" id="LN8640">8640</td><td class="line">        requests = aux;</td></tr>
<tr class="codeline" data-linenumber="8641"><td class="num" id="LN8641">8641</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8642"><td class="num" id="LN8642">8642</td><td class="line">        <span class='comment'>/* Connections */</span></td></tr>
<tr class="codeline" data-linenumber="8643"><td class="num" id="LN8643">8643</td><td class="line">        aux = getLongInfoField(reply-&gt;str,<span class='string_literal'>"total_connections_received"</span>);</td></tr>
<tr class="codeline" data-linenumber="8644"><td class="num" id="LN8644">8644</td><td class="line">        sprintf(buf,<span class='string_literal'>"%ld"</span>,aux);</td></tr>
<tr class="codeline" data-linenumber="8645"><td class="num" id="LN8645">8645</td><td class="line">        printf(<span class='string_literal'>" %-12s"</span>,buf);</td></tr>
<tr class="codeline" data-linenumber="8646"><td class="num" id="LN8646">8646</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8647"><td class="num" id="LN8647">8647</td><td class="line">        <span class='comment'>/* Children */</span></td></tr>
<tr class="codeline" data-linenumber="8648"><td class="num" id="LN8648">8648</td><td class="line">        aux = getLongInfoField(reply-&gt;str,<span class='string_literal'>"bgsave_in_progress"</span>);</td></tr>
<tr class="codeline" data-linenumber="8649"><td class="num" id="LN8649">8649</td><td class="line">        aux |= getLongInfoField(reply-&gt;str,<span class='string_literal'>"aof_rewrite_in_progress"</span>) &lt;&lt; 1;</td></tr>
<tr class="codeline" data-linenumber="8650"><td class="num" id="LN8650">8650</td><td class="line">        aux |= getLongInfoField(reply-&gt;str,<span class='string_literal'>"loading"</span>) &lt;&lt; 2;</td></tr>
<tr class="codeline" data-linenumber="8651"><td class="num" id="LN8651">8651</td><td class="line">        <span class='keyword'>switch</span>(aux) {</td></tr>
<tr class="codeline" data-linenumber="8652"><td class="num" id="LN8652">8652</td><td class="line">        <span class='keyword'>case</span> 0: <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="8653"><td class="num" id="LN8653">8653</td><td class="line">        <span class='keyword'>case</span> 1:</td></tr>
<tr class="codeline" data-linenumber="8654"><td class="num" id="LN8654">8654</td><td class="line">            printf(<span class='string_literal'>"SAVE"</span>);</td></tr>
<tr class="codeline" data-linenumber="8655"><td class="num" id="LN8655">8655</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="8656"><td class="num" id="LN8656">8656</td><td class="line">        <span class='keyword'>case</span> 2:</td></tr>
<tr class="codeline" data-linenumber="8657"><td class="num" id="LN8657">8657</td><td class="line">            printf(<span class='string_literal'>"AOF"</span>);</td></tr>
<tr class="codeline" data-linenumber="8658"><td class="num" id="LN8658">8658</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="8659"><td class="num" id="LN8659">8659</td><td class="line">        <span class='keyword'>case</span> 3:</td></tr>
<tr class="codeline" data-linenumber="8660"><td class="num" id="LN8660">8660</td><td class="line">            printf(<span class='string_literal'>"SAVE+AOF"</span>);</td></tr>
<tr class="codeline" data-linenumber="8661"><td class="num" id="LN8661">8661</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="8662"><td class="num" id="LN8662">8662</td><td class="line">        <span class='keyword'>case</span> 4:</td></tr>
<tr class="codeline" data-linenumber="8663"><td class="num" id="LN8663">8663</td><td class="line">            printf(<span class='string_literal'>"LOAD"</span>);</td></tr>
<tr class="codeline" data-linenumber="8664"><td class="num" id="LN8664">8664</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="8665"><td class="num" id="LN8665">8665</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="8666"><td class="num" id="LN8666">8666</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8667"><td class="num" id="LN8667">8667</td><td class="line">        printf(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="8668"><td class="num" id="LN8668">8668</td><td class="line">        freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="8669"><td class="num" id="LN8669">8669</td><td class="line">        usleep(config.interval);</td></tr>
<tr class="codeline" data-linenumber="8670"><td class="num" id="LN8670">8670</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="8671"><td class="num" id="LN8671">8671</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="8672"><td class="num" id="LN8672">8672</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8673"><td class="num" id="LN8673">8673</td><td class="line"><span class='comment'>/*------------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="8674"><td class="num" id="LN8674">8674</td><td class="line"> <span class='comment'>* Scan mode</span></td></tr>
<tr class="codeline" data-linenumber="8675"><td class="num" id="LN8675">8675</td><td class="line"> <span class='comment'>*--------------------------------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="8676"><td class="num" id="LN8676">8676</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8677"><td class="num" id="LN8677">8677</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> scanMode(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="8678"><td class="num" id="LN8678">8678</td><td class="line">    redisReply *reply;</td></tr>
<tr class="codeline" data-linenumber="8679"><td class="num" id="LN8679">8679</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> cur = 0;</td></tr>
<tr class="codeline" data-linenumber="8680"><td class="num" id="LN8680">8680</td><td class="line">    signal(<span class='macro'>SIGINT<span class='macro_popup'>2</span></span>, longStatLoopModeStop);</td></tr>
<tr class="codeline" data-linenumber="8681"><td class="num" id="LN8681">8681</td><td class="line">    <span class='keyword'>do</span> {</td></tr>
<tr class="codeline" data-linenumber="8682"><td class="num" id="LN8682">8682</td><td class="line">        reply = sendScan(&amp;cur);</td></tr>
<tr class="codeline" data-linenumber="8683"><td class="num" id="LN8683">8683</td><td class="line">        <span class='keyword'>for</span> (<span class='keyword'>unsigned</span> <span class='keyword'>int</span> j = 0; j &lt; reply-&gt;element[1]-&gt;elements; j++) {</td></tr>
<tr class="codeline" data-linenumber="8684"><td class="num" id="LN8684">8684</td><td class="line">            <span class='keyword'>if</span> (config.output == <span class='macro'>OUTPUT_STANDARD<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="8685"><td class="num" id="LN8685">8685</td><td class="line">                <span class='macro'>sds<span class='macro_popup'>hisds</span></span> out = <span class='macro'>sdscatrepr<span class='macro_popup'>hi_sdscatrepr</span></span>(<span class='macro'>sdsempty<span class='macro_popup'>hi_sdsempty</span></span>(), reply-&gt;element[1]-&gt;element[j]-&gt;str,</td></tr>
<tr class="codeline" data-linenumber="8686"><td class="num" id="LN8686">8686</td><td class="line">                                     reply-&gt;element[1]-&gt;element[j]-&gt;len);</td></tr>
<tr class="codeline" data-linenumber="8687"><td class="num" id="LN8687">8687</td><td class="line">                printf(<span class='string_literal'>"%s\n"</span>, out);</td></tr>
<tr class="codeline" data-linenumber="8688"><td class="num" id="LN8688">8688</td><td class="line">                <span class='macro'>sdsfree<span class='macro_popup'>hi_sdsfree</span></span>(out);</td></tr>
<tr class="codeline" data-linenumber="8689"><td class="num" id="LN8689">8689</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="8690"><td class="num" id="LN8690">8690</td><td class="line">                printf(<span class='string_literal'>"%s\n"</span>, reply-&gt;element[1]-&gt;element[j]-&gt;str);</td></tr>
<tr class="codeline" data-linenumber="8691"><td class="num" id="LN8691">8691</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="8692"><td class="num" id="LN8692">8692</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="8693"><td class="num" id="LN8693">8693</td><td class="line">        freeReplyObject(reply);</td></tr>
<tr class="codeline" data-linenumber="8694"><td class="num" id="LN8694">8694</td><td class="line">        <span class='keyword'>if</span> (config.interval) usleep(config.interval);</td></tr>
<tr class="codeline" data-linenumber="8695"><td class="num" id="LN8695">8695</td><td class="line">    } <span class='keyword'>while</span>(force_cancel_loop == 0 &amp;&amp; cur != 0);</td></tr>
<tr class="codeline" data-linenumber="8696"><td class="num" id="LN8696">8696</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8697"><td class="num" id="LN8697">8697</td><td class="line">    exit(0);</td></tr>
<tr class="codeline" data-linenumber="8698"><td class="num" id="LN8698">8698</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="8699"><td class="num" id="LN8699">8699</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8700"><td class="num" id="LN8700">8700</td><td class="line"><span class='comment'>/*------------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="8701"><td class="num" id="LN8701">8701</td><td class="line"> <span class='comment'>* LRU test mode</span></td></tr>
<tr class="codeline" data-linenumber="8702"><td class="num" id="LN8702">8702</td><td class="line"> <span class='comment'>*--------------------------------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="8703"><td class="num" id="LN8703">8703</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8704"><td class="num" id="LN8704">8704</td><td class="line"><span class='comment'>/* Return an integer from min to max (both inclusive) using a power-law</span></td></tr>
<tr class="codeline" data-linenumber="8705"><td class="num" id="LN8705">8705</td><td class="line"> <span class='comment'>* distribution, depending on the value of alpha: the greater the alpha</span></td></tr>
<tr class="codeline" data-linenumber="8706"><td class="num" id="LN8706">8706</td><td class="line"> <span class='comment'>* the more bias towards lower values.</span></td></tr>
<tr class="codeline" data-linenumber="8707"><td class="num" id="LN8707">8707</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="8708"><td class="num" id="LN8708">8708</td><td class="line"> <span class='comment'>* With alpha = 6.2 the output follows the 80-20 rule where 20% of</span></td></tr>
<tr class="codeline" data-linenumber="8709"><td class="num" id="LN8709">8709</td><td class="line"> <span class='comment'>* the returned numbers will account for 80% of the frequency. */</span></td></tr>
<tr class="codeline" data-linenumber="8710"><td class="num" id="LN8710">8710</td><td class="line"><span class='keyword'>long</span> <span class='keyword'>long</span> powerLawRand(<span class='keyword'>long</span> <span class='keyword'>long</span> min, <span class='keyword'>long</span> <span class='keyword'>long</span> max, <span class='keyword'>double</span> alpha) {</td></tr>
<tr class="codeline" data-linenumber="8711"><td class="num" id="LN8711">8711</td><td class="line">    <span class='keyword'>double</span> pl, r;</td></tr>
<tr class="codeline" data-linenumber="8712"><td class="num" id="LN8712">8712</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8713"><td class="num" id="LN8713">8713</td><td class="line">    max += 1;</td></tr>
<tr class="codeline" data-linenumber="8714"><td class="num" id="LN8714">8714</td><td class="line">    r = ((<span class='keyword'>double</span>)rand()) / <span class='macro'>RAND_MAX<span class='macro_popup'>2147483647</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8715"><td class="num" id="LN8715">8715</td><td class="line">    pl = pow(</td></tr>
<tr class="codeline" data-linenumber="8716"><td class="num" id="LN8716">8716</td><td class="line">        ((pow(max,alpha+1) - pow(min,alpha+1))*r + pow(min,alpha+1)),</td></tr>
<tr class="codeline" data-linenumber="8717"><td class="num" id="LN8717">8717</td><td class="line">        (1.0/(alpha+1)));</td></tr>
<tr class="codeline" data-linenumber="8718"><td class="num" id="LN8718">8718</td><td class="line">    <span class='keyword'>return</span> (max-1-(<span class='keyword'>long</span> <span class='keyword'>long</span>)pl)+min;</td></tr>
<tr class="codeline" data-linenumber="8719"><td class="num" id="LN8719">8719</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="8720"><td class="num" id="LN8720">8720</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8721"><td class="num" id="LN8721">8721</td><td class="line"><span class='comment'>/* Generates a key name among a set of lru_test_sample_size keys, using</span></td></tr>
<tr class="codeline" data-linenumber="8722"><td class="num" id="LN8722">8722</td><td class="line"> <span class='comment'>* an 80-20 distribution. */</span></td></tr>
<tr class="codeline" data-linenumber="8723"><td class="num" id="LN8723">8723</td><td class="line"><span class='keyword'>void</span> LRUTestGenKey(<span class='keyword'>char</span> *buf, size_t buflen) {</td></tr>
<tr class="codeline" data-linenumber="8724"><td class="num" id="LN8724">8724</td><td class="line">    snprintf(buf, buflen, <span class='string_literal'>"lru:%lld"</span>,</td></tr>
<tr class="codeline" data-linenumber="8725"><td class="num" id="LN8725">8725</td><td class="line">        powerLawRand(1, config.lru_test_sample_size, 6.2));</td></tr>
<tr class="codeline" data-linenumber="8726"><td class="num" id="LN8726">8726</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="8727"><td class="num" id="LN8727">8727</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8728"><td class="num" id="LN8728">8728</td><td class="line"><span class='directive'>#define <span class='macro'>LRU_CYCLE_PERIOD<span class='macro_popup'>1000</span></span> 1000 /* 1000 milliseconds. */</span></td></tr>
<tr class="codeline" data-linenumber="8729"><td class="num" id="LN8729">8729</td><td class="line"><span class='directive'>#define <span class='macro'>LRU_CYCLE_PIPELINE_SIZE<span class='macro_popup'>250</span></span> 250</span></td></tr>
<tr class="codeline" data-linenumber="8730"><td class="num" id="LN8730">8730</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LRUTestMode(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="8731"><td class="num" id="LN8731">8731</td><td class="line">    redisReply *reply;</td></tr>
<tr class="codeline" data-linenumber="8732"><td class="num" id="LN8732">8732</td><td class="line">    <span class='keyword'>char</span> key[128];</td></tr>
<tr class="codeline" data-linenumber="8733"><td class="num" id="LN8733">8733</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> start_cycle;</td></tr>
<tr class="codeline" data-linenumber="8734"><td class="num" id="LN8734">8734</td><td class="line">    <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="8735"><td class="num" id="LN8735">8735</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8736"><td class="num" id="LN8736">8736</td><td class="line">    srand(time(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)^getpid());</td></tr>
<tr class="codeline" data-linenumber="8737"><td class="num" id="LN8737">8737</td><td class="line">    <span class='keyword'>while</span>(1) {</td></tr>
<tr class="codeline" data-linenumber="8738"><td class="num" id="LN8738">8738</td><td class="line">        <span class='comment'>/* Perform cycles of 1 second with 50% writes and 50% reads.</span></td></tr>
<tr class="codeline" data-linenumber="8739"><td class="num" id="LN8739">8739</td><td class="line">         <span class='comment'>* We use pipelining batching writes / reads N times per cycle in order</span></td></tr>
<tr class="codeline" data-linenumber="8740"><td class="num" id="LN8740">8740</td><td class="line">         <span class='comment'>* to fill the target instance easily. */</span></td></tr>
<tr class="codeline" data-linenumber="8741"><td class="num" id="LN8741">8741</td><td class="line">        start_cycle = mstime();</td></tr>
<tr class="codeline" data-linenumber="8742"><td class="num" id="LN8742">8742</td><td class="line">        <span class='keyword'>long</span> <span class='keyword'>long</span> hits = 0, misses = 0;</td></tr>
<tr class="codeline" data-linenumber="8743"><td class="num" id="LN8743">8743</td><td class="line">        <span class='keyword'>while</span>(mstime() - start_cycle &lt; <span class='macro'>LRU_CYCLE_PERIOD<span class='macro_popup'>1000</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="8744"><td class="num" id="LN8744">8744</td><td class="line">            <span class='comment'>/* Write cycle. */</span></td></tr>
<tr class="codeline" data-linenumber="8745"><td class="num" id="LN8745">8745</td><td class="line">            <span class='keyword'>for</span> (j = 0; j &lt; <span class='macro'>LRU_CYCLE_PIPELINE_SIZE<span class='macro_popup'>250</span></span>; j++) {</td></tr>
<tr class="codeline" data-linenumber="8746"><td class="num" id="LN8746">8746</td><td class="line">                <span class='keyword'>char</span> val[6];</td></tr>
<tr class="codeline" data-linenumber="8747"><td class="num" id="LN8747">8747</td><td class="line">                val[5] = '\0';</td></tr>
<tr class="codeline" data-linenumber="8748"><td class="num" id="LN8748">8748</td><td class="line">                <span class='keyword'>for</span> (<span class='keyword'>int</span> i = 0; i &lt; 5; i++) val[i] = 'A'+rand()%('z'-'A');</td></tr>
<tr class="codeline" data-linenumber="8749"><td class="num" id="LN8749">8749</td><td class="line">                LRUTestGenKey(key,<span class='keyword'>sizeof</span>(key));</td></tr>
<tr class="codeline" data-linenumber="8750"><td class="num" id="LN8750">8750</td><td class="line">                redisAppendCommand(context, <span class='string_literal'>"SET %s %s"</span>,key,val);</td></tr>
<tr class="codeline" data-linenumber="8751"><td class="num" id="LN8751">8751</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="8752"><td class="num" id="LN8752">8752</td><td class="line">            <span class='keyword'>for</span> (j = 0; j &lt; <span class='macro'>LRU_CYCLE_PIPELINE_SIZE<span class='macro_popup'>250</span></span>; j++)</td></tr>
<tr class="codeline" data-linenumber="8753"><td class="num" id="LN8753">8753</td><td class="line">                redisGetReply(context, (<span class='keyword'>void</span>**)&amp;reply);</td></tr>
<tr class="codeline" data-linenumber="8754"><td class="num" id="LN8754">8754</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8755"><td class="num" id="LN8755">8755</td><td class="line">            <span class='comment'>/* Read cycle. */</span></td></tr>
<tr class="codeline" data-linenumber="8756"><td class="num" id="LN8756">8756</td><td class="line">            <span class='keyword'>for</span> (j = 0; j &lt; <span class='macro'>LRU_CYCLE_PIPELINE_SIZE<span class='macro_popup'>250</span></span>; j++) {</td></tr>
<tr class="codeline" data-linenumber="8757"><td class="num" id="LN8757">8757</td><td class="line">                LRUTestGenKey(key,<span class='keyword'>sizeof</span>(key));</td></tr>
<tr class="codeline" data-linenumber="8758"><td class="num" id="LN8758">8758</td><td class="line">                redisAppendCommand(context, <span class='string_literal'>"GET %s"</span>,key);</td></tr>
<tr class="codeline" data-linenumber="8759"><td class="num" id="LN8759">8759</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="8760"><td class="num" id="LN8760">8760</td><td class="line">            <span class='keyword'>for</span> (j = 0; j &lt; <span class='macro'>LRU_CYCLE_PIPELINE_SIZE<span class='macro_popup'>250</span></span>; j++) {</td></tr>
<tr class="codeline" data-linenumber="8761"><td class="num" id="LN8761">8761</td><td class="line">                <span class='keyword'>if</span> (redisGetReply(context, (<span class='keyword'>void</span>**)&amp;reply) == <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="8762"><td class="num" id="LN8762">8762</td><td class="line">                    <span class='keyword'>switch</span>(reply-&gt;type) {</td></tr>
<tr class="codeline" data-linenumber="8763"><td class="num" id="LN8763">8763</td><td class="line">                        <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_ERROR<span class='macro_popup'>6</span></span>:</td></tr>
<tr class="codeline" data-linenumber="8764"><td class="num" id="LN8764">8764</td><td class="line">                            fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"%s\n"</span>, reply-&gt;str);</td></tr>
<tr class="codeline" data-linenumber="8765"><td class="num" id="LN8765">8765</td><td class="line">                            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="8766"><td class="num" id="LN8766">8766</td><td class="line">                        <span class='keyword'>case</span> <span class='macro'>REDIS_REPLY_NIL<span class='macro_popup'>4</span></span>:</td></tr>
<tr class="codeline" data-linenumber="8767"><td class="num" id="LN8767">8767</td><td class="line">                            misses++;</td></tr>
<tr class="codeline" data-linenumber="8768"><td class="num" id="LN8768">8768</td><td class="line">                            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="8769"><td class="num" id="LN8769">8769</td><td class="line">                        <span class='keyword'>default</span>:</td></tr>
<tr class="codeline" data-linenumber="8770"><td class="num" id="LN8770">8770</td><td class="line">                            hits++;</td></tr>
<tr class="codeline" data-linenumber="8771"><td class="num" id="LN8771">8771</td><td class="line">                            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="8772"><td class="num" id="LN8772">8772</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="8773"><td class="num" id="LN8773">8773</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="8774"><td class="num" id="LN8774">8774</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="8775"><td class="num" id="LN8775">8775</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8776"><td class="num" id="LN8776">8776</td><td class="line">            <span class='keyword'>if</span> (context-&gt;err) {</td></tr>
<tr class="codeline" data-linenumber="8777"><td class="num" id="LN8777">8777</td><td class="line">                fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"I/O error during LRU test\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="8778"><td class="num" id="LN8778">8778</td><td class="line">                exit(1);</td></tr>
<tr class="codeline" data-linenumber="8779"><td class="num" id="LN8779">8779</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="8780"><td class="num" id="LN8780">8780</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="8781"><td class="num" id="LN8781">8781</td><td class="line">        <span class='comment'>/* Print stats. */</span></td></tr>
<tr class="codeline" data-linenumber="8782"><td class="num" id="LN8782">8782</td><td class="line">        printf(</td></tr>
<tr class="codeline" data-linenumber="8783"><td class="num" id="LN8783">8783</td><td class="line">            <span class='string_literal'>"%lld Gets/sec | Hits: %lld (%.2f%%) | Misses: %lld (%.2f%%)\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="8784"><td class="num" id="LN8784">8784</td><td class="line">            hits+misses,</td></tr>
<tr class="codeline" data-linenumber="8785"><td class="num" id="LN8785">8785</td><td class="line">            hits, (<span class='keyword'>double</span>)hits/(hits+misses)*100,</td></tr>
<tr class="codeline" data-linenumber="8786"><td class="num" id="LN8786">8786</td><td class="line">            misses, (<span class='keyword'>double</span>)misses/(hits+misses)*100);</td></tr>
<tr class="codeline" data-linenumber="8787"><td class="num" id="LN8787">8787</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="8788"><td class="num" id="LN8788">8788</td><td class="line">    exit(0);</td></tr>
<tr class="codeline" data-linenumber="8789"><td class="num" id="LN8789">8789</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="8790"><td class="num" id="LN8790">8790</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8791"><td class="num" id="LN8791">8791</td><td class="line"><span class='comment'>/*------------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="8792"><td class="num" id="LN8792">8792</td><td class="line"> <span class='comment'>* Intrinsic latency mode.</span></td></tr>
<tr class="codeline" data-linenumber="8793"><td class="num" id="LN8793">8793</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="8794"><td class="num" id="LN8794">8794</td><td class="line"> <span class='comment'>* Measure max latency of a running process that does not result from</span></td></tr>
<tr class="codeline" data-linenumber="8795"><td class="num" id="LN8795">8795</td><td class="line"> <span class='comment'>* syscalls. Basically this software should provide a hint about how much</span></td></tr>
<tr class="codeline" data-linenumber="8796"><td class="num" id="LN8796">8796</td><td class="line"> <span class='comment'>* time the kernel leaves the process without a chance to run.</span></td></tr>
<tr class="codeline" data-linenumber="8797"><td class="num" id="LN8797">8797</td><td class="line"> <span class='comment'>*--------------------------------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="8798"><td class="num" id="LN8798">8798</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8799"><td class="num" id="LN8799">8799</td><td class="line"><span class='comment'>/* This is just some computation the compiler can't optimize out.</span></td></tr>
<tr class="codeline" data-linenumber="8800"><td class="num" id="LN8800">8800</td><td class="line"> <span class='comment'>* Should run in less than 100-200 microseconds even using very</span></td></tr>
<tr class="codeline" data-linenumber="8801"><td class="num" id="LN8801">8801</td><td class="line"> <span class='comment'>* slow hardware. Runs in less than 10 microseconds in modern HW. */</span></td></tr>
<tr class="codeline" data-linenumber="8802"><td class="num" id="LN8802">8802</td><td class="line"><span class='keyword'>unsigned</span> <span class='keyword'>long</span> compute_something_fast(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="8803"><td class="num" id="LN8803">8803</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> s[256], i, j, t;</td></tr>
<tr class="codeline" data-linenumber="8804"><td class="num" id="LN8804">8804</td><td class="line">    <span class='keyword'>int</span> count = 1000, k;</td></tr>
<tr class="codeline" data-linenumber="8805"><td class="num" id="LN8805">8805</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>long</span> output = 0;</td></tr>
<tr class="codeline" data-linenumber="8806"><td class="num" id="LN8806">8806</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8807"><td class="num" id="LN8807">8807</td><td class="line">    <span class='keyword'>for</span> (k = 0; k &lt; 256; k++) s[k] = k;</td></tr>
<tr class="codeline" data-linenumber="8808"><td class="num" id="LN8808">8808</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8809"><td class="num" id="LN8809">8809</td><td class="line">    i = 0;</td></tr>
<tr class="codeline" data-linenumber="8810"><td class="num" id="LN8810">8810</td><td class="line">    j = 0;</td></tr>
<tr class="codeline" data-linenumber="8811"><td class="num" id="LN8811">8811</td><td class="line">    <span class='keyword'>while</span>(count--) {</td></tr>
<tr class="codeline" data-linenumber="8812"><td class="num" id="LN8812">8812</td><td class="line">        i++;</td></tr>
<tr class="codeline" data-linenumber="8813"><td class="num" id="LN8813">8813</td><td class="line">        j = j + s[i];</td></tr>
<tr class="codeline" data-linenumber="8814"><td class="num" id="LN8814">8814</td><td class="line">        t = s[i];</td></tr>
<tr class="codeline" data-linenumber="8815"><td class="num" id="LN8815">8815</td><td class="line">        s[i] = s[j];</td></tr>
<tr class="codeline" data-linenumber="8816"><td class="num" id="LN8816">8816</td><td class="line">        s[j] = t;</td></tr>
<tr class="codeline" data-linenumber="8817"><td class="num" id="LN8817">8817</td><td class="line">        output += s[(s[i]+s[j])&amp;255];</td></tr>
<tr class="codeline" data-linenumber="8818"><td class="num" id="LN8818">8818</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="8819"><td class="num" id="LN8819">8819</td><td class="line">    <span class='keyword'>return</span> output;</td></tr>
<tr class="codeline" data-linenumber="8820"><td class="num" id="LN8820">8820</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="8821"><td class="num" id="LN8821">8821</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8822"><td class="num" id="LN8822">8822</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> sigIntHandler(<span class='keyword'>int</span> s) {</td></tr>
<tr class="codeline" data-linenumber="8823"><td class="num" id="LN8823">8823</td><td class="line">    <span class='macro'>UNUSED(s)<span class='macro_popup'>((void) s)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8824"><td class="num" id="LN8824">8824</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8825"><td class="num" id="LN8825">8825</td><td class="line">    <span class='keyword'>if</span> (config.monitor_mode || config.pubsub_mode) {</td></tr>
<tr class="codeline" data-linenumber="8826"><td class="num" id="LN8826">8826</td><td class="line">        close(context-&gt;fd);</td></tr>
<tr class="codeline" data-linenumber="8827"><td class="num" id="LN8827">8827</td><td class="line">        context-&gt;fd = <span class='macro'>REDIS_INVALID_FD<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8828"><td class="num" id="LN8828">8828</td><td class="line">        config.blocking_state_aborted = 1;</td></tr>
<tr class="codeline" data-linenumber="8829"><td class="num" id="LN8829">8829</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="8830"><td class="num" id="LN8830">8830</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="8831"><td class="num" id="LN8831">8831</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="8832"><td class="num" id="LN8832">8832</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="8833"><td class="num" id="LN8833">8833</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8834"><td class="num" id="LN8834">8834</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> intrinsicLatencyMode(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="8835"><td class="num" id="LN8835">8835</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> test_end, run_time, max_latency = 0, runs = 0;</td></tr>
<tr class="codeline" data-linenumber="8836"><td class="num" id="LN8836">8836</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8837"><td class="num" id="LN8837">8837</td><td class="line">    run_time = (<span class='keyword'>long</span> <span class='keyword'>long</span>)config.intrinsic_latency_duration * 1000000;</td></tr>
<tr class="codeline" data-linenumber="8838"><td class="num" id="LN8838">8838</td><td class="line">    test_end = ustime() + run_time;</td></tr>
<tr class="codeline" data-linenumber="8839"><td class="num" id="LN8839">8839</td><td class="line">    signal(<span class='macro'>SIGINT<span class='macro_popup'>2</span></span>, longStatLoopModeStop);</td></tr>
<tr class="codeline" data-linenumber="8840"><td class="num" id="LN8840">8840</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8841"><td class="num" id="LN8841">8841</td><td class="line">    <span class='keyword'>while</span>(1) {</td></tr>
<tr class="codeline" data-linenumber="8842"><td class="num" id="LN8842">8842</td><td class="line">        <span class='keyword'>long</span> <span class='keyword'>long</span> start, end, latency;</td></tr>
<tr class="codeline" data-linenumber="8843"><td class="num" id="LN8843">8843</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8844"><td class="num" id="LN8844">8844</td><td class="line">        start = ustime();</td></tr>
<tr class="codeline" data-linenumber="8845"><td class="num" id="LN8845">8845</td><td class="line">        compute_something_fast();</td></tr>
<tr class="codeline" data-linenumber="8846"><td class="num" id="LN8846">8846</td><td class="line">        end = ustime();</td></tr>
<tr class="codeline" data-linenumber="8847"><td class="num" id="LN8847">8847</td><td class="line">        latency = end-start;</td></tr>
<tr class="codeline" data-linenumber="8848"><td class="num" id="LN8848">8848</td><td class="line">        runs++;</td></tr>
<tr class="codeline" data-linenumber="8849"><td class="num" id="LN8849">8849</td><td class="line">        <span class='keyword'>if</span> (latency &lt;= 0) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="8850"><td class="num" id="LN8850">8850</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8851"><td class="num" id="LN8851">8851</td><td class="line">        <span class='comment'>/* Reporting */</span></td></tr>
<tr class="codeline" data-linenumber="8852"><td class="num" id="LN8852">8852</td><td class="line">        <span class='keyword'>if</span> (latency &gt; max_latency) {</td></tr>
<tr class="codeline" data-linenumber="8853"><td class="num" id="LN8853">8853</td><td class="line">            max_latency = latency;</td></tr>
<tr class="codeline" data-linenumber="8854"><td class="num" id="LN8854">8854</td><td class="line">            printf(<span class='string_literal'>"Max latency so far: %lld microseconds.\n"</span>, max_latency);</td></tr>
<tr class="codeline" data-linenumber="8855"><td class="num" id="LN8855">8855</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="8856"><td class="num" id="LN8856">8856</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8857"><td class="num" id="LN8857">8857</td><td class="line">        <span class='keyword'>double</span> avg_us = (<span class='keyword'>double</span>)run_time/runs;</td></tr>
<tr class="codeline" data-linenumber="8858"><td class="num" id="LN8858">8858</td><td class="line">        <span class='keyword'>double</span> avg_ns = avg_us * 1e3;</td></tr>
<tr class="codeline" data-linenumber="8859"><td class="num" id="LN8859">8859</td><td class="line">        <span class='keyword'>if</span> (force_cancel_loop || end &gt; test_end) {</td></tr>
<tr class="codeline" data-linenumber="8860"><td class="num" id="LN8860">8860</td><td class="line">            printf(<span class='string_literal'>"\n%lld total runs "</span></td></tr>
<tr class="codeline" data-linenumber="8861"><td class="num" id="LN8861">8861</td><td class="line">                <span class='string_literal'>"(avg latency: "</span></td></tr>
<tr class="codeline" data-linenumber="8862"><td class="num" id="LN8862">8862</td><td class="line">                <span class='string_literal'>"%.4f microseconds / %.2f nanoseconds per run).\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="8863"><td class="num" id="LN8863">8863</td><td class="line">                runs, avg_us, avg_ns);</td></tr>
<tr class="codeline" data-linenumber="8864"><td class="num" id="LN8864">8864</td><td class="line">            printf(<span class='string_literal'>"Worst run took %.0fx longer than the average latency.\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="8865"><td class="num" id="LN8865">8865</td><td class="line">                max_latency / avg_us);</td></tr>
<tr class="codeline" data-linenumber="8866"><td class="num" id="LN8866">8866</td><td class="line">            exit(0);</td></tr>
<tr class="codeline" data-linenumber="8867"><td class="num" id="LN8867">8867</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="8868"><td class="num" id="LN8868">8868</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="8869"><td class="num" id="LN8869">8869</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="8870"><td class="num" id="LN8870">8870</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8871"><td class="num" id="LN8871">8871</td><td class="line"><span class='keyword'>static</span> <span class='macro'>sds<span class='macro_popup'>hisds</span></span> askPassword(<span class='keyword'>const</span> <span class='keyword'>char</span> *msg) {</td></tr>
<tr class="codeline" data-linenumber="8872"><td class="num" id="LN8872">8872</td><td class="line">    linenoiseMaskModeEnable();</td></tr>
<tr class="codeline" data-linenumber="8873"><td class="num" id="LN8873">8873</td><td class="line">    <span class='macro'>sds<span class='macro_popup'>hisds</span></span> auth = linenoise(msg);</td></tr>
<tr class="codeline" data-linenumber="8874"><td class="num" id="LN8874">8874</td><td class="line">    linenoiseMaskModeDisable();</td></tr>
<tr class="codeline" data-linenumber="8875"><td class="num" id="LN8875">8875</td><td class="line">    <span class='keyword'>return</span> auth;</td></tr>
<tr class="codeline" data-linenumber="8876"><td class="num" id="LN8876">8876</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="8877"><td class="num" id="LN8877">8877</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8878"><td class="num" id="LN8878">8878</td><td class="line"><span class='comment'>/*------------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="8879"><td class="num" id="LN8879">8879</td><td class="line"> <span class='comment'>* Program main()</span></td></tr>
<tr class="codeline" data-linenumber="8880"><td class="num" id="LN8880">8880</td><td class="line"> <span class='comment'>*--------------------------------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="8881"><td class="num" id="LN8881">8881</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8882"><td class="num" id="LN8882">8882</td><td class="line"><span class='keyword'>int</span> main(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv) {</td></tr>
<tr class="codeline" data-linenumber="8883"><td class="num" id="LN8883">8883</td><td class="line">    <span class='keyword'>int</span> firstarg;</td></tr>
<tr class="codeline" data-linenumber="8884"><td class="num" id="LN8884">8884</td><td class="line">    <span class='keyword'>struct</span> timeval tv;</td></tr>
<tr class="codeline" data-linenumber="8885"><td class="num" id="LN8885">8885</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8886"><td class="num" id="LN8886">8886</td><td class="line">    memset(&amp;config.sslconfig, 0, <span class='keyword'>sizeof</span>(config.sslconfig));</td></tr>
<tr class="codeline" data-linenumber="8887"><td class="num" id="LN8887">8887</td><td class="line">    config.conn_info.hostip = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(<span class='string_literal'>"127.0.0.1"</span>);</td></tr>
<tr class="codeline" data-linenumber="8888"><td class="num" id="LN8888">8888</td><td class="line">    config.conn_info.hostport = 6379;</td></tr>
<tr class="codeline" data-linenumber="8889"><td class="num" id="LN8889">8889</td><td class="line">    config.hostsocket = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8890"><td class="num" id="LN8890">8890</td><td class="line">    config.repeat = 1;</td></tr>
<tr class="codeline" data-linenumber="8891"><td class="num" id="LN8891">8891</td><td class="line">    config.interval = 0;</td></tr>
<tr class="codeline" data-linenumber="8892"><td class="num" id="LN8892">8892</td><td class="line">    config.dbnum = 0;</td></tr>
<tr class="codeline" data-linenumber="8893"><td class="num" id="LN8893">8893</td><td class="line">    config.conn_info.input_dbnum = 0;</td></tr>
<tr class="codeline" data-linenumber="8894"><td class="num" id="LN8894">8894</td><td class="line">    config.interactive = 0;</td></tr>
<tr class="codeline" data-linenumber="8895"><td class="num" id="LN8895">8895</td><td class="line">    config.shutdown = 0;</td></tr>
<tr class="codeline" data-linenumber="8896"><td class="num" id="LN8896">8896</td><td class="line">    config.monitor_mode = 0;</td></tr>
<tr class="codeline" data-linenumber="8897"><td class="num" id="LN8897">8897</td><td class="line">    config.pubsub_mode = 0;</td></tr>
<tr class="codeline" data-linenumber="8898"><td class="num" id="LN8898">8898</td><td class="line">    config.blocking_state_aborted = 0;</td></tr>
<tr class="codeline" data-linenumber="8899"><td class="num" id="LN8899">8899</td><td class="line">    config.latency_mode = 0;</td></tr>
<tr class="codeline" data-linenumber="8900"><td class="num" id="LN8900">8900</td><td class="line">    config.latency_dist_mode = 0;</td></tr>
<tr class="codeline" data-linenumber="8901"><td class="num" id="LN8901">8901</td><td class="line">    config.latency_history = 0;</td></tr>
<tr class="codeline" data-linenumber="8902"><td class="num" id="LN8902">8902</td><td class="line">    config.lru_test_mode = 0;</td></tr>
<tr class="codeline" data-linenumber="8903"><td class="num" id="LN8903">8903</td><td class="line">    config.lru_test_sample_size = 0;</td></tr>
<tr class="codeline" data-linenumber="8904"><td class="num" id="LN8904">8904</td><td class="line">    config.cluster_mode = 0;</td></tr>
<tr class="codeline" data-linenumber="8905"><td class="num" id="LN8905">8905</td><td class="line">    config.cluster_send_asking = 0;</td></tr>
<tr class="codeline" data-linenumber="8906"><td class="num" id="LN8906">8906</td><td class="line">    config.slave_mode = 0;</td></tr>
<tr class="codeline" data-linenumber="8907"><td class="num" id="LN8907">8907</td><td class="line">    config.getrdb_mode = 0;</td></tr>
<tr class="codeline" data-linenumber="8908"><td class="num" id="LN8908">8908</td><td class="line">    config.get_functions_rdb_mode = 0;</td></tr>
<tr class="codeline" data-linenumber="8909"><td class="num" id="LN8909">8909</td><td class="line">    config.stat_mode = 0;</td></tr>
<tr class="codeline" data-linenumber="8910"><td class="num" id="LN8910">8910</td><td class="line">    config.scan_mode = 0;</td></tr>
<tr class="codeline" data-linenumber="8911"><td class="num" id="LN8911">8911</td><td class="line">    config.intrinsic_latency_mode = 0;</td></tr>
<tr class="codeline" data-linenumber="8912"><td class="num" id="LN8912">8912</td><td class="line">    config.pattern = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8913"><td class="num" id="LN8913">8913</td><td class="line">    config.rdb_filename = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8914"><td class="num" id="LN8914">8914</td><td class="line">    config.pipe_mode = 0;</td></tr>
<tr class="codeline" data-linenumber="8915"><td class="num" id="LN8915">8915</td><td class="line">    config.pipe_timeout = <span class='macro'>REDIS_CLI_DEFAULT_PIPE_TIMEOUT<span class='macro_popup'>30</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8916"><td class="num" id="LN8916">8916</td><td class="line">    config.bigkeys = 0;</td></tr>
<tr class="codeline" data-linenumber="8917"><td class="num" id="LN8917">8917</td><td class="line">    config.hotkeys = 0;</td></tr>
<tr class="codeline" data-linenumber="8918"><td class="num" id="LN8918">8918</td><td class="line">    config.stdin_lastarg = 0;</td></tr>
<tr class="codeline" data-linenumber="8919"><td class="num" id="LN8919">8919</td><td class="line">    config.stdin_tag_arg = 0;</td></tr>
<tr class="codeline" data-linenumber="8920"><td class="num" id="LN8920">8920</td><td class="line">    config.stdin_tag_name = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8921"><td class="num" id="LN8921">8921</td><td class="line">    config.conn_info.auth = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8922"><td class="num" id="LN8922">8922</td><td class="line">    config.askpass = 0;</td></tr>
<tr class="codeline" data-linenumber="8923"><td class="num" id="LN8923">8923</td><td class="line">    config.conn_info.user = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8924"><td class="num" id="LN8924">8924</td><td class="line">    config.eval = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8925"><td class="num" id="LN8925">8925</td><td class="line">    config.eval_ldb = 0;</td></tr>
<tr class="codeline" data-linenumber="8926"><td class="num" id="LN8926">8926</td><td class="line">    config.eval_ldb_end = 0;</td></tr>
<tr class="codeline" data-linenumber="8927"><td class="num" id="LN8927">8927</td><td class="line">    config.eval_ldb_sync = 0;</td></tr>
<tr class="codeline" data-linenumber="8928"><td class="num" id="LN8928">8928</td><td class="line">    config.enable_ldb_on_eval = 0;</td></tr>
<tr class="codeline" data-linenumber="8929"><td class="num" id="LN8929">8929</td><td class="line">    config.last_cmd_type = -1;</td></tr>
<tr class="codeline" data-linenumber="8930"><td class="num" id="LN8930">8930</td><td class="line">    config.verbose = 0;</td></tr>
<tr class="codeline" data-linenumber="8931"><td class="num" id="LN8931">8931</td><td class="line">    config.set_errcode = 0;</td></tr>
<tr class="codeline" data-linenumber="8932"><td class="num" id="LN8932">8932</td><td class="line">    config.no_auth_warning = 0;</td></tr>
<tr class="codeline" data-linenumber="8933"><td class="num" id="LN8933">8933</td><td class="line">    config.in_multi = 0;</td></tr>
<tr class="codeline" data-linenumber="8934"><td class="num" id="LN8934">8934</td><td class="line">    config.cluster_manager_command.name = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8935"><td class="num" id="LN8935">8935</td><td class="line">    config.cluster_manager_command.argc = 0;</td></tr>
<tr class="codeline" data-linenumber="8936"><td class="num" id="LN8936">8936</td><td class="line">    config.cluster_manager_command.argv = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8937"><td class="num" id="LN8937">8937</td><td class="line">    config.cluster_manager_command.stdin_arg = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8938"><td class="num" id="LN8938">8938</td><td class="line">    config.cluster_manager_command.flags = 0;</td></tr>
<tr class="codeline" data-linenumber="8939"><td class="num" id="LN8939">8939</td><td class="line">    config.cluster_manager_command.replicas = 0;</td></tr>
<tr class="codeline" data-linenumber="8940"><td class="num" id="LN8940">8940</td><td class="line">    config.cluster_manager_command.from = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8941"><td class="num" id="LN8941">8941</td><td class="line">    config.cluster_manager_command.to = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8942"><td class="num" id="LN8942">8942</td><td class="line">    config.cluster_manager_command.from_user = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8943"><td class="num" id="LN8943">8943</td><td class="line">    config.cluster_manager_command.from_pass = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8944"><td class="num" id="LN8944">8944</td><td class="line">    config.cluster_manager_command.from_askpass = 0;</td></tr>
<tr class="codeline" data-linenumber="8945"><td class="num" id="LN8945">8945</td><td class="line">    config.cluster_manager_command.weight = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8946"><td class="num" id="LN8946">8946</td><td class="line">    config.cluster_manager_command.weight_argc = 0;</td></tr>
<tr class="codeline" data-linenumber="8947"><td class="num" id="LN8947">8947</td><td class="line">    config.cluster_manager_command.slots = 0;</td></tr>
<tr class="codeline" data-linenumber="8948"><td class="num" id="LN8948">8948</td><td class="line">    config.cluster_manager_command.timeout = <span class='macro'>CLUSTER_MANAGER_MIGRATE_TIMEOUT<span class='macro_popup'>60000</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8949"><td class="num" id="LN8949">8949</td><td class="line">    config.cluster_manager_command.pipeline = <span class='macro'>CLUSTER_MANAGER_MIGRATE_PIPELINE<span class='macro_popup'>10</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8950"><td class="num" id="LN8950">8950</td><td class="line">    config.cluster_manager_command.threshold =</td></tr>
<tr class="codeline" data-linenumber="8951"><td class="num" id="LN8951">8951</td><td class="line">        <span class='macro'>CLUSTER_MANAGER_REBALANCE_THRESHOLD<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8952"><td class="num" id="LN8952">8952</td><td class="line">    config.cluster_manager_command.backup_dir = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8953"><td class="num" id="LN8953">8953</td><td class="line">    pref.hints = 1;</td></tr>
<tr class="codeline" data-linenumber="8954"><td class="num" id="LN8954">8954</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8955"><td class="num" id="LN8955">8955</td><td class="line">    spectrum_palette = spectrum_palette_color;</td></tr>
<tr class="codeline" data-linenumber="8956"><td class="num" id="LN8956">8956</td><td class="line">    spectrum_palette_size = spectrum_palette_color_size;</td></tr>
<tr class="codeline" data-linenumber="8957"><td class="num" id="LN8957">8957</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8958"><td class="num" id="LN8958">8958</td><td class="line">    <span class='keyword'>if</span> (!isatty(fileno(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>)) &amp;&amp; (getenv(<span class='string_literal'>"FAKETTY"</span>) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="8959"><td class="num" id="LN8959">8959</td><td class="line">        config.output = <span class='macro'>OUTPUT_RAW<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8960"><td class="num" id="LN8960">8960</td><td class="line">        config.push_output = 0;</td></tr>
<tr class="codeline" data-linenumber="8961"><td class="num" id="LN8961">8961</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="8962"><td class="num" id="LN8962">8962</td><td class="line">        config.output = <span class='macro'>OUTPUT_STANDARD<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="8963"><td class="num" id="LN8963">8963</td><td class="line">        config.push_output = 1;</td></tr>
<tr class="codeline" data-linenumber="8964"><td class="num" id="LN8964">8964</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="8965"><td class="num" id="LN8965">8965</td><td class="line">    config.mb_delim = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="8966"><td class="num" id="LN8966">8966</td><td class="line">    config.cmd_delim = <span class='macro'>sdsnew<span class='macro_popup'>hi_sdsnew</span></span>(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="8967"><td class="num" id="LN8967">8967</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8968"><td class="num" id="LN8968">8968</td><td class="line">    firstarg = parseOptions(argc,argv);</td></tr>
<tr class="codeline" data-linenumber="8969"><td class="num" id="LN8969">8969</td><td class="line">    argc -= firstarg;</td></tr>
<tr class="codeline" data-linenumber="8970"><td class="num" id="LN8970">8970</td><td class="line">    argv += firstarg;</td></tr>
<tr class="codeline" data-linenumber="8971"><td class="num" id="LN8971">8971</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8972"><td class="num" id="LN8972">8972</td><td class="line">    parseEnv();</td></tr>
<tr class="codeline" data-linenumber="8973"><td class="num" id="LN8973">8973</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8974"><td class="num" id="LN8974">8974</td><td class="line">    <span class='keyword'>if</span> (config.askpass) {</td></tr>
<tr class="codeline" data-linenumber="8975"><td class="num" id="LN8975">8975</td><td class="line">        config.conn_info.auth = askPassword(<span class='string_literal'>"Please input password: "</span>);</td></tr>
<tr class="codeline" data-linenumber="8976"><td class="num" id="LN8976">8976</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="8977"><td class="num" id="LN8977">8977</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8978"><td class="num" id="LN8978">8978</td><td class="line">    <span class='keyword'>if</span> (config.cluster_manager_command.from_askpass) {</td></tr>
<tr class="codeline" data-linenumber="8979"><td class="num" id="LN8979">8979</td><td class="line">        config.cluster_manager_command.from_pass = askPassword(</td></tr>
<tr class="codeline" data-linenumber="8980"><td class="num" id="LN8980">8980</td><td class="line">            <span class='string_literal'>"Please input import source node password: "</span>);</td></tr>
<tr class="codeline" data-linenumber="8981"><td class="num" id="LN8981">8981</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="8982"><td class="num" id="LN8982">8982</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8983"><td class="num" id="LN8983">8983</td><td class="line"><span class='directive'>#ifdef USE_OPENSSL</span></td></tr>
<tr class="codeline" data-linenumber="8984"><td class="num" id="LN8984">8984</td><td class="line">    <span class='keyword'>if</span> (config.tls) {</td></tr>
<tr class="codeline" data-linenumber="8985"><td class="num" id="LN8985">8985</td><td class="line">        cliSecureInit();</td></tr>
<tr class="codeline" data-linenumber="8986"><td class="num" id="LN8986">8986</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="8987"><td class="num" id="LN8987">8987</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="8988"><td class="num" id="LN8988">8988</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8989"><td class="num" id="LN8989">8989</td><td class="line">    gettimeofday(&amp;tv, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="8990"><td class="num" id="LN8990">8990</td><td class="line">    init_genrand64(((<span class='keyword'>long</span> <span class='keyword'>long</span>) tv.tv_sec * 1000000 + tv.tv_usec) ^ getpid());</td></tr>
<tr class="codeline" data-linenumber="8991"><td class="num" id="LN8991">8991</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8992"><td class="num" id="LN8992">8992</td><td class="line">    <span class='comment'>/* Cluster Manager mode */</span></td></tr>
<tr class="codeline" data-linenumber="8993"><td class="num" id="LN8993">8993</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>CLUSTER_MANAGER_MODE()<span class='macro_popup'>(config.cluster_manager_command.name != ((void*)0))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="8994"><td class="num" id="LN8994">8994</td><td class="line">        clusterManagerCommandProc *proc = validateClusterManagerCommand();</td></tr>
<tr class="codeline" data-linenumber="8995"><td class="num" id="LN8995">8995</td><td class="line">        <span class='keyword'>if</span> (!proc) {</td></tr>
<tr class="codeline" data-linenumber="8996"><td class="num" id="LN8996">8996</td><td class="line">            exit(1);</td></tr>
<tr class="codeline" data-linenumber="8997"><td class="num" id="LN8997">8997</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="8998"><td class="num" id="LN8998">8998</td><td class="line">        clusterManagerMode(proc);</td></tr>
<tr class="codeline" data-linenumber="8999"><td class="num" id="LN8999">8999</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="9000"><td class="num" id="LN9000">9000</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="9001"><td class="num" id="LN9001">9001</td><td class="line">    <span class='comment'>/* Latency mode */</span></td></tr>
<tr class="codeline" data-linenumber="9002"><td class="num" id="LN9002">9002</td><td class="line">    <span class='keyword'>if</span> (config.latency_mode) {</td></tr>
<tr class="codeline" data-linenumber="9003"><td class="num" id="LN9003">9003</td><td class="line">        <span class='keyword'>if</span> (cliConnect(0) == <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>) exit(1);</td></tr>
<tr class="codeline" data-linenumber="9004"><td class="num" id="LN9004">9004</td><td class="line">        latencyMode();</td></tr>
<tr class="codeline" data-linenumber="9005"><td class="num" id="LN9005">9005</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="9006"><td class="num" id="LN9006">9006</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="9007"><td class="num" id="LN9007">9007</td><td class="line">    <span class='comment'>/* Latency distribution mode */</span></td></tr>
<tr class="codeline" data-linenumber="9008"><td class="num" id="LN9008">9008</td><td class="line">    <span class='keyword'>if</span> (config.latency_dist_mode) {</td></tr>
<tr class="codeline" data-linenumber="9009"><td class="num" id="LN9009">9009</td><td class="line">        <span class='keyword'>if</span> (cliConnect(0) == <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>) exit(1);</td></tr>
<tr class="codeline" data-linenumber="9010"><td class="num" id="LN9010">9010</td><td class="line">        latencyDistMode();</td></tr>
<tr class="codeline" data-linenumber="9011"><td class="num" id="LN9011">9011</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="9012"><td class="num" id="LN9012">9012</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="9013"><td class="num" id="LN9013">9013</td><td class="line">    <span class='comment'>/* Slave mode */</span></td></tr>
<tr class="codeline" data-linenumber="9014"><td class="num" id="LN9014">9014</td><td class="line">    <span class='keyword'>if</span> (config.slave_mode) {</td></tr>
<tr class="codeline" data-linenumber="9015"><td class="num" id="LN9015">9015</td><td class="line">        <span class='keyword'>if</span> (cliConnect(0) == <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>) exit(1);</td></tr>
<tr class="codeline" data-linenumber="9016"><td class="num" id="LN9016">9016</td><td class="line">        sendCapa();</td></tr>
<tr class="codeline" data-linenumber="9017"><td class="num" id="LN9017">9017</td><td class="line">        sendReplconf(<span class='string_literal'>"rdb-filter-only"</span>, <span class='string_literal'>""</span>);</td></tr>
<tr class="codeline" data-linenumber="9018"><td class="num" id="LN9018">9018</td><td class="line">        slaveMode();</td></tr>
<tr class="codeline" data-linenumber="9019"><td class="num" id="LN9019">9019</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="9020"><td class="num" id="LN9020">9020</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="9021"><td class="num" id="LN9021">9021</td><td class="line">    <span class='comment'>/* Get RDB/functions mode. */</span></td></tr>
<tr class="codeline" data-linenumber="9022"><td class="num" id="LN9022">9022</td><td class="line">    <span class='keyword'>if</span> (config.getrdb_mode || config.get_functions_rdb_mode) {</td></tr>
<tr class="codeline" data-linenumber="9023"><td class="num" id="LN9023">9023</td><td class="line">        <span class='keyword'>if</span> (cliConnect(0) == <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>) exit(1);</td></tr>
<tr class="codeline" data-linenumber="9024"><td class="num" id="LN9024">9024</td><td class="line">        sendCapa();</td></tr>
<tr class="codeline" data-linenumber="9025"><td class="num" id="LN9025">9025</td><td class="line">        sendRdbOnly();</td></tr>
<tr class="codeline" data-linenumber="9026"><td class="num" id="LN9026">9026</td><td class="line">        <span class='keyword'>if</span> (config.get_functions_rdb_mode &amp;&amp; !sendReplconf(<span class='string_literal'>"rdb-filter-only"</span>, <span class='string_literal'>"functions"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="9027"><td class="num" id="LN9027">9027</td><td class="line">            fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='string_literal'>"Failed requesting functions only RDB from server, aborting\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="9028"><td class="num" id="LN9028">9028</td><td class="line">            exit(1);</td></tr>
<tr class="codeline" data-linenumber="9029"><td class="num" id="LN9029">9029</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="9030"><td class="num" id="LN9030">9030</td><td class="line">        getRDB(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="9031"><td class="num" id="LN9031">9031</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="9032"><td class="num" id="LN9032">9032</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="9033"><td class="num" id="LN9033">9033</td><td class="line">    <span class='comment'>/* Pipe mode */</span></td></tr>
<tr class="codeline" data-linenumber="9034"><td class="num" id="LN9034">9034</td><td class="line">    <span class='keyword'>if</span> (config.pipe_mode) {</td></tr>
<tr class="codeline" data-linenumber="9035"><td class="num" id="LN9035">9035</td><td class="line">        <span class='keyword'>if</span> (cliConnect(0) == <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>) exit(1);</td></tr>
<tr class="codeline" data-linenumber="9036"><td class="num" id="LN9036">9036</td><td class="line">        pipeMode();</td></tr>
<tr class="codeline" data-linenumber="9037"><td class="num" id="LN9037">9037</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="9038"><td class="num" id="LN9038">9038</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="9039"><td class="num" id="LN9039">9039</td><td class="line">    <span class='comment'>/* Find big keys */</span></td></tr>
<tr class="codeline" data-linenumber="9040"><td class="num" id="LN9040">9040</td><td class="line">    <span class='keyword'>if</span> (config.bigkeys) {</td></tr>
<tr class="codeline" data-linenumber="9041"><td class="num" id="LN9041">9041</td><td class="line">        <span class='keyword'>if</span> (cliConnect(0) == <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>) exit(1);</td></tr>
<tr class="codeline" data-linenumber="9042"><td class="num" id="LN9042">9042</td><td class="line">        findBigKeys(0, 0);</td></tr>
<tr class="codeline" data-linenumber="9043"><td class="num" id="LN9043">9043</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="9044"><td class="num" id="LN9044">9044</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="9045"><td class="num" id="LN9045">9045</td><td class="line">    <span class='comment'>/* Find large keys */</span></td></tr>
<tr class="codeline" data-linenumber="9046"><td class="num" id="LN9046">9046</td><td class="line">    <span class='keyword'>if</span> (config.memkeys) {</td></tr>
<tr class="codeline" data-linenumber="9047"><td class="num" id="LN9047">9047</td><td class="line">        <span class='keyword'>if</span> (cliConnect(0) == <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>) exit(1);</td></tr>
<tr class="codeline" data-linenumber="9048"><td class="num" id="LN9048">9048</td><td class="line">        findBigKeys(1, config.memkeys_samples);</td></tr>
<tr class="codeline" data-linenumber="9049"><td class="num" id="LN9049">9049</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="9050"><td class="num" id="LN9050">9050</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="9051"><td class="num" id="LN9051">9051</td><td class="line">    <span class='comment'>/* Find hot keys */</span></td></tr>
<tr class="codeline" data-linenumber="9052"><td class="num" id="LN9052">9052</td><td class="line">    <span class='keyword'>if</span> (config.hotkeys) {</td></tr>
<tr class="codeline" data-linenumber="9053"><td class="num" id="LN9053">9053</td><td class="line">        <span class='keyword'>if</span> (cliConnect(0) == <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>) exit(1);</td></tr>
<tr class="codeline" data-linenumber="9054"><td class="num" id="LN9054">9054</td><td class="line">        findHotKeys();</td></tr>
<tr class="codeline" data-linenumber="9055"><td class="num" id="LN9055">9055</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="9056"><td class="num" id="LN9056">9056</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="9057"><td class="num" id="LN9057">9057</td><td class="line">    <span class='comment'>/* Stat mode */</span></td></tr>
<tr class="codeline" data-linenumber="9058"><td class="num" id="LN9058">9058</td><td class="line">    <span class='keyword'>if</span> (config.stat_mode) {</td></tr>
<tr class="codeline" data-linenumber="9059"><td class="num" id="LN9059">9059</td><td class="line">        <span class='keyword'>if</span> (cliConnect(0) == <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>) exit(1);</td></tr>
<tr class="codeline" data-linenumber="9060"><td class="num" id="LN9060">9060</td><td class="line">        <span class='keyword'>if</span> (config.interval == 0) config.interval = 1000000;</td></tr>
<tr class="codeline" data-linenumber="9061"><td class="num" id="LN9061">9061</td><td class="line">        statMode();</td></tr>
<tr class="codeline" data-linenumber="9062"><td class="num" id="LN9062">9062</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="9063"><td class="num" id="LN9063">9063</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="9064"><td class="num" id="LN9064">9064</td><td class="line">    <span class='comment'>/* Scan mode */</span></td></tr>
<tr class="codeline" data-linenumber="9065"><td class="num" id="LN9065">9065</td><td class="line">    <span class='keyword'>if</span> (config.scan_mode) {</td></tr>
<tr class="codeline" data-linenumber="9066"><td class="num" id="LN9066">9066</td><td class="line">        <span class='keyword'>if</span> (cliConnect(0) == <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>) exit(1);</td></tr>
<tr class="codeline" data-linenumber="9067"><td class="num" id="LN9067">9067</td><td class="line">        scanMode();</td></tr>
<tr class="codeline" data-linenumber="9068"><td class="num" id="LN9068">9068</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="9069"><td class="num" id="LN9069">9069</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="9070"><td class="num" id="LN9070">9070</td><td class="line">    <span class='comment'>/* LRU test mode */</span></td></tr>
<tr class="codeline" data-linenumber="9071"><td class="num" id="LN9071">9071</td><td class="line">    <span class='keyword'>if</span> (config.lru_test_mode) {</td></tr>
<tr class="codeline" data-linenumber="9072"><td class="num" id="LN9072">9072</td><td class="line">        <span class='keyword'>if</span> (cliConnect(0) == <span class='macro'>REDIS_ERR<span class='macro_popup'>-1</span></span>) exit(1);</td></tr>
<tr class="codeline" data-linenumber="9073"><td class="num" id="LN9073">9073</td><td class="line">        LRUTestMode();</td></tr>
<tr class="codeline" data-linenumber="9074"><td class="num" id="LN9074">9074</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="9075"><td class="num" id="LN9075">9075</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="9076"><td class="num" id="LN9076">9076</td><td class="line">    <span class='comment'>/* Intrinsic latency mode */</span></td></tr>
<tr class="codeline" data-linenumber="9077"><td class="num" id="LN9077">9077</td><td class="line">    <span class='keyword'>if</span> (config.intrinsic_latency_mode) intrinsicLatencyMode();</td></tr>
<tr class="codeline" data-linenumber="9078"><td class="num" id="LN9078">9078</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="9079"><td class="num" id="LN9079">9079</td><td class="line">    <span class='comment'>/* Start interactive mode when no command is provided */</span></td></tr>
<tr class="codeline" data-linenumber="9080"><td class="num" id="LN9080">9080</td><td class="line">    <span class='keyword'>if</span> (argc == 0 &amp;&amp; !config.eval) {</td></tr>
<tr class="codeline" data-linenumber="9081"><td class="num" id="LN9081">9081</td><td class="line">        <span class='comment'>/* Ignore SIGPIPE in interactive mode to force a reconnect */</span></td></tr>
<tr class="codeline" data-linenumber="9082"><td class="num" id="LN9082">9082</td><td class="line">        signal(<span class='macro'>SIGPIPE<span class='macro_popup'>13</span></span>, <span class='macro'>SIG_IGN<span class='macro_popup'>((__sighandler_t) 1)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="9083"><td class="num" id="LN9083">9083</td><td class="line">        signal(<span class='macro'>SIGINT<span class='macro_popup'>2</span></span>, sigIntHandler);</td></tr>
<tr class="codeline" data-linenumber="9084"><td class="num" id="LN9084">9084</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="9085"><td class="num" id="LN9085">9085</td><td class="line">        <span class='comment'>/* Note that in repl mode we don't abort on connection error.</span></td></tr>
<tr class="codeline" data-linenumber="9086"><td class="num" id="LN9086">9086</td><td class="line">         <span class='comment'>* A new attempt will be performed for every command send. */</span></td></tr>
<tr class="codeline" data-linenumber="9087"><td class="num" id="LN9087">9087</td><td class="line">        cliConnect(0);</td></tr>
<tr class="codeline" data-linenumber="9088"><td class="num" id="LN9088">9088</td><td class="line">        repl();</td></tr>
<tr class="codeline" data-linenumber="9089"><td class="num" id="LN9089">9089</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="9090"><td class="num" id="LN9090">9090</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="9091"><td class="num" id="LN9091">9091</td><td class="line">    <span class='comment'>/* Otherwise, we have some arguments to execute */</span></td></tr>
<tr class="codeline" data-linenumber="9092"><td class="num" id="LN9092">9092</td><td class="line">    <span class='keyword'>if</span> (config.eval) {</td></tr>
<tr class="codeline" data-linenumber="9093"><td class="num" id="LN9093">9093</td><td class="line">        <span class='keyword'>if</span> (cliConnect(0) != <span class='macro'>REDIS_OK<span class='macro_popup'>0</span></span>) exit(1);</td></tr>
<tr class="codeline" data-linenumber="9094"><td class="num" id="LN9094">9094</td><td class="line">        <span class='keyword'>return</span> evalMode(argc,argv);</td></tr>
<tr class="codeline" data-linenumber="9095"><td class="num" id="LN9095">9095</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="9096"><td class="num" id="LN9096">9096</td><td class="line">        cliConnect(<span class='macro'>CC_QUIET<span class='macro_popup'>(1&lt;&lt;1)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="9097"><td class="num" id="LN9097">9097</td><td class="line">        <span class='keyword'>return</span> noninteractive(argc,argv);</td></tr>
<tr class="codeline" data-linenumber="9098"><td class="num" id="LN9098">9098</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="9099"><td class="num" id="LN9099">9099</td><td class="line">}</td></tr>
</table></body></html>
